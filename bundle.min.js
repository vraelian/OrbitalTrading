(()=>{var v=Object.freeze({STATUS:"status",NAVIGATION:"navigation",SERVICES:"services",MARKET:"market",CARGO:"cargo",HANGAR:"hangar",MISSIONS:"missions",FINANCE:"finance",INTEL:"intel"}),k=Object.freeze({SHIP:"ship",STARPORT:"starport",ADMIN:"admin"}),T=Object.freeze({WANDERER:"starter",STALWART:"hauler_c1",MULE:"hauler_c2",PATHFINDER:"explorer_b1",NOMAD:"explorer_b2",VINDICATOR:"frigate_a1",AEGIS:"frigate_a2",ODYSSEY:"luxury_s1",MAJESTIC:"luxury_s2",TITAN_HAULER:"rare_s1",VOID_CHASER:"rare_s2",GUARDIAN:"rare_s3",STARGAZER:"rare_s4",BEHEMOTH:"rare_o1"}),u=Object.freeze({WATER_ICE:"water_ice",PLASTEEL:"plasteel",HYDROPONICS:"hydroponics",CYBERNETICS:"cybernetics",PROPELLANT:"propellant",PROCESSORS:"processors",GMO_SEEDS:"gmo_seeds",CRYO_PODS:"cryo_pods",ATMO_PROCESSORS:"atmos_processors",CLONED_ORGANS:"cloned_organs",XENO_GEOLOGICALS:"xeno_geologicals",SENTIENT_AI:"sentient_ai",ANTIMATTER:"antimatter",FOLDED_DRIVES:"folded_drives"}),g=Object.freeze({EARTH:"loc_earth",LUNA:"loc_luna",MARS:"loc_mars",VENUS:"loc_venus",BELT:"loc_belt",SATURN:"loc_saturn",JUPITER:"loc_jupiter",URANUS:"loc_uranus",NEPTUNE:"loc_neptune",PLUTO:"loc_pluto",EXCHANGE:"loc_exchange",KEPLER:"loc_kepler"}),I=Object.freeze({TRADEMASTER:"trademaster",NAVIGATOR:"navigator",VENETIAN_SYNDICATE:"venetian_syndicate",MERCHANT_GUILD_SHIP:"merchant_guild_ship"}),p=Object.freeze({SET_SCREEN:"set-screen",TRAVEL:"travel",BUY_SHIP:"buy-ship",SELL_SHIP:"sell-ship",SELECT_SHIP:"select-ship",PAY_DEBT:"pay-debt",TAKE_LOAN:"take-loan",PURCHASE_INTEL:"purchase-intel",BUY_ITEM:"buy-item",SELL_ITEM:"sell-item",SET_MAX_BUY:"set-max-buy",SET_MAX_SELL:"set-max-sell",INCREMENT:"increment",DECREMENT:"decrement",SHOW_PRICE_GRAPH:"show-price-graph",SHOW_FINANCE_GRAPH:"show-finance-graph"}),H=Object.freeze({SCREEN_LOAD:"SCREEN_LOAD",ACTION:"ACTION",INFO:"INFO"}),M=Object.freeze({STARTING_CREDITS:5e3,STARTING_DEBT_INTEREST:125,REPAIR_COST_PER_HP:75,REPAIR_AMOUNT_PER_TICK:5,FUEL_SCALAR:3,INTEREST_INTERVAL:7,PASSIVE_REPAIR_RATE:.02,HULL_DECAY_PER_TRAVEL_DAY:1/7,SHIP_SELL_MODIFIER:.75,RARE_SHIP_CHANCE:.3,PRICE_HISTORY_LENGTH:50,FINANCE_HISTORY_LENGTH:10,DAILY_PRICE_VOLATILITY:.035,MEAN_REVERSION_STRENGTH:.01,LOAN_GARNISHMENT_DAYS:180,LOAN_GARNISHMENT_PERCENT:.14,RANDOM_EVENT_CHANCE:.07}),de="orbitalTraderSave_v2";var J={modals:[{id:"lore_1",title:"Year 2140",description:'Humanity has expanded throughout the Solar System.<br><br> <span class="hl">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.',buttonText:"Begin",contentClass:"text-center"},{id:"lore_2",title:"A Calculated Risk",description:`While a dead-end job in the Belt paid the bills, your dreams reached for the stars.<br><br> The <span class="hl">Merchant's Guild</span> presents an opportunity: the credit you need to build something of your own...`,buttonText:"Apply for Loan",contentClass:"text-center",buttonClass:"btn-pulse-green"},{id:"charter",title:`<span class="hl">MERCHANT'S GUILD LOAN AGREEMENT</span>`,description:`
        <div class="font-roboto-mono text-left text-sm space-y-2">
            <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
            <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">\u232C25,000</span></p>
            <p><span class="text-gray-400">INTEREST RATE:</span> 1.3% (Weekly)</p>
        </div>
        <div class="border-t border-slate-600 my-4"></div>
        <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment, subject to interest accrual as stipulated by the Merchant's Guild Interstellar Commerce Mandates. All financial agreements are recognized across all systems.</p>
      `,buttonText:"Accept Terms",buttonClass:"btn-pulse-gold"},{id:"signature",title:"SIGN YOUR NAME",description:`
        <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
      `,buttonText:"Submit Application"},{id:"final",title:"Earn Your Fortune",description:"Interest on your debt grows every week. Visit the market in any Starport to begin your career and start earning credits!",buttonText:"Board the {shipName}"}],tutorials:{intro_hangar:{title:"Your First Ship",trigger:{type:H.ACTION,action:"INTRO_START_HANGAR"},steps:[{stepId:"hangar_1",text:"Welcome to the Shipyard. Every station has a port from which you can trade ships and manage your hangar.",highlightElementId:"starport-shipyard-panel",mobileHighlightElementId:"starport-shipyard-panel-mobile",position:{desktop:"bottom-right",mobile:"top"},completion:{type:H.INFO},nextStepId:"hangar_2",isSkippable:!0},{stepId:"hangar_2",text:"You've borrowed enough credits to purchase a ship!<br><br> Choose carefully...",highlightElementQuery:'.ship-card button[data-action="buy-ship"]',mobileHighlightElementQuery:'.ship-list-item-mobile[data-context="shipyard"]',position:{desktop:"bottom-right",mobile:"top"},completion:{type:H.ACTION,action:p.BUY_SHIP},nextStepId:"hangar_3",isSkippable:!0},{stepId:"hangar_3",text:'Congratulations! Your new vessel is now in your Hangar. Select it in your hangar and <span class="hl-yellow">Board</span> it to make it your active ship.',highlightElementId:"starport-hangar-panel",mobileHighlightElementId:"starport-hangar-panel-mobile",position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:H.ACTION,action:p.SELECT_SHIP},nextStepId:null,isSkippable:!1}]},intro_finance:{title:"Managing Your Debt",trigger:{type:H.ACTION,action:"INTRO_START_FINANCE"},steps:[{stepId:"finance_1",text:"Welcome aboard the {shipName}, Captain {playerName}! Now, don't forget where the money came from!",highlightElementId:"finance-debt-panel",position:{desktop:"bottom-right",mobile:"top"},completion:{type:H.INFO},nextStepId:"finance_2",isSkippable:!1},{stepId:"finance_2",text:`Your debt to the Merchant's Guild is due in <span class="hl-red">180 days</span>. You will need to earn credits to pay off your debt!`,highlightElementId:"finance-debt-panel",position:{desktop:"bottom-right",mobile:"top"},completion:{type:H.INFO},nextStepId:null,isSkippable:!1}]}}},le={[g.EARTH]:"\u{1F30D}",[g.LUNA]:"\u{1F315}",[g.MARS]:"\u{1F534}",[g.VENUS]:"\u{1F7E1}",[g.BELT]:"\u{1FAA8}",[g.SATURN]:"\u{1FA90}",[g.JUPITER]:"\u{1F7E0}",[g.URANUS]:"\u{1F535}",[g.NEPTUNE]:"\u{1F7E3}",[g.PLUTO]:"\u{1FAA9}",[g.EXCHANGE]:"\u{1F3F4}\u200D\u2620\uFE0F",[g.KEPLER]:"\u{1F441}\uFE0F"},G={[I.TRADEMASTER]:{profitBonus:.05},[I.NAVIGATOR]:{fuelMod:.9,hullDecayMod:.9,travelTimeMod:.9},[I.VENETIAN_SYNDICATE]:{fuelDiscount:.25,repairDiscount:.25}},he=[{id:"captain_choice",trigger:{day:366},title:"Captain Who?",description:"You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",choices:[{title:"Trademaster",description:"5% bonus on all trade profits.",perkId:I.TRADEMASTER,playerTitle:"Trademaster"},{title:"Navigator",description:"10% reduced fuel usage, hull decay, and travel time.",perkId:I.NAVIGATOR,playerTitle:"Navigator"}]},{id:"friends_with_benefits",trigger:{credits:5e4},title:"Friends with Benefits",description:"An ally in need is an ally indeed.",choices:[{title:"Join the Merchant's Guild",description:"Receive a free C-Class freighter.",perkId:I.MERCHANT_GUILD_SHIP},{title:"Join the Venetian Syndicate",description:"75% discount on fuel and repairs at Venus.",perkId:I.VENETIAN_SYNDICATE}]}],ce=[{id:"distress_call",title:"Distress Call",scenario:"You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.",precondition:(d,e)=>e.fuel>=20,choices:[{title:"Offer Aid (20 Fuel)",outcomes:[{chance:.75,description:"The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.",effects:[{type:"fuel",value:-20},{type:"credits",value:1e4}]},{chance:.25,description:"As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.",effects:[{type:"fuel",value:-20},{type:"hull_damage_percent",value:15}]}]},{title:"Ignore the Call",outcomes:[{chance:1,description:"You press on, and the desperate signal fades behind you.",effects:[]}]}]},{id:"floating_cargo",title:"Floating Cargo Pod",scenario:"Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.",precondition:()=>!0,choices:[{title:"Bring it Aboard",outcomes:[{chance:.6,description:"The pod contains valuable goods. You gain 25 units of Neural Processors.",effects:[{type:"add_cargo",value:{id:u.PROCESSORS,quantity:25}}]},{chance:.4,description:"It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.",effects:[{type:"hull_damage_percent",value:20}]}]},{title:"Report it",outcomes:[{chance:1,description:"You notify the nearest station of the hazard and receive a small finder's fee of 1,000 credits.",effects:[{type:"credits",value:1e3}]}]}]},{id:"adrift_passenger",title:"Adrift Passenger",scenario:"You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.",precondition:(d,e)=>e.fuel>=30,choices:[{title:"Take Aboard for Payment",outcomes:[{chance:1,description:"The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.",effects:[{type:"credits",value:1e4}]}]},{title:"Give a Fuel Cell (30 Fuel)",outcomes:[{chance:1,descriptions:{reward_cybernetics:'In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.',reward_debt_paid:'Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.',reward_credits:'With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.'},effects:[{type:"ADRIFT_PASSENGER"}]}]}]},{id:"meteoroid_swarm",title:"Micrometeoroid Swarm",scenario:"Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.",precondition:(d,e)=>e.fuel>=15,choices:[{title:"Evade Aggressively (+15 Fuel)",outcomes:[{chance:1,description:"You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.",effects:[{type:"fuel",value:-15}]}]},{title:"Brace for Impact",outcomes:[{chance:1,description:"You trust your hull to withstand the impacts, taking a beating but saving fuel.",effects:[{type:"hull_damage_percent",value:[10,25]}]}]}]},{id:"engine_malfunction",title:"Engine Malfunction",scenario:"A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.",precondition:(d,e,t)=>(t()[u.PLASTEEL]?.quantity||0)>=5,choices:[{title:"Quick, Risky Fix (5 Plasteel)",outcomes:[{chance:.5,description:"The patch holds! The engine stabilizes and you continue your journey without further incident.",effects:[{type:"lose_cargo",value:{id:u.PLASTEEL,quantity:5}}]},{chance:.5,description:"The patch fails catastrophically, causing a small explosion that deals 20% hull damage.",effects:[{type:"lose_cargo",value:{id:u.PLASTEEL,quantity:5}},{type:"hull_damage_percent",value:20}]}]},{title:"Limp to Destination",outcomes:[{chance:1,description:"You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.",effects:[{type:"travel_time_add_percent",value:.25}]}]}]},{id:"nav_glitch",title:"Navigation Sensor Glitch",scenario:"The nav-console flashes red. Your primary positioning sensors are offline, and you're flying blind in the deep dark.",precondition:()=>!0,choices:[{title:"Attempt Hard Reboot",outcomes:[{chance:.5,description:"Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.",effects:[{type:"set_travel_time",value:1}]},{chance:.5,description:"The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.",effects:[{type:"travel_time_add",value:15}]}]},{title:"Navigate Manually",outcomes:[{chance:1,description:"You rely on old-fashioned star charts. It's slow but safe, adding 7 days to your trip.",effects:[{type:"travel_time_add",value:7}]}]}]},{id:"life_support_fluctuation",title:"Life Support Fluctuation",scenario:"An alarm indicates unstable oxygen levels. It's not critical yet, but the crew is on edge and efficiency is dropping.",precondition:(d,e)=>e.health>e.maxHealth*.25,choices:[{title:"Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)",outcomes:[{chance:1,description:"You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship's integrity is compromised.",effects:[{type:"hull_damage_percent",value:25}]}]},{title:"Defer Maintenance Costs",outcomes:[{chance:1,description:"You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.",effects:[{type:"add_debt",value:5e3}]}]}]},{id:"cargo_rupture",title:"Cargo Hold Rupture",scenario:"A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.",precondition:(d,e,t)=>{let a=t();return a?Object.values(a).some(i=>i.quantity>0):!1},choices:[{title:"Jettison Damaged Cargo",outcomes:[{chance:1,description:"You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.",effects:[{type:"lose_random_cargo_percent",value:.1}]}]},{title:"Attempt EVA Repair",outcomes:[{chance:.75,description:"The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.",effects:[{type:"travel_time_add",value:2}]},{chance:.25,description:"The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.",effects:[{type:"lose_random_cargo_percent",value:.5},{type:"travel_time_add",value:2}]}]}]},{id:"space_race",title:"Space Race Wager",scenario:'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',precondition:d=>d.player.credits>100,choices:[{title:"Accept Wager (Bet: 80% of current credits)",outcomes:[{chance:1,description:"You accept the high-stakes challenge...",effects:[{type:"SPACE_RACE",wagerPercentage:.8,winChance:{S:.85,A:.7,B:.55,C:.4,O:.95}}]}]},{title:"Politely Decline",outcomes:[{chance:1,description:"You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.",effects:[]}]}]},{id:"supply_drop",title:"Emergency Supply Drop",scenario:"You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.",precondition:(d,e,t)=>{let a=t();return a&&Object.values(a).some(i=>i.quantity>0)},choices:[{title:"Divert Course to Deliver",outcomes:[{chance:1,description:"You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.",effects:[{type:"sell_random_cargo_premium",value:3},{type:"travel_time_add",value:7},{type:"set_new_random_destination"}]}]},{title:"Decline and Continue",outcomes:[{chance:1,description:"You stick to your original plan and let someone else handle the emergency supply run.",effects:[]}]}]}],E={[T.WANDERER]:{name:"Wanderer",class:"C",price:25e3,maxHealth:100,cargoCapacity:50,maxFuel:100,saleLocationId:null,lore:"The All-Rounder. A reliable, if unspectacular, light freighter. Its balanced stats make it a good choice for new captains finding their niche."},[T.STALWART]:{name:"Stalwart",class:"C",price:25e3,maxHealth:150,cargoCapacity:75,maxFuel:80,saleLocationId:g.MARS,lore:"The Hauler. A workhorse of the inner worlds. Slow and cumbersome, but boasts an impressive cargo capacity for its price point."},[T.MULE]:{name:"Mule",class:"C",price:25e3,maxHealth:75,cargoCapacity:40,maxFuel:150,saleLocationId:g.BELT,lore:"The Explorer. What it lacks in cargo space, it makes up for with surprising efficiency and robust systems, allowing it to travel further and cheaper than other ships in its class."},[T.PATHFINDER]:{name:"Pathfinder",class:"B",price:18e4,maxHealth:120,cargoCapacity:250,maxFuel:150,saleLocationId:g.LUNA,lore:"Built for the long haul. Its extended fuel tanks and robust sensor suite make it ideal for reaching the outer edges of the system."},[T.NOMAD]:{name:"Nomad",class:"B",price:28e4,maxHealth:100,cargoCapacity:100,maxFuel:140,saleLocationId:g.URANUS,lore:"A vessel designed for self-sufficiency, featuring advanced life support and a small onboard workshop for emergency repairs."},[T.VINDICATOR]:{name:"Vindicator",class:"A",price:75e4,maxHealth:250,cargoCapacity:125,maxFuel:120,saleLocationId:g.NEPTUNE,lore:"A decommissioned military frigate. Fast, tough, and intimidating, with cargo space retrofitted where missile launchers used to be."},[T.AEGIS]:{name:"Aegis",class:"A",price:12e5,maxHealth:120,cargoCapacity:150,maxFuel:140,saleLocationId:g.EARTH,lore:"Built as a high-threat escort vessel, its hull is exceptionally dense. A flying fortress that can also haul a respectable amount of cargo."},[T.ODYSSEY]:{name:"Odyssey",class:"S",price:38e5,maxHealth:100,cargoCapacity:125,maxFuel:250,saleLocationId:g.SATURN,lore:"The pinnacle of personal transport. Gleaming chrome, whisper-quiet engines, and a cabin that smells of rich Corinthian leather."},[T.MAJESTIC]:{name:"Majestic",class:"S",price:72e5,maxHealth:200,cargoCapacity:400,maxFuel:250,saleLocationId:g.KEPLER,lore:"A flying palace favored by corporate magnates. Its speed, range, and capacity make it one of the most versatile ships money can buy."},[T.TITAN_HAULER]:{name:"Titan Hauler",class:"S",price:18e5,maxHealth:175,cargoCapacity:500,maxFuel:75,saleLocationId:g.URANUS,isRare:!0,lore:"A relic of a failed colonization effort, this ship is almost entirely a cargo container with an engine strapped to it."},[T.VOID_CHASER]:{name:"Void Chaser",class:"S",price:31e5,maxHealth:50,cargoCapacity:75,maxFuel:400,saleLocationId:g.BELT,isRare:!0,lore:"A heavily modified smuggling vessel. Its paper-thin hull is a small price to pay for its legendary engine and long-range fuel cells."},[T.GUARDIAN]:{name:"Guardian",class:"S",price:15e5,maxHealth:400,cargoCapacity:100,maxFuel:150,saleLocationId:g.EARTH,isRare:!0,lore:"An experimental military prototype with redundant hull plating, designed to withstand extreme punishment."},[T.STARGAZER]:{name:"Stargazer",class:"S",price:95e4,maxHealth:100,cargoCapacity:50,maxFuel:350,saleLocationId:g.JUPITER,isRare:!0,lore:"A deep-space exploration vessel with colossal fuel reserves, intended for journeys far beyond the known systems."},[T.BEHEMOTH]:{name:"Behemoth",class:"O",price:32e6,maxHealth:600,cargoCapacity:6e3,maxFuel:600,saleLocationId:g.EXCHANGE,isRare:!0,lore:"An orbital-class freighter that dwarfs even the largest stations. It is a legend among traders, rumored to be a mobile black market in its own right."}},_=[{id:u.WATER_ICE,name:"Water Ice",basePriceRange:[25,500],tier:1,unlockLevel:1,styleClass:"item-style-1",lore:"Crude, unrefined water ice scraped from asteroids; a universal necessity."},{id:u.PLASTEEL,name:"Plasteel",basePriceRange:[1e3,4e3],tier:1,unlockLevel:1,styleClass:"item-style-2",lore:"A basic, versatile polymer for 3D printing and simple manufacturing."},{id:u.HYDROPONICS,name:"Hydroponics",basePriceRange:[6e3,1e4],tier:2,unlockLevel:1,styleClass:"item-style-3",lore:"Packaged agricultural systems and produce essential for feeding isolated colonies."},{id:u.CYBERNETICS,name:"Cybernetics",basePriceRange:[15e3,3e4],tier:2,unlockLevel:1,styleClass:"item-style-4",lore:"Mass-produced enhancement limbs and organs for the industrial workforce."},{id:u.PROPELLANT,name:"Refined Propellant",basePriceRange:[5e4,9e4],tier:3,unlockLevel:2,styleClass:"item-style-5",lore:"High-efficiency fuel that powers all modern ship drives."},{id:u.PROCESSORS,name:"Neural Processors",basePriceRange:[1e5,2e5],tier:3,unlockLevel:2,styleClass:"item-style-6",lore:"The silicon brains behind complex ship systems and station logistics."},{id:u.GMO_SEEDS,name:"GMO Seed Cultures",basePriceRange:[2e5,6e5],tier:4,unlockLevel:3,styleClass:"item-style-7",lore:"Patented seeds holding the key to unlocking agricultural wealth on new worlds."},{id:u.CRYO_PODS,name:"Cryo-Sleep Pods",basePriceRange:[9e5,16e5],tier:4,unlockLevel:3,styleClass:"item-style-8",lore:"Essential for long-haul passenger transport and colonization efforts."},{id:u.ATMO_PROCESSORS,name:"Atmo Processors",basePriceRange:[3e6,7e6],tier:5,unlockLevel:4,styleClass:"item-style-9",lore:"Gargantuan machines that begin the centuries-long process of making a world breathable."},{id:u.CLONED_ORGANS,name:"Cloned Organs",basePriceRange:[15e6,4e7],tier:5,unlockLevel:4,styleClass:"item-style-10",lore:"Lab-grown replacements with high demand in wealthy core worlds; morally grey."},{id:u.XENO_GEOLOGICALS,name:"Xeno-Geologicals",basePriceRange:[8e7,2e8],tier:6,unlockLevel:5,styleClass:"item-style-11",lore:"Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure."},{id:u.SENTIENT_AI,name:"Sentient AI Cores",basePriceRange:[4e8,9e8],tier:6,unlockLevel:5,styleClass:"item-style-12",lore:"The &quot;brains&quot; of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate."},{id:u.ANTIMATTER,name:"Antimatter",basePriceRange:[3e9,7e9],tier:7,unlockLevel:6,styleClass:"item-style-13",lore:"The only safe way to transport the most volatile and powerful substance known to science."},{id:u.FOLDED_DRIVES,name:"Folded-Space Drives",basePriceRange:[4e10,1e11],tier:7,unlockLevel:6,styleClass:"item-style-14",lore:"The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps."}],A=[{id:g.EARTH,name:"Earth Orbit",description:"The hub of power and wealth. High demand for tech and bio-enhancements.",color:"border-cyan-500",bg:"bg-gradient-to-br from-blue-900 to-slate-900",fuelPrice:250,arrivalLore:"The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.",modifiers:{[u.SENTIENT_AI]:.7,[u.PROPELLANT]:1.8,[u.CLONED_ORGANS]:1.5,[u.PLASTEEL]:1.2},specialDemand:{[u.CLONED_ORGANS]:{lore:"Cloning is outlawed on Earth, so the station has none. However, the black market pays handsomely for them.",bonus:1.75}}},{id:g.LUNA,name:"The Moon",description:"An industrial proving ground. Exports propellant and basic materials.",color:"border-gray-400",bg:"bg-gradient-to-br from-gray-700 to-slate-900",fuelPrice:350,arrivalLore:"Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.",modifiers:{[u.PROPELLANT]:.8,[u.PLASTEEL]:1.5,[u.WATER_ICE]:1.4},specialDemand:{[u.GMO_SEEDS]:{lore:"Luna's sterile environment is perfect for agricultural data vaults, leaving no room for production. However, they will pay handsomely for GMO Seed Cultures.",bonus:1.75}}},{id:g.MARS,name:"Mars",description:"A growing colony. Needs processors and materials for expansion.",color:"border-orange-600",bg:"bg-gradient-to-br from-orange-900 to-slate-900",fuelPrice:450,arrivalLore:"The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.",modifiers:{[u.PLASTEEL]:.7,[u.HYDROPONICS]:.6,[u.PROCESSORS]:1.6,[u.ATMO_PROCESSORS]:1.4},specialDemand:{[u.CRYO_PODS]:{lore:"The constant influx of colonists means Cryo-Sleep Pods are immediately used, so the station has none to sell. However, they will pay handsomely for more.",bonus:1.75}}},{id:g.VENUS,name:"Venus",description:"A scientific enclave hungry for research data and processors.",color:"border-yellow-400",bg:"bg-gradient-to-br from-yellow-800 to-slate-900",fuelPrice:400,arrivalLore:"Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.",modifiers:{[u.XENO_GEOLOGICALS]:.5,[u.PROCESSORS]:1.3,[u.HYDROPONICS]:1.6},specialDemand:{[u.PROCESSORS]:{lore:"The complex simulations on Venus consume all available Neural Processors, leaving none to spare. However, they will pay handsomely for any you can bring.",bonus:1.75}}},{id:g.BELT,name:"The Asteroid Belt",description:"A lawless frontier. Rich in raw minerals and water ice.",color:"border-amber-700",bg:"bg-gradient-to-br from-stone-800 to-slate-900",fuelPrice:600,arrivalLore:"Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.",modifiers:{[u.WATER_ICE]:.4,[u.PLASTEEL]:.6,[u.XENO_GEOLOGICALS]:1.7,[u.CRYO_PODS]:1.2},specialDemand:{[u.CYBERNETICS]:{lore:"The harsh conditions mean no cybernetics are ever in stock here. However, belters will pay handsomely for replacements.",bonus:1.75}}},{id:g.SATURN,name:"Saturn's Rings",description:"A tourism hub. Demands luxury goods and bio-wares.",color:"border-yellow-200",bg:"bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900",fuelPrice:550,arrivalLore:"The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.",modifiers:{[u.WATER_ICE]:.6,[u.PLASTEEL]:1.3,[u.GMO_SEEDS]:1.5,[u.CLONED_ORGANS]:1.8},specialDemand:{[u.XENO_GEOLOGICALS]:{lore:"Wealthy tourists buy any available Xeno-Geologicals, leaving none to sell. However, they will pay handsomely for more exotic specimens.",bonus:1.75}}},{id:g.JUPITER,name:"Jupiter",description:"A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.",color:"border-orange-400",bg:"bg-gradient-to-br from-orange-800 to-stone-900",fuelPrice:150,arrivalLore:"The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.",modifiers:{[u.PROPELLANT]:.5,[u.PROCESSORS]:1.4,[u.CYBERNETICS]:1.5,[u.PLASTEEL]:1.3},specialDemand:{[u.ATMO_PROCESSORS]:{lore:"Expanding Jupiter's refineries consumes Atmo Processors faster than they can be stocked. However, they will pay handsomely for more.",bonus:1.75}}},{id:g.URANUS,name:"Uranus",description:"A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.",color:"border-cyan-200",bg:"bg-gradient-to-br from-cyan-800 to-indigo-900",fuelPrice:700,arrivalLore:"The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.",modifiers:{[u.XENO_GEOLOGICALS]:1.2,[u.PROCESSORS]:1.5,[u.GMO_SEEDS]:1.8,[u.WATER_ICE]:.8},specialDemand:{[u.FOLDED_DRIVES]:{lore:"Research vessels are immediately equipped with any Folded-Space Drives, leaving none in stock. However, they will pay handsomely for them.",bonus:1.75}}},{id:g.NEPTUNE,name:"Neptune",description:"A dark, stormy world, home to secretive military bases and shipyards.",color:"border-blue-400",bg:"bg-gradient-to-br from-blue-900 to-black",fuelPrice:650,arrivalLore:"Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.",modifiers:{[u.SENTIENT_AI]:1.4,[u.FOLDED_DRIVES]:1.2,[u.ANTIMATTER]:1.3,[u.CYBERNETICS]:.7},specialDemand:{[u.ANTIMATTER]:{lore:"All antimatter is requisitioned for classified military projects, leaving none for public sale. However, the naval authority pays handsomely for it.",bonus:1.75}}},{id:g.PLUTO,name:"Pluto",description:"The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.",color:"border-indigo-400",bg:"bg-gradient-to-br from-indigo-900 to-slate-900",fuelPrice:900,arrivalLore:"Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.",modifiers:{[u.CLONED_ORGANS]:2,[u.SENTIENT_AI]:1.5,[u.CYBERNETICS]:1.4,[u.PLASTEEL]:.9},specialDemand:{[u.CLONED_ORGANS]:{lore:"On this lawless frontier, functional cloned organs are too valuable to ever be sold on the open market. However, they will pay handsomely for them.",bonus:1.75}}},{id:g.EXCHANGE,name:"The Exchange",description:"A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.",color:"border-purple-500",bg:"bg-gradient-to-br from-purple-900 via-black to-slate-900",fuelPrice:1200,arrivalLore:"A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.",modifiers:{[u.ANTIMATTER]:2.5,[u.FOLDED_DRIVES]:1.5,[u.XENO_GEOLOGICALS]:1.2},specialDemand:{[u.SENTIENT_AI]:{lore:"The operators of The Exchange install any available Sentient AI Cores into their own network, leaving none for sale. However, they pay handsomely for these minds.",bonus:1.75}}},{id:g.KEPLER,name:"Kepler's Eye",description:"A massive deep-space observatory that consumes vast amounts of processing power.",color:"border-fuchsia-500",bg:"bg-gradient-to-br from-fuchsia-900 to-slate-900",fuelPrice:800,arrivalLore:"The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.",modifiers:{[u.SENTIENT_AI]:2,[u.PROCESSORS]:1.8,[u.CRYO_PODS]:1.3},specialDemand:{[u.XENO_GEOLOGICALS]:{lore:"All Xeno-Geologicals are immediately pulverized for analysis, so none are ever sold. However, the research council pays handsomely for new samples.",bonus:1.75}}}],P={...J.tutorials},V={guild_01:{id:"guild_01",name:"A Golden Opportunity",type:"DELIVERY",host:"GUILD",isRepeatable:!1,description:"The Guild requires a shipment of Plasteel for a construction project on Luna. Discretion is paramount. Deliver 50 units and you will be rewarded.",objectives:[{type:"have_item",goodId:u.PLASTEEL,quantity:50}],completion:{locationId:g.LUNA,title:"Delivery Complete",text:"The Merchant's Guild eagerly accepts delivery of 50 Plasteel. Your promptness has been noted.",buttonText:"Deliver Plasteel"},rewards:[{type:"credits",amount:25e3}]},syndicate_01:{id:"syndicate_01",name:"Syndicate Science",type:"ACQUISITION",host:"SYNDICATE",isRepeatable:!1,description:"Our research division on Venus requires a sample of Hydroponics for analysis. Acquire 25 units and deliver them. Your contribution will be noted.",objectives:[{type:"have_item",goodId:u.HYDROPONICS,quantity:25}],completion:{locationId:g.VENUS,title:"Acquisition Complete",text:"The Venetian Syndicate thanks you for the timely delivery. The Hydroponics will be put to good use.",buttonText:"Deliver Hydroponics"},rewards:[{type:"credits",amount:5e4}]}};var B={START_YEAR:2140,START_DAY_OF_WEEK:1,DAYS_IN_MONTH:[31,28,31,30,31,30,31,31,30,31,30,31],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]};function y(d,e=!0){let t=Math.floor(d),a=e?"\u232C ":"";return t>=1e12?`${a}${(t/1e12).toFixed(2)}T`:t>=1e9?`${a}${(t/1e9).toFixed(2)}B`:t>=1e6?`${a}${(t/1e6).toFixed(2)}M`:t>=1e3?`${a}${(t/1e3).toFixed(1)}k`:`${a}${t.toLocaleString()}`}function $(d){return d?Object.values(d).reduce((e,t)=>e+t.quantity,0):0}function ye(d){if(d>3&&d<21)return"th";switch(d%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function ue(d){let e=B.START_YEAR+Math.floor((d-1)/365),t=(d-1)%365,a=B.DAY_NAMES[(d-1+B.START_DAY_OF_WEEK)%7],i=0;for(let o=0;o<B.DAYS_IN_MONTH.length;o++){if(t<B.DAYS_IN_MONTH[o]){i=o;break}t-=B.DAYS_IN_MONTH[o]}let s=t+1,n=B.MONTH_NAMES[i];return`${a}, ${n} ${s}${ye(s)}, ${e}`}function pe(d,e){let t=(Math.random()+Math.random()+Math.random())/3;return Math.floor(d+(e-d)*Math.pow(t,.5))}function Se(d){let e={};return d.forEach((t,a)=>{e[t.id]={},d.forEach((i,s)=>{if(a===s)return;let n=Math.abs(a-s),o=n*2+Math.floor(Math.random()*3),r=Math.round(o*M.FUEL_SCALAR*(1+s/d.length*.5)),l;t.id===g.EARTH&&i.id===g.LUNA||t.id===g.LUNA&&i.id===g.EARTH?l=1+Math.floor(Math.random()*3):l=15+n*10+Math.floor(Math.random()*5),e[t.id][i.id]={time:l,fuelCost:Math.max(1,r)}})}),e}var Z=class{constructor(){this.state={},this.subscribers=[],this.TRAVEL_DATA=Se(A)}subscribe(e){this.subscribers.push(e)}_notify(){this.subscribers.forEach(e=>e(this))}setState(e){Object.assign(this,e),this._notify()}getState(){return JSON.parse(JSON.stringify(this))}saveGame(){}loadGame(){return!1}startNewGame(e){let t={day:1,lastInterestChargeDay:1,lastMarketUpdateDay:1,currentLocationId:g.MARS,activeNav:k.SHIP,activeScreen:v.NAVIGATION,isGameOver:!1,popupsDisabled:!1,introSequenceActive:!0,lastActiveScreen:{[k.SHIP]:v.STATUS,[k.STARPORT]:v.MARKET,[k.ADMIN]:v.MISSIONS},pendingTravel:null,player:{name:e,playerTitle:"Captain",playerAge:24,lastBirthdayYear:B.START_YEAR,birthdayProfitBonus:0,introStep:0,credits:1e4,debt:0,weeklyInterestAmount:0,loanStartDate:null,seenGarnishmentWarning:!1,unlockedCommodityLevel:1,unlockedLocationIds:[g.EARTH,g.LUNA,g.MARS,g.VENUS,g.BELT,g.SATURN],seenCommodityMilestones:[],financeLog:[],activePerks:{},seenEvents:[],activeShipId:T.WANDERER,ownedShipIds:[T.WANDERER],shipStates:{[T.WANDERER]:{health:E[T.WANDERER].maxHealth,fuel:E[T.WANDERER].maxFuel,hullAlerts:{one:!1,two:!1}}},inventories:{}},market:{prices:{},inventory:{},galacticAverages:{},priceHistory:{},shipyardStock:{}},intel:{active:null,available:{}},tutorials:{activeBatchId:null,activeStepId:null,seenBatchIds:[],skippedTutorialBatches:[]},missions:{activeMissionId:null,completedMissionIds:[],missionProgress:{},activeMissionObjectivesMet:!1}};t.player.inventories[T.WANDERER]={},_.forEach(a=>{t.player.inventories[T.WANDERER][a.id]={quantity:0,avgCost:0}}),A.forEach(a=>{t.market.priceHistory[a.id]={},t.intel.available[a.id]=Math.random()<.3,t.market.inventory[a.id]={},t.market.shipyardStock[a.id]={day:0,shipsForSale:[]},_.forEach(i=>{t.market.priceHistory[a.id][i.id]=[];let s=this._getTierAvailability(i.tier),n=pe(s.min,s.max);a.modifiers[i.id]&&a.modifiers[i.id]>1&&(n=Math.floor(n*1.5)),a.specialDemand&&a.specialDemand[i.id]&&(n=0),t.market.inventory[a.id][i.id]={quantity:Math.max(0,n)}})}),Object.assign(this,t),this._calculateGalacticAverages(),this._seedInitialMarketPrices(),this.setState({})}_getTierAvailability(e){switch(e){case 1:return{min:6,max:240};case 2:return{min:4,max:200};case 3:return{min:3,max:120};case 4:return{min:2,max:40};case 5:return{min:1,max:20};case 6:return{min:0,max:20};case 7:return{min:0,max:10};default:return{min:0,max:5}}}_calculateGalacticAverages(){this.market.galacticAverages={},_.forEach(e=>{this.market.galacticAverages[e.id]=(e.basePriceRange[0]+e.basePriceRange[1])/2})}_seedInitialMarketPrices(){A.forEach(e=>{this.market.prices[e.id]={},_.forEach(t=>{let a=this.market.galacticAverages[t.id]*(1+(Math.random()-.5)*.5);a*=e.modifiers[t.id]||1,this.market.prices[e.id][t.id]=Math.max(1,Math.round(a))})})}};var z={INTEL_COST_PERCENTAGE:.2,INTEL_MIN_CREDITS:5e3,INTEL_CHANCE:.3,INTEL_DEMAND_MOD:1.8,INTEL_DEPRESSION_MOD:.5,COMMODITY_MILESTONES:[{threshold:3e4,unlockLevel:2,message:"Your growing reputation has unlocked access to more advanced industrial hardware.<br>New opportunities await."},{threshold:3e5,unlockLevel:3,message:"Word of your success is spreading. High-tech biological and medical markets are now open to you.",unlocksLocation:g.URANUS},{threshold:5e6,unlockLevel:4,message:"Your influence is undeniable. Contracts for planetary-scale infrastructure are now within your reach.",unlocksLocation:g.NEPTUNE},{threshold:75e6,unlockLevel:5,message:"You now operate on a level few can comprehend. The most exotic and reality-bending goods are available to you.",unlocksLocation:g.PLUTO},{threshold:1e8,message:"Your name is legend. You've been granted clearance to 'Kepler's Eye', a deep space observatory with unique scientific demands.",unlocksLocation:g.KEPLER},{threshold:5e8,unlockLevel:6,message:"You now operate on a level few can comprehend. The most exotic and reality-bending goods are available to you.",unlocksLocation:g.EXCHANGE}]};function me(d,e,t,a){let i=e._getActiveShip(),s=Math.floor(d.player.credits*t.wagerPercentage),n=t.winChance[i.class]||.4;Math.random()<n?(d.player.credits+=s,e._logTransaction("event",s,"Won space race wager"),a.description=`Your Class ${i.class} ship wins! You gain <span class="hl-green">${y(s)}</span>.`):(d.player.credits-=s,e._logTransaction("event",-s,"Lost space race wager"),a.description=`The luxury ship was too fast. You lose <span class="hl-red">${y(s)}</span>.`)}function ge(d,e,t,a){let i=e._getActiveShip(),s=d.player.shipStates[i.id],n=e._getActiveInventory();if(s.fuel=Math.max(0,s.fuel-30),n[u.CYBERNETICS]||(n[u.CYBERNETICS]={quantity:0,avgCost:0}),$(n)+40<=i.cargoCapacity)return n[u.CYBERNETICS].quantity+=40,{key:"reward_cybernetics"};if(d.player.debt>0){let o=Math.floor(d.player.debt*.2);return d.player.debt-=o,e._logTransaction("event",o,"Passenger paid off debt"),{key:"reward_debt_paid",amount:y(o)}}else{let o=Math.floor(d.player.credits*.05);return d.player.credits+=o,e._logTransaction("event",o,"Passenger payment"),{key:"reward_credits",amount:y(o)}}}var be={SPACE_RACE:me,ADRIFT_PASSENGER:ge,credits:(d,e,t)=>{d.player.credits+=t.value,e._logTransaction("event",t.value,"Received credits from event")},fuel:(d,e,t)=>{let a=e._getActiveShip(),i=d.player.shipStates[a.id];i.fuel=Math.max(0,i.fuel+t.value)},hull_damage_percent:(d,e,t)=>{let a=Array.isArray(t.value)?Math.random()*(t.value[1]-t.value[0])+t.value[0]:t.value;d.pendingTravel.eventHullDamagePercent=(d.pendingTravel.eventHullDamagePercent||0)+a},travel_time_add:(d,e,t)=>{d.pendingTravel.travelTimeAdd=(d.pendingTravel.travelTimeAdd||0)+t.value},travel_time_add_percent:(d,e,t)=>{d.pendingTravel.travelTimeAddPercent=(d.pendingTravel.travelTimeAddPercent||0)+t.value},set_travel_time:(d,e,t)=>{d.pendingTravel.setTravelTime=t.value},add_debt:(d,e,t)=>{d.player.debt<=0&&(d.player.loanStartDate=d.day,d.player.weeklyInterestAmount=0);let a=Math.ceil(t.value*.013);d.player.weeklyInterestAmount+=a,d.player.debt+=t.value,e._logTransaction("loan",t.value,"Incurred debt from event")},add_cargo:(d,e,t,a)=>{let i=e._getActiveShip(),s=e._getActiveInventory(),n=_.find(o=>o.id===t.value.id);$(s)+t.value.quantity<=i.cargoCapacity?s[t.value.id].quantity+=t.value.quantity:a.description=`You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${n.name}</span> behind.`},lose_cargo:(d,e,t)=>{let a=e._getActiveInventory();a[t.value.id].quantity=Math.max(0,a[t.value.id].quantity-t.value.quantity)},lose_random_cargo_percent:(d,e,t)=>{let a=e._getActiveInventory(),i=Object.entries(a).filter(([,s])=>s.quantity>0);if(i.length>0){let[s,n]=i[Math.floor(Math.random()*i.length)];n.quantity=Math.max(0,n.quantity-Math.ceil(n.quantity*t.value))}},sell_random_cargo_premium:(d,e,t)=>{let a=e._getActiveInventory(),i=Object.entries(a).filter(([,s])=>s.quantity>0);if(i.length>0){let[s,n]=i[Math.floor(Math.random()*i.length)],o=d.market.galacticAverages[s]*t.value*n.quantity;d.player.credits+=o,e._logTransaction("trade",o,"Emergency supply drop sale"),n.quantity=0}},set_new_random_destination:(d,e,t)=>{let a=A.filter(i=>i.id!==d.currentLocationId&&d.player.unlockedLocationIds.includes(i.id));a.length>0&&(d.pendingTravel.destinationId=a[Math.floor(Math.random()*a.length)].id)}};function fe(d,e,t,a){let i=be[t.type];i?i(d,e,t,a):console.warn(`No handler found for event effect type: ${t.type}`)}var ee=class{constructor(e){this.gameState=e}evolveMarketPrices(){A.forEach(e=>{_.forEach(t=>{if(t.unlockLevel>this.gameState.player.unlockedCommodityLevel)return;let a=this.gameState.market.prices[e.id][t.id],i=this.gameState.market.galacticAverages[t.id],s=e.modifiers[t.id]||1,n=i*s,o=(Math.random()-.5)*2*M.DAILY_PRICE_VOLATILITY,r=(n-a)*M.MEAN_REVERSION_STRENGTH;this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(a+a*o+r))})}),this._recordPriceHistory()}replenishMarketInventory(){A.forEach(e=>{_.forEach(t=>{if(t.unlockLevel>this.gameState.player.unlockedCommodityLevel)return;let a=this.gameState.market.inventory[e.id][t.id],s=this._getTierAvailability(t.tier).max,n=.1;a.quantity<s&&(a.quantity=Math.min(s,a.quantity+Math.ceil(s*n))),e.specialDemand&&e.specialDemand[t.id]&&(a.quantity=0)})})}_getTierAvailability(e){switch(e){case 1:return{min:6,max:240};case 2:return{min:4,max:200};case 3:return{min:3,max:120};case 4:return{min:2,max:40};case 5:return{min:1,max:20};case 6:return{min:0,max:20};case 7:return{min:0,max:10};default:return{min:0,max:5}}}_recordPriceHistory(){!this.gameState||!this.gameState.market||A.forEach(e=>{this.gameState.market.priceHistory[e.id]||(this.gameState.market.priceHistory[e.id]={}),_.forEach(t=>{if(t.unlockLevel>this.gameState.player.unlockedCommodityLevel)return;this.gameState.market.priceHistory[e.id][t.id]||(this.gameState.market.priceHistory[e.id][t.id]=[]);let a=this.gameState.market.priceHistory[e.id][t.id],i=this.gameState.market.prices[e.id][t.id];for(a.push({day:this.gameState.day,price:i});a.length>M.PRICE_HISTORY_LENGTH;)a.shift()})})}};var te=class{constructor(e,t){this.gameState=e,this.uiManager=t,this.tutorialService=null,this.missionService=null,this.marketService=new ee(e)}setTutorialService(e){this.tutorialService=e}setMissionService(e){this.missionService=e}startIntroSequence(){this.gameState.introSequenceActive&&(this.gameState.player.introStep=0,this._showNextIntroModal())}_showNextIntroModal(){let e=J.modals[this.gameState.player.introStep];if(!e){this._endIntroSequence();return}let t={buttonClass:e.buttonClass,contentClass:e.contentClass},a="event-modal";e.id==="charter"||e.id==="signature"?(a=`${e.id}-modal`,t.customSetup=(i,s)=>{this._setupIntroModal(i,e,s)}):t.customSetup=(i,s)=>{let n=i.querySelector("#event-button-container");if(!n)return;n.innerHTML="";let o=document.createElement("button");o.className="btn px-6 py-2",e.buttonClass&&o.classList.add(e.buttonClass),o.id="intro-next-btn",o.innerHTML=e.buttonText,o.onclick=r=>{r.target.disabled=!0,s()},n.appendChild(o)},this.uiManager.queueModal(a,e.title,e.description,null,t)}_setupIntroModal(e,t,a){let i=e.querySelector(`#${t.id}-button-container`);i.innerHTML="";let s=document.createElement("button");if(s.className="btn px-6 py-2",s.innerHTML=t.buttonText,s.onclick=n=>{n.target.disabled=!0,a()},i.appendChild(s),t.id==="signature"){let n=e.querySelector("#signature-input");n.value="",s.id="intro-submit-btn",s.disabled=!0,s.onclick=a,n.oninput=()=>{s.disabled=n.value.trim()===""}}else s.id="intro-next-btn"}handleIntroClick(e){let t=e.target.closest("button");if(!t)return;let a=t.id;if(a==="intro-next-btn")t.disabled=!0,this.gameState.player.introStep++,this._showNextIntroModal();else if(a==="intro-submit-btn"){t.disabled=!0;let s=document.getElementById("signature-input").value.trim().replace(/[^a-zA-Z0-9 ]/g,"");s?(this.gameState.player.name=s,this.gameState.player.debt=25e3,this.gameState.player.loanStartDate=this.gameState.day,this.gameState.player.weeklyInterestAmount=325,this.gameState.player.ownedShipIds=[],delete this.gameState.player.shipStates[T.WANDERER],delete this.gameState.player.inventories[T.WANDERER],this.gameState.player.activeShipId=null,this._startProcessingSequence()):(this.uiManager.queueModal("event-modal","Invalid Signature","The Merchant's Guild requires a name on the contract. Please provide your legal mark."),t.disabled=!1,this._showNextIntroModal())}}_startProcessingSequence(){let e=()=>{let t="Loan Approved",a=`Dear ${this.gameState.player.name},<br><br>Your line of credit has been approved.<br><span class="credits-text-pulsing">\u232C25,000</span> is ready to transfer to your account.`,i=s=>{let n=s.target;n&&(n.disabled=!0),this.uiManager.createFloatingText(`+${y(25e3,!1)}`,s.clientX,s.clientY,"#34d399"),this.gameState.player.credits+=25e3,setTimeout(()=>{document.getElementById("game-container").classList.remove("hidden"),this.uiManager.render(this.gameState.getState()),this.setScreen(k.STARPORT,v.HANGAR),this.tutorialService.checkState({type:"ACTION",action:"INTRO_START_HANGAR"})},2e3)};this.uiManager.queueModal("event-modal",t,a,null,{contentClass:"text-center",customSetup:(s,n)=>{s.querySelector(".modal-content").classList.add("modal-theme-admin");let o=s.querySelector("#event-button-container");o.innerHTML="";let r=document.createElement("button");r.className="btn px-6 py-2",r.innerHTML="Accept Transfer",r.onclick=l=>{i(l),n()},o.appendChild(r)}})};this.uiManager.showProcessingAnimation(this.gameState.player.name,e)}_continueIntroSequence(e){e==="intro_hangar"?(this.setScreen(k.ADMIN,v.FINANCE),this.tutorialService.checkState({type:"ACTION",action:"INTRO_START_FINANCE"})):e==="intro_finance"&&this._endIntroSequence()}_endIntroSequence(){this.gameState.introSequenceActive=!1;let e=J.modals.find(i=>i.id==="final"),t=E[this.gameState.player.activeShipId].name,a=e.buttonText.replace("{shipName}",t);this.uiManager.queueModal("event-modal",e.title,e.description,()=>{this.setScreen(k.ADMIN,v.MISSIONS)},{buttonText:a}),this.uiManager.render(this.gameState.getState())}setScreen(e,t){let a={...this.gameState.lastActiveScreen,[e]:t};this.gameState.setState({activeNav:e,activeScreen:t,lastActiveScreen:a}),this.uiManager.render(this.gameState.getState()),this.tutorialService&&this.tutorialService.checkState({type:"SCREEN_LOAD",screenId:t})}travelTo(e){let t=this.gameState.getState();if(t.isGameOver||t.pendingTravel)return;if(t.currentLocationId===e){this.setScreen(k.STARPORT,v.MARKET);return}let a=this._getActiveShip();if(!a){this.uiManager.queueModal("event-modal","No Active Ship","You must have an active vessel to travel.");return}let s=t.TRAVEL_DATA[t.currentLocationId][e].fuelCost;if(t.player.activePerks[I.NAVIGATOR]&&(s=Math.round(s*G[I.NAVIGATOR].fuelMod)),a.maxFuel<s){this.uiManager.queueModal("event-modal","Fuel Capacity Insufficient",`Your ship's fuel tank is too small. This trip requires ${s} fuel, but you can only hold ${a.maxFuel}.`);return}if(a.fuel<s){this.uiManager.queueModal("event-modal","Insufficient Fuel",`You need ${s} fuel but only have ${Math.floor(a.fuel)}.`);return}this._checkForRandomEvent(e)||this.initiateTravel(e)}initiateTravel(e,t={}){let a=this.gameState.getState(),i=a.currentLocationId,s={...a.TRAVEL_DATA[i][e]};a.player.activePerks[I.NAVIGATOR]&&(s.time=Math.round(s.time*G[I.NAVIGATOR].travelTimeMod),s.fuelCost=Math.round(s.fuelCost*G[I.NAVIGATOR].fuelMod)),t.travelTimeAdd&&(s.time+=t.travelTimeAdd),t.travelTimeAddPercent&&(s.time*=1+t.travelTimeAddPercent),t.setTravelTime&&(s.time=t.setTravelTime),s.time=Math.max(1,Math.round(s.time));let n=this._getActiveShip(),o=this.gameState.player.shipStates[n.id];if(n.fuel<s.fuelCost){this.uiManager.queueModal("event-modal","Insufficient Fuel",`Trip modifications left you without enough fuel. You need ${s.fuelCost} but only have ${Math.floor(n.fuel)}.`);return}if(t.forceEvent&&this._checkForRandomEvent(e,!0))return;let r=s.time*M.HULL_DECAY_PER_TRAVEL_DAY;a.player.activePerks[I.NAVIGATOR]&&(r*=G[I.NAVIGATOR].hullDecayMod);let l=n.maxHealth*((t.eventHullDamagePercent||0)/100),c=r+l;if(o.health-=c,this._checkHullWarnings(n.id),o.health<=0){this._handleShipDestruction(n.id);return}if(o.fuel-=s.fuelCost,this._advanceDays(s.time),this.gameState.isGameOver)return;this.gameState.setState({currentLocationId:e,pendingTravel:null});let h=A.find(S=>S.id===i),m=A.find(S=>S.id===e),f=c/n.maxHealth*100;this.uiManager.showTravelAnimation(h,m,s,f,()=>{this.setScreen(k.STARPORT,v.MARKET)})}resumeTravel(){if(!this.gameState.pendingTravel)return;let{destinationId:e,...t}=this.gameState.pendingTravel;this.initiateTravel(e,t)}buyItem(e,t){let a=this.gameState.getState();if(a.isGameOver||t<=0)return!1;let i=_.find(h=>h.id===e),n=this.uiManager.getItemPrice(a,e)*t,o=a.market.inventory[a.currentLocationId][e].quantity;if(o<=0)return this.uiManager.queueModal("event-modal","Sold Out",`This station has no more ${i.name} available.`),!1;if(t>o)return this.uiManager.queueModal("event-modal","Limited Stock",`This station only has ${o} units available.`),!1;let r=this._getActiveShip(),l=this._getActiveInventory();if($(l)+t>r.cargoCapacity)return this.uiManager.queueModal("event-modal","Cargo Hold Full","You don't have enough space."),!1;if(a.player.credits<n)return this.uiManager.queueModal("event-modal","Insufficient Funds","Your credit balance is too low."),!1;this.gameState.market.inventory[a.currentLocationId][e].quantity-=t;let c=l[e];return c.avgCost=(c.quantity*c.avgCost+n)/(c.quantity+t),c.quantity+=t,this.gameState.player.credits-=n,this._logConsolidatedTrade(i.name,t,-n),this._checkMilestones(),this.missionService.checkTriggers(),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),!0}sellItem(e,t){let a=this.gameState.getState();if(a.isGameOver||t<=0)return 0;let i=_.find(c=>c.id===e),n=this._getActiveInventory()[e];if(!n||n.quantity<t)return 0;this.gameState.market.inventory[a.currentLocationId][e].quantity+=t;let r=this.uiManager.getItemPrice(a,e,!0)*t,l=r-n.avgCost*t;if(l>0){let c=(a.player.activePerks[I.TRADEMASTER]?G[I.TRADEMASTER].profitBonus:0)+(a.player.birthdayProfitBonus||0);r+=l*c}return r=Math.floor(r),this.gameState.player.credits+=r,n.quantity-=t,n.quantity===0&&(n.avgCost=0),this._logConsolidatedTrade(i.name,t,r),this._checkMilestones(),this.missionService.checkTriggers(),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),r}buyShip(e){let t=E[e];return this.gameState.player.credits<t.price?(this.uiManager.queueModal("event-modal","Insufficient Funds","You cannot afford this ship."),!1):(this.gameState.player.credits-=t.price,this._logTransaction("ship",-t.price,`Purchased ${t.name}`),this.addShipToHangar(e),this.uiManager.queueModal("event-modal","Acquisition Complete",`The ${t.name} has been transferred to your hangar.`),this.gameState.introSequenceActive&&this.tutorialService.checkState({type:"ACTION",action:p.BUY_SHIP}),this.gameState.setState({}),this.uiManager.updateStickyBar(this.gameState.getState()),!0)}sellShip(e){let t=this.gameState.getState();if(t.player.ownedShipIds.length<=1)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your last remaining ship."),!1;if(e===t.player.activeShipId)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your active ship."),!1;if($(t.player.inventories[e])>0)return this.uiManager.queueModal("event-modal","Cannot Sell Ship","This vessel's cargo hold is not empty."),!1;let a=E[e],i=Math.floor(a.price*M.SHIP_SELL_MODIFIER);return this.gameState.player.credits+=i,this._logTransaction("ship",i,`Sold ${a.name}`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(s=>s!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.uiManager.queueModal("event-modal","Vessel Sold",`You sold the ${a.name} for ${y(i)}.`),this.gameState.setState({}),this.uiManager.updateStickyBar(this.gameState.getState()),i}setActiveShip(e){this.gameState.player.ownedShipIds.includes(e)&&(this.gameState.player.activeShipId=e,this.gameState.introSequenceActive&&this.tutorialService.checkState({type:"ACTION",action:p.SELECT_SHIP}),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}payOffDebt(){if(this.gameState.isGameOver)return;let{player:e}=this.gameState;if(e.credits<e.debt){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford to pay off your entire debt.");return}let t=e.debt;e.credits-=t,this._logTransaction("loan",-t,`Paid off ${y(t)} debt`),e.debt=0,e.weeklyInterestAmount=0,e.loanStartDate=null,this._checkMilestones(),this.gameState.setState({}),this.uiManager.updateStickyBar(this.gameState.getState()),this.uiManager.renderFinanceScreen(this.gameState.getState())}takeLoan(e){let{player:t,day:a}=this.gameState;if(t.debt>0){this.uiManager.queueModal("event-modal","Loan Unavailable","You must pay off your existing debt first.");return}if(t.credits<e.fee){this.uiManager.queueModal("event-modal","Unable to Secure Loan",`The financing fee is ${y(e.fee)}, but you only have ${y(t.credits)}.`);return}t.credits-=e.fee,this._logTransaction("loan",-e.fee,`Financing fee for ${y(e.amount)} loan`),t.credits+=e.amount,this._logTransaction("loan",e.amount,`Acquired ${y(e.amount)} loan`),t.debt+=e.amount,t.weeklyInterestAmount=e.interest,t.loanStartDate=a,t.seenGarnishmentWarning=!1;let i=`You've acquired a loan of <span class="hl-blue">${y(e.amount)}</span>.<br>A financing fee of <span class="hl-red">${y(e.fee)}</span> was deducted.`;this.uiManager.queueModal("event-modal","Loan Acquired",i),this.gameState.setState({}),this.uiManager.updateStickyBar(this.gameState.getState()),this.uiManager.renderFinanceScreen(this.gameState.getState())}purchaseIntel(e){let{player:t,currentLocationId:a,day:i}=this.gameState;if(t.credits<e){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford this intel.");return}t.credits-=e,this._logTransaction("intel",-e,"Purchased market intel"),this.gameState.intel.available[a]=!1;let s=A.filter(l=>l.id!==a&&t.unlockedLocationIds.includes(l.id));if(s.length===0)return;let n=s[Math.floor(Math.random()*s.length)],o=_.filter(l=>l.unlockLevel<=t.unlockedCommodityLevel),r=o[Math.floor(Math.random()*o.length)];r&&(this.gameState.intel.active={targetMarketId:n.id,commodityId:r.id,type:"demand",startDay:i,endDay:i+100}),this.gameState.setState({}),this.uiManager.updateStickyBar(this.gameState.getState())}refuelTick(){let e=this.gameState,t=this._getActiveShip();if(t.fuel>=t.maxFuel)return 0;let a=A.find(i=>i.id===e.currentLocationId).fuelPrice/2;return e.player.activePerks[I.VENETIAN_SYNDICATE]&&e.currentLocationId===g.VENUS&&(a*=1-G[I.VENETIAN_SYNDICATE].fuelDiscount),e.player.credits<a?0:(e.player.credits-=a,e.player.shipStates[t.id].fuel=Math.min(t.maxFuel,e.player.shipStates[t.id].fuel+5),this._logConsolidatedTransaction("fuel",-a,"Fuel Purchase"),this.gameState.setState({}),a)}repairTick(){let e=this.gameState,t=this._getActiveShip();if(t.health>=t.maxHealth)return 0;let a=t.maxHealth*(M.REPAIR_AMOUNT_PER_TICK/100)*M.REPAIR_COST_PER_HP;return e.player.activePerks[I.VENETIAN_SYNDICATE]&&e.currentLocationId===g.VENUS&&(a*=1-G[I.VENETIAN_SYNDICATE].repairDiscount),e.player.credits<a?0:(e.player.credits-=a,e.player.shipStates[t.id].health=Math.min(t.maxHealth,e.player.shipStates[t.id].health+t.maxHealth*(M.REPAIR_AMOUNT_PER_TICK/100)),this._logConsolidatedTransaction("repair",-a,"Hull Repairs"),this._checkHullWarnings(t.id),this.gameState.setState({}),a)}_advanceDays(e){let t=!1;for(let a=0;a<e;a++){if(this.gameState.isGameOver)return;this.gameState.day++;let i=(this.gameState.day-1)%365,s=B.START_YEAR+Math.floor((this.gameState.day-1)/365);if(i===11&&s>this.gameState.player.lastBirthdayYear&&(this.gameState.player.playerAge++,this.gameState.player.birthdayProfitBonus+=.01,this.gameState.player.lastBirthdayYear=s,this.uiManager.queueModal("event-modal",`Captain ${this.gameState.player.name}`,`You are now ${this.gameState.player.playerAge}. You feel older and wiser.<br><br>Your experience now grants you an additional 1% profit on all trades.`)),this._checkAgeEvents(),this.gameState.day-this.gameState.lastMarketUpdateDay>=7&&(this.marketService.evolveMarketPrices(),this.marketService.replenishMarketInventory(),this._applyGarnishment(),this._updateShipyardStock(),this.gameState.lastMarketUpdateDay=this.gameState.day,t=!0),this.gameState.intel.active&&this.gameState.day>this.gameState.intel.active.endDay&&(this.gameState.intel.active=null),this.gameState.player.ownedShipIds.forEach(n=>{if(n!==this.gameState.player.activeShipId){let o=E[n],r=o.maxHealth*M.PASSIVE_REPAIR_RATE;this.gameState.player.shipStates[n].health=Math.min(o.maxHealth,this.gameState.player.shipStates[n].health+r)}}),this.gameState.player.debt>0&&this.gameState.day-this.gameState.lastInterestChargeDay>=M.INTEREST_INTERVAL){let n=this.gameState.player.weeklyInterestAmount;this.gameState.player.debt+=n,this._logTransaction("loan",n,"Weekly interest charge"),this.gameState.lastInterestChargeDay=this.gameState.day}}t&&this.gameState.activeScreen===v.MARKET&&this.uiManager.renderMarketScreen(this.gameState.getState()),this.gameState.setState({})}_checkForRandomEvent(e,t=!1){if(!t&&Math.random()>M.RANDOM_EVENT_CHANCE)return!1;let a=this._getActiveShip(),i=ce.filter(n=>n.precondition(this.gameState.getState(),a,this._getActiveInventory.bind(this)));if(i.length===0)return!1;let s=i[Math.floor(Math.random()*i.length)];return this.gameState.setState({pendingTravel:{destinationId:e}}),this.uiManager.showRandomEventModal(s,(n,o)=>this._resolveEventChoice(n,o)),!0}_resolveEventChoice(e,t){let a=ce.find(l=>l.id===e),i=a.choices[t],s=Math.random(),n=i.outcomes.find(l=>(s-=l.chance)<0)||i.outcomes[i.outcomes.length-1],o=this._applyEventEffects(n),r=n.description;o&&n.descriptions&&(r=n.descriptions[o.key],o.amount&&(r=r.replace("{amount}",o.amount))),this.uiManager.queueModal("event-modal",a.title,r,()=>this.resumeTravel(),{buttonText:"Continue Journey"})}_applyEventEffects(e){let t=null;return e.effects.forEach(a=>{let i=fe(this.gameState,this,a,e);i&&(t=i)}),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),t}_checkAgeEvents(){he.forEach(e=>{this.gameState.player.seenEvents.includes(e.id)||(e.trigger.day&&this.gameState.day>=e.trigger.day||e.trigger.credits&&this.gameState.player.credits>=e.trigger.credits)&&(this.gameState.player.seenEvents.push(e.id),this.uiManager.showAgeEventModal(e,t=>this._applyPerk(t)))})}_applyPerk(e){e.perkId&&(this.gameState.player.activePerks[e.perkId]=!0),e.playerTitle&&(this.gameState.player.playerTitle=e.playerTitle),e.perkId===I.MERCHANT_GUILD_SHIP&&(this.addShipToHangar(T.STALWART),this.uiManager.queueModal("event-modal","Vessel Delivered",`The Merchant's Guild has delivered a new ${E[T.STALWART].name} to your hangar.`)),this.gameState.setState({})}_getActiveShip(){let e=this.gameState,t=e.player.activeShipId;return t?{id:t,...E[t],...e.player.shipStates[t]}:null}_getActiveInventory(){return this.gameState.player.activeShipId?this.gameState.player.inventories[this.gameState.player.activeShipId]:null}_logTransaction(e,t,a){this.gameState.player.financeLog.push({day:this.gameState.day,type:e,amount:t,balance:this.gameState.player.credits,description:a})}_logConsolidatedTrade(e,t,a){let i=this.gameState.player.financeLog,s=a<0,n=s?"Bought":"Sold",o=i.find(r=>r.day===this.gameState.day&&r.type==="trade"&&r.description.startsWith(`${n}`)&&r.description.endsWith(` ${e}`)&&(s&&r.amount<0||!s&&r.amount>0));if(o){o.amount+=a,o.balance=this.gameState.player.credits;let r=o.description.match(/\s(\d+)x\s/);if(r){let c=parseInt(r[1],10)+t;o.description=`${n} ${c}x ${e}`}else o.description+=` & ${t}x more`}else this._logTransaction("trade",a,`${n} ${t}x ${e}`)}_logConsolidatedTransaction(e,t,a){let i=this.gameState.player.financeLog,s=i.length>0?i[i.length-1]:null;s&&s.day===this.gameState.day&&s.type===e?(s.amount+=t,s.balance=this.gameState.player.credits):this._logTransaction(e,t,a)}_checkMilestones(){let e=!1;return z.COMMODITY_MILESTONES.forEach(t=>{if(this.gameState.player.credits>=t.threshold&&!this.gameState.player.seenCommodityMilestones.includes(t.threshold)){this.gameState.player.seenCommodityMilestones.push(t.threshold);let a=t.message;if(t.unlockLevel&&t.unlockLevel>this.gameState.player.unlockedCommodityLevel&&(this.gameState.player.unlockedCommodityLevel=t.unlockLevel,e=!0),t.unlocksLocation&&!this.gameState.player.unlockedLocationIds.includes(t.unlocksLocation)){this.gameState.player.unlockedLocationIds.push(t.unlocksLocation);let i=A.find(s=>s.id===t.unlocksLocation);a+=`<br><br><span class="hl-blue">New Destination:</span> Access to <span class="hl">${i.name}</span> has been granted.`,e=!0}e&&this.uiManager.queueModal("event-modal","Reputation Growth",a)}}),e}_checkHullWarnings(e){let t=this.gameState.player.shipStates[e],a=E[e],i=t.health/a.maxHealth*100;i<=15&&!t.hullAlerts.two?(this.uiManager.showToast("hullWarningToast",`System Warning: Hull Health at ${Math.floor(i)}%.`),t.hullAlerts.two=!0):i<=30&&!t.hullAlerts.one&&(this.uiManager.showToast("hullWarningToast",`System Warning: Hull Health at ${Math.floor(i)}%.`),t.hullAlerts.one=!0),i>30&&(t.hullAlerts.one=!1),i>15&&(t.hullAlerts.two=!1)}_handleShipDestruction(e){let t=E[e].name;if(this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(a=>a!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.gameState.player.ownedShipIds.length===0)this._gameOver(`Your last ship, the ${t}, was destroyed. Your trading career ends here.`);else{this.gameState.player.activeShipId=this.gameState.player.ownedShipIds[0];let a=E[this.gameState.player.activeShipId].name,i=`The ${t} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${a}.`;this.uiManager.queueModal("event-modal","Vessel Lost",i)}this.gameState.setState({})}_gameOver(e){this.gameState.setState({isGameOver:!0}),this.uiManager.queueModal("event-modal","Game Over",e,()=>{localStorage.removeItem(de),window.location.reload()},{buttonText:"Restart"})}_applyGarnishment(){let{player:e,day:t}=this.gameState;if(e.debt>0&&e.loanStartDate&&t-e.loanStartDate>=M.LOAN_GARNISHMENT_DAYS){let a=Math.floor(e.credits*M.LOAN_GARNISHMENT_PERCENT);a>0&&(e.credits-=a,this.uiManager.showToast("garnishmentToast",`14% of credits garnished: -${y(a,!1)}`),this._logTransaction("debt",-a,"Weekly credit garnishment")),e.seenGarnishmentWarning||(this.uiManager.queueModal("event-modal","Credit Garnishment Notice","Your loan is delinquent. Your lender is now garnishing 14% of your credits weekly until the debt is paid.",null,{buttonClass:"bg-red-800/80"}),e.seenGarnishmentWarning=!0)}}_updateShipyardStock(){let{player:e}=this.gameState;e.unlockedLocationIds.forEach(t=>{let a=this.gameState.market.shipyardStock[t];if(a&&a.day===this.gameState.day)return;let i=Object.entries(E).filter(([o,r])=>!r.isRare&&r.saleLocationId===t&&!e.ownedShipIds.includes(o)),s=Object.entries(E).filter(([o,r])=>r.isRare&&r.saleLocationId===t&&!e.ownedShipIds.includes(o)),n=[...i.map(o=>o[0])];s.forEach(([o,r])=>{Math.random()<M.RARE_SHIP_CHANCE&&n.push(o)}),this.gameState.market.shipyardStock[t]={day:this.gameState.day,shipsForSale:n}})}_grantRewards(e,t){e.forEach(a=>{a.type==="credits"&&(this.gameState.player.credits+=a.amount,this._logTransaction("mission",a.amount,`Reward: ${t}`),this.uiManager.createFloatingText(`+${y(a.amount,!1)}`,window.innerWidth/2,window.innerHeight/2,"#34d399"))})}addShipToHangar(e){let t=E[e];t&&(this.gameState.player.ownedShipIds.push(e),this.gameState.player.shipStates[e]={health:t.maxHealth,fuel:t.maxFuel,hullAlerts:{one:!1,two:!1}},this.gameState.player.inventories[e]={},_.forEach(a=>{this.gameState.player.inventories[e][a.id]={quantity:0,avgCost:0}}))}debugQuickStart(){this.gameState.introSequenceActive=!1,this.tutorialService.activeBatchId=null,this.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(P),this.gameState.player.credits=1e4,this.gameState.player.ownedShipIds=[],this.addShipToHangar(T.WANDERER),this.gameState.player.activeShipId=T.WANDERER,document.getElementById("game-container").classList.remove("hidden"),this.setScreen(k.SHIP,v.NAVIGATION)}};var ae=class{constructor(){this.isMobile=window.innerWidth<=768,this.modalQueue=[],this.activeGraphAnchor=null,this.activeGenericTooltipAnchor=null,this.activeTutorialHighlight=null,this.lastActiveScreenEl=null,this.lastKnownState=null,this.navStructure={[k.SHIP]:{label:"Ship",screens:{[v.STATUS]:"Status",[v.NAVIGATION]:"Navigation",[v.SERVICES]:"Services"}},[k.STARPORT]:{label:"Starport",screens:{[v.MARKET]:"Market",[v.CARGO]:"Cargo",[v.HANGAR]:"Hangar"}},[k.ADMIN]:{label:"Admin",screens:{[v.MISSIONS]:"Missions",[v.FINANCE]:"Finance",[v.INTEL]:"Intel"}}},this._cacheDOM(),window.addEventListener("resize",()=>{let e=this.isMobile;this.isMobile=window.innerWidth<=768,e!==this.isMobile&&this.render(this.lastKnownState)})}_cacheDOM(){this.cache={gameContainer:document.getElementById("game-container"),navBar:document.getElementById("nav-bar"),subNavBar:document.getElementById("sub-nav-bar"),stickyBar:document.getElementById("sticky-bar"),statusScreen:document.getElementById(`${v.STATUS}-screen`),navigationScreen:document.getElementById(`${v.NAVIGATION}-screen`),servicesScreen:document.getElementById(`${v.SERVICES}-screen`),marketScreen:document.getElementById(`${v.MARKET}-screen`),cargoScreen:document.getElementById(`${v.CARGO}-screen`),hangarScreen:document.getElementById(`${v.HANGAR}-screen`),missionsScreen:document.getElementById(`${v.MISSIONS}-screen`),financeScreen:document.getElementById(`${v.FINANCE}-screen`),intelScreen:document.getElementById(`${v.INTEL}-screen`),saveToast:document.getElementById("save-toast"),garnishmentToast:document.getElementById("garnishment-toast"),hullWarningToast:document.getElementById("hull-warning-toast"),debugToast:document.getElementById("debug-toast"),starportUnlockTooltip:document.getElementById("starport-unlock-tooltip"),graphTooltip:document.getElementById("graph-tooltip"),genericTooltip:document.getElementById("generic-tooltip"),processingModal:document.getElementById("processing-modal"),shipDetailModal:document.getElementById("ship-detail-modal"),tutorialToastContainer:document.getElementById("tutorial-toast-container"),tutorialToastText:document.getElementById("tutorial-toast-text"),tutorialToastSkipBtn:document.getElementById("tutorial-toast-skip-btn"),tutorialToastNextBtn:document.getElementById("tutorial-toast-next-btn"),skipTutorialModal:document.getElementById("skip-tutorial-modal"),skipTutorialConfirmBtn:document.getElementById("skip-tutorial-confirm-btn"),skipTutorialCancelBtn:document.getElementById("skip-tutorial-cancel-btn")}}render(e){if(!e||!e.player)return;this.lastKnownState=e;let t=A.find(a=>a.id===e.currentLocationId);t&&(this.cache.gameContainer.className=`game-container p-4 md:p-8 ${t.bg}`),this.renderNavigation(e),this.renderActiveScreen(e),this.updateStickyBar(e),this.renderStickyBar(e)}renderNavigation(e){let{activeNav:t,activeScreen:a,lastActiveScreen:i,introSequenceActive:s}=e,n=s?"disabled":"",o=s?"btn-intro-locked":"",r=Object.entries(this.navStructure).map(([m,f])=>{let S=m===t,b=i[m]||Object.keys(f.screens)[0];return`
                <button class="btn btn-header theme-${m} ${S?"btn-nav-active":""} ${o}" 
                        data-action="${p.SET_SCREEN}" data-nav-id="${m}" data-screen-id="${b}" ${n}>
                    ${f.label}
                </button>`}).join("");this.cache.navBar.innerHTML=`<div class="flex justify-around w-full gap-2 md:gap-4">${r}</div>`;let l=this.navStructure[t]?.screens||{},c=`theme-${t}`,h=Object.entries(l).map(([m,f])=>`
                <button class="btn btn-sub-nav ${m===a?"btn-sub-nav-active":""} ${o}"
                        data-action="${p.SET_SCREEN}" data-nav-id="${t}" data-screen-id="${m}" ${n}>
                    ${f}
                </button>`).join("");this.cache.subNavBar.innerHTML=`<div class="flex justify-center w-full gap-2 md:gap-4 mt-3 ${c}">${h}</div>`}renderActiveScreen(e){let t=document.getElementById(`${e.activeScreen}-screen`);switch(this.lastActiveScreenEl&&this.lastActiveScreenEl!==t&&(this.lastActiveScreenEl.style.display="none"),t&&(t.style.display="block",this.lastActiveScreenEl=t),e.activeScreen){case v.STATUS:this.renderStatusScreen(e);break;case v.NAVIGATION:this.renderNavigationScreen(e);break;case v.SERVICES:this.renderServicesScreen(e);break;case v.MARKET:this.renderMarketScreen(e);break;case v.CARGO:this.renderCargoScreen(e);break;case v.HANGAR:this.renderHangarScreen(e);break;case v.MISSIONS:this.renderMissionsScreen(e);break;case v.FINANCE:this.renderFinanceScreen(e);break;case v.INTEL:this.renderIntelScreen(e);break}}updateStickyBar(e){let{activeScreen:t,player:a}=e;if(this.cache.stickyBar.innerHTML="",!a.activeShipId){[v.MARKET,v.CARGO,v.HANGAR,v.SERVICES,v.FINANCE].includes(t)&&(this.cache.stickyBar.innerHTML=`
                     <div class="ship-hud text-center">
                        <div class="flex justify-around items-center font-roboto-mono">
                            <span class="credits-text-pulsing">${y(a.credits)}</span>
                        </div>
                     </div>
                `);return}let i=a.shipStates[a.activeShipId],s=E[a.activeShipId];switch(t){case v.NAVIGATION:let n=i.fuel/s.maxFuel*100;this.cache.stickyBar.innerHTML=`
                    <div class="ship-hud">
                        <div class="flex items-center justify-between">
                             <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                <span class="text-gray-400">Fuel:</span>
                            </div>
                            <span class="font-bold text-sky-300">${Math.floor(i.fuel)}/${s.maxFuel}</span>
                        </div>
                        <div class="mt-1">
                            <div class="hud-stat-bar"><div style="width: ${n}%" class="bg-sky-400"></div></div>
                        </div>
                    </div>
                `;break;case v.MARKET:case v.CARGO:case v.HANGAR:case v.SERVICES:case v.FINANCE:let o=$(a.inventories[a.activeShipId]);this.cache.stickyBar.innerHTML=`
                     <div class="ship-hud text-center">
                        <div class="flex justify-around items-center font-roboto-mono">
                            <span class="credits-text-pulsing">${y(a.credits)}</span>
                            <span class="text-gray-500">|</span>
                            <span>Cargo: ${o}/${s.cargoCapacity}</span>
                        </div>
                    </div>
                
                `;break}}renderStatusScreen(e){let{player:t,day:a}=e,i=E[t.activeShipId],s=t.shipStates[t.activeShipId],n=t.inventories[t.activeShipId],o=$(n);this.cache.statusScreen.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-black/30 p-4 rounded-lg mb-6 items-start">
                <div class="md:col-span-2 h-full p-4 rounded-lg flex items-center justify-between transition-all duration-500 panel-border border border-slate-700">
                    <div class="text-left pl-4">
                        <span class="block text-lg text-gray-400 uppercase tracking-widest">Day</span>
                        <span class="text-4xl font-bold font-orbitron">${a}</span>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <p class="text-xs text-cyan-200/80 mb-2 font-roboto-mono text-right">${ue(a)}</p>
                        <div class="mt-2 pt-2 border-t border-slate-500/50">
                            <div class="text-right">
                                <p class="text-gray-400 text-sm tracking-wider">Vessel</p>
                                <p>${i.name}</p>
                                <p>Class: ${i.class}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-1 flex flex-col gap-4">
                    <div class="ship-hud">
                        <h4 class="font-orbitron text-xl text-center mb-3 text-cyan-300">Ship Status</h4>
                        <div class="flex flex-col gap-y-2 text-sm">
                            <div class="tooltip-container" data-tooltip="Ship integrity. Damaged by travel.">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                        <span class="text-gray-400">Hull:</span>
                                    </div>
                                    <span class="font-bold text-green-300">${Math.floor(s.health)}%</span>
                                </div>
                            </div>
                            <div class="tooltip-container" data-tooltip="Propulsion system fuel levels.">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path></svg>
                                        <span class="text-gray-400">Fuel:</span>
                                    </div>
                                    <span class="font-bold text-sky-300">${Math.floor(s.fuel)}/${i.maxFuel}</span>
                                </div>
                            </div>
                            <div class="tooltip-container" data-tooltip="Active ship's current/max cargo space.">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 000 2h6a1 1 0 100-2H6z" /><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2-2H4a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1V5a1 1 0 00-1-1H4z" clip-rule="evenodd" /></svg>
                                        <span class="text-gray-400">Cargo:</span>
                                    </div>
                                    <span class="font-bold text-amber-300">${o}/${i.cargoCapacity}</span>
                                </div>
                            </div>
                         </div>
                    </div>
                    <div class="text-center text-lg text-cyan-200 font-orbitron flex items-center justify-center gap-2">
                        <span>${t.playerTitle} ${t.name}, ${t.playerAge}</span>
                    </div>
                </div>
            </div>`}renderNavigationScreen(e){let{player:t,currentLocationId:a,TRAVEL_DATA:i}=e;this.cache.navigationScreen.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${A.filter(s=>t.unlockedLocationIds.includes(s.id)).map(s=>{let n=s.id===a,o=n?null:i[a][s.id];return`<div class="location-card p-6 rounded-lg text-center flex flex-col ${n?"highlight-current":""} ${s.color} ${s.bg}" data-action="${p.TRAVEL}" data-location-id="${s.id}">
                        <h3 class="text-2xl font-orbitron flex-grow">${s.name}</h3>
                        <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                        ${n?'<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>':`<div class="flex justify-around items-center text-center">
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${o.time}</span><span class="block text-xs text-gray-400">Days</span></div>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${o.fuelCost}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                                   </div>
                               </div>`}
                      </div>
                      </div>`}).join("")}
            </div>`}renderServicesScreen(e){let{player:t,currentLocationId:a}=e,i=E[t.activeShipId],s=t.shipStates[t.activeShipId],n=A.find(h=>h.id===a),o=n.fuelPrice/2;t.activePerks[I.VENETIAN_SYNDICATE]&&a===g.VENUS&&(o*=1-G[I.VENETIAN_SYNDICATE].fuelDiscount);let r=i.maxHealth*(M.REPAIR_AMOUNT_PER_TICK/100)*M.REPAIR_COST_PER_HP;t.activePerks[I.VENETIAN_SYNDICATE]&&a===g.VENUS&&(r*=1-G[I.VENETIAN_SYNDICATE].repairDiscount);let l=s.fuel/i.maxFuel*100,c=s.health/i.maxHealth*100;this.cache.servicesScreen.innerHTML=`
             <div class="text-center mb-4">
                <h3 class="text-2xl font-orbitron">Station Services at ${n.name}</h3>
                <div id="services-credits-display" class="text-lg text-cyan-300 mt-2"><span class="text-cyan-400">\u232C </span><span class="font-bold text-cyan-300 ml-auto">${y(t.credits,!1)}</span></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-black/20 p-4 rounded-lg text-center shadow-lg panel-border border border-slate-700">
                    <h4 class="font-orbitron text-xl mb-2">Refueling</h4>
                    <p class="mb-3">Price: <span class="font-bold text-cyan-300">${y(o,!1)}</span> / 5 units</p>
                    <button id="refuel-btn" class="btn btn-green w-full py-3" ${s.fuel>=i.maxFuel?"disabled":""}>Hold to Refuel</button>
                    <div class="w-full hud-stat-bar mt-2"><div id="fuel-bar" style="width: ${l}%" class="bg-sky-400"></div></div>
                </div>
                <div class="bg-black/20 p-4 rounded-lg text-center shadow-lg panel-border border border-slate-700">
                    <h4 class="font-orbitron text-xl mb-2">Ship Maintenance</h4>
                    <p class="mb-3">Price: <span class="font-bold text-cyan-300">${y(r,!1)}</span> / 5% repair</p>
                    <button id="repair-btn" class="btn btn-blue w-full py-3" ${s.health>=i.maxHealth?"disabled":""}>Hold to Repair</button>
                    <div class="w-full hud-stat-bar mt-2"><div id="repair-bar" style="width: ${c}%" class="bg-green-400"></div></div>
                </div>
            </div>`}updateServicesScreen(e){if(e.activeScreen!==v.SERVICES)return;let{player:t}=e,a=E[t.activeShipId],i=t.shipStates[t.activeShipId],s=document.getElementById("services-credits-display");s&&(s.innerHTML=`<span class="text-cyan-400">\u232C </span><span class="font-bold text-cyan-300 ml-auto">${y(t.credits,!1)}</span>`);let n=document.getElementById("fuel-bar"),o=document.getElementById("refuel-btn");if(n&&o){let c=i.fuel/a.maxFuel*100;n.style.width=`${c}%`,o.disabled=i.fuel>=a.maxFuel}let r=document.getElementById("repair-bar"),l=document.getElementById("repair-btn");if(r&&l){let c=i.health/a.maxHealth*100;r.style.width=`${c}%`,l.disabled=i.health>=a.maxHealth}}renderMarketScreen(e){let a=_.filter(i=>i.unlockLevel<=e.player.unlockedCommodityLevel).map(i=>this.isMobile?this._getMarketItemHtmlMobile(i,e):this._getMarketItemHtmlDesktop(i,e)).join("");this.cache.marketScreen.innerHTML=`<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${a}</div>`}updateMarketScreen(e){if(e.activeScreen!==v.MARKET)return;let{player:t,market:a,currentLocationId:i}=e,s=_.filter(l=>l.unlockLevel<=t.unlockedCommodityLevel),n=E[t.activeShipId],o=$(t.inventories[t.activeShipId]),r=A.find(l=>l.id===i);s.forEach(l=>{let c=l.id;if(!document.getElementById(`item-card-container-${c}`))return;let m=t.inventories[t.activeShipId][c],f=a.inventory[i][c],S=this.getItemPrice(e,c),b=this.getItemPrice(e,c,!0),C=document.getElementById(`p-inv-${c}`);C&&(C.innerHTML=m&&m.quantity>0?` <span class='text-cyan-300'>(${m.quantity})</span>`:"");let x=document.getElementById(`m-stock-${c}`);x&&(x.innerHTML=f.quantity);let L=document.getElementById(`price-${c}`);L&&(L.innerHTML=y(S));let O=a.galacticAverages[c],N=document.getElementById(`indicators-${c}`);if(N){let{marketIndicatorHtml:W,plIndicatorHtml:Q}=this._getIndicatorHtml(S,b,O,m,this.isMobile);N.innerHTML=this.isMobile?W:`${W||""}${Q||""}`}let R=document.getElementById(`buy-btn-${c}`),w=document.getElementById(`max-buy-btn-${c}`),D=document.getElementById(`sell-btn-${c}`),Y=document.getElementById(`max-sell-btn-${c}`),F=r.specialDemand&&r.specialDemand[l.id],q=t.credits<S,X=o>=n.cargoCapacity,U=f.quantity<=0;R&&(R.disabled=!!(F||q||X||U)),w&&(w.disabled=!!(F||q||X||U));let K=!m||m.quantity<=0;D&&(D.disabled=K),Y&&(Y.disabled=K)})}renderCargoScreen(e){let t=e.player.inventories[e.player.activeShipId],a=Object.entries(t).filter(([,s])=>s.quantity>0),i;a.length>0?i=`<div class="flex justify-center flex-wrap gap-4">
                ${a.map(([s,n])=>{let o=_.find(l=>l.id===s),r=`${o.lore}

Avg. Cost: ${y(n.avgCost,!1)}`;return`<div class="p-2 rounded-lg border-2 ${o.styleClass} cargo-item-tooltip" style="filter: drop-shadow(0 4px 3px rgba(0, 0, 0, 0.4));" data-tooltip="${r}"><div class="font-semibold text-sm commodity-name text-outline">${o.name}</div><div class="text-lg text-center text-cyan-300 text-outline">(${n.quantity})</div></div>`}).join("")}
            </div>`:i='<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>',this.cache.cargoScreen.innerHTML=`
            <div class="mt-8 pt-6">
                <h3 class="text-2xl font-orbitron text-center mb-4">Active Ship Cargo Manifest</h3>
                ${i}
            </div>`}_getShipyardInventory(e){let{player:t,currentLocationId:a,market:i,introSequenceActive:s}=e;return s?t.ownedShipIds.length>0?[]:[T.WANDERER,T.STALWART,T.MULE].map(o=>[o,E[o]]):(i.shipyardStock[a]?.shipsForSale||[]).map(o=>[o,E[o]]).filter(([o,r])=>!t.ownedShipIds.includes(o))}renderHangarScreen(e){let{tutorials:t}=e,a="",i="";t.activeBatchId==="intro_hangar"&&(t.activeStepId==="hangar_1"||t.activeStepId==="hangar_2"?a="tutorial-highlight":t.activeStepId==="hangar_3"&&(i="tutorial-highlight")),this.isMobile?this._renderHangarScreenMobile(e,a,i):this._renderHangarScreenDesktop(e,a,i)}_renderHangarScreenMobile(e,t,a){let{player:i}=e,s=this._getShipyardInventory(e),n=s.length>0?s.map(([r])=>this._getHangarItemHtmlMobile(e,r,"shipyard")).join(""):'<p class="text-center text-gray-500 text-sm p-4">No new ships available.</p>',o=i.ownedShipIds.length>0?i.ownedShipIds.map(r=>this._getHangarItemHtmlMobile(e,r,"hangar")).join(""):'<p class="text-center text-gray-500 text-sm p-4">Your hangar is empty.</p>';this.cache.hangarScreen.innerHTML=`
            <div class="flex flex-col gap-6">
                <div id="starport-shipyard-panel-mobile" class="${t}">
                    <h2 class="text-2xl font-orbitron text-cyan-300 mb-2 text-center">Shipyard</h2>
                    <div class="starport-panel-mobile space-y-2">${n}</div>
                </div>
                <div id="starport-hangar-panel-mobile" class="${a}">
                    <h2 class="text-2xl font-orbitron text-cyan-300 mb-2 text-center">Hangar</h2>
                    <div class="starport-panel-mobile space-y-2">${o}</div>
                </div>
            </div>`}_renderHangarScreenDesktop(e,t,a){let{player:i,tutorials:s}=e,n=this._getShipyardInventory(e),o=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",r;n.length>0?r=n.map(([c,h])=>{let f=!(i.credits>=h.price)||o;return`<div class="ship-card p-4 flex flex-col space-y-3"><div class="flex justify-between items-start"><div><h3 class="text-xl font-orbitron text-cyan-300">${h.name}</h3><p class="text-sm text-gray-400">Class ${h.class}</p></div><div class="text-right"><p class="text-lg font-bold text-cyan-300">${y(h.price)}</p></div></div><p class="text-sm text-gray-400 flex-grow">${h.lore}</p><div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2"><div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${h.maxHealth}</span></div><div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${h.maxFuel}</span></div><div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${h.cargoCapacity}</span></div></div><button class="btn w-full mt-2" 
                 data-action="${p.BUY_SHIP}" data-ship-id="${c}" ${f?"disabled":""}>Purchase</button></div>`}).join(""):r='<p class="text-center text-gray-500">No new ships available at this location.</p>';let l=i.ownedShipIds.length>0?i.ownedShipIds.map(c=>{let h=E[c],m=i.shipStates[c],f=i.inventories[c],S=$(f),b=c===i.activeShipId,C=i.ownedShipIds.length>1&&!b,x=Math.floor(h.price*M.SHIP_SELL_MODIFIER);return`<div class="ship-card p-4 flex flex-col space-y-3 ${b?"border-yellow-400":""}"><h3 class="text-xl font-orbitron ${b?"text-yellow-300":"text-cyan-300"} hanger-ship-name" data-tooltip="${h.lore}">${h.name}</h3><p class="text-sm text-gray-400 flex-grow">Class ${h.class}</p><div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2"><div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${Math.floor(m.health)}/${h.maxHealth}</span></div><div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${Math.floor(m.fuel)}/${h.maxFuel}</span></div><div><span class="text-amber-400">${S}/${h.cargoCapacity}</span></div></div><div class="grid grid-cols-2 gap-2 mt-2">${b?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${p.SELECT_SHIP}" data-ship-id="${c}">Board</button>`}<button class="btn" data-action="${p.SELL_SHIP}" data-ship-id="${c}" ${C?"":"disabled"}>Sell (${y(x,!1)})</button></div></div>`}).join(""):'<p class="text-center text-gray-500">Your hangar is empty.</p>';this.cache.hangarScreen.innerHTML=`
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 relative">
                <div id="starport-shipyard-panel" class="${t}">
                    <h2 class="text-3xl font-orbitron text-cyan-300 mb-4 text-center">Shipyard</h2>
                    <div class="starport-panel space-y-4">${r}</div>
                </div>
                <div class="w-full my-4 border-t-2 border-slate-600 lg:hidden"></div>
                <div class="absolute left-1/2 top-0 h-full w-px bg-slate-600 hidden lg:block"></div>
                <div id="starport-hangar-panel" class="${a}">
                    <h2 class="text-3xl font-orbitron text-cyan-300 mb-4 text-center">Hangar</h2>
                    <div class="starport-panel space-y-4">${l}</div>
                </div>
            </div>`}_getHangarItemHtmlMobile(e,t,a){let{player:i,tutorials:s}=e,n=E[t],o,r;if(a==="shipyard")o=y(n.price),r=i.credits>=n.price?"text-cyan-300":"text-red-400";else{let h=t===i.activeShipId;o=h?"ACTIVE":"STORED",r=h?"text-yellow-300":"text-gray-400"}return`
            <div class="ship-list-item-mobile p-3 flex justify-between items-center ${s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1"&&a==="shipyard"?"disabled":""}" data-action="show-ship-detail" data-ship-id="${t}" data-context="${a}">
                <div>
                    <p class="font-orbitron ${r}">${n.name}</p>
                    <p class="text-xs text-gray-500">Class ${n.class}</p>
                </div>
                <div class="font-roboto-mono text-right text-sm ${r}">
                    ${o}
                </div>
            </div>`}renderMissionsScreen(e){let{missions:t,currentLocationId:a}=e,{activeMissionId:i,completedMissionIds:s,activeMissionObjectivesMet:n}=t,o=(c,h)=>{let m="";h==="active"&&(m="mission-active"),h==="completed"&&(m="mission-complete"),h==="active"&&n&&c.completion.locationId===a&&(m+=" mission-turn-in");let f=`host-${c.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,S=c.rewards.map(b=>b.type==="credits"?`\u232C ${b.amount.toLocaleString()}`:b.type.toUpperCase()).join(", ");return`
                <div class="mission-card sci-fi-frame ${f} ${m}" data-action="show-mission-modal" data-mission-id="${c.id}">
                    <div class="flex justify-between items-center w-full text-xs mb-1">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            <span class="mission-type">${c.type}</span>
                        </div>
                        <span class="mission-host">${c.host}</span>
                    </div>
                    <div class="flex justify-between items-end w-full">
                        <p class="font-bold text-base">${c.name}</p>
                        <span class="mission-reward">${S}</span>
                    </div>
                </div>`},r="",l=i?V[i]:null;l&&(r+=o(l,"active")),Object.values(V).forEach(c=>{c.id!==i&&!s.includes(c.id)&&(r+=o(c,"available"))}),r===""&&(r='<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>'),this.cache.missionsScreen.innerHTML=`
            <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300">Mission Terminal</h1>
            <div class="space-y-3 max-w-2xl mx-auto">
                ${r}
            </div>
        `}renderFinanceScreen(e){let{player:t,day:a}=e,i;if(t.debt>0){let n="";if(t.loanStartDate){let o=M.LOAN_GARNISHMENT_DAYS-(a-t.loanStartDate);o>0&&(n=`<p class="text-xs text-red-400/70 mt-2">Garnishment in ${o} days</p>`)}i=`
               <div id="finance-debt-panel">
                 <h4 class="font-orbitron text-xl mb-2">Debt</h4>
                 <p class="text-2xl font-bold font-roboto-mono text-red-400 mb-2">${y(t.debt,!1)}</p>
                 <button data-action="${p.PAY_DEBT}" class="btn w-full py-3 bg-red-800/80 hover:bg-red-700/80 border-red-500" ${t.credits>=t.debt?"":"disabled"}>
                     Pay Off Full Amount
                 </button>
                 ${n}
               </div>`}else{let n=Math.floor(t.credits*3.5),o=Math.floor(n*.1),r=Math.floor(n*.01);i=`<h4 class="font-orbitron text-xl mb-2">Financing</h4><div class="flex justify-center gap-4 w-full">${[{key:"10000",amount:1e4,fee:600,interest:125},{key:"dynamic",...{amount:n,fee:o,interest:r}}].map(h=>{let m=`Fee: ${y(h.fee,!1)}
Interest: ${y(h.interest,!1)} / 7d`;return`<button class="btn btn-loan w-full p-2 mt-2 loan-btn-tooltip" data-action="${p.TAKE_LOAN}" data-loan-details='${JSON.stringify(h)}' ${t.credits<h.fee?"disabled":""} data-tooltip="${m}">
                            <span class="font-orbitron text-cyan-300">\u232C ${y(h.amount,!1)}</span>
                        </button>`}).join("")}</div>`}let s=[...t.financeLog].reverse().map(n=>{let o=n.amount>0?"text-green-400":"text-red-400",r=n.amount>0?"+":"";return`
                <div class="grid grid-cols-4 gap-2 p-2 border-b border-slate-700 text-sm">
                    <span class="text-gray-400">${n.day}</span>
                    <span class="col-span-2">${n.description}</span>
                    <span class="${o} text-right">${r}${y(n.amount,!1)}</span>
                </div>
            `}).join("");this.cache.financeScreen.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 bg-black/20 p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border border-slate-700 text-center">
                    ${i}
                </div>
                <div class="md:col-span-2">
                     <h3 class="text-2xl font-orbitron text-center mb-4">Transaction Log</h3>
                     <div class="bg-black/20 p-4 rounded-lg shadow-lg panel-border border border-slate-700 h-96 overflow-y-auto">
                        <div class="grid grid-cols-4 gap-2 p-2 border-b-2 border-slate-500 font-bold text-gray-300">
                           <span>Day</span>
                           <span class="col-span-2">Description</span>
                           <span class="text-right">Amount</span>
                        </div>
                        ${s||'<p class="text-center text-gray-500 p-4">No transactions recorded.</p>'}
                     </div>
                </div>
            </div>
        `}renderIntelScreen(e){this.cache.intelScreen.innerHTML=`
            <div class="text-center p-8 flex flex-col items-center gap-4">
                 <div id="tutorial-button-container" class="tutorial-container relative">
                    <button class="btn btn-header">Tutorial Log</button>
                    <div id="tutorial-log-modal" class="tutorial-tooltip">
                        <h3 id="tutorial-log-title" class="text-2xl font-orbitron mb-4 text-center">Tutorial Log</h3>
                        <ul id="tutorial-log-list" class="space-y-2"></ul>
                    </div>
                </div>
                <div id="lore-button-container" class="lore-container relative">
                    <button class="btn btn-header">Story So Far...</button>
                    <div class="lore-tooltip">
                        <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p><br><p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p><br><p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p><br><p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
                    </div>
                </div>
            </div>`}_getMarketItemHtmlDesktop(e,t){let{player:a,market:i,currentLocationId:s}=t,n=a.inventories[a.activeShipId][e.id],o=this.getItemPrice(t,e.id),r=this.getItemPrice(t,e.id,!0),l=i.galacticAverages[e.id],c=i.inventory[s][e.id],h=A.find(O=>O.id===s),m=h.specialDemand&&h.specialDemand[e.id],f=m?"disabled":"",S=m?`data-tooltip="${h.specialDemand[e.id].lore}"`:`data-tooltip="${e.lore}"`,b=n&&n.quantity>0?` <span class='text-cyan-300'>(${n.quantity})</span>`:"",C=`<span class="graph-icon" data-action="${p.SHOW_PRICE_GRAPH}" data-good-id="${e.id}">\u{1F4C8}</span>`,{marketIndicatorHtml:x,plIndicatorHtml:L}=this._getIndicatorHtml(o,r,l,n,!1);return`
        <div class="item-card-container" id="item-card-container-${e.id}">
            <div class="bg-black/20 p-4 rounded-lg flex justify-between items-center border ${e.styleClass} transition-colors shadow-md h-32">
                <div class="flex flex-col h-full justify-between flex-grow self-start pt-1">
                    <div>
                        <p class="font-bold commodity-name text-outline"><span class="commodity-name-tooltip" ${S}>${e.name}</span><span id="p-inv-${e.id}">${b}</span></p>
                         <p id="price-${e.id}" class="font-roboto-mono text-xl font-bold text-left pt-2 price-text text-outline flex items-center">${y(o)}</p>
                    </div>
                    <div class="text-sm self-start pb-1 text-outline flex items-center gap-3">
                        <span>Avail: <span id="m-stock-${e.id}">${c.quantity}</span> ${C}</span>
                        <div id="indicators-${e.id}" class="flex items-center gap-2">${x}${L}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex flex-col items-center"><div class="flex flex-col space-y-1">
                        <button id="buy-btn-${e.id}" class="btn item-btn" data-action="${p.BUY_ITEM}" data-good-id="${e.id}" ${f}>Buy</button>
                        <button id="max-buy-btn-${e.id}" class="btn btn-sm item-btn" data-action="${p.SET_MAX_BUY}" data-good-id="${e.id}" ${f}>Max</button>
                    </div></div>
                    <div class="flex flex-col items-center">
                        <button class="qty-btn" data-action="${p.INCREMENT}" data-good-id="${e.id}">+</button>
                        <input type="number" class="qty-input p-2 my-1" id="qty-${e.id}" data-good-id="${e.id}" value="1" min="1">
                        <button class="qty-btn" data-action="${p.DECREMENT}" data-good-id="${e.id}">-</button>
                    </div>
                    <div class="flex flex-col items-center"><div class="flex flex-col space-y-1">
                        <button id="sell-btn-${e.id}" class="btn item-btn" data-action="${p.SELL_ITEM}" data-good-id="${e.id}">Sell</button>
                        <button id="max-sell-btn-${e.id}" class="btn btn-sm item-btn" data-action="${p.SET_MAX_SELL}" data-good-id="${e.id}">Max</button>
                    </div></div>
                </div>
            </div>
        </div>`}_getMarketItemHtmlMobile(e,t){let{player:a,market:i,currentLocationId:s}=t,n=a.inventories[a.activeShipId][e.id],o=this.getItemPrice(t,e.id),r=this.getItemPrice(t,e.id,!0),l=i.galacticAverages[e.id],c=i.inventory[s][e.id],h=A.find(L=>L.id===s),m=h.specialDemand&&h.specialDemand[e.id],f=m?"disabled":"",S=m?`data-tooltip="${h.specialDemand[e.id].lore}"`:`data-tooltip="${e.lore}"`,b=n&&n.quantity>0?` <span class='text-cyan-300'>(${n.quantity})</span>`:"",C=`<span class="graph-icon" data-action="${p.SHOW_PRICE_GRAPH}" data-good-id="${e.id}">\u{1F4C8}</span>`,{marketIndicatorHtml:x}=this._getIndicatorHtml(o,r,l,n,!0);return`
        <div class="item-card-container" id="item-card-container-${e.id}">
            <div class="bg-black/20 p-4 rounded-lg flex flex-col border ${e.styleClass} shadow-md">
                <div class="flex justify-between items-start w-full mb-2">
                    <div class="flex-grow">
                        <p class="font-bold commodity-name text-outline"><span class="commodity-name-tooltip" ${S}>${e.name}</span><span id="p-inv-${e.id}">${b}</span></p>
                        <p id="price-${e.id}" class="font-roboto-mono text-xl font-bold text-left pt-2 price-text text-outline flex items-center">${y(o)}</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-2 text-outline">Avail: <span id="m-stock-${e.id}">${c.quantity}</span> ${C}</div>
                </div>
                <div id="indicators-${e.id}">${x}</div>
                <div class="flex justify-end items-end mt-2">
                    <div class="mobile-controls-wrapper">
                        <div class="flex flex-col items-center space-y-1">
                            <button id="buy-btn-${e.id}" class="btn item-btn" data-action="${p.BUY_ITEM}" data-good-id="${e.id}" ${f}>Buy</button>
                            <button id="max-buy-btn-${e.id}" class="btn btn-sm item-btn" data-action="${p.SET_MAX_BUY}" data-good-id="${e.id}" ${f}>Max</button>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <button class="qty-btn" data-action="${p.INCREMENT}" data-good-id="${e.id}">+</button>
                            <input type="number" class="qty-input" id="qty-${e.id}-mobile" data-good-id="${e.id}" value="1" min="1">
                            <button class="qty-btn" data-action="${p.DECREMENT}" data-good-id="${e.id}">-</button>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <button id="sell-btn-${e.id}" class="btn item-btn" data-action="${p.SELL_ITEM}" data-good-id="${e.id}">Sell</button>
                            <button id="max-sell-btn-${e.id}" class="btn btn-sm item-btn" data-action="${p.SET_MAX_SELL}" data-good-id="${e.id}">Max</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`}_getIndicatorHtml(e,t,a,i,s){let n=e-a,o=a>0?Math.round(n/a*100):0,r=o>0?"+":"",l=o<-15?"text-red-400":o>15?"text-green-400":"text-white",c=this._getArrowSvg(o>15?"up":o<-15?"down":"neutral");if(s){let h='<div class="mobile-indicator-wrapper text-sm text-outline">';if(h+=`<div class="flex items-center ${l}"><span>MKT: ${r}${o}%</span> ${c}</div>`,i&&i.avgCost>0){let m=t-i.avgCost;if(Math.abs(m)>.01){let f=i.avgCost>0?Math.round(m/i.avgCost*100):0,S=m>=0?"text-green-400":"text-red-400",b=f>0?"+":"",C=this._getArrowSvg(m>0?"up":"down");h+=`<div class="flex items-center ${S}"><span>P/L: ${b}${f}%</span> ${C}</div>`}}return h+="</div>",{marketIndicatorHtml:h,plIndicatorHtml:""}}else{let h=`<div class="flex items-center gap-2"><div class="market-indicator-stacked ${l}"><span class="text-xs opacity-80">MKT</span><span>${r}${o}%</span></div>${c}</div>`,m="";if(i&&i.avgCost>0){let f=t-i.avgCost;if(Math.abs(f)>.01){let S=i.avgCost>0?Math.round(f/i.avgCost*100):0,b=f>=0?"text-green-400":"text-red-400",C=S>0?"+":"",x=this._getArrowSvg(f>0?"up":"down");m=`<div class="flex items-center gap-2"><div class="market-indicator-stacked ${b}"><span class="text-xs opacity-80">P/L</span><span>${C}${S}%</span></div>${x}</div>`}}return{marketIndicatorHtml:h,plIndicatorHtml:m}}}_getArrowSvg(e){return`<svg class="indicator-arrow" viewBox="0 0 24 24" fill="${e==="neutral"?"none":"currentColor"}" stroke="${e==="neutral"?"currentColor":"none"}" stroke-width="${e==="neutral"?"3":"0"}"><path d="${{up:"M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z",down:"M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z",neutral:"M5 12h14"}[e]}"/></svg>`}getItemPrice(e,t,a=!1){let i=e.market.prices[e.currentLocationId][t],s=A.find(o=>o.id===e.currentLocationId);a&&s.specialDemand&&s.specialDemand[t]&&(i*=s.specialDemand[t].bonus);let n=e.intel.active;return n&&n.targetMarketId===e.currentLocationId&&n.commodityId===t&&(i*=n.type==="demand"?z.INTEL_DEMAND_MOD:z.INTEL_DEPRESSION_MOD),Math.max(1,Math.round(i))}showTravelAnimation(e,t,a,i,s){let n=document.getElementById("travel-animation-modal"),o=document.getElementById("travel-status-text"),r=document.getElementById("travel-arrival-lore"),l=document.getElementById("travel-canvas"),c=l.getContext("2d"),h=document.getElementById("travel-progress-container"),m=document.getElementById("travel-progress-bar"),f=document.getElementById("travel-readout-container"),S=document.getElementById("travel-info-text"),b=document.getElementById("travel-hull-damage"),C=document.getElementById("travel-confirm-button"),x=null;o.textContent=`Traveling to ${t.name}...`,r.textContent="",r.style.opacity=0,f.classList.add("hidden"),f.style.opacity=0,C.classList.add("hidden"),C.style.opacity=0,h.classList.remove("hidden"),m.style.width="0%",n.classList.remove("hidden");let L=2500,O=null,N=le[e.id]||"\u2753",R=le[t.id]||"\u2753",w="\u{1F680}",D=[],Y=150;l.width=l.clientWidth,l.height=l.clientHeight;for(let q=0;q<Y;q++)D.push({x:Math.random()*l.width,y:Math.random()*l.height,radius:Math.random()*1.5,speed:.2+Math.random()*.8,alpha:.5+Math.random()*.5});let F=q=>{O||(O=q);let X=q-O,U=Math.min(X/L,1);U=1-Math.pow(1-U,3),l.width=l.clientWidth,l.height=l.clientHeight,c.clearRect(0,0,l.width,l.height),c.fillStyle="#FFF";for(let re=0;re<Y;re++){let j=D[re];U<1&&(j.x-=j.speed,j.x<0&&(j.x=l.width)),c.beginPath(),c.arc(j.x,j.y,j.radius,0,Math.PI*2),c.globalAlpha=j.alpha,c.fill()}c.globalAlpha=1;let K=60,W=K,Q=l.width-K,oe=l.height/2;c.font="42px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText(N,W,oe),c.fillText(R,Q,oe);let ve=W+(Q-W)*U;c.save(),c.translate(ve,oe),c.font="17px sans-serif",c.fillText(w,0,0),c.restore(),m.style.width=`${U*100}%`,U<1?x=requestAnimationFrame(F):(o.textContent=`Arrived at ${t.name}`,r.innerHTML=t.arrivalLore||"You have arrived.",S.innerHTML=`
                    <div class="text-center ${this.isMobile?"travel-info-mobile":""}">
                        <div>Journey Time: ${a.time} Days</div>
                        <div><span class="font-bold text-sky-300">Fuel Expended: ${a.fuelCost}</span></div>
                    </div>`,b.className="text-sm font-roboto-mono mt-1 font-bold text-red-400",i>.01?(b.innerHTML=`Hull Integrity -${i.toFixed(2)}%`,this.isMobile&&S.querySelector("div").appendChild(b)):b.innerHTML="",r.style.opacity=1,h.classList.add("hidden"),f.classList.remove("hidden"),C.classList.remove("hidden"),setTimeout(()=>{f.style.opacity=1,C.style.opacity=1},50))};x=requestAnimationFrame(F),C.onclick=()=>{cancelAnimationFrame(x),n.classList.add("hidden"),s&&s()}}queueModal(e,t,a,i=null,s={}){this.modalQueue.push({modalId:e,title:t,description:a,callback:i,options:s}),document.querySelector(".modal-backdrop:not(.hidden)")||this.processModalQueue()}processModalQueue(){if(this.modalQueue.length===0)return;let{modalId:e,title:t,description:a,callback:i,options:s}=this.modalQueue.shift(),n=document.getElementById(e);if(!n)return console.error(`Modal with ID ${e} not found.`),this.processModalQueue();let o=n.querySelector("#"+e.replace("-modal","-title")),r=n.querySelector("#"+e.replace("-modal","-description"))||n.querySelector("#"+e.replace("-modal","-scenario"));o&&(o.innerHTML=t),r&&(r.innerHTML=a,r.className="mb-6 text-lg",s.contentClass&&r.classList.add(s.contentClass));let l=()=>{this.hideModal(e),i&&i(),this.processModalQueue()};if(s.customSetup)s.customSetup(n,l);else{let c=n.querySelector("#"+e.replace("-modal","-button-container")),h;c?(c.innerHTML="",h=document.createElement("button"),c.appendChild(h)):h=n.querySelector("button"),h&&(h.className="btn px-6 py-2",s.buttonClass&&h.classList.add(s.buttonClass),h.innerHTML=s.buttonText||"Understood",h.onclick=l)}n.classList.remove("hidden"),n.classList.add("modal-visible")}showRandomEventModal(e,t){this.queueModal("random-event-modal",e.title,e.scenario,null,{customSetup:(a,i)=>{let s=a.querySelector("#random-event-choices-container");s.innerHTML="",e.choices.forEach((n,o)=>{let r=document.createElement("button");r.className="btn w-full text-left p-4 hover:bg-slate-700",r.innerHTML=n.title,r.onclick=()=>{t(e.id,o),i()},s.appendChild(r)})}})}showAgeEventModal(e,t){let a=document.getElementById("age-event-modal");document.getElementById("age-event-title").innerHTML=e.title,document.getElementById("age-event-description").innerHTML=e.description;let i=document.getElementById("age-event-button-container");i.innerHTML="",e.choices.forEach(s=>{let n=document.createElement("button");n.className="perk-button",n.innerHTML=`<h4>${s.title}</h4><p>${s.description}</p>`,n.onclick=()=>{this.hideModal("age-event-modal"),t(s)},i.appendChild(n)}),a.classList.remove("hidden"),a.classList.add("modal-visible")}hideModal(e){let t=document.getElementById(e);t&&!t.classList.contains("hidden")&&(t.classList.add("modal-hiding"),t.addEventListener("animationend",()=>{t.classList.add("hidden"),t.classList.remove("modal-hiding","modal-visible"),this.modalQueue.length>0&&!document.querySelector(".modal-backdrop:not(.hidden)")&&this.processModalQueue()},{once:!0}))}showProcessingAnimation(e,t){let a=this.cache.processingModal;if(!a)return;let i=a.querySelector("#processing-title"),s=a.querySelector("#processing-progress-bar"),n=a.querySelector("#processing-status");i.textContent=`Processing application for ${e}...`,s.style.width="0%",n.textContent="",a.classList.remove("hidden"),setTimeout(()=>{s.style.width="100%"},100),setTimeout(()=>{n.textContent="Processing complete!",setTimeout(()=>{this.hideModal("processing-modal"),t&&t()},1e3)},4e3)}createFloatingText(e,t,a,i="#fde047"){let s=document.createElement("div");s.textContent=e,s.className="floating-text",s.style.left=`${t-20}px`,s.style.top=`${a-40}px`,s.style.color=i,document.body.appendChild(s),setTimeout(()=>s.remove(),2450)}showToast(e,t,a=3e3){let i=this.cache[e];i&&(i.textContent=t,i.classList.remove("hidden"),i.style.opacity="1",setTimeout(()=>{i.style.opacity="0",setTimeout(()=>i.classList.add("hidden"),300)},a))}showGraph(e,t){this.activeGraphAnchor=e;let a=this.cache.graphTooltip,i=e.dataset.action;if(i===p.SHOW_PRICE_GRAPH){let s=e.dataset.goodId,n=t.player.inventories[t.player.activeShipId][s];a.innerHTML=this._renderPriceGraph(s,t,n)}else i===p.SHOW_FINANCE_GRAPH&&(a.innerHTML=this._renderFinanceGraph(t));a.style.display="block",this.updateGraphTooltipPosition()}hideGraph(){this.activeGraphAnchor&&(this.cache.graphTooltip.style.display="none",this.activeGraphAnchor=null)}updateGraphTooltipPosition(){if(!this.activeGraphAnchor)return;let e=this.cache.graphTooltip;if(e.style.display==="none")return;let t=this.activeGraphAnchor.getBoundingClientRect(),a=e.offsetWidth,i=e.offsetHeight,s,n;this.isMobile?(s=window.innerWidth/2-a/2,n=t.top-i-10,n<10&&(n=t.bottom+10)):this.activeGraphAnchor.dataset.action===p.SHOW_FINANCE_GRAPH?(s=t.left-a-10,n=t.top+t.height/2-i/2):(s=t.left+t.width/2-a/2,n=t.bottom+5),s<10&&(s=10),s+a>window.innerWidth&&(s=window.innerWidth-a-10),n<10&&(n=10),n+i>window.innerHeight&&(n=t.top-i-5),e.style.left=`${s}px`,e.style.top=`${n}px`}showGenericTooltip(e,t){this.activeGenericTooltipAnchor=e;let a=this.cache.genericTooltip;a.innerHTML=t,a.style.display="block",this.updateGenericTooltipPosition()}hideGenericTooltip(){this.activeGenericTooltipAnchor&&(this.cache.genericTooltip.style.display="none",this.activeGenericTooltipAnchor=null)}updateGenericTooltipPosition(){if(!this.activeGenericTooltipAnchor)return;let e=this.cache.genericTooltip,t=this.activeGenericTooltipAnchor.getBoundingClientRect(),a=e.offsetWidth,i=e.offsetHeight,s=window.innerWidth/2-a/2,n=t.top-i-10;n<10&&(n=t.bottom+10),s<10&&(s=10),s+a>window.innerWidth&&(s=window.innerWidth-a-10),e.style.left=`${s}px`,e.style.top=`${n}px`}_renderPriceGraph(e,t,a){let i=t.market.priceHistory[t.currentLocationId]?.[e];if(!i||i.length<2)return'<div class="text-gray-400 text-sm p-4">Check back next week!!</div>';let s=_.find(w=>w.id===e),n=(s.basePriceRange[0]+s.basePriceRange[1])/2,o=280,r=140,l=35,c=i.map(w=>w.price),h=a?.avgCost>0?a.avgCost:null,m=[...c,n];h&&m.push(h);let f=Math.min(...m),S=Math.max(...m),b=S-f>0?S-f:1,C=w=>w/(i.length-1)*(o-l*2)+l,x=w=>r-l-(w-f)/b*(r-l*2.5),L=c.map((w,D)=>`${C(D)},${x(w)}`).join(" "),O=h?x(h):null,N=x(n),R=`<svg width="${o}" height="${r}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;return R+=`<line x1="${l}" y1="${N}" x2="${o-l}" y2="${N}" stroke="#facc15" stroke-width="1.5" stroke-dasharray="4 2" /><text x="${o-l+2}" y="${N+4}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg</text>`,O&&(R+=`<line x1="${l}" y1="${O}" x2="${o-l}" y2="${O}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" /><text x="${o-l+2}" y="${O+4}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid</text>`),R+=`<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${L}" /><text x="${C(c.length-1)}" y="${x(c[c.length-1])-5}" fill="#60a5fa" font-size="10" font-family="Roboto Mono" text-anchor="middle">Price</text>`,R+=`<text x="${l-5}" y="${x(f)+4}" fill="#d0d8e8" font-size="10" font-family="Roboto Mono" text-anchor="end">${y(f,!1)}</text><text x="${l-5}" y="${x(S)+4}" fill="#d0d8e8" font-size="10" font-family="Roboto Mono" text-anchor="end">${y(S,!1)}</text></svg>`,R}showTutorialToast({step:e,onSkip:t,onNext:a,gameState:i}){let s=this.cache.tutorialToastContainer,n=e.text;if(n.includes("{shipName}")){let c=E[i.player.activeShipId]?.name||"your ship";n=n.replace(/{shipName}/g,c)}n.includes("{playerName}")&&(n=n.replace(/{playerName}/g,i.player.name)),this.cache.tutorialToastText.innerHTML=n,this.applyTutorialHighlight(e),s.className="hidden fixed p-4 rounded-lg shadow-2xl transition-all duration-300 pointer-events-auto";let o;this.isMobile?o=`tt-${e.position.mobile||"mobile"}`:o=`tt-${e.position.desktop||"bottom-right"}`,s.classList.add(o),s.style.width=e.size?.width||"auto",s.classList.remove("hidden");let r=e.completion.type==="INFO";this.cache.tutorialToastNextBtn.style.display=r?"inline-block":"none",this.cache.tutorialToastNextBtn.onclick=a;let l=e.isSkippable!==!1;this.cache.tutorialToastSkipBtn.style.display=l?"block":"none",this.cache.tutorialToastSkipBtn.onclick=t}hideTutorialToast(){this.cache.tutorialToastContainer.classList.add("hidden"),this.applyTutorialHighlight(null)}applyTutorialHighlight(e){this.activeTutorialHighlight&&this.activeTutorialHighlight.classList.remove("tutorial-highlight");let t=null;if(e&&(t=this.isMobile&&e.mobileHighlightElementId?e.mobileHighlightElementId:e.highlightElementId),t){let a=document.getElementById(t);a&&(a.classList.add("tutorial-highlight"),this.activeTutorialHighlight=a,t!=="starport-shipyard-panel"&&t!=="starport-hangar-panel"&&a.scrollIntoView({behavior:"smooth",block:"center"}))}else this.activeTutorialHighlight=null}showSkipTutorialModal(e){this.cache.skipTutorialModal.classList.remove("hidden");let a=()=>{e(),this.hideModal("skip-tutorial-modal")},i=()=>{this.hideModal("skip-tutorial-modal")};this.cache.skipTutorialConfirmBtn.onclick=a,this.cache.skipTutorialCancelBtn.onclick=i}showTutorialLogModal({seenBatches:e,onSelect:t}){let a=document.getElementById("tutorial-log-modal"),i=document.getElementById("tutorial-log-list");if(!a||!i){console.error("Tutorial log modal elements not found in DOM.");return}i.innerHTML="",e.length===0?i.innerHTML='<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>':e.forEach(s=>{let n=P[s];if(n){let o=document.createElement("li");o.innerHTML=`<button class="btn w-full text-center">${n.title}</button>`,o.onclick=()=>{a.classList.remove("visible"),t(s)},i.appendChild(o)}}),a.classList.add("visible")}showShipDetailModal(e,t,a){let{player:i,tutorials:s}=e,n=E[t],o;if(a==="shipyard"){let c=i.credits>=n.price,h=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",m=!c||h;o=`
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-orbitron text-cyan-300">${n.name}</h3>
                            <p class="text-sm text-gray-400">Class ${n.class}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-cyan-300">${y(n.price)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 flex-grow text-left">${n.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${n.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${n.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${n.cargoCapacity}</span></div>
                    </div>
                    <button class="btn w-full mt-2" data-action="${p.BUY_SHIP}" data-ship-id="${t}" ${m?"disabled":""}>Purchase</button>
                </div>`}else{let c=i.shipStates[t],h=i.inventories[t],m=$(h),f=t===i.activeShipId,S=i.ownedShipIds.length>1&&!f,b=Math.floor(n.price*M.SHIP_SELL_MODIFIER);o=`
                <div class="ship-card p-4 flex flex-col space-y-3 ${f?"border-yellow-400":""}">
                    <h3 class="text-xl font-orbitron ${f?"text-yellow-300":"text-cyan-300"}">${n.name}</h3>
                    <p class="text-sm text-gray-400 flex-grow text-left">Class ${n.class}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${Math.floor(c.health)}/${n.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${Math.floor(c.fuel)}/${n.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span><span class="text-amber-400">${m}/${n.cargoCapacity}</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        ${f?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${p.SELECT_SHIP}" data-ship-id="${t}">Board</button>`}
                        <button class="btn" data-action="${p.SELL_SHIP}" data-ship-id="${t}" ${S?"":"disabled"}>Sell (${y(b,!1)})</button>
                    </div>
                </div>`}let r=this.cache.shipDetailModal,l=r.querySelector("#ship-detail-content");l.innerHTML=o,r.classList.remove("hidden"),r.classList.add("modal-visible")}renderStickyBar(e){let t=document.getElementById("mission-sticky-bar"),a=t.querySelector(".sticky-content"),i=document.getElementById("sticky-objective-text"),s=document.getElementById("sticky-objective-progress");if(e.missions.activeMissionId){let n=V[e.missions.activeMissionId],o=e.missions.missionProgress[n.id]||{objectives:{}},r=n.objectives[0],l=o.objectives[r.goodId]?.current??0,c=r.quantity,h=_.find(b=>b.id===r.goodId).name,m=A.find(b=>b.id===n.completion.locationId).name;i.textContent=`Deliver ${h} to ${m}`,s.textContent=`[${l}/${c}]`;let f=`host-${n.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,S=e.missions.activeMissionObjectivesMet&&n.completion.locationId===e.currentLocationId?"mission-turn-in":"";a.className=`sticky-content sci-fi-frame ${f} ${S}`,t.style.display="block"}else t.style.display="none"}showMissionModal(e){let t=V[e];if(!t)return;let{missions:a,currentLocationId:i}=this.lastKnownState,{activeMissionId:s,activeMissionObjectivesMet:n}=a;s===e&&n&&t.completion.locationId===i?this._showMissionCompletionModal(t):this._showMissionDetailsModal(t)}_showMissionDetailsModal(e){let{missions:t}=this.lastKnownState,a=t.activeMissionId===e.id,i=t.activeMissionId&&!a,s={customSetup:(n,o)=>{n.querySelector("#mission-modal-close").onclick=o,n.querySelector("#mission-modal-title").textContent=e.name,n.querySelector("#mission-modal-type").textContent=e.type,n.querySelector("#mission-modal-description").innerHTML=e.description;let r=e.rewards.map(c=>c.type==="credits"?`\u232C ${c.amount.toLocaleString()}`:c.type.toUpperCase()).join(", ");n.querySelector("#mission-modal-rewards").innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${r}</p>`;let l=n.querySelector("#mission-modal-buttons");a?l.innerHTML=`<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${e.id}">Abandon Mission</button>`:l.innerHTML=`<button class="btn w-full" data-action="accept-mission" data-mission-id="${e.id}" ${i?"disabled":""}>Accept</button>`}};this.queueModal("mission-modal",e.name,e.description,null,s)}_showMissionCompletionModal(e){let t={customSetup:(a,i)=>{let s=a.querySelector(".modal-content");s.classList.add("mission-turn-in",`host-${e.host.toLowerCase()}`),a.querySelector("#mission-modal-close").onclick=()=>{s.classList.remove("mission-turn-in",`host-${e.host.toLowerCase()}`),i()},a.querySelector("#mission-modal-title").textContent=e.completion.title,a.querySelector("#mission-modal-type").textContent="OBJECTIVES MET",a.querySelector("#mission-modal-description").innerHTML=e.completion.text;let n=e.rewards.map(r=>r.type==="credits"?`\u232C ${r.amount.toLocaleString()}`:r.type.toUpperCase()).join(", ");a.querySelector("#mission-modal-rewards").innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${n}</p>`;let o=a.querySelector("#mission-modal-buttons");o.innerHTML=`<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${e.id}">${e.completion.buttonText}</button>`}};this.queueModal("mission-modal",e.completion.title,e.completion.text,null,t)}flashObjectiveProgress(){let e=document.getElementById("sticky-objective-progress");e&&(e.classList.add("objective-progress-flash"),setTimeout(()=>{e.classList.remove("objective-progress-flash")},700))}};var ie=class{constructor(e,t,a,i){this.gameState=e,this.simulationService=t,this.uiManager=a,this.tutorialService=i,this.refuelInterval=null,this.repairInterval=null,this.activeTooltipTarget=null}bindEvents(){document.body.addEventListener("click",t=>this._handleClick(t)),document.body.addEventListener("dblclick",t=>t.preventDefault()),document.body.addEventListener("mouseover",t=>this._handleMouseOver(t)),document.body.addEventListener("mouseout",t=>this._handleMouseOut(t)),document.addEventListener("keydown",t=>this._handleKeyDown(t)),document.body.addEventListener("mousedown",t=>{let a=t.target.closest("#refuel-btn");a&&this._startRefueling(a);let i=t.target.closest("#repair-btn");i&&this._startRepairing(i)}),document.body.addEventListener("touchstart",t=>{let a=t.target.closest("#refuel-btn");a&&(t.preventDefault(),this._startRefueling(a));let i=t.target.closest("#repair-btn");i&&(t.preventDefault(),this._startRepairing(i))}),["mouseup","mouseleave","touchend"].forEach(t=>{document.addEventListener(t,()=>{this._stopRefueling(),this._stopRepairing()})}),window.addEventListener("resize",()=>{this.uiManager.render(this.gameState.getState())}),window.addEventListener("scroll",()=>{this.uiManager.isMobile&&this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null)},{passive:!0});let e=document.getElementById("mission-sticky-bar");e&&e.addEventListener("click",()=>{this.gameState.missions.activeMissionId&&this.uiManager.showMissionModal(this.gameState.missions.activeMissionId)})}_handleClick(e){let t=this.gameState.getState(),a=e.target.closest("[data-action]");if(a){let{action:r,goodId:l,locationId:c,shipId:h,loanDetails:m,cost:f,navId:S,screenId:b,context:C,missionId:x}=a.dataset,L=null;switch(r){case"show-mission-modal":this.uiManager.showMissionModal(x);return;case"close-modal":this.uiManager.hideModal("mission-modal");return;case"accept-mission":this.simulationService.missionService.acceptMission(x),this.uiManager.hideModal("mission-modal");break;case"abandon-mission":this.simulationService.missionService.abandonMission(),this.uiManager.hideModal("mission-modal");break;case"complete-mission":this.simulationService.missionService.completeActiveMission(),this.uiManager.hideModal("mission-modal");break;case"show-ship-detail":this.uiManager.showShipDetailModal(t,h,C);break;case p.SET_SCREEN:this.simulationService.setScreen(S,b);break;case p.TRAVEL:this.simulationService.travelTo(c);break;case p.BUY_SHIP:if(this.simulationService.buyShip(h)){let N=E[h].price;this.uiManager.createFloatingText(`-${y(N,!1)}`,e.clientX,e.clientY,"#f87171"),L={type:"ACTION",action:p.BUY_SHIP},this.uiManager.hideModal("ship-detail-modal")}break;case p.SELL_SHIP:let O=this.simulationService.sellShip(h);O&&(this.uiManager.createFloatingText(`+${y(O,!1)}`,e.clientX,e.clientY,"#34d399"),this.uiManager.hideModal("ship-detail-modal"));break;case p.SELECT_SHIP:this.simulationService.setActiveShip(h),L={type:"ACTION",action:p.SELECT_SHIP},this.uiManager.hideModal("ship-detail-modal");break;case p.PAY_DEBT:this.simulationService.payOffDebt();break;case p.TAKE_LOAN:this.simulationService.takeLoan(JSON.parse(m));break;case p.PURCHASE_INTEL:this.simulationService.purchaseIntel(parseInt(f));break;case"show-starport-locked-toast":this.uiManager.showToast("starport-unlock-tooltip","Pay off your initial loan to access the Starport!");break;case p.BUY_ITEM:case p.SELL_ITEM:{let N=document.getElementById(`qty-${l}`)||document.getElementById(`qty-${l}-mobile`),R=parseInt(N.value,10)||1;if(R>0){let w=r===p.BUY_ITEM?this.simulationService.buyItem(l,R):this.simulationService.sellItem(l,R);if(w){let D=r===p.BUY_ITEM?this.uiManager.getItemPrice(t,l)*R:w,Y=r===p.BUY_ITEM?`-${y(D,!1)}`:`+${y(D,!1)}`,F=r===p.BUY_ITEM?"#f87171":"#34d399";this.uiManager.createFloatingText(Y,e.clientX,e.clientY,F),N.value="1",L={type:"ACTION",action:r,goodId:l}}}break}case p.SET_MAX_BUY:case p.SET_MAX_SELL:{let N=document.getElementById(`qty-${l}`)||document.getElementById(`qty-${l}-mobile`),R=this.simulationService._getActiveShip(),w=this.simulationService._getActiveInventory();if(r===p.SET_MAX_SELL)N.value=w[l]?w[l].quantity:0;else{let D=this.uiManager.getItemPrice(t,l),Y=R.cargoCapacity-$(w),F=D>0?Math.floor(t.player.credits/D):Y,q=t.market.inventory[t.currentLocationId][l].quantity;N.value=Math.max(0,Math.min(Y,F,q))}break}case p.INCREMENT:case p.DECREMENT:{let N=document.getElementById(`qty-${l}`)||document.getElementById(`qty-${l}-mobile`),R=parseInt(N.value)||0;N.value=r===p.INCREMENT?R+1:Math.max(1,R-1);break}}L&&this.tutorialService.checkState(L);return}if(t.introSequenceActive&&!t.tutorials.activeBatchId){this.simulationService.handleIntroClick(e);return}if(t.isGameOver)return;if(e.target.closest("#ship-detail-modal")&&!e.target.closest("#ship-detail-content")){this.uiManager.hideModal("ship-detail-modal");return}if(this.uiManager.isMobile){let r=e.target.closest(`[data-action="${p.SHOW_PRICE_GRAPH}"], [data-action="${p.SHOW_FINANCE_GRAPH}"]`),l=e.target.closest(".commodity-name-tooltip"),c=e.target.closest(".cargo-item-tooltip"),h=e.target.closest(".hanger-ship-name"),m=r||l||c||h;if(this.activeTooltipTarget){let f=this.activeTooltipTarget===m;if(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null,f)return}if(m){if(m.dataset.action?.includes(p.SHOW_PRICE_GRAPH)||m.dataset.action?.includes(p.SHOW_FINANCE_GRAPH))this.uiManager.showGraph(m,this.gameState.getState());else{let f=m.dataset.tooltip;f&&this.uiManager.showGenericTooltip(m,f)}this.activeTooltipTarget=m;return}}let s=e.target.closest(".tutorial-container"),n=e.target.closest(".lore-container"),o=document.querySelector(".lore-tooltip.visible, .tutorial-tooltip.visible");if(o&&!e.target.closest(".lore-tooltip, .tutorial-tooltip")&&o.classList.remove("visible"),n){let r=n.querySelector(".lore-tooltip");r&&r.classList.toggle("visible");return}if(s){this.uiManager.showTutorialLogModal({seenBatches:this.gameState.tutorials.seenBatchIds,onSelect:r=>{this.tutorialService.triggerBatch(r)}});return}}_handleMouseOver(e){if(this.uiManager.isMobile)return;let t=e.target.closest(`[data-action="${p.SHOW_PRICE_GRAPH}"], [data-action="${p.SHOW_FINANCE_GRAPH}"]`);t&&this.uiManager.showGraph(t,this.gameState.getState())}_handleMouseOut(e){if(this.uiManager.isMobile)return;e.target.closest(`[data-action="${p.SHOW_PRICE_GRAPH}"], [data-action="${p.SHOW_FINANCE_GRAPH}"]`)&&this.uiManager.hideGraph()}_handleKeyDown(e){if(this.gameState.getState().isGameOver||e.ctrlKey||e.metaKey)return;let a="";switch(e.key){case"!":this.simulationService.debugQuickStart(),a="Debug: Quick Start";break;case"#":this.gameState.player.credits+=1e5,a="Debug: +100k Credits.";break;case"$":Object.keys(E).forEach(o=>{this.gameState.player.ownedShipIds.includes(o)||this.simulationService.addShipToHangar(o)}),a="Debug: All ships added.";break;case"@":let i=this.simulationService._getActiveShip();if(i){this.gameState.player.shipStates[i.id].fuel=i.maxFuel;let o=A.filter(r=>r.id!==this.gameState.currentLocationId&&this.gameState.player.unlockedLocationIds.includes(r.id));if(o.length>0){let r=o[Math.floor(Math.random()*o.length)];this.simulationService.initiateTravel(r.id,{forceEvent:!0}),a=`Debug: Refilled fuel & force-traveling to ${r.name} with event.`}else a="Debug: No available destinations."}break;case"%":this.gameState.player.credits+=1e12;let s=this.simulationService._getActiveShip(),n=this.simulationService._getActiveInventory();s&&n&&_.forEach(o=>{$(n)<s.cargoCapacity&&(n[o.id].quantity=(n[o.id].quantity||0)+1)}),a="Debug: +1T Credits & 1 of each item.";break;case"^":this.simulationService._advanceDays(366),a="Debug: Time advanced 1 year and 1 day.";break}a&&(this.uiManager.showToast("debugToast",a),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}_startRefueling(e){this.gameState.isGameOver||this.refuelInterval||(this._refuelTick(e),this.refuelInterval=setInterval(()=>this._refuelTick(e),1e3))}_stopRefueling(){clearInterval(this.refuelInterval),this.refuelInterval=null}_refuelTick(e){let t=this.simulationService.refuelTick();if(t>0){let a=e.getBoundingClientRect(),i=a.left+a.width/2+(Math.random()*40-20),s=a.top+(Math.random()*20-10);this.uiManager.createFloatingText(`-${y(t,!1)}`,i,s,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRefueling()}_startRepairing(e){this.gameState.isGameOver||this.repairInterval||(this._repairTick(e),this.repairInterval=setInterval(()=>this._repairTick(e),1e3))}_stopRepairing(){clearInterval(this.repairInterval),this.repairInterval=null}_repairTick(e){let t=this.simulationService.repairTick();if(t>0){let a=e.getBoundingClientRect(),i=a.left+a.width/2+(Math.random()*40-20),s=a.top+(Math.random()*20-10);this.uiManager.createFloatingText(`-${y(t,!1)}`,i,s,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRepairing()}};var se=class{constructor(e,t,a,i){this.gameState=e,this.uiManager=t,this.simulationService=a,this.activeBatchId=null,this.activeStepId=null,this.screenToNavMap={};for(let s in i)for(let n in i[s].screens)this.screenToNavMap[n]=s}checkState(e=null){if(this.activeBatchId&&this.activeStepId){let a=P[this.activeBatchId].steps.find(i=>i.stepId===this.activeStepId);a&&this._matchesCondition(a.completion,e)&&this.advanceStep();return}for(let t in P){let a=P[t],i=this.gameState.tutorials.seenBatchIds.includes(t),s=this.gameState.tutorials.skippedTutorialBatches.includes(t),n=t.startsWith("intro_");if(!i&&!s){let o=e||{type:H.SCREEN_LOAD,screenId:this.gameState.activeScreen};if(this._matchesCondition(a.trigger,o)){this.triggerBatch(t);break}}}}triggerBatch(e){if(!P[e])return;let t=P[e];if(t.trigger.type===H.SCREEN_LOAD){let i=t.trigger.screenId;if(this.gameState.activeScreen!==i){let s=this.screenToNavMap[i];s&&this.simulationService.setScreen(s,i)}}this.activeBatchId=e,this.gameState.tutorials.activeBatchId=e,this.gameState.tutorials.seenBatchIds.includes(e)||this.gameState.tutorials.seenBatchIds.push(e);let a=t.steps[0].stepId;this._displayStep(a),this.gameState.setState(this.gameState),this.uiManager.render(this.gameState.getState())}skipActiveTutorial(){this.activeBatchId&&(this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)||this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId),this._endBatch(),this.gameState.setState(this.gameState))}advanceStep(){if(!this.activeStepId||!this.activeBatchId)return;let t=P[this.activeBatchId].steps.find(a=>a.stepId===this.activeStepId);if(this.uiManager.hideTutorialToast(),t&&t.nextStepId)this._displayStep(t.nextStepId);else{let a=this.activeBatchId;this._endBatch(),this.gameState.introSequenceActive&&a?.startsWith("intro_")&&this.simulationService._continueIntroSequence(a)}this.uiManager.render(this.gameState.getState())}_displayStep(e){if(!this.activeBatchId)return;let a=P[this.activeBatchId].steps.find(i=>i.stepId===e);if(!a){this._endBatch();return}a.completion.action===p.BUY_ITEM&&this.gameState.player.credits<1e3||(this.activeStepId=e,this.gameState.tutorials.activeStepId=e,this.uiManager.showTutorialToast({step:a,onSkip:()=>this.uiManager.showSkipTutorialModal(()=>this.skipActiveTutorial()),onNext:()=>this.advanceStep(),gameState:this.gameState.getState()}))}_endBatch(){this.uiManager.hideTutorialToast(),this.activeBatchId=null,this.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null}_matchesCondition(e,t){return!e||!t?!1:Array.isArray(e)?e.every(a=>this._matchesSingleCondition(a,t)):this._matchesSingleCondition(e,t)}_matchesSingleCondition(e,t){if(e.type!==t.type)return!1;switch(e.type){case H.SCREEN_LOAD:return e.screenId===t.screenId;case H.ACTION:return e.action===t.action;case H.INFO:return!0;default:return!1}}};var ne=class{constructor(e,t){this.gameState=e,this.uiManager=t,this.simulationService=null}setSimulationService(e){this.simulationService=e}acceptMission(e){this.gameState.missions.activeMissionId||!V[e]||(this.gameState.missions.activeMissionId=e,this.gameState.missions.missionProgress[e]={objectives:{}},this.checkTriggers(),this.uiManager.render(this.gameState.getState()))}abandonMission(){this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}checkTriggers(){let{activeMissionId:e}=this.gameState.missions;if(!e){this.gameState.missions.activeMissionObjectivesMet&&(this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}));return}let t=V[e],a=this.gameState.player.inventories[this.gameState.player.activeShipId];if(!t||!a){this.gameState.missions.activeMissionObjectivesMet=!1;return}let i=!0,s=!1;t.objectives.forEach(n=>{if(n.type==="have_item"){let o=a[n.goodId]?.quantity||0,r=this.gameState.missions.missionProgress[e];r.objectives[n.goodId]||(r.objectives[n.goodId]={current:0}),r.objectives[n.goodId].current!==o&&(r.objectives[n.goodId].current=o,s=!0),o<n.quantity&&(i=!1)}}),(this.gameState.missions.activeMissionObjectivesMet!==i||s)&&(this.gameState.missions.activeMissionObjectivesMet=i,this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),s&&this.uiManager.flashObjectiveProgress())}completeActiveMission(){let{activeMissionId:e}=this.gameState.missions;if(!e||!this.gameState.missions.activeMissionObjectivesMet)return;let t=V[e],a=this.gameState.player.inventories[this.gameState.player.activeShipId];t.objectives.forEach(i=>{i.type==="have_item"&&a[i.goodId]&&(a[i.goodId].quantity-=i.quantity)}),this.simulationService&&this.simulationService._grantRewards(t.rewards,t.name),this.gameState.missions.completedMissionIds.push(e),this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}};document.addEventListener("DOMContentLoaded",()=>{let d=document.getElementById("splash-screen");document.getElementById("start-game-btn").addEventListener("click",()=>{d.classList.add("modal-hiding"),d.addEventListener("animationend",()=>{d.style.display="none"},{once:!0}),t()},{once:!0});function t(){let a=new Z,i=new ae,s=new te(a,i),n=new se(a,i,s,i.navStructure),o=new ne(a,i);s.setTutorialService(n),s.setMissionService(o),o.setSimulationService(s);let r=new ie(a,s,i,n),l=a.loadGame();l||(a.startNewGame(""),s.startIntroSequence()),r.bindEvents(),l&&(document.getElementById("game-container").classList.remove("hidden"),i.render(a.getState())),n.checkState({type:"SCREEN_LOAD",screenId:a.activeScreen})}});})();
