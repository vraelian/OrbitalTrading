(()=>{var y=Object.freeze({MAP:"map",NAVIGATION:"navigation",SERVICES:"services",MARKET:"market",CARGO:"cargo",HANGAR:"hangar",MISSIONS:"missions",FINANCE:"finance",INTEL:"intel"}),M=Object.freeze({SHIP:"ship",STARPORT:"starport",DATA:"data"}),A=Object.freeze({WANDERER:"starter",STALWART:"hauler_c1",MULE:"hauler_c2",PATHFINDER:"explorer_b1",NOMAD:"explorer_b2",VINDICATOR:"frigate_a1",AEGIS:"frigate_a2",ODYSSEY:"luxury_s1",MAJESTIC:"luxury_s2",TITAN_HAULER:"rare_s1",VOID_CHASER:"rare_s2",GUARDIAN:"rare_s3",STARGAZER:"rare_s4",BEHEMOTH:"rare_o1"}),b=Object.freeze({WATER_ICE:"water_ice",PLASTEEL:"plasteel",HYDROPONICS:"hydroponics",CYBERNETICS:"cybernetics",PROPELLANT:"propellant",PROCESSORS:"processors",GMO_SEEDS:"gmo_seeds",CRYO_PODS:"cryo_pods",ATMO_PROCESSORS:"atmos_processors",CLONED_ORGANS:"cloned_organs",XENO_GEOLOGICALS:"xeno_geologicals",SENTIENT_AI:"sentient_ai",ANTIMATTER:"antimatter",FOLDED_DRIVES:"folded_drives"}),g=Object.freeze({EARTH:"loc_earth",LUNA:"loc_luna",MARS:"loc_mars",VENUS:"loc_venus",BELT:"loc_belt",SATURN:"loc_saturn",JUPITER:"loc_jupiter",URANUS:"loc_uranus",NEPTUNE:"loc_neptune",PLUTO:"loc_pluto",EXCHANGE:"loc_exchange",KEPLER:"loc_kepler"}),E=Object.freeze({TRADEMASTER:"trademaster",NAVIGATOR:"navigator",VENETIAN_SYNDICATE:"venetian_syndicate",MERCHANT_GUILD_SHIP:"merchant_guild_ship"}),f=Object.freeze({SET_SCREEN:"set-screen",TRAVEL:"travel",BUY_SHIP:"buy-ship",SELL_SHIP:"sell-ship",SELECT_SHIP:"select-ship",PAY_DEBT:"pay-debt",TAKE_LOAN:"take-loan",PURCHASE_INTEL:"purchase-intel",ACQUIRE_LICENSE:"acquire-license",BUY_ITEM:"buy-item",SELL_ITEM:"sell-item",SET_MAX_BUY:"set-max-buy",SET_MAX_SELL:"set-max-sell",INCREMENT:"increment",DECREMENT:"decrement",SHOW_PRICE_GRAPH:"show-price-graph",SHOW_FINANCE_GRAPH:"show-finance-graph",TOGGLE_MARKET_CARD_VIEW:"toggle-market-card-view",TOGGLE_HANGAR_MODE:"toggle-hangar-mode",SET_HANGAR_PAGE:"set-hangar-page"}),w=Object.freeze({SCREEN_LOAD:"SCREEN_LOAD",ACTION:"ACTION",INFO:"INFO"}),_=Object.freeze({STARTING_CREDITS:5e3,STARTING_DEBT_INTEREST:125,REPAIR_COST_PER_HP:75,REPAIR_AMOUNT_PER_TICK:5,FUEL_SCALAR:3,INTEREST_INTERVAL:30,PASSIVE_REPAIR_RATE:.02,HULL_DECAY_PER_TRAVEL_DAY:1/7,SHIP_SELL_MODIFIER:.75,RARE_SHIP_CHANCE:.3,PRICE_HISTORY_LENGTH:65,FINANCE_HISTORY_LENGTH:10,DAILY_PRICE_VOLATILITY:.15,MEAN_REVERSION_STRENGTH:.07,MARKET_PRESSURE_DECAY:.7,LOAN_GARNISHMENT_DAYS:1095,LOAN_GARNISHMENT_PERCENT:.14,RANDOM_EVENT_CHANCE:.07}),ge=[{threshold:5e4,revealsTier:2},{threshold:45e4,revealsTier:3},{threshold:4e6,revealsTier:4},{threshold:35e6,revealsTier:5},{threshold:3e8,revealsTier:6},{threshold:25e8,revealsTier:7}],Ee="orbitalTraderSave_v2";var Ae={START_YEAR:2140,START_DAY_OF_WEEK:1,DAYS_IN_MONTH:[31,28,31,30,31,30,31,31,30,31,30,31],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Ue={NEUTRAL:{name:"Neutral System",duration:28,description:"Standard space-faring conditions. Markets are operating under normal parameters.",modifiers:{}}},d={CONFIG:{INTEL_COST_PERCENTAGE:.2,INTEL_MIN_CREDITS:5e3,INTEL_CHANCE:.3,INTEL_DEMAND_MOD:1.8,INTEL_DEPRESSION_MOD:.5},SYSTEM_STATES:Ue,DATE_CONFIG:Ae,INTRO_SEQUENCE_V1:{modals:[{id:"lore_1",title:"Year 2140",description:'Humanity has expanded throughout the Solar System.<br><br> <span class="hl">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.',buttonText:"Begin",contentClass:"text-center"},{id:"lore_2",title:"The Price of Freedom",description:"A dead-end job in the Belt pays the bills, but it does not offer the <b class='hl-green font-bold'>prosperity</b> that you dream of.<br><br>The <span class='hl'>Merchant's Guild</span> will fund your ambition, but their price is steep.<br><br>This is no simple loan; it's a bet on yourself and your future.",buttonText:"Apply for Loan",contentClass:"text-center",buttonClass:"btn-pulse-green"},{id:"charter",title:`<span class="hl">MERCHANT'S GUILD LOAN AGREEMENT</span>`,description:`
            <div class="font-roboto-mono text-left text-sm space-y-2">
                <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
                <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">\u232C 25,000</span></p>
                <p><span class="text-gray-400">INTEREST RATE:</span> 1.56% (Monthly)</p>
            </div>
            <div class="border-t border-slate-600 my-4"></div>
            <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment and interest accrual, subject to the Interstellar Commerce Mandates of the Merchant's Guild. This binding digital agreement is logged on the system-wide ledger, whereupon it is considered immutable and enforceable system-wide. The principal of the debt is due in 1095 Terran-standard days, after which failure to remit payment shall authorize the automatic initiation of a garnishment sub-routine against the Applicant's credit.</p>
          `,buttonText:"Accept Terms",buttonClass:"btn-pulse-gold"},{id:"signature",title:"SIGN YOUR NAME",description:`
            <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
          `,buttonText:"Submit Application"},{id:"final",title:"Low On Credits!",description:"Interest on your debt grows every month. It's time to make some <b class='hl-yellow font-bold'>credits</b>. Let's view the <b>Mission Terminal</b> here on <b>Mars</b>!",buttonText:"View Missions"}]},LOCATION_VISUALS:{[g.EARTH]:"\u{1F30D}",[g.LUNA]:"\u{1F315}",[g.MARS]:"\u{1F534}",[g.VENUS]:"\u{1F7E1}",[g.BELT]:"\u{1FAA8}",[g.SATURN]:"\u{1FA90}",[g.JUPITER]:"\u{1F7E0}",[g.URANUS]:"\u{1F535}",[g.NEPTUNE]:"\u{1F7E3}",[g.PLUTO]:"\u{1FAA9}",[g.EXCHANGE]:"\u{1F3F4}\u200D\u2620\uFE0F",[g.KEPLER]:"\u{1F441}\uFE0F"},TRAVEL_VISUALS:{zones:{inner_sphere:{locations:[g.EARTH,g.LUNA,g.MARS,g.BELT],gradient:["#0f172a","#1e3a8a"]},outer_reaches:{locations:[g.JUPITER,g.SATURN,g.URANUS,g.NEPTUNE],gradient:["#0f172a","#312e81"]}},objects:{earth_to_mars:[{type:"planet",emoji:"\u{1F315}",position:{x:.5,y:.3},scale:.8,speed:.3}],belt_to_jupiter:[{type:"asteroid_field",count:15,speed:.2}]}},PERKS:{[E.TRADEMASTER]:{profitBonus:.05},[E.NAVIGATOR]:{fuelMod:.9,hullDecayMod:.9,travelTimeMod:.9},[E.VENETIAN_SYNDICATE]:{fuelDiscount:.25,repairDiscount:.25}},AGE_EVENTS:[{id:"captain_choice",trigger:{day:366},title:"Captain Who?",description:"You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",choices:[{title:"Trademaster",description:"5% bonus on all trade profits.",perkId:E.TRADEMASTER,playerTitle:"Trademaster"},{title:"Navigator",description:"10% reduced fuel usage, hull decay, and travel time.",perkId:E.NAVIGATOR,playerTitle:"Navigator"}]},{id:"friends_with_benefits",trigger:{credits:5e4},title:"Friends with Benefits",description:"An ally in need is an ally indeed.",choices:[{title:"Join the Merchant's Guild",description:"Receive a free C-Class freighter.",perkId:E.MERCHANT_GUILD_SHIP},{title:"Join the Venetian Syndicate",description:"75% discount on fuel and repairs at Venus.",perkId:E.VENETIAN_SYNDICATE}]}],RANDOM_EVENTS:[{id:"distress_call",title:"Distress Call",scenario:"You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.",precondition:(l,e)=>e.fuel>=20,choices:[{title:"Offer Aid (20 Fuel)",outcomes:[{chance:.75,description:"The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.",effects:[{type:"fuel",value:-20},{type:"credits",value:1e4}]},{chance:.25,description:"As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.",effects:[{type:"fuel",value:-20},{type:"hull_damage_percent",value:15}]}]},{title:"Ignore the Call",outcomes:[{chance:1,description:"You press on, and the desperate signal fades behind you.",effects:[]}]}]},{id:"floating_cargo",title:"Floating Cargo Pod",scenario:"Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.",precondition:()=>!0,choices:[{title:"Bring it Aboard",outcomes:[{chance:.6,description:"The pod contains valuable goods. You gain 25 units of Neural Processors.",effects:[{type:"add_cargo",value:{id:b.PROCESSORS,quantity:25}}]},{chance:.4,description:"It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.",effects:[{type:"hull_damage_percent",value:20}]}]},{title:"Report it",outcomes:[{chance:1,description:"You notify the nearest station of the hazard and receive a small finder's fee of 1,000 credits.",effects:[{type:"credits",value:1e3}]}]}]},{id:"adrift_passenger",title:"Adrift Passenger",scenario:"You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.",precondition:(l,e)=>e.fuel>=30,choices:[{title:"Take Aboard for Payment",outcomes:[{chance:1,description:"The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.",effects:[{type:"credits",value:1e4}]}]},{title:"Give a Fuel Cell (30 Fuel)",outcomes:[{chance:1,descriptions:{reward_cybernetics:'In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.',reward_debt_paid:'Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.',reward_credits:'With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.'},effects:[{type:"ADRIFT_PASSENGER"}]}]}]},{id:"meteoroid_swarm",title:"Micrometeoroid Swarm",scenario:"Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.",precondition:(l,e)=>e.fuel>=15,choices:[{title:"Evade Aggressively (+15 Fuel)",outcomes:[{chance:1,description:"You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.",effects:[{type:"fuel",value:-15}]}]},{title:"Brace for Impact",outcomes:[{chance:1,description:"You trust your hull to withstand the impacts, taking a beating but saving fuel.",effects:[{type:"hull_damage_percent",value:[10,25]}]}]}]},{id:"engine_malfunction",title:"Engine Malfunction",scenario:"A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.",precondition:(l,e,t)=>(t()[b.PLASTEEL]?.quantity||0)>=5,choices:[{title:"Quick, Risky Fix (5 Plasteel)",outcomes:[{chance:.5,description:"The patch holds! The engine stabilizes and you continue your journey without further incident.",effects:[{type:"lose_cargo",value:{id:b.PLASTEEL,quantity:5}}]},{chance:.5,description:"The patch fails catastrophically, causing a small explosion that deals 20% hull damage.",effects:[{type:"lose_cargo",value:{id:b.PLASTEEL,quantity:5}},{type:"hull_damage_percent",value:20}]}]},{title:"Limp to Destination",outcomes:[{chance:1,description:"You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.",effects:[{type:"travel_time_add_percent",value:.25}]}]}]},{id:"nav_glitch",title:"Navigation Sensor Glitch",scenario:"The nav-console flashes red. Your primary positioning sensors are offline, and you're flying blind in the deep dark.",precondition:()=>!0,choices:[{title:"Attempt Hard Reboot",outcomes:[{chance:.5,description:"Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.",effects:[{type:"set_travel_time",value:1}]},{chance:.5,description:"The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.",effects:[{type:"travel_time_add",value:15}]}]},{title:"Navigate Manually",outcomes:[{chance:1,description:"You rely on old-fashioned star charts. It's slow but safe, adding 7 days to your trip.",effects:[{type:"travel_time_add",value:7}]}]}]},{id:"life_support_fluctuation",title:"Life Support Fluctuation",scenario:"An alarm indicates unstable oxygen levels. It's not critical yet, but the crew is on edge and efficiency is dropping.",precondition:(l,e)=>e.health>e.maxHealth*.25,choices:[{title:"Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)",outcomes:[{chance:1,description:"You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship's integrity is compromised.",effects:[{type:"hull_damage_percent",value:25}]}]},{title:"Defer Maintenance Costs",outcomes:[{chance:1,description:"You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.",effects:[{type:"add_debt",value:5e3}]}]}]},{id:"cargo_rupture",title:"Cargo Hold Rupture",scenario:"A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.",precondition:(l,e,t)=>{let i=t();return i?Object.values(i).some(a=>a.quantity>0):!1},choices:[{title:"Jettison Damaged Cargo",outcomes:[{chance:1,description:"You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.",effects:[{type:"lose_random_cargo_percent",value:.1}]}]},{title:"Attempt EVA Repair",outcomes:[{chance:.75,description:"The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.",effects:[{type:"travel_time_add",value:2}]},{chance:.25,description:"The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.",effects:[{type:"lose_random_cargo_percent",value:.5},{type:"travel_time_add",value:2}]}]}]},{id:"space_race",title:"Space Race Wager",scenario:'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',precondition:l=>l.player.credits>100,choices:[{title:"Accept Wager (Bet: 80% of current credits)",outcomes:[{chance:1,description:"You accept the high-stakes challenge...",effects:[{type:"SPACE_RACE",wagerPercentage:.8,winChance:{S:.85,A:.7,B:.55,C:.4,O:.95}}]}]},{title:"Politely Decline",outcomes:[{chance:1,description:"You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.",effects:[]}]}]},{id:"supply_drop",title:"Emergency Supply Drop",scenario:"You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.",precondition:(l,e,t)=>{let i=t();return i&&Object.values(i).some(a=>a.quantity>0)},choices:[{title:"Divert Course to Deliver",outcomes:[{chance:1,description:"You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.",effects:[{type:"sell_random_cargo_premium",value:3},{type:"travel_time_add",value:7},{type:"set_new_random_destination"}]}]},{title:"Decline and Continue",outcomes:[{chance:1,description:"You stick to your original plan and let someone else handle the emergency supply run.",effects:[]}]}]}],SHIPS:{[A.WANDERER]:{name:"Wanderer",class:"C",price:25e3,maxHealth:100,cargoCapacity:20,maxFuel:100,saleLocationId:null,lore:"The All-Rounder. A reliable, if unspectacular, light freighter. Its balanced stats make it a good choice for new captains finding their niche."},[A.STALWART]:{name:"Stalwart",class:"C",price:25e3,maxHealth:150,cargoCapacity:45,maxFuel:80,saleLocationId:g.MARS,lore:"The Hauler. A workhorse of the inner worlds. Slow and cumbersome, but boasts an impressive cargo capacity for its price point."},[A.MULE]:{name:"Mule",class:"C",price:25e3,maxHealth:75,cargoCapacity:30,maxFuel:150,saleLocationId:g.BELT,lore:"The Explorer. What it lacks in cargo space, it makes up for with surprising efficiency and robust systems, allowing it to travel further and cheaper than other ships in its class."},[A.PATHFINDER]:{name:"Pathfinder",class:"B",price:18e4,maxHealth:120,cargoCapacity:40,maxFuel:150,saleLocationId:g.LUNA,lore:"Built for the long haul. Its extended fuel tanks and robust sensor suite make it ideal for reaching the outer edges of the system."},[A.NOMAD]:{name:"Nomad",class:"B",price:28e4,maxHealth:100,cargoCapacity:35,maxFuel:140,saleLocationId:g.URANUS,lore:"A vessel designed for self-sufficiency, featuring advanced life support and a small onboard workshop for emergency repairs."},[A.VINDICATOR]:{name:"Vindicator",class:"A",price:75e4,maxHealth:250,cargoCapacity:80,maxFuel:120,saleLocationId:g.NEPTUNE,lore:"A decommissioned military frigate. Fast, tough, and intimidating, with cargo space retrofitted where missile launchers used to be."},[A.AEGIS]:{name:"Aegis",class:"A",price:12e5,maxHealth:120,cargoCapacity:70,maxFuel:140,saleLocationId:g.EARTH,lore:"Built as a high-threat escort vessel, its hull is exceptionally dense. A flying fortress that can also haul a respectable amount of cargo."},[A.ODYSSEY]:{name:"Odyssey",class:"S",price:38e5,maxHealth:100,cargoCapacity:120,maxFuel:250,saleLocationId:g.SATURN,lore:"The pinnacle of personal transport. Gleaming chrome, whisper-quiet engines, and a cabin that smells of rich Corinthian leather."},[A.MAJESTIC]:{name:"Majestic",class:"S",price:72e5,maxHealth:200,cargoCapacity:160,maxFuel:250,saleLocationId:g.KEPLER,lore:"A flying palace favored by corporate magnates. Its speed, range, and capacity make it one of the most versatile ships money can buy."},[A.TITAN_HAULER]:{name:"Titan Hauler",class:"S",price:18e5,maxHealth:175,cargoCapacity:300,maxFuel:75,saleLocationId:g.URANUS,isRare:!0,lore:"A relic of a failed colonization effort, this ship is almost entirely a cargo container with an engine strapped to it."},[A.VOID_CHASER]:{name:"Void Chaser",class:"S",price:31e5,maxHealth:50,cargoCapacity:90,maxFuel:400,saleLocationId:g.BELT,isRare:!0,lore:"A heavily modified smuggling vessel. Its paper-thin hull is a small price to pay for its legendary engine and long-range fuel cells."},[A.GUARDIAN]:{name:"Guardian",class:"S",price:15e5,maxHealth:400,cargoCapacity:75,maxFuel:150,saleLocationId:g.EARTH,isRare:!0,lore:"An experimental military prototype with redundant hull plating, designed to withstand extreme punishment."},[A.STARGAZER]:{name:"Stargazer",class:"S",price:95e4,maxHealth:100,cargoCapacity:60,maxFuel:350,saleLocationId:g.JUPITER,isRare:!0,lore:"A deep-space exploration vessel with colossal fuel reserves, intended for journeys far beyond the known systems."},[A.BEHEMOTH]:{name:"Behemoth",class:"O",price:32e6,maxHealth:600,cargoCapacity:500,maxFuel:600,saleLocationId:g.EXCHANGE,isRare:!0,lore:"An orbital-class freighter that dwarfs even the largest stations. It is a legend among traders, rumored to be a mobile black market in its own right."}},COMMODITIES:[{id:b.WATER_ICE,name:"Water Ice",tier:1,basePriceRange:[15,80],volatility:.01,canonicalAvailability:[80,150],styleClass:"item-style-1",lore:"Crude, unrefined water ice scraped from asteroids; a universal necessity.",cat:"RAW",symbol:"H2O"},{id:b.PLASTEEL,name:"Plasteel",tier:1,basePriceRange:[100,280],volatility:.015,canonicalAvailability:[80,150],styleClass:"item-style-2",lore:"A basic, versatile polymer for 3D printing and simple manufacturing.",cat:"IND",symbol:"PLST"},{id:b.HYDROPONICS,name:"Hydroponics",tier:2,licenseId:"t2_license",basePriceRange:[850,2400],volatility:.025,canonicalAvailability:[40,70],styleClass:"item-style-3",lore:"Packaged agricultural systems and produce essential for feeding isolated colonies.",cat:"AGRI",symbol:"HYD"},{id:b.CYBERNETICS,name:"Cybernetics",tier:2,licenseId:"t2_license",basePriceRange:[1200,3800],volatility:.03,canonicalAvailability:[40,70],styleClass:"item-style-4",lore:"Mass-produced enhancement limbs and organs for the industrial workforce.",cat:"TECH",symbol:"CYB"},{id:b.PROPELLANT,name:"Refined Propellant",tier:3,licenseId:"t3_license",basePriceRange:[14e3,38e3],volatility:.035,canonicalAvailability:[25,50],styleClass:"item-style-5",lore:"High-efficiency fuel that powers all modern ship drives.",cat:"IND",symbol:"PROP"},{id:b.PROCESSORS,name:"Neural Processors",tier:3,licenseId:"t3_license",basePriceRange:[18e3,52e3],volatility:.045,canonicalAvailability:[25,50],styleClass:"item-style-6",lore:"The silicon brains behind complex ship systems and station logistics.",cat:"TECH",symbol:"NPRO"},{id:b.GMO_SEEDS,name:"GMO Seed Cultures",tier:4,licenseId:"t4_license",basePriceRange:[19e4,55e4],volatility:.06,canonicalAvailability:[15,30],styleClass:"item-style-7",lore:"Patented seeds holding the key to unlocking agricultural wealth on new worlds.",cat:"AGRI",symbol:"GMO"},{id:b.CRYO_PODS,name:"Cryo-Sleep Pods",tier:4,licenseId:"t4_license",basePriceRange:[25e4,75e4],volatility:.075,canonicalAvailability:[15,30],styleClass:"item-style-8",lore:"Essential for long-haul passenger transport and colonization efforts.",cat:"CIV",symbol:"CRYO"},{id:b.ATMO_PROCESSORS,name:"Atmo Processors",tier:5,licenseId:"t5_license",basePriceRange:[28e5,85e5],volatility:.08,canonicalAvailability:[10,20],styleClass:"item-style-9",lore:"Gargantuan machines that begin the centuries-long process of making a world breathable.",cat:"IND",symbol:"ATMO"},{id:b.CLONED_ORGANS,name:"Cloned Organs",tier:5,licenseId:"t5_license",basePriceRange:[35e5,11e6],volatility:.09,canonicalAvailability:[10,20],styleClass:"item-style-10",lore:"Lab-grown replacements with high demand in wealthy core worlds; morally grey.",cat:"BIO",symbol:"CLON"},{id:b.XENO_GEOLOGICALS,name:"Xeno-Geologicals",tier:6,licenseId:"t6_license",basePriceRange:[24e6,7e7],volatility:.1,canonicalAvailability:[2,10],styleClass:"item-style-11",lore:"Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure.",cat:"RAW",symbol:"XENO"},{id:b.SENTIENT_AI,name:"Sentient AI Cores",tier:6,licenseId:"t6_license",basePriceRange:[32e6,95e6],volatility:.125,canonicalAvailability:[2,10],styleClass:"item-style-12",lore:'The "brains" of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate.',cat:"TECH",symbol:"AI"},{id:b.ANTIMATTER,name:"Antimatter",tier:7,licenseId:"t7_license",basePriceRange:[28e7,8e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-13",lore:"The only safe way to transport the most volatile and powerful substance known to science.",cat:"RARE",symbol:"AM"},{id:b.FOLDED_DRIVES,name:"Folded-Space Drives",tier:7,licenseId:"t7_license",basePriceRange:[35e7,11e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-14",lore:"The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps.",cat:"RARE",symbol:"FSD"}],LICENSES:{t2_license:{type:"purchase",name:"Tier 2 Trade License",description:"Grants access to trade Tier 2 commodities like Hydroponics and Cybernetics.",cost:25e3},t3_license:{type:"mission",name:"Tier 3 Trade License",description:"Grants access to trade Tier 3 commodities.",missionId:"mission_license_t3",guidanceText:"Access to this tier is granted by the Merchant's Guild upon completion of a key contract."},t4_license:{type:"purchase",name:"Tier 4 Trade License",description:"Grants access to trade Tier 4 commodities.",cost:4e6},t5_license:{type:"mission",name:"Tier 5 Trade License",description:"Grants access to trade Tier 5 commodities.",missionId:"mission_license_t5",guidanceText:"Prove your industrial might by completing a grand contract for a planetary governor."},t6_license:{type:"purchase",name:"Tier 6 Trade License",description:"Grants access to trade the rarest and most exotic technologies.",cost:3e8},t7_license:{type:"mission",name:"Tier 7 Trade License",description:"The ultimate license, granting the right to trade reality-bending technologies.",missionId:"mission_license_t7",guidanceText:"Only a true legend of the trade routes can earn this privilege."}},MARKETS:[{id:g.VENUS,name:"Venus",distance:97,launchFlavor:"Floating cities hide scientific marvels and secrets.",navTheme:{gradient:"linear-gradient(to bottom right, #854d0e, #0f172a)",textColor:"#fde047",borderColor:"#facc15"},description:"A scientific enclave hungry for research data and processors.",color:"border-yellow-400",bg:"bg-gradient-to-br from-yellow-800 to-slate-900",fuelPrice:400,arrivalLore:"Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.",specialty:"Exclusive access to the Venetian Syndicate for high-risk, high-reward intel and missions.",availabilityModifier:{[b.CLONED_ORGANS]:2,[b.PROCESSORS]:2,[b.GMO_SEEDS]:.5,[b.SENTIENT_AI]:.5}},{id:g.EARTH,name:"Earth",distance:180,launchFlavor:"The bustling heart of the Sol system.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #0f172a)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"The hub of power and wealth. High demand for tech and bio-enhancements.",color:"border-cyan-500",bg:"bg-gradient-to-br from-blue-900 to-slate-900",fuelPrice:250,arrivalLore:"The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.",specialty:"Offers the best sell prices for rare, high-tier goods and is the exclusive source for top-tier ship licenses.",availabilityModifier:{[b.HYDROPONICS]:2,[b.GMO_SEEDS]:2,[b.CLONED_ORGANS]:.5,[b.XENO_GEOLOGICALS]:.5}},{id:g.LUNA,name:"The Moon",parent:"loc_earth",distance:15,launchFlavor:"An industrial powerhouse built on grey dust.",navTheme:{gradient:"linear-gradient(to bottom right, #374151, #0f172a)",textColor:"#e5e7eb",borderColor:"#9ca3af"},description:"An industrial proving ground. Exports propellant and basic materials.",color:"border-gray-400",bg:"bg-gradient-to-br from-gray-700 to-slate-900",fuelPrice:350,arrivalLore:"Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.",specialty:"Offers a slight discount on all ship repairs.",availabilityModifier:{[b.PLASTEEL]:2,[b.PROPELLANT]:2,[b.WATER_ICE]:.5,[b.HYDROPONICS]:.5}},{id:g.MARS,name:"Mars",distance:226,launchFlavor:"The red frontier, ripe with opportunity.",navTheme:{gradient:"linear-gradient(to bottom right, #7c2d12, #0f172a)",textColor:"#fca5a5",borderColor:"#f87171"},description:"A growing colony. Needs processors and materials for expansion.",color:"border-orange-600",bg:"bg-gradient-to-br from-orange-900 to-slate-900",fuelPrice:450,arrivalLore:"The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.",specialty:"Offers a higher-than-average number of colonial supply missions.",availabilityModifier:{[b.PLASTEEL]:2,[b.HYDROPONICS]:.5,[b.CRYO_PODS]:.5,[b.WATER_ICE]:.5}},{id:g.BELT,name:"The Belt",distance:292,launchFlavor:"A lawless expanse of rock and riches.",navTheme:{gradient:"linear-gradient(to bottom right, #292524, #0f172a)",textColor:"#ca8a04",borderColor:"#ca8a04"},description:"A lawless frontier. Rich in raw minerals and water ice.",color:"border-amber-700",bg:"bg-gradient-to-br from-stone-800 to-slate-900",fuelPrice:600,arrivalLore:"Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.",specialty:"Increased chance to find rare derelict ships in its shipyards.",availabilityModifier:{[b.WATER_ICE]:2,[b.XENO_GEOLOGICALS]:2,[b.HYDROPONICS]:.5,[b.CYBERNETICS]:.5}},{id:g.EXCHANGE,name:"The Exchange",distance:309,launchFlavor:"The notorious black market of the outer belt.",navTheme:{gradient:"linear-gradient(to bottom right, #581c87, #000000, #0f172a)",textColor:"#e9d5ff",borderColor:"#c084fc"},description:"A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.",color:"border-purple-500",bg:"bg-gradient-to-br from-purple-900 via-black to-slate-900",fuelPrice:1200,arrivalLore:"A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.",specialty:"The notorious black market of the outer belt.",availabilityModifier:{}},{id:g.JUPITER,name:"Jupiter",distance:443,launchFlavor:"Vast refineries harvest fuel from the giant.",navTheme:{gradient:"linear-gradient(to bottom right, #9a3412, #1c1917)",textColor:"#fed7aa",borderColor:"#fb923c"},description:"A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.",color:"border-orange-400",bg:"bg-gradient-to-br from-orange-800 to-stone-900",fuelPrice:150,arrivalLore:"The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.",specialty:"Fuel is sold at 50% of the galactic average price, making it an essential stop for any long-haul journey.",availabilityModifier:{[b.PROPELLANT]:2,[b.ATMO_PROCESSORS]:2,[b.PROCESSORS]:.5}},{id:g.SATURN,name:"Saturn",distance:618,launchFlavor:"Opulent stations drift among majestic rings.",navTheme:{gradient:"linear-gradient(to bottom right, #713f12, #312e81, #0f172a)",textColor:"#fef08a",borderColor:"#fde047"},description:"A tourism hub. Demands luxury goods and bio-wares.",color:"border-yellow-200",bg:"bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900",fuelPrice:550,arrivalLore:"The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.",specialty:"Offers the highest sell prices for luxury and bio-tech goods.",availabilityModifier:{[b.CRYO_PODS]:.5,[b.CLONED_ORGANS]:.5}},{id:g.URANUS,name:"Uranus",distance:775,launchFlavor:"A silent, ice-cold world of strange science.",navTheme:{gradient:"linear-gradient(to bottom right, #155e75, #312e81)",textColor:"#a5f3fc",borderColor:"#67e8f9"},description:"A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.",color:"border-cyan-200",bg:"bg-gradient-to-br from-cyan-800 to-indigo-900",fuelPrice:700,arrivalLore:"The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.",specialty:'A unique R&D service to temporarily "overclock" ship components.',availabilityModifier:{[b.ATMO_PROCESSORS]:2,[b.SENTIENT_AI]:.5,[b.PROCESSORS]:.5}},{id:g.NEPTUNE,name:"Neptune",distance:877,launchFlavor:"The stormy edge of military-controlled space.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #000000)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"A dark, stormy world, home to secretive military bases and shipyards.",color:"border-blue-400",bg:"bg-gradient-to-br from-blue-900 to-black",fuelPrice:650,arrivalLore:"Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.",specialty:"A military surplus shipyard that occasionally sells damaged, high-tier frigates.",availabilityModifier:{[b.PLASTEEL]:.1,[b.PROPELLANT]:.5}},{id:g.KEPLER,name:"Kepler's Eye",distance:903,launchFlavor:"A colossal lens staring into the infinite void.",navTheme:{gradient:"linear-gradient(to bottom right, #701a75, #0f172a)",textColor:"#f472b6",borderColor:"#ec4899"},description:"A massive deep-space observatory that consumes vast amounts of processing power.",color:"border-fuchsia-500",bg:"bg-gradient-to-br from-fuchsia-900 to-slate-900",fuelPrice:800,arrivalLore:"The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.",specialty:"A colossal lens staring into the infinite void.",availabilityModifier:{}},{id:g.PLUTO,name:"Pluto",distance:1080,launchFlavor:"A haven for outcasts at the system's fringe.",navTheme:{gradient:"linear-gradient(to bottom right, #312e81, #0f172a)",textColor:"#c4b5fd",borderColor:"#a78bfa"},description:"The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.",color:"border-indigo-400",bg:"bg-gradient-to-br from-indigo-900 to-slate-900",fuelPrice:900,arrivalLore:"Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.",specialty:"A haven for outcasts at the system's fringe.",availabilityModifier:{water_ice:2,hydroponics:.5,cybernetics:.5,cloned_organs:.5,xeno_geologicals:2}}],MISSIONS:{mission_tutorial_01:{id:"mission_tutorial_01",name:"Milk Run to Luna",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"Hey buddy, you're a new captain, right? My hauler's reactor is fried and I'm on the hook for a delivery to Luna.<br><br>Could you deliver this load of <b>Plasteel</b> to the <b>Moon</b> for me? I don't have any credits to spare, but I've padded the manifest.<br><br>Deliver what I owe, keep the rest. You won't have trouble selling it there, trust me.",objectives:[{type:"have_item",goodId:"plasteel",quantity:5}],completion:{locationId:"loc_luna",title:"Favor Complete",text:"The freelancer sends his thanks.",buttonText:"Deliver Plasteel"},rewards:[],providedCargo:[{goodId:"plasteel",quantity:6}]},mission_tutorial_02:{id:"mission_tutorial_02",name:"Martian Resupply",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"A construction crew on Mars has requested a small shipment of plasteel to complete a habitat.",prerequisites:[{type:"mission_completed",missionId:"mission_tutorial_01"}],objectives:[{type:"have_item",goodId:"plasteel",quantity:2}],completion:{locationId:"loc_mars",title:"Delivery Complete",text:"The construction foreman thanks you for the Plasteel.",buttonText:"Deliver Plasteel"},rewards:[{type:"credits",amount:7500}]},mission_license_t3:{id:"mission_license_t3",name:"Guild Certification",type:"LICENSE_GRANT",host:"GUILD",isRepeatable:!1,isAbandonable:!1,description:"The Merchant's Guild requires you to certify your trade proficiency. Accepting this contract formally recognizes your status and grants you access to Tier 3 commodities.",prerequisites:[{type:"revealed_tier",tier:3}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t3_license"}]},mission_license_t5:{id:"mission_license_t5",name:"Governor's Contract",type:"LICENSE_GRANT",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"The planetary governor requires a sign of your commitment to local industry. This contract solidifies your standing and unlocks access to Tier 5 commodities.",prerequisites:[{type:"revealed_tier",tier:5}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t5_license"}]},mission_license_t7:{id:"mission_license_t7",name:"Legendary Run",type:"LICENSE_GRANT",host:"UNKNOWN",isRepeatable:!1,isAbandonable:!1,description:"Your name is spoken in the farthest corners of the system. Only a legend of your stature may be granted the right to trade the most advanced technologies known.",prerequisites:[{type:"revealed_tier",tier:7}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t7_license"}]}},TUTORIAL_DATA:{intro_hangar:{title:"Your First Ship",trigger:{type:w.ACTION,action:"INTRO_START_HANGAR"},navLock:!0,steps:[{stepId:"hangar_1",text:"Welcome to the <b>Shipyard</b> on <b>Mars!</b><br><br>Every station has a port from which you can trade ships and manage your <b>Hangar</b>.",position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:w.INFO},nextStepId:"hangar_2",isSkippable:!0},{stepId:"hangar_2",text:"Now that you've borrowed <b class='hl-yellow font-bold'>extra credits</b>, you can buy your first ship!<br><br>Select one of the options in the <b>Shipyard</b>. Choose carefully...",position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:w.ACTION,action:f.BUY_SHIP},nextStepId:"hangar_3",isSkippable:!0,unlockPurchase:!0},{stepId:"hangar_3",text:'This is your <b>Hangar</b>. From here you can manage all the ships you own. Select your new ship and <b class="hl-yellow font-bold">Board</b> it to make it your active vessel.',position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:w.ACTION,action:f.SELECT_SHIP},nextStepId:null,isSkippable:!1}]},intro_finance:{title:"Managing Your Debt",trigger:{type:w.ACTION,action:"INTRO_START_FINANCE"},navLock:!0,steps:[{stepId:"finance_1",text:"That was a big purchase, but don't worry - you've still got some <b class='hl-yellow font-bold'>credits</b> left over!<br><br>Your transaction history and debts can be viewed on the <b>Finance</b> tab within <b>Data</b>.",position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:w.INFO},nextStepId:"finance_2",isSkippable:!1},{stepId:"finance_2",text:"Dont forget, your debt to the <b class='hl-yellow font-bold'>Merchant's Guild</b> is due in <b class='hl-red font-bold'>3 years</b>.<br><br>You will need to earn <b class='hl-yellow font-bold'>credits</b> to <b>pay off your debt</b>!",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:w.INFO},nextStepId:null,isSkippable:!1}]},intro_missions:{id:"intro_missions",title:"First Steps",trigger:{type:"ACTION",action:"INTRO_START_MISSIONS"},navLock:!0,steps:[{stepId:"mission_1_1",text:"This is the <b>Mission Terminal</b>.<br><br>Check the <b>Missions</b> tab often for opportunities to earn <b class='hl-yellow font-bold'>credits</b> and improve your reputation.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"INFO"},nextStepId:"mission_1_2",isSkippable:!1},{stepId:"mission_1_2",text:"A freelancer at the <b>Mars</b> station has put in a <b>Delivery</b> request. Select the mission '<b>Milk Run to Luna</b>' to view more details.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"ACTION",action:"show-mission-modal"},nextStepId:"mission_1_3",isSkippable:!1},{stepId:"mission_1_3",text:"The freelancer can't pay, but he's giving you the <b>remaining cargo</b>. Accept the contract.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"ACTION",action:"accept-mission"},nextStepId:"mission_1_4",isSkippable:!1},{stepId:"mission_1_4",text:"Mission accepted!<br><br>The contract is now <b>active</b> and the cargo as been loaded onto your ship, the <b>{shipName}</b>.<br><br>The freelancer has also loaded extra <b>Plasteel</b> which you can sell for <b class='hl-yellow font-bold'>credits</b>.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"INFO"},nextStepId:"mission_1_5",isSkippable:!1},{stepId:"mission_1_5",text:"This mission must be completed on the <b>Moon</b>, but you are presently docked at <b>Mars</b>! Therefore, it's time for the maiden voyage of your new ship, the <b>{shipName}</b>!<br><br>On the <b>nav bar</b> at the top, select the <b>Ship</b> tab, then the <b>Navigation</b> tab.",position:{desktop:"bottom-center",mobile:"bottom-center"},completion:{type:"SCREEN_LOAD",screenId:"navigation"},nextStepId:"mission_1_6",isSkippable:!1,navLock:{navId:M.SHIP,screenId:"navigation"}},{stepId:"mission_1_6",text:"From here you can travel to other stations in the system. This will cost you <b>time</b>, <b class='hl-blue'>fuel</b>, and wear on the <b class='hl-green'>hull</b> of your ship.<br><br>Select the <b>Moon</b> to lift off from <b>Mars</b>.",position:{desktop:"top-center",mobile:"top-center"},completion:{type:"ACTION",action:"travel"},nextStepId:"mission_1_7",isSkippable:!1,navLock:{navId:M.SHIP,screenId:"navigation",enabledElementQuery:"[data-location-id='loc_luna']"}},{stepId:"mission_1_7",text:"You've arrived and docked at the <b>Moon</b> station!<br><br>It's time to deliver the <b>Plasteel</b>. Select the active mission and <b>deliver the Plasteel</b>.",position:{desktop:"bottom-center",mobile:"bottom-center"},completion:{type:"ACTION",action:"complete-mission"},nextStepId:"mission_1_8",isSkippable:!1,navLock:{navId:M.DATA,screenId:"missions"}},{stepId:"mission_1_8",text:"Mission complete!<br><br>However, favors don't pay off <b class='hl-yellow font-bold'>Guild</b> loans. You're going to need more <b class='hl-yellow font-bold'>credits</b>.",position:{desktop:"top-center",mobile:"bottom-center"},completion:{type:"INFO"},nextStepId:"mission_2_1",isSkippable:!1},{stepId:"mission_1_9",text:"Well done. Let's find a more profitable contract. Return to the Mission Terminal.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_1",isSkippable:!1,navLock:{navId:M.DATA,screenId:"missions"}},{stepId:"mission_2_1",text:"The <i>best way to make money</i> is to play the markets yourself by <b class='hl-green font-bold'>buying low and selling high</b>.<br><br>Select the <b>Starport</b> tab, then the <b>Market</b> tab.",position:{desktop:"top-center",mobile:"bottom-center"},completion:{type:"SCREEN_LOAD",screenId:"market"},nextStepId:"mission_2_2",isSkippable:!1,navLock:{navId:M.STARPORT,screenId:"market"}},{stepId:"mission_2_2",text:"This is the <b>Moon Market</b>.<br>On each commodity you will find a wealth of information to aid your trading.<br><br>The <b class='hl-green font-bold'>MKT</b> indicator will inform you of <b class='hl-green font-bold'>prices higher or lower than average.</b> Selecting the price will reveal past performance.<br><br>Select the <b class='hl-yellow font-bold'>Buy/Sell toggle</b> to transition to sale mode, and then sell your single unit of <b>Plasteel</b>.",position:{desktop:"top-center",mobile:"bottom-center"},completion:{type:"ACTION",action:"sell-item",goodId:"plasteel"},nextStepId:"mission_2_3",isSkippable:!1},{stepId:"mission_2_3",text:"<b class='hl-green font-bold'>Pure profit</b>!<br><br>However, you still need more <b class='hl-yellow font-bold'>credits</b>! Return to the <b>Mission Terminal</b> by selecting the <b>Data</b> tab.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_4",isSkippable:!1,navLock:{navId:M.DATA,screenId:"missions"}},{stepId:"mission_2_4",text:"This mission offers a <b class='hl-yellow font-bold'>credit</b> reward.<br><br>Accept the mission, <b>Martian Resupply</b>.",position:{desktop:"bottom-right",mobile:"bottom-center"},completion:{type:"ACTION",action:"accept-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_3_1",isSkippable:!1},{stepId:"mission_3_1",text:"To complete this mission you will need to <b>travel to Mars</b> after you have purchased <b>two Plasteel</b> from any <b>Market</b>.<br><br>After you have acquired the <b>Plasteel</b>, visit the <b>Mission</b> tab on <b>Mars</b> to submit the cargo and complete the mission. ",position:{desktop:"top-center",mobile:"bottom-center"},completion:{type:"ACTION",action:"complete-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_final",isSkippable:!1,navLock:null},{stepId:"mission_final",text:"Well done Captain {playerName}, you have successfully completed trades across the <b>Moon</b> and <b>Mars</b>.<br><br>Continue to trade commodities for <b class='hl-green font-bold'>favorable margins</b> and complete missions to unlock additional opportunities.<br><br><b>The Solar System awaits</b>!",position:{desktop:"top-center",mobile:"bottom-center"},completion:{type:"INFO"},nextStepId:null,isSkippable:!1,buttonText:"Complete Tutorial",navLock:null}]}}};var Ye={"item-style-1":{hex:"#60a5fa",gradient:"linear-gradient(45deg, #3b82f6, #1e3a8a)"},"item-style-2":{hex:"#a3a3a3",gradient:"linear-gradient(45deg, #737373, #262626)"},"item-style-3":{hex:"#22c55e",gradient:"linear-gradient(45deg, #16a34a, #14532d)"},"item-style-4":{hex:"#e5e5e5",gradient:"linear-gradient(45deg, #d4d4d4, #737373)"},"item-style-5":{hex:"#c084fc",gradient:"linear-gradient(45deg, #a855f7, #6b21a8)"},"item-style-6":{hex:"#93c5fd",gradient:"linear-gradient(45deg, #60a5fa, #2563eb)"},"item-style-7":{hex:"#84cc16",gradient:"linear-gradient(45deg, #a3e635, #4d7c0f)"},"item-style-8":{hex:"#67e8f9",gradient:"linear-gradient(45deg, #22d3ee, #0891b2)"},"item-style-9":{hex:"#fcd34d",gradient:"linear-gradient(45deg, #facc15, #b45309)"},"item-style-10":{hex:"#fb7185",gradient:"linear-gradient(45deg, #f43f5e, #9f1239)"},"item-style-11":{hex:"#a78bfa",gradient:"linear-gradient(165deg, #a78bfa, #312e81, #1e3a8a)"},"item-style-12":{hex:"#f87171",gradient:"linear-gradient(45deg, #ef4444, #7f1d1d)"},"item-style-13":{hex:"#d8b4fe",gradient:"linear-gradient(45deg, #a855f7, #3b0764)"},"item-style-14":{hex:"#f472b6",gradient:"linear-gradient(45deg, #ec4899, #831843)"}};function q(l){return Ye[l]||{hex:"#a8a29e",gradient:"linear-gradient(45deg, #52525b, #18181b)"}}function S(l,e=!0){let t=l<0,i=Math.abs(Math.floor(l)),a=e?"\u232C ":"",s=t?"-":"",n;return i>=1e12?n=`${(i/1e12).toFixed(2)}T`:i>=1e9?n=`${(i/1e9).toFixed(2)}B`:i>=1e6?n=`${(i/1e6).toFixed(2)}M`:i>=1e3?n=`${(i/1e3).toFixed(1)}k`:n=i.toLocaleString(),`${a}${s}${n}`}function N(l){return l?Object.values(l).reduce((e,t)=>e+t.quantity,0):0}function V(l,e){let t=(Math.random()+Math.random()+Math.random())/3;return Math.floor(l+(e-l)*Math.pow(t,.5))}function U({price:l,sellPrice:e,galacticAvg:t,playerItem:i}){let a=l-t,s=t>0?Math.round(a/t*100):0,n=s>=0?"+":"",r="neutral";s>5&&(r="positive"),s<-5&&(r="negative");let o=s>5?"\u25B2":s<-5?"\u25BC":"\u25CF",c=`<div class="indicator-pill ${r}">${o} MKT: ${n}${s}%</div>`,u="";if(i&&i.avgCost>0){let h=e-i.avgCost;if(Math.abs(h)>.01){let m=i.avgCost>0?Math.round(h/i.avgCost*100):0,p=m>=0?"+":"",v=h>=0?"positive":"negative",T=h>=0?"\u25B2":"\u25BC";u=`<div class="indicator-pill ${v}"> P/L: ${p}${m}%</div>`}}return`${c}${u}`}function Ve(l){let e={};return l.forEach(a=>{e[a.id]={},l.forEach(s=>{if(a.id===s.id)return;let n=a.parent?l.find(p=>p.id===a.parent)?.distance||0:a.distance,r=s.parent?l.find(p=>p.id===s.parent)?.distance||0:s.distance,o=Math.abs(r-n),c=a.parent||s.parent?15:0,u=o+c,h=1+Math.pow(u,1.15)*.1,m=2+u*.45;(a.id===g.EARTH&&s.id===g.LUNA||a.id===g.LUNA&&s.id===g.EARTH)&&(h=2+Math.floor(Math.random()*2),m=5+Math.floor(Math.random()*2)),e[a.id][s.id]={time:Math.max(1,Math.round(h)),fuelCost:Math.max(1,Math.round(m))}})}),e}var j=class{constructor(){this.state={},this.subscribers=[],this.TRAVEL_DATA=Ve(d.MARKETS)}subscribe(e){this.subscribers.push(e)}_notify(){this.subscribers.forEach(e=>e(this))}setState(e){Object.assign(this,e),this._notify()}getState(){return JSON.parse(JSON.stringify(this))}saveGame(){}loadGame(){return!1}startNewGame(e){let t={day:1,lastInterestChargeDay:1,lastMarketUpdateDay:1,currentLocationId:g.MARS,activeNav:M.SHIP,activeScreen:y.NAVIGATION,isGameOver:!1,subNavCollapsed:!1,introSequenceActive:!0,lastActiveScreen:{[M.SHIP]:y.MAP,[M.STARPORT]:y.MARKET,[M.DATA]:y.MISSIONS},pendingTravel:null,player:{name:e,playerTitle:"Captain",playerAge:24,lastBirthdayYear:d.DATE_CONFIG.START_YEAR,birthdayProfitBonus:0,introStep:0,credits:3e3,debt:0,monthlyInterestAmount:0,loanStartDate:null,seenGarnishmentWarning:!1,revealedTier:1,unlockedLicenseIds:[],unlockedLocationIds:d.MARKETS.map(i=>i.id).filter(i=>i!==g.EXCHANGE&&i!==g.KEPLER),seenCommodityMilestones:[],financeLog:[],activePerks:{},seenEvents:[],activeShipId:A.WANDERER,ownedShipIds:[A.WANDERER],shipStates:{[A.WANDERER]:{health:d.SHIPS[A.WANDERER].maxHealth,fuel:d.SHIPS[A.WANDERER].maxFuel,hullAlerts:{one:!1,two:!1}}},inventories:{},debugEventIndex:0},market:{prices:{},inventory:{},galacticAverages:{},priceHistory:{},shipyardStock:{}},intel:{active:null,available:{}},tutorials:{activeBatchId:null,activeStepId:null,seenBatchIds:[],skippedTutorialBatches:[],navLock:null},missions:{activeMissionId:null,completedMissionIds:[],missionProgress:{},activeMissionObjectivesMet:!1},uiState:{marketCardMinimized:{},hangarShipyardToggleState:"shipyard",hangarActiveIndex:0,shipyardActiveIndex:0}};t.player.inventories[A.WANDERER]={},d.COMMODITIES.forEach(i=>{t.player.inventories[A.WANDERER][i.id]={quantity:0,avgCost:0}}),d.MARKETS.forEach(i=>{t.market.priceHistory[i.id]={},t.intel.available[i.id]=Math.random()<.3,t.market.inventory[i.id]={},t.market.shipyardStock[i.id]={day:0,shipsForSale:[]},d.COMMODITIES.forEach(a=>{t.market.priceHistory[i.id][a.id]=[];let[s,n]=a.canonicalAvailability,r=i.availabilityModifier?.[a.id]??1,o=Math.floor(V(s,n)*r);i.specialDemand&&i.specialDemand[a.id]&&(o=0),t.market.inventory[i.id][a.id]={quantity:Math.max(0,o),marketPressure:0,lastPlayerInteractionTimestamp:0,hoverUntilDay:0,rivalArbitrage:{isActive:!1,endDay:0}}})}),Object.assign(this,t),this._calculateGalacticAverages(),this._seedInitialMarketPrices(),this.setState({})}_calculateGalacticAverages(){this.market.galacticAverages={},d.COMMODITIES.forEach(e=>{this.market.galacticAverages[e.id]=(e.basePriceRange[0]+e.basePriceRange[1])/2})}_seedInitialMarketPrices(){d.MARKETS.forEach(e=>{this.market.prices[e.id]={},d.COMMODITIES.forEach(t=>{let i=this.market.galacticAverages[t.id]*(1+(Math.random()-.5)*.15);this.market.prices[e.id][t.id]=Math.max(1,Math.round(i))})})}};var z=class{constructor(e){this.gameState=e,this._currentSystemState=null,this._systemStateExpirationDay=0}checkForSystemStateChange(){if(this.gameState.day>this._systemStateExpirationDay){let e=Object.keys(d.SYSTEM_STATES),t=e[Math.floor(Math.random()*e.length)];this._currentSystemState=d.SYSTEM_STATES[t],this._systemStateExpirationDay=this.gameState.day+this._currentSystemState.duration}}evolveMarketPrices(){d.MARKETS.forEach(e=>{d.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id],a=this.gameState.market.prices[e.id][t.id],n=this.gameState.market.galacticAverages[t.id],r=_.DAILY_PRICE_VOLATILITY,o=_.MEAN_REVERSION_STRENGTH,c=this._currentSystemState?.modifiers?.commodity?.[t.id];c&&(c.volatility_mult&&(r*=c.volatility_mult),c.mean_reversion_mult&&(o*=c.mean_reversion_mult));let u=t.basePriceRange[1]-t.basePriceRange[0],h=(Math.random()-.5)*u*r,m=(n-a)*o;i.rivalArbitrage.isActive&&this.gameState.day<i.rivalArbitrage.endDay?m=(n-a)*.2:i.rivalArbitrage.isActive&&(i.rivalArbitrage.isActive=!1),i.hoverUntilDay>this.gameState.day?m*=.1:i.hoverUntilDay>0&&(i.hoverUntilDay=0);let p=n*i.marketPressure*-1,v=a+h+m+p;this._currentSystemState?.modifiers?.commodity?.[t.id]?.price&&(v*=this._currentSystemState.modifiers.commodity[t.id].price),this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(v)),i.marketPressure*=_.MARKET_PRESSURE_DECAY,Math.abs(i.marketPressure)<.001&&(i.marketPressure=0)}),this._recordPriceHistory(e.id)})}replenishMarketInventory(){d.MARKETS.forEach(e=>{d.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id];if(i.lastPlayerInteractionTimestamp>0&&this.gameState.day-i.lastPlayerInteractionTimestamp>60)i.quantity=this._calculateBaselineStock(e,t),i.lastPlayerInteractionTimestamp=0,i.marketPressure=0;else{let[r,o]=t.canonicalAvailability,c=(r+o)/2*(e.availabilityModifier?.[t.id]??1),u=1-Math.min(.5,i.marketPressure*.5),p=(c*u-i.quantity)*.15;i.quantity+=p}let a=Math.random()*.15+.15,s=Math.random()<.5?-1:1,n=1+a*s;i.quantity*=n,this._currentSystemState?.modifiers?.commodity?.[t.id]?.availability&&(i.quantity*=this._currentSystemState.modifiers.commodity[t.id].availability),i.quantity=Math.max(0,Math.round(i.quantity))})})}applyMarketImpact(e,t,i){let a=d.COMMODITIES.find(r=>r.id===e),s=this.gameState.market.inventory[this.gameState.currentLocationId][e],n=t/(a.canonicalAvailability[1]||100)*a.tier/10;i==="buy"?s.marketPressure-=n:s.marketPressure+=n,s.lastPlayerInteractionTimestamp=this.gameState.day}_calculateBaselineStock(e,t){let[i,a]=t.canonicalAvailability,s=e.availabilityModifier?.[t.id]??1;return Math.floor(V(i,a)*s)}_recordPriceHistory(e=null){if(!this.gameState||!this.gameState.market)return;let t=e||this.gameState.currentLocationId;this.gameState.market.priceHistory[t]||(this.gameState.market.priceHistory[t]={}),d.COMMODITIES.forEach(i=>{if(i.tier>this.gameState.player.revealedTier)return;this.gameState.market.priceHistory[t][i.id]||(this.gameState.market.priceHistory[t][i.id]=[]);let a=this.gameState.market.priceHistory[t][i.id],s=this.gameState.market.prices[t][i.id],n=a[a.length-1];for(n&&n.day===this.gameState.day?n.price!==s&&(n.price=s):a.push({day:this.gameState.day,price:s});a.length>_.PRICE_HISTORY_LENGTH;)a.shift()})}_updateShipyardStock(){let{player:e}=this.gameState;e.unlockedLocationIds.forEach(t=>{let i=this.gameState.market.shipyardStock[t];if(i&&i.day===this.gameState.day)return;let a=Object.entries(d.SHIPS).filter(([r,o])=>!o.isRare&&o.saleLocationId===t&&!e.ownedShipIds.includes(r)),s=Object.entries(d.SHIPS).filter(([r,o])=>o.isRare&&o.saleLocationId===t&&!e.ownedShipIds.includes(r)),n=[...a.map(r=>r[0])];s.forEach(([r,o])=>{Math.random()<_.RARE_SHIP_CHANCE&&n.push(r)}),this.gameState.market.shipyardStock[t]={day:this.gameState.day,shipsForSale:n}})}};var K=class{constructor(e,t,i,a){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=a}start(){this.gameState.introSequenceActive&&(this.logger.info.state(this.gameState.day,"INTRO_START","Starting new game introduction sequence."),this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.gameState.player.introStep=0,this._showNextModal())}handleIntroClick(e){let t=e.target.closest("button");if(!t)return;let i=t.id;if(i==="intro-next-btn")t.disabled=!0,this._showNextModal();else if(i==="intro-submit-btn"){t.disabled=!0;let n=document.getElementById("signature-input").value.trim().replace(/[^a-zA-Z0-9 ]/g,"");!n||n.length===0?this.uiManager.queueModal("event-modal","Invalid Signature","The Merchant's Guild requires a valid name on the contract. Please provide your legal mark.",()=>{this.gameState.player.introStep--,this._showNextModal()}):(this.gameState.player.name=n,this.gameState.player.debt=25e3,this.gameState.player.loanStartDate=this.gameState.day,this.gameState.player.monthlyInterestAmount=390,this.logger.info.state(this.gameState.day,"LOAN_ACCEPTED",`Player ${n} accepted Guild loan.`,{debt:25e3,name:n}),this._startProcessingSequence())}}continueAfterTutorial(e){e==="intro_hangar"?(this.simulationService.setScreen(M.DATA,y.FINANCE),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_FINANCE"})):e==="intro_finance"&&this._end()}_showNextModal(){let e=d.INTRO_SEQUENCE_V1.modals[this.gameState.player.introStep];if(!e){this._end();return}let t={buttonClass:e.buttonClass,contentClass:e.contentClass};this.gameState.player.introStep===0&&(t.specialClass="intro-fade-in");let i="event-modal";e.id==="charter"||e.id==="signature"?(i=`${e.id}-modal`,t.customSetup=(a,s)=>{this._setupInteractiveModal(a,e,s)}):t.customSetup=(a,s)=>{let n=a.querySelector("#event-button-container");if(!n)return;n.innerHTML="";let r=document.createElement("button");r.className="btn px-6 py-2",e.buttonClass&&r.classList.add(e.buttonClass),r.id="intro-next-btn",r.innerHTML=e.buttonText,r.onclick=o=>{o.target.disabled=!0,s()},n.appendChild(r)},this.uiManager.queueModal(i,e.title,e.description,()=>this.gameState.player.introStep++,t)}_setupInteractiveModal(e,t,i){let a=e.querySelector(`#${t.id}-button-container`);a.innerHTML="";let s=document.createElement("button");if(s.className="btn px-6 py-2",s.innerHTML=t.buttonText,s.onclick=n=>{n.target.disabled=!0,i()},a.appendChild(s),t.id==="signature"){let n=e.querySelector("#signature-input");n.value="",s.id="intro-submit-btn",s.disabled=!0,s.onclick=i,n.oninput=()=>{s.disabled=n.value.trim()===""}}else s.id="intro-next-btn"}_startProcessingSequence(){let e=()=>{let t="Loan Approved",i=`Dear ${this.gameState.player.name},<br><br>Your line of credit has been <b>approved</b>.<br><br><span class="credits-text-pulsing">\u232C 25,000</span> is ready to transfer to your account.`,a=s=>{let n=s.target;n&&(n.disabled=!0),this.uiManager.createFloatingText(`+${S(25e3,!1)}`,s.clientX,s.clientY,"#34d399"),this.gameState.player.credits+=25e3,this.logger.info.player(this.gameState.day,"CREDITS_TRANSFER","Accepted loan transfer of \u232C25,000"),setTimeout(()=>{this.uiManager.showGameContainer(),this.uiManager.render(this.gameState.getState()),this.simulationService.setScreen(M.STARPORT,y.HANGAR),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_HANGAR"})},2e3)};this.uiManager.queueModal("event-modal",t,i,null,{contentClass:"text-center",customSetup:(s,n)=>{s.querySelector(".modal-content").classList.add("modal-theme-admin");let r=s.querySelector("#event-button-container");r.innerHTML="";let o=document.createElement("button");o.className="btn px-6 py-2",o.innerHTML="Accept Transfer",o.onclick=c=>{a(c),n()},r.appendChild(o)}})};this.uiManager.showProcessingAnimation(this.gameState.player.name,e)}_end(){this.gameState.introSequenceActive=!1,this.logger.info.state(this.gameState.day,"INTRO_END","Introduction sequence complete.");let e=d.INTRO_SEQUENCE_V1.modals.find(a=>a.id==="final"),t=d.SHIPS[this.gameState.player.activeShipId].name,i=e.buttonText.replace("{shipName}",t);this.gameState.tutorials.navLock={navId:M.DATA,screenId:y.FINANCE},this.uiManager.queueModal("event-modal",e.title,e.description,()=>{this.simulationService.setScreen(M.DATA,y.MISSIONS),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_MISSIONS"})},{buttonText:i}),this.uiManager.render(this.gameState.getState())}};var W=class{constructor(e,t,i,a,s,n,r){this.gameState=e,this.uiManager=t,this.missionService=i,this.marketService=a,this.timeService=s,this.logger=n,this.simulationService=r}buyItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return!1;let a=d.COMMODITIES.find(m=>m.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),!1;let n=this.uiManager.getItemPrice(i,e)*t,r=i.market.inventory[i.currentLocationId][e].quantity;if(r<=0)return this.uiManager.queueModal("event-modal","Sold Out",`This station has no more ${a.name} available.`),!1;if(t>r)return this.uiManager.queueModal("event-modal","Limited Stock",`This station only has ${r} units available.`),!1;let o=this.simulationService._getActiveShip(),c=this.simulationService._getActiveInventory();if(N(c)+t>o.cargoCapacity)return this.uiManager.queueModal("event-modal","Cargo Hold Full","You don't have enough space."),!1;if(i.player.credits<n)return this.uiManager.queueModal("event-modal","Insufficient Funds","Your credit balance is too low."),!1;let u=this.gameState.market.inventory[i.currentLocationId][e];u.quantity-=t;let h=c[e];return h.avgCost=(h.quantity*h.avgCost+n)/(h.quantity+t),h.quantity+=t,this.gameState.player.credits-=n,this.logger.info.player(i.day,"BUY",`Bought ${t}x ${a.name} for ${S(n)}`),this.simulationService._logConsolidatedTrade(a.name,t,-n),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"buy"),this.gameState.setState({}),!0}sellItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return 0;let a=d.COMMODITIES.find(h=>h.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),0;let n=this.simulationService._getActiveInventory()[e];if(!n||n.quantity<t)return this.uiManager.queueModal("event-modal","Insufficient Inventory",`You do not have ${t} units of ${a.name} to sell.`),0;let{totalPrice:r}=this.uiManager._calculateSaleDetails(e,t),o=r,c=o-n.avgCost*t;if(c>0){let h=(i.player.activePerks[E.TRADEMASTER]?d.PERKS[E.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);o+=c*h}o=Math.floor(o),this.gameState.player.credits+=o,n.quantity-=t,n.quantity===0&&(n.avgCost=0);let u=this.gameState.market.inventory[i.currentLocationId][e];return u.quantity+=t,this.logger.info.player(i.day,"SELL",`Sold ${t}x ${a.name} for ${S(o)}`),this.simulationService._logConsolidatedTrade(a.name,t,o),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"sell"),this.gameState.setState({}),o}buyShip(e,t){let i=d.SHIPS[e];return i?this.gameState.player.credits<i.price?(this.uiManager.queueModal("event-modal","Insufficient Funds","You cannot afford this ship."),null):(this.gameState.player.credits-=i.price,this.logger.info.player(this.gameState.day,"SHIP_PURCHASE",`Purchased ${i.name} for ${S(i.price)}.`),t&&this.uiManager.createFloatingText(`-${S(i.price,!1)}`,t.clientX,t.clientY,"#f87171"),this.simulationService._logTransaction("ship",-i.price,`Purchased ${i.name}`),this.simulationService.addShipToHangar(e),["S","O"].includes(i.class)?this.uiManager.triggerEffect("systemSurge",{theme:"red",text:"TOP CLASS"}):this.uiManager.triggerEffect("systemSurge",{theme:"silver",text:"VESSEL ACQUIRED"}),this.gameState.tutorials.activeBatchId==="intro_hangar"&&(this.simulationService.setHangarShipyardMode("hangar"),this.simulationService.tutorialService.checkState({type:"ACTION",action:f.BUY_SHIP})),this.gameState.setState({uiState:{...this.gameState.uiState,lastTransactionTimestamp:Date.now()}}),i):(this.logger.error("PlayerActionService",`buyShip called with invalid shipId: ${e}`),null)}sellShip(e,t){let i=this.gameState.getState();if(i.player.ownedShipIds.length<=1)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your last remaining ship."),!1;if(e===i.player.activeShipId)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your active ship."),!1;if(N(i.player.inventories[e])>0)return this.uiManager.queueModal("event-modal","Cannot Sell Ship","This vessel's cargo hold is not empty."),!1;let a=d.SHIPS[e];if(!a)return this.logger.error("PlayerActionService",`sellShip called with invalid shipId: ${e}`),!1;let s=Math.floor(a.price*_.SHIP_SELL_MODIFIER);this.gameState.player.credits+=s,this.logger.info.player(this.gameState.day,"SHIP_SALE",`Sold ${a.name} for ${S(s)}.`),t&&this.uiManager.createFloatingText(`+${S(s,!1)}`,t.clientX,t.clientY,"#34d399"),this.simulationService._logTransaction("ship",s,`Sold ${a.name}`);let n=this.gameState.player.ownedShipIds.indexOf(e);this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(o=>o!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e];let r=this.gameState.uiState.hangarActiveIndex;return n<r&&r--,r>=this.gameState.player.ownedShipIds.length&&(r=Math.max(0,this.gameState.player.ownedShipIds.length-1)),this.uiManager.queueModal("event-modal","Vessel Sold",`You sold the ${a.name} for ${S(s)}.`),this.gameState.setState({uiState:{...this.gameState.uiState,hangarActiveIndex:r,lastTransactionTimestamp:Date.now()}}),s}setActiveShip(e){if(!this.gameState.player.ownedShipIds.includes(e))return;this.gameState.player.activeShipId=e;let t=this.gameState.player.ownedShipIds.indexOf(e);t!==-1&&(this.gameState.uiState.hangarActiveIndex=t),this.logger.info.player(this.gameState.day,"SET_ACTIVE_SHIP",`Boarded the ${d.SHIPS[e].name}.`),this.gameState.introSequenceActive&&this.simulationService.tutorialService.checkState({type:"ACTION",action:f.SELECT_SHIP}),this.gameState.setState({})}payOffDebt(){if(this.gameState.isGameOver)return;let{player:e}=this.gameState;if(e.credits<e.debt){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford to pay off your entire debt.");return}let t=e.debt;e.credits-=t,this.logger.info.player(this.gameState.day,"DEBT_PAID",`Paid off ${S(t)} in debt.`),this.simulationService._logTransaction("loan",-t,`Paid off ${S(t)} debt`),e.debt=0,e.monthlyInterestAmount=0,e.loanStartDate=null,this.uiManager.triggerEffect("systemSurge",{theme:"tan",text:"DEBT CLEARED"}),this.timeService._checkMilestones(),this.gameState.setState({})}takeLoan(e){let{player:t,day:i}=this.gameState;if(t.debt>0){this.uiManager.queueModal("event-modal","Loan Unavailable","You must pay off your existing debt first.");return}if(t.credits<e.fee){this.uiManager.queueModal("event-modal","Unable to Secure Loan",`The financing fee is ${S(e.fee)}, but you only have ${S(t.credits)}.`);return}t.credits-=e.fee,this.simulationService._logTransaction("loan",-e.fee,`Financing fee for ${S(e.amount)} loan`),t.credits+=e.amount,this.simulationService._logTransaction("loan",e.amount,`Acquired ${S(e.amount)} loan`),t.debt+=e.amount,t.monthlyInterestAmount=e.interest,t.loanStartDate=i,t.seenGarnishmentWarning=!1;let a=`You've acquired a loan of <span class="hl-blue">${S(e.amount)}</span>.<br>A financing fee of <span class="hl-red">${S(e.fee)}</span> was deducted.`;this.uiManager.queueModal("event-modal","Loan Acquired",a),this.logger.info.player(i,"LOAN_TAKEN",`Took a loan for ${S(e.amount)}.`),this.gameState.setState({})}purchaseLicense(e){let t=d.LICENSES[e],{player:i,day:a}=this.gameState;return t?t.type!=="purchase"?{success:!1,error:"NOT_FOR_PURCHASE"}:i.unlockedLicenseIds.includes(e)?{success:!1,error:"ALREADY_OWNED"}:i.credits<t.cost?{success:!1,error:"INSUFFICIENT_FUNDS"}:(i.credits-=t.cost,i.unlockedLicenseIds.push(e),this.logger.info.player(a,"LICENSE_PURCHASE",`Purchased ${t.name}.`),this.simulationService._logTransaction("license",-t.cost,`Purchased ${t.name}`),this.uiManager.triggerEffect("systemSurge",{theme:"tan"}),this.gameState.setState({}),{success:!0}):{success:!1,error:"INVALID_LICENSE"}}purchaseIntel(e){let{player:t,currentLocationId:i,day:a}=this.gameState;if(t.credits<e){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford this intel.");return}t.credits-=e,this.logger.info.player(a,"INTEL_PURCHASE",`Purchased intel for ${S(e)}.`),this.simulationService._logTransaction("intel",-e,"Purchased market intel"),this.gameState.intel.available[i]=!1;let s=d.MARKETS.filter(c=>c.id!==i&&t.unlockedLocationIds.includes(c.id));if(s.length===0)return;let n=s[Math.floor(Math.random()*s.length)],r=d.COMMODITIES.filter(c=>c.tier<=t.revealedTier),o=r[Math.floor(Math.random()*r.length)];o&&(this.gameState.intel.active={targetMarketId:n.id,commodityId:o.id,type:"demand",startDay:a,endDay:a+100}),this.gameState.setState({})}refuelTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(t.fuel>=t.maxFuel)return 0;let i=d.MARKETS.find(a=>a.id===e.currentLocationId).fuelPrice/2;return e.player.activePerks[E.VENETIAN_SYNDICATE]&&e.currentLocationId===g.VENUS&&(i*=1-d.PERKS[E.VENETIAN_SYNDICATE].fuelDiscount),e.player.credits<i?0:(e.player.credits-=i,e.player.shipStates[t.id].fuel=Math.min(t.maxFuel,e.player.shipStates[t.id].fuel+5),this.simulationService._logConsolidatedTransaction("fuel",-i,"Fuel Purchase"),this.gameState.setState({}),i)}repairTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(t.health>=t.maxHealth)return 0;let i=t.maxHealth*(_.REPAIR_AMOUNT_PER_TICK/100)*_.REPAIR_COST_PER_HP;return e.player.activePerks[E.VENETIAN_SYNDICATE]&&e.currentLocationId===g.VENUS&&(i*=1-d.PERKS[E.VENETIAN_SYNDICATE].repairDiscount),e.player.credits<i?0:(e.player.credits-=i,e.player.shipStates[t.id].health=Math.min(t.maxHealth,e.player.shipStates[t.id].health+t.maxHealth*(_.REPAIR_AMOUNT_PER_TICK/100)),this.simulationService._logConsolidatedTransaction("repair",-i,"Hull Repairs"),this.simulationService._checkHullWarnings(t.id),this.gameState.setState({}),i)}};var X=class{constructor(e,t,i,a){this.gameState=e,this.marketService=t,this.uiManager=i,this.logger=a,this.simulationService=null}advanceDays(e){this.logger.group(`[System] Advancing time by ${e} day(s) from Day ${this.gameState.day}`);for(let t=0;t<e;t++){if(this.gameState.isGameOver){this.logger.warn("TimeService","Advance days aborted: Game is over."),this.logger.groupEnd();return}this.gameState.day++;let i=(this.gameState.day-1)%365,a=d.DATE_CONFIG.START_YEAR+Math.floor((this.gameState.day-1)/365);if(i===11&&a>this.gameState.player.lastBirthdayYear&&(this.gameState.player.playerAge++,this.gameState.player.birthdayProfitBonus+=.01,this.gameState.player.lastBirthdayYear=a,this.uiManager.triggerEffect("systemSurge",{theme:"blue",text:`Happy Birthday, ${this.gameState.player.name}`,subtext:`Age: ${this.gameState.player.playerAge}`}),this.logger.info.state(this.gameState.day,"BIRTHDAY",`Player is now age ${this.gameState.player.playerAge}. Profit bonus increased.`)),this._checkAgeEvents(),this.marketService.evolveMarketPrices(),this.gameState.day-this.gameState.lastMarketUpdateDay>=7&&(this.marketService.checkForSystemStateChange(),this.marketService.replenishMarketInventory(),this.marketService._updateShipyardStock(),this.gameState.lastMarketUpdateDay=this.gameState.day),this.gameState.intel.active&&this.gameState.day>this.gameState.intel.active.endDay&&(this.logger.info.system("Intel",this.gameState.day,"EXPIRED","Active intel has expired."),this.gameState.intel.active=null),this.gameState.player.ownedShipIds.forEach(s=>{if(s!==this.gameState.player.activeShipId){let n=d.SHIPS[s],r=n.maxHealth*_.PASSIVE_REPAIR_RATE;this.gameState.player.shipStates[s].health=Math.min(n.maxHealth,this.gameState.player.shipStates[s].health+r)}}),this.gameState.player.debt>0&&this.gameState.day-this.gameState.lastInterestChargeDay>=_.INTEREST_INTERVAL){let s=this.gameState.player.monthlyInterestAmount;this.gameState.player.debt+=s,this.simulationService._logTransaction("loan",s,"Monthly interest charge"),this.logger.info.system("Finance",this.gameState.day,"INTEREST",`Charged ${S(s)} interest on debt.`),this.gameState.lastInterestChargeDay=this.gameState.day}}this.logger.groupEnd(),this.gameState.setState({})}_checkAgeEvents(){d.AGE_EVENTS.forEach(e=>{this.gameState.player.seenEvents.includes(e.id)||(e.trigger.day&&this.gameState.day>=e.trigger.day||e.trigger.credits&&this.gameState.player.credits>=e.trigger.credits)&&(this.gameState.player.seenEvents.push(e.id),this.logger.info.state(this.gameState.day,"AGE_EVENT",`Triggered age event: ${e.title}`),this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t)))})}_checkMilestones(){let{credits:e,revealedTier:t}=this.gameState.player,i=t,a=ge.find(s=>s.revealsTier===i+1);for(;a&&e>=a.threshold;)this.gameState.player.revealedTier=a.revealsTier,this.logger.info.state(this.gameState.day,"MILESTONE",`Unlocked Tier ${a.revealsTier} commodities.`),this.uiManager.triggerEffect("systemSurge",{theme:"purple",text:`TIER ${a.revealsTier} UNLOCKED`}),i=a.revealsTier,a=ge.find(s=>s.revealsTier===i+1);this.gameState.player.revealedTier!==t&&this.gameState.setState({})}_applyGarnishment(){let{player:e,day:t}=this.gameState;if(e.debt>0&&e.loanStartDate&&t-e.loanStartDate>=_.LOAN_GARNISHMENT_DAYS){let i=Math.floor(e.credits*_.LOAN_GARNISHMENT_PERCENT);i>0&&(e.credits-=i,this.simulationService._logTransaction("debt",-i,"Monthly credit garnishment")),e.seenGarnishmentWarning||(this.uiManager.queueModal("event-modal","Credit Garnishment Notice","Your loan is delinquent. Your lender is now garnishing 14% of your credits monthly until the debt is paid.",null,{buttonClass:"bg-red-800/80"}),e.seenGarnishmentWarning=!0,this.logger.warn("Finance",`Loan delinquent. Garnishment of ${_.LOAN_GARNISHMENT_PERCENT*100}% initiated.`))}}};function Me(l,e,t,i){let a=e._getActiveShip(),s=Math.floor(l.player.credits*t.wagerPercentage),n=t.winChance[a.class]||.4;Math.random()<n?(l.player.credits+=s,e._logTransaction("event",s,"Won space race wager"),i.description=`Your Class ${a.class} ship wins! You gain <span class="hl-green">${S(s)}</span>.`):(l.player.credits-=s,e._logTransaction("event",-s,"Lost space race wager"),i.description=`The luxury ship was too fast. You lose <span class="hl-red">${S(s)}</span>.`)}function _e(l,e,t){let i=e._getActiveShip(),a=l.player.shipStates[i.id],s=e._getActiveInventory();if(a.fuel=Math.max(0,a.fuel-30),s[b.CYBERNETICS]||(s[b.CYBERNETICS]={quantity:0,avgCost:0}),N(s)+40<=i.cargoCapacity)return s[b.CYBERNETICS].quantity+=40,{key:"reward_cybernetics"};if(l.player.debt>0){let n=Math.floor(l.player.debt*.2);return l.player.debt-=n,e._logTransaction("event",n,"Passenger paid off debt"),{key:"reward_debt_paid",amount:S(n)}}else{let n=Math.floor(l.player.credits*.05);return l.player.credits+=n,e._logTransaction("event",n,"Passenger payment"),{key:"reward_credits",amount:S(n)}}}var je={SPACE_RACE:Me,ADRIFT_PASSENGER:_e,credits:(l,e,t)=>{l.player.credits+=t.value,e._logTransaction("event",t.value,"Received credits from event")},fuel:(l,e,t)=>{let i=e._getActiveShip(),a=l.player.shipStates[i.id];a.fuel=Math.max(0,a.fuel+t.value)},hull_damage_percent:(l,e,t)=>{let i=Array.isArray(t.value)?Math.random()*(t.value[1]-t.value[0])+t.value[0]:t.value;l.pendingTravel.eventHullDamagePercent=(l.pendingTravel.eventHullDamagePercent||0)+i},travel_time_add:(l,e,t)=>{l.pendingTravel.travelTimeAdd=(l.pendingTravel.travelTimeAdd||0)+t.value},travel_time_add_percent:(l,e,t)=>{l.pendingTravel.travelTimeAddPercent=(l.pendingTravel.travelTimeAddPercent||0)+t.value},set_travel_time:(l,e,t)=>{l.pendingTravel.setTravelTime=t.value},add_debt:(l,e,t)=>{l.player.debt<=0&&(l.player.loanStartDate=l.day,l.player.weeklyInterestAmount=0);let i=Math.ceil(t.value*.013);l.player.weeklyInterestAmount+=i,l.player.debt+=t.value,e._logTransaction("loan",t.value,"Incurred debt from event")},add_cargo:(l,e,t,i)=>{let a=e._getActiveShip(),s=e._getActiveInventory(),n=d.COMMODITIES.find(r=>r.id===t.value.id);N(s)+t.value.quantity<=a.cargoCapacity?s[t.value.id].quantity+=t.value.quantity:i.description=`You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${n.name}</span> behind.`},lose_cargo:(l,e,t)=>{let i=e._getActiveInventory();i[t.value.id].quantity=Math.max(0,i[t.value.id].quantity-t.value.quantity)},lose_random_cargo_percent:(l,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,n]=a[Math.floor(Math.random()*a.length)],r=Math.ceil(n.quantity*t.value);n.quantity=Math.max(0,n.quantity-r)}},sell_random_cargo_premium:(l,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,n]=a[Math.floor(Math.random()*a.length)],r=l.market.galacticAverages[s]*t.value*n.quantity;l.player.credits+=r,e._logTransaction("trade",r,"Emergency supply drop sale"),n.quantity=0}},set_new_random_destination:(l,e,t)=>{let i=d.MARKETS.filter(a=>a.id!==l.currentLocationId&&l.player.unlockedLocationIds.includes(a.id));i.length>0&&(l.pendingTravel.destinationId=i[Math.floor(Math.random()*i.length)].id)}};function xe(l,e,t,i){let a=je[t.type];if(a)return a(l,e,t,i);console.warn(`No handler found for event effect type: ${t.type}`)}var Q=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.timeService=i,this.logger=a,this.simulationService=s}travelTo(e){this.uiManager.resetMarketTransactionState();let{tutorials:t}=this.gameState,{navLock:i}=t;if(i&&i.screenId===y.NAVIGATION&&i.enabledElementQuery&&!i.enabledElementQuery.includes(`[data-location-id='${e}']`))return;let a=this.gameState.getState();if(a.isGameOver||a.pendingTravel)return;if(a.currentLocationId===e){this.simulationService.setScreen(M.STARPORT,y.MARKET);return}let s=this.simulationService._getActiveShip();if(!s){this.uiManager.queueModal("event-modal","No Active Ship","You must have an active vessel to travel.");return}let r=a.TRAVEL_DATA[a.currentLocationId][e].fuelCost;if(a.player.activePerks[E.NAVIGATOR]&&(r=Math.round(r*d.PERKS[E.NAVIGATOR].fuelMod)),s.maxFuel<r){this.uiManager.queueModal("event-modal","Fuel Capacity Insufficient",`Your ship's fuel tank is too small. This trip requires ${r} fuel, but you can only hold ${s.maxFuel}.`);return}if(s.fuel<r){this.uiManager.queueModal("event-modal","Insufficient Fuel",`You need ${r} fuel but only have ${Math.floor(s.fuel)}.`);return}!(a.tutorials.activeBatchId==="intro_missions"&&a.tutorials.activeStepId==="mission_1_6")&&this._checkForRandomEvent(e)||this.initiateTravel(e)}initiateTravel(e,t={}){let i=this.gameState.getState(),a=i.currentLocationId,s={...i.TRAVEL_DATA[a][e]};this.logger.info.player(i.day,"TRAVEL_START",`Departing from ${a} to ${e}.`),i.player.activePerks[E.NAVIGATOR]&&(s.time=Math.round(s.time*d.PERKS[E.NAVIGATOR].travelTimeMod),s.fuelCost=Math.round(s.fuelCost*d.PERKS[E.NAVIGATOR].fuelMod)),t.travelTimeAdd&&(s.time+=t.travelTimeAdd),t.travelTimeAddPercent&&(s.time*=1+t.travelTimeAddPercent),t.setTravelTime&&(s.time=t.setTravelTime),s.time=Math.max(1,Math.round(s.time));let n=this.simulationService._getActiveShip(),r=this.gameState.player.shipStates[n.id];if(n.fuel<s.fuelCost){this.uiManager.queueModal("event-modal","Insufficient Fuel",`Trip modifications left you without enough fuel. You need ${s.fuelCost} but only have ${Math.floor(n.fuel)}.`),this.logger.warn("TravelService",`Travel to ${e} aborted due to insufficient fuel after event mods.`);return}if(t.forceEvent&&this._checkForRandomEvent(e,!0))return;let o=s.time*_.HULL_DECAY_PER_TRAVEL_DAY;i.player.activePerks[E.NAVIGATOR]&&(o*=d.PERKS[E.NAVIGATOR].hullDecayMod);let c=n.maxHealth*((t.eventHullDamagePercent||0)/100),u=o+c;if(r.health-=u,this.simulationService._checkHullWarnings(n.id),r.health<=0){this._handleShipDestruction(n.id);return}if(r.fuel-=s.fuelCost,this.timeService.advanceDays(s.time),this.gameState.isGameOver)return;this.gameState.setState({currentLocationId:e,pendingTravel:null});let h=d.MARKETS.find(T=>T.id===a),m=d.MARKETS.find(T=>T.id===e);if(!h||!m){this.logger.error("TravelService",`Invalid location ID provided for travel animation. From: ${a}, To: ${e}`),this.uiManager.queueModal("event-modal","Navigation Error","Could not plot a course. The destination is unknown.");return}let p=u/n.maxHealth*100;this.logger.info.player(this.gameState.day,"TRAVEL_END",`Arrived at ${e}.`,{fuelUsed:s.fuelCost,hullDamage:p.toFixed(2)+"%"});let v=()=>{this.gameState.tutorials.activeBatchId==="intro_missions"&&this.gameState.tutorials.activeStepId==="mission_1_7"&&e===g.LUNA?this.simulationService.setScreen(M.DATA,y.MISSIONS):this.simulationService.setScreen(M.STARPORT,y.MARKET)};this.uiManager.showTravelAnimation(h,m,s,p,v)}resumeTravel(){if(!this.gameState.pendingTravel)return;this.logger.info.system("Game",this.gameState.day,"TRAVEL_RESUME","Resuming travel after event.");let{destinationId:e,...t}=this.gameState.pendingTravel;this.initiateTravel(e,t)}_checkForRandomEvent(e,t=!1){if(t===!1&&Math.random()>_.RANDOM_EVENT_CHANCE)return!1;let i=this.simulationService._getActiveShip(),a;if(typeof t=="number")a=d.RANDOM_EVENTS[t];else{let s=d.RANDOM_EVENTS.filter(n=>n.precondition(this.gameState.getState(),i,this.simulationService._getActiveInventory.bind(this.simulationService)));if(s.length===0)return!1;a=s[Math.floor(Math.random()*s.length)]}return a?(this.logger.info.system("Event",this.gameState.day,"EVENT_TRIGGER",`Triggered random event: ${a.title}`),this.gameState.setState({pendingTravel:{destinationId:e}}),this.uiManager.showRandomEventModal(a,(s,n)=>this._resolveEventChoice(s,n)),!0):(this.logger.warn("TravelService",`Debug event trigger failed for index: ${t}`),!1)}_resolveEventChoice(e,t){let i=d.RANDOM_EVENTS.find(c=>c.id===e),a=i.choices[t],s=Math.random(),n=a.outcomes.find(c=>(s-=c.chance)<0)||a.outcomes[a.outcomes.length-1],r=this._applyEventEffects(n),o=n.description;r&&n.descriptions&&(o=n.descriptions[r.key],r.amount&&(o=o.replace("{amount}",r.amount))),this.logger.info.player(this.gameState.day,"EVENT_CHOICE",`Chose '${a.title}' for event '${i.title}'.`),this.uiManager.queueModal("event-modal",i.title,o,()=>this.resumeTravel(),{buttonText:"Continue Journey"})}_applyEventEffects(e){let t=null;return e.effects.forEach(i=>{let a=xe(this.gameState,this.simulationService,i,e);a&&(t=a)}),this.gameState.setState({}),t}_handleShipDestruction(e){let t=d.SHIPS[e].name;if(this.logger.error("TravelService",`Ship ${t} was destroyed.`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(i=>i!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.gameState.player.ownedShipIds.length===0)this.simulationService._gameOver(`Your last ship, the ${t}, was destroyed. Your trading career ends here.`);else{this.gameState.player.activeShipId=this.gameState.player.ownedShipIds[0];let i=d.SHIPS[this.gameState.player.activeShipId].name,a=`The ${t} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${i}.`;this.uiManager.queueModal("event-modal","Vessel Lost",a)}this.gameState.setState({})}};var J=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.tutorialService=null,this.missionService=null,this.marketService=new z(e),this.timeService=new X(e,this.marketService,t,i),this.travelService=new Q(e,t,this.timeService,i,this),this.introService=new K(e,t,i,this),this.playerActionService=new W(e,t,null,this.marketService,this.timeService,i,this),this.timeService.simulationService=this}setTutorialService(e){this.tutorialService=e}setMissionService(e){this.missionService=e,this.playerActionService.missionService=e}startIntroSequence(){this.introService.start()}handleIntroClick(e){this.introService.handleIntroClick(e)}_continueIntroSequence(e){this.introService.continueAfterTutorial(e)}buyItem(e,t){return this.playerActionService.buyItem(e,t)}sellItem(e,t){return this.playerActionService.sellItem(e,t)}initiateShipTransactionAnimation(e,t,i){this.playerActionService.initiateShipTransactionAnimation(e,t,i)}buyShip(e,t){return this.playerActionService.buyShip(e,t)}sellShip(e,t){return this.playerActionService.sellShip(e,t)}setActiveShip(e){this.playerActionService.setActiveShip(e)}payOffDebt(){this.playerActionService.payOffDebt()}takeLoan(e){this.playerActionService.takeLoan(e)}purchaseLicense(e){return this.playerActionService.purchaseLicense(e)}purchaseIntel(e){this.playerActionService.purchaseIntel(e)}refuelTick(){return this.playerActionService.refuelTick()}repairTick(){return this.playerActionService.repairTick()}travelTo(e){this.travelService.travelTo(e)}resumeTravel(){this.travelService.resumeTravel()}setScreen(e,t){let i={...this.gameState.lastActiveScreen,[e]:t};this.gameState.setState({activeNav:e,activeScreen:t,lastActiveScreen:i}),this.tutorialService&&this.tutorialService.checkState({type:"SCREEN_LOAD",screenId:t})}setHangarShipyardMode(e){this.gameState.uiState.hangarShipyardToggleState!==e&&(this.gameState.uiState.hangarShipyardToggleState=e,this.gameState.setState({}))}setHangarCarouselIndex(e,t){t==="hangar"?this.gameState.uiState.hangarActiveIndex=e:this.gameState.uiState.shipyardActiveIndex=e,this.gameState.setState({})}cycleHangarCarousel(e){let{uiState:t,player:i}=this.gameState,a=t.hangarShipyardToggleState==="hangar",s=a?i.ownedShipIds:this._getShipyardInventory().map(([r])=>r);if(s.length<=1)return;let n=a?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;e==="next"?n=(n+1)%s.length:n=(n-1+s.length)%s.length,this.setHangarCarouselIndex(n,a?"hangar":"shipyard")}_gameOver(e){this.logger.info.state(this.gameState.day,"GAME_OVER",e),this.gameState.setState({isGameOver:!0}),this.uiManager.queueModal("event-modal","Game Over",e,()=>{localStorage.removeItem(Ee),window.location.reload()},{buttonText:"Restart"})}addShipToHangar(e){let t=d.SHIPS[e];t&&(this.gameState.player.ownedShipIds.push(e),this.gameState.player.shipStates[e]={health:t.maxHealth,fuel:t.maxFuel,hullAlerts:{one:!1,two:!1}},this.gameState.player.inventories[e]||(this.gameState.player.inventories[e]={},d.COMMODITIES.forEach(i=>{this.gameState.player.inventories[e][i.id]={quantity:0,avgCost:0}})))}_applyPerk(e){this.logger.info.player(this.gameState.day,"PERK_APPLIED",`Gained perk: ${e.title}`),e.perkId&&(this.gameState.player.activePerks[e.perkId]=!0),e.playerTitle&&(this.gameState.player.playerTitle=e.playerTitle),e.perkId===E.MERCHANT_GUILD_SHIP&&(this.addShipToHangar(A.STALWART),this.uiManager.queueModal("event-modal","Vessel Delivered",`The Merchant's Guild has delivered a new ${d.SHIPS[A.STALWART].name} to your hangar.`)),this.gameState.setState({})}_getActiveShip(){let e=this.gameState,t=e.player.activeShipId;return t?{id:t,...d.SHIPS[t],...e.player.shipStates[t]}:null}_getActiveInventory(){return this.gameState.player.activeShipId?this.gameState.player.inventories[this.gameState.player.activeShipId]:null}_checkHullWarnings(e){let t=this.gameState.player.shipStates[e],i=d.SHIPS[e],a=t.health/i.maxHealth*100;a<=15&&!t.hullAlerts.two?t.hullAlerts.two=!0:a<=30&&!t.hullAlerts.one&&(t.hullAlerts.one=!0),a>30&&(t.hullAlerts.one=!1),a>15&&(t.hullAlerts.two=!1)}_logTransaction(e,t,i){this.gameState.player.financeLog.push({day:this.gameState.day,type:e,amount:t,balance:this.gameState.player.credits,description:i})}_logConsolidatedTrade(e,t,i){let a=this.gameState.player.financeLog,s=i<0,n=s?"Bought":"Sold",r=a.find(o=>o.day===this.gameState.day&&o.type==="trade"&&o.description.startsWith(`${n}`)&&o.description.endsWith(` ${e}`)&&(s&&o.amount<0||!s&&o.amount>0));if(r){r.amount+=i,r.balance=this.gameState.player.credits;let o=r.description.match(/\s(\d+)x\s/);if(o){let c=parseInt(o[1],10);r.description=`${n} ${c+t}x ${e}`}}else this._logTransaction("trade",i,`${n} ${t}x ${e}`)}_logConsolidatedTransaction(e,t,i){let a=this.gameState.player.financeLog,s=a.length>0?a[a.length-1]:null;s&&s.day===this.gameState.day&&s.type===e?(s.amount+=t,s.balance=this.gameState.player.credits):this._logTransaction(e,t,i)}_getShipyardInventory(){let{tutorials:e,player:t,currentLocationId:i,market:a}=this.gameState;return e.activeBatchId==="intro_hangar"?t.ownedShipIds.length>0?[]:[A.WANDERER,A.STALWART,A.MULE].map(s=>[s,d.SHIPS[s]]):(a.shipyardStock[i]?.shipsForSale||[]).map(n=>[n,d.SHIPS[n]]).filter(([n])=>!t.ownedShipIds.includes(n))}_grantRewards(e,t){e.forEach(i=>{if(i.type==="credits"&&(this.gameState.player.credits+=i.amount,this._logTransaction("mission",i.amount,`Reward: ${t}`),this.uiManager.createFloatingText(`+${S(i.amount,!1)}`,window.innerWidth/2,window.innerHeight/2,"#34d399")),i.type==="license"&&!this.gameState.player.unlockedLicenseIds.includes(i.licenseId)){this.gameState.player.unlockedLicenseIds.push(i.licenseId);let a=d.LICENSES[i.licenseId];this.uiManager.triggerEffect("systemSurge",{theme:"tan"}),this.logger.info.player(this.gameState.day,"LICENSE_GRANTED",`Received ${a.name}.`)}})}grantMissionCargo(e){let t=d.MISSIONS[e];if(!t||!t.providedCargo)return;let i=this._getActiveInventory();if(!i){this.logger.error("SimulationService","Cannot grant mission cargo: No active inventory found.");return}t.providedCargo.forEach(a=>{i[a.goodId]||(i[a.goodId]={quantity:0,avgCost:0}),i[a.goodId].quantity+=a.quantity,this.logger.info.player(this.gameState.day,"CARGO_GRANT",`Received ${a.quantity}x ${d.COMMODITIES.find(s=>s.id===a.goodId).name} from ${t.name}.`)}),this.missionService&&this.missionService.checkTriggers()}};var Z=class{constructor(){this.effectQueue=[],this.isEffectActive=!1,this.effectsRegistry={}}registerEffect(e,t){this.effectsRegistry[e]=t}trigger(e,t){this.effectQueue.push({effectName:e,options:t}),this._processQueue()}async _processQueue(){if(this.isEffectActive||this.effectQueue.length===0)return;this.isEffectActive=!0;let e=this.effectQueue.shift(),t=this.effectsRegistry[e.effectName];if(!t){console.warn(`EffectManager: Attempted to trigger unregistered effect '${e.effectName}'.`),this.isEffectActive=!1,this._processQueue();return}try{await new t(e.options).play()}catch(i){console.error(`Error playing effect '${e.effectName}':`,i)}finally{this.isEffectActive=!1,this._processQueue()}}};var ee=class{constructor(e){this.options=e}async play(){throw new Error("Effects must implement the 'play' method.")}_createDOM(){}_injectCSS(){}_cleanup(){}};var te=class l extends ee{constructor(e={}){super(e);let t=e.theme||"blue",i=l.PROFILES[t]||l.PROFILES.blue;this.options={...i,...e,theme:t},this.domElements={},this.particles=[],this.animationFrameId=null,this._animationLoop=this._animationLoop.bind(this),this.themes={gold:{color:"rgba(255, 223, 0, 0.8)",glow:"#ffd700"},green:{color:"rgba(50, 255, 150, 0.8)",glow:"#32ff96"},red:{color:"rgba(255, 50, 50, 0.8)",glow:"#ff3232"},blue:{color:"rgba(50, 150, 255, 0.8)",glow:"#3296ff"},orange:{color:"rgba(255, 165, 0, 0.8)",glow:"#ffa500"},purple:{color:"rgba(220, 50, 255, 0.8)",glow:"#dc32ff"},silver:{color:"rgba(192, 192, 192, 0.9)",glow:"#c0c0c0"},tan:{color:"rgba(210, 180, 140, 0.9)",glow:"#d2b48c"}}}async play(){return new Promise(e=>{this._createDOM(),this.animationFrameId=requestAnimationFrame(this._animationLoop);let{fadeInTime:t,lingerTime:i,fadeOutTime:a}=this.options,s=t+i+a;setTimeout(()=>document.body.classList.add("system-surge-active"),50),setTimeout(()=>document.body.classList.add("system-surge-fading"),t+i),setTimeout(()=>{this._cleanup(),e()},s)})}_createDOM(){let e=this.themes[this.options.theme]||this.themes.blue,t=document.createElement("div");t.id="celebration-overlay",t.style.setProperty("--surge-color",e.color),t.style.setProperty("--surge-glow",e.glow),this.domElements.overlay=t;let i=document.createElement("div");i.className="surge-light",this.domElements.surgeLight=i;let a=document.createElement("div");a.className="surge-text";let s=document.createElement("div");if(s.textContent=this.options.text,s.style.fontSize=this.options.textSize,a.appendChild(s),this.options.subtext){let r=document.createElement("div");r.textContent=this.options.subtext,r.style.fontSize=this.options.subtextSize||"6vw",r.style.opacity="0.8",r.style.marginTop="1rem",a.appendChild(r)}this.domElements.surgeText=a;let n=document.createElement("canvas");n.id="particle-canvas",this.domElements.canvas=n,this.ctx=n.getContext("2d"),t.appendChild(i),t.appendChild(n),t.appendChild(a),document.body.appendChild(t),this._resizeCanvas(),this._initializeParticles(),window.addEventListener("resize",this._resizeCanvas.bind(this))}_resizeCanvas(){let e=this.domElements.canvas;e&&(e.width=e.clientWidth,e.height=e.clientHeight)}_initializeParticles(){let e=this.domElements.canvas;if(e){this.particles=[];for(let t=0;t<this.options.particleCount;t++)this.particles.push({x:Math.random()*e.width,y:Math.random()*e.height,size:Math.random()*(this.options.particleSize.max-this.options.particleSize.min)+this.options.particleSize.min,speed:Math.random()*(this.options.particleSpeed.max-this.options.particleSpeed.min)+this.options.particleSpeed.min,alpha:.5+Math.random()*.5})}}_animationLoop(){if(!this.ctx)return;let e=this.domElements.canvas;this.ctx.clearRect(0,0,e.width,e.height);let t=this.themes[this.options.theme]||this.themes.blue;this.ctx.fillStyle=t.color,this.particles.forEach(i=>{i.y-=i.speed,i.y<-i.size&&(i.y=e.height+i.size,i.x=Math.random()*e.width),this.ctx.globalAlpha=i.alpha,this.ctx.beginPath(),this.options.particleShape==="circle"?this.ctx.arc(i.x,i.y,i.size/2,0,Math.PI*2):this.options.particleShape==="sliver"?this.ctx.rect(i.x,i.y,2,i.size):this.ctx.rect(i.x-2,i.y,4,i.size),this.ctx.fill()}),this.animationFrameId=requestAnimationFrame(this._animationLoop)}_cleanup(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),window.removeEventListener("resize",this._resizeCanvas.bind(this)),document.body.classList.remove("system-surge-active","system-surge-fading"),Object.values(this.domElements).forEach(e=>e&&e.remove())}static PROFILES={tan:{text:"TRADING LICENSE ACQUIRED",textSize:"7vw",particleCount:20,particleShape:"sliver",particleSize:{min:2,max:20},particleSpeed:{min:1,max:7},fadeInTime:1900,lingerTime:3950,fadeOutTime:3750},silver:{text:"SHIP PURCHASED",textSize:"7vw",particleCount:20,particleShape:"sliver",particleSize:{min:1,max:20},particleSpeed:{min:1,max:5},fadeInTime:500,lingerTime:3900,fadeOutTime:3500},purple:{text:"WEALTH MILESTONE ACHIEVED",textSize:"7vw",particleCount:18,particleShape:"rectangle",particleSize:{min:1,max:9},particleSpeed:{min:1.5,max:4},fadeInTime:500,lingerTime:4250,fadeOutTime:3500},orange:{text:"ORANGE",textSize:"7vw",particleCount:40,particleShape:"sliver",particleSize:{min:1,max:6},particleSpeed:{min:2.5,max:8.5},fadeInTime:1750,lingerTime:3250,fadeOutTime:3500},blue:{text:"HAPPY BIRTHDAY",subtext:"Age: XX",textSize:"7vw",subtextSize:"6vw",particleCount:30,particleShape:"circle",particleSize:{min:5,max:20},particleSpeed:{min:4,max:7.5},fadeInTime:1750,lingerTime:4300,fadeOutTime:5e3},red:{text:"SUPERIOR SHIP ACQUIRED",textSize:"7vw",particleCount:30,particleShape:"rectangle",particleSize:{min:3,max:10},particleSpeed:{min:1,max:3.5},fadeInTime:1750,lingerTime:3e3,fadeOutTime:5e3},green:{text:"WEALTH MILESTONE ACHIEVED",textSize:"7vw",particleCount:22,particleShape:"sliver",particleSize:{min:1,max:20},particleSpeed:{min:2.5,max:15.5},fadeInTime:1750,lingerTime:3e3,fadeOutTime:5e3},gold:{text:"MISSION COMPLETE",textSize:"7vw",particleCount:62,particleShape:"circle",particleSize:{min:3,max:18},particleSpeed:{min:2.5,max:12},fadeInTime:1750,lingerTime:1900,fadeOutTime:5e3}}};function Le(l,e){let{uiState:t,player:i,tutorials:a}=l,s=t.hangarShipyardToggleState==="hangar",n=s?"mode-hangar":"mode-shipyard",r=s?i.ownedShipIds:e._getShipyardInventory().map(([u])=>u),o=s?t.hangarActiveIndex||0:t.shipyardActiveIndex||0,c=Math.min(o,Math.max(0,r.length-1));return`
        <div id="ship-terminal-container" class="flex flex-col h-full ${n}">
            <div class="toggle-container mx-auto my-1">
                <div class="toggle-switch p-1 rounded-md flex w-[180px] h-10">
                    <div class="toggle-label hangar flex-1 text-center py-1 cursor-pointer" data-action="${f.TOGGLE_HANGAR_MODE}" data-mode="hangar">HANGAR</div>
                    <div class="toggle-label shipyard flex-1 text-center py-1 cursor-pointer" data-action="${f.TOGGLE_HANGAR_MODE}" data-mode="shipyard">SHIPYARD</div>
                </div>
            </div>

            <div class="carousel-container flex-grow overflow-hidden relative">
                <div id="hangar-carousel" class="flex h-full" style="transform: translateX(-${c*100}%)">
                    ${r.map(u=>Ke(l,u,s)).join("")||ze(s)}
                </div>
            </div>

            <div id="hangar-pagination" class="flex justify-center items-center p-2 space-x-2 flex-nowrap overflow-x-auto">
                ${r.map((u,h)=>`<div class="pagination-dot w-2 h-2 rounded-full bg-gray-600 transition-all duration-300 ${h===c?"active":""}" data-action="${f.SET_HANGAR_PAGE}" data-index="${h}"></div>`).join("")}
            </div>
        </div>
    `}function ze(l){return`
        <div class="carousel-page p-2 md:p-4 w-full">
             <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div class="flex flex-col items-center justify-center h-full">
                    <p class="text-gray-400">${l?"Your hangar is empty.":"No ships available in the shipyard."}</p>
                </div>
            </div>
        </div>
    `}function Ke(l,e,t){let i=d.SHIPS[e],a=t?l.player.shipStates[e]:null,{player:s}=l,n="";if(t){let c=s.activeShipId===e;n=`<div class="status-badge" style="border-color: ${c?"var(--theme-color-primary)":"var(--ot-border-light)"}; color: ${c?"var(--theme-color-primary)":"var(--ot-text-secondary)"};">${c?"ACTIVE":"STORED"}</div>`}let r=`
        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${n}
            </div>
        </div>
        <div class="col-span-2 flex flex-col justify-between">
            ${Ce(l,e,i,a,s,t)}
            <div class="action-buttons-container pt-2">
                ${Re(e,i,s,t,l.tutorials)}
            </div>
        </div>
    `,o=`
        <div class="col-span-2 flex flex-col justify-between">
            ${Ce(l,e,i,a,s,t)}
        </div>

        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${n}
            </div>
            <div class="action-buttons-container pt-2">
                ${Re(e,i,s,t,l.tutorials)}
            </div>
        </div>
    `;return`
        <div class="carousel-page p-2 md:p-4 w-full">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div id="ship-card-main-content" class="h-full">
                    <div class="ship-card-content-wrapper h-full">
                        ${t?o:r}
                    </div>
                </div>
            </div>
        </div>
    `}function Ce(l,e,t,i,a,s){let n=t.class.toLowerCase();return s?`
            <div class="info-panel-content info-panel-hangar flex-col justify-between h-full">
                <div>
                    <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${n}-color);">${t.name}</h3>
                    <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                </div>
                <div class="hangar-specs my-4">
                    ${Se("Hull",i?.health,t.maxHealth,"var(--ot-green-accent)")}
                    ${Se("Fuel",i?.fuel,t.maxFuel,"var(--ot-cyan-base)")}
                    ${Se("Cargo",N(a.inventories[e]),t.cargoCapacity,"var(--class-s-color)")}
                </div>
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${t.lore}</p>
                </div>
            </div>
        `:`
             <div class="info-panel-content info-panel-shipyard flex-col justify-between h-full">
                <div>
                    <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${n}-color);">${t.name}</h3>
                    <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                    <p class="ship-price-display font-roboto-mono text-2xl">${S(t.price)}</p>
                </div>
                 <div class="grid grid-cols-3 gap-2 my-4">
                    ${fe("Max Hull",t.maxHealth)}
                    ${fe("Max Fuel",t.maxFuel)}
                    ${fe("Cargo Hold",t.cargoCapacity)}
                </div>
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${t.lore}</p>
                </div>
            </div>
        `}function Re(l,e,t,i,a){if(i){let s=t.activeShipId===l,n=t.ownedShipIds.length>1&&!s,r=Math.floor(e.price*_.SHIP_SELL_MODIFIER);return`
            <div class="grid grid-cols-2 gap-2">
                <button class="action-button" data-action="${f.SELECT_SHIP}" data-ship-id="${l}" ${s?"disabled":""} style="background-color: ${s?"#374151":"var(--ot-cyan-base)"}; color: ${s?"var(--ot-text-secondary)":"var(--ot-bg-dark)"};">
                    <span class="font-bold">${s?"ACTIVE":"BOARD"}</span>
                </button>
                <button class="action-button" data-action="${f.SELL_SHIP}" data-ship-id="${l}" ${n?"":"disabled"} style="background-color: var(--ot-hangar-red-base);">
                    <span class="font-bold">SELL</span>
                    <span class="action-button-price font-roboto-mono">${S(r,!0)}</span>
                </button>
            </div>
        `}else{let s=t.credits>=e.price,n=a.activeBatchId?d.TUTORIAL_DATA[a.activeBatchId]?.steps.find(c=>c.stepId===a.activeStepId):null,r=a.activeBatchId==="intro_hangar"&&!n?.unlockPurchase,o=!s||r;return`
            <button class="action-button w-full justify-center" data-action="${f.BUY_SHIP}" data-ship-id="${l}" ${o?"disabled":""} style="background-color: var(--ot-green-accent);">
                <span class="font-bold">PURCHASE</span>
            </button>
        `}}function Se(l,e,t,i){let a=t>0?e/t*100:0;return`
        <div class="spec-readout hangar-specs">
            <span class="text-xs text-right pr-2 text-gray-400">${l}</span>
            <div class="spec-bar"><div class="spec-bar-fill" style="width: ${a}%; background-color: ${i}; --bar-color: ${i};"></div></div>
            <span class="text-xs text-left pl-2">${Math.floor(e??0)}/${t}</span>
        </div>
    `}function fe(l,e){return`
        <div class="spec-card">
            <p class="text-xs text-gray-400">${l}</p>
            <p class="text-lg font-bold font-orbitron">${e}</p>
        </div>
    `}function we(l,e,t,i){return`<div class="scroll-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${d.COMMODITIES.filter(n=>n.tier<=l.player.revealedTier).map(n=>We(n,l,t,i)).join("")}</div>
            </div>`}function We(l,e,t,i){let{player:a,market:s,currentLocationId:n,tutorials:r,uiState:o}=e,c=a.inventories[a.activeShipId]?.[l.id],u=t(e,l.id),h=t(e,l.id,!0),m=s.galacticAverages[l.id],p=s.inventory[n]?.[l.id],v=!l.licenseId||a.unlockedLicenseIds.includes(l.licenseId),T=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_2",I=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_3",R=T&&l.id!==b.PLASTEEL||I,x=`data-tooltip="${l.lore}"`,P=c&&c.quantity>0?c.quantity:"0",F=o.marketCardMinimized[l.id],L=U({price:u,sellPrice:h,galacticAvg:m,playerItem:c}),k=c&&c.quantity>0?`<div class="avg-cost-display" id="avg-cost-${l.id}">Avg. Cost: ${S(c.avgCost,!1)}</div>`:"",C;v?C=`
             <div class="transaction-controls" data-mode="${i[l.id]?.mode||"buy"}" data-good-id="${l.id}" ${R?"disabled":""}>
                <div class="toggle-switch" data-action="toggle-trade-mode" data-good-id="${l.id}">
                    <div class="toggle-thumb"></div>
                    <div class="toggle-labels"><span class="label-buy">Buy</span><span class="label-sell">Sell</span></div>
                </div>
                <div class="qty-stepper">
                    <button class="qty-down" data-action="decrement" data-good-id="${l.id}">\u25BC</button>
                    <input type="number" value="0" id="qty-${l.id}" min="0">
                    <button class="qty-up" data-action="increment" data-good-id="${l.id}">\u25B2</button>
                </div>
                <div class="action-group">
                    <button class="btn confirm-btn" data-action="confirm-trade" data-good-id="${l.id}">Confirm</button>
                    <button class="btn max-btn" data-action="set-max-trade" data-good-id="${l.id}">Max</button>
                </div>
            </div>`:C=`
            <div class="transaction-controls absolute inset-0 flex items-center justify-center p-4">
                <button class="btn w-full h-full text-center" data-action="${f.ACQUIRE_LICENSE}" data-license-id="${l.licenseId}">Acquire License</button>
            </div>`;let D=c?.quantity>0?` (${c.quantity})`:"";return`
    <div class="item-card-container ${v?"":"locked"} ${F?"minimized":""}" id="item-card-container-${l.id}">
        <div class="rounded-lg border ${l.styleClass} transition-colors shadow-md">
            <button class="card-toggle-btn" data-action="${f.TOGGLE_MARKET_CARD_VIEW}" data-good-id="${l.id}">${F?"+":"\u2212"}</button>
            
            <div class="max-view-content">
                <p class="font-bold commodity-name"><span class="commodity-name-tooltip" ${x}>${l.name}</span></p>
                <p class="avail-text">Avail: <span id="m-stock-${l.id}">${p.quantity}</span>, Own: <span id="p-inv-${l.id}">${P}</span></p>
                <p id="price-display-${l.id}" class="font-roboto-mono font-bold price-text" data-action="${f.SHOW_PRICE_GRAPH}" data-good-id="${l.id}" data-base-price="${u}">${S(u)}</p>
                
                <div id="effective-price-display-${l.id}" class="effective-price-display"></div>
                
                <div class="indicator-container" id="indicators-${l.id}">${L}</div>

                ${k}

                ${C}
            </div>

            <div class="min-view-content">
                <p class="font-bold commodity-name-min">${l.name}${D}</p>
                <p class="tier-text-min">Tier ${l.tier} | ${l.cat}</p>
            </div>
        </div>
    </div>`}function Ne(){return'<div id="map-container" class="w-full h-full"></div>'}function ke(l){let e=d3.select("#map-container");if(!e.node()||!e.select("svg").empty())return;let t=e.append("svg").attr("id","map-svg").attr("width","100%").attr("height","100%"),a=t.append("defs").append("radialGradient").attr("id","sun-gradient");a.append("stop").attr("offset","0%").attr("stop-color","#fef08a"),a.append("stop").attr("offset","100%").attr("stop-color","#fde047"),t.append("circle").attr("class","sun").attr("cx","50%").attr("cy",-195).attr("r",225).attr("fill","url(#sun-gradient)"),t.append("line").attr("class","central-axis").attr("x1","50%").attr("y1",0).attr("x2","50%").attr("y2","100%");let s={[g.VENUS]:1.035,[g.EARTH]:1.035,[g.LUNA]:.805,[g.MARS]:.9775,[g.BELT]:.805,[g.EXCHANGE]:.805,[g.JUPITER]:1.564,[g.SATURN]:1.46625,[g.URANUS]:1.27075,[g.NEPTUNE]:1.27075,[g.KEPLER]:.8625,[g.PLUTO]:.92},n=d.MARKETS.filter(h=>l.lastKnownState.player.unlockedLocationIds.includes(h.id)).map(h=>{let p=(h.parent?8:12)*(s[h.id]||1),v=h.distance;if(h.parent){let T=d.MARKETS.find(I=>I.id===h.parent);T&&(v=T.distance+.1)}return{...h,effectiveDistance:v,finalRadius:p}}).sort((h,m)=>h.effectiveDistance-m.effectiveDistance),r=d3.scalePoint().domain(n.map(h=>h.id)).range([120,e.node().clientHeight-80]).padding(.1),o=e.node().clientWidth/2,c=t.selectAll(".poi-group").data(n).enter().append("g").attr("class","poi-group").attr("data-action","show-map-modal").attr("data-location-id",h=>h.id).on("click",(h,m)=>{l.showMapDetailModal(m.id)});c.filter(h=>h.id!==g.BELT).append("circle").attr("cx","50%").attr("cy",h=>r(h.id)).attr("r",h=>h.finalRadius).attr("fill",h=>h.navTheme.borderColor);let u=c.filter(h=>h.id===g.BELT);if(!u.empty()){let h=u.datum().finalRadius;u.append("path").attr("d",`M 0,${-h} L ${h},0 L 0,${h} L ${-h},0 Z`).attr("transform",m=>`translate(${o}, ${r(m.id)})`).attr("fill",m=>m.navTheme.borderColor)}c.append("line").attr("class","leader-line").attr("x1","50%").attr("y1",h=>r(h.id)).attr("x2",(h,m)=>o+(m%2===0?-46:46)).attr("y2",h=>r(h.id)),c.append("text").attr("class","poi-label").attr("x",(h,m)=>o+(m%2===0?-52:52)).attr("y",h=>r(h.id)).attr("text-anchor",(h,m)=>m%2===0?"end":"start").attr("dominant-baseline","middle").text(h=>h.name)}function Oe(l){let{player:e,currentLocationId:t,TRAVEL_DATA:i,tutorials:a}=l,{navLock:s}=a,n=s&&s.screenId===y.NAVIGATION,r=n?s.enabledElementQuery:null;return`
        <div class="scroll-panel p-1">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${d.MARKETS.filter(o=>e.unlockedLocationIds.includes(o.id)).map(o=>{let c=o.id===t,u=c?null:i[t][o.id],h=!1;if(n&&r){let p=document.createElement("div");p.innerHTML=`<div data-location-id="${o.id}"></div>`,h=!p.querySelector(r)}let m=h?"disabled-location":"";return`<div class="location-card p-6 rounded-lg text-center flex flex-col ${c?"highlight-current":""} ${o.color} ${o.bg} ${m}" 
                                 data-action="show-launch-modal" data-location-id="${o.id}" ${h?"disabled":""}>
                        <h3 class="text-2xl font-orbitron flex-grow">${o.name}</h3>
                        <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                        ${c?'<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>':`<div class="flex justify-around items-center text-center">
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${u.time}</span><span class="block text-xs text-gray-400">Days</span></div>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${u.fuelCost}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                                   </div>
                               </div>`}
                      </div>
                      </div>`}).join("")}
            </div>
        </div>`}function Pe(l){let{player:e,currentLocationId:t}=l,i=d.SHIPS[e.activeShipId],a=e.shipStates[e.activeShipId],s=d.MARKETS.find(h=>h.id===t),n=s?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},r=s.fuelPrice/2;e.activePerks[E.VENETIAN_SYNDICATE]&&t===g.VENUS&&(r*=1-d.PERKS[E.VENETIAN_SYNDICATE].fuelDiscount);let o=i.maxHealth*(_.REPAIR_AMOUNT_PER_TICK/100)*_.REPAIR_COST_PER_HP;e.activePerks[E.VENETIAN_SYNDICATE]&&t===g.VENUS&&(o*=1-d.PERKS[E.VENETIAN_SYNDICATE].repairDiscount);let c=a.fuel/i.maxFuel*100,u=a.health/i.maxHealth*100;return`
        <div class="services-scroll-panel">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8">
                <div class="p-4 rounded-lg text-center shadow-lg panel-border border" style="border-color: ${n.borderColor}; color: ${n.textColor}; background: ${n.gradient};">
                    <h4 class="font-orbitron text-xl mb-2">Refueling</h4>
                    <p class="mb-3">Price: <span class="font-bold">\u232C ${S(r,!1)}</span> / 5 units</p>
                    <button id="refuel-btn" class="btn w-full py-3" ${a.fuel>=i.maxFuel?"disabled":""}>Hold to Refuel</button>
                    <div class="w-full hud-stat-bar mt-2"><div id="fuel-bar" style="width: ${c}%" class="bg-sky-400"></div></div>
                </div>
                <div class="p-4 rounded-lg text-center shadow-lg panel-border border" style="border-color: ${n.borderColor}; color: ${n.textColor}; background: ${n.gradient};">
                    <h4 class="font-orbitron text-xl mb-2">Ship Maintenance</h4>
                    <p class="mb-3">Price: <span class="font-bold">\u232C ${S(o,!1)}</span> / 5% repair</p>
                    <button id="repair-btn" class="btn w-full py-3" ${a.health>=i.maxHealth?"disabled":""}>Hold to Repair</button>
                    <div class="w-full hud-stat-bar mt-2"><div id="repair-bar" style="width: ${u}%" class="bg-green-400"></div></div>
                </div>
            </div>
        </div>`}function De(l){let e=l.player.inventories[l.player.activeShipId];if(!e)return'<p class="text-center text-gray-500 text-lg">No active ship.</p>';let t=Object.entries(e).filter(([,a])=>a.quantity>0);return t.length===0?'<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>':`<div class="cargo-scroll-panel"><div class="cargo-grid">${t.map(([a,s])=>{let n=d.COMMODITIES.find(r=>r.id===a);return Xe(n,s)}).join("")}</div></div>`}function Xe(l,e){let t=q(l.styleClass);return`
        <div class="min-cargo-item" 
             style="background: ${t.gradient}; border: 2px solid ${t.hex};"
             data-action="show_cargo_detail" 
             data-good-id="${l.id}">
            
            <div class="pt-symbol" style="font-size: 2rem; color: ${t.hex}; text-shadow: 0 0 5px rgba(0,0,0,0.7);">${l.symbol.toUpperCase()}</div>
            <div class="pt-quantity text-gray-400" style="text-shadow: 1px 1px 3px #000;">(${e.quantity})</div>
        </div>
    `}function $e(l,e){let t=q(l.styleClass),a={RAW:"Raw Material",IND:"Industrial Product",AGRI:"Agricultural Good",TECH:"Technology",CIV:"Civilian Commodity",BIO:"Bioware",RARE:"Exotic Material"}[l.cat]||"Unknown",n=(l.basePriceRange[0]+l.basePriceRange[1])/2*e.quantity;return`
        <div class="max-cargo-card" style="background: ${t.gradient}; border-color: ${t.hex};">
            <h3 class="text-2xl font-orbitron text-center">${l.name}</h3>
            <p class="text-sm text-center tier-type-line mb-4" style="color: ${t.hex};">Tier ${l.tier} ${a}</p>
            <p class="flavor-text">${l.lore}</p>
            <div class="avg-cost">
                <div>Avg. Cost: <span class="font-bold credits-text-pulsing">${S(e.avgCost,!0)}</span></div>
                <div>Qty Aboard: <span class="font-bold">${e.quantity}</span></div>
                <div>Avg. Value: <span class="font-bold credits-text-pulsing">${S(n,!0)}</span></div>
            </div>
        </div>
    `}function He(l,e){let{missions:t,currentLocationId:i}=l,{activeMissionId:a,activeMissionObjectivesMet:s}=t,n=(c,u)=>{let h="";u==="active"&&(h="mission-active"),u==="completed"&&(h="mission-complete"),u==="active"&&s&&c.completion.locationId===i&&(h+=" mission-turn-in");let m=`host-${c.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,p=c.rewards.map(v=>v.type==="credits"?`\u232C ${v.amount.toLocaleString()}`:v.type.toUpperCase()).join(", ");return`
            <div class="mission-card sci-fi-frame ${m} ${h}" data-action="show-mission-modal" data-mission-id="${c.id}">
                <div class="flex justify-between items-center w-full text-xs mb-1">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mission-type">${c.type}</span>
                    </div>
                    <span class="mission-host">${c.host}</span>
                </div>
                <div class="flex justify-between items-end w-full">
                    <p class="font-bold text-base">${c.name}</p>
                    <span class="mission-reward">${p}</span>
                </div>
            </div>`},r="",o=a?d.MISSIONS[a]:null;return o&&(r+=n(o,"active")),e&&e.getAvailableMissions().forEach(u=>{r+=n(u,"available")}),r===""&&(r='<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>'),`
        <div class="flex flex-col h-full">
            <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300 flex-shrink-0">Mission Terminal</h1>
            <div class="missions-scroll-panel flex-grow min-h-0">
                <div class="space-y-3 max-w-2xl mx-auto">
                    ${r}
                </div>
            </div>
        </div>
    `}function Be(l){let{player:e,day:t,currentLocationId:i}=l,s=d.MARKETS.find(o=>o.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},n;if(e.debt>0){let o="";if(e.loanStartDate){let c=_.LOAN_GARNISHMENT_DAYS-(t-e.loanStartDate);c>0&&(o=`<p class="text-xs text-red-400/70 mt-2">Garnishment in ${c} days</p>`)}n=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Debt</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <button data-action="${f.PAY_DEBT}" class="btn w-full py-2 bg-red-800/80 hover:bg-red-700/80 border-red-500 font-roboto-mono" ${e.credits>=e.debt?"":"disabled"}>
                        Pay Off ${S(e.debt)}
                    </button>
                    ${o}
                </div>
            </div>`}else{let o=Math.floor(e.credits*3.5),c=Math.floor(o*.1),u=Math.floor(o*.04),m=[{key:"10000",amount:1e4,fee:600,interest:500},{key:"dynamic",...{amount:o,fee:c,interest:u}}].map(p=>`<button class="btn btn-loan w-full p-2 mt-2" data-action="${f.TAKE_LOAN}" data-loan-details='${JSON.stringify(p)}' ${e.credits<p.fee?"disabled":""}>
                        <span class="font-orbitron text-cyan-300">\u232C ${S(p.amount,!1)}</span>
                    </button>`).join("");n=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Financing</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <div class="flex justify-center gap-4 w-full">${m}</div>
                </div>
            </div>`}let r=[...e.financeLog].reverse().map(o=>{let c=o.amount>0?"text-green-400":"text-red-400",u=o.amount>0?"+":"";return`
            <div class="grid grid-cols-4 gap-2 p-2 border-b border-slate-700 text-sm">
                <span class="text-gray-400">${o.day}</span>
                <span class="col-span-2">${o.description}</span>
                <span class="${c} text-right">${u}${S(o.amount,!1)}</span>
            </div>
        `}).join("");return`
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                ${n}
            </div>
            <div class="md:col-span-2">
                 <h3 class="text-2xl font-orbitron text-center mb-4">Transaction Log</h3>
                 <div class="finance-log-panel p-4 rounded-lg shadow-lg panel-border border" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <div class="grid grid-cols-4 gap-2 p-2 border-b-2 font-bold" style="border-color: ${s.borderColor};">
                       <span>Day</span>
                       <span class="col-span-2">Description</span>
                       <span class="text-right">Amount</span>
                    </div>
                    ${r||'<p class="text-center p-4">No transactions recorded.</p>'}
                 </div>
            </div>
        </div>
    `}function Ge(){return`
        <div class="intel-scroll-panel">
            <div class="text-center p-8 flex flex-col items-center gap-4">
                 <div id="tutorial-button-container" class="tutorial-container relative">
                    <button class="btn btn-header">Tutorial Log</button>
                    <div id="tutorial-log-modal" class="tutorial-tooltip">
                        <h3 id="tutorial-log-title" class="text-2xl font-orbitron mb-4 text-center">Tutorial Log</h3>
                        <ul id="tutorial-log-list" class="space-y-2"></ul>
                    </div>
                </div>
                <div id="lore-button-container" class="lore-container relative">
                    <button class="btn btn-header">Story So Far...</button>
                    <div class="lore-tooltip">
                        <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p><br><p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p><br><p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p><br><p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
                    </div>
                </div>
            </div>
        </div>`}var ie=class{constructor(e){this.isMobile=e,this.modal=document.getElementById("travel-animation-modal"),this.gameContainer=document.getElementById("game-container"),this.canvas=document.getElementById("travel-canvas"),this.ctx=this.canvas.getContext("2d"),this.statusText=document.getElementById("travel-status-text"),this.arrivalLore=document.getElementById("travel-arrival-lore"),this.progressBar=document.getElementById("travel-progress-bar"),this.progressContainer=document.getElementById("travel-progress-container"),this.readoutContainer=document.getElementById("travel-readout-container"),this.infoText=document.getElementById("travel-info-text"),this.hullDamageText=document.getElementById("travel-hull-damage"),this.confirmButton=document.getElementById("travel-confirm-button"),this.animationFrame=null,this.starLayers=[],this.engineParticles=[],this.celestialObjects=[]}play(e,t,i,a,s){this.modal.classList.remove("hidden"),this.modal.classList.add("dismiss-disabled"),this.gameContainer.classList.add("fade-out");let n=t.navTheme||{gradient:"linear-gradient(to right, #06b6d4, #67e8f9)",borderColor:"#06b6d4"},r=this._lightenGradient(n.gradient);this.progressBar.style.background=r,this.progressBar.style.setProperty("--progress-glow-color",n.borderColor),this._setupInitialState(t,i),this._setupAnimationElements(e,t);let o=null,c=2500,u=h=>{o||(o=h);let m=h-o,p=Math.min(m/c,1);if(p>.8){let v=(p-.8)/.2;p=.8+(1-Math.pow(1-v,3))*.2}this._draw(p,e,t),this.progressBar.style.width=`${p*100}%`,p<1?this.animationFrame=requestAnimationFrame(u):this._onArrival(t,i,a,s)};this.animationFrame=requestAnimationFrame(u),this.confirmButton.onclick=()=>{cancelAnimationFrame(this.animationFrame),this.modal.classList.add("modal-hiding"),s&&s(),setTimeout(()=>{this.gameContainer.classList.remove("fade-out"),this.gameContainer.classList.add("fade-in")},50),setTimeout(()=>{this.modal.classList.add("hidden"),this.modal.classList.remove("modal-hiding","dismiss-disabled")},1e3)}}_lightenGradient(e){let t=e.match(/#[0-9a-f]{6}|#[0-9a-f]{3}/ig);if(!t)return e;let i=(s,n)=>{s=s.replace(/^#/,""),s.length===3&&(s=s.split("").map(h=>h+h).join(""));let r=parseInt(s,16),o=(r>>16)+n;o>255&&(o=255),o<0&&(o=0);let c=(r>>8&255)+n;c>255&&(c=255),c<0&&(c=0);let u=(r&255)+n;return u>255&&(u=255),u<0&&(u=0),"#"+(u|c<<8|o<<16).toString(16).padStart(6,"0")};return`linear-gradient(to right, ${t.map(s=>i(s,40)).join(", ")})`}_setupInitialState(e,t){this.statusText.textContent=`Traveling to ${e.name}...`,this.arrivalLore.textContent="",this.arrivalLore.style.opacity=0,this.readoutContainer.classList.add("hidden"),this.readoutContainer.style.opacity=0,this.confirmButton.style.opacity=0,this.confirmButton.disabled=!0,this.progressBar.style.width="0%"}_setupAnimationElements(e,t){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.starLayers=[this._createStarLayer(80,.5,.8),this._createStarLayer(50,1.2,1.2),this._createStarLayer(20,1.8,2)],this.engineParticles=[],this.backgroundGradient=this._getBackgroundGradient(e,t),this.celestialObjects=this._getCelestialObjects(e.id,t.id)}_createStarLayer(e,t,i){let a=[];for(let s=0;s<e;s++)a.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,radius:Math.random()*1.5,speed:t+Math.random()*(i-t),alpha:.5+Math.random()*.5});return a}_getBackgroundGradient(e,t){let a=(n=>{for(let r in d.TRAVEL_VISUALS.zones)if(d.TRAVEL_VISUALS.zones[r].locations.includes(n.id))return d.TRAVEL_VISUALS.zones[r];return d.TRAVEL_VISUALS.zones.inner_sphere})(t),s=this.ctx.createLinearGradient(0,0,0,this.canvas.height);return s.addColorStop(0,a.gradient[0]),s.addColorStop(1,a.gradient[1]),s}_getCelestialObjects(e,t){let i=`${e}_to_${t}`;return(d.TRAVEL_VISUALS.objects[i]||[]).map(s=>({...s,x:this.canvas.width+Math.random()*200,y:s.position.y*this.canvas.height}))}_draw(e,t,i){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.backgroundGradient,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.starLayers.forEach((c,u)=>{let h=e<.8?1:1-(e-.8)/.2;c.forEach(m=>{m.x-=m.speed*h,m.x<0&&(m.x=this.canvas.width),this.ctx.beginPath(),this.ctx.arc(m.x,m.y,m.radius,0,Math.PI*2),this.ctx.globalAlpha=m.alpha,this.ctx.fillStyle="#FFF",this.ctx.fill()}),u===1&&this.celestialObjects.forEach(m=>{m.x-=m.speed*h,this.ctx.font=`${40*(m.scale||1)}px sans-serif`,this.ctx.globalAlpha=.5,this.ctx.fillText(m.emoji,m.x,m.y)})}),this.ctx.globalAlpha=1;let a=60,s=a,n=this.canvas.width-a,r=this.canvas.height/2;this.ctx.font="42px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(d.LOCATION_VISUALS[t.id]||"\u2753",s,r),this.ctx.fillText(d.LOCATION_VISUALS[i.id]||"\u2753",n,r);let o=s+(n-s)*e;this.ctx.save(),this.ctx.translate(o,r),this.ctx.font="17px sans-serif",this.ctx.fillText("\u{1F680}",0,0),this.ctx.restore(),this._updateEngineParticles(o,r),this._drawEngineParticles()}_updateEngineParticles(e,t){Math.random()>.5&&this.engineParticles.push({x:e-15,y:t+(Math.random()-.5)*8,life:1,speedX:-2-Math.random()*2,speedY:(Math.random()-.5)*.5,size:Math.random()*2+1});for(let i=this.engineParticles.length-1;i>=0;i--){let a=this.engineParticles[i];a.x+=a.speedX,a.y+=a.speedY,a.life-=.05,a.life<=0&&this.engineParticles.splice(i,1)}}_drawEngineParticles(){this.engineParticles.forEach(e=>{this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.globalAlpha=e.life,this.ctx.fillStyle=`rgba(255, 220, 180, ${e.life})`,this.ctx.fill()}),this.ctx.globalAlpha=1}_onArrival(e,t,i,a){this.statusText.textContent=`Arrived at ${e.name}`,this.arrivalLore.innerHTML=e.arrivalLore||"You have arrived.",this.infoText.innerHTML=`
            <div class="text-center">
                <div>Journey Time: ${t.time} Days</div>
                <div><span class="font-bold text-sky-300">Fuel Expended: ${t.fuelCost}</span></div>
            </div>`,this.hullDamageText.className="text-sm font-roboto-mono mt-1 font-bold text-red-400",i>.01?this.hullDamageText.innerHTML=`Hull Integrity -${i.toFixed(2)}%`:this.hullDamageText.innerHTML="",this.arrivalLore.style.opacity=1,this.readoutContainer.classList.remove("hidden"),setTimeout(()=>{this.readoutContainer.style.opacity=1,this.confirmButton.style.opacity=1,this.confirmButton.disabled=!1},150)}};var ae=class{constructor(e){this.logger=e,this.isMobile=window.innerWidth<=768,this.modalQueue=[],this.activeGraphAnchor=null,this.activeGenericTooltipAnchor=null,this.lastActiveScreenEl=null,this.lastKnownState=null,this.missionService=null,this.simulationService=null,this.marketTransactionState={},this.activeHighlightConfig=null,this.marketScrollPosition=0,this.effectsManager=new Z,this.effectsManager.registerEffect("systemSurge",te),this.travelAnimationService=new ie(this.isMobile),this.navStructure={[M.SHIP]:{label:"Ship",screens:{[y.MAP]:"Map",[y.NAVIGATION]:"Navigation",[y.CARGO]:"Cargo"}},[M.STARPORT]:{label:"Starport",screens:{[y.MARKET]:"Market",[y.SERVICES]:"Services",[y.HANGAR]:"Shipyard"}},[M.DATA]:{label:"Data",screens:{[y.MISSIONS]:"Missions",[y.FINANCE]:"Finance",[y.INTEL]:"Intel"}}},this._cacheDOM(),window.addEventListener("resize",this._setAppHeight)}_setAppHeight(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}triggerEffect(e,t){this.effectsManager.trigger(e,t)}setMissionService(e){this.missionService=e}setSimulationService(e){this.simulationService=e}resetMarketTransactionState(){this.marketTransactionState={}}_cacheDOM(){this.cache={gameContainer:document.getElementById("game-container"),navBar:document.getElementById("nav-bar"),topBarContainer:document.getElementById("top-bar-container"),subNavBar:document.getElementById("sub-nav-bar"),stickyBar:document.getElementById("sticky-bar"),mapScreen:document.getElementById(`${y.MAP}-screen`),navigationScreen:document.getElementById(`${y.NAVIGATION}-screen`),servicesScreen:document.getElementById(`${y.SERVICES}-screen`),marketScreen:document.getElementById(`${y.MARKET}-screen`),cargoScreen:document.getElementById(`${y.CARGO}-screen`),hangarScreen:document.getElementById(`${y.HANGAR}-screen`),missionsScreen:document.getElementById(`${y.MISSIONS}-screen`),financeScreen:document.getElementById(`${y.FINANCE}-screen`),intelScreen:document.getElementById(`${y.INTEL}-screen`),graphTooltip:document.getElementById("graph-tooltip"),genericTooltip:document.getElementById("generic-tooltip"),processingModal:document.getElementById("processing-modal"),shipDetailModal:document.getElementById("ship-detail-modal"),launchModal:document.getElementById("launch-modal"),launchModalContent:document.getElementById("launch-modal-content"),cargoDetailModal:document.getElementById("cargo-detail-modal"),cargoDetailContent:document.getElementById("cargo-detail-content"),mapDetailModal:document.getElementById("map-detail-modal"),tutorialToastContainer:document.getElementById("tutorial-toast-container"),tutorialToastText:document.getElementById("tutorial-toast-text"),tutorialToastSkipBtn:document.getElementById("tutorial-toast-skip-btn"),tutorialToastNextBtn:document.getElementById("tutorial-toast-next-btn"),skipTutorialModal:document.getElementById("skip-tutorial-modal"),skipTutorialConfirmBtn:document.getElementById("skip-tutorial-confirm-btn"),skipTutorialCancelBtn:document.getElementById("skip-tutorial-cancel-btn"),tutorialHighlightOverlay:document.getElementById("tutorial-highlight-overlay"),missionStickyBar:document.getElementById("mission-sticky-bar"),stickyObjectiveText:document.getElementById("sticky-objective-text"),stickyObjectiveProgress:document.getElementById("sticky-objective-progress")}}render(e){if(!e||!e.player)return;let t=this.lastKnownState;if(this.lastKnownState=e,e.introSequenceActive&&!e.tutorials.activeBatchId)return;let i=d.MARKETS.find(a=>a.id===e.currentLocationId);i&&(this.cache.topBarContainer.setAttribute("data-location-theme",i.id),this.cache.gameContainer.className=`game-container ${i.bg}`,i.navTheme&&i.navTheme.borderColor?document.documentElement.style.setProperty("--theme-border-color",i.navTheme.borderColor):document.documentElement.style.removeProperty("--theme-border-color")),this.renderNavigation(e),this.renderActiveScreen(e,t),this.updateStickyBar(e),this.renderStickyBar(e)}renderNavigation(e){let{player:t,currentLocationId:i,activeNav:a,activeScreen:s,lastActiveScreen:n,introSequenceActive:r,tutorials:o,subNavCollapsed:c}=e,{navLock:u}=o,h=d.MARKETS.find(L=>L.id===i),m=t.activeShipId?d.SHIPS[t.activeShipId]:null,p=t.activeShipId?t.shipStates[t.activeShipId]:null,v=t.activeShipId?t.inventories[t.activeShipId]:null,T=h?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0"},I=`
            <div class="context-bar" style="background: ${T.gradient}; color: ${T.textColor};">
                <span class="location-name-text">${h?.name||"In Transit"}</span>
                <span class="credit-text">${S(t.credits)}</span>
            </div>`,R=Object.keys(this.navStructure).map(L=>{let k=L===a,C=n[L]||Object.keys(this.navStructure[L].screens)[0],D=u&&u.navId!==L,B=r||D,pe=k?`background: ${T.gradient}; color: ${T.textColor};`:"";return`<div class="tab ${k?"active":""} ${B?"disabled":""}" style="${pe}" data-action="${f.SET_SCREEN}" data-nav-id="${L}" data-screen-id="${C}">${this.navStructure[L].label}</div>`}).join(""),x="";if(m&&p&&v){let L=N(v),k=p.health/m.maxHealth*100,C=p.fuel/m.maxFuel*100,D=L/m.cargoCapacity*100;x=`
                <div class="status-pod">
                    <div class="status-bar-group hull-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">H</span>
                        <div class="status-bar"><div class="fill hull-fill" style="width: ${k}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(p.health)}/${m.maxHealth} Hull</div>
                    </div>
                    <div class="status-bar-group fuel-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">F</span>
                        <div class="status-bar"><div class="fill fuel-fill" style="width: ${C}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(p.fuel)}/${m.maxFuel} Fuel</div>
                    </div>
                    <div class="status-bar-group cargo-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">C</span>
                        <div class="status-bar"><div class="fill cargo-fill" style="width: ${D}%;"></div></div>
                        <div class="status-tooltip">${L}/${m.cargoCapacity} Cargo</div>
                    </div>
                </div>`}let P=`<div class="nav-wrapper">${R}${x}</div>`,F=Object.keys(this.navStructure).map(L=>{let k=this.navStructure[L].screens,C=L===a,D=Object.keys(k).map(B=>{let pe=u&&u.screenId!==B,Te=B===s,Fe=r||pe,qe=Te?"sub-nav-active":"",Ie="";return Te&&(Ie=`style="background: ${T.gradient}; color: ${T.textColor}; opacity: 1; font-weight: 700;"`),`<a href="#" class="${Fe?"disabled":""} ${qe}" ${Ie} data-action="${f.SET_SCREEN}" data-nav-id="${L}" data-screen-id="${B}" draggable="false">${k[B]}</a>`}).join("");return`<div class="nav-sub ${!C||c?"hidden":""}" id="${L}-sub">${D}</div>`}).join("");this.cache.navBar.innerHTML=I+P,this.cache.subNavBar.innerHTML=F}renderActiveScreen(e,t){let i=this.cache[`${e.activeScreen}Screen`];switch(this.lastActiveScreenEl&&this.lastActiveScreenEl!==i&&this.lastActiveScreenEl.classList.remove("active-screen"),i&&(i.classList.add("active-screen"),this.lastActiveScreenEl=i),e.activeScreen){case y.MAP:this.cache.mapScreen.innerHTML=Ne(),requestAnimationFrame(()=>ke(this));break;case y.NAVIGATION:this.cache.navigationScreen.innerHTML=Oe(e);break;case y.SERVICES:this.cache.servicesScreen.innerHTML=Pe(e);break;case y.MARKET:this.updateMarketScreen(e);break;case y.CARGO:this.cache.cargoScreen.innerHTML=De(e);break;case y.HANGAR:{(!t||t.activeScreen!==y.HANGAR||t.uiState.hangarShipyardToggleState!==e.uiState.hangarShipyardToggleState||t.player.activeShipId!==e.player.activeShipId||t.uiState.lastTransactionTimestamp!==e.uiState.lastTransactionTimestamp||t&&t.tutorials.activeBatchId!==e.tutorials.activeBatchId||t&&t.tutorials.activeStepId!==e.tutorials.activeStepId)&&(this.cache.hangarScreen.innerHTML=Le(e,this.simulationService)),this._updateHangarScreen(e);break}case y.MISSIONS:this.cache.missionsScreen.innerHTML=He(e,this.missionService);break;case y.FINANCE:this.cache.financeScreen.innerHTML=Be(e);break;case y.INTEL:this.cache.intelScreen.innerHTML=Ge();break}}_updateHangarScreen(e){let{uiState:t}=e,i=this.cache.hangarScreen.querySelector("#hangar-carousel"),a=this.cache.hangarScreen.querySelectorAll(".pagination-dot");if(!i||!a)return;let n=t.hangarShipyardToggleState==="hangar"?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;i.style.transform=`translateX(-${n*100}%)`,a.forEach((r,o)=>{r.classList.toggle("active",o===n)})}updateStickyBar(e){this.cache.stickyBar.innerHTML="",this.cache.topBarContainer.classList.remove("has-sticky-bar")}updateServicesScreen(e){if(e.activeScreen!==y.SERVICES)return;let{player:t}=e,i=d.SHIPS[t.activeShipId],a=t.shipStates[t.activeShipId],s=this.cache.servicesScreen.querySelector("#fuel-bar"),n=this.cache.servicesScreen.querySelector("#refuel-btn");if(s&&n){let c=a.fuel/i.maxFuel*100;s.style.width=`${c}%`,n.disabled=a.fuel>=i.maxFuel}let r=this.cache.servicesScreen.querySelector("#repair-bar"),o=this.cache.servicesScreen.querySelector("#repair-btn");if(r&&o){let c=a.health/i.maxHealth*100;r.style.width=`${c}%`,o.disabled=a.health>=i.maxHealth}}updateMarketScreen(e){if(e.activeScreen!==y.MARKET)return;let t=this.cache.marketScreen.querySelector(".scroll-panel");this.lastKnownState&&this.lastKnownState.activeScreen===y.MARKET&&this.lastKnownState.currentLocationId===e.currentLocationId&&t?this.marketScrollPosition=t.scrollTop:this.marketScrollPosition=0,this._saveMarketTransactionState(),this.cache.marketScreen.innerHTML=we(e,this.isMobile,this.getItemPrice,this.marketTransactionState),this._restoreMarketTransactionState();let i=this.cache.marketScreen.querySelector(".scroll-panel");i&&(i.scrollTop=this.marketScrollPosition)}_saveMarketTransactionState(){if(!this.lastKnownState||this.lastKnownState.activeScreen!==y.MARKET)return;this.cache.marketScreen.querySelectorAll(".transaction-controls").forEach(t=>{let i=t.dataset.goodId,a=t.querySelector("input"),s=t.dataset.mode;a&&(this.marketTransactionState[i]={quantity:a.value,mode:s})})}_restoreMarketTransactionState(){for(let e in this.marketTransactionState){let t=this.marketTransactionState[e],i=this.cache.marketScreen.querySelector(`.transaction-controls[data-good-id="${e}"]`);if(i){let a=i.querySelector("input");a&&(a.value=t.quantity,i.setAttribute("data-mode",t.mode),this.updateMarketCardDisplay(e,parseInt(t.quantity,10)||0,t.mode))}}}getItemPrice(e,t,i=!1){let a=e.market.prices[e.currentLocationId][t],s=d.MARKETS.find(r=>r.id===e.currentLocationId);i&&s.specialDemand&&s.specialDemand[t]&&(a*=s.specialDemand[t].bonus);let n=e.intel.active;return n&&n.targetMarketId===e.currentLocationId&&n.commodityId===t&&(a*=n.type==="demand"?d.CONFIG.INTEL_DEMAND_MOD:d.CONFIG.INTEL_DEPRESSION_MOD),Math.max(1,Math.round(a))}_calculateSaleDetails(e,t){let i=this.lastKnownState;if(!i)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let a=d.COMMODITIES.find(I=>I.id===e),s=i.market.inventory[i.currentLocationId][e].quantity,n=this.getItemPrice(i,e,!0),o=i.player.inventories[i.player.activeShipId]?.[e]?.avgCost||0;if(s<=0)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let c=s*.1;if(t<=c){let I=n*t,R=o*t,x=I-R;if(x>0){let P=(i.player.activePerks[E.TRADEMASTER]?d.PERKS[E.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);x+=x*P}return{totalPrice:I,effectivePricePerUnit:n,netProfit:x}}let u=t/s,h=0;a.tier<=2?h=Math.min(.1,(u-.1)*.2):a.tier<=5?h=Math.min(.25,(u-.1)*.5):h=Math.min(.4,(u-.1)*.8);let m=n*(1-h),p=Math.floor(m*t),v=o*t,T=p-v;if(T>0){let I=(i.player.activePerks[E.TRADEMASTER]?d.PERKS[E.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);T+=T*I}return{totalPrice:p,effectivePricePerUnit:m,netProfit:T}}updateMarketCardPrice(e,t){let i=this.cache.marketScreen.querySelector(`#price-display-${e}`);if(i){i.dataset.basePrice=t;let a=i.closest(".item-card-container").querySelector(".transaction-controls");a&&a.dataset.mode==="buy"&&(i.textContent=S(t))}}updateMarketCardDisplay(e,t,i){let a=this.cache.marketScreen.querySelector(`#price-display-${e}`),s=this.cache.marketScreen.querySelector(`#effective-price-display-${e}`),n=this.cache.marketScreen.querySelector(`#indicators-${e}`),r=this.cache.marketScreen.querySelector(`#avg-cost-${e}`);if(!a||!s||!n||!this.lastKnownState)return;let o=this.lastKnownState,c=parseInt(a.dataset.basePrice,10),u=o.player.inventories[o.player.activeShipId]?.[e];if(r&&r.classList.toggle("visible",i==="sell"),i==="buy")a.textContent=S(c),a.className="font-roboto-mono font-bold price-text",s.textContent="",n.innerHTML=U({price:c,sellPrice:this.getItemPrice(o,e,!0),galacticAvg:o.market.galacticAverages[e],playerItem:u});else{let{effectivePricePerUnit:h,netProfit:m}=this._calculateSaleDetails(e,t);if(t>0){let p=`\u232C ${m>=0?"+":""}${S(m,!1)}`;a.textContent=p,s.textContent=`(${S(h,!1)}/unit)`,a.className=`font-roboto-mono font-bold ${m>=0?"profit-text":"loss-text"}`}else a.textContent="\u232C +0",a.className="font-roboto-mono font-bold profit-text",s.textContent="";n.innerHTML=U({price:c,sellPrice:h||this.getItemPrice(o,e,!0),galacticAvg:o.market.galacticAverages[e],playerItem:u})}}showTravelAnimation(e,t,i,a,s){this.travelAnimationService.play(e,t,i,a,s)}queueModal(e,t,i,a=null,s={}){this.modalQueue.push({modalId:e,title:t,description:i,callback:a,options:s}),document.querySelector(".modal-backdrop:not(.hidden)")||this.processModalQueue()}processModalQueue(){if(this.modalQueue.length===0)return;let{modalId:e,title:t,description:i,callback:a,options:s}=this.modalQueue.shift(),n=document.getElementById(e);if(!n)return this.logger.error("UIManager",`Modal element with ID '${e}' not found in the DOM. Aborting modal display.`),this.processModalQueue();s.specialClass&&n.classList.add(s.specialClass),s.nonDismissible&&n.classList.add("dismiss-disabled");let r=e==="mission-modal"?"mission-modal-title":e.replace("-modal","-title"),o=e==="mission-modal"?"mission-modal-description":e.replace("-modal","-description"),c=n.querySelector(`#${r}`),u=n.querySelector(`#${o}`)||n.querySelector(`#${e.replace("-modal","-scenario")}`);c&&(c.innerHTML=t),u&&(u.innerHTML=i,u.className="my-4 text-gray-300",e!=="mission-modal"&&u.classList.add("mb-6","text-lg"),s.contentClass&&u.classList.add(s.contentClass));let h=()=>{this.hideModal(e),a&&a(),this.processModalQueue()};if(s.customSetup)s.customSetup(n,h);else{let m=n.querySelector("#"+e.replace("-modal","-button-container")),p;m?(m.innerHTML="",p=document.createElement("button"),m.appendChild(p)):p=n.querySelector("button"),p&&(p.className="btn px-6 py-2",s.buttonClass&&p.classList.add(s.buttonClass),p.innerHTML=s.buttonText||"Understood",p.onclick=h)}n.classList.remove("hidden"),n.classList.add("modal-visible")}showRandomEventModal(e,t){this.queueModal("random-event-modal",e.title,e.scenario,null,{nonDismissible:!0,customSetup:(i,a)=>{let s=i.querySelector("#random-event-choices-container");s.innerHTML="",e.choices.forEach((n,r)=>{let o=document.createElement("button");o.className="btn w-full text-left p-4 hover:bg-slate-700",o.innerHTML=n.title,o.onclick=()=>{t(e.id,r),a()},s.appendChild(o)})}})}showAgeEventModal(e,t){let i=document.getElementById("age-event-modal");i.classList.add("dismiss-disabled"),document.getElementById("age-event-title").innerHTML=e.title,document.getElementById("age-event-description").innerHTML=e.description;let a=document.getElementById("age-event-button-container");a.innerHTML="",e.choices.forEach(s=>{let n=document.createElement("button");n.className="perk-button",n.innerHTML=`<h4>${s.title}</h4><p>${s.description}</p>`,n.onclick=()=>{this.hideModal("age-event-modal"),t(s)},a.appendChild(n)}),i.classList.remove("hidden"),i.classList.add("modal-visible")}hideModal(e){let t=document.getElementById(e);t&&!t.classList.contains("hidden")&&(t.classList.add("modal-hiding"),t.addEventListener("animationend",()=>{t.classList.add("hidden"),t.classList.remove("modal-hiding","modal-visible","dismiss-disabled","intro-fade-in"),this.modalQueue.length>0&&!document.querySelector(".modal-backdrop:not(.hidden)")&&this.processModalQueue()},{once:!0}))}showProcessingAnimation(e,t){let i=this.cache.processingModal;if(!i)return;let a=i.querySelector("#processing-title"),s=i.querySelector("#processing-progress-bar"),n=i.querySelector("#processing-status");a.textContent=`Processing application for ${e}...`,s.style.width="0%",n.textContent="",i.classList.remove("hidden"),setTimeout(()=>{s.style.width="100%"},100),setTimeout(()=>{n.textContent="Processing complete!",setTimeout(()=>{this.hideModal("processing-modal"),t&&t()},1e3)},4e3)}createFloatingText(e,t,i,a="#fde047"){let s=document.createElement("div");s.textContent=e,s.className="floating-text",s.style.left=`${t-20}px`,s.style.top=`${i-40}px`,s.style.color=a,document.body.appendChild(s),setTimeout(()=>s.remove(),2450)}showGraph(e,t){this.activeGraphAnchor=e;let i=this.cache.graphTooltip,a=e.dataset.action;if(a===f.SHOW_PRICE_GRAPH){let s=e.dataset.goodId,n=t.player.inventories[t.player.activeShipId][s];i.innerHTML=this._renderPriceGraph(s,t,n)}else a===f.SHOW_FINANCE_GRAPH&&(i.innerHTML=this._renderFinanceGraph(t));i.style.display="block",this.updateGraphTooltipPosition()}hideGraph(){this.activeGraphAnchor&&(this.cache.graphTooltip.style.display="none",this.activeGraphAnchor=null)}updateGraphTooltipPosition(){if(!this.activeGraphAnchor)return;let e=this.cache.graphTooltip;if(e.style.display==="none")return;let t=this.activeGraphAnchor.closest(".item-card-container").getBoundingClientRect(),i=e.offsetHeight,a=t.top-i-10,s=t.left;a<10&&(a=t.bottom+10),e.style.left=`${s}px`,e.style.top=`${a}px`}showGenericTooltip(e,t){this.activeGenericTooltipAnchor=e;let i=this.cache.genericTooltip;i.innerHTML=t,i.style.display="block",this.updateGenericTooltipPosition()}hideGenericTooltip(){this.activeGenericTooltipAnchor&&(this.cache.genericTooltip.style.display="none",this.activeGenericTooltipAnchor=null)}updateGenericTooltipPosition(){if(!this.activeGenericTooltipAnchor)return;let e=this.cache.genericTooltip,t=this.activeGenericTooltipAnchor.getBoundingClientRect(),i=e.offsetWidth,a=e.offsetHeight,s=t.right+10,n=t.top+t.height/2-a/2;n<10&&(n=t.bottom+10),s<10&&(s=10),s+i>window.innerWidth&&(s=window.innerWidth-i-10),e.style.left=`${s}px`,e.style.top=`${n}px`}_renderPriceGraph(e,t,i){let a=t.market.priceHistory[t.currentLocationId]?.[e];if(!a||a.length<2)return'<div class="text-gray-400 text-sm p-4">No Data Available!</div>';let s=d.COMMODITIES.find(C=>C.id===e),n=(s.basePriceRange[0]+s.basePriceRange[1])/2,r=280,o=140,c=35,u=a.map(C=>C.price),h=i?.avgCost>0?i.avgCost:null,m=[...u,n];h&&m.push(h);let p=Math.min(...m),v=Math.max(...m),T=v-p>0?v-p:1,I=C=>C/(a.length-1)*(r-c*2)+c,R=C=>o-c-(C-p)/T*(o-c*2.5),x=`<svg width="${r}" height="${o}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;x+='<g class="grid-lines" stroke="#1f2937" stroke-width="1">',x+=`<line x1="${c}" y1="${R(v)}" x2="${c}" y2="${o-c}" /><line x1="${c}" y1="${o-c}" x2="${r-c}" y2="${o-c}" />`,x+="</g>";let P=R(n);if(x+=`<line x1="${c}" y1="${P}" x2="${r-c}" y2="${P}" stroke="#facc15" stroke-width="1" stroke-dasharray="3 3" />`,x+=`<text x="${r-c+4}" y="${P+3}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg: ${S(n,!1)}</text>`,h){let C=R(h);x+=`<line x1="${c}" y1="${C}" x2="${r-c}" y2="${C}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" />`,x+=`<text x="${r-c+4}" y="${C+3}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid: ${S(h,!1)}</text>`}let F=a.map((C,D)=>`${I(D)},${R(C.price)}`).join(" ");x+=`<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${F}" />`;let L=a[0].day,k=a[a.length-1].day;return x+=`<text x="${c}" y="${o-c+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${L}</text>`,x+=`<text x="${r-c}" y="${o-c+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${k}</text>`,x+=`<text x="${c-8}" y="${R(p)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${S(p,!1)}</text>`,x+=`<text x="${c-8}" y="${R(v)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${S(v,!1)}</text>`,x+="</svg>",x}showTutorialToast({step:e,onSkip:t,onNext:i,gameState:a}){let s=this.cache.tutorialToastContainer,n=e.text;if(n.includes("{shipName}")){let u=d.SHIPS[a.player.activeShipId]?.name||"your ship";n=n.replace(/{shipName}/g,u)}n.includes("{playerName}")&&(n=n.replace(/{playerName}/g,a.player.name)),this.cache.tutorialToastText.innerHTML=n,s.className="hidden fixed p-4 rounded-lg shadow-2xl transition-all duration-300 pointer-events-auto";let r;if(this.isMobile?r=`tt-${e.position.mobile||"mobile"}`:r=`tt-${e.position.desktop||"bottom-right"}`,s.classList.add(r),s.style.width=e.size?.width||"auto",s.classList.remove("hidden"),e.completion.type==="INFO"){let u=e.buttonText||"Next &rarr;";this.cache.tutorialToastNextBtn.innerHTML=u,this.cache.tutorialToastNextBtn.style.display="inline-block",this.cache.tutorialToastNextBtn.onclick=i}else this.cache.tutorialToastNextBtn.style.display="none";let c=!1;this.cache.tutorialToastSkipBtn.style.display=c?"block":"none",this.cache.tutorialToastSkipBtn.onclick=t,this.cache.tutorialToastText.scrollTop=0}hideTutorialToast(){this.cache.tutorialToastContainer.classList.add("hidden"),this.applyTutorialHighlight(null)}applyTutorialHighlight(e){this.activeHighlightConfig=e,this._renderHighlightsFromConfig(this.activeHighlightConfig)}_renderHighlightsFromConfig(e){let t=this.cache.tutorialHighlightOverlay;if(t){if(t.innerHTML="",!e){t.classList.add("hidden");return}t.classList.remove("hidden"),e.forEach(i=>{let a=document.createElement("div");a.className="tutorial-cue",a.style.left=`${i.x}px`,a.style.top=`${i.y}px`,a.style.width=`${i.width}px`,a.style.height=`${i.height}px`,a.style.transform=`rotate(${i.rotation}deg)`,a.style.opacity=i.style.opacity,i.style.animation!=="None"&&a.classList.add(`anim-${i.style.animation.toLowerCase()}`);let s="";i.type==="Shape"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 ${i.width} ${i.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${i.shapeType==="Rectangle"?`<rect x="0" y="0" width="100%" height="100%" rx="${i.style.borderRadius}" ry="${i.style.borderRadius}" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`:`<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`}
                    </svg>`:i.type==="Arrow"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                            <marker id="arrowhead-player" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${i.style.stroke}" />
                            </marker>
                        </defs>
                        <line x1="0" y1="25" x2="90" y2="25" stroke="${i.style.stroke}" stroke-width="${i.style.strokeWidth}" marker-end="url(#arrowhead-player)" />
                    </svg>
                `:i.type==="Spotlight"&&(a.style.borderRadius="50%",a.style.boxShadow=`0 0 0 9999px rgba(0,0,0,0.7), 0 0 ${i.style.glowIntensity||20}px ${i.style.glowIntensity||10}px ${i.style.glowColor||i.style.stroke}`),a.innerHTML=s;let n=a.querySelector("svg");n&&i.style.animation!=="None"&&(n.classList.add(`anim-${i.style.animation.toLowerCase()}`),n.style.setProperty("--glow-color",i.style.glowColor||i.style.stroke),n.style.setProperty("--anim-speed",`${i.style.animationSpeed}s`),n.style.setProperty("--glow-intensity",`${i.style.glowIntensity}px`)),t.appendChild(a)})}}showSkipTutorialModal(e){this.cache.skipTutorialModal.classList.remove("hidden");let i=()=>{e(),this.hideModal("skip-tutorial-modal")},a=()=>{this.hideModal("skip-tutorial-modal")};this.cache.skipTutorialConfirmBtn.onclick=i,this.cache.skipTutorialCancelBtn.onclick=a}showTutorialLogModal({seenBatches:e,onSelect:t}){let i=document.getElementById("tutorial-log-modal"),a=document.getElementById("tutorial-log-list");if(!i||!a){this.logger.error("UIManager","Tutorial log modal elements not found in DOM.");return}a.innerHTML="",e.length===0?a.innerHTML='<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>':e.forEach(s=>{let n=d.TUTORIAL_DATA[s];if(n){let r=document.createElement("li");r.innerHTML=`<button class="btn w-full text-center">${n.title}</button>`,r.onclick=()=>{i.classList.remove("visible"),t(s)},a.appendChild(r)}}),i.classList.add("visible")}showShipDetailModal(e,t,i){let{player:a,tutorials:s}=e,n=d.SHIPS[t],r;if(i==="shipyard"){let u=a.credits>=n.price,h=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",m=!u||h;r=`
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-orbitron text-cyan-300">${n.name}</h3>
                            <p class="text-sm text-gray-400">Class ${n.class}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-cyan-300">${S(n.price)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 flex-grow text-left">${n.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${n.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${n.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${n.cargoCapacity}</span></div>
                    </div>
                    <button class="btn w-full mt-2" data-action="${f.BUY_SHIP}" data-ship-id="${t}" ${m?"disabled":""}>Purchase</button>
                </div>`}else{let u=a.shipStates[t],h=a.inventories[t],m=N(h),p=t===a.activeShipId,v=a.ownedShipIds.length>1&&!p,T=Math.floor(n.price*_.SHIP_SELL_MODIFIER);r=`
                <div class="ship-card p-4 flex flex-col space-y-3 ${p?"border-yellow-400":""}">
                    <h3 class="text-xl font-orbitron text-center ${p?"text-yellow-300":"text-cyan-300"}">${n.name}</h3>
                    <p class="text-sm text-gray-400 text-center">Class ${n.class}</p>
                    <p class="text-sm text-gray-400 flex-grow text-left my-2">${n.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull</span><div class="text-green-400">${Math.floor(u.health)}/${n.maxHealth}</div></div>
                        <div><span class="text-gray-500">Fuel</span><div class="text-sky-400">${Math.floor(u.fuel)}/${n.maxFuel}</div></div>
                        <div><span class="text-gray-500">Cargo</span><div class="text-amber-400">${m}/${n.cargoCapacity}</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        ${p?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${f.SELECT_SHIP}" data-ship-id="${t}">Board</button>`}
                        <button class="btn" data-action="${f.SELL_SHIP}" data-ship-id="${t}" ${v?"":"disabled"}>Sell<br>\u232C ${S(T,!1)}</button>
                    </div>
                </div>`}let o=this.cache.shipDetailModal,c=o.querySelector("#ship-detail-content");c.innerHTML=r,o.classList.remove("hidden"),o.classList.add("modal-visible")}showLaunchModal(e){let t=this.lastKnownState;if(!t)return;let i=d.MARKETS.find(u=>u.id===e);if(!i)return;let a=i.navTheme,s=t.TRAVEL_DATA[t.currentLocationId]?.[e],n=t.player.shipStates[t.player.activeShipId];if(!s)return;let r=`
            <div class="launch-modal-wrapper panel-border" style="background: ${a.gradient}; color: ${a.textColor}; border-color: ${a.borderColor};">
                <div class="flex-shrink-0">
                    <h3 class="font-orbitron">${i.name}</h3>
                    <p class="flavor-text italic">${i.launchFlavor}</p>
                </div>
    
                <div class="flex-grow flex items-center justify-center"> 
                   <button class="btn-launch-glow" data-action="travel" data-location-id="${e}" style="--launch-glow-color: ${a.borderColor};">Launch</button>
                </div>
    
                <div class="travel-info-text"> 
                    <p>Travel Time: ${s.time} Days</p>
                    <p>Fuel: ${Math.floor(n.fuel)} / ${s.fuelCost} required</p>
                </div>
            </div>`,o=this.cache.launchModal;this.cache.launchModalContent.innerHTML=r,o.classList.remove("hidden"),o.classList.add("modal-visible");let c=u=>{u.target.id==="launch-modal"&&(this.hideModal("launch-modal"),o.removeEventListener("click",c))};o.addEventListener("click",c)}showCargoDetailModal(e,t){let i=d.COMMODITIES.find(r=>r.id===t),a=e.player.inventories[e.player.activeShipId]?.[t];if(!i||!a)return;let s=this.cache.cargoDetailModal,n=this.cache.cargoDetailContent;n.innerHTML=$e(i,a),s.classList.remove("hidden"),s.classList.add("modal-visible")}renderStickyBar(e){let t=this.cache.missionStickyBar,i=t.querySelector(".sticky-content"),a=this.cache.stickyObjectiveText,s=this.cache.stickyObjectiveProgress;if(e.missions.activeMissionId){let n=d.MISSIONS[e.missions.activeMissionId];if(!n.objectives||n.objectives.length===0){t.style.display="none";return}let r=e.missions.missionProgress[n.id]||{objectives:{}},o=n.objectives[0],c=r.objectives[o.goodId]?.current??0,u=o.quantity,h=d.COMMODITIES.find(T=>T.id===o.goodId).name,m=d.MARKETS.find(T=>T.id===n.completion.locationId).name;a.textContent=`Deliver ${h} to ${m}`,s.textContent=`[${c}/${u}]`;let p=`host-${n.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,v=e.missions.activeMissionObjectivesMet&&n.completion.locationId===e.currentLocationId?"mission-turn-in":"";i.className=`sticky-content sci-fi-frame ${p} ${v}`,t.style.display="block"}else t.style.display="none"}showMissionModal(e){let t=d.MISSIONS[e];if(!t)return;let{missions:i,currentLocationId:a}=this.lastKnownState,{activeMissionId:s,activeMissionObjectivesMet:n}=i;s===e&&n&&t.completion.locationId===a?this._showMissionCompletionModal(t):this._showMissionDetailsModal(t)}_showMissionDetailsModal(e){let{missions:t,tutorials:i}=this.lastKnownState,a=t.activeMissionId===e.id,n=t.activeMissionId&&!a;e.id==="mission_tutorial_02"&&i.activeBatchId==="intro_missions"&&i.activeStepId!=="mission_2_4"&&(n=!0);let r={customSetup:(o,c)=>{let u=o.querySelector(".modal-content");u.className="modal-content sci-fi-frame flex flex-col items-center text-center";let h=`host-${e.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`;u.classList.add(h),o.querySelector("#mission-modal-type").textContent=e.type;let m=o.querySelector("#mission-modal-objectives"),p='<h6 class="font-bold text-sm uppercase tracking-widest text-gray-400 text-center">OBJECTIVES:</h6><ul class="list-disc list-inside text-gray-300">'+e.objectives.map(I=>`<li>Deliver ${I.quantity}x ${d.COMMODITIES.find(R=>R.id===I.goodId).name}</li>`).join("")+"</ul>";m.innerHTML=p,m.style.display="block";let v=o.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let I=e.rewards.map(R=>R.type==="credits"?`\u232C ${R.amount.toLocaleString()}`:R.type.toUpperCase()).join(", ");v.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${I}</p>`,v.style.display="block"}else v.innerHTML="",v.style.display="none";let T=o.querySelector("#mission-modal-buttons");if(a){let I=e.isAbandonable!==!1;T.innerHTML=`<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${e.id}" ${I?"":"disabled"}>Abandon Mission</button>`}else T.innerHTML=`<button class="btn w-full" data-action="accept-mission" data-mission-id="${e.id}" ${n?"disabled":""}>Accept</button>`}};e.id==="mission_tutorial_01"&&i.activeStepId==="mission_1_1"&&(n=!0),this.queueModal("mission-modal",e.name,e.description,null,r)}_showMissionCompletionModal(e){let t={customSetup:(i,a)=>{let s=i.querySelector(".modal-content");s.className="modal-content sci-fi-frame flex flex-col items-center text-center";let n=`host-${e.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`;s.classList.add(n),i.querySelector("#mission-modal-title").textContent=e.completion.title,i.querySelector("#mission-modal-type").textContent="OBJECTIVES MET",i.querySelector("#mission-modal-description").innerHTML=e.completion.text;let r=i.querySelector("#mission-modal-objectives");r.style.display="none";let o=i.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let u=e.rewards.map(h=>h.type==="credits"?`\u232C ${h.amount.toLocaleString()}`:h.type.toUpperCase()).join(", ");o.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${u}</p>`,o.style.display="block"}else o.innerHTML="",o.style.display="none";let c=i.querySelector("#mission-modal-buttons");c.innerHTML=`<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${e.id}">${e.completion.buttonText}</button>`}};this.queueModal("mission-modal",e.completion.title,e.completion.text,null,t)}flashObjectiveProgress(){let e=this.cache.stickyObjectiveProgress;e&&(e.classList.add("objective-progress-flash"),setTimeout(()=>{e.classList.remove("objective-progress-flash")},700))}getModalIdFromEvent(e){let t=e.target.closest(".modal-backdrop");return t&&t.id&&!t.classList.contains("dismiss-disabled")&&!e.target.closest(".modal-content")?t.id:null}isClickInside(e,t){return e.target.closest(t)!==null}getTooltipContent(e){let t=e.target.closest("[data-tooltip]");return t?t.dataset.tooltip:null}showGameContainer(){this.cache.gameContainer.classList.remove("hidden"),this._setAppHeight(),requestAnimationFrame(()=>{this._setAppHeight()})}showMapDetailModal(e){let t=d.MARKETS.find(h=>h.id===e);if(!t)return;let i=this.cache.mapDetailModal,a=i.querySelector("#map-modal-content-container"),s=t.navTheme,n=[],r=[];if(t.availabilityModifier)for(let[h,m]of Object.entries(t.availabilityModifier)){let p=d.COMMODITIES.find(v=>v.id===h);if(p){let v={name:p.name,style:q(p.styleClass)};m<1?n.push(v):m>1&&r.push(v)}}let o=h=>h.map(m=>`<span class="commodity-tag" style="border-color: ${m.style.hex}; background-color: ${m.style.hex}20; color: ${m.style.hex};">${m.name}</span>`).join(""),c=`
            <div class="text-center">
                <h3 class="text-3xl font-orbitron" style="color: ${s.textColor};">${t.name}</h3>
                <p class="text-lg italic imprinted-text">${t.launchFlavor}</p>
            </div>
            <div class="my-4 p-4 rounded-lg" style="background-color: rgba(0,0,0,0.3);">
                <h4 class="text-xl font-orbitron text-center mb-2 imprinted-text">Intel Report</h4>
                <div class="text-center font-roboto-mono space-y-1 imprinted-text">
                    <p><b>Position:</b> ${t.distance} AU</p>
                    <p><b>Quirk:</b> ${t.specialty}</p>
                    <p><b>Services:</b> Fuel @ ${S(t.fuelPrice,!0)}/unit</p>
                </div>
            </div>
            <div class="text-center">
                <div>
                    <h5 class="font-bold">Primary Exports:</h5>
                    <div>${r.length>0?o(r):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
                <div class="mt-2">
                    <h5 class="font-bold">Primary Imports:</h5>
                    <div>${n.length>0?o(n):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
            </div>
        `;a.innerHTML=c,i.classList.remove("hidden"),requestAnimationFrame(()=>{i.classList.add("modal-visible")});let u=h=>{(!h.target.closest(".modal-content")||h.target.closest('[data-action="close-map-modal"]'))&&(this.hideMapDetailModal(),i.removeEventListener("click",u))};i.addEventListener("click",u)}hideMapDetailModal(){this.hideModal("map-detail-modal")}};var se=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a}handle(e,t){let i=this.gameState.getState();if(t.hasAttribute("disabled"))return;let{action:a,...s}=t.dataset,n=null;switch(a){case f.BUY_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation(),this.simulationService.buyShip(r,e),n={type:"ACTION",action:f.BUY_SHIP};break}case f.SELL_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation(),this.simulationService.sellShip(r,e);break}case f.SELECT_SHIP:{let{shipId:r}=s;if(!r)return;this.simulationService.setActiveShip(r),n={type:"ACTION",action:f.SELECT_SHIP};break}case f.TOGGLE_HANGAR_MODE:s.mode&&this.gameState.uiState.hangarShipyardToggleState!==s.mode&&(this.gameState.uiState.hangarShipyardToggleState=s.mode,this.gameState.setState({}));break;case f.SET_HANGAR_PAGE:{let r=parseInt(s.index,10),o=this.gameState.uiState.hangarShipyardToggleState==="hangar",c=document.getElementById("hangar-carousel");if(c){let u=o?this.gameState.uiState.hangarActiveIndex:this.gameState.uiState.shipyardActiveIndex,h=Math.abs(r-u),m=Math.min(.8,.2+h*.1);c.style.transitionDuration=`${m}s`,this.simulationService.setHangarCarouselIndex(r,o?"hangar":"shipyard"),setTimeout(()=>{c&&(c.style.transitionDuration="")},m*1e3)}else this.simulationService.setHangarCarouselIndex(r,o?"hangar":"shipyard");break}case f.SET_SCREEN:s.navId===i.activeNav&&t.tagName==="DIV"?(this.gameState.subNavCollapsed=!this.gameState.subNavCollapsed,this.uiManager.render(this.gameState.getState())):(this.gameState.subNavCollapsed=!1,this.simulationService.setScreen(s.navId,s.screenId)),n={type:"ACTION",action:f.SET_SCREEN,navId:s.navId,screenId:s.screenId};break;case f.TRAVEL:this.uiManager.hideModal("launch-modal"),this.simulationService.travelTo(s.locationId),n={type:"ACTION",action:f.TRAVEL};break;case"show-mission-modal":this.uiManager.showMissionModal(s.missionId),n={type:"ACTION",action:"show-mission-modal"};break;case"show_cargo_detail":this.uiManager.showCargoDetailModal(i,s.goodId);break;case"show-launch-modal":this.uiManager.showLaunchModal(s.locationId);break;case"show-map-modal":this.uiManager.showMapDetailModal(s.locationId);break;case"close-map-modal":this.uiManager.hideMapDetailModal();break;case"accept-mission":this.simulationService.missionService.acceptMission(s.missionId),this.uiManager.hideModal("mission-modal"),n={type:"ACTION",action:"accept-mission",missionId:s.missionId};break;case"abandon-mission":this.simulationService.missionService.abandonMission(),this.uiManager.hideModal("mission-modal");break;case"complete-mission":this.simulationService.missionService.completeActiveMission(),this.uiManager.hideModal("mission-modal"),n={type:"ACTION",action:"complete-mission"};break;case f.PAY_DEBT:this.simulationService.payOffDebt();break;case f.TAKE_LOAN:this.simulationService.takeLoan(JSON.parse(s.loanDetails));break;case f.PURCHASE_INTEL:this.simulationService.purchaseIntel(parseInt(s.cost));break;case f.ACQUIRE_LICENSE:this._handleAcquireLicense(s.licenseId);break;case f.TOGGLE_MARKET_CARD_VIEW:s.goodId&&(this.gameState.uiState.marketCardMinimized[s.goodId]=!this.gameState.uiState.marketCardMinimized[s.goodId],this.gameState.setState({}));break}n&&this.tutorialService.checkState(n)}_handleAcquireLicense(e){let t=d.LICENSES[e];if(t)if(t.type==="purchase"){let i=`${t.description}<br><br>Cost: <b class='hl-yellow'>${formatCredits(t.cost)}</b>`;this.uiManager.queueModal("event-modal",`Purchase ${t.name}?`,i,null,{customSetup:(a,s)=>{let n=a.querySelector("#event-button-container");n.innerHTML=`
                        <button id="confirm-license-purchase" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-license-purchase" class="btn">Cancel</button>
                    `,a.querySelector("#confirm-license-purchase").onclick=()=>{let r=this.simulationService.purchaseLicense(e);!r.success&&r.error==="INSUFFICIENT_FUNDS"&&this.uiManager.queueModal("event-modal","Purchase Failed",`You cannot afford the ${formatCredits(t.cost)} fee for this license.`),s()},a.querySelector("#cancel-license-purchase").onclick=s}})}else t.type==="mission"&&this.uiManager.queueModal("event-modal",t.name,t.guidanceText)}};var ne=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.uiManager=i}handleInput(e){let t=e.target.closest('.transaction-controls input[type="number"]');if(t){let i=t.closest(".transaction-controls"),{goodId:a,mode:s}=i.dataset,n=parseInt(t.value,10)||0;this.uiManager.updateMarketCardDisplay(a,n,s)}}handleClick(e,t){let{action:i}=t.dataset;switch(i){case"toggle-trade-mode":case"confirm-trade":case"set-max-trade":case f.INCREMENT:case f.DECREMENT:this._performMarketAction(t,i,e);break}}_performMarketAction(e,t,i){let a=e.closest(".transaction-controls");if(!a)return;let{goodId:s,mode:n}=a.dataset,r=a.querySelector("input"),o=this.gameState.getState();switch(t){case"toggle-trade-mode":{let c=n==="buy"?"sell":"buy";a.dataset.mode=c,this.uiManager.updateMarketCardDisplay(s,parseInt(r.value)||0,c);break}case"confirm-trade":{let c=parseInt(r.value)||0;if(c<=0)return;let u=n==="buy"?this.simulationService.buyItem(s,c):this.simulationService.sellItem(s,c);if(u){let h=n==="buy"?this.uiManager.getItemPrice(o,s)*c:u,m=n==="buy"?`-${S(h,!1)}`:`+${S(h,!1)}`,p=n==="buy"?"#f87171":"#34d399";if(this.uiManager.createFloatingText(m,i.clientX,i.clientY,p),n==="sell"){let v={type:"ACTION",action:"sell-item",goodId:s};this.simulationService.tutorialService.checkState(v)}}break}case"set-max-trade":{let c=this.simulationService._getActiveShip(),u=this.simulationService._getActiveInventory();if(n==="sell")r.value=u[s]?.quantity||0;else{let h=this.uiManager.getItemPrice(o,s),m=c.cargoCapacity-N(u),p=h>0?Math.floor(o.player.credits/h):1/0,v=o.market.inventory[o.currentLocationId][s].quantity;r.value=Math.max(0,Math.min(m,p,v))}this.uiManager.updateMarketCardDisplay(s,parseInt(r.value)||0,n);break}case f.INCREMENT:case f.DECREMENT:{let c=parseInt(r.value)||0;r.value=t===f.INCREMENT?c+1:Math.max(0,c-1),this.uiManager.updateMarketCardDisplay(s,parseInt(r.value)||0,n);break}}}};var re=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.uiManager=i,this.refuelInterval=null,this.repairInterval=null}handleHoldStart(e){e.target.closest("#refuel-btn")&&this._startRefueling(e.type==="touchstart"),e.target.closest("#repair-btn")&&this._startRepairing(e.type==="touchstart")}handleHoldEnd(){this._stopRefueling(),this._stopRepairing()}_startRefueling(e=!1){this.gameState.isGameOver||this.refuelInterval||(this._refuelTick(),this.refuelInterval=setInterval(()=>this._refuelTick(),e?200:1e3))}_stopRefueling(){clearInterval(this.refuelInterval),this.refuelInterval=null}_refuelTick(){let e=this.simulationService.refuelTick(),t=this.uiManager.cache.servicesScreen?.querySelector("#refuel-btn");if(e>0&&t){let i=t.getBoundingClientRect();this.uiManager.createFloatingText(`-${S(e,!1)}`,i.left+i.width/2,i.top,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRefueling()}_startRepairing(e=!1){this.gameState.isGameOver||this.repairInterval||(this._repairTick(),this.repairInterval=setInterval(()=>this._repairTick(),e?200:1e3))}_stopRepairing(){clearInterval(this.repairInterval),this.repairInterval=null}_repairTick(){let e=this.simulationService.repairTick(),t=this.uiManager.cache.servicesScreen?.querySelector("#repair-btn");if(e>0&&t){let i=t.getBoundingClientRect();this.uiManager.createFloatingText(`-${S(e,!1)}`,i.left+i.width/2,i.top,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRepairing()}};var oe=class{constructor(e,t){this.gameState=e,this.simulationService=t,this.isScrolling=!1,this.scrollTimeout=null,this.state={isDragging:!1,startX:0,startTranslate:0,currentTranslate:0,activeCarousel:null,containerWidth:0,pageCount:0,currentIndex:0,moved:!1}}handleWheel(e){if(this.isScrolling)return;let t=e.deltaY>0?"next":"prev";this.simulationService.cycleHangarCarousel(t),this.isScrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1},300)}handleDragStart(e){let t=e.target.closest(".carousel-container"),i=t?t.querySelector("#hangar-carousel"):null;if(e.target.closest(".action-button")||!i||i.children.length<=1){this.state.isDragging=!1;return}e.preventDefault();let a=this.gameState.getState(),s=a.uiState.hangarShipyardToggleState==="hangar";this.state.isDragging=!0,this.state.activeCarousel=i,this.state.startX=e.pageX??e.touches[0].pageX,this.state.containerWidth=i.parentElement.offsetWidth,this.state.pageCount=i.children.length,this.state.currentIndex=s?a.uiState.hangarActiveIndex||0:a.uiState.shipyardActiveIndex||0,this.state.startTranslate=-this.state.currentIndex*this.state.containerWidth,this.state.currentTranslate=this.state.startTranslate,this.state.moved=!1,i.style.transitionDuration="0s",document.body.style.cursor="grabbing"}handleDragMove(e){if(!this.state.isDragging)return;e.preventDefault();let i=(e.pageX??e.touches[0].pageX)-this.state.startX;this.state.currentTranslate=this.state.startTranslate+i,Math.abs(i)>10&&(this.state.moved=!0),this.state.activeCarousel&&(this.state.activeCarousel.style.transform=`translateX(${this.state.currentTranslate}px)`)}handleDragEnd(){if(!this.state.isDragging)return;let{activeCarousel:e,startTranslate:t,currentTranslate:i,currentIndex:a,containerWidth:s,pageCount:n}=this.state;if(this.state.isDragging=!1,document.body.style.cursor="default",!e)return;e.style.transitionDuration="";let r=i-t,o=a,c=s/4;r<-c&&a<n-1?o++:r>c&&a>0&&o--;let u=this.gameState.uiState.hangarShipyardToggleState;this.simulationService.setHangarCarouselIndex(o,u),setTimeout(()=>{this.state.moved=!1},50)}wasMoved(){return this.state.moved}};var le=class{constructor(e,t){this.gameState=e,this.uiManager=t,this.activeTooltipTarget=null,this.activeStatusTooltip=null}handleClick(e){let t=e.target.closest("[data-action]");if(this.activeStatusTooltip&&!this.uiManager.isClickInside(e,'[data-action="toggle-tooltip"]')&&(this.activeStatusTooltip.classList.remove("visible"),this.activeStatusTooltip=null),this.uiManager.isClickInside(e,"#graph-tooltip, #generic-tooltip")){this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null;return}if(this.activeTooltipTarget&&t!==this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null),t){let{action:i}=t.dataset;switch(i){case"toggle-tooltip":this._toggleStatusTooltip(t);return;case f.SHOW_PRICE_GRAPH:case f.SHOW_FINANCE_GRAPH:this.uiManager.isMobile&&(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget===t?(this.uiManager.hideGraph(),this.activeTooltipTarget=null):(this.uiManager.showGraph(t,this.gameState.getState()),this.activeTooltipTarget=t));break}}this.uiManager.isMobile&&this._handleMobileTooltip(e),this._handleLoreAndTutorialLog(e)}handleMouseOver(e){if(this.uiManager.isMobile)return;let t=e.target.closest(`[data-action="${f.SHOW_PRICE_GRAPH}"], [data-action="${f.SHOW_FINANCE_GRAPH}"]`);t&&this.uiManager.showGraph(t,this.gameState.getState())}handleMouseOut(e){if(this.uiManager.isMobile)return;e.target.closest(`[data-action="${f.SHOW_PRICE_GRAPH}"], [data-action="${f.SHOW_FINANCE_GRAPH}"]`)&&this.uiManager.hideGraph()}_toggleStatusTooltip(e){let t=e.querySelector(".status-tooltip");t&&(this.activeStatusTooltip===t?(t.classList.remove("visible"),this.activeStatusTooltip=null):(this.activeStatusTooltip&&this.activeStatusTooltip.classList.remove("visible"),t.classList.add("visible"),this.activeStatusTooltip=t))}_handleMobileTooltip(e){let t=e.target.closest("[data-tooltip]");t&&!t.closest('[data-action="toggle-tooltip"]')&&(this.uiManager.hideGraph(),this.activeTooltipTarget===t?(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null):(this.uiManager.showGenericTooltip(t,t.dataset.tooltip),this.activeTooltipTarget=t))}_handleLoreAndTutorialLog(e){let t=e.target.closest(".tutorial-container"),i=e.target.closest(".lore-container"),a=document.querySelector(".lore-tooltip.visible, .tutorial-tooltip.visible");a&&!e.target.closest(".lore-tooltip, .tutorial-tooltip")&&a.classList.remove("visible"),i&&i.querySelector(".lore-tooltip")?.classList.toggle("visible"),t&&this.uiManager.showTutorialLogModal({seenBatches:this.gameState.tutorials.seenBatchIds,onSelect:s=>this.tutorialService.triggerBatch(s)})}};var ce=class{constructor(e,t,i,a,s=null,n){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a,this.debugService=s,this.logger=n,this.actionClickHandler=new se(e,t,i,a),this.marketEventHandler=new ne(e,t,i),this.holdEventHandler=new re(e,t,i),this.carouselEventHandler=new oe(e,t),this.tooltipHandler=new le(e,i)}bindEvents(){document.body.addEventListener("click",i=>this._handleClick(i)),document.body.addEventListener("dblclick",i=>i.preventDefault()),document.body.addEventListener("mouseover",i=>this.tooltipHandler.handleMouseOver(i)),document.body.addEventListener("mouseout",i=>this.tooltipHandler.handleMouseOut(i)),document.addEventListener("keydown",i=>this._handleKeyDown(i)),document.body.addEventListener("input",i=>this.marketEventHandler.handleInput(i)),document.body.addEventListener("contextmenu",i=>i.preventDefault()),document.body.addEventListener("wheel",i=>{i.target.closest(".carousel-container")&&(i.preventDefault(),this.carouselEventHandler.handleWheel(i))},{passive:!1});let e=i=>{this.holdEventHandler.handleHoldStart(i),this.carouselEventHandler.handleDragStart(i)};document.body.addEventListener("mousedown",e),document.body.addEventListener("touchstart",i=>{(i.target.closest("#refuel-btn")||i.target.closest("#repair-btn"))&&i.preventDefault(),e(i)},{passive:!1});let t=()=>{this.holdEventHandler.handleHoldEnd(),this.carouselEventHandler.handleDragEnd()};document.body.addEventListener("mouseup",t),document.body.addEventListener("mouseleave",t),document.body.addEventListener("touchend",t),document.body.addEventListener("touchcancel",t),document.body.addEventListener("mousemove",i=>this.carouselEventHandler.handleDragMove(i)),document.body.addEventListener("touchmove",i=>this.carouselEventHandler.handleDragMove(i),{passive:!1}),window.addEventListener("resize",()=>this.uiManager.render(this.gameState.getState())),this.uiManager.cache.missionStickyBar&&this.uiManager.cache.missionStickyBar.addEventListener("click",()=>{this.simulationService.setScreen(M.DATA,y.MISSIONS)})}_handleClick(e){if(this.carouselEventHandler.wasMoved()){e.preventDefault();return}let t=this.gameState.getState(),i=e.target.closest("[data-action]");if(this.tooltipHandler.handleClick(e),i){this.actionClickHandler.handle(e,i),this.marketEventHandler.handleClick(e,i);return}if(t.introSequenceActive&&!t.tutorials.activeBatchId){this.simulationService.handleIntroClick(e);return}if(t.isGameOver)return;let a=this.uiManager.getModalIdFromEvent(e);a&&this.uiManager.hideModal(a)}_handleKeyDown(e){this.gameState.isGameOver||e.ctrlKey||e.metaKey||(e.key==="`"||e.key==="&")&&this.debugService&&this.debugService.toggleVisibility()}};var de=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.simulationService=i,this.logger=s,this.activeBatchId=null,this.activeStepId=null,this.screenToNavMap={};for(let n in a)for(let r in a[n].screens)this.screenToNavMap[r]=n}checkState(e=null){if(this.activeBatchId&&this.activeStepId){let i=d.TUTORIAL_DATA[this.activeBatchId].steps.find(a=>a.stepId===this.activeStepId);i&&this._matchesCondition(i.completion,e)&&this.advanceStep();return}for(let t in d.TUTORIAL_DATA){let i=d.TUTORIAL_DATA[t],a=this.gameState.tutorials.seenBatchIds.includes(t),s=this.gameState.tutorials.skippedTutorialBatches.includes(t);if(!a&&!s){let n=e||{type:w.SCREEN_LOAD,screenId:this.gameState.activeScreen};if(this._matchesCondition(i.trigger,n)){this.triggerBatch(t);break}}}}triggerBatch(e,t=null){if(!d.TUTORIAL_DATA[e])return;let i=d.TUTORIAL_DATA[e];if(i.trigger.type===w.SCREEN_LOAD){let s=i.trigger.screenId;if(this.gameState.activeScreen!==s){let n=this.screenToNavMap[s];n&&this.simulationService.setScreen(n,s)}}this.activeBatchId=e,this.gameState.tutorials.activeBatchId=e,this.gameState.tutorials.seenBatchIds.includes(e)||this.gameState.tutorials.seenBatchIds.push(e),this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_START",`Starting tutorial batch: ${e}`),this.gameState.setState(this.gameState),this.uiManager.render(this.gameState.getState());let a=t||i.steps[0].stepId;this._displayStep(a)}skipActiveTutorial(){this.activeBatchId&&(this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)||this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId),this.logger.info.player(this.gameState.day,"TUTORIAL_SKIP",`Skipped tutorial: ${this.activeBatchId}`),this._endBatch(),this.gameState.setState(this.gameState))}advanceStep(){if(!this.activeStepId||!this.activeBatchId)return;let t=d.TUTORIAL_DATA[this.activeBatchId].steps.find(i=>i.stepId===this.activeStepId);if(this.uiManager.hideTutorialToast(),t&&t.nextStepId)this._displayStep(t.nextStepId);else{let i=this.activeBatchId;this._endBatch(),this.gameState.introSequenceActive&&i?.startsWith("intro_")&&this.simulationService._continueIntroSequence(i)}}_displayStep(e){if(!this.activeBatchId)return;let t=d.TUTORIAL_DATA[this.activeBatchId],i=t.steps.find(a=>a.stepId===e);if(!i){this._endBatch();return}if(i.hasOwnProperty("navLock"))this.gameState.tutorials.navLock=i.navLock;else if(t.navLock){let a=this.gameState.activeScreen,s=this.screenToNavMap[a];this.gameState.tutorials.navLock={navId:s,screenId:a}}else this.gameState.tutorials.navLock=null;this.activeStepId=e,this.gameState.tutorials.activeStepId=e,this.logger.info.system("Tutorial",this.gameState.day,"STEP_DISPLAY",`Displaying step: ${e}`),this.uiManager.showTutorialToast({step:i,onSkip:()=>this.uiManager.showSkipTutorialModal(()=>this.skipActiveTutorial()),onNext:()=>this.advanceStep(),gameState:this.gameState.getState()}),this.uiManager.render(this.gameState.getState())}_endBatch(){this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_END",`Ending tutorial batch: ${this.activeBatchId}`),this.uiManager.hideTutorialToast(),this.activeBatchId=null,this.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.navLock=null}_matchesCondition(e,t){return!e||!t?!1:Array.isArray(e)?e.every(i=>this._matchesSingleCondition(i,t)):this._matchesSingleCondition(e,t)}_matchesSingleCondition(e,t){if(e.type!==t.type)return!1;switch(e.type){case w.SCREEN_LOAD:return e.screenId===t.screenId;case w.ACTION:return e.action===f.SET_SCREEN&&t.action===f.SET_SCREEN?e.navId===t.navId&&e.screenId===t.screenId:e.action===t.action;case w.INFO:return!0;default:return!1}}};var he=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=null}setSimulationService(e){this.simulationService=e}arePrerequisitesMet(e){let t=d.MISSIONS[e];return!t||!t.prerequisites?!0:t.prerequisites.every(i=>{switch(i.type){case"mission_completed":return this.gameState.missions.completedMissionIds.includes(i.missionId);case"revealed_tier":return this.gameState.player.revealedTier>=i.tier;default:return!1}})}getAvailableMissions(){let{activeMissionId:e,completedMissionIds:t}=this.gameState.missions;return Object.values(d.MISSIONS).filter(i=>i.id!==e&&!t.includes(i.id)&&this.arePrerequisitesMet(i.id))}acceptMission(e){let t=d.MISSIONS[e];this.gameState.missions.activeMissionId||!t||!this.arePrerequisitesMet(e)||(this.gameState.missions.activeMissionId=e,this.gameState.missions.missionProgress[e]={objectives:{}},this.logger.info.player(this.gameState.day,"MISSION_ACCEPT",`Accepted mission: ${e}`),this.simulationService.grantMissionCargo(e),this.checkTriggers(),!t.objectives||t.objectives.length===0?this.completeActiveMission():this.uiManager.render(this.gameState.getState()))}abandonMission(){let e=this.gameState.missions.activeMissionId;e&&(this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.logger.info.player(this.gameState.day,"MISSION_ABANDON",`Abandoned mission: ${e}`),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}checkTriggers(){let{activeMissionId:e}=this.gameState.missions;if(!e){this.gameState.missions.activeMissionObjectivesMet&&(this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}));return}let t=d.MISSIONS[e],i=this.gameState.player.inventories[this.gameState.player.activeShipId];if(!t||!i){this.gameState.missions.activeMissionObjectivesMet=!1;return}let a=!0,s=!1;t.objectives.forEach(n=>{if(n.type==="have_item"){let r=i[n.goodId]?.quantity||0,o=this.gameState.missions.missionProgress[e];o.objectives[n.goodId]||(o.objectives[n.goodId]={current:0}),o.objectives[n.goodId].current!==r&&(o.objectives[n.goodId].current=r,s=!0),r<n.quantity&&(a=!1)}}),(this.gameState.missions.activeMissionObjectivesMet!==a||s)&&(a&&!this.gameState.missions.activeMissionObjectivesMet&&this.logger.info.player(this.gameState.day,"OBJECTIVES_MET",`All objectives for mission ${e} are met.`),this.gameState.missions.activeMissionObjectivesMet=a,this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),s&&this.uiManager.flashObjectiveProgress())}completeActiveMission(){let{activeMissionId:e}=this.gameState.missions;if(!e)return;let t=this.gameState.missions.activeMissionObjectivesMet,i=d.MISSIONS[e];if((!i.objectives||i.objectives.length===0)&&(this.gameState.missions.activeMissionObjectivesMet=!0),!this.gameState.missions.activeMissionObjectivesMet){this.gameState.missions.activeMissionObjectivesMet=t;return}let a=this.gameState.player.inventories[this.gameState.player.activeShipId];i.objectives.forEach(s=>{s.type==="have_item"&&a[s.goodId]&&(a[s.goodId].quantity-=s.quantity)}),this.simulationService&&this.simulationService._grantRewards(i.rewards,i.name),this.logger.info.player(this.gameState.day,"MISSION_COMPLETE",`Completed mission: ${e}`),this.uiManager.triggerEffect("systemSurge",{theme:"gold"}),this.gameState.missions.completedMissionIds.push(e),this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}};var O={DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},G={player:"#60a5fa",system:"#4ade80",state:"#facc15",warn:"#f59e0b",error:"#f87171",group:"#d4d4d8"},Qe=100,$=O.INFO,ue=[];function Y(l){ue.push(l),ue.length>Qe&&ue.shift()}function ve(l,e,t,i,a,s,n=null){if(l>$)return;let r=`[${e}] [Day ${t}] ${i}: ${a}`;Y(r),console.log(`%c[${e}] %c[Day ${t}] %c${i}: %c${a}`,`color: ${s}; font-weight: bold;`,"color: #9ca3af;","color: #e5e7eb; font-weight: bold;","color: inherit;",n||""),n&&console.dir(n)}var H={setLevel:l=>{let e=O[l.toUpperCase()];typeof e<"u"?($=e,console.log(`%c[Logger] Log level set to: ${l}`,`color: ${G.state}; font-weight: bold;`)):H.warn("LoggingService",`Attempted to set invalid log level: ${l}`)},getLogHistory:()=>ue.join(`
`),info:{player:(l,e,t,i=null)=>ve(O.INFO,"Player",l,e,t,G.player,i),system:(l,e,t,i,a=null)=>ve(O.INFO,l,e,t,i,G.system,a),state:(l,e,t,i=null)=>ve(O.INFO,"Game",l,e,t,G.state,i)},warn:(l,e)=>{if(O.WARN>$)return;let t=`[${l}] WARN: ${e}`;Y(t),console.warn(`%c[${l}] WARN:`,`color: ${G.warn}; font-weight: bold;`,e)},error:(l,e,t=null)=>{if(O.ERROR>$)return;let i=`[${l}] ERROR: ${e}`;Y(i),console.error(`%c[${l}] ERROR:`,`color: ${G.error}; font-weight: bold;`,e,t||"")},group:l=>{O.DEBUG>$||(Y(`--- GROUP START: ${l} ---`),console.groupCollapsed(`%c${l}`,`color: ${G.group}; font-style: italic;`))},groupEnd:()=>{O.DEBUG>$||(console.groupEnd(),Y("--- GROUP END ---"))},time:l=>{O.DEBUG>$||console.time(l)},timeEnd:l=>{O.DEBUG>$||console.timeEnd(l)}};var ye=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.logger=i,this.isRunning=!1,this.stopRequested=!1}async runSimulation({daysToRun:e},t){if(this.isRunning){this.logger.warn("AutomatedPlayer","AUTOTRADER-01 is already running.");return}this.isRunning=!0,this.stopRequested=!1;let i=this.gameState.day,a=i+e;for(this.logger.info.system("Bot",i,"SIMULATION_START",`Starting simulation for ${e} days.`);this.gameState.day<a&&!this.stopRequested;){let s=this.simulationService._getActiveShip();if(s){let r=this.gameState.player.shipStates[s.id].fuel/s.maxFuel*100,o=this.gameState.player.shipStates[s.id].health/s.maxHealth*100;r<30&&(this.logger.info.system("Bot",this.gameState.day,"REFUEL",`Low fuel (${r.toFixed(1)}%). Refueling.`),this.botRefuel()),o<30&&(this.logger.info.system("Bot",this.gameState.day,"REPAIR",`Low hull integrity (${o.toFixed(1)}%). Repairing.`),this.botRepair())}let n=this._findBestTradeRoute();if(n){this.logger.group(`[Bot] [Day ${this.gameState.day}] Executing Trade Route: ${n.goodId}`),this.gameState.currentLocationId!==n.buyLocationId&&this.simulationService.travelService.initiateTravel(n.buyLocationId);let r=this._calculateMaxBuy(n.goodId,n.buyPrice);r>0&&this.simulationService.playerActionService.buyItem(n.goodId,r),this.gameState.currentLocationId!==n.sellLocationId&&this.simulationService.travelService.initiateTravel(n.sellLocationId);let o=this.simulationService._getActiveInventory()[n.goodId]?.quantity||0;o>0&&this.simulationService.playerActionService.sellItem(n.goodId,o),this.logger.groupEnd()}else this.simulationService.timeService.advanceDays(1);t(this.gameState.day,a),await new Promise(r=>setTimeout(r,10))}this.logger.info.system("Bot",this.gameState.day,"SIMULATION_END","Simulation finished."),this.isRunning=!1}stop(){this.stopRequested=!0}botRefuel(){let e=this.simulationService._getActiveShip();if(!e)return;let t=e.maxFuel-this.gameState.player.shipStates[e.id].fuel;if(t<=0)return;let a=d.MARKETS.find(n=>n.id===this.gameState.currentLocationId).fuelPrice/2,s=t/5*a;this.gameState.player.credits>=s&&(this.gameState.player.credits-=s,this.gameState.player.shipStates[e.id].fuel=e.maxFuel)}botRepair(){let e=this.simulationService._getActiveShip();if(!e)return;let t=e.maxHealth-this.gameState.player.shipStates[e.id].health;if(t<=0)return;let i=t*GAME_RULES.REPAIR_COST_PER_HP;this.gameState.player.credits>=i&&(this.gameState.player.credits-=i,this.gameState.player.shipStates[e.id].health=e.maxHealth)}_calculateMaxBuy(e,t){let i=this.gameState.getState(),a=this.simulationService._getActiveShip(),s=this.simulationService._getActiveInventory(),n=a.cargoCapacity-Object.values(s).reduce((c,u)=>c+u.quantity,0),r=t>0?Math.floor(i.player.credits/t):n,o=i.market.inventory[i.currentLocationId][e].quantity;return Math.max(0,Math.min(n,r,o))}_findBestTradeRoute(){let e=this.gameState.getState(),t=null,i=0,a=d.COMMODITIES.filter(s=>s.tier<=e.player.revealedTier);for(let s of a)for(let n of d.MARKETS)if(e.player.unlockedLocationIds.includes(n.id))for(let r of d.MARKETS){if(n.id===r.id||!e.player.unlockedLocationIds.includes(r.id))continue;let o=e.market.prices[n.id][s.id],c=e.market.prices[r.id][s.id],u=c-o;if(u>0){let h=e.TRAVEL_DATA[e.currentLocationId]?.[n.id]?.time||0,m=e.TRAVEL_DATA[n.id]?.[r.id]?.time||0,p=h+m+1,v=u/p;v>i&&(i=v,t={goodId:s.id,buyLocationId:n.id,sellLocationId:r.id,buyPrice:o,sellPrice:c,profitPerUnit:u})}}return t}},me=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.logger=a,this.gui=null,this.active=!1,this.diagActive=!1,this.diagElements={},this.actions={},this.debugState={},this.bot=new ye(e,t,a)}init(){this.gui||(this._cacheDiagElements(),this.gui=new lil.GUI,this.gui.domElement.style.display="none",this._registerDebugActions(),this.buildGui(),this._startDiagLoop())}handleKeyPress(e){}toggleVisibility(){this.gui&&(this.active=!this.active,this.gui.domElement.style.display=this.active?"block":"none")}toggleDiagnosticOverlay(){this.diagActive=!this.diagActive;let e=document.getElementById("diagnostic-overlay");e&&e.classList.toggle("hidden",!this.diagActive)}generateBugReport(){let e=this.logger.getLogHistory(),t=this.gameState.getState();delete t.TRAVEL_DATA,delete t.market.priceHistory;let i=`
ORBITAL TRADING - BUG REPORT
==============================
Date: ${new Date().toISOString()}

--- GAME STATE SNAPSHOT ---
${JSON.stringify(t,null,2)}

--- RECENT LOG HISTORY ---
${e}
        `;navigator.clipboard.writeText(i.trim()).then(()=>{this.uiManager.createFloatingText("Bug Report Copied to Clipboard!",window.innerWidth/2,window.innerHeight/2,"#4ade80")}).catch(a=>{this.logger.error("DebugService","Failed to copy bug report.",a)})}godMode(){this.logger.warn("DebugService","GOD MODE ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(d.TUTORIAL_DATA),this.gameState.player.credits=1e12,this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(A.BEHEMOTH),this.gameState.player.activeShipId=A.BEHEMOTH,this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(d.LICENSES),this.gameState.player.unlockedLocationIds=d.MARKETS.map(e=>e.id),this.uiManager.showGameContainer(),this.simulationService.setScreen(M.STARPORT,y.MARKET),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}simpleStart(){this.logger.warn("DebugService","SIMPLE START ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(d.TUTORIAL_DATA),this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(A.WANDERER),this.gameState.player.activeShipId=A.WANDERER,this.uiManager.showGameContainer(),this.simulationService.setScreen(M.DATA,y.MISSIONS),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}skipToHangarTutorial(){this.logger.warn("DebugService","SKIP TO HANGAR TUTORIAL ACTIVATED."),this.gameState.introSequenceActive=!0,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=[],this.gameState.player.credits=25e3,this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.uiManager.showGameContainer(),this.simulationService.setScreen(M.STARPORT,y.HANGAR),this.simulationService.tutorialService.triggerBatch("intro_hangar","hangar_1"),this.gameState.setState({})}grantAllItems(){let e=this.simulationService._getActiveInventory();if(!e){this.logger.warn("DebugService","Cannot grant items: No active inventory found.");return}d.COMMODITIES.forEach(t=>{e[t.id]?e[t.id].quantity+=1:e[t.id]={quantity:1,avgCost:0}}),this.logger.warn("DebugService","Debug: Granted 1x of all commodities."),this.gameState.setState({})}fillShipyard(){let{currentLocationId:e,day:t}=this.gameState;if(this.gameState.market.shipyardStock[e]){let i=Object.keys(d.SHIPS);this.gameState.market.shipyardStock[e]={day:t,shipsForSale:i},this.logger.warn("DebugService",`SHIPYARD FILLED: All ships added to ${e}.`),this.gameState.setState({})}else this.logger.error("DebugService",`Cannot fill shipyard: No stock object for ${e}.`)}_registerDebugActions(){this.actions={godMode:{name:"God Mode",type:"button",handler:()=>this.godMode()},simpleStart:{name:"Simple Start",type:"button",handler:()=>this.simpleStart()},skipToHangarTutorial:{name:"Skip to Hangar Tutorial",type:"button",handler:()=>this.skipToHangarTutorial()},addCredits:{name:"Add Credits",type:"button",handler:()=>{this.gameState.player.credits+=this.debugState.creditsToAdd,this.simulationService.timeService._checkMilestones(),this.uiManager.render(this.gameState.getState())}},payDebt:{name:"Pay Off Debt",type:"button",handler:()=>this.simulationService.playerActionService.payOffDebt()},teleport:{name:"Teleport",type:"button",handler:()=>{this.debugState.selectedLocation&&(this.gameState.currentLocationId=this.debugState.selectedLocation,this.gameState.setState({}))}},unlockAll:{name:"Unlock All",type:"button",handler:()=>{this.gameState.player.unlockedLocationIds=d.MARKETS.map(e=>e.id),this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(d.LICENSES),this.gameState.setState({})}},grantAllShips:{name:"Grant All Ships",type:"button",handler:()=>{Object.keys(d.SHIPS).forEach(e=>{this.gameState.player.ownedShipIds.includes(e)||this.simulationService.addShipToHangar(e)}),this.gameState.setState({})}},grantAllItems:{name:"Grant 1x All Items",type:"button",handler:()=>this.grantAllItems()},advanceTime:{name:"Advance Days",type:"button",handler:()=>this.simulationService.timeService.advanceDays(this.debugState.daysToAdvance)},replenishStock:{name:"Replenish All Stock",type:"button",handler:()=>{this.simulationService.marketService.replenishMarketInventory(),this.gameState.setState({})}},fillShipyard:{name:"Fill Shipyard w/ All Ships",type:"button",handler:()=>this.fillShipyard()},triggerRandomEvent:{name:"Trigger Random Event",type:"button",handler:()=>{let e=d.MARKETS.find(t=>t.id!==this.gameState.currentLocationId)?.id;e&&this.simulationService.travelService._checkForRandomEvent(e,this.debugState.selectedRandomEvent)}},triggerAgeEvent:{name:"Trigger Age Event",type:"button",handler:()=>{let e=d.AGE_EVENTS.find(t=>t.id===this.debugState.selectedAgeEvent);e&&this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t))}},triggerMission:{name:"Trigger Mission",type:"button",handler:()=>{this.debugState.selectedMission&&(this.gameState.missions.activeMissionId&&this.simulationService.missionService.abandonMission(),this.simulationService.missionService.acceptMission(this.debugState.selectedMission))}},triggerSystemSurge:{name:"Trigger System Surge",type:"button",handler:()=>{this.uiManager.triggerEffect("systemSurge",{text:this.debugState.surgeText,theme:this.debugState.surgeTheme,particleCount:this.debugState.surgeParticleCount,particleShape:this.debugState.surgeParticleShape,particleSize:{min:this.debugState.surgeParticleSizeMin,max:this.debugState.surgeParticleSizeMax},particleSpeed:{min:this.debugState.surgeParticleSpeedMin,max:this.debugState.surgeParticleSpeedMax},fadeInTime:this.debugState.surgeFadeIn,lingerTime:this.debugState.surgeLinger,fadeOutTime:this.debugState.surgeFadeOut,textSize:this.debugState.surgeTextSize})}},startBot:{name:"Start AUTOTRADER-01",type:"button",handler:()=>{let e=this.gui.controllers.find(t=>t.property==="botProgress");this.bot.runSimulation({daysToRun:this.debugState.botDaysToRun},(t,i)=>{e&&e.setValue(`${t} / ${i}`).updateDisplay()})}},stopBot:{name:"Stop AUTOTRADER-01",type:"button",handler:()=>this.bot.stop()}}}_cacheDiagElements(){this.diagElements={winW:document.getElementById("diag-window-w"),winH:document.getElementById("diag-window-h"),visualVpW:document.getElementById("diag-visual-vp-w"),visualVpH:document.getElementById("diag-visual-vp-h"),gameW:document.getElementById("diag-game-container-w"),gameH:document.getElementById("diag-game-container-h"),bodyW:document.getElementById("diag-body-w"),bodyH:document.getElementById("diag-body-h"),pixelRatio:document.getElementById("diag-pixel-ratio"),displayMode:document.getElementById("diag-display-mode"),day:document.getElementById("diag-day"),navScreen:document.getElementById("diag-nav-screen"),tutorialBatch:document.getElementById("diag-tutorial-batch"),tutorialStep:document.getElementById("diag-tutorial-step")}}_startDiagLoop(){let e=()=>{this._updateDiagOverlay(),requestAnimationFrame(e)};requestAnimationFrame(e)}_updateDiagOverlay(){if(!this.diagActive)return;let e=this.gameState.getState(),t=document.getElementById("game-container");this.diagElements.winW.textContent=window.innerWidth,this.diagElements.winH.textContent=window.innerHeight,window.visualViewport&&(this.diagElements.visualVpW.textContent=Math.round(window.visualViewport.width),this.diagElements.visualVpH.textContent=Math.round(window.visualViewport.height)),this.diagElements.gameW.textContent=t.clientWidth,this.diagElements.gameH.textContent=t.clientHeight,this.diagElements.bodyW.textContent=document.body.clientWidth,this.diagElements.bodyH.textContent=document.body.clientHeight,this.diagElements.pixelRatio.textContent=window.devicePixelRatio.toFixed(2),this.diagElements.displayMode.textContent=window.matchMedia("(display-mode: standalone)").matches?"standalone":"browser",this.diagElements.day.textContent=e.day,this.diagElements.navScreen.textContent=`${e.activeNav} / ${e.activeScreen}`,this.diagElements.tutorialBatch.textContent=e.tutorials.activeBatchId||"none",this.diagElements.tutorialStep.textContent=e.tutorials.activeStepId||"none"}buildGui(){let e=this.gui.addFolder("Game Flow");e.add(this.actions.godMode,"handler").name(this.actions.godMode.name),e.add(this.actions.simpleStart,"handler").name(this.actions.simpleStart.name),e.add(this.actions.skipToHangarTutorial,"handler").name(this.actions.skipToHangarTutorial.name);let t=this.gui.addFolder("Player");this.debugState.creditsToAdd=1e5,t.add(this.debugState,"creditsToAdd").name("Credits Amount"),t.add(this.actions.addCredits,"handler").name("Add Credits"),t.add(this.actions.payDebt,"handler").name(this.actions.payDebt.name);let i=d.MARKETS.reduce((T,I)=>({...T,[I.name]:I.id}),{});this.debugState.selectedLocation=this.gameState.currentLocationId,t.add(this.debugState,"selectedLocation",i).name("Location"),t.add(this.actions.teleport,"handler").name("Teleport");let a=this.gui.addFolder("World & Time");this.debugState.daysToAdvance=7,a.add(this.debugState,"daysToAdvance",1,365,1).name("Days to Advance"),a.add(this.actions.advanceTime,"handler").name("Advance Time");let s=this.gui.addFolder("Economy");s.add(this.actions.replenishStock,"handler").name(this.actions.replenishStock.name),s.add(this.actions.unlockAll,"handler").name("Unlock Tiers/Locations"),s.add(this.actions.grantAllShips,"handler").name("Grant All Ships"),s.add(this.actions.grantAllItems,"handler").name(this.actions.grantAllItems.name),s.add(this.actions.fillShipyard,"handler").name(this.actions.fillShipyard.name);let n=this.gui.addFolder("Triggers"),r=d.RANDOM_EVENTS.reduce((T,I,R)=>({...T,[I.title]:R}),{});this.debugState.selectedRandomEvent=0,n.add(this.debugState,"selectedRandomEvent",r).name("Random Event"),n.add(this.actions.triggerRandomEvent,"handler").name("Trigger Event");let o=d.AGE_EVENTS.reduce((T,I)=>({...T,[I.title]:I.id}),{});this.debugState.selectedAgeEvent=d.AGE_EVENTS[0].id,n.add(this.debugState,"selectedAgeEvent",o).name("Age Event"),n.add(this.actions.triggerAgeEvent,"handler").name("Trigger Event");let c=Object.values(d.MISSIONS).reduce((T,I)=>({...T,[I.name]:I.id}),{});this.debugState.selectedMission=Object.keys(c)[0],n.add(this.debugState,"selectedMission",c).name("Mission"),n.add(this.actions.triggerMission,"handler").name("Accept Mission");let u=this.gui.addFolder("System Surge Effect"),h=this.simulationService.uiManager.effectsManager.effectsRegistry.systemSurge.PROFILES.gold;this.debugState.surgeThemePreset="gold",this.debugState.surgeText=h.text,this.debugState.surgeParticleCount=h.particleCount,this.debugState.surgeParticleShape=h.particleShape,this.debugState.surgeParticleSizeMin=h.particleSize.min,this.debugState.surgeParticleSizeMax=h.particleSize.max,this.debugState.surgeParticleSpeedMin=h.particleSpeed.min,this.debugState.surgeParticleSpeedMax=h.particleSpeed.max,this.debugState.surgeFadeIn=h.fadeInTime,this.debugState.surgeLinger=h.lingerTime,this.debugState.surgeFadeOut=h.fadeOutTime,this.debugState.surgeTextSize=h.textSize;let m=this.simulationService.uiManager.effectsManager.effectsRegistry.systemSurge.PROFILES,p=Object.keys(m);u.add(this.debugState,"surgeThemePreset",p).name("Load Preset").onChange(T=>{let I=m[T];I&&(this.debugState.surgeTheme=T,this.debugState.surgeText=I.text,this.debugState.surgeParticleCount=I.particleCount,this.debugState.surgeParticleShape=I.particleShape,this.debugState.surgeParticleSizeMin=I.particleSize.min,this.debugState.surgeParticleSizeMax=I.particleSize.max,this.debugState.surgeParticleSpeedMin=I.particleSpeed.min,this.debugState.surgeParticleSpeedMax=I.particleSpeed.max,this.debugState.surgeFadeIn=I.fadeInTime,this.debugState.surgeLinger=I.lingerTime,this.debugState.surgeFadeOut=I.fadeOutTime,this.debugState.surgeTextSize=I.textSize,u.controllers.forEach(R=>R.updateDisplay()))}),u.add(this.debugState,"surgeText").name("Text"),u.add(this.debugState,"surgeTheme",p).name("Theme"),u.add(this.debugState,"surgeTextSize").name("Text Size"),u.add(this.debugState,"surgeParticleCount",0,200,1).name("Particle Count"),u.add(this.debugState,"surgeParticleShape",["circle","sliver","rectangle"]).name("Particle Shape"),u.add(this.debugState,"surgeParticleSizeMin",1,20,1).name("Min Size"),u.add(this.debugState,"surgeParticleSizeMax",1,20,1).name("Max Size"),u.add(this.debugState,"surgeParticleSpeedMin",1,20,.5).name("Min Speed"),u.add(this.debugState,"surgeParticleSpeedMax",1,20,.5).name("Max Speed"),u.add(this.debugState,"surgeFadeIn",500,5e3,50).name("Fade In (ms)"),u.add(this.debugState,"surgeLinger",500,5e3,50).name("Linger (ms)"),u.add(this.debugState,"surgeFadeOut",500,5e3,50).name("Fade Out (ms)"),u.add(this.actions.triggerSystemSurge,"handler").name("Trigger Effect");let v=this.gui.addFolder("Automation & Logging");v.add(this,"toggleDiagnosticOverlay").name("Toggle HUD Diagnostics"),this.debugState.logLevel="INFO",v.add(this.debugState,"logLevel",["DEBUG","INFO","WARN","ERROR","NONE"]).name("Log Level").onChange(T=>this.logger.setLevel(T)),v.add(this,"generateBugReport").name("Generate Bug Report"),this.debugState.botDaysToRun=365,this.debugState.botProgress="Idle",v.add(this.debugState,"botDaysToRun",1,1e4,1).name("Simulation Days"),v.add(this.actions.startBot,"handler").name(this.actions.startBot.name),v.add(this.actions.stopBot,"handler").name(this.actions.stopBot.name),v.add(this.debugState,"botProgress").name("Progress").listen(),this.gui.folders.forEach(T=>T.close())}};var be=()=>{let l=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-height",`${l}px`)};document.addEventListener("DOMContentLoaded",()=>{let l=document.getElementById("splash-screen"),e=document.getElementById("start-game-btn"),t=!0;be(),window.visualViewport?window.visualViewport.addEventListener("resize",be):window.addEventListener("resize",be),e.addEventListener("click",()=>{l.classList.add("splash-screen-hiding"),l.addEventListener("animationend",()=>{l.style.display="none",i()},{once:!0})},{once:!0});function i(){let a=new j,s=new ae(H),n=new he(a,s,H),r=new J(a,s,H),o=new de(a,s,r,s.navStructure,H),c=null;t&&(c=new me(a,r,s,H),c.init()),s.setMissionService(n),s.setSimulationService(r),r.setTutorialService(o),r.setMissionService(n),n.setSimulationService(r);let u=new ce(a,r,s,o,c,H);a.subscribe(()=>s.render(a.getState()));let h=a.loadGame();h||(a.startNewGame(""),r.timeService.advanceDays(7),r.startIntroSequence()),u.bindEvents(),h&&(s.showGameContainer(),s.render(a.getState())),o.checkState({type:"SCREEN_LOAD",screenId:a.activeScreen})}});})();
