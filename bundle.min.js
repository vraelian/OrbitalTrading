(()=>{var S=Object.freeze({STATUS:"status",NAVIGATION:"navigation",SERVICES:"services",MARKET:"market",CARGO:"cargo",HANGAR:"hangar",MISSIONS:"missions",FINANCE:"finance",INTEL:"intel"}),k=Object.freeze({SHIP:"ship",STARPORT:"starport",DATA:"data"}),A=Object.freeze({WANDERER:"starter",STALWART:"hauler_c1",MULE:"hauler_c2",PATHFINDER:"explorer_b1",NOMAD:"explorer_b2",VINDICATOR:"frigate_a1",AEGIS:"frigate_a2",ODYSSEY:"luxury_s1",MAJESTIC:"luxury_s2",TITAN_HAULER:"rare_s1",VOID_CHASER:"rare_s2",GUARDIAN:"rare_s3",STARGAZER:"rare_s4",BEHEMOTH:"rare_o1"}),L=Object.freeze({WATER_ICE:"water_ice",PLASTEEL:"plasteel",HYDROPONICS:"hydroponics",CYBERNETICS:"cybernetics",PROPELLANT:"propellant",PROCESSORS:"processors",GMO_SEEDS:"gmo_seeds",CRYO_PODS:"cryo_pods",ATMO_PROCESSORS:"atmos_processors",CLONED_ORGANS:"cloned_organs",XENO_GEOLOGICALS:"xeno_geologicals",SENTIENT_AI:"sentient_ai",ANTIMATTER:"antimatter",FOLDED_DRIVES:"folded_drives"}),y=Object.freeze({EARTH:"loc_earth",LUNA:"loc_luna",MARS:"loc_mars",VENUS:"loc_venus",BELT:"loc_belt",SATURN:"loc_saturn",JUPITER:"loc_jupiter",URANUS:"loc_uranus",NEPTUNE:"loc_neptune",PLUTO:"loc_pluto",EXCHANGE:"loc_exchange",KEPLER:"loc_kepler"}),M=Object.freeze({TRADEMASTER:"trademaster",NAVIGATOR:"navigator",VENETIAN_SYNDICATE:"venetian_syndicate",MERCHANT_GUILD_SHIP:"merchant_guild_ship"}),b=Object.freeze({SET_SCREEN:"set-screen",TRAVEL:"travel",BUY_SHIP:"buy-ship",SELL_SHIP:"sell-ship",SELECT_SHIP:"select-ship",PAY_DEBT:"pay-debt",TAKE_LOAN:"take-loan",PURCHASE_INTEL:"purchase-intel",ACQUIRE_LICENSE:"acquire-license",BUY_ITEM:"buy-item",SELL_ITEM:"sell-item",SET_MAX_BUY:"set-max-buy",SET_MAX_SELL:"set-max-sell",INCREMENT:"increment",DECREMENT:"decrement",SHOW_PRICE_GRAPH:"show-price-graph",SHOW_FINANCE_GRAPH:"show-finance-graph",TOGGLE_MARKET_CARD_VIEW:"toggle-market-card-view"}),D=Object.freeze({SCREEN_LOAD:"SCREEN_LOAD",ACTION:"ACTION",INFO:"INFO"}),R=Object.freeze({STARTING_CREDITS:5e3,STARTING_DEBT_INTEREST:125,REPAIR_COST_PER_HP:75,REPAIR_AMOUNT_PER_TICK:5,FUEL_SCALAR:3,INTEREST_INTERVAL:30,PASSIVE_REPAIR_RATE:.02,HULL_DECAY_PER_TRAVEL_DAY:1/7,SHIP_SELL_MODIFIER:.75,RARE_SHIP_CHANCE:.3,PRICE_HISTORY_LENGTH:65,FINANCE_HISTORY_LENGTH:10,DAILY_PRICE_VOLATILITY:.15,MEAN_REVERSION_STRENGTH:.07,MARKET_PRESSURE_DECAY:.7,LOAN_GARNISHMENT_DAYS:1095,LOAN_GARNISHMENT_PERCENT:.14,RANDOM_EVENT_CHANCE:.07}),de=[{threshold:5e4,revealsTier:2},{threshold:45e4,revealsTier:3},{threshold:4e6,revealsTier:4},{threshold:35e6,revealsTier:5},{threshold:3e8,revealsTier:6},{threshold:25e8,revealsTier:7}];var ge="orbitalTraderSave_v2";var F={START_YEAR:2140,START_DAY_OF_WEEK:1,DAYS_IN_MONTH:[31,28,31,30,31,30,31,31,30,31,30,31],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Le={NEUTRAL:{name:"Neutral System",duration:28,description:"Standard space-faring conditions. Markets are operating under normal parameters.",modifiers:{}}},d={CONFIG:{INTEL_COST_PERCENTAGE:.2,INTEL_MIN_CREDITS:5e3,INTEL_CHANCE:.3,INTEL_DEMAND_MOD:1.8,INTEL_DEPRESSION_MOD:.5},SYSTEM_STATES:Le,DATE_CONFIG:F,INTRO_SEQUENCE_V1:{modals:[{id:"lore_1",title:"Year 2140",description:'Humanity has expanded throughout the Solar System.<br><br> <span class="hl">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.',buttonText:"Begin",contentClass:"text-center"},{id:"lore_2",title:"The Price of Freedom",description:"A dead-end job in the Belt paid the bills... yet you dream of <b class='hl-green font-bold'>wealth</b>.<br><br>The <span class='hl'>Merchant's Guild</span> is willing to finance your ambition at a steep price. It's not just a loan; it's a wager on your very future.",buttonText:"Apply for Loan",contentClass:"text-center",buttonClass:"btn-pulse-green"},{id:"charter",title:`<span class="hl">MERCHANT'S GUILD LOAN AGREEMENT</span>`,description:`
            <div class="font-roboto-mono text-left text-sm space-y-2">
                <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
                <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">\u232C 25,000</span></p>
                <p><span class="text-gray-400">INTEREST RATE:</span> 1.56% (Monthly)</p>
            </div>
            <div class="border-t border-slate-600 my-4"></div>
            <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment, subject to interest accrual as stipulated by the Merchant's Guild Interstellar Commerce Mandates. All financial agreements are recognized across the system.</p>
          `,buttonText:"Accept Terms",buttonClass:"btn-pulse-gold"},{id:"signature",title:"SIGN YOUR NAME",description:`
            <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
          `,buttonText:"Submit Application"},{id:"final",title:"Low On Credits!",description:"Interest on your debt grows every month. It's time to make some <b class='hl-yellow font-bold'>credits</b>. Let's view the <b>Mission Terminal</b> here on <b>Mars</b>!",buttonText:"View Missions"}]},LOCATION_VISUALS:{[y.EARTH]:"\u{1F30D}",[y.LUNA]:"\u{1F315}",[y.MARS]:"\u{1F534}",[y.VENUS]:"\u{1F7E1}",[y.BELT]:"\u{1FAA8}",[y.SATURN]:"\u{1FA90}",[y.JUPITER]:"\u{1F7E0}",[y.URANUS]:"\u{1F535}",[y.NEPTUNE]:"\u{1F7E3}",[y.PLUTO]:"\u{1FAA9}",[y.EXCHANGE]:"\u{1F3F4}\u200D\u2620\uFE0F",[y.KEPLER]:"\u{1F441}\uFE0F"},PERKS:{[M.TRADEMASTER]:{profitBonus:.05},[M.NAVIGATOR]:{fuelMod:.9,hullDecayMod:.9,travelTimeMod:.9},[M.VENETIAN_SYNDICATE]:{fuelDiscount:.25,repairDiscount:.25}},AGE_EVENTS:[{id:"captain_choice",trigger:{day:366},title:"Captain Who?",description:"You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",choices:[{title:"Trademaster",description:"5% bonus on all trade profits.",perkId:M.TRADEMASTER,playerTitle:"Trademaster"},{title:"Navigator",description:"10% reduced fuel usage, hull decay, and travel time.",perkId:M.NAVIGATOR,playerTitle:"Navigator"}]},{id:"friends_with_benefits",trigger:{credits:5e4},title:"Friends with Benefits",description:"An ally in need is an ally indeed.",choices:[{title:"Join the Merchant's Guild",description:"Receive a free C-Class freighter.",perkId:M.MERCHANT_GUILD_SHIP},{title:"Join the Venetian Syndicate",description:"75% discount on fuel and repairs at Venus.",perkId:M.VENETIAN_SYNDICATE}]}],RANDOM_EVENTS:[{id:"distress_call",title:"Distress Call",scenario:"You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.",precondition:(c,e)=>e.fuel>=20,choices:[{title:"Offer Aid (20 Fuel)",outcomes:[{chance:.75,description:"The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.",effects:[{type:"fuel",value:-20},{type:"credits",value:1e4}]},{chance:.25,description:"As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.",effects:[{type:"fuel",value:-20},{type:"hull_damage_percent",value:15}]}]},{title:"Ignore the Call",outcomes:[{chance:1,description:"You press on, and the desperate signal fades behind you.",effects:[]}]}]},{id:"floating_cargo",title:"Floating Cargo Pod",scenario:"Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.",precondition:()=>!0,choices:[{title:"Bring it Aboard",outcomes:[{chance:.6,description:"The pod contains valuable goods. You gain 25 units of Neural Processors.",effects:[{type:"add_cargo",value:{id:L.PROCESSORS,quantity:25}}]},{chance:.4,description:"It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.",effects:[{type:"hull_damage_percent",value:20}]}]},{title:"Report it",outcomes:[{chance:1,description:"You notify the nearest station of the hazard and receive a small finder's fee of 1,000 credits.",effects:[{type:"credits",value:1e3}]}]}]},{id:"adrift_passenger",title:"Adrift Passenger",scenario:"You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.",precondition:(c,e)=>e.fuel>=30,choices:[{title:"Take Aboard for Payment",outcomes:[{chance:1,description:"The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.",effects:[{type:"credits",value:1e4}]}]},{title:"Give a Fuel Cell (30 Fuel)",outcomes:[{chance:1,descriptions:{reward_cybernetics:'In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.',reward_debt_paid:'Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.',reward_credits:'With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.'},effects:[{type:"ADRIFT_PASSENGER"}]}]}]},{id:"meteoroid_swarm",title:"Micrometeoroid Swarm",scenario:"Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.",precondition:(c,e)=>e.fuel>=15,choices:[{title:"Evade Aggressively (+15 Fuel)",outcomes:[{chance:1,description:"You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.",effects:[{type:"fuel",value:-15}]}]},{title:"Brace for Impact",outcomes:[{chance:1,description:"You trust your hull to withstand the impacts, taking a beating but saving fuel.",effects:[{type:"hull_damage_percent",value:[10,25]}]}]}]},{id:"engine_malfunction",title:"Engine Malfunction",scenario:"A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.",precondition:(c,e,t)=>(t()[L.PLASTEEL]?.quantity||0)>=5,choices:[{title:"Quick, Risky Fix (5 Plasteel)",outcomes:[{chance:.5,description:"The patch holds! The engine stabilizes and you continue your journey without further incident.",effects:[{type:"lose_cargo",value:{id:L.PLASTEEL,quantity:5}}]},{chance:.5,description:"The patch fails catastrophically, causing a small explosion that deals 20% hull damage.",effects:[{type:"lose_cargo",value:{id:L.PLASTEEL,quantity:5}},{type:"hull_damage_percent",value:20}]}]},{title:"Limp to Destination",outcomes:[{chance:1,description:"You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.",effects:[{type:"travel_time_add_percent",value:.25}]}]}]},{id:"nav_glitch",title:"Navigation Sensor Glitch",scenario:"The nav-console flashes red. Your primary positioning sensors are offline, and you're flying blind in the deep dark.",precondition:()=>!0,choices:[{title:"Attempt Hard Reboot",outcomes:[{chance:.5,description:"Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.",effects:[{type:"set_travel_time",value:1}]},{chance:.5,description:"The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.",effects:[{type:"travel_time_add",value:15}]}]},{title:"Navigate Manually",outcomes:[{chance:1,description:"You rely on old-fashioned star charts. It's slow but safe, adding 7 days to your trip.",effects:[{type:"travel_time_add",value:7}]}]}]},{id:"life_support_fluctuation",title:"Life Support Fluctuation",scenario:"An alarm indicates unstable oxygen levels. It's not critical yet, but the crew is on edge and efficiency is dropping.",precondition:(c,e)=>e.health>e.maxHealth*.25,choices:[{title:"Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)",outcomes:[{chance:1,description:"You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship's integrity is compromised.",effects:[{type:"hull_damage_percent",value:25}]}]},{title:"Defer Maintenance Costs",outcomes:[{chance:1,description:"You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.",effects:[{type:"add_debt",value:5e3}]}]}]},{id:"cargo_rupture",title:"Cargo Hold Rupture",scenario:"A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.",precondition:(c,e,t)=>{let i=t();return i?Object.values(i).some(a=>a.quantity>0):!1},choices:[{title:"Jettison Damaged Cargo",outcomes:[{chance:1,description:"You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.",effects:[{type:"lose_random_cargo_percent",value:.1}]}]},{title:"Attempt EVA Repair",outcomes:[{chance:.75,description:"The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.",effects:[{type:"travel_time_add",value:2}]},{chance:.25,description:"The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.",effects:[{type:"lose_random_cargo_percent",value:.5},{type:"travel_time_add",value:2}]}]}]},{id:"space_race",title:"Space Race Wager",scenario:'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',precondition:c=>c.player.credits>100,choices:[{title:"Accept Wager (Bet: 80% of current credits)",outcomes:[{chance:1,description:"You accept the high-stakes challenge...",effects:[{type:"SPACE_RACE",wagerPercentage:.8,winChance:{S:.85,A:.7,B:.55,C:.4,O:.95}}]}]},{title:"Politely Decline",outcomes:[{chance:1,description:"You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.",effects:[]}]}]},{id:"supply_drop",title:"Emergency Supply Drop",scenario:"You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.",precondition:(c,e,t)=>{let i=t();return i&&Object.values(i).some(a=>a.quantity>0)},choices:[{title:"Divert Course to Deliver",outcomes:[{chance:1,description:"You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.",effects:[{type:"sell_random_cargo_premium",value:3},{type:"travel_time_add",value:7},{type:"set_new_random_destination"}]}]},{title:"Decline and Continue",outcomes:[{chance:1,description:"You stick to your original plan and let someone else handle the emergency supply run.",effects:[]}]}]}],SHIPS:{[A.WANDERER]:{name:"Wanderer",class:"C",price:25e3,maxHealth:100,cargoCapacity:20,maxFuel:100,saleLocationId:null,lore:"The All-Rounder. A reliable, if unspectacular, light freighter. Its balanced stats make it a good choice for new captains finding their niche."},[A.STALWART]:{name:"Stalwart",class:"C",price:25e3,maxHealth:150,cargoCapacity:45,maxFuel:80,saleLocationId:y.MARS,lore:"The Hauler. A workhorse of the inner worlds. Slow and cumbersome, but boasts an impressive cargo capacity for its price point."},[A.MULE]:{name:"Mule",class:"C",price:25e3,maxHealth:75,cargoCapacity:30,maxFuel:150,saleLocationId:y.BELT,lore:"The Explorer. What it lacks in cargo space, it makes up for with surprising efficiency and robust systems, allowing it to travel further and cheaper than other ships in its class."},[A.PATHFINDER]:{name:"Pathfinder",class:"B",price:18e4,maxHealth:120,cargoCapacity:40,maxFuel:150,saleLocationId:y.LUNA,lore:"Built for the long haul. Its extended fuel tanks and robust sensor suite make it ideal for reaching the outer edges of the system."},[A.NOMAD]:{name:"Nomad",class:"B",price:28e4,maxHealth:100,cargoCapacity:35,maxFuel:140,saleLocationId:y.URANUS,lore:"A vessel designed for self-sufficiency, featuring advanced life support and a small onboard workshop for emergency repairs."},[A.VINDICATOR]:{name:"Vindicator",class:"A",price:75e4,maxHealth:250,cargoCapacity:80,maxFuel:120,saleLocationId:y.NEPTUNE,lore:"A decommissioned military frigate. Fast, tough, and intimidating, with cargo space retrofitted where missile launchers used to be."},[A.AEGIS]:{name:"Aegis",class:"A",price:12e5,maxHealth:120,cargoCapacity:70,maxFuel:140,saleLocationId:y.EARTH,lore:"Built as a high-threat escort vessel, its hull is exceptionally dense. A flying fortress that can also haul a respectable amount of cargo."},[A.ODYSSEY]:{name:"Odyssey",class:"S",price:38e5,maxHealth:100,cargoCapacity:120,maxFuel:250,saleLocationId:y.SATURN,lore:"The pinnacle of personal transport. Gleaming chrome, whisper-quiet engines, and a cabin that smells of rich Corinthian leather."},[A.MAJESTIC]:{name:"Majestic",class:"S",price:72e5,maxHealth:200,cargoCapacity:160,maxFuel:250,saleLocationId:y.KEPLER,lore:"A flying palace favored by corporate magnates. Its speed, range, and capacity make it one of the most versatile ships money can buy."},[A.TITAN_HAULER]:{name:"Titan Hauler",class:"S",price:18e5,maxHealth:175,cargoCapacity:300,maxFuel:75,saleLocationId:y.URANUS,isRare:!0,lore:"A relic of a failed colonization effort, this ship is almost entirely a cargo container with an engine strapped to it."},[A.VOID_CHASER]:{name:"Void Chaser",class:"S",price:31e5,maxHealth:50,cargoCapacity:90,maxFuel:400,saleLocationId:y.BELT,isRare:!0,lore:"A heavily modified smuggling vessel. Its paper-thin hull is a small price to pay for its legendary engine and long-range fuel cells."},[A.GUARDIAN]:{name:"Guardian",class:"S",price:15e5,maxHealth:400,cargoCapacity:75,maxFuel:150,saleLocationId:y.EARTH,isRare:!0,lore:"An experimental military prototype with redundant hull plating, designed to withstand extreme punishment."},[A.STARGAZER]:{name:"Stargazer",class:"S",price:95e4,maxHealth:100,cargoCapacity:60,maxFuel:350,saleLocationId:y.JUPITER,isRare:!0,lore:"A deep-space exploration vessel with colossal fuel reserves, intended for journeys far beyond the known systems."},[A.BEHEMOTH]:{name:"Behemoth",class:"O",price:32e6,maxHealth:600,cargoCapacity:500,maxFuel:600,saleLocationId:y.EXCHANGE,isRare:!0,lore:"An orbital-class freighter that dwarfs even the largest stations. It is a legend among traders, rumored to be a mobile black market in its own right."}},COMMODITIES:[{id:L.WATER_ICE,name:"Water Ice",tier:1,basePriceRange:[15,80],volatility:.01,canonicalAvailability:[80,150],styleClass:"item-style-1",lore:"Crude, unrefined water ice scraped from asteroids; a universal necessity.",cat:"RAW",symbol:"H2O"},{id:L.PLASTEEL,name:"Plasteel",tier:1,basePriceRange:[100,280],volatility:.015,canonicalAvailability:[80,150],styleClass:"item-style-2",lore:"A basic, versatile polymer for 3D printing and simple manufacturing.",cat:"IND",symbol:"PLST"},{id:L.HYDROPONICS,name:"Hydroponics",tier:2,licenseId:"t2_license",basePriceRange:[850,2400],volatility:.025,canonicalAvailability:[40,70],styleClass:"item-style-3",lore:"Packaged agricultural systems and produce essential for feeding isolated colonies.",cat:"AGRI",symbol:"HYD"},{id:L.CYBERNETICS,name:"Cybernetics",tier:2,licenseId:"t2_license",basePriceRange:[1200,3800],volatility:.03,canonicalAvailability:[40,70],styleClass:"item-style-4",lore:"Mass-produced enhancement limbs and organs for the industrial workforce.",cat:"TECH",symbol:"CYB"},{id:L.PROPELLANT,name:"Refined Propellant",tier:3,licenseId:"t3_license",basePriceRange:[14e3,38e3],volatility:.035,canonicalAvailability:[25,50],styleClass:"item-style-5",lore:"High-efficiency fuel that powers all modern ship drives.",cat:"IND",symbol:"PROP"},{id:L.PROCESSORS,name:"Neural Processors",tier:3,licenseId:"t3_license",basePriceRange:[18e3,52e3],volatility:.045,canonicalAvailability:[25,50],styleClass:"item-style-6",lore:"The silicon brains behind complex ship systems and station logistics.",cat:"TECH",symbol:"NPRO"},{id:L.GMO_SEEDS,name:"GMO Seed Cultures",tier:4,licenseId:"t4_license",basePriceRange:[19e4,55e4],volatility:.06,canonicalAvailability:[15,30],styleClass:"item-style-7",lore:"Patented seeds holding the key to unlocking agricultural wealth on new worlds.",cat:"AGRI",symbol:"GMO"},{id:L.CRYO_PODS,name:"Cryo-Sleep Pods",tier:4,licenseId:"t4_license",basePriceRange:[25e4,75e4],volatility:.075,canonicalAvailability:[15,30],styleClass:"item-style-8",lore:"Essential for long-haul passenger transport and colonization efforts.",cat:"CIV",symbol:"CRYO"},{id:L.ATMO_PROCESSORS,name:"Atmo Processors",tier:5,licenseId:"t5_license",basePriceRange:[28e5,85e5],volatility:.08,canonicalAvailability:[10,20],styleClass:"item-style-9",lore:"Gargantuan machines that begin the centuries-long process of making a world breathable.",cat:"IND",symbol:"ATMO"},{id:L.CLONED_ORGANS,name:"Cloned Organs",tier:5,licenseId:"t5_license",basePriceRange:[35e5,11e6],volatility:.09,canonicalAvailability:[10,20],styleClass:"item-style-10",lore:"Lab-grown replacements with high demand in wealthy core worlds; morally grey.",cat:"BIO",symbol:"CLON"},{id:L.XENO_GEOLOGICALS,name:"Xeno-Geologicals",tier:6,licenseId:"t6_license",basePriceRange:[24e6,7e7],volatility:.1,canonicalAvailability:[2,10],styleClass:"item-style-11",lore:"Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure.",cat:"RAW",symbol:"XENO"},{id:L.SENTIENT_AI,name:"Sentient AI Cores",tier:6,licenseId:"t6_license",basePriceRange:[32e6,95e6],volatility:.125,canonicalAvailability:[2,10],styleClass:"item-style-12",lore:'The "brains" of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate.',cat:"TECH",symbol:"AI"},{id:L.ANTIMATTER,name:"Antimatter",tier:7,licenseId:"t7_license",basePriceRange:[28e7,8e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-13",lore:"The only safe way to transport the most volatile and powerful substance known to science.",cat:"RARE",symbol:"AM"},{id:L.FOLDED_DRIVES,name:"Folded-Space Drives",tier:7,licenseId:"t7_license",basePriceRange:[35e7,11e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-14",lore:"The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps.",cat:"RARE",symbol:"FSD"}],LICENSES:{t2_license:{type:"purchase",name:"Tier 2 Trade License",description:"Grants access to trade Tier 2 commodities like Hydroponics and Cybernetics.",cost:25e3},t3_license:{type:"mission",name:"Tier 3 Trade License",description:"Grants access to trade Tier 3 commodities.",missionId:"mission_license_t3",guidanceText:"Access to this tier is granted by the Merchant's Guild upon completion of a key contract."},t4_license:{type:"purchase",name:"Tier 4 Trade License",description:"Grants access to trade Tier 4 commodities.",cost:4e6},t5_license:{type:"mission",name:"Tier 5 Trade License",description:"Grants access to trade Tier 5 commodities.",missionId:"mission_license_t5",guidanceText:"Prove your industrial might by completing a grand contract for a planetary governor."},t6_license:{type:"purchase",name:"Tier 6 Trade License",description:"Grants access to trade the rarest and most exotic technologies.",cost:3e8},t7_license:{type:"mission",name:"Tier 7 Trade License",description:"The ultimate license, granting the right to trade reality-bending technologies.",missionId:"mission_license_t7",guidanceText:"Only a true legend of the trade routes can earn this privilege."}},MARKETS:[{id:y.EARTH,name:"Earth Orbit",launchFlavor:"The bustling heart of the Sol system.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #0f172a)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"The hub of power and wealth. High demand for tech and bio-enhancements.",color:"border-cyan-500",bg:"bg-gradient-to-br from-blue-900 to-slate-900",fuelPrice:250,arrivalLore:"The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.",availabilityModifier:{cybernetics:2,gmo_seeds:2,cloned_organs:.1,sentient_ai:.5,folded_drives:.5}},{id:y.LUNA,name:"The Moon",launchFlavor:"An industrial powerhouse built on grey dust.",navTheme:{gradient:"linear-gradient(to bottom right, #374151, #0f172a)",textColor:"#e5e7eb",borderColor:"#9ca3af"},description:"An industrial proving ground. Exports propellant and basic materials.",color:"border-gray-400",bg:"bg-gradient-to-br from-gray-700 to-slate-900",fuelPrice:350,arrivalLore:"Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.",availabilityModifier:{plasteel:2}},{id:y.MARS,name:"Mars",launchFlavor:"The red frontier, ripe with opportunity.",navTheme:{gradient:"linear-gradient(to bottom right, #7c2d12, #0f172a)",textColor:"#fca5a5",borderColor:"#f87171"},description:"A growing colony. Needs processors and materials for expansion.",color:"border-orange-600",bg:"bg-gradient-to-br from-orange-900 to-slate-900",fuelPrice:450,arrivalLore:"The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.",availabilityModifier:{plasteel:2,hydroponics:2,gmo_seeds:.5,cryo_pods:.5}},{id:y.VENUS,name:"Venus",launchFlavor:"Floating cities hide scientific marvels and secrets.",navTheme:{gradient:"linear-gradient(to bottom right, #854d0e, #0f172a)",textColor:"#fde047",borderColor:"#facc15"},description:"A scientific enclave hungry for research data and processors.",color:"border-yellow-400",bg:"bg-gradient-to-br from-yellow-800 to-slate-900",fuelPrice:400,arrivalLore:"Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.",availabilityModifier:{processors:.5,atmo_processors:.5,cloned_organs:2}},{id:y.BELT,name:"The Asteroid Belt",launchFlavor:"A lawless expanse of rock and riches.",navTheme:{gradient:"linear-gradient(to bottom right, #292524, #0f172a)",textColor:"#ca8a04",borderColor:"#ca8a04"},description:"A lawless frontier. Rich in raw minerals and water ice.",color:"border-amber-700",bg:"bg-gradient-to-br from-stone-800 to-slate-900",fuelPrice:600,arrivalLore:"Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.",availabilityModifier:{water_ice:2,hydroponics:.5,cybernetics:.5}},{id:y.SATURN,name:"Saturn's Rings",launchFlavor:"Opulent stations drift among majestic rings.",navTheme:{gradient:"linear-gradient(to bottom right, #713f12, #312e81, #0f172a)",textColor:"#fef08a",borderColor:"#fde047"},description:"A tourism hub. Demands luxury goods and bio-wares.",color:"border-yellow-200",bg:"bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900",fuelPrice:550,arrivalLore:"The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.",availabilityModifier:{hydroponics:.5,cryo_pods:2}},{id:y.JUPITER,name:"Jupiter",launchFlavor:"Vast refineries harvest fuel from the giant.",navTheme:{gradient:"linear-gradient(to bottom right, #9a3412, #1c1917)",textColor:"#fed7aa",borderColor:"#fb923c"},description:"A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.",color:"border-orange-400",bg:"bg-gradient-to-br from-orange-800 to-stone-900",fuelPrice:150,arrivalLore:"The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.",availabilityModifier:{water_ice:2,propellant:2,atmo_processors:2}},{id:y.URANUS,name:"Uranus",launchFlavor:"A silent, ice-cold world of strange science.",navTheme:{gradient:"linear-gradient(to bottom right, #155e75, #312e81)",textColor:"#a5f3fc",borderColor:"#67e8f9"},description:"A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.",color:"border-cyan-200",bg:"bg-gradient-to-br from-cyan-800 to-indigo-900",fuelPrice:700,arrivalLore:"The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.",availabilityModifier:{water_ice:2,processors:.5,xeno_geologicals:.5,sentient_ai:.5,antimatter:.5,folded_drives:.5}},{id:y.NEPTUNE,name:"Neptune",launchFlavor:"The stormy edge of military-controlled space.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #000000)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"A dark, stormy world, home to secretive military bases and shipyards.",color:"border-blue-400",bg:"bg-gradient-to-br from-blue-900 to-black",fuelPrice:650,arrivalLore:"Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.",availabilityModifier:{water_ice:2,sentient_ai:.5,antimatter:.5,folded_drives:.5}},{id:y.PLUTO,name:"Pluto",launchFlavor:"A haven for outcasts at the system's fringe.",navTheme:{gradient:"linear-gradient(to bottom right, #312e81, #0f172a)",textColor:"#c4b5fd",borderColor:"#a78bfa"},description:"The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.",color:"border-indigo-400",bg:"bg-gradient-to-br from-indigo-900 to-slate-900",fuelPrice:900,arrivalLore:"Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.",availabilityModifier:{water_ice:2,hydroponics:.5,cybernetics:.5,cloned_organs:.5,xeno_geologicals:2}},{id:y.EXCHANGE,name:"The Exchange",launchFlavor:"The notorious black market of the outer belt.",navTheme:{gradient:"linear-gradient(to bottom right, #581c87, #000000, #0f172a)",textColor:"#e9d5ff",borderColor:"#c084fc"},description:"A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.",color:"border-purple-500",bg:"bg-gradient-to-br from-purple-900 via-black to-slate-900",fuelPrice:1200,arrivalLore:"A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.",availabilityModifier:{}},{id:y.KEPLER,name:"Kepler's Eye",launchFlavor:"A colossal lens staring into the infinite void.",navTheme:{gradient:"linear-gradient(to bottom right, #701a75, #0f172a)",textColor:"#f472b6",borderColor:"#ec4899"},description:"A massive deep-space observatory that consumes vast amounts of processing power.",color:"border-fuchsia-500",bg:"bg-gradient-to-br from-fuchsia-900 to-slate-900",fuelPrice:800,arrivalLore:"The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.",availabilityModifier:{}}],MISSIONS:{mission_tutorial_01:{id:"mission_tutorial_01",name:"Milk Run to Luna",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"Hey buddy, you're a new captain, right? My hauler's reactor is fried and I'm on the hook for a delivery to Luna.<br><br>Could you take this load of <b>plasteel</b> to the Moon for me? I don't have credits to spare, but I've padded the manifest.<br><br>Deliver what I owe, keep the rest. You won't have trouble selling it there, trust me.",objectives:[{type:"have_item",goodId:"plasteel",quantity:5}],completion:{locationId:"loc_luna",title:"Favor Complete",text:"The freelancer sends his thanks.",buttonText:"Deliver Plasteel"},rewards:[],providedCargo:[{goodId:"plasteel",quantity:6}]},mission_tutorial_02:{id:"mission_tutorial_02",name:"The Mars Margin",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"A construction crew on Mars has requested a small shipment of plasteel to complete a habitat.",prerequisites:[{type:"mission_completed",missionId:"mission_tutorial_01"}],objectives:[{type:"have_item",goodId:"plasteel",quantity:2}],completion:{locationId:"loc_mars",title:"Delivery Complete",text:"The construction foreman thanks you for the Plasteel.",buttonText:"Deliver Plasteel"},rewards:[{type:"credits",amount:7500}]},mission_tutorial_03:{id:"mission_tutorial_03",name:"The Terran Contract",type:"DELIVERY",host:"GUILD",isRepeatable:!1,isAbandonable:!1,description:"Urgent acquisition required: 10 units of Martian-grown Hydroponics for agricultural analysis. Premium offered for prompt delivery to the orbital stations of Earth.",prerequisites:[{type:"mission_completed",missionId:"mission_tutorial_02"}],objectives:[{type:"have_item",goodId:"hydroponics",quantity:10}],completion:{locationId:"loc_earth",title:"Contract Fulfilled",text:"The Terran Alliance R&D Division confirms receipt of the samples. Your payment has been authorized.",buttonText:"Deliver Samples"},rewards:[{type:"credits",amount:15e3}]},mission_license_t3:{id:"mission_license_t3",name:"Guild Certification",type:"LICENSE_GRANT",host:"GUILD",isRepeatable:!1,isAbandonable:!1,description:"The Merchant's Guild requires you to certify your trade proficiency. Accepting this contract formally recognizes your status and grants you access to Tier 3 commodities.",prerequisites:[{type:"revealed_tier",tier:3}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t3_license"}]},mission_license_t5:{id:"mission_license_t5",name:"Governor's Contract",type:"LICENSE_GRANT",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"The planetary governor requires a sign of your commitment to local industry. This contract solidifies your standing and unlocks access to Tier 5 commodities.",prerequisites:[{type:"revealed_tier",tier:5}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t5_license"}]},mission_license_t7:{id:"mission_license_t7",name:"Legendary Run",type:"LICENSE_GRANT",host:"UNKNOWN",isRepeatable:!1,isAbandonable:!1,description:"Your name is spoken in the farthest corners of the system. Only a legend of your stature may be granted the right to trade the most advanced technologies known.",prerequisites:[{type:"revealed_tier",tier:7}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t7_license"}]}},TUTORIAL_DATA:{intro_hangar:{title:"Your First Ship",trigger:{type:D.ACTION,action:"INTRO_START_HANGAR"},navLock:!0,steps:[{stepId:"hangar_1",text:"Welcome to the <b>Shipyard</b> on <b>Mars!</b><br><br>Every station has a port from which you can trade ships and manage your hangar.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:D.INFO},nextStepId:"hangar_2",isSkippable:!0},{stepId:"hangar_2",text:"Now that you've borrowed <b class='hl-yellow font-bold'>extra credits</b>, you can buy your first ship!<br><br>Select one of the options in the <b>Shipyard</b>. Choose carefully...",position:{desktop:"bottom-right",mobile:"top"},completion:{type:D.ACTION,action:b.BUY_SHIP},nextStepId:"hangar_3",isSkippable:!0},{stepId:"hangar_3",text:'Congratulations! Your new vessel is now in your <b>Hangar</b>. Select it and <b class="hl-yellow font-bold">Board</b> to make it your active ship.',position:{desktop:"bottom-right",mobile:"top-center"},completion:{type:D.ACTION,action:b.SELECT_SHIP},nextStepId:null,isSkippable:!1}]},intro_finance:{title:"Managing Your Debt",trigger:{type:D.ACTION,action:"INTRO_START_FINANCE"},navLock:!0,steps:[{stepId:"finance_1",text:"That was a big purchase, but don't worry - you've still got some <b class='hl-yellow font-bold'>credits</b> left over! All of your transaction history and debts can be viewed in your <b>Finances</b>.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:D.INFO},nextStepId:"finance_2",isSkippable:!1},{stepId:"finance_2",text:"Dont forget, your debt to the <b class='hl-yellow font-bold'>Merchant's Guild</b> is due in <b class='hl-red font-bold'>3 years</b>. You will need to earn <b class='hl-yellow font-bold'>credits</b> to pay off your debt!",position:{desktop:"bottom-right",mobile:"top"},completion:{type:D.INFO},nextStepId:null,isSkippable:!1}]},intro_missions:{id:"intro_missions",title:"First Steps",trigger:{type:"ACTION",action:"INTRO_START_MISSIONS"},navLock:!0,steps:[{stepId:"mission_1_1",text:"This is the <b>Mission Terminal</b>. Check here for opportunities to earn <b class='hl-yellow font-bold'>credits</b> and improve your reputation.<br><br>It appears that the <b>Mars</b> station has put in a <b>Delivery</b> request.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"INFO"},nextStepId:"mission_1_2",isSkippable:!1},{stepId:"mission_1_2",text:"Select the mission '<b>Milk Run to Luna</b>' to view more details.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"ACTION",action:"show-mission-modal"},nextStepId:"mission_1_3",isSkippable:!1},{stepId:"mission_1_3",text:"The freelancer can't pay, but he's giving you the <b>remaining cargo</b>. Accept the contract.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"ACTION",action:"accept-mission"},nextStepId:"mission_1_4",isSkippable:!1},{stepId:"mission_1_4",text:"Mission accepted! The contract is now <b>active</b> and the cargo as been loaded into your ship. The freelancer also loaded extra Plasteel which you can sell for <b class='hl-yellow font-bold'>credits</b>.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"INFO"},nextStepId:"mission_1_5",isSkippable:!1},{stepId:"mission_1_5",text:"It's time for the maiden voyage of your new ship, the <b>{shipName}</b>!<br><br>Proceed to your <b>Ship Navigation</b> terminal and fly to the <b>Moon</b>.",position:{desktop:"bottom-center",mobile:"top"},completion:{type:"SCREEN_LOAD",screenId:"navigation"},nextStepId:"mission_1_6",isSkippable:!1,navLock:{navId:k.SHIP,screenId:"navigation"}},{stepId:"mission_1_6",text:"From here you can travel to other stations in the system. This will cost you <b>time</b>, <b>fuel</b>, and wear on the <b>hull</b> of your ship. Select the <b>Moon</b> to lift off from <b>Mars</b>.",position:{desktop:"top-center",mobile:"top"},completion:{type:"ACTION",action:"travel"},nextStepId:"mission_1_7",isSkippable:!1,navLock:{navId:k.SHIP,screenId:"navigation",enabledElementQuery:"[data-location-id='loc_luna']"}},{stepId:"mission_1_7",text:"You've arrived and docked at the <b>Moon</b> station! It's time to deliver the plasteel. Select the active mission and <b>deliver the plasteel</b>.",position:{desktop:"bottom-center",mobile:"top"},completion:{type:"ACTION",action:"complete-mission"},nextStepId:"mission_1_8",isSkippable:!1,navLock:{navId:k.DATA,screenId:"missions"}},{stepId:"mission_1_8",text:"Mission complete!<br><br>However, favors don't pay off <b class='hl-yellow font-bold'>Guild</b> loans. You're going to need more <b class='hl-yellow font-bold'>credits</b>.",position:{desktop:"top-center",mobile:"top"},completion:{type:"INFO"},nextStepId:"mission_2_1",isSkippable:!1},{stepId:"mission_1_9",text:"Well done. Let's find a more profitable contract. Return to the Mission Terminal.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_1",isSkippable:!1,navLock:{navId:k.DATA,screenId:"missions"}},{stepId:"mission_2_1",text:"The <i>best way to make money</i> is to play the markets yourself by <b class='hl-green font-bold'>buying low and selling high</b>.<br><br>Select the Starport to visit the <b>Moon</b> station's <b>Market</b>",position:{desktop:"top-center",mobile:"top"},completion:{type:"SCREEN_LOAD",screenId:"market"},nextStepId:"mission_2_2",isSkippable:!1,navLock:{navId:k.STARPORT,screenId:"market"}},{stepId:"mission_2_2",text:"This is the <b>Moon</b> Market. On each commodity you will find a wealth of information to inform your trading. The <b class='hl-green font-bold'>MKT</b> indicator will inform you of <b class='hl-green font-bold'>prices higher or lower than average.</b> Selecting the price will reveal past performance.<br><br>You were given extra plasteel for free, therefore selling it will yield a pure profit! Do so now.",position:{desktop:"top-center",mobile:"top"},completion:{type:"ACTION",action:"sell-item",goodId:"plasteel"},nextStepId:"mission_2_3",isSkippable:!1},{stepId:"mission_2_3",text:"Pure profit!<br><br>Let's check the Data <b>Mission Terminal</b> again.",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_4",isSkippable:!1,navLock:{navId:k.DATA,screenId:"missions"}},{stepId:"mission_2_4",text:"This mission offers a credit reward. Accept <b>The Mars Margin</b>  .",position:{desktop:"bottom-right",mobile:"top"},completion:{type:"ACTION",action:"accept-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_3_1",isSkippable:!1},{stepId:"mission_3_1",text:"Acquire plasteel from any <b>Market</b>, then travel to <b>Mars</b> to complete this mission.",position:{desktop:"top-center",mobile:"top"},completion:{type:"ACTION",action:"complete-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_final",isSkippable:!1,navLock:null},{stepId:"mission_final",text:"Well done Captain {playerName}, you have successfully completed trades across the <b>Moon</b> and <b>Mars</b>.<br><br>Continue to trade commodities for <b class='hl-green font-bold'>favorable margins</b> and complete missions to unlock additional opportunities.<br><br><b>The Solar System awaits</b>!",position:{desktop:"top-center",mobile:"top"},completion:{type:"INFO"},nextStepId:null,isSkippable:!1,buttonText:"Complete Tutorial",navLock:null}]}}};function g(c,e=!0){let t=Math.floor(c),i=e?"\u232C ":"";return t>=1e12?`${i}${(t/1e12).toFixed(2)}T`:t>=1e9?`${i}${(t/1e9).toFixed(2)}B`:t>=1e6?`${i}${(t/1e6).toFixed(2)}M`:t>=1e3?`${i}${(t/1e3).toFixed(1)}k`:`${i}${t.toLocaleString()}`}function O(c){return c?Object.values(c).reduce((e,t)=>e+t.quantity,0):0}function Ne(c){if(c>3&&c<21)return"th";switch(c%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function fe(c){let e=F.START_YEAR+Math.floor((c-1)/365),t=(c-1)%365,i=F.DAY_NAMES[(c-1+F.START_DAY_OF_WEEK)%7],a=0;for(let n=0;n<F.DAYS_IN_MONTH.length;n++){if(t<F.DAYS_IN_MONTH[n]){a=n;break}t-=F.DAYS_IN_MONTH[n]}let s=t+1,o=F.MONTH_NAMES[a];return`${i}, ${o} ${s}${Ne(s)}, ${e}`}function Q(c,e){let t=(Math.random()+Math.random()+Math.random())/3;return Math.floor(c+(e-c)*Math.pow(t,.5))}function z({price:c,sellPrice:e,galacticAvg:t,playerItem:i}){let a=c-t,s=t>0?Math.round(a/t*100):0,o=s>=0?"+":"",n="neutral";s>5&&(n="positive"),s<-5&&(n="negative");let r=s>5?"\u25B2":s<-5?"\u25BC":"\u25CF",l=`<div class="indicator-pill ${n}">${r} MKT: ${o}${s}%</div>`,h="";if(i&&i.avgCost>0){let u=e-i.avgCost;if(Math.abs(u)>.01){let p=i.avgCost>0?Math.round(u/i.avgCost*100):0,m=p>=0?"+":"",f=u>=0?"positive":"negative",T=u>=0?"\u25B2":"\u25BC";h=`<div class="indicator-pill ${f}"> P/L: ${m}${p}%</div>`}}return`${l}${h}`}function $e(c){let e={};return c.forEach((t,i)=>{e[t.id]={},c.forEach((a,s)=>{if(i===s)return;let o=Math.abs(i-s),n=o*2+Math.floor(Math.random()*3),r=Math.round(n*R.FUEL_SCALAR*(1+s/c.length*.5)),l;t.id===y.EARTH&&a.id===y.LUNA||t.id===y.LUNA&&a.id===y.EARTH?l=1+Math.floor(Math.random()*3):l=15+o*10+Math.floor(Math.random()*5),e[t.id][a.id]={time:l,fuelCost:Math.max(1,r)}})}),e}var J=class{constructor(){this.state={},this.subscribers=[],this.TRAVEL_DATA=$e(d.MARKETS)}subscribe(e){this.subscribers.push(e)}_notify(){this.subscribers.forEach(e=>e(this))}setState(e){Object.assign(this,e),this._notify()}getState(){return JSON.parse(JSON.stringify(this))}saveGame(){}loadGame(){return!1}startNewGame(e){let t={day:1,lastInterestChargeDay:1,lastMarketUpdateDay:1,currentLocationId:y.MARS,activeNav:k.SHIP,activeScreen:S.NAVIGATION,isGameOver:!1,subNavCollapsed:!1,introSequenceActive:!0,lastActiveScreen:{[k.SHIP]:S.STATUS,[k.STARPORT]:S.MARKET,[k.DATA]:S.MISSIONS},pendingTravel:null,player:{name:e,playerTitle:"Captain",playerAge:24,lastBirthdayYear:d.DATE_CONFIG.START_YEAR,birthdayProfitBonus:0,introStep:0,credits:3e3,debt:0,monthlyInterestAmount:0,loanStartDate:null,seenGarnishmentWarning:!1,revealedTier:1,unlockedLicenseIds:[],unlockedLocationIds:d.MARKETS.map(i=>i.id).filter(i=>i!==y.EXCHANGE&&i!==y.KEPLER),seenCommodityMilestones:[],financeLog:[],activePerks:{},seenEvents:[],activeShipId:A.WANDERER,ownedShipIds:[A.WANDERER],shipStates:{[A.WANDERER]:{health:d.SHIPS[A.WANDERER].maxHealth,fuel:d.SHIPS[A.WANDERER].maxFuel,hullAlerts:{one:!1,two:!1}}},inventories:{},debugEventIndex:0},market:{prices:{},inventory:{},galacticAverages:{},priceHistory:{},shipyardStock:{}},intel:{active:null,available:{}},tutorials:{activeBatchId:null,activeStepId:null,seenBatchIds:[],skippedTutorialBatches:[],navLock:null},missions:{activeMissionId:null,completedMissionIds:[],missionProgress:{},activeMissionObjectivesMet:!1},uiState:{marketCardMinimized:{}}};t.player.inventories[A.WANDERER]={},d.COMMODITIES.forEach(i=>{t.player.inventories[A.WANDERER][i.id]={quantity:0,avgCost:0}}),d.MARKETS.forEach(i=>{t.market.priceHistory[i.id]={},t.intel.available[i.id]=Math.random()<.3,t.market.inventory[i.id]={},t.market.shipyardStock[i.id]={day:0,shipsForSale:[]},d.COMMODITIES.forEach(a=>{t.market.priceHistory[i.id][a.id]=[];let[s,o]=a.canonicalAvailability,n=i.availabilityModifier?.[a.id]??1,r=Math.floor(Q(s,o)*n);i.specialDemand&&i.specialDemand[a.id]&&(r=0),t.market.inventory[i.id][a.id]={quantity:Math.max(0,r),marketPressure:0,lastPlayerInteractionTimestamp:0,hoverUntilDay:0,rivalArbitrage:{isActive:!1,endDay:0}}})}),Object.assign(this,t),this._calculateGalacticAverages(),this._seedInitialMarketPrices(),this.setState({})}_calculateGalacticAverages(){this.market.galacticAverages={},d.COMMODITIES.forEach(e=>{this.market.galacticAverages[e.id]=(e.basePriceRange[0]+e.basePriceRange[1])/2})}_seedInitialMarketPrices(){d.MARKETS.forEach(e=>{this.market.prices[e.id]={},d.COMMODITIES.forEach(t=>{let i=this.market.galacticAverages[t.id]*(1+(Math.random()-.5)*.15);this.market.prices[e.id][t.id]=Math.max(1,Math.round(i))})})}};function ye(c,e,t,i){let a=e._getActiveShip(),s=Math.floor(c.player.credits*t.wagerPercentage),o=t.winChance[a.class]||.4;Math.random()<o?(c.player.credits+=s,e._logTransaction("event",s,"Won space race wager"),i.description=`Your Class ${a.class} ship wins! You gain <span class="hl-green">${g(s)}</span>.`):(c.player.credits-=s,e._logTransaction("event",-s,"Lost space race wager"),i.description=`The luxury ship was too fast. You lose <span class="hl-red">${g(s)}</span>.`)}function ve(c,e,t){let i=e._getActiveShip(),a=c.player.shipStates[i.id],s=e._getActiveInventory();if(a.fuel=Math.max(0,a.fuel-30),s[L.CYBERNETICS]||(s[L.CYBERNETICS]={quantity:0,avgCost:0}),O(s)+40<=i.cargoCapacity)return s[L.CYBERNETICS].quantity+=40,{key:"reward_cybernetics"};if(c.player.debt>0){let o=Math.floor(c.player.debt*.2);return c.player.debt-=o,e._logTransaction("event",o,"Passenger paid off debt"),{key:"reward_debt_paid",amount:g(o)}}else{let o=Math.floor(c.player.credits*.05);return c.player.credits+=o,e._logTransaction("event",o,"Passenger payment"),{key:"reward_credits",amount:g(o)}}}var Oe={SPACE_RACE:ye,ADRIFT_PASSENGER:ve,credits:(c,e,t)=>{c.player.credits+=t.value,e._logTransaction("event",t.value,"Received credits from event")},fuel:(c,e,t)=>{let i=e._getActiveShip(),a=c.player.shipStates[i.id];a.fuel=Math.max(0,a.fuel+t.value)},hull_damage_percent:(c,e,t)=>{let i=Array.isArray(t.value)?Math.random()*(t.value[1]-t.value[0])+t.value[0]:t.value;c.pendingTravel.eventHullDamagePercent=(c.pendingTravel.eventHullDamagePercent||0)+i},travel_time_add:(c,e,t)=>{c.pendingTravel.travelTimeAdd=(c.pendingTravel.travelTimeAdd||0)+t.value},travel_time_add_percent:(c,e,t)=>{c.pendingTravel.travelTimeAddPercent=(c.pendingTravel.travelTimeAddPercent||0)+t.value},set_travel_time:(c,e,t)=>{c.pendingTravel.setTravelTime=t.value},add_debt:(c,e,t)=>{c.player.debt<=0&&(c.player.loanStartDate=c.day,c.player.weeklyInterestAmount=0);let i=Math.ceil(t.value*.013);c.player.weeklyInterestAmount+=i,c.player.debt+=t.value,e._logTransaction("loan",t.value,"Incurred debt from event")},add_cargo:(c,e,t,i)=>{let a=e._getActiveShip(),s=e._getActiveInventory(),o=d.COMMODITIES.find(n=>n.id===t.value.id);O(s)+t.value.quantity<=a.cargoCapacity?s[t.value.id].quantity+=t.value.quantity:i.description=`You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${o.name}</span> behind.`},lose_cargo:(c,e,t)=>{let i=e._getActiveInventory();i[t.value.id].quantity=Math.max(0,i[t.value.id].quantity-t.value.quantity)},lose_random_cargo_percent:(c,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],n=Math.ceil(o.quantity*t.value);o.quantity=Math.max(0,o.quantity-n)}},sell_random_cargo_premium:(c,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],n=c.market.galacticAverages[s]*t.value*o.quantity;c.player.credits+=n,e._logTransaction("trade",n,"Emergency supply drop sale"),o.quantity=0}},set_new_random_destination:(c,e,t)=>{let i=d.MARKETS.filter(a=>a.id!==c.currentLocationId&&c.player.unlockedLocationIds.includes(a.id));i.length>0&&(c.pendingTravel.destinationId=i[Math.floor(Math.random()*i.length)].id)}};function Se(c,e,t,i){let a=Oe[t.type];if(a)return a(c,e,t,i);console.warn(`No handler found for event effect type: ${t.type}`)}var Z=class{constructor(e){this.gameState=e,this._currentSystemState=null,this._systemStateExpirationDay=0}checkForSystemStateChange(){if(this.gameState.day>this._systemStateExpirationDay){let e=Object.keys(d.SYSTEM_STATES),t=e[Math.floor(Math.random()*e.length)];this._currentSystemState=d.SYSTEM_STATES[t],this._systemStateExpirationDay=this.gameState.day+this._currentSystemState.duration}}evolveMarketPrices(){d.MARKETS.forEach(e=>{d.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id],a=this.gameState.market.prices[e.id][t.id],o=this.gameState.market.galacticAverages[t.id],n=R.DAILY_PRICE_VOLATILITY,r=R.MEAN_REVERSION_STRENGTH,l=this._currentSystemState?.modifiers?.commodity?.[t.id];l&&(l.volatility_mult&&(n*=l.volatility_mult),l.mean_reversion_mult&&(r*=l.mean_reversion_mult));let h=t.basePriceRange[1]-t.basePriceRange[0],u=(Math.random()-.5)*h*n,p=(o-a)*r;i.rivalArbitrage.isActive&&this.gameState.day<i.rivalArbitrage.endDay?p=(o-a)*.2:i.rivalArbitrage.isActive&&(i.rivalArbitrage.isActive=!1),i.hoverUntilDay>this.gameState.day?p*=.1:i.hoverUntilDay>0&&(i.hoverUntilDay=0);let m=o*i.marketPressure*-1,f=a+u+p+m;this._currentSystemState?.modifiers?.commodity?.[t.id]?.price&&(f*=this._currentSystemState.modifiers.commodity[t.id].price),this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(f)),i.marketPressure*=R.MARKET_PRESSURE_DECAY,Math.abs(i.marketPressure)<.001&&(i.marketPressure=0)}),this._recordPriceHistory(e.id)})}replenishMarketInventory(){d.MARKETS.forEach(e=>{d.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id];if(i.lastPlayerInteractionTimestamp>0&&this.gameState.day-i.lastPlayerInteractionTimestamp>60)i.quantity=this._calculateBaselineStock(e,t),i.lastPlayerInteractionTimestamp=0,i.marketPressure=0;else{let[n,r]=t.canonicalAvailability,l=(n+r)/2*(e.availabilityModifier?.[t.id]??1),h=1-Math.min(.5,i.marketPressure*.5),m=(l*h-i.quantity)*.15;i.quantity+=m}let a=Math.random()*.15+.15,s=Math.random()<.5?-1:1,o=1+a*s;i.quantity*=o,this._currentSystemState?.modifiers?.commodity?.[t.id]?.availability&&(i.quantity*=this._currentSystemState.modifiers.commodity[t.id].availability),i.quantity=Math.max(0,Math.round(i.quantity))})})}_calculateBaselineStock(e,t){let[i,a]=t.canonicalAvailability,s=e.availabilityModifier?.[t.id]??1;return Math.floor(Q(i,a)*s)}_recordPriceHistory(e=null){if(!this.gameState||!this.gameState.market)return;let t=e||this.gameState.currentLocationId;this.gameState.market.priceHistory[t]||(this.gameState.market.priceHistory[t]={}),d.COMMODITIES.forEach(i=>{if(i.tier>this.gameState.player.revealedTier)return;this.gameState.market.priceHistory[t][i.id]||(this.gameState.market.priceHistory[t][i.id]=[]);let a=this.gameState.market.priceHistory[t][i.id],s=this.gameState.market.prices[t][i.id],o=a[a.length-1];for(o&&o.day===this.gameState.day?o.price!==s&&(o.price=s):a.push({day:this.gameState.day,price:s});a.length>R.PRICE_HISTORY_LENGTH;)a.shift()})}};var ee=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.tutorialService=null,this.missionService=null,this.marketService=new Z(e)}setTutorialService(e){this.tutorialService=e}setMissionService(e){this.missionService=e}startIntroSequence(){this.gameState.introSequenceActive&&(this.logger.info.state(this.gameState.day,"INTRO_START","Starting new game introduction sequence."),this.gameState.player.introStep=0,this._showNextIntroModal())}_showNextIntroModal(){let e=d.INTRO_SEQUENCE_V1.modals[this.gameState.player.introStep];if(!e){this._endIntroSequence();return}let t={buttonClass:e.buttonClass,contentClass:e.contentClass},i="event-modal";e.id==="charter"||e.id==="signature"?(i=`${e.id}-modal`,t.customSetup=(a,s)=>{this._setupIntroModal(a,e,s)}):t.customSetup=(a,s)=>{let o=a.querySelector("#event-button-container");if(!o)return;o.innerHTML="";let n=document.createElement("button");n.className="btn px-6 py-2",e.buttonClass&&n.classList.add(e.buttonClass),n.id="intro-next-btn",n.innerHTML=e.buttonText,n.onclick=r=>{r.target.disabled=!0,s()},o.appendChild(n)},this.uiManager.queueModal(i,e.title,e.description,null,t)}_setupIntroModal(e,t,i){let a=e.querySelector(`#${t.id}-button-container`);a.innerHTML="";let s=document.createElement("button");if(s.className="btn px-6 py-2",s.innerHTML=t.buttonText,s.onclick=o=>{o.target.disabled=!0,i()},a.appendChild(s),t.id==="signature"){let o=e.querySelector("#signature-input");o.value="",s.id="intro-submit-btn",s.disabled=!0,s.onclick=i,o.oninput=()=>{s.disabled=o.value.trim()===""}}else s.id="intro-next-btn"}handleIntroClick(e){let t=e.target.closest("button");if(!t)return;let i=t.id;if(i==="intro-next-btn")t.disabled=!0,this.gameState.player.introStep++,this._showNextIntroModal();else if(i==="intro-submit-btn"){t.disabled=!0;let s=document.getElementById("signature-input").value.trim().replace(/[^a-zA-Z0-9 ]/g,"");s?(this.gameState.player.name=s,this.gameState.player.debt=25e3,this.gameState.player.loanStartDate=this.gameState.day,this.gameState.player.monthlyInterestAmount=390,this.gameState.player.ownedShipIds=[],delete this.gameState.player.shipStates[A.WANDERER],delete this.gameState.player.inventories[A.WANDERER],this.gameState.player.activeShipId=null,this.logger.info.state(this.gameState.day,"LOAN_ACCEPTED",`Player ${s} accepted Guild loan.`,{debt:25e3,name:s}),this._startProcessingSequence()):(this.uiManager.queueModal("event-modal","Invalid Signature","The Merchant's Guild requires a name on the contract. Please provide your legal mark."),t.disabled=!1,this._showNextIntroModal())}}_startProcessingSequence(){let e=()=>{let t="Loan Approved",i=`Dear ${this.gameState.player.name},<br><br>Your line of credit has been <b>approved</b>.<br><br><span class="credits-text-pulsing">\u232C 25,000</span> is ready to transfer to your account.`,a=s=>{let o=s.target;o&&(o.disabled=!0),this.uiManager.createFloatingText(`+${g(25e3,!1)}`,s.clientX,s.clientY,"#34d399"),this.gameState.player.credits+=25e3,this.logger.info.player(this.gameState.day,"CREDITS_TRANSFER","Accepted loan transfer of \u232C25,000"),setTimeout(()=>{document.getElementById("game-container").classList.remove("hidden"),this.uiManager.render(this.gameState.getState()),this.setScreen(k.STARPORT,S.HANGAR),this.tutorialService.checkState({type:"ACTION",action:"INTRO_START_HANGAR"})},2e3)};this.uiManager.queueModal("event-modal",t,i,null,{contentClass:"text-center",customSetup:(s,o)=>{s.querySelector(".modal-content").classList.add("modal-theme-admin");let n=s.querySelector("#event-button-container");n.innerHTML="";let r=document.createElement("button");r.className="btn px-6 py-2",r.innerHTML="Accept Transfer",r.onclick=l=>{a(l),o()},n.appendChild(r)}})};this.uiManager.showProcessingAnimation(this.gameState.player.name,e)}_continueIntroSequence(e){e==="intro_hangar"?(this.setScreen(k.DATA,S.FINANCE),this.tutorialService.checkState({type:"ACTION",action:"INTRO_START_FINANCE"})):e==="intro_finance"&&this._endIntroSequence()}_endIntroSequence(){this.gameState.introSequenceActive=!1,this.logger.info.state(this.gameState.day,"INTRO_END","Introduction sequence complete.");let e=d.INTRO_SEQUENCE_V1.modals.find(a=>a.id==="final"),t=d.SHIPS[this.gameState.player.activeShipId].name,i=e.buttonText.replace("{shipName}",t);this.gameState.tutorials.navLock={navId:k.DATA,screenId:S.FINANCE},this.uiManager.queueModal("event-modal",e.title,e.description,()=>{this.setScreen(k.DATA,S.MISSIONS),this.tutorialService.checkState({type:"ACTION",action:"INTRO_START_MISSIONS"})},{buttonText:i}),this.uiManager.render(this.gameState.getState())}setScreen(e,t){let i={...this.gameState.lastActiveScreen,[e]:t};this.gameState.setState({activeNav:e,activeScreen:t,lastActiveScreen:i}),this.tutorialService&&this.tutorialService.checkState({type:"SCREEN_LOAD",screenId:t})}travelTo(e){this.uiManager.resetMarketTransactionState();let{tutorials:t}=this.gameState,{navLock:i}=t;if(i&&i.screenId===S.NAVIGATION&&i.enabledElementQuery&&!i.enabledElementQuery.includes(`[data-location-id='${e}']`))return;let a=this.gameState.getState();if(a.isGameOver||a.pendingTravel)return;if(a.currentLocationId===e){this.setScreen(k.STARPORT,S.MARKET);return}let s=this._getActiveShip();if(!s){this.uiManager.queueModal("event-modal","No Active Ship","You must have an active vessel to travel.");return}let n=a.TRAVEL_DATA[a.currentLocationId][e].fuelCost;if(a.player.activePerks[M.NAVIGATOR]&&(n=Math.round(n*d.PERKS[M.NAVIGATOR].fuelMod)),s.maxFuel<n){this.uiManager.queueModal("event-modal","Fuel Capacity Insufficient",`Your ship's fuel tank is too small. This trip requires ${n} fuel, but you can only hold ${s.maxFuel}.`);return}if(s.fuel<n){this.uiManager.queueModal("event-modal","Insufficient Fuel",`You need ${n} fuel but only have ${Math.floor(s.fuel)}.`);return}!(a.tutorials.activeBatchId==="intro_missions"&&a.tutorials.activeStepId==="mission_1_6")&&this._checkForRandomEvent(e)||this.initiateTravel(e)}initiateTravel(e,t={}){let i=this.gameState.getState(),a=i.currentLocationId,s={...i.TRAVEL_DATA[a][e]};this.logger.info.player(i.day,"TRAVEL_START",`Departing from ${a} to ${e}.`),i.player.activePerks[M.NAVIGATOR]&&(s.time=Math.round(s.time*d.PERKS[M.NAVIGATOR].travelTimeMod),s.fuelCost=Math.round(s.fuelCost*d.PERKS[M.NAVIGATOR].fuelMod)),t.travelTimeAdd&&(s.time+=t.travelTimeAdd),t.travelTimeAddPercent&&(s.time*=1+t.travelTimeAddPercent),t.setTravelTime&&(s.time=t.setTravelTime),s.time=Math.max(1,Math.round(s.time));let o=this._getActiveShip(),n=this.gameState.player.shipStates[o.id];if(o.fuel<s.fuelCost){this.uiManager.queueModal("event-modal","Insufficient Fuel",`Trip modifications left you without enough fuel. You need ${s.fuelCost} but only have ${Math.floor(o.fuel)}.`),this.logger.warn("SimulationService",`Travel to ${e} aborted due to insufficient fuel after event mods.`);return}if(t.forceEvent&&this._checkForRandomEvent(e,!0))return;let r=s.time*R.HULL_DECAY_PER_TRAVEL_DAY;i.player.activePerks[M.NAVIGATOR]&&(r*=d.PERKS[M.NAVIGATOR].hullDecayMod);let l=o.maxHealth*((t.eventHullDamagePercent||0)/100),h=r+l;if(n.health-=h,this._checkHullWarnings(o.id),n.health<=0){this._handleShipDestruction(o.id);return}if(n.fuel-=s.fuelCost,this._advanceDays(s.time),this.gameState.isGameOver)return;this.gameState.setState({currentLocationId:e,pendingTravel:null});let u=d.MARKETS.find(T=>T.id===a),p=d.MARKETS.find(T=>T.id===e),m=h/o.maxHealth*100;this.logger.info.player(this.gameState.day,"TRAVEL_END",`Arrived at ${e}.`,{fuelUsed:s.fuelCost,hullDamage:m.toFixed(2)+"%"});let f=()=>{this.gameState.tutorials.activeBatchId==="intro_missions"&&this.gameState.tutorials.activeStepId==="mission_1_7"&&e===y.LUNA?this.setScreen(k.DATA,S.MISSIONS):this.setScreen(k.STARPORT,S.MARKET)};this.uiManager.showTravelAnimation(u,p,s,m,f)}resumeTravel(){if(!this.gameState.pendingTravel)return;this.logger.info.system("Game",this.gameState.day,"TRAVEL_RESUME","Resuming travel after event.");let{destinationId:e,...t}=this.gameState.pendingTravel;this.initiateTravel(e,t)}_calculateDiminishingReturns(e,t,i){let a=d.COMMODITIES.find(u=>u.id===e),s=this.gameState.market.inventory[i][e].quantity,o=this.uiManager.getItemPrice(this.gameState.getState(),e,!0),n=s*.1;if(t<=n)return{totalPrice:o*t,effectivePricePerUnit:o};let r=t/s,l=0;a.tier<=2?l=Math.min(.1,(r-.1)*.2):a.tier<=5?l=Math.min(.25,(r-.1)*.5):l=Math.min(.4,(r-.1)*.8);let h=o*(1-l);return{totalPrice:Math.floor(h*t),effectivePricePerUnit:h}}buyItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return!1;let a=d.COMMODITIES.find(p=>p.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),!1;let o=this.uiManager.getItemPrice(i,e)*t,n=i.market.inventory[i.currentLocationId][e].quantity;if(n<=0)return this.uiManager.queueModal("event-modal","Sold Out",`This station has no more ${a.name} available.`),!1;if(t>n)return this.uiManager.queueModal("event-modal","Limited Stock",`This station only has ${n} units available.`),!1;let r=this._getActiveShip(),l=this._getActiveInventory();if(O(l)+t>r.cargoCapacity)return this.uiManager.queueModal("event-modal","Cargo Hold Full","You don't have enough space."),!1;if(i.player.credits<o)return this.uiManager.queueModal("event-modal","Insufficient Funds","Your credit balance is too low."),!1;let h=this.gameState.market.inventory[i.currentLocationId][e];h.quantity-=t;let u=l[e];return u.avgCost=(u.quantity*u.avgCost+o)/(u.quantity+t),u.quantity+=t,this.gameState.player.credits-=o,this.logger.info.player(i.day,"BUY",`Bought ${t}x ${a.name} for ${g(o)}`),this._logConsolidatedTrade(a.name,t,-o),this._checkMilestones(),this.missionService.checkTriggers(),this._applyMarketImpact(e,t,"buy"),this.gameState.setState({}),!0}sellItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return 0;let a=d.COMMODITIES.find(u=>u.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),0;let o=this._getActiveInventory()[e];if(!o||o.quantity<t)return this.uiManager.queueModal("event-modal","Insufficient Inventory",`You do not have ${t} units of ${a.name} to sell.`),0;let{totalPrice:n}=this._calculateDiminishingReturns(e,t,i.currentLocationId),r=n,l=r-o.avgCost*t;if(l>0){let u=(i.player.activePerks[M.TRADEMASTER]?d.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);r+=l*u}r=Math.floor(r),this.gameState.player.credits+=r,o.quantity-=t,o.quantity===0&&(o.avgCost=0);let h=this.gameState.market.inventory[i.currentLocationId][e];return h.quantity+=t,this.logger.info.player(i.day,"SELL",`Sold ${t}x ${a.name} for ${g(r)}`),this._logConsolidatedTrade(a.name,t,r),this._checkMilestones(),this.missionService.checkTriggers(),this._applyMarketImpact(e,t,"sell"),this.gameState.setState({}),r}_applyMarketImpact(e,t,i){let a=d.COMMODITIES.find(n=>n.id===e),s=this.gameState.market.inventory[this.gameState.currentLocationId][e],o=t/(a.canonicalAvailability[1]||100)*a.tier/10;i==="buy"?s.marketPressure-=o:s.marketPressure+=o,s.lastPlayerInteractionTimestamp=this.gameState.day}buyShip(e){let t=d.SHIPS[e];return this.gameState.player.credits<t.price?(this.uiManager.queueModal("event-modal","Insufficient Funds","You cannot afford this ship."),!1):(this.gameState.player.credits-=t.price,this.logger.info.player(this.gameState.day,"SHIP_PURCHASE",`Purchased ${t.name} for ${g(t.price)}.`),this._logTransaction("ship",-t.price,`Purchased ${t.name}`),this.addShipToHangar(e),this.uiManager.queueModal("event-modal","Acquisition Complete",`The ${t.name} has been transferred to your hangar.`),this.gameState.introSequenceActive&&this.tutorialService.checkState({type:"ACTION",action:b.BUY_SHIP}),this.gameState.setState({}),!0)}sellShip(e){let t=this.gameState.getState();if(t.player.ownedShipIds.length<=1)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your last remaining ship."),!1;if(e===t.player.activeShipId)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your active ship."),!1;if(O(t.player.inventories[e])>0)return this.uiManager.queueModal("event-modal","Cannot Sell Ship","This vessel's cargo hold is not empty."),!1;let i=d.SHIPS[e],a=Math.floor(i.price*R.SHIP_SELL_MODIFIER);return this.gameState.player.credits+=a,this.logger.info.player(this.gameState.day,"SHIP_SALE",`Sold ${i.name} for ${g(a)}.`),this._logTransaction("ship",a,`Sold ${i.name}`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(s=>s!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.uiManager.queueModal("event-modal","Vessel Sold",`You sold the ${i.name} for ${g(a)}.`),this.gameState.setState({}),a}setActiveShip(e){this.gameState.player.ownedShipIds.includes(e)&&(this.gameState.player.activeShipId=e,this.logger.info.player(this.gameState.day,"SET_ACTIVE_SHIP",`Boarded the ${d.SHIPS[e].name}.`),this.gameState.introSequenceActive&&this.tutorialService.checkState({type:"ACTION",action:b.SELECT_SHIP}),this.gameState.setState({}))}payOffDebt(){if(this.gameState.isGameOver)return;let{player:e}=this.gameState;if(e.credits<e.debt){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford to pay off your entire debt.");return}let t=e.debt;e.credits-=t,this.logger.info.player(this.gameState.day,"DEBT_PAID",`Paid off ${g(t)} in debt.`),this._logTransaction("loan",-t,`Paid off ${g(t)} debt`),e.debt=0,e.monthlyInterestAmount=0,e.loanStartDate=null,this._checkMilestones(),this.gameState.setState({})}takeLoan(e){let{player:t,day:i}=this.gameState;if(t.debt>0){this.uiManager.queueModal("event-modal","Loan Unavailable","You must pay off your existing debt first.");return}if(t.credits<e.fee){this.uiManager.queueModal("event-modal","Unable to Secure Loan",`The financing fee is ${g(e.fee)}, but you only have ${g(t.credits)}.`);return}t.credits-=e.fee,this._logTransaction("loan",-e.fee,`Financing fee for ${g(e.amount)} loan`),t.credits+=e.amount,this._logTransaction("loan",e.amount,`Acquired ${g(e.amount)} loan`),t.debt+=e.amount,t.monthlyInterestAmount=e.interest,t.loanStartDate=i,t.seenGarnishmentWarning=!1;let a=`You've acquired a loan of <span class="hl-blue">${g(e.amount)}</span>.<br>A financing fee of <span class="hl-red">${g(e.fee)}</span> was deducted.`;this.uiManager.queueModal("event-modal","Loan Acquired",a),this.logger.info.player(i,"LOAN_TAKEN",`Took a loan for ${g(e.amount)}.`),this.gameState.setState({})}purchaseLicense(e){let t=d.LICENSES[e],{player:i,day:a}=this.gameState;return t?t.type!=="purchase"?{success:!1,error:"NOT_FOR_PURCHASE"}:i.unlockedLicenseIds.includes(e)?{success:!1,error:"ALREADY_OWNED"}:i.credits<t.cost?{success:!1,error:"INSUFFICIENT_FUNDS"}:(i.credits-=t.cost,i.unlockedLicenseIds.push(e),this.logger.info.player(a,"LICENSE_PURCHASE",`Purchased ${t.name}.`),this._logTransaction("license",-t.cost,`Purchased ${t.name}`),this.gameState.setState({}),{success:!0}):{success:!1,error:"INVALID_LICENSE"}}purchaseIntel(e){let{player:t,currentLocationId:i,day:a}=this.gameState;if(t.credits<e){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford this intel.");return}t.credits-=e,this.logger.info.player(a,"INTEL_PURCHASE",`Purchased intel for ${g(e)}.`),this._logTransaction("intel",-e,"Purchased market intel"),this.gameState.intel.available[i]=!1;let s=d.MARKETS.filter(l=>l.id!==i&&t.unlockedLocationIds.includes(l.id));if(s.length===0)return;let o=s[Math.floor(Math.random()*s.length)],n=d.COMMODITIES.filter(l=>l.tier<=t.revealedTier),r=n[Math.floor(Math.random()*n.length)];r&&(this.gameState.intel.active={targetMarketId:o.id,commodityId:r.id,type:"demand",startDay:a,endDay:a+100}),this.gameState.setState({})}refuelTick(){let e=this.gameState,t=this._getActiveShip();if(t.fuel>=t.maxFuel)return 0;let i=d.MARKETS.find(a=>a.id===e.currentLocationId).fuelPrice/2;return e.player.activePerks[M.VENETIAN_SYNDICATE]&&e.currentLocationId===y.VENUS&&(i*=1-d.PERKS[M.VENETIAN_SYNDICATE].fuelDiscount),e.player.credits<i?0:(e.player.credits-=i,e.player.shipStates[t.id].fuel=Math.min(t.maxFuel,e.player.shipStates[t.id].fuel+5),this._logConsolidatedTransaction("fuel",-i,"Fuel Purchase"),this.gameState.setState({}),i)}repairTick(){let e=this.gameState,t=this._getActiveShip();if(t.health>=t.maxHealth)return 0;let i=t.maxHealth*(R.REPAIR_AMOUNT_PER_TICK/100)*R.REPAIR_COST_PER_HP;return e.player.activePerks[M.VENETIAN_SYNDICATE]&&e.currentLocationId===y.VENUS&&(i*=1-d.PERKS[M.VENETIAN_SYNDICATE].repairDiscount),e.player.credits<i?0:(e.player.credits-=i,e.player.shipStates[t.id].health=Math.min(t.maxHealth,e.player.shipStates[t.id].health+t.maxHealth*(R.REPAIR_AMOUNT_PER_TICK/100)),this._logConsolidatedTransaction("repair",-i,"Hull Repairs"),this._checkHullWarnings(t.id),this.gameState.setState({}),i)}_advanceDays(e){this.logger.group(`[System] Advancing time by ${e} day(s) from Day ${this.gameState.day}`);for(let t=0;t<e;t++){if(this.gameState.isGameOver){this.logger.warn("SimulationService","Advance days aborted: Game is over."),this.logger.groupEnd();return}this.gameState.day++;let i=(this.gameState.day-1)%365,a=d.DATE_CONFIG.START_YEAR+Math.floor((this.gameState.day-1)/365);if(i===11&&a>this.gameState.player.lastBirthdayYear&&(this.gameState.player.playerAge++,this.gameState.player.birthdayProfitBonus+=.01,this.gameState.player.lastBirthdayYear=a,this.uiManager.queueModal("event-modal",`Captain ${this.gameState.player.name}`,`You are now ${this.gameState.player.playerAge}. You feel older and wiser.<br><br>Your experience now grants you an additional 1% profit on all trades.`),this.logger.info.state(this.gameState.day,"BIRTHDAY",`Player is now age ${this.gameState.player.playerAge}. Profit bonus increased.`)),this._checkAgeEvents(),this.marketService.evolveMarketPrices(),this.gameState.day-this.gameState.lastMarketUpdateDay>=7&&(this.marketService.checkForSystemStateChange(),this.marketService.replenishMarketInventory(),this._updateShipyardStock(),this.gameState.lastMarketUpdateDay=this.gameState.day),this.gameState.intel.active&&this.gameState.day>this.gameState.intel.active.endDay&&(this.logger.info.system("Intel",this.gameState.day,"EXPIRED","Active intel has expired."),this.gameState.intel.active=null),this.gameState.player.ownedShipIds.forEach(s=>{if(s!==this.gameState.player.activeShipId){let o=d.SHIPS[s],n=o.maxHealth*R.PASSIVE_REPAIR_RATE;this.gameState.player.shipStates[s].health=Math.min(o.maxHealth,this.gameState.player.shipStates[s].health+n)}}),this.gameState.player.debt>0&&this.gameState.day-this.gameState.lastInterestChargeDay>=R.INTEREST_INTERVAL){let s=this.gameState.player.monthlyInterestAmount;this.gameState.player.debt+=s,this._logTransaction("loan",s,"Monthly interest charge"),this.logger.info.system("Finance",this.gameState.day,"INTEREST",`Charged ${g(s)} interest on debt.`),this.gameState.lastInterestChargeDay=this.gameState.day}}this.logger.groupEnd(),this.gameState.setState({})}_checkForRandomEvent(e,t=!1){if(t===!1&&Math.random()>R.RANDOM_EVENT_CHANCE)return!1;let i=this._getActiveShip(),a;if(typeof t=="number")a=d.RANDOM_EVENTS[t];else{let s=d.RANDOM_EVENTS.filter(o=>o.precondition(this.gameState.getState(),i,this._getActiveInventory.bind(this)));if(s.length===0)return!1;a=s[Math.floor(Math.random()*s.length)]}return a?(this.logger.info.system("Event",this.gameState.day,"EVENT_TRIGGER",`Triggered random event: ${a.title}`),this.gameState.setState({pendingTravel:{destinationId:e}}),this.uiManager.showRandomEventModal(a,(s,o)=>this._resolveEventChoice(s,o)),!0):(this.logger.warn("SimulationService",`Debug event trigger failed for index: ${t}`),this.gameState.player.debugEventIndex=0,!1)}_resolveEventChoice(e,t){let i=d.RANDOM_EVENTS.find(l=>l.id===e),a=i.choices[t],s=Math.random(),o=a.outcomes.find(l=>(s-=l.chance)<0)||a.outcomes[a.outcomes.length-1],n=this._applyEventEffects(o),r=o.description;n&&o.descriptions&&(r=o.descriptions[n.key],n.amount&&(r=r.replace("{amount}",n.amount))),this.logger.info.player(this.gameState.day,"EVENT_CHOICE",`Chose '${a.title}' for event '${i.title}'.`),this.uiManager.queueModal("event-modal",i.title,r,()=>this.resumeTravel(),{buttonText:"Continue Journey"})}_applyEventEffects(e){let t=null;return e.effects.forEach(i=>{let a=Se(this.gameState,this,i,e);a&&(t=a)}),this.gameState.setState({}),t}_checkAgeEvents(){d.AGE_EVENTS.forEach(e=>{this.gameState.player.seenEvents.includes(e.id)||(e.trigger.day&&this.gameState.day>=e.trigger.day||e.trigger.credits&&this.gameState.player.credits>=e.trigger.credits)&&(this.gameState.player.seenEvents.push(e.id),this.logger.info.state(this.gameState.day,"AGE_EVENT",`Triggered age event: ${e.title}`),this.uiManager.showAgeEventModal(e,t=>this._applyPerk(t)))})}_applyPerk(e){this.logger.info.player(this.gameState.day,"PERK_APPLIED",`Gained perk: ${e.title}`),e.perkId&&(this.gameState.player.activePerks[e.perkId]=!0),e.playerTitle&&(this.gameState.player.playerTitle=e.playerTitle),e.perkId===M.MERCHANT_GUILD_SHIP&&(this.addShipToHangar(A.STALWART),this.uiManager.queueModal("event-modal","Vessel Delivered",`The Merchant's Guild has delivered a new ${d.SHIPS[A.STALWART].name} to your hangar.`)),this.gameState.setState({})}_getActiveShip(){let e=this.gameState,t=e.player.activeShipId;return t?{id:t,...d.SHIPS[t],...e.player.shipStates[t]}:null}_getActiveInventory(){return this.gameState.player.activeShipId?this.gameState.player.inventories[this.gameState.player.activeShipId]:null}_logTransaction(e,t,i){this.gameState.player.financeLog.push({day:this.gameState.day,type:e,amount:t,balance:this.gameState.player.credits,description:i})}_logConsolidatedTrade(e,t,i){let a=this.gameState.player.financeLog,s=i<0,o=s?"Bought":"Sold",n=a.find(r=>r.day===this.gameState.day&&r.type==="trade"&&r.description.startsWith(`${o}`)&&r.description.endsWith(` ${e}`)&&(s&&r.amount<0||!s&&r.amount>0));if(n){n.amount+=i,n.balance=this.gameState.player.credits;let r=n.description.match(/\s(\d+)x\s/);if(r){let h=parseInt(r[1],10)+t;n.description=`${o} ${h}x ${e}`}}else this._logTransaction("trade",i,`${o} ${t}x ${e}`)}_logConsolidatedTransaction(e,t,i){let a=this.gameState.player.financeLog,s=a.length>0?a[a.length-1]:null;s&&s.day===this.gameState.day&&s.type===e?(s.amount+=t,s.balance=this.gameState.player.credits):this._logTransaction(e,t,i)}_checkMilestones(){let{credits:e,revealedTier:t}=this.gameState.player,i=t,a=de.find(s=>s.revealsTier===i+1);for(;a&&e>=a.threshold;)this.gameState.player.revealedTier=a.revealsTier,this.logger.info.state(this.gameState.day,"MILESTONE",`Unlocked Tier ${a.revealsTier} commodities.`),this.uiManager.queueModal("event-modal","New Opportunities",`Your financial success has drawn attention! New Tier ${a.revealsTier} trading opportunities are now available.`),i=a.revealsTier,a=de.find(s=>s.revealsTier===i+1);this.gameState.player.revealedTier!==t&&this.gameState.setState({})}_checkHullWarnings(e){let t=this.gameState.player.shipStates[e],i=d.SHIPS[e],a=t.health/i.maxHealth*100;a<=15&&!t.hullAlerts.two?t.hullAlerts.two=!0:a<=30&&!t.hullAlerts.one&&(t.hullAlerts.one=!0),a>30&&(t.hullAlerts.one=!1),a>15&&(t.hullAlerts.two=!1)}_handleShipDestruction(e){let t=d.SHIPS[e].name;if(this.logger.error("SimulationService",`Ship ${t} was destroyed.`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(i=>i!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.gameState.player.ownedShipIds.length===0)this._gameOver(`Your last ship, the ${t}, was destroyed. Your trading career ends here.`);else{this.gameState.player.activeShipId=this.gameState.player.ownedShipIds[0];let i=d.SHIPS[this.gameState.player.activeShipId].name,a=`The ${t} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${i}.`;this.uiManager.queueModal("event-modal","Vessel Lost",a)}this.gameState.setState({})}_gameOver(e){this.logger.info.state(this.gameState.day,"GAME_OVER",e),this.gameState.setState({isGameOver:!0}),this.uiManager.queueModal("event-modal","Game Over",e,()=>{localStorage.removeItem(ge),window.location.reload()},{buttonText:"Restart"})}_applyGarnishment(){let{player:e,day:t}=this.gameState;if(e.debt>0&&e.loanStartDate&&t-e.loanStartDate>=R.LOAN_GARNISHMENT_DAYS){let i=Math.floor(e.credits*R.LOAN_GARNISHMENT_PERCENT);i>0&&(e.credits-=i,this._logTransaction("debt",-i,"Monthly credit garnishment")),e.seenGarnishmentWarning||(this.uiManager.queueModal("event-modal","Credit Garnishment Notice","Your loan is delinquent. Your lender is now garnishing 14% of your credits monthly until the debt is paid.",null,{buttonClass:"bg-red-800/80"}),e.seenGarnishmentWarning=!0,this.logger.warn("Finance",`Loan delinquent. Garnishment of ${R.LOAN_GARNISHMENT_PERCENT*100}% initiated.`))}}_updateShipyardStock(){let{player:e}=this.gameState;e.unlockedLocationIds.forEach(t=>{let i=this.gameState.market.shipyardStock[t];if(i&&i.day===this.gameState.day)return;let a=Object.entries(d.SHIPS).filter(([n,r])=>!r.isRare&&r.saleLocationId===t&&!e.ownedShipIds.includes(n)),s=Object.entries(d.SHIPS).filter(([n,r])=>r.isRare&&r.saleLocationId===t&&!e.ownedShipIds.includes(n)),o=[...a.map(n=>n[0])];s.forEach(([n,r])=>{Math.random()<R.RARE_SHIP_CHANCE&&o.push(n)}),this.gameState.market.shipyardStock[t]={day:this.gameState.day,shipsForSale:o}})}_grantRewards(e,t){e.forEach(i=>{if(i.type==="credits"&&(this.gameState.player.credits+=i.amount,this._logTransaction("mission",i.amount,`Reward: ${t}`),this.uiManager.createFloatingText(`+${g(i.amount,!1)}`,window.innerWidth/2,window.innerHeight/2,"#34d399")),i.type==="license"&&!this.gameState.player.unlockedLicenseIds.includes(i.licenseId)){this.gameState.player.unlockedLicenseIds.push(i.licenseId);let a=d.LICENSES[i.licenseId];this.uiManager.queueModal("event-modal","License Granted",`You have been granted the ${a.name}.`),this.logger.info.player(this.gameState.day,"LICENSE_GRANTED",`Received ${a.name}.`)}})}grantMissionCargo(e){let t=d.MISSIONS[e];if(!t||!t.providedCargo)return;let i=this._getActiveInventory();if(!i){this.logger.error("SimulationService","Cannot grant mission cargo: No active inventory found.");return}t.providedCargo.forEach(a=>{i[a.goodId]||(i[a.goodId]={quantity:0,avgCost:0}),i[a.goodId].quantity+=a.quantity,this.logger.info.player(this.gameState.day,"CARGO_GRANT",`Received ${a.quantity}x ${d.COMMODITIES.find(s=>s.id===a.goodId).name} from ${t.name}.`)}),this.missionService&&this.missionService.checkTriggers()}botRefuel(){let e=this._getActiveShip();if(!e)return;let t=e.maxFuel-e.fuel;if(t<=0)return;let a=d.MARKETS.find(o=>o.id===this.gameState.currentLocationId).fuelPrice/2,s=t/5*a;this.gameState.player.credits>=s&&(this.gameState.player.credits-=s,this.gameState.player.shipStates[e.id].fuel=e.maxFuel)}botRepair(){let e=this._getActiveShip();if(!e)return;let t=e.maxHealth-e.health;if(t<=0)return;let i=t*R.REPAIR_COST_PER_HP;this.gameState.player.credits>=i&&(this.gameState.player.credits-=i,this.gameState.player.shipStates[e.id].health=e.maxHealth)}addShipToHangar(e){let t=d.SHIPS[e];t&&(this.gameState.player.ownedShipIds.push(e),this.gameState.player.shipStates[e]={health:t.maxHealth,fuel:t.maxFuel,hullAlerts:{one:!1,two:!1}},this.gameState.player.inventories[e]={},d.COMMODITIES.forEach(i=>{this.gameState.player.inventories[e][i.id]={quantity:0,avgCost:0}}))}debugGodMode(){this.logger.warn("DebugService","GOD MODE ACTIVATED."),this.gameState.introSequenceActive=!1,this.tutorialService.activeBatchId=null,this.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(d.TUTORIAL_DATA),this.gameState.player.credits=1e12,this.gameState.player.ownedShipIds=[],this.addShipToHangar(A.BEHEMOTH),this.gameState.player.activeShipId=A.BEHEMOTH,this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(d.LICENSES),this.gameState.player.unlockedLocationIds=d.MARKETS.map(e=>e.id),document.getElementById("game-container").classList.remove("hidden"),this.setScreen(k.STARPORT,S.MARKET),this._advanceDays(7),this.gameState.setState({})}debugTriggerRandomEvent(){let e=this.gameState.getState(),t=d.MARKETS.filter(i=>i.id!==e.currentLocationId);if(t.length>0){let i=t[Math.floor(Math.random()*t.length)].id;this._checkForRandomEvent(i,this.gameState.player.debugEventIndex),this.gameState.player.debugEventIndex=(this.gameState.player.debugEventIndex+1)%d.RANDOM_EVENTS.length}}};function Te(c){let{player:e}=c,t=Pe(c),i=t.length>0?t.map(([s])=>be(c,s,"shipyard")).join(""):'<p class="text-center text-gray-500 text-sm p-4">No new ships available at this location.</p>',a=e.ownedShipIds.length>0?e.ownedShipIds.map(s=>be(c,s,"hangar")).join(""):'<p class="text-center text-gray-500 text-sm p-4">Your hangar is empty.</p>';return`
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 relative">
            <div id="starport-shipyard-panel">
                <h2 class="text-3xl font-orbitron text-cyan-300 mb-4 text-center">Shipyard</h2>
                <div class="starport-panel space-y-4">${i}</div>
            </div>
            <div class="w-full my-4 border-t-2 border-slate-600 lg:hidden"></div>
            <div class="absolute left-1/2 top-0 h-full w-px bg-slate-600 hidden lg:block"></div>
            <div id="starport-hangar-panel">
                <h2 class="text-3xl font-orbitron text-cyan-300 mb-4 text-center">Hangar</h2>
                <div class="starport-panel space-y-4">${a}</div>
            </div>
        </div>`}function be(c,e,t){let{player:i,tutorials:a}=c,s=d.SHIPS[e],o=s.class.toLowerCase(),n=`
        <div class="ship-info">
            <span class="ship-name class-${o}">${s.name}</span>
            <span class="ship-class">Class ${s.class}</span>
        </div>`,r="",l="",h="",u=`ship-bar-wrapper bg-class-${o} class-${o}`;if(t==="shipyard"){let p=i.credits>=s.price,m=a.activeBatchId==="intro_hangar"&&a.activeStepId==="hangar_1";(!p||m)&&(u+=" opacity-60 pointer-events-none"),r=`<div class="ship-price">${g(s.price)}</div>`}else{let p=i.shipStates[e],m=i.inventories[e],f=O(m),T=f/s.cargoCapacity*100,E=Math.floor(p.health/s.maxHealth*100),x=Math.floor(p.fuel/s.maxFuel*100),_=e===i.activeShipId;h=`<div class="status-sidelabel ${_?"sidelabel-active":"sidelabel-stored"}">${_?"ACTIVE":"STORED"}</div>`,r=`
            <div class="ship-stats-text">
                <span class="stat-hull">HULL: <span class="value">${E}%</span></span>
                <span class="stat-fuel">FUEL: <span class="value">${x}%</span></span>
            </div>`,l=`
            <div class="bottom-line">
                <div class="cargo-bar">${Array.from({length:Math.max(10,Math.min(25,Math.floor(s.cargoCapacity/8)))},(B,v)=>{let C=Math.round(f/s.cargoCapacity*Math.max(10,Math.min(25,Math.floor(s.cargoCapacity/8))));return`<div class="segment ${v<C?"filled":""}"></div>`}).join("")}</div>
                <div class="cargo-text">CARGO: <span class="value">${f}/${s.cargoCapacity}</span></div>
            </div>`}return`
        <div class="${u}" data-action="show-ship-detail" data-ship-id="${e}" data-context="${t}">
            ${h}
            <div class="main-content">
                <div class="ship-info-top">
                    ${n}
                    ${r}
                </div>
                ${l}
            </div>
        </div>`}function Pe(c){let{player:e,currentLocationId:t,market:i,introSequenceActive:a}=c;return a?e.ownedShipIds.length>0?[]:[A.WANDERER,A.STALWART,A.MULE].map(o=>[o,d.SHIPS[o]]):(i.shipyardStock[t]?.shipsForSale||[]).map(o=>[o,d.SHIPS[o]]).filter(([o,n])=>!e.ownedShipIds.includes(o))}function he(c,e,t,i){return`<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${d.COMMODITIES.filter(o=>o.tier<=c.player.revealedTier).map(o=>De(o,c,t,i)).join("")}</div>`}function De(c,e,t,i){let{player:a,market:s,currentLocationId:o,tutorials:n,uiState:r}=e,l=a.inventories[a.activeShipId]?.[c.id],h=t(e,c.id),u=t(e,c.id,!0),p=s.galacticAverages[c.id],m=s.inventory[o]?.[c.id],f=!c.licenseId||a.unlockedLicenseIds.includes(c.licenseId),T=n.activeBatchId==="intro_missions"&&n.activeStepId==="mission_2_2",E=n.activeBatchId==="intro_missions"&&n.activeStepId==="mission_2_3",x=T&&c.id!==L.PLASTEEL||E,_=`data-tooltip="${c.lore}"`,w=l&&l.quantity>0?l.quantity:"0",B=r.marketCardMinimized[c.id],v=z({price:h,sellPrice:u,galacticAvg:p,playerItem:l}),C=l&&l.quantity>0?`<div class="avg-cost-display" id="avg-cost-${c.id}">Avg. Cost: ${g(l.avgCost,!1)}</div>`:"",I;f?I=`
             <div class="transaction-controls" data-mode="${i[c.id]?.mode||"buy"}" data-good-id="${c.id}" ${x?"disabled":""}>
                <div class="toggle-switch" data-action="toggle-trade-mode" data-good-id="${c.id}">
                    <div class="toggle-thumb"></div>
                    <div class="toggle-labels"><span class="label-buy">Buy</span><span class="label-sell">Sell</span></div>
                </div>
                <div class="qty-stepper">
                    <button class="qty-down" data-action="decrement" data-good-id="${c.id}">\u25BC</button>
                    <input type="number" value="0" id="qty-${c.id}" min="0">
                    <button class="qty-up" data-action="increment" data-good-id="${c.id}">\u25B2</button>
                </div>
                <div class="action-group">
                    <button class="btn confirm-btn" data-action="confirm-trade" data-good-id="${c.id}">Confirm</button>
                    <button class="btn max-btn" data-action="set-max-trade" data-good-id="${c.id}">Max</button>
                </div>
            </div>`:I=`
            <div class="transaction-controls absolute inset-0 flex items-center justify-center p-4">
                <button class="btn w-full h-full text-center" data-action="${b.ACQUIRE_LICENSE}" data-license-id="${c.licenseId}">Acquire License</button>
            </div>`;let N=l?.quantity>0?` (${l.quantity})`:"";return`
    <div class="item-card-container ${f?"":"locked"} ${B?"minimized":""}" id="item-card-container-${c.id}">
        <div class="rounded-lg border ${c.styleClass} transition-colors shadow-md">
            <button class="card-toggle-btn" data-action="${b.TOGGLE_MARKET_CARD_VIEW}" data-good-id="${c.id}">${B?"+":"\u2212"}</button>
            
            <div class="max-view-content">
                <p class="font-bold commodity-name"><span class="commodity-name-tooltip" ${_}>${c.name}</span></p>
                <p class="avail-text">Avail: <span id="m-stock-${c.id}">${m.quantity}</span>, Own: <span id="p-inv-${c.id}">${w}</span></p>
                <p id="price-display-${c.id}" class="font-roboto-mono font-bold price-text" data-action="${b.SHOW_PRICE_GRAPH}" data-good-id="${c.id}" data-base-price="${h}">${g(h)}</p>
                
                <div id="effective-price-display-${c.id}" class="effective-price-display"></div>
                
                <div class="indicator-container" id="indicators-${c.id}">${v}</div>

                ${C}

                ${I}
            </div>

            <div class="min-view-content">
                <p class="font-bold commodity-name-min">${c.name}${N}</p>
                <p class="tier-text-min">Tier ${c.tier} | ${c.cat}</p>
            </div>
        </div>
    </div>`}function Ie(c){let{player:e,day:t,currentLocationId:i}=c,a=d.SHIPS[e.activeShipId],s=e.shipStates[e.activeShipId],o=e.inventories[e.activeShipId],n=O(o),l=d.MARKETS.find(h=>h.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"};return`
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-black/30 p-4 rounded-lg mb-6 items-start">
            <div class="md:col-span-2 h-full p-4 rounded-lg flex items-center justify-between transition-all duration-500 panel-border border" style="border-color: ${l.borderColor}; color: ${l.textColor}; background: ${l.gradient};">
                <div class="text-left pl-4">
                    <span class="block text-lg uppercase tracking-widest" style="color: ${l.textColor}a0;">Day</span>
                    <span class="text-4xl font-bold font-orbitron">${t}</span>
                </div>
                <div class="text-right flex flex-col items-end">
                    <p class="text-xs font-roboto-mono text-right" style="color: ${l.textColor}cc;">${fe(t)}</p>
                    <div class="mt-2 pt-2 border-t" style="border-color: ${l.textColor}50;">
                        <div class="text-right">
                            <p class="text-sm tracking-wider" style="color: ${l.textColor}a0;">Vessel</p>
                            <p>${a.name}</p>
                            <p>Class: ${a.class}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-1 flex flex-col gap-4">
                <div class="p-2 rounded-lg shadow-lg panel-border border" style="border-color: ${l.borderColor}; color: ${l.textColor}; background: ${l.gradient};">
                    <h4 class="font-orbitron text-xl text-center mb-3">${a.name} Status</h4>
                    <div class="flex flex-col gap-y-2 text-sm">
                        <div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                    <span>Hull:</span>
                                </div>
                                <span class="font-bold text-green-300">${Math.floor(s.health)}%</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path></svg>
                                    <span>Fuel:</span>
                                </div>
                                <span class="font-bold text-sky-300">${Math.floor(s.fuel)}/${a.maxFuel}</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 000 2h6a1 1 0 100-2H6z" /><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2-2H4a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1V5a1 1 0 00-1-1H4z" clip-rule="evenodd" /></svg>
                                    <span>Cargo:</span>
                                </div>
                                <span class="font-bold text-amber-300">${n}/${a.cargoCapacity}</span>
                            </div>
                        </div>
                     </div>
                </div>
                <div class="text-center text-lg font-orbitron flex items-center justify-center gap-2" style="color: ${l.textColor};">
                    <span>${e.playerTitle} ${e.name}, ${e.playerAge}</span>
                </div>
            </div>
        </div>`}function Ee(c){let{player:e,currentLocationId:t,TRAVEL_DATA:i,tutorials:a}=c,{navLock:s}=a,o=s&&s.screenId===S.NAVIGATION,n=o?s.enabledElementQuery:null;return`
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
        ${d.MARKETS.filter(r=>e.unlockedLocationIds.includes(r.id)).map(r=>{let l=r.id===t,h=l?null:i[t][r.id],u=!1;if(o&&n){let m=document.createElement("div");m.innerHTML=`<div data-location-id="${r.id}"></div>`,u=!m.querySelector(n)}let p=u?"disabled-location":"";return`<div class="location-card p-6 rounded-lg text-center flex flex-col ${l?"highlight-current":""} ${r.color} ${r.bg} ${p}" 
                             data-action="show-launch-modal" data-location-id="${r.id}" ${u?"disabled":""}>
                    <h3 class="text-2xl font-orbitron flex-grow">${r.name}</h3>
                    <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                    ${l?'<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>':`<div class="flex justify-around items-center text-center">
                               <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                   <div><span class="font-bold font-roboto-mono text-lg">${h.time}</span><span class="block text-xs text-gray-400">Days</span></div>
                               </div>
                               <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                   <div><span class="font-bold font-roboto-mono text-lg">${h.fuelCost}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                               </div>
                           </div>`}
                  </div>
                  </div>`}).join("")}
        </div>`}function Ae(c){let{player:e,currentLocationId:t}=c,i=d.SHIPS[e.activeShipId],a=e.shipStates[e.activeShipId],s=d.MARKETS.find(u=>u.id===t),o=s?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},n=s.fuelPrice/2;e.activePerks[M.VENETIAN_SYNDICATE]&&t===y.VENUS&&(n*=1-d.PERKS[M.VENETIAN_SYNDICATE].fuelDiscount);let r=i.maxHealth*(R.REPAIR_AMOUNT_PER_TICK/100)*R.REPAIR_COST_PER_HP;e.activePerks[M.VENETIAN_SYNDICATE]&&t===y.VENUS&&(r*=1-d.PERKS[M.VENETIAN_SYNDICATE].repairDiscount);let l=a.fuel/i.maxFuel*100,h=a.health/i.maxHealth*100;return`
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8">
            <div class="p-4 rounded-lg text-center shadow-lg panel-border border" style="border-color: ${o.borderColor}; color: ${o.textColor}; background: ${o.gradient};">
                <h4 class="font-orbitron text-xl mb-2">Refueling</h4>
                <p class="mb-3">Price: <span class="font-bold">\u232C ${g(n,!1)}</span> / 5 units</p>
                <button id="refuel-btn" class="btn w-full py-3" ${a.fuel>=i.maxFuel?"disabled":""}>Hold to Refuel</button>
                <div class="w-full hud-stat-bar mt-2"><div id="fuel-bar" style="width: ${l}%" class="bg-sky-400"></div></div>
            </div>
            <div class="p-4 rounded-lg text-center shadow-lg panel-border border" style="border-color: ${o.borderColor}; color: ${o.textColor}; background: ${o.gradient};">
                <h4 class="font-orbitron text-xl mb-2">Ship Maintenance</h4>
                <p class="mb-3">Price: <span class="font-bold">\u232C ${g(r,!1)}</span> / 5% repair</p>
                <button id="repair-btn" class="btn w-full py-3" ${a.health>=i.maxHealth?"disabled":""}>Hold to Repair</button>
                <div class="w-full hud-stat-bar mt-2"><div id="repair-bar" style="width: ${h}%" class="bg-green-400"></div></div>
            </div>
        </div>`}function Me(c){let e=c.player.inventories[c.player.activeShipId],t=Object.entries(e).filter(([,o])=>o.quantity>0),i={"item-style-1":{hex:"#60a5fa",rgb:"96, 165, 250",gradient:"linear-gradient(45deg, #3b82f6, #1e3a8a)"},"item-style-2":{hex:"#a3a3a3",rgb:"163, 163, 163",gradient:"linear-gradient(45deg, #737373, #262626)"},"item-style-3":{hex:"#22c55e",rgb:"34, 197, 94",gradient:"linear-gradient(45deg, #16a34a, #14532d)"},"item-style-4":{hex:"#e5e5e5",rgb:"229, 229, 229",gradient:"linear-gradient(45deg, #d4d4d4, #737373)"},"item-style-5":{hex:"#c084fc",rgb:"192, 132, 252",gradient:"linear-gradient(45deg, #a855f7, #6b21a8)"},"item-style-6":{hex:"#93c5fd",rgb:"147, 197, 253",gradient:"linear-gradient(45deg, #60a5fa, #2563eb)"},"item-style-7":{hex:"#84cc16",rgb:"132, 204, 22",gradient:"linear-gradient(45deg, #a3e635, #4d7c0f)"},"item-style-8":{hex:"#67e8f9",rgb:"103, 232, 249",gradient:"linear-gradient(45deg, #22d3ee, #0891b2)"},"item-style-9":{hex:"#fcd34d",rgb:"252, 211, 77",gradient:"linear-gradient(45deg, #facc15, #b45309)"},"item-style-10":{hex:"#fb7185",rgb:"251, 113, 133",gradient:"linear-gradient(45deg, #f43f5e, #9f1239)"},"item-style-11":{hex:"#a78bfa",rgb:"167, 139, 250",gradient:"linear-gradient(165deg, #a78bfa, #312e81, #1e3a8a)"},"item-style-12":{hex:"#f87171",rgb:"248, 113, 113",gradient:"linear-gradient(45deg, #ef4444, #7f1d1d)"},"item-style-13":{hex:"#d8b4fe",rgb:"216, 180, 254",gradient:"linear-gradient(45deg, #a855f7, #3b0764)"},"item-style-14":{hex:"#f472b6",rgb:"244, 114, 182",gradient:"linear-gradient(45deg, #ec4899, #831843)"}},a=o=>o.map(([n,r])=>{let l=d.COMMODITIES.find(p=>p.id===n),h=i[l.styleClass]||{hex:"#a8a29e",rgb:"168, 162, 158",gradient:"linear-gradient(45deg, #52525b, #18181b)"},u=`${l.lore}

Avg. Cost: ${g(r.avgCost,!1)}`;return`
            <div 
                class="cargo-item-card cargo-item-tooltip" 
                style="background: ${h.gradient}; border-color: ${h.hex};" 
                data-tooltip="${u}">
                <div class="base-concept">
                    <div class="pt-header">
                        <div class="pt-number">TIER ${l.tier}</div>
                        <div class="pt-category">${l.cat}</div>
                    </div>
                    <div class="pt-symbol-wrapper">
                        <div class="pt-symbol">${l.symbol.toUpperCase()}</div>
                        <div class="pt-quantity" style="color: ${h.hex};">(${r.quantity})</div>
                    </div>
                    <div class="pt-name">${l.name}</div>
                </div>
            </div>`}).join(""),s;if(t.length>0){let o=t.filter((r,l)=>l%2===0),n=t.filter((r,l)=>l%2!==0);s=`
        <div class="flex flex-row justify-center gap-8">
            <div class="flex flex-col gap-4">${a(o)}</div>
            <div class="flex flex-col gap-4">${a(n)}</div>
        </div>`}else s='<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>';return`
        <div class="mt-4">
            ${s}
        </div>`}function _e(c,e){let{missions:t,currentLocationId:i}=c,{activeMissionId:a,activeMissionObjectivesMet:s}=t,o=(l,h)=>{let u="";h==="active"&&(u="mission-active"),h==="completed"&&(u="mission-complete"),h==="active"&&s&&l.completion.locationId===i&&(u+=" mission-turn-in");let p=`host-${l.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,m=l.rewards.map(f=>f.type==="credits"?`\u232C ${f.amount.toLocaleString()}`:f.type.toUpperCase()).join(", ");return`
            <div class="mission-card sci-fi-frame ${p} ${u}" data-action="show-mission-modal" data-mission-id="${l.id}">
                <div class="flex justify-between items-center w-full text-xs mb-1">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mission-type">${l.type}</span>
                    </div>
                    <span class="mission-host">${l.host}</span>
                </div>
                <div class="flex justify-between items-end w-full">
                    <p class="font-bold text-base">${l.name}</p>
                    <span class="mission-reward">${m}</span>
                </div>
            </div>`},n="",r=a?d.MISSIONS[a]:null;return r&&(n+=o(r,"active")),e&&e.getAvailableMissions().forEach(h=>{n+=o(h,"available")}),n===""&&(n='<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>'),`
        <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300">Mission Terminal</h1>
        <div class="space-y-3 max-w-2xl mx-auto">
            ${n}
        </div>
    `}function Ce(c){let{player:e,day:t,currentLocationId:i}=c,s=d.MARKETS.find(r=>r.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},o;if(e.debt>0){let r="";if(e.loanStartDate){let l=R.LOAN_GARNISHMENT_DAYS-(t-e.loanStartDate);l>0&&(r=`<p class="text-xs text-red-400/70 mt-2">Garnishment in ${l} days</p>`)}o=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Debt</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <p class="text-2xl font-bold font-roboto-mono text-red-400 mb-2">\u232C ${g(e.debt,!1)}</p>
                    <button data-action="${b.PAY_DEBT}" class="btn w-full py-3 bg-red-800/80 hover:bg-red-700/80 border-red-500" ${e.credits>=e.debt?"":"disabled"}>
                        Pay Off Full Amount
                    </button>
                    ${r}
                </div>
            </div>`}else{let r=Math.floor(e.credits*3.5),l=Math.floor(r*.1),h=Math.floor(r*.04),p=[{key:"10000",amount:1e4,fee:600,interest:500},{key:"dynamic",...{amount:r,fee:l,interest:h}}].map(m=>`<button class="btn btn-loan w-full p-2 mt-2" data-action="${b.TAKE_LOAN}" data-loan-details='${JSON.stringify(m)}' ${e.credits<m.fee?"disabled":""}>
                        <span class="font-orbitron text-cyan-300">\u232C ${g(m.amount,!1)}</span>
                    </button>`).join("");o=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Financing</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <div class="flex justify-center gap-4 w-full">${p}</div>
                </div>
            </div>`}let n=[...e.financeLog].reverse().map(r=>{let l=r.amount>0?"text-green-400":"text-red-400",h=r.amount>0?"+":"";return`
            <div class="grid grid-cols-4 gap-2 p-2 border-b border-slate-700 text-sm">
                <span class="text-gray-400">${r.day}</span>
                <span class="col-span-2">${r.description}</span>
                <span class="${l} text-right">${h}${g(r.amount,!1)}</span>
            </div>
        `}).join("");return`
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                ${o}
            </div>
            <div class="md:col-span-2">
                 <h3 class="text-2xl font-orbitron text-center mb-4">Transaction Log</h3>
                 <div class="p-4 rounded-lg shadow-lg panel-border border h-96 overflow-y-auto" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <div class="grid grid-cols-4 gap-2 p-2 border-b-2 font-bold" style="border-color: ${s.borderColor};">
                       <span>Day</span>
                       <span class="col-span-2">Description</span>
                       <span class="text-right">Amount</span>
                    </div>
                    ${n||'<p class="text-center p-4">No transactions recorded.</p>'}
                 </div>
            </div>
        </div>
    `}function xe(){return`
        <div class="text-center p-8 flex flex-col items-center gap-4">
             <div id="tutorial-button-container" class="tutorial-container relative">
                <button class="btn btn-header">Tutorial Log</button>
                <div id="tutorial-log-modal" class="tutorial-tooltip">
                    <h3 id="tutorial-log-title" class="text-2xl font-orbitron mb-4 text-center">Tutorial Log</h3>
                    <ul id="tutorial-log-list" class="space-y-2"></ul>
                </div>
            </div>
            <div id="lore-button-container" class="lore-container relative">
                <button class="btn btn-header">Story So Far...</button>
                <div class="lore-tooltip">
                    <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p><br><p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p><br><p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p><br><p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
                </div>
            </div>
        </div>`}var te=class{constructor(e){this.logger=e,this.isMobile=window.innerWidth<=768,this.modalQueue=[],this.activeGraphAnchor=null,this.activeGenericTooltipAnchor=null,this.lastActiveScreenEl=null,this.lastKnownState=null,this.missionService=null,this.marketTransactionState={},this.navStructure={[k.SHIP]:{label:"Ship",screens:{[S.STATUS]:"Status",[S.NAVIGATION]:"Navigation",[S.CARGO]:"Cargo"}},[k.STARPORT]:{label:"Starport",screens:{[S.MARKET]:"Market",[S.SERVICES]:"Services",[S.HANGAR]:"Shipyard"}},[k.DATA]:{label:"Data",screens:{[S.MISSIONS]:"Missions",[S.FINANCE]:"Finance",[S.INTEL]:"Intel"}}},this._cacheDOM(),window.addEventListener("resize",()=>{let t=this.isMobile;this.isMobile=window.innerWidth<=768,t!==this.isMobile&&this.render(this.lastKnownState)})}setMissionService(e){this.missionService=e}resetMarketTransactionState(){this.marketTransactionState={}}_cacheDOM(){this.cache={gameContainer:document.getElementById("game-container"),navBar:document.getElementById("nav-bar"),topBarContainer:document.getElementById("top-bar-container"),subNavBar:document.getElementById("sub-nav-bar"),stickyBar:document.getElementById("sticky-bar"),statusScreen:document.getElementById(`${S.STATUS}-screen`),navigationScreen:document.getElementById(`${S.NAVIGATION}-screen`),servicesScreen:document.getElementById(`${S.SERVICES}-screen`),marketScreen:document.getElementById(`${S.MARKET}-screen`),cargoScreen:document.getElementById(`${S.CARGO}-screen`),hangarScreen:document.getElementById(`${S.HANGAR}-screen`),missionsScreen:document.getElementById(`${S.MISSIONS}-screen`),financeScreen:document.getElementById(`${S.FINANCE}-screen`),intelScreen:document.getElementById(`${S.INTEL}-screen`),saveToast:document.getElementById("save-toast"),starportUnlockTooltip:document.getElementById("starport-unlock-tooltip"),graphTooltip:document.getElementById("graph-tooltip"),genericTooltip:document.getElementById("generic-tooltip"),processingModal:document.getElementById("processing-modal"),shipDetailModal:document.getElementById("ship-detail-modal"),launchModal:document.getElementById("launch-modal"),tutorialToastContainer:document.getElementById("tutorial-toast-container"),tutorialToastText:document.getElementById("tutorial-toast-text"),tutorialToastSkipBtn:document.getElementById("tutorial-toast-skip-btn"),tutorialToastNextBtn:document.getElementById("tutorial-toast-next-btn"),skipTutorialModal:document.getElementById("skip-tutorial-modal"),skipTutorialConfirmBtn:document.getElementById("skip-tutorial-confirm-btn"),skipTutorialCancelBtn:document.getElementById("skip-tutorial-cancel-btn"),directorModeOverlay:document.getElementById("director-mode-overlay"),directorToolkit:document.getElementById("director-toolkit"),tutorialHighlightOverlay:document.getElementById("tutorial-highlight-overlay")}}render(e){if(!e||!e.player||e.introSequenceActive&&!e.tutorials.activeBatchId)return;this.lastKnownState=e;let t=d.MARKETS.find(i=>i.id===e.currentLocationId);t&&(this.cache.topBarContainer.setAttribute("data-location-theme",t.id),this.cache.gameContainer.className=`game-container ${t.bg}`,t.navTheme&&t.navTheme.borderColor?document.documentElement.style.setProperty("--theme-border-color",t.navTheme.borderColor):document.documentElement.style.removeProperty("--theme-border-color")),this.renderNavigation(e),this.renderActiveScreen(e),this.updateStickyBar(e),this.renderStickyBar(e)}renderNavigation(e){let{player:t,currentLocationId:i,activeNav:a,activeScreen:s,lastActiveScreen:o,introSequenceActive:n,tutorials:r,subNavCollapsed:l}=e,{navLock:h}=r,u=d.MARKETS.find(v=>v.id===i),p=t.activeShipId?d.SHIPS[t.activeShipId]:null,m=t.activeShipId?t.shipStates[t.activeShipId]:null,f=t.activeShipId?t.inventories[t.activeShipId]:null,T=u?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0"},E=`
            <div class="context-bar" style="background: ${T.gradient}; color: ${T.textColor};">
                <span class="location-name-text">${u?.name||"In Transit"}</span>
                <span class="credit-text">${g(t.credits)}</span>
            </div>`,x=Object.keys(this.navStructure).map(v=>{let C=v===a,I=o[v]||Object.keys(this.navStructure[v].screens)[0],N=h&&h.navId!==v,$=n||N,P=C?`background: ${T.gradient}; color: ${T.textColor};`:"";return`<div class="tab ${v}-tab ${C?"active":""} ${$?"disabled":""}" style="${P}" data-action="${b.SET_SCREEN}" data-nav-id="${v}" data-screen-id="${I}">${this.navStructure[v].label}</div>`}).join(""),_="";if(p&&m&&f){let v=O(f),C=m.health/p.maxHealth*100,I=m.fuel/p.maxFuel*100,N=v/p.cargoCapacity*100;_=`
                <div class="status-pod">
                    <div class="status-bar-group hull-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">H</span>
                        <div class="status-bar"><div class="fill hull-fill" style="width: ${C}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(m.health)}/${p.maxHealth} Hull</div>
                    </div>
                    <div class="status-bar-group fuel-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">F</span>
                        <div class="status-bar"><div class="fill fuel-fill" style="width: ${I}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(m.fuel)}/${p.maxFuel} Fuel</div>
                    </div>
                    <div class="status-bar-group cargo-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">C</span>
                        <div class="status-bar"><div class="fill cargo-fill" style="width: ${N}%;"></div></div>
                        <div class="status-tooltip">${v}/${p.cargoCapacity} Cargo</div>
                    </div>
                </div>`}let w=`<div class="nav-wrapper">${x}${_}</div>`,B=Object.keys(this.navStructure).map(v=>{let C=this.navStructure[v].screens,I=v===a,N=Object.keys(C).map($=>{let P=h&&h.screenId!==$,Y=$===s,H=n||P,j=`style="color: ${T.textColor};"`;return Y&&(j=`style="background: ${T.gradient}; color: ${T.textColor}; opacity: 1; font-weight: 700;"`),`<a href="#" class="${H?"disabled":""}" ${j} data-action="${b.SET_SCREEN}" data-nav-id="${v}" data-screen-id="${$}" draggable="false">${C[$]}</a>`}).join("");return`<div class="nav-sub ${!I||l?"hidden":""}" id="${v}-sub">${N}</div>`}).join("");this.cache.navBar.innerHTML=E+w,this.cache.subNavBar.innerHTML=B}renderActiveScreen(e){let t=document.getElementById(`${e.activeScreen}-screen`);switch(this.lastActiveScreenEl&&this.lastActiveScreenEl!==t&&(this.lastActiveScreenEl.style.display="none"),t&&(t.style.display="block",this.lastActiveScreenEl=t),e.activeScreen){case S.STATUS:this.cache.statusScreen.innerHTML=Ie(e);break;case S.NAVIGATION:this.cache.navigationScreen.innerHTML=Ee(e);break;case S.SERVICES:this.cache.servicesScreen.innerHTML=Ae(e);break;case S.MARKET:this._saveMarketTransactionState(),this.cache.marketScreen.innerHTML=he(e,this.isMobile,this.getItemPrice,this.marketTransactionState),this._restoreMarketTransactionState();break;case S.CARGO:this.cache.cargoScreen.innerHTML=Me(e);break;case S.HANGAR:this.cache.hangarScreen.innerHTML=Te(e,this.isMobile);break;case S.MISSIONS:this.cache.missionsScreen.innerHTML=_e(e,this.missionService);break;case S.FINANCE:this.cache.financeScreen.innerHTML=Ce(e);break;case S.INTEL:this.cache.intelScreen.innerHTML=xe();break}}updateStickyBar(e){this.cache.stickyBar.innerHTML="",this.cache.topBarContainer.classList.remove("has-sticky-bar")}updateServicesScreen(e){if(e.activeScreen!==S.SERVICES)return;let{player:t}=e,i=d.SHIPS[t.activeShipId],a=t.shipStates[t.activeShipId],s=document.getElementById("services-credits-display");s&&(s.innerHTML=`<span class="text-cyan-400">\u232C </span><span class="font-bold text-cyan-300 ml-auto">${g(t.credits,!1)}</span>`);let o=document.getElementById("fuel-bar"),n=document.getElementById("refuel-btn");if(o&&n){let h=a.fuel/i.maxFuel*100;o.style.width=`${h}%`,n.disabled=a.fuel>=i.maxFuel}let r=document.getElementById("repair-bar"),l=document.getElementById("repair-btn");if(r&&l){let h=a.health/i.maxHealth*100;r.style.width=`${h}%`,l.disabled=a.health>=i.maxHealth}}updateMarketScreen(e){e.activeScreen===S.MARKET&&(this._saveMarketTransactionState(),this.cache.marketScreen.innerHTML=he(e,this.isMobile,this.getItemPrice,this.marketTransactionState),this._restoreMarketTransactionState())}_saveMarketTransactionState(){if(!this.lastKnownState||this.lastKnownState.activeScreen!==S.MARKET)return;document.querySelectorAll(".transaction-controls").forEach(t=>{let i=t.dataset.goodId,a=t.querySelector("input"),s=t.dataset.mode;a&&(this.marketTransactionState[i]={quantity:a.value,mode:s})})}_restoreMarketTransactionState(){for(let e in this.marketTransactionState){let t=this.marketTransactionState[e],i=document.querySelector(`.transaction-controls[data-good-id="${e}"]`);if(i){let a=i.querySelector("input");a&&(a.value=t.quantity,i.setAttribute("data-mode",t.mode),this.updateMarketCardDisplay(e,parseInt(t.quantity,10)||0,t.mode))}}}getItemPrice(e,t,i=!1){let a=e.market.prices[e.currentLocationId][t],s=d.MARKETS.find(n=>n.id===e.currentLocationId);i&&s.specialDemand&&s.specialDemand[t]&&(a*=s.specialDemand[t].bonus);let o=e.intel.active;return o&&o.targetMarketId===e.currentLocationId&&o.commodityId===t&&(a*=o.type==="demand"?d.CONFIG.INTEL_DEMAND_MOD:d.CONFIG.INTEL_DEPRESSION_MOD),Math.max(1,Math.round(a))}_calculateSaleDetails(e,t){let i=this.lastKnownState;if(!i)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let a=d.COMMODITIES.find(E=>E.id===e),s=i.market.inventory[i.currentLocationId][e].quantity,o=this.getItemPrice(i,e,!0),r=i.player.inventories[i.player.activeShipId]?.[e]?.avgCost||0;if(s<=0)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let l=s*.1;if(t<=l){let E=o*t,x=r*t,_=E-x;if(_>0){let w=(i.player.activePerks[M.TRADEMASTER]?d.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);_+=_*w}return{totalPrice:E,effectivePricePerUnit:o,netProfit:_}}let h=t/s,u=0;a.tier<=2?u=Math.min(.1,(h-.1)*.2):a.tier<=5?u=Math.min(.25,(h-.1)*.5):u=Math.min(.4,(h-.1)*.8);let p=o*(1-u),m=Math.floor(p*t),f=r*t,T=m-f;if(T>0){let E=(i.player.activePerks[M.TRADEMASTER]?d.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);T+=T*E}return{totalPrice:m,effectivePricePerUnit:p,netProfit:T}}updateMarketCardPrice(e,t){let i=document.getElementById(`price-display-${e}`);if(i){i.dataset.basePrice=t;let a=i.closest(".item-card-container").querySelector(".transaction-controls");a&&a.dataset.mode==="buy"&&(i.textContent=g(t))}}updateMarketCardDisplay(e,t,i){let a=document.getElementById(`price-display-${e}`),s=document.getElementById(`effective-price-display-${e}`),o=document.getElementById(`indicators-${e}`),n=document.getElementById(`avg-cost-${e}`);if(!a||!s||!o||!this.lastKnownState)return;let r=this.lastKnownState,l=parseInt(a.dataset.basePrice,10),h=r.player.inventories[r.player.activeShipId]?.[e];if(n&&n.classList.toggle("visible",i==="sell"),i==="buy")a.textContent=g(l),a.className="font-roboto-mono font-bold price-text",s.textContent="",o.innerHTML=z({price:l,sellPrice:this.getItemPrice(r,e,!0),galacticAvg:r.market.galacticAverages[e],playerItem:h});else{let{effectivePricePerUnit:u,netProfit:p}=this._calculateSaleDetails(e,t);if(t>0){let m=`\u232C ${p>=0?"+":""}${g(p,!1)}`;a.textContent=m,s.textContent=`(${g(u,!1)}/unit)`,a.className=`font-roboto-mono font-bold ${p>=0?"profit-text":"loss-text"}`}else a.textContent="\u232C +0",a.className="font-roboto-mono font-bold profit-text",s.textContent="";o.innerHTML=z({price:l,sellPrice:u||this.getItemPrice(r,e,!0),galacticAvg:r.market.galacticAverages[e],playerItem:h})}}showTravelAnimation(e,t,i,a,s){let o=document.getElementById("travel-animation-modal"),n=document.getElementById("travel-status-text"),r=document.getElementById("travel-arrival-lore"),l=document.getElementById("travel-canvas"),h=l.getContext("2d"),u=document.getElementById("travel-progress-container"),p=document.getElementById("travel-progress-bar"),m=document.getElementById("travel-readout-container"),f=document.getElementById("travel-info-text"),T=document.getElementById("travel-hull-damage"),E=document.getElementById("travel-confirm-button"),x=null;n.textContent=`Traveling to ${t.name}...`,r.textContent="",r.style.opacity=0,m.classList.add("hidden"),m.style.opacity=0,E.classList.add("hidden"),E.style.opacity=0,u.classList.remove("hidden"),p.style.width="0%",o.classList.remove("hidden");let _=2500,w=null,B=d.LOCATION_VISUALS[e.id]||"\u2753",v=d.LOCATION_VISUALS[t.id]||"\u2753",C="\u{1F680}",I=[],N=150;l.width=l.clientWidth,l.height=l.clientHeight;for(let P=0;P<N;P++)I.push({x:Math.random()*l.width,y:Math.random()*l.height,radius:Math.random()*1.5,speed:.2+Math.random()*.8,alpha:.5+Math.random()*.5});let $=P=>{w||(w=P);let Y=P-w,H=Math.min(Y/_,1);H=1-Math.pow(1-H,3),l.width=l.clientWidth,l.height=l.clientHeight,h.clearRect(0,0,l.width,l.height),h.fillStyle="#FFF";for(let ce=0;ce<N;ce++){let U=I[ce];H<1&&(U.x-=U.speed,U.x<0&&(U.x=l.width)),h.beginPath(),h.arc(U.x,U.y,U.radius,0,Math.PI*2),h.globalAlpha=U.alpha,h.fill()}h.globalAlpha=1;let j=60,W=j,me=l.width-j,le=l.height/2;h.font="42px sans-serif",h.textAlign="center",h.textBaseline="middle",h.fillText(B,W,le),h.fillText(v,me,le);let we=W+(me-W)*H;h.save(),h.translate(we,le),h.font="17px sans-serif",h.fillText(C,0,0),h.restore(),p.style.width=`${H*100}%`,H<1?x=requestAnimationFrame($):(n.textContent=`Arrived at ${t.name}`,r.innerHTML=t.arrivalLore||"You have arrived.",f.innerHTML=`
                    <div class="text-center ${this.isMobile?"travel-info-mobile":""}">
                        <div>Journey Time: ${i.time} Days</div>
                        <div><span class="font-bold text-sky-300">Fuel Expended: ${i.fuelCost}</span></div>
                    </div>`,T.className="text-sm font-roboto-mono mt-1 font-bold text-red-400",a>.01?(T.innerHTML=`Hull Integrity -${a.toFixed(2)}%`,this.isMobile&&f.querySelector("div").appendChild(T)):T.innerHTML="",r.style.opacity=1,u.classList.add("hidden"),m.classList.remove("hidden"),E.classList.remove("hidden"),setTimeout(()=>{m.style.opacity=1,E.style.opacity=1},50))};x=requestAnimationFrame($),E.onclick=()=>{cancelAnimationFrame(x),o.classList.add("hidden"),s&&s()}}queueModal(e,t,i,a=null,s={}){this.modalQueue.push({modalId:e,title:t,description:i,callback:a,options:s}),document.querySelector(".modal-backdrop:not(.hidden)")||this.processModalQueue()}processModalQueue(){if(this.modalQueue.length===0)return;let{modalId:e,title:t,description:i,callback:a,options:s}=this.modalQueue.shift(),o=document.getElementById(e);if(!o)return this.logger.error("UIManager",`Modal element with ID '${e}' not found in the DOM. Aborting modal display.`),this.processModalQueue();let n=e==="mission-modal"?"mission-modal-title":e.replace("-modal","-title"),r=e==="mission-modal"?"mission-modal-description":e.replace("-modal","-description"),l=o.querySelector(`#${n}`),h=o.querySelector(`#${r}`)||o.querySelector(`#${e.replace("-modal","-scenario")}`);l&&(l.innerHTML=t),h&&(h.innerHTML=i,h.className="my-4 text-gray-300",e!=="mission-modal"&&h.classList.add("mb-6","text-lg"),s.contentClass&&h.classList.add(s.contentClass));let u=()=>{this.hideModal(e),a&&a(),this.processModalQueue()};if(s.customSetup)s.customSetup(o,u);else{let p=o.querySelector("#"+e.replace("-modal","-button-container")),m;p?(p.innerHTML="",m=document.createElement("button"),p.appendChild(m)):m=o.querySelector("button"),m&&(m.className="btn px-6 py-2",s.buttonClass&&m.classList.add(s.buttonClass),m.innerHTML=s.buttonText||"Understood",m.onclick=u)}o.classList.remove("hidden"),o.classList.add("modal-visible")}showRandomEventModal(e,t){this.queueModal("random-event-modal",e.title,e.scenario,null,{customSetup:(i,a)=>{let s=i.querySelector("#random-event-choices-container");s.innerHTML="",e.choices.forEach((o,n)=>{let r=document.createElement("button");r.className="btn w-full text-left p-4 hover:bg-slate-700",r.innerHTML=o.title,r.onclick=()=>{t(e.id,n),a()},s.appendChild(r)})}})}showAgeEventModal(e,t){let i=document.getElementById("age-event-modal");document.getElementById("age-event-title").innerHTML=e.title,document.getElementById("age-event-description").innerHTML=e.description;let a=document.getElementById("age-event-button-container");a.innerHTML="",e.choices.forEach(s=>{let o=document.createElement("button");o.className="perk-button",o.innerHTML=`<h4>${s.title}</h4><p>${s.description}</p>`,o.onclick=()=>{this.hideModal("age-event-modal"),t(s)},a.appendChild(o)}),i.classList.remove("hidden"),i.classList.add("modal-visible")}hideModal(e){let t=document.getElementById(e);t&&!t.classList.contains("hidden")&&(t.classList.add("modal-hiding"),t.addEventListener("animationend",()=>{t.classList.add("hidden"),t.classList.remove("modal-hiding","modal-visible"),this.modalQueue.length>0&&!document.querySelector(".modal-backdrop:not(.hidden)")&&this.processModalQueue()},{once:!0}))}showProcessingAnimation(e,t){let i=this.cache.processingModal;if(!i)return;let a=i.querySelector("#processing-title"),s=i.querySelector("#processing-progress-bar"),o=i.querySelector("#processing-status");a.textContent=`Processing application for ${e}...`,s.style.width="0%",o.textContent="",i.classList.remove("hidden"),setTimeout(()=>{s.style.width="100%"},100),setTimeout(()=>{o.textContent="Processing complete!",setTimeout(()=>{this.hideModal("processing-modal"),t&&t()},1e3)},4e3)}createFloatingText(e,t,i,a="#fde047"){let s=document.createElement("div");s.textContent=e,s.className="floating-text",s.style.left=`${t-20}px`,s.style.top=`${i-40}px`,s.style.color=a,document.body.appendChild(s),setTimeout(()=>s.remove(),2450)}showGraph(e,t){this.activeGraphAnchor=e;let i=this.cache.graphTooltip,a=e.dataset.action;if(a===b.SHOW_PRICE_GRAPH){let s=e.dataset.goodId,o=t.player.inventories[t.player.activeShipId][s];i.innerHTML=this._renderPriceGraph(s,t,o)}else a===b.SHOW_FINANCE_GRAPH&&(i.innerHTML=this._renderFinanceGraph(t));i.style.display="block",this.updateGraphTooltipPosition()}hideGraph(){this.activeGraphAnchor&&(this.cache.graphTooltip.style.display="none",this.activeGraphAnchor=null)}updateGraphTooltipPosition(){if(!this.activeGraphAnchor)return;let e=this.cache.graphTooltip;if(e.style.display==="none")return;let t=this.activeGraphAnchor.closest(".item-card-container").getBoundingClientRect(),i=e.offsetHeight,a=t.top-i-10,s=t.left;a<10&&(a=t.bottom+10),e.style.left=`${s}px`,e.style.top=`${a}px`}showGenericTooltip(e,t){this.activeGenericTooltipAnchor=e;let i=this.cache.genericTooltip;i.innerHTML=t,i.style.display="block",this.updateGenericTooltipPosition()}hideGenericTooltip(){this.activeGenericTooltipAnchor&&(this.cache.genericTooltip.style.display="none",this.activeGenericTooltipAnchor=null)}updateGenericTooltipPosition(){if(!this.activeGenericTooltipAnchor)return;let e=this.cache.genericTooltip,t=this.activeGenericTooltipAnchor.getBoundingClientRect(),i=e.offsetWidth,a=e.offsetHeight,s=t.right+10,o=t.top+t.height/2-a/2;o<10&&(o=t.bottom+10),s<10&&(s=10),s+i>window.innerWidth&&(s=window.innerWidth-i-10),e.style.left=`${s}px`,e.style.top=`${o}px`}_renderPriceGraph(e,t,i){let a=t.market.priceHistory[t.currentLocationId]?.[e];if(!a||a.length<2)return'<div class="text-gray-400 text-sm p-4">No Data Available!</div>';let s=d.COMMODITIES.find(I=>I.id===e),o=(s.basePriceRange[0]+s.basePriceRange[1])/2,n=280,r=140,l=35,h=a.map(I=>I.price),u=i?.avgCost>0?i.avgCost:null,p=[...h,o];u&&p.push(u);let m=Math.min(...p),f=Math.max(...p),T=f-m>0?f-m:1,E=I=>I/(a.length-1)*(n-l*2)+l,x=I=>r-l-(I-m)/T*(r-l*2.5),_=`<svg width="${n}" height="${r}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;_+='<g class="grid-lines" stroke="#1f2937" stroke-width="1">',_+=`<line x1="${l}" y1="${x(f)}" x2="${l}" y2="${r-l}" /><line x1="${l}" y1="${r-l}" x2="${n-l}" y2="${r-l}" />`,_+="</g>";let w=x(o);if(_+=`<line x1="${l}" y1="${w}" x2="${n-l}" y2="${w}" stroke="#facc15" stroke-width="1" stroke-dasharray="3 3" />`,_+=`<text x="${n-l+4}" y="${w+3}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg: ${g(o,!1)}</text>`,u){let I=x(u);_+=`<line x1="${l}" y1="${I}" x2="${n-l}" y2="${I}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" />`,_+=`<text x="${n-l+4}" y="${I+3}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid: ${g(u,!1)}</text>`}let B=a.map((I,N)=>`${E(N)},${x(I.price)}`).join(" ");_+=`<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${B}" />`;let v=a[0].day,C=a[a.length-1].day;return _+=`<text x="${l}" y="${r-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${v}</text>`,_+=`<text x="${n-l}" y="${r-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${C}</text>`,_+=`<text x="${l-8}" y="${x(m)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${g(m,!1)}</text>`,_+=`<text x="${l-8}" y="${x(f)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${g(f,!1)}</text>`,_+="</svg>",_}_updateScrollIndicator(e){}showTutorialToast({step:e,onSkip:t,onNext:i,gameState:a}){let s=this.cache.tutorialToastContainer,o=e.text;if(o.includes("{shipName}")){let h=d.SHIPS[a.player.activeShipId]?.name||"your ship";o=o.replace(/{shipName}/g,h)}o.includes("{playerName}")&&(o=o.replace(/{playerName}/g,a.player.name)),this.cache.tutorialToastText.innerHTML=o,s.className="hidden fixed p-4 rounded-lg shadow-2xl transition-all duration-300 pointer-events-auto";let n;if(this.isMobile?n=`tt-${e.position.mobile||"mobile"}`:n=`tt-${e.position.desktop||"bottom-right"}`,s.classList.add(n),s.style.width=e.size?.width||"auto",s.classList.remove("hidden"),e.completion.type==="INFO"){let h=e.buttonText||"Next &rarr;";this.cache.tutorialToastNextBtn.innerHTML=h,this.cache.tutorialToastNextBtn.style.display="inline-block",this.cache.tutorialToastNextBtn.onclick=i}else this.cache.tutorialToastNextBtn.style.display="none";let l=!1;this.cache.tutorialToastSkipBtn.style.display=l?"block":"none",this.cache.tutorialToastSkipBtn.onclick=t}hideTutorialToast(){this.cache.tutorialToastContainer.classList.add("hidden"),this.applyTutorialHighlight(null)}applyTutorialHighlight(e){let t=this.cache.tutorialHighlightOverlay;if(t){if(t.innerHTML="",!e){t.classList.add("hidden");return}t.classList.remove("hidden"),e.forEach(i=>{let a=document.createElement("div");a.className="tutorial-cue",a.style.left=`${i.x}px`,a.style.top=`${i.y}px`,a.style.width=`${i.width}px`,a.style.height=`${i.height}px`,a.style.transform=`rotate(${i.rotation}deg)`,a.style.opacity=i.style.opacity,i.style.animation!=="None"&&a.classList.add(`anim-${i.style.animation.toLowerCase()}`);let s="";i.type==="Shape"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 ${i.width} ${i.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${i.shapeType==="Rectangle"?`<rect x="0" y="0" width="100%" height="100%" rx="${i.style.borderRadius}" ry="${i.style.borderRadius}" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`:`<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`}
                    </svg>`:i.type==="Arrow"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                            <marker id="arrowhead-player" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${i.style.stroke}" />
                            </marker>
                        </defs>
                        <line x1="0" y1="25" x2="90" y2="25" stroke="${i.style.stroke}" stroke-width="${i.style.strokeWidth}" marker-end="url(#arrowhead-player)" />
                    </svg>
                `:i.type==="Spotlight"&&(a.style.borderRadius="50%",a.style.boxShadow=`0 0 0 9999px rgba(0,0,0,0.7), 0 0 ${i.style.glowIntensity||20}px ${i.style.glowIntensity||10}px ${i.style.glowColor||i.style.stroke}`),a.innerHTML=s;let o=a.querySelector("svg");o&&i.style.animation!=="None"&&(o.classList.add(`anim-${i.style.animation.toLowerCase()}`),o.style.setProperty("--glow-color",i.style.glowColor||i.style.stroke),o.style.setProperty("--anim-speed",`${i.style.animationSpeed}s`),o.style.setProperty("--glow-intensity",`${i.style.glowIntensity}px`)),t.appendChild(a)})}}showSkipTutorialModal(e){this.cache.skipTutorialModal.classList.remove("hidden");let i=()=>{e(),this.hideModal("skip-tutorial-modal")},a=()=>{this.hideModal("skip-tutorial-modal")};this.cache.skipTutorialConfirmBtn.onclick=i,this.cache.skipTutorialCancelBtn.onclick=a}showTutorialLogModal({seenBatches:e,onSelect:t}){let i=document.getElementById("tutorial-log-modal"),a=document.getElementById("tutorial-log-list");if(!i||!a){this.logger.error("UIManager","Tutorial log modal elements not found in DOM.");return}a.innerHTML="",e.length===0?a.innerHTML='<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>':e.forEach(s=>{let o=d.TUTORIAL_DATA[s];if(o){let n=document.createElement("li");n.innerHTML=`<button class="btn w-full text-center">${o.title}</button>`,n.onclick=()=>{i.classList.remove("visible"),t(s)},a.appendChild(n)}}),i.classList.add("visible")}showShipDetailModal(e,t,i){let{player:a,tutorials:s}=e,o=d.SHIPS[t],n;if(i==="shipyard"){let h=a.credits>=o.price,u=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",p=!h||u;n=`
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-orbitron text-cyan-300">${o.name}</h3>
                            <p class="text-sm text-gray-400">Class ${o.class}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-cyan-300">${g(o.price)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 flex-grow text-left">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${o.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${o.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${o.cargoCapacity}</span></div>
                    </div>
                    <button class="btn w-full mt-2" data-action="${b.BUY_SHIP}" data-ship-id="${t}" ${p?"disabled":""}>Purchase</button>
                </div>`}else{let h=a.shipStates[t],u=a.inventories[t],p=O(u),m=t===a.activeShipId,f=a.ownedShipIds.length>1&&!m,T=Math.floor(o.price*R.SHIP_SELL_MODIFIER);n=`
                <div class="ship-card p-4 flex flex-col space-y-3 ${m?"border-yellow-400":""}">
                    <h3 class="text-xl font-orbitron text-center ${m?"text-yellow-300":"text-cyan-300"}">${o.name}</h3>
                    <p class="text-sm text-gray-400 text-center">Class ${o.class}</p>
                    <p class="text-sm text-gray-400 flex-grow text-left my-2">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull</span><div class="text-green-400">${Math.floor(h.health)}/${o.maxHealth}</div></div>
                        <div><span class="text-gray-500">Fuel</span><div class="text-sky-400">${Math.floor(h.fuel)}/${o.maxFuel}</div></div>
                        <div><span class="text-gray-500">Cargo</span><div class="text-amber-400">${p}/${o.cargoCapacity}</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        ${m?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${b.SELECT_SHIP}" data-ship-id="${t}">Board</button>`}
                        <button class="btn" data-action="${b.SELL_SHIP}" data-ship-id="${t}" ${f?"":"disabled"}>Sell<br>\u232C ${g(T,!1)}</button>
                    </div>
                </div>`}let r=this.cache.shipDetailModal,l=r.querySelector("#ship-detail-content");l.innerHTML=n,r.classList.remove("hidden"),r.classList.add("modal-visible")}showLaunchModal(e){let t=this.lastKnownState;if(!t)return;let i=d.MARKETS.find(f=>f.id===e);if(!i)return;let a=i.navTheme,s=t.TRAVEL_DATA[t.currentLocationId]?.[e],o=t.player.shipStates[t.player.activeShipId];if(!s)return;let n={water_ice:"RAW",plasteel:"IND",hydroponics:"AGRI",cybernetics:"TECH",propellant:"IND",processors:"TECH",gmo_seeds:"AGRI",cryo_pods:"CIV",atmos_processors:"IND",cloned_organs:"BIO",xeno_geologicals:"RAW",sentient_ai:"TECH",antimatter:"RARE",folded_drives:"RARE"},r=[],l=[];for(let f in i.availabilityModifier){let T=i.availabilityModifier[f],E=n[f];T<1&&!r.includes(E)?r.push(E):T>1&&!l.includes(E)&&l.push(E)}let h="";r.length>0&&(h+=`<p><b style="color: ${a.textColor};">Imports:</b> ${r.join(", ")}</p>`),l.length>0&&(h+=`<p><b style="color: ${a.textColor};">Exports:</b> ${l.join(", ")}</p>`),h===""&&(h="<p>Market data is unreliable.</p>");let u=`
            <div class="launch-modal-wrapper panel-border" style="background: ${a.gradient}; color: ${a.textColor}; border-color: ${a.borderColor};">
                <div class="flex-shrink-0">
                    <h3 class="font-orbitron">${i.name}</h3>
                    <p class="flavor-text italic">${i.launchFlavor}</p>
                </div>
                <div class="border-t border-b py-2 text-center space-y-1" style="border-color: ${a.borderColor}50;">
                    ${h}
                </div>
                <div class="font-roboto-mono text-xs"> 
                    <p>Travel Time: ${s.time} Days</p>
                    <p>Fuel: ${Math.floor(o.fuel)} / ${s.fuelCost} required</p>
                </div>
                <div class="pt-2"> 
                   <button class="btn btn-launch-glow" data-action="travel" data-location-id="${e}" style="--launch-glow-color: ${a.borderColor};">Launch</button>
                </div>
            </div>`,p=this.cache.launchModal;p.innerHTML=u,p.classList.remove("hidden"),p.classList.add("modal-visible");let m=f=>{f.target.id==="launch-modal"&&(this.hideModal("launch-modal"),p.removeEventListener("click",m))};p.addEventListener("click",m)}renderStickyBar(e){let t=document.getElementById("mission-sticky-bar"),i=t.querySelector(".sticky-content"),a=document.getElementById("sticky-objective-text"),s=document.getElementById("sticky-objective-progress");if(e.missions.activeMissionId){let o=d.MISSIONS[e.missions.activeMissionId],n=e.missions.missionProgress[o.id]||{objectives:{}},r=o.objectives[0],l=n.objectives[r.goodId]?.current??0,h=r.quantity,u=d.COMMODITIES.find(T=>T.id===r.goodId).name,p=d.MARKETS.find(T=>T.id===o.completion.locationId).name;a.textContent=`Deliver ${u} to ${p}`,s.textContent=`[${l}/${h}]`;let m=`host-${o.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,f=e.missions.activeMissionObjectivesMet&&o.completion.locationId===e.currentLocationId?"mission-turn-in":"";i.className=`sticky-content sci-fi-frame ${m} ${f}`,t.style.display="block"}else t.style.display="none"}showMissionModal(e){let t=d.MISSIONS[e];if(!t)return;let{missions:i,currentLocationId:a}=this.lastKnownState,{activeMissionId:s,activeMissionObjectivesMet:o}=i;s===e&&o&&t.completion.locationId===a?this._showMissionCompletionModal(t):this._showMissionDetailsModal(t)}_showMissionDetailsModal(e){let{missions:t,tutorials:i}=this.lastKnownState,a=t.activeMissionId===e.id,o=t.activeMissionId&&!a;e.id==="mission_tutorial_02"&&i.activeBatchId==="intro_missions"&&i.activeStepId!=="mission_2_4"&&(o=!0);let n={customSetup:(r,l)=>{let h=r.querySelector(".modal-content");h.className="modal-content sci-fi-frame flex flex-col items-center text-center";let u=`host-${e.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`;h.classList.add(u),r.querySelector("#mission-modal-type").textContent=e.type;let p=r.querySelector("#mission-modal-objectives"),m='<h6 class="font-bold text-sm uppercase tracking-widest text-gray-400 text-center">OBJECTIVES:</h6><ul class="list-disc list-inside text-gray-300">'+e.objectives.map(E=>`<li>Deliver ${E.quantity}x ${d.COMMODITIES.find(x=>x.id===E.goodId).name}</li>`).join("")+"</ul>";p.innerHTML=m,p.style.display="block";let f=r.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let E=e.rewards.map(x=>x.type==="credits"?`\u232C ${x.amount.toLocaleString()}`:x.type.toUpperCase()).join(", ");f.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${E}</p>`,f.style.display="block"}else f.innerHTML="",f.style.display="none";let T=r.querySelector("#mission-modal-buttons");if(a){let E=e.isAbandonable!==!1;T.innerHTML=`<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${e.id}" ${E?"":"disabled"}>Abandon Mission</button>`}else T.innerHTML=`<button class="btn w-full" data-action="accept-mission" data-mission-id="${e.id}" ${o?"disabled":""}>Accept</button>`}};e.id==="mission_tutorial_01"&&i.activeStepId==="mission_1_1"&&(o=!0),this.queueModal("mission-modal",e.name,e.description,null,n)}_showMissionCompletionModal(e){let t={customSetup:(i,a)=>{let s=i.querySelector(".modal-content");s.className="modal-content sci-fi-frame flex flex-col items-center text-center";let o=`host-${e.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`;s.classList.add(o),i.querySelector("#mission-modal-title").textContent=e.completion.title,i.querySelector("#mission-modal-type").textContent="OBJECTIVES MET",i.querySelector("#mission-modal-description").innerHTML=e.completion.text;let n=i.querySelector("#mission-modal-objectives");n.style.display="none";let r=i.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let h=e.rewards.map(u=>u.type==="credits"?`\u232C ${u.amount.toLocaleString()}`:u.type.toUpperCase()).join(", ");r.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${h}</p>`,r.style.display="block"}else r.innerHTML="",r.style.display="none";let l=i.querySelector("#mission-modal-buttons");l.innerHTML=`<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${e.id}">${e.completion.buttonText}</button>`}};this.queueModal("mission-modal",e.completion.title,e.completion.text,null,t)}flashObjectiveProgress(){let e=document.getElementById("sticky-objective-progress");e&&(e.classList.add("objective-progress-flash"),setTimeout(()=>{e.classList.remove("objective-progress-flash")},700))}showDirectorMode(){this.cache.directorModeOverlay&&this.cache.directorModeOverlay.classList.remove("hidden"),this.cache.directorToolkit&&this.cache.directorToolkit.classList.remove("hidden")}hideDirectorMode(){this.cache.directorModeOverlay&&this.cache.directorModeOverlay.classList.add("hidden"),this.cache.directorToolkit&&this.cache.directorToolkit.classList.add("hidden")}};var ie=class{constructor(e,t,i,a,s=null,o=null,n){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a,this.debugService=s,this.directorModeService=o,this.logger=n,this.refuelInterval=null,this.repairInterval=null,this.activeTooltipTarget=null,this.activeStatusTooltip=null}bindEvents(){document.body.addEventListener("click",t=>this._handleClick(t)),document.body.addEventListener("dblclick",t=>t.preventDefault()),document.body.addEventListener("mouseover",t=>this._handleMouseOver(t)),document.body.addEventListener("mouseout",t=>this._handleMouseOut(t)),document.addEventListener("keydown",t=>this._handleKeyDown(t)),document.body.addEventListener("mousemove",t=>{this.directorModeService?.isActive&&this.directorModeService.handleInput(t)}),document.body.addEventListener("input",t=>{if(this.directorModeService?.isActive)return;let i=t.target.closest('.transaction-controls input[type="number"]');if(i){let a=i.closest(".transaction-controls"),s=a.dataset.goodId,o=a.dataset.mode,n=parseInt(i.value,10)||0;this.uiManager.updateMarketCardDisplay(s,n,o)}}),document.body.addEventListener("mousedown",t=>{if(this.directorModeService?.isActive){this.directorModeService.handleInput(t);return}t.target.closest("#refuel-btn")&&this._startRefueling(),t.target.closest("#repair-btn")&&this._startRepairing()}),document.body.addEventListener("touchstart",t=>{if(this.directorModeService?.isActive){this.directorModeService.handleInput(t);return}t.target.closest("#refuel-btn")&&(t.preventDefault(),this._startRefueling()),t.target.closest("#repair-btn")&&(t.preventDefault(),this._startRepairing())}),["mouseup","mouseleave","touchend"].forEach(t=>{document.addEventListener(t,i=>{if(this.directorModeService?.isActive){this.directorModeService.handleInput(i);return}this._stopRefueling(),this._stopRepairing()})}),window.addEventListener("resize",()=>{this.uiManager.render(this.gameState.getState())}),window.addEventListener("scroll",()=>{this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null)},{passive:!0});let e=document.getElementById("mission-sticky-bar");e&&e.addEventListener("click",()=>{this.directorModeService?.isActive||this.simulationService.setScreen(k.DATA,S.MISSIONS)})}_handleClick(e){if(this.directorModeService?.isActive&&this.directorModeService.isPickerActive){if(e.target.closest("#director-toolkit"))return;e.preventDefault(),e.stopPropagation(),this.directorModeService.captureElement(e.target);return}if(this.directorModeService?.isActive){this.directorModeService.handleInput(e);return}let t=this.gameState.getState(),i=e.target.closest("[data-action]");if(this.activeStatusTooltip&&!e.target.closest('[data-action="toggle-tooltip"]')&&(this.activeStatusTooltip.classList.remove("visible"),this.activeStatusTooltip=null),e.target.closest("#graph-tooltip")||e.target.closest("#generic-tooltip")){this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null;return}if(this.activeTooltipTarget&&i!==this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null),i){if(i.hasAttribute("disabled"))return;let{action:r,goodId:l,locationId:h,shipId:u,loanDetails:p,cost:m,navId:f,screenId:T,context:E,missionId:x,licenseId:_}=i.dataset,w=null;switch(r){case"toggle-tooltip":{let v=i.querySelector(".status-tooltip");if(!v)return;this.activeStatusTooltip===v?(v.classList.remove("visible"),this.activeStatusTooltip=null):(this.activeStatusTooltip&&this.activeStatusTooltip.classList.remove("visible"),v.classList.add("visible"),this.activeStatusTooltip=v);return}case"show-mission-modal":this.uiManager.showMissionModal(x),w={type:"ACTION",action:"show-mission-modal"};break;case"accept-mission":this.simulationService.missionService.acceptMission(x),this.uiManager.hideModal("mission-modal"),w={type:"ACTION",action:"accept-mission",missionId:x};break;case"abandon-mission":this.simulationService.missionService.abandonMission(),this.uiManager.hideModal("mission-modal");break;case"complete-mission":this.simulationService.missionService.completeActiveMission(),this.uiManager.hideModal("mission-modal"),w={type:"ACTION",action:"complete-mission"};break;case"show-launch-modal":this.uiManager.showLaunchModal(h);break;case"show-ship-detail":this.uiManager.showShipDetailModal(t,u,E);break;case b.SET_SCREEN:f===t.activeNav&&i.tagName==="DIV"?(this.gameState.subNavCollapsed=!this.gameState.subNavCollapsed,this.uiManager.render(this.gameState.getState())):(this.gameState.subNavCollapsed=!1,this.simulationService.setScreen(f,T)),w={type:"ACTION",action:b.SET_SCREEN,navId:f,screenId:T};break;case b.TRAVEL:this.uiManager.hideModal("launch-modal"),this.simulationService.travelTo(h),w={type:"ACTION",action:b.TRAVEL};break;case b.BUY_SHIP:if(this.simulationService.buyShip(u)){let v=d.SHIPS[u].price;this.uiManager.createFloatingText(`-${g(v,!1)}`,e.clientX,e.clientY,"#f87171"),w={type:"ACTION",action:b.BUY_SHIP},this.uiManager.hideModal("ship-detail-modal")}break;case b.SELL_SHIP:let B=this.simulationService.sellShip(u);B&&(this.uiManager.createFloatingText(`+${g(B,!1)}`,e.clientX,e.clientY,"#34d399"),this.uiManager.hideModal("ship-detail-modal"));break;case b.SELECT_SHIP:this.simulationService.setActiveShip(u),w={type:"ACTION",action:b.SELECT_SHIP},this.uiManager.hideModal("ship-detail-modal");break;case b.PAY_DEBT:this.simulationService.payOffDebt();break;case b.TAKE_LOAN:this.simulationService.takeLoan(JSON.parse(p));break;case b.PURCHASE_INTEL:this.simulationService.purchaseIntel(parseInt(m));break;case"show-starport-locked-toast":this.uiManager.showToast("starport-unlock-tooltip","Pay off your initial loan to access the Starport!");break;case b.ACQUIRE_LICENSE:this._handleAcquireLicense(_);break;case b.TOGGLE_MARKET_CARD_VIEW:{l&&(this.gameState.uiState.marketCardMinimized[l]=!this.gameState.uiState.marketCardMinimized[l],this.gameState.setState({}));break}case"toggle-trade-mode":{let v=i.closest(".transaction-controls");if(v){let I=v.getAttribute("data-mode")==="buy"?"sell":"buy";v.setAttribute("data-mode",I);let N=v.querySelector("input"),$=parseInt(N.value,10)||0;this.uiManager.updateMarketCardDisplay(l,$,I)}break}case"confirm-trade":{let v=i.closest(".transaction-controls");if(!v)break;let C=v.getAttribute("data-mode"),I=v.querySelector("input"),N=parseInt(I.value,10)||0;if(N>0){let $=C==="buy"?this.simulationService.buyItem(l,N):this.simulationService.sellItem(l,N);if($){let P=C==="buy"?this.uiManager.getItemPrice(t,l)*N:$,Y=C==="buy"?`-${g(P,!1)}`:`+${g(P,!1)}`,H=C==="buy"?"#f87171":"#34d399";this.uiManager.createFloatingText(Y,e.clientX,e.clientY,H),w={type:"ACTION",action:C==="buy"?"buy-item":"sell-item",goodId:l}}}break}case"set-max-trade":{let v=i.closest(".transaction-controls");if(!v)break;let C=v.getAttribute("data-mode"),I=v.querySelector("input"),N=this.simulationService._getActiveShip(),$=this.simulationService._getActiveInventory();if(C==="sell")I.value=$[l]?$[l].quantity:0;else{let Y=this.uiManager.getItemPrice(t,l),H=N.cargoCapacity-O($),j=Y>0?Math.floor(t.player.credits/Y):H,W=t.market.inventory[t.currentLocationId][l].quantity;I.value=Math.max(0,Math.min(H,j,W))}let P=parseInt(I.value,10)||0;this.uiManager.updateMarketCardDisplay(l,P,C);break}case b.INCREMENT:case b.DECREMENT:{let v=i.closest(".transaction-controls");if(!v)break;let C=v.querySelector("input"),I=parseInt(C.value)||0;C.value=r===b.INCREMENT?I+1:Math.max(0,I-1);let N=parseInt(C.value,10)||0;this.uiManager.updateMarketCardDisplay(l,N,v.dataset.mode);break}case b.SHOW_PRICE_GRAPH:case b.SHOW_FINANCE_GRAPH:{this.uiManager.isMobile&&(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget===i?(this.uiManager.hideGraph(),this.activeTooltipTarget=null):(this.uiManager.showGraph(i,this.gameState.getState()),this.activeTooltipTarget=i));break}}w&&this.tutorialService.checkState(w);return}if(t.introSequenceActive&&!t.tutorials.activeBatchId){this.simulationService.handleIntroClick(e);return}if(t.isGameOver)return;let a=e.target.closest(".modal-backdrop");if(a&&a.id&&!e.target.closest(".modal-content")){this.uiManager.hideModal(a.id);return}if(this.uiManager.isMobile){let r=e.target.closest("[data-tooltip]");if(r&&!r.closest('[data-action="toggle-tooltip"]')){this.uiManager.hideGraph(),this.activeTooltipTarget===r?(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null):(this.uiManager.showGenericTooltip(r,r.dataset.tooltip),this.activeTooltipTarget=r);return}}let s=e.target.closest(".tutorial-container"),o=e.target.closest(".lore-container"),n=document.querySelector(".lore-tooltip.visible, .tutorial-tooltip.visible");if(n&&!e.target.closest(".lore-tooltip, .tutorial-tooltip")&&n.classList.remove("visible"),o){let r=o.querySelector(".lore-tooltip");r&&r.classList.toggle("visible");return}if(s){this.uiManager.showTutorialLogModal({seenBatches:this.gameState.tutorials.seenBatchIds,onSelect:r=>{this.tutorialService.triggerBatch(r)}});return}}_handleAcquireLicense(e){let t=d.LICENSES[e];if(t)if(t.type==="purchase"){let i=`${t.description}<br><br>Cost: <b class='hl-yellow'>${g(t.cost)}</b>`;this.uiManager.queueModal("event-modal",`Purchase ${t.name}?`,i,null,{customSetup:(a,s)=>{let o=a.querySelector("#event-button-container");o.innerHTML=`
                        <button id="confirm-license-purchase" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-license-purchase" class="btn">Cancel</button>
                    `,a.querySelector("#confirm-license-purchase").onclick=()=>{let n=this.simulationService.purchaseLicense(e);if(!n.success){let r="An unknown error occurred.";n.error==="INSUFFICIENT_FUNDS"&&(r=`You cannot afford the ${g(t.cost)} fee for this license.`),this.uiManager.queueModal("event-modal","Purchase Failed",r)}s()},a.querySelector("#cancel-license-purchase").onclick=s}})}else t.type==="mission"&&this.uiManager.queueModal("event-modal",t.name,t.guidanceText)}_handleMouseOver(e){if(this.uiManager.isMobile)return;let t=e.target.closest(`[data-action="${b.SHOW_PRICE_GRAPH}"], [data-action="${b.SHOW_FINANCE_GRAPH}"]`);t&&this.uiManager.showGraph(t,this.gameState.getState())}_handleMouseOut(e){if(this.uiManager.isMobile)return;e.target.closest(`[data-action="${b.SHOW_PRICE_GRAPH}"], [data-action="${b.SHOW_FINANCE_GRAPH}"]`)&&this.uiManager.hideGraph()}_handleKeyDown(e){if(!(this.gameState.getState().isGameOver||e.ctrlKey||e.metaKey)){if(e.key==="`"){this.debugService&&this.debugService.toggleVisibility();return}this.debugService&&this.debugService.handleKeyPress(e.key)}}_startRefueling(){this.gameState.isGameOver||this.refuelInterval||(this._refuelTick(),this.refuelInterval=setInterval(()=>this._refuelTick(),1e3))}_stopRefueling(){clearInterval(this.refuelInterval),this.refuelInterval=null}_refuelTick(){let e=this.simulationService.refuelTick();if(e>0){let t=document.getElementById("refuel-btn");if(!t)return;let i=t.getBoundingClientRect(),a=i.left+i.width/2+(Math.random()*40-20),s=i.top+(Math.random()*20-10);this.uiManager.createFloatingText(`-${g(e,!1)}`,a,s,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRefueling()}_startRepairing(){this.gameState.isGameOver||this.repairInterval||(this._repairTick(),this.repairInterval=setInterval(()=>this._repairTick(),1e3))}_stopRepairing(){clearInterval(this.repairInterval),this.repairInterval=null}_repairTick(){let e=this.simulationService.repairTick();if(e>0){let t=document.getElementById("repair-btn");if(!t)return;let i=t.getBoundingClientRect(),a=i.left+i.width/2+(Math.random()*40-20),s=i.top+(Math.random()*20-10);this.uiManager.createFloatingText(`-${g(e,!1)}`,a,s,"#f87171"),this.uiManager.updateServicesScreen(this.gameState.getState())}else this._stopRepairing()}};var Re={hangar_1:[{type:"Arrow",tutorialStepId:"hangar_1",x:59,y:133.56,width:52.400000000000006,height:73.66,rotation:360,style:{fill:"rgba(253, 224, 71, 0.0)",stroke:"#fde047",strokeWidth:1,opacity:1,animation:"Pulse",animationSpeed:1,glowColor:"#fde047",glowIntensity:10}}],hangar_2:[{type:"Shape",tutorialStepId:"hangar_2",x:39,y:203,width:318,height:306,rotation:0,style:{fill:"rgba(253, 224, 71, 0.2)",stroke:"#fde047",strokeWidth:2,opacity:.3,animation:"Pulse",animationSpeed:2,glowColor:"#fde047",glowIntensity:10,borderRadius:25,boxShadow:"none"},shapeType:"Rectangle"}],hangar_3:[{type:"Shape",tutorialStepId:"hangar_3",x:44,y:401,width:308,height:120,rotation:0,style:{fill:"rgba(253, 224, 71, 0.2)",stroke:"#fde047",strokeWidth:1,opacity:.3,animation:"Pulse",animationSpeed:2,glowColor:"#fde047",glowIntensity:10,borderRadius:25,boxShadow:"none"},shapeType:"Rectangle"}]};var ae=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.simulationService=i,this.logger=s,this.activeBatchId=null,this.activeStepId=null,this.screenToNavMap={};for(let o in a)for(let n in a[o].screens)this.screenToNavMap[n]=o}checkState(e=null){if(this.activeBatchId&&this.activeStepId){let i=d.TUTORIAL_DATA[this.activeBatchId].steps.find(a=>a.stepId===this.activeStepId);i&&this._matchesCondition(i.completion,e)&&this.advanceStep();return}for(let t in d.TUTORIAL_DATA){let i=d.TUTORIAL_DATA[t],a=this.gameState.tutorials.seenBatchIds.includes(t),s=this.gameState.tutorials.skippedTutorialBatches.includes(t);if(!a&&!s){let o=e||{type:D.SCREEN_LOAD,screenId:this.gameState.activeScreen};if(this._matchesCondition(i.trigger,o)){this.triggerBatch(t);break}}}}triggerBatch(e,t=null){if(!d.TUTORIAL_DATA[e])return;let i=d.TUTORIAL_DATA[e];if(i.trigger.type===D.SCREEN_LOAD){let s=i.trigger.screenId;if(this.gameState.activeScreen!==s){let o=this.screenToNavMap[s];o&&this.simulationService.setScreen(o,s)}}this.activeBatchId=e,this.gameState.tutorials.activeBatchId=e,this.gameState.tutorials.seenBatchIds.includes(e)||this.gameState.tutorials.seenBatchIds.push(e),this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_START",`Starting tutorial batch: ${e}`),this.gameState.setState(this.gameState),this.uiManager.render(this.gameState.getState());let a=t||i.steps[0].stepId;this._displayStep(a)}skipActiveTutorial(){this.activeBatchId&&(this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)||this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId),this.logger.info.player(this.gameState.day,"TUTORIAL_SKIP",`Skipped tutorial: ${this.activeBatchId}`),this._endBatch(),this.gameState.setState(this.gameState))}advanceStep(){if(!this.activeStepId||!this.activeBatchId)return;let t=d.TUTORIAL_DATA[this.activeBatchId].steps.find(i=>i.stepId===this.activeStepId);if(this.uiManager.hideTutorialToast(),t&&t.nextStepId)this._displayStep(t.nextStepId);else{let i=this.activeBatchId;this._endBatch(),this.gameState.introSequenceActive&&i?.startsWith("intro_")&&this.simulationService._continueIntroSequence(i)}this.uiManager.render(this.gameState.getState())}_displayStep(e){if(!this.activeBatchId)return;let t=d.TUTORIAL_DATA[this.activeBatchId],i=t.steps.find(s=>s.stepId===e);if(!i){this._endBatch();return}if(i.hasOwnProperty("navLock"))this.gameState.tutorials.navLock=i.navLock;else if(t.navLock){let s=this.gameState.activeScreen,o=this.screenToNavMap[s];this.gameState.tutorials.navLock={navId:o,screenId:s}}else this.gameState.tutorials.navLock=null;this.activeStepId=e,this.gameState.tutorials.activeStepId=e,this.logger.info.system("Tutorial",this.gameState.day,"STEP_DISPLAY",`Displaying step: ${e}`),this.uiManager.showTutorialToast({step:i,onSkip:()=>this.uiManager.showSkipTutorialModal(()=>this.skipActiveTutorial()),onNext:()=>this.advanceStep(),gameState:this.gameState.getState()});let a=Re[e];this.uiManager.applyTutorialHighlight(a),this.uiManager.render(this.gameState.getState())}_endBatch(){this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_END",`Ending tutorial batch: ${this.activeBatchId}`),this.uiManager.hideTutorialToast(),this.activeBatchId=null,this.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.navLock=null}_matchesCondition(e,t){return!e||!t?!1:Array.isArray(e)?e.every(i=>this._matchesSingleCondition(i,t)):this._matchesSingleCondition(e,t)}_matchesSingleCondition(e,t){if(e.type!==t.type)return!1;switch(e.type){case D.SCREEN_LOAD:return e.screenId===t.screenId;case D.ACTION:return e.action===b.SET_SCREEN&&t.action===b.SET_SCREEN?e.navId===t.navId&&e.screenId===t.screenId:e.action===t.action;case D.INFO:return!0;default:return!1}}};var se=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=null}setSimulationService(e){this.simulationService=e}arePrerequisitesMet(e){let t=d.MISSIONS[e];return!t||!t.prerequisites?!0:t.prerequisites.every(i=>{switch(i.type){case"mission_completed":return this.gameState.missions.completedMissionIds.includes(i.missionId);default:return!1}})}getAvailableMissions(){let{activeMissionId:e,completedMissionIds:t}=this.gameState.missions;return Object.values(d.MISSIONS).filter(i=>i.id!==e&&!t.includes(i.id)&&this.arePrerequisitesMet(i.id))}acceptMission(e){this.gameState.missions.activeMissionId||!d.MISSIONS[e]||!this.arePrerequisitesMet(e)||(this.gameState.missions.activeMissionId=e,this.gameState.missions.missionProgress[e]={objectives:{}},this.logger.info.player(this.gameState.day,"MISSION_ACCEPT",`Accepted mission: ${e}`),this.simulationService.grantMissionCargo(e),this.checkTriggers(),this.uiManager.render(this.gameState.getState()))}abandonMission(){let e=this.gameState.missions.activeMissionId;e&&(this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.logger.info.player(this.gameState.day,"MISSION_ABANDON",`Abandoned mission: ${e}`),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}checkTriggers(){let{activeMissionId:e}=this.gameState.missions;if(!e){this.gameState.missions.activeMissionObjectivesMet&&(this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}));return}let t=d.MISSIONS[e],i=this.gameState.player.inventories[this.gameState.player.activeShipId];if(!t||!i){this.gameState.missions.activeMissionObjectivesMet=!1;return}let a=!0,s=!1;t.objectives.forEach(o=>{if(o.type==="have_item"){let n=i[o.goodId]?.quantity||0,r=this.gameState.missions.missionProgress[e];r.objectives[o.goodId]||(r.objectives[o.goodId]={current:0}),r.objectives[o.goodId].current!==n&&(r.objectives[o.goodId].current=n,s=!0),n<o.quantity&&(a=!1)}}),(this.gameState.missions.activeMissionObjectivesMet!==a||s)&&(a&&!this.gameState.missions.activeMissionObjectivesMet&&this.logger.info.player(this.gameState.day,"OBJECTIVES_MET",`All objectives for mission ${e} are met.`),this.gameState.missions.activeMissionObjectivesMet=a,this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),s&&this.uiManager.flashObjectiveProgress())}completeActiveMission(){let{activeMissionId:e}=this.gameState.missions;if(!e||!this.gameState.missions.activeMissionObjectivesMet)return;let t=d.MISSIONS[e],i=this.gameState.player.inventories[this.gameState.player.activeShipId];t.objectives.forEach(a=>{a.type==="have_item"&&i[a.goodId]&&(i[a.goodId].quantity-=a.quantity)}),this.simulationService&&this.simulationService._grantRewards(t.rewards,t.name),this.logger.info.player(this.gameState.day,"MISSION_COMPLETE",`Completed mission: ${e}`),this.gameState.missions.completedMissionIds.push(e),this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}};var G={DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},K={player:"#60a5fa",system:"#4ade80",state:"#facc15",warn:"#f59e0b",error:"#f87171",group:"#d4d4d8"},He=100,V=G.INFO,oe=[];function X(c){oe.push(c),oe.length>He&&oe.shift()}function ue(c,e,t,i,a,s,o=null){if(c>V)return;let n=`[${e}] [Day ${t}] ${i}: ${a}`;X(n),console.log(`%c[${e}] %c[Day ${t}] %c${i}: %c${a}`,`color: ${s}; font-weight: bold;`,"color: #9ca3af;","color: #e5e7eb; font-weight: bold;","color: inherit;",o||""),o&&console.dir(o)}var q={setLevel:c=>{let e=G[c.toUpperCase()];typeof e<"u"?(V=e,console.log(`%c[Logger] Log level set to: ${c}`,`color: ${K.state}; font-weight: bold;`)):q.warn("LoggingService",`Attempted to set invalid log level: ${c}`)},getLogHistory:()=>oe.join(`
`),info:{player:(c,e,t,i=null)=>ue(G.INFO,"Player",c,e,t,K.player,i),system:(c,e,t,i,a=null)=>ue(G.INFO,c,e,t,i,K.system,a),state:(c,e,t,i=null)=>ue(G.INFO,"Game",c,e,t,K.state,i)},warn:(c,e)=>{if(G.WARN>V)return;let t=`[${c}] WARN: ${e}`;X(t),console.warn(`%c[${c}] WARN:`,`color: ${K.warn}; font-weight: bold;`,e)},error:(c,e,t=null)=>{if(G.ERROR>V)return;let i=`[${c}] ERROR: ${e}`;X(i),console.error(`%c[${c}] ERROR:`,`color: ${K.error}; font-weight: bold;`,e,t||"")},group:c=>{G.DEBUG>V||(X(`--- GROUP START: ${c} ---`),console.groupCollapsed(`%c${c}`,`color: ${K.group}; font-style: italic;`))},groupEnd:()=>{G.DEBUG>V||(console.groupEnd(),X("--- GROUP END ---"))},time:c=>{G.DEBUG>V||console.time(c)},timeEnd:c=>{G.DEBUG>V||console.timeEnd(c)}};var pe=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.logger=i,this.isRunning=!1,this.stopRequested=!1}async runSimulation({daysToRun:e},t){if(this.isRunning){this.logger.warn("AutomatedPlayer","AUTOTRADER-01 is already running.");return}this.isRunning=!0,this.stopRequested=!1;let i=this.gameState.day,a=i+e;for(this.logger.info.system("Bot",i,"SIMULATION_START",`Starting simulation for ${e} days.`);this.gameState.day<a&&!this.stopRequested;){let s=this.simulationService._getActiveShip();if(s){let n=s.fuel/s.maxFuel*100,r=s.health/s.maxHealth*100;n<30&&(this.logger.info.system("Bot",this.gameState.day,"REFUEL",`Low fuel (${n.toFixed(1)}%). Refueling.`),this.simulationService.botRefuel()),r<30&&(this.logger.info.system("Bot",this.gameState.day,"REPAIR",`Low hull integrity (${r.toFixed(1)}%). Repairing.`),this.simulationService.botRepair())}let o=this._findBestTradeRoute();if(o){this.logger.group(`[Bot] [Day ${this.gameState.day}] Executing Trade Route: ${o.goodId}`),this.gameState.currentLocationId!==o.buyLocationId&&this.simulationService.initiateTravel(o.buyLocationId);let n=this._calculateMaxBuy(o.goodId,o.buyPrice);n>0&&this.simulationService.buyItem(o.goodId,n),this.gameState.currentLocationId!==o.sellLocationId&&this.simulationService.initiateTravel(o.sellLocationId);let r=this.simulationService._getActiveInventory()[o.goodId]?.quantity||0;r>0&&this.simulationService.sellItem(o.goodId,r),this.logger.groupEnd()}else this.simulationService._advanceDays(1);t(this.gameState.day,a),await new Promise(n=>setTimeout(n,10))}this.logger.info.system("Bot",this.gameState.day,"SIMULATION_END","Simulation finished."),this.isRunning=!1}stop(){this.stopRequested=!0}_calculateMaxBuy(e,t){let i=this.gameState.getState(),a=this.simulationService._getActiveShip(),s=this.simulationService._getActiveInventory(),o=a.cargoCapacity-Object.values(s).reduce((l,h)=>l+h.quantity,0),n=t>0?Math.floor(i.player.credits/t):o,r=i.market.inventory[i.currentLocationId][e].quantity;return Math.max(0,Math.min(o,n,r))}_findBestTradeRoute(){let e=this.gameState.getState(),t=null,i=0,a=d.COMMODITIES.filter(s=>s.tier<=e.player.revealedTier);for(let s of a)for(let o of d.MARKETS)if(e.player.unlockedLocationIds.includes(o.id))for(let n of d.MARKETS){if(o.id===n.id||!e.player.unlockedLocationIds.includes(n.id))continue;let r=e.market.prices[o.id][s.id],l=e.market.prices[n.id][s.id],h=l-r;if(h>0){let u=e.TRAVEL_DATA[e.currentLocationId]?.[o.id]?.time||0,p=e.TRAVEL_DATA[o.id]?.[n.id]?.time||0,m=u+p+1,f=h/m;f>i&&(i=f,t={goodId:s.id,buyLocationId:o.id,sellLocationId:n.id,buyPrice:r,sellPrice:l,profitPerUnit:h})}}return t}},ne=class{constructor(e,t,i,a,s){this.gameState=e,this.simulationService=t,this.uiManager=i,this.directorModeService=a,this.logger=s,this.gui=null,this.active=!1,this.actions={},this.debugState={},this.bot=new pe(e,t,s)}init(){this.gui||(this.gui=new lil.GUI,this.gui.domElement.style.display="none",this._registerDebugActions(),this.buildGui())}handleKeyPress(e){let t=Object.values(this.actions).find(i=>i.key===e);t&&t.handler&&t.handler()}toggleVisibility(){this.gui&&(this.active=!this.active,this.gui.domElement.style.display=this.active?"block":"none")}generateBugReport(){let e=this.logger.getLogHistory(),t=this.gameState.getState();delete t.TRAVEL_DATA,delete t.market.priceHistory;let i=`
ORBITAL TRADING - BUG REPORT
==============================
Date: ${new Date().toISOString()}

--- GAME STATE SNAPSHOT ---
${JSON.stringify(t,null,2)}

--- RECENT LOG HISTORY ---
${e}
        `;navigator.clipboard.writeText(i.trim()).then(()=>{this.uiManager.createFloatingText("Bug Report Copied to Clipboard!",window.innerWidth/2,window.innerHeight/2,"#4ade80")}).catch(a=>{this.logger.error("DebugService","Failed to copy bug report.",a)})}_registerDebugActions(){this.actions={godMode:{name:"God Mode",type:"button",handler:()=>this.simulationService.debugGodMode()},directorMode:{name:"Director Mode",type:"button",handler:()=>this.directorModeService.toggleVisibility()},addCredits:{name:"Add Credits",type:"button",handler:()=>{this.gameState.player.credits+=this.debugState.creditsToAdd,this.simulationService._checkMilestones(),this.uiManager.render(this.gameState.getState())}},payDebt:{name:"Pay Off Debt",type:"button",handler:()=>this.simulationService.payOffDebt()},teleport:{name:"Teleport",type:"button",handler:()=>{this.debugState.selectedLocation&&(this.gameState.currentLocationId=this.debugState.selectedLocation,this.gameState.setState({}))}},unlockAll:{name:"Unlock All",type:"button",handler:()=>{this.gameState.player.unlockedLocationIds=d.MARKETS.map(e=>e.id),this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(d.LICENSES),this.gameState.setState({})}},grantAllShips:{name:"Grant All Ships",type:"button",handler:()=>{Object.keys(d.SHIPS).forEach(e=>{this.gameState.player.ownedShipIds.includes(e)||this.simulationService.addShipToHangar(e)}),this.gameState.setState({})}},advanceTime:{name:"Advance Days",type:"button",handler:()=>this.simulationService._advanceDays(this.debugState.daysToAdvance)},evolvePrices:{name:"Evolve Prices (7d)",type:"button",handler:()=>this.simulationService.marketService.evolveMarketPrices()},replenishStock:{name:"Replenish All Stock",type:"button",handler:()=>{this.simulationService.marketService.replenishMarketInventory(),this.gameState.setState({})}},triggerRandomEvent:{name:"Trigger Random Event",type:"button",handler:()=>{let e=d.MARKETS.find(t=>t.id!==this.gameState.currentLocationId)?.id;e&&this.simulationService._checkForRandomEvent(e,this.debugState.selectedRandomEvent)}},triggerAgeEvent:{name:"Trigger Age Event",type:"button",handler:()=>{let e=d.AGE_EVENTS.find(t=>t.id===this.debugState.selectedAgeEvent);e&&this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t))}},triggerMission:{name:"Trigger Mission",type:"button",handler:()=>{this.debugState.selectedMission&&this.simulationService.missionService.acceptMission(this.debugState.selectedMission)}},startBot:{name:"Start AUTOTRADER-01",type:"button",handler:()=>{let e=this.gui.controllers.find(t=>t.property==="botProgress");this.bot.runSimulation({daysToRun:this.debugState.botDaysToRun},(t,i)=>{e&&e.setValue(`${t} / ${i}`).updateDisplay()})}},stopBot:{name:"Stop AUTOTRADER-01",type:"button",handler:()=>this.bot.stop()}}}buildGui(){let e=this.gui.addFolder("Game Flow");e.add(this.actions.godMode,"handler").name(this.actions.godMode.name),e.add(this.actions.directorMode,"handler").name(this.actions.directorMode.name);let t=this.gui.addFolder("Player");this.debugState.creditsToAdd=1e5,t.add(this.debugState,"creditsToAdd").name("Credits Amount"),t.add(this.actions.addCredits,"handler").name("Add Credits"),t.add(this.actions.payDebt,"handler").name(this.actions.payDebt.name);let i=d.MARKETS.reduce((u,p)=>({...u,[p.name]:p.id}),{});this.debugState.selectedLocation=this.gameState.currentLocationId,t.add(this.debugState,"selectedLocation",i).name("Location"),t.add(this.actions.teleport,"handler").name("Teleport");let a=this.gui.addFolder("World & Time");this.debugState.daysToAdvance=7,a.add(this.debugState,"daysToAdvance",1,365,1).name("Days to Advance"),a.add(this.actions.advanceTime,"handler").name("Advance Time");let s=this.gui.addFolder("Economy");s.add(this.actions.evolvePrices,"handler").name(this.actions.evolvePrices.name),s.add(this.actions.replenishStock,"handler").name(this.actions.replenishStock.name),s.add(this.actions.unlockAll,"handler").name("Unlock Tiers/Locations"),s.add(this.actions.grantAllShips,"handler").name("Grant All Ships");let o=this.gui.addFolder("Triggers"),n=d.RANDOM_EVENTS.reduce((u,p,m)=>({...u,[p.title]:m}),{});this.debugState.selectedRandomEvent=0,o.add(this.debugState,"selectedRandomEvent",n).name("Random Event"),o.add(this.actions.triggerRandomEvent,"handler").name("Trigger Event");let r=d.AGE_EVENTS.reduce((u,p)=>({...u,[p.title]:p.id}),{});this.debugState.selectedAgeEvent=d.AGE_EVENTS[0].id,o.add(this.debugState,"selectedAgeEvent",r).name("Age Event"),o.add(this.actions.triggerAgeEvent,"handler").name("Trigger Event");let l=Object.values(d.MISSIONS).reduce((u,p)=>({...u,[p.name]:p.id}),{});this.debugState.selectedMission=Object.keys(l)[0],o.add(this.debugState,"selectedMission",l).name("Mission"),o.add(this.actions.triggerMission,"handler").name("Accept Mission");let h=this.gui.addFolder("Automation & Logging");this.debugState.logLevel="INFO",h.add(this.debugState,"logLevel",["DEBUG","INFO","WARN","ERROR","NONE"]).name("Log Level").onChange(u=>this.logger.setLevel(u)),h.add(this,"generateBugReport").name("Generate Bug Report"),this.debugState.botDaysToRun=365,this.debugState.botProgress="Idle",h.add(this.debugState,"botDaysToRun",1,1e4,1).name("Simulation Days"),h.add(this.actions.startBot,"handler").name(this.actions.startBot.name),h.add(this.actions.stopBot,"handler").name(this.actions.stopBot.name),h.add(this.debugState,"botProgress").name("Progress").listen(),this.gui.folders.forEach(u=>u.close())}};var ke={mouse_pointer:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13.62,1.38a1,1,0,0,0-1.24,0L1,13.21a1,1,0,0,0,0,1.41l1.41,1.41a1,1,0,0,0,1.41,0L12,7.83l5.18,5.18a1,1,0,0,0,1.41,0l1.41-1.41a1,1,0,0,0,0-1.41Z"/></svg>',click:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13.62,1.38a1,1,0,0,0-1.24,0L1,13.21a1,1,0,0,0,0,1.41l1.41,1.41a1,1,0,0,0,1.41,0L12,7.83l5.18,5.18a1,1,0,0,0,1.41,0l1.41-1.41a1,1,0,0,0,0-1.41Z"/><path fill="currentColor" d="M19.47,20.53a1,1,0,0,1-1.42,0l-3.18-3.18a1,1,0,0,1,1.42-1.42l3.18,3.18a1,1,0,0,1,0,1.42Z"/><path fill="currentColor" d="M19.47,15.47a1,1,0,0,1-1.42,0l-1-1a1,1,0,0,1,1.42-1.42l1,1a1,1,0,0,1,0,1.42Z"/></svg>',tap:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M20.5,13.23A1,1,0,0,0,19.22,13l-4.2-2.1a1,1,0,0,0-1-.13L9.09,13.15a1,1,0,0,0-.59.91v5.09a1,1,0,0,0,.5,0.86l4.4,2.54a1,1,0,0,0,1,0l4.4-2.54A1,1,0,0,0,20.5,19.15ZM15,20.12l-3-1.72v-3.41l3,1.52Zm4.5-3.87-3,1.72-1.5-.76,3-2.23,1.5,1.13Z"/><path fill="currentColor" d="M16.44,4.24,15,3.5l-2,3.46L14.44,8Z"/><path fill="currentColor" d="M19,8.46l-2-3.46L15.56,6,17,6.76Z"/><path fill="currentColor" d="m11.56,6-1.44-.76L11.56,1.8Z"/><path fill="currentColor" d="M9.12,5.24,7.56,6,6.12,5.24,7.56,1.8Z"/></svg>',swipe:'<svg viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13l4-4l4 4M3 8l4-4l4 4"/><path fill="currentColor" d="M18.5,13.23A1,1,0,0,0,17.22,13l-4.2-2.1a1,1,0,0,0-1-.13l-4.93,2.38a1,1,0,0,0-.59.91v5.09a1,1,0,0,0,.5,0.86l4.4,2.54a1,1,0,0,0,1,0l4.4-2.54A1,1,0,0,0,18.5,19.15Z"/></svg>',checkmark:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" /></svg>',cross:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M20,6.91L17.09,4L12,9.09L6.91,4L4,6.91L9.09,12L4,17.09L6.91,20L12,14.91L17.09,20L20,17.09L14.91,12L20,6.91Z" /></svg>',exclamation:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M11 4h2v12h-2z M11 18h2v2h-2z"/></svg>',question_mark:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,17.25A1.25,1.25 0 0,0 13.25,16A1.25,1.25 0 0,0 12,14.75A1.25,1.25 0 0,0 10.75,16A1.25,1.25 0 0,0 12,17.25M12,6.5A3.5,3.5 0 0,0 8.5,10H10.5A1.5,1.5 0 0,1 12,8.5A1.5,1.5 0 0,1 13.5,10C13.5,11.5 11,11.75 11,14H13C13,12.5 15.5,12.25 15.5,10A3.5,3.5 0 0,0 12,6.5Z" /></svg>'},re=class{constructor(e,t){this.uiManager=e,this.logger=t,this.isActive=!1,this.isPickerActive=!1,this.cues=[],this.selectedCue=null,this.actionState={isDragging:!1,isResizing:!1,startX:0,startY:0,originalX:0,originalY:0,originalWidth:0,originalHeight:0},this.toolkitActionState={isDragging:!1,startX:0,startY:0,originalX:0,originalY:0},this.toolkit=null,this.cueControllers=[],this.pickerButton=null}toggleVisibility(){this.isActive=!this.isActive;let e=this.uiManager.cache.directorModeOverlay;this.isActive?(this.uiManager.showDirectorMode(),e.classList.add("interactive"),this.toolkit||this.buildToolkit(),this.render(),this.logger.info.system("DirectorMode","SYSTEM","ACTIVATED","Visual tutorial editor is now active.")):(this.uiManager.hideDirectorMode(),e.classList.remove("interactive"),this.logger.info.system("DirectorMode","SYSTEM","DEACTIVATED","Visual tutorial editor is now inactive."))}buildToolkit(){this.toolkit=new lil.GUI({container:this.uiManager.cache.directorToolkit,title:"Director's Toolkit",draggable:!1});let e=document.createElement("div");e.className="drag-handle",this.uiManager.cache.directorToolkit.appendChild(e),this.actions={addShape:()=>this.addCue({type:"Shape"}),addArrow:()=>this.addCue({type:"Arrow"}),addIcon:()=>this.addCue({type:"Icon"}),togglePicker:()=>this.togglePickerMode(),deleteCue:()=>this.deleteSelectedCue(),copyConfig:()=>this.copyConfigToClipboard()};let t=this.toolkit.addFolder("Creation");t.add(this.actions,"addShape").name("Add Shape"),t.add(this.actions,"addArrow").name("Add Arrow"),t.add(this.actions,"addIcon").name("Add Icon");let i=this.toolkit.addFolder("Advanced");this.pickerButton=i.add(this.actions,"togglePicker").name("Start Picking Element"),this.toolkit.addFolder("Cue Properties"),this.toolkit.addFolder("Style"),this.toolkit.add(this.actions,"deleteCue").name("Delete Selected"),this.copyButton=this.toolkit.add(this.actions,"copyConfig").name("Copy Config to Clipboard"),this.copyButton.disable()}togglePickerMode(){this.isPickerActive=!this.isPickerActive,this.pickerButton.name(this.isPickerActive?"Stop Picking (ESC)":"Start Picking Element"),this.uiManager.cache.directorModeOverlay.classList.toggle("picker-active",this.isPickerActive),this.isPickerActive?this.logger.info.system("DirectorMode","SYSTEM","PICKER_ON","Element picker is active. Click an element to anchor a cue."):this.logger.info.system("DirectorMode","SYSTEM","PICKER_OFF","Element picker is inactive.")}captureElement(e){if(!this.selectedCue){this.logger.warn("DirectorMode","Picker Error: No cue selected to anchor."),this.togglePickerMode();return}let t="";e.id?t=`#${e.id}`:e.dataset.action?(t=`[data-action="${e.dataset.action}"]`,e.dataset.goodId&&(t+=`[data-good-id="${e.dataset.goodId}"]`),e.dataset.shipId&&(t+=`[data-ship-id="${e.dataset.shipId}"]`)):t=e.tagName.toLowerCase()+(e.className?"."+e.className.split(" ").join("."):""),this.logger.info.system("DirectorMode","ANCHOR",`Anchored cue ${this.selectedCue.id} to element: ${t}`),this.selectedCue.anchorTarget=t,this.selectedCue.positionMode="anchored",this.updateToolkit(),this.togglePickerMode(),this.render()}addCue({type:e}){let t={id:`cue-${Date.now()}`,type:e,tutorialStepId:"",x:100,y:100,width:150,height:150,rotation:0,style:{fill:"rgba(253, 224, 71, 0.2)",stroke:"#fde047",strokeWidth:3,opacity:1,animation:"None",animationSpeed:2,glowColor:"#fde047",glowIntensity:10,borderRadius:0,boxShadow:"none"}};e==="Shape"?t.shapeType="Rectangle":e==="Icon"?t.iconName="mouse_pointer":e==="Arrow"&&(t.width=100,t.height=50),this.cues.push(t),this.selectCue(t)}deleteSelectedCue(){this.selectedCue&&(this.cues=this.cues.filter(e=>e.id!==this.selectedCue.id),this.selectCue(null))}selectCue(e){this.selectedCue=e,this.updateToolkit(),this.render()}updateToolkit(){this.cueControllers.forEach(i=>i.destroy()),this.cueControllers=[];let e=this.toolkit.folders.find(i=>i._title==="Cue Properties"),t=this.toolkit.folders.find(i=>i._title==="Style");if([...e.children,...t.children].forEach(i=>i.destroy()),this.selectedCue){let i=this.selectedCue,a=e.add(i,"tutorialStepId").name("Step ID");a.onChange(()=>this.validateExport()),this.cueControllers.push(a),this.cueControllers.push(e.add(i,"x",0,window.innerWidth).name("X").listen()),this.cueControllers.push(e.add(i,"y",0,window.innerHeight).name("Y").listen()),this.cueControllers.push(e.add(i,"width",10,500).name("Width").listen()),this.cueControllers.push(e.add(i,"height",10,500).name("Height").listen()),this.cueControllers.push(e.add(i,"rotation",0,360,1).name("Rotation").listen()),i.type==="Shape"?(this.cueControllers.push(e.add(i,"shapeType",["Rectangle","Ellipse"]).name("Shape")),this.cueControllers.push(t.add(i.style,"borderRadius",0,100,1).name("Border Radius"))):i.type==="Icon"&&this.cueControllers.push(e.add(i,"iconName",Object.keys(ke)).name("Icon")),this.cueControllers.push(t.addColor(i.style,"fill").name("Fill Color")),this.cueControllers.push(t.addColor(i.style,"stroke").name("Stroke Color")),this.cueControllers.push(t.add(i.style,"strokeWidth",0,10,1).name("Stroke Width")),this.cueControllers.push(t.add(i.style,"opacity",0,1,.1).name("Opacity")),this.cueControllers.push(t.add(i.style,"boxShadow").name("Box Shadow"));let s=t.add(i.style,"animation",["None","Pulse","Glow"]).name("Animation");s.onChange(()=>this.updateToolkit()),this.cueControllers.push(s),i.style.animation!=="None"&&this.cueControllers.push(t.add(i.style,"animationSpeed",.5,5,.1).name("Speed (s)")),i.style.animation==="Glow"&&(this.cueControllers.push(t.addColor(i.style,"glowColor").name("Glow Color")),this.cueControllers.push(t.add(i.style,"glowIntensity",1,30,1).name("Glow Intensity"))),this.cueControllers.forEach(o=>o.onChange(()=>this.render()))}this.validateExport()}handleInput(e){if(!this.isActive||!e.target||typeof e.target.closest!="function")return;let t=e.target,i=t.classList.contains("drag-handle"),a=t.closest(".director-cue"),s=this.uiManager.cache.directorToolkit;switch(e.type){case"mousedown":if(i){this.toolkitActionState.isDragging=!0,this.toolkitActionState.startX=e.clientX,this.toolkitActionState.startY=e.clientY;let o=s.getBoundingClientRect();this.toolkitActionState.originalX=o.left,this.toolkitActionState.originalY=o.top,e.preventDefault()}else if(a){let o=this.cues.find(n=>n.id===a.dataset.id);this.selectCue(o),this.actionState.isDragging=!0,this.actionState.startX=e.clientX,this.actionState.startY=e.clientY,this.actionState.originalX=o.x,this.actionState.originalY=o.y,this.actionState.originalWidth=o.width,this.actionState.originalHeight=o.height,t.classList.contains("resize-handle")&&(this.actionState.isDragging=!1,this.actionState.isResizing=!0,this.actionState.handle=t.dataset.handle)}else t.closest(".lil-gui")||this.selectCue(null);break;case"mousemove":if(this.toolkitActionState.isDragging){let o=e.clientX-this.toolkitActionState.startX,n=e.clientY-this.toolkitActionState.startY;s.style.left=`${this.toolkitActionState.originalX+o}px`,s.style.top=`${this.toolkitActionState.originalY+n}px`,s.style.right="auto",s.style.bottom="auto"}else if(this.selectedCue&&(this.actionState.isDragging||this.actionState.isResizing)){let o=e.clientX-this.actionState.startX,n=e.clientY-this.actionState.startY;this.actionState.isDragging?(this.selectedCue.x=this.actionState.originalX+o,this.selectedCue.y=this.actionState.originalY+n):this.actionState.isResizing&&(this.selectedCue.width=Math.max(10,this.actionState.originalWidth+o),this.selectedCue.height=Math.max(10,this.actionState.originalHeight+n))}break;case"mouseup":case"mouseleave":this.actionState.isDragging=!1,this.actionState.isResizing=!1,this.toolkitActionState.isDragging=!1;break}}render(){if(!this.isActive)return;let e=this.uiManager.cache.directorModeOverlay;e.innerHTML="",this.cues.forEach(t=>{let i=document.createElement("div");if(i.className="director-cue",i.dataset.id=t.id,t.positionMode==="anchored"&&t.anchorTarget){let o=document.querySelector(t.anchorTarget);if(o){let n=o.getBoundingClientRect();i.style.left=`${n.left}px`,i.style.top=`${n.top}px`,i.style.width=`${n.width}px`,i.style.height=`${n.height}px`}else i.style.left=`${t.x}px`,i.style.top=`${t.y}px`,i.style.width=`${t.width}px`,i.style.height=`${t.height}px`}else i.style.left=`${t.x}px`,i.style.top=`${t.y}px`,i.style.width=`${t.width}px`,i.style.height=`${t.height}px`;i.style.transform=`rotate(${t.rotation}deg)`,i.style.opacity=t.style.opacity,i.style.boxShadow=t.style.boxShadow,t.style.animation!=="None"&&i.classList.add(`anim-${t.style.animation.toLowerCase()}`);let a="";t.type==="Shape"?a=`
                    <svg width="100%" height="100%" viewBox="0 0 ${t.width} ${t.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${t.shapeType==="Rectangle"?`<rect x="0" y="0" width="100%" height="100%" rx="${t.style.borderRadius}" ry="${t.style.borderRadius}" style="fill:${t.style.fill}; stroke:${t.style.stroke}; stroke-width:${t.style.strokeWidth}px;" />`:`<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${t.style.fill}; stroke:${t.style.stroke}; stroke-width:${t.style.strokeWidth}px;" />`}
                    </svg>`:t.type==="Icon"?(a=ke[t.iconName]||"",i.style.color=t.style.fill):t.type==="Arrow"&&(a=`
                    <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                            <marker id="arrowhead-${t.id}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${t.style.stroke}" />
                            </marker>
                        </defs>
                        <line x1="0" y1="25" x2="90" y2="25" stroke="${t.style.stroke}" stroke-width="${t.style.strokeWidth}" marker-end="url(#arrowhead-${t.id})" />
                    </svg>
                `),i.innerHTML=a;let s=i.querySelector("svg")||i;if(t.style.animation!=="None"&&(s.classList.add(`anim-${t.style.animation.toLowerCase()}`),s.style.setProperty("--glow-color",t.style.glowColor),s.style.setProperty("--glow-intensity",`${t.style.glowIntensity}px`),s.style.setProperty("--anim-speed",`${t.style.animationSpeed}s`)),this.selectedCue&&this.selectedCue.id===t.id){i.classList.add("selected");let o=`
                    <div class="resize-handle n" data-handle="n"></div><div class="resize-handle ne" data-handle="ne"></div>
                    <div class="resize-handle e" data-handle="e"></div><div class="resize-handle se" data-handle="se"></div>
                    <div class="resize-handle s" data-handle="s"></div><div class="resize-handle sw" data-handle="sw"></div>
                    <div class="resize-handle w" data-handle="w"></div><div class="resize-handle nw" data-handle="nw"></div>
                    <div class="rotate-handle" data-handle="rotate"></div>
                `;i.innerHTML+=o}e.appendChild(i)})}validateExport(){this.cues.some(t=>t.tutorialStepId&&t.tutorialStepId.trim()!=="")?this.copyButton.enable():this.copyButton.disable()}copyConfigToClipboard(){let e=this.cues.reduce((i,a)=>{if(a.tutorialStepId&&a.tutorialStepId.trim()!==""){let s=a.tutorialStepId.trim();i[s]||(i[s]=[]);let{id:o,...n}=a;i[s].push(n)}return i},{}),t=JSON.stringify(e,null,2);navigator.clipboard.writeText(t).then(()=>{this.logger.info.system("DirectorMode","EXPORT","Cue configuration copied to clipboard."),this.uiManager.createFloatingText("Config Copied!",window.innerWidth/2,window.innerHeight/2,"#4ade80")}).catch(i=>{this.logger.error("DirectorMode","Failed to copy config.",i)})}};document.addEventListener("DOMContentLoaded",()=>{let c=document.getElementById("splash-screen"),e=document.getElementById("start-game-btn"),t=!0;e.addEventListener("click",()=>{c.classList.add("modal-hiding"),c.addEventListener("animationend",()=>{c.style.display="none"},{once:!0}),i()},{once:!0});function i(){let a=new J,s=new te(q),o=new se(a,s,q),n=new ee(a,s,q),r=new ae(a,s,n,s.navStructure,q),l=null,h=null;t&&(h=new re(s,q),l=new ne(a,n,s,h,q),l.init()),s.setMissionService(o),n.setTutorialService(r),n.setMissionService(o),o.setSimulationService(n);let u=new ie(a,n,s,r,l,h,q);a.subscribe(()=>s.render(a.getState()));let p=a.loadGame();p||(a.startNewGame(""),n._advanceDays(7),n.startIntroSequence()),u.bindEvents(),p&&(document.getElementById("game-container").classList.remove("hidden"),s.render(a.getState())),r.checkState({type:"SCREEN_LOAD",screenId:a.activeScreen})}});})();
