(()=>{var _=Object.freeze({MAP:"map",NAVIGATION:"navigation",SERVICES:"services",MARKET:"market",CARGO:"cargo",HANGAR:"hangar",MISSIONS:"missions",FINANCE:"finance",INTEL:"intel"}),H=Object.freeze({SHIP:"ship",STARPORT:"starport",DATA:"data"}),G=Object.freeze({WANDERER:"Wanderer.Ship",STALWART:"Stalwart.Ship",MULE:"Mule.Ship",PATHFINDER:"Pathfinder.Ship",NOMAD:"Nomad.Ship",VINDICATOR:"Vindicator.Ship",AEGIS:"Aegis.Ship",ODYSSEY:"Odyssey.Ship",MAJESTIC:"luxury_s2",TITAN_HAULER:"Titan.Ship",VOID_CHASER:"rare_s2",GUARDIAN:"Guardian.Ship",STARGAZER:"rare_s4",BEHEMOTH:"Behemoth.Ship"}),M=Object.freeze({WATER_ICE:"water_ice",PLASTEEL:"plasteel",HYDROPONICS:"hydroponics",CYBERNETICS:"cybernetics",PROPELLANT:"propellant",PROCESSORS:"processors",GRAPHENE_LATTICES:"graphene_lattices",CRYO_PODS:"cryo_pods",ATMO_PROCESSORS:"atmos_processors",CLONED_ORGANS:"cloned_organs",XENO_GEOLOGICALS:"xeno_geologicals",SENTIENT_AI:"sentient_ai",ANTIMATTER:"antimatter",FOLDED_DRIVES:"folded_drives"}),I=Object.freeze({EARTH:"loc_earth",LUNA:"loc_luna",MARS:"loc_mars",VENUS:"loc_venus",BELT:"loc_belt",SATURN:"loc_saturn",JUPITER:"loc_jupiter",URANUS:"loc_uranus",NEPTUNE:"loc_neptune",PLUTO:"loc_pluto",EXCHANGE:"loc_exchange",KEPLER:"loc_kepler"}),R=Object.freeze({TRADEMASTER:"trademaster",NAVIGATOR:"navigator",VENETIAN_SYNDICATE:"venetian_syndicate",MERCHANT_GUILD_SHIP:"merchant_guild_ship"}),w=Object.freeze({DEBUG_SIMPLE_START:"debug-simple-start",SET_SCREEN:"set-screen",TRAVEL:"travel",BUY_SHIP:"buy-ship",SELL_SHIP:"sell-ship",SELECT_SHIP:"select-ship",PAY_DEBT:"pay-debt",TAKE_LOAN:"take-loan",PURCHASE_INTEL:"purchase-intel",ACQUIRE_LICENSE:"acquire-license",BUY_ITEM:"buy-item",SELL_ITEM:"sell-item",SET_MAX_BUY:"set-max-buy",SET_MAX_SELL:"set-max-sell",INCREMENT:"increment",DECREMENT:"decrement",SHOW_PRICE_GRAPH:"show-price-graph",SHOW_FINANCE_GRAPH:"show-finance-graph",TOGGLE_MARKET_CARD_VIEW:"toggle-market-card-view",TOGGLE_HANGAR_MODE:"toggle-hangar-mode",SET_HANGAR_PAGE:"set-hangar-page"}),K=Object.freeze({SCREEN_LOAD:"SCREEN_LOAD",ACTION:"ACTION",INFO:"INFO"}),pe=Object.freeze({MOD_PRICE:"MOD_PRICE",MOD_FUEL_BURN:"MOD_FUEL_BURN",MOD_FUEL_PRICE:"MOD_FUEL_PRICE",MOD_TRAVEL_TIME:"MOD_TRAVEL_TIME",MOD_HULL_DECAY:"MOD_HULL_DECAY",MOD_SERVICE_COST:"MOD_SERVICE_COST",TRIGGER_ON_TRAVEL:"TRIGGER_ON_TRAVEL",TRIGGER_ON_TRADE:"TRIGGER_ON_TRADE",PASSIVE_EFFECT:"PASSIVE_EFFECT",RESTRICTION:"RESTRICTION"}),C=Object.freeze({MOD_TRAVEL_SPEED:"MOD_TRAVEL_SPEED",MOD_FUEL_BURN:"MOD_FUEL_BURN",MOD_FUEL_PRICE:"MOD_FUEL_PRICE",MOD_BUY_PRICE:"MOD_BUY_PRICE",MOD_SELL_PRICE:"MOD_SELL_PRICE",MOD_MAX_HULL:"MOD_MAX_HULL",MOD_MAX_FUEL:"MOD_MAX_FUEL",MOD_MAX_CARGO:"MOD_MAX_CARGO",MOD_EVENT_CHANCE:"MOD_EVENT_CHANCE",MOD_REPAIR_COST:"MOD_REPAIR_COST",MOD_PASSIVE_REPAIR:"MOD_PASSIVE_REPAIR",MOD_DEBT_INTEREST:"MOD_DEBT_INTEREST"}),P=Object.freeze({BLUE:"#3b82f6",CYAN:"#06b6d4",GREEN:"#22c55e",GOLD:"#eab308",GREY:"#94a3b8",INDIGO:"#6366f1",EMERALD:"#10b981",SEAFOAM:"#14b8a6",ORANGE:"#f97316",RED:"#ef4444",VIOLET:"#8b5cf6"}),$=Object.freeze({STARTING_CREDITS:5e3,STARTING_DEBT_INTEREST:125,REPAIR_COST_PER_HP:75,REPAIR_AMOUNT_PER_TICK:5,FUEL_SCALAR:2.5,INTEREST_INTERVAL:30,PASSIVE_REPAIR_RATE:.02,HULL_DECAY_PER_TRAVEL_DAY:1/7,SHIP_SELL_MODIFIER:.75,RARE_SHIP_CHANCE:.3,PRICE_HISTORY_LENGTH:65,FINANCE_HISTORY_LENGTH:25,DAILY_PRICE_VOLATILITY:.25,MEAN_REVERSION_STRENGTH:.04,MARKET_PRESSURE_DECAY:.7,LOCAL_PRICE_MOD_STRENGTH:.5,LOAN_GARNISHMENT_DAYS:1095,LOAN_GARNISHMENT_PERCENT:.14,RANDOM_EVENT_CHANCE:.07}),je=[{threshold:5e4,revealsTier:2},{threshold:45e4,revealsTier:3},{threshold:4e6,revealsTier:4},{threshold:35e6,revealsTier:5},{threshold:3e8,revealsTier:6},{threshold:25e8,revealsTier:7}],ze="orbitalTraderSave_v2";var Xe={mission_tutorial_01:{id:"mission_tutorial_01",name:"Milk Run to Luna",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"Hey buddy, you're a new captain, right? My hauler's reactor is fried and I'm on the hook for a delivery to Luna.<br><br>Could you deliver this load of <b>Plasteel</b> to the <b>Moon</b> for me? I don't have any credits to spare, but I've padded the manifest.<br><br>Deliver what I owe, keep the rest. You won't have trouble selling it there, trust me.",objectives:[{type:"have_item",goodId:"plasteel",quantity:5}],completion:{locationId:"loc_luna",title:"Favor Complete",text:"The freelancer sends his thanks.",buttonText:"Deliver Plasteel"},rewards:[],providedCargo:[{goodId:"plasteel",quantity:6}]},mission_tutorial_02:{id:"mission_tutorial_02",name:"Martian Resupply",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"A construction crew on Mars has requested a small shipment of plasteel to complete a habitat.",prerequisites:[{type:"mission_completed",missionId:"mission_tutorial_01"}],objectives:[{type:"have_item",goodId:"plasteel",quantity:2}],completion:{locationId:"loc_mars",title:"Delivery Complete",text:"The construction foreman thanks you for the Plasteel.",buttonText:"Deliver Plasteel"},rewards:[{type:"credits",amount:7500}]},mission_license_t3:{id:"mission_license_t3",name:"Guild Certification",type:"LICENSE_GRANT",host:"GUILD",isRepeatable:!1,isAbandonable:!1,description:"The Merchant's Guild requires you to certify your trade proficiency. Accepting this contract formally recognizes your status and grants you access to Tier 3 commodities.",prerequisites:[{type:"revealed_tier",tier:3}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t3_license"}]},mission_license_t5:{id:"mission_license_t5",name:"Governor's Contract",type:"LICENSE_GRANT",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"The planetary governor requires a sign of your commitment to local industry. This contract solidifies your standing and unlocks access to Tier 5 commodities.",prerequisites:[{type:"revealed_tier",tier:5}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t5_license"}]},mission_license_t7:{id:"mission_license_t7",name:"Legendary Run",type:"LICENSE_GRANT",host:"UNKNOWN",isRepeatable:!1,isAbandonable:!1,description:"Your name is spoken in the farthest corners of the system. Only a legend of your stature may be granted the right to trade the most advanced technologies known.",prerequisites:[{type:"revealed_tier",tier:7}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t7_license"}]}};var Qe=[{id:"distress_call",title:"Distress Call",scenario:"You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.",precondition:(c,e)=>e.fuel>=20,choices:[{title:"Offer Aid (20 Fuel)",outcomes:[{chance:.75,description:"The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.",effects:[{type:"fuel",value:-20},{type:"credits",value:1e4}]},{chance:.25,description:"As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.",effects:[{type:"fuel",value:-20},{type:"hull_damage_percent",value:15}]}]},{title:"Ignore the Call",outcomes:[{chance:1,description:"You press on, and the desperate signal fades behind you.",effects:[]}]}]},{id:"floating_cargo",title:"Floating Cargo Pod",scenario:"Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.",precondition:()=>!0,choices:[{title:"Bring it Aboard",outcomes:[{chance:.6,description:"The pod contains valuable goods. You gain 25 units of Neural Processors.",effects:[{type:"add_cargo",value:{id:M.PROCESSORS,quantity:25}}]},{chance:.4,description:"It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.",effects:[{type:"hull_damage_percent",value:20}]}]},{title:"Report it",outcomes:[{chance:1,description:"You notify the nearest station of the hazard and receive a small finder's fee of 1,000 credits.",effects:[{type:"credits",value:1e3}]}]}]},{id:"adrift_passenger",title:"Adrift Passenger",scenario:"You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.",precondition:(c,e)=>e.fuel>=30,choices:[{title:"Take Aboard for Payment",outcomes:[{chance:1,description:"The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.",effects:[{type:"credits",value:1e4}]}]},{title:"Give a Fuel Cell (30 Fuel)",outcomes:[{chance:1,descriptions:{reward_cybernetics:'In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.',reward_debt_paid:'Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.',reward_credits:'With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.'},effects:[{type:"ADRIFT_PASSENGER"}]}]}]},{id:"meteoroid_swarm",title:"Micrometeoroid Swarm",scenario:"Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.",precondition:(c,e)=>e.fuel>=15,choices:[{title:"Evade Aggressively (+15 Fuel)",outcomes:[{chance:1,description:"You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.",effects:[{type:"fuel",value:-15}]}]},{title:"Brace for Impact",outcomes:[{chance:1,description:"You trust your hull to withstand the impacts, taking a beating but saving fuel.",effects:[{type:"hull_damage_percent",value:[10,25]}]}]}]},{id:"engine_malfunction",title:"Engine Malfunction",scenario:"A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.",precondition:(c,e,t)=>(t()[M.PLASTEEL]?.quantity||0)>=5,choices:[{title:"Quick, Risky Fix (5 Plasteel)",outcomes:[{chance:.5,description:"The patch holds! The engine stabilizes and you continue your journey without further incident.",effects:[{type:"lose_cargo",value:{id:M.PLASTEEL,quantity:5}}]},{chance:.5,description:"The patch fails catastrophically, causing a small explosion that deals 20% hull damage.",effects:[{type:"lose_cargo",value:{id:M.PLASTEEL,quantity:5}},{type:"hull_damage_percent",value:20}]}]},{title:"Limp to Destination",outcomes:[{chance:1,description:"You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.",effects:[{type:"travel_time_add_percent",value:.25}]}]}]},{id:"nav_glitch",title:"Navigation Sensor Glitch",scenario:"The nav-console flashes red. Your primary positioning sensors are offline, and you're flying blind in the deep dark.",precondition:()=>!0,choices:[{title:"Attempt Hard Reboot",outcomes:[{chance:.5,description:"Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.",effects:[{type:"set_travel_time",value:1}]},{chance:.5,description:"The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.",effects:[{type:"travel_time_add",value:15}]}]},{title:"Navigate Manually",outcomes:[{chance:1,description:"You rely on old-fashioned star charts. It's slow but safe, adding 7 days to your trip.",effects:[{type:"travel_time_add",value:7}]}]}]},{id:"life_support_fluctuation",title:"Life Support Fluctuation",scenario:"An alarm indicates unstable oxygen levels. It's not critical yet, but the crew is on edge and efficiency is dropping.",precondition:(c,e)=>e.health>e.maxHealth*.25,choices:[{title:"Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)",outcomes:[{chance:1,description:"You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship's integrity is compromised.",effects:[{type:"hull_damage_percent",value:25}]}]},{title:"Defer Maintenance Costs",outcomes:[{chance:1,description:"You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.",effects:[{type:"add_debt",value:5e3}]}]}]},{id:"cargo_rupture",title:"Cargo Hold Rupture",scenario:"A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.",precondition:(c,e,t)=>{let i=t();return i?Object.values(i).some(a=>a.quantity>0):!1},choices:[{title:"Jettison Damaged Cargo",outcomes:[{chance:1,description:"You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.",effects:[{type:"lose_random_cargo_percent",value:.1}]}]},{title:"Attempt EVA Repair",outcomes:[{chance:.75,description:"The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.",effects:[{type:"travel_time_add",value:2}]},{chance:.25,description:"The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.",effects:[{type:"lose_random_cargo_percent",value:.5},{type:"travel_time_add",value:2}]}]}]},{id:"space_race",title:"Space Race Wager",scenario:'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',precondition:c=>c.player.credits>100,choices:[{title:"Accept Wager (Bet: 80% of current credits)",outcomes:[{chance:1,description:"You accept the high-stakes challenge...",effects:[{type:"SPACE_RACE",wagerPercentage:.8,winChance:{S:.85,A:.7,B:.55,C:.4,O:.95}}]}]},{title:"Politely Decline",outcomes:[{chance:1,description:"You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.",effects:[]}]}]},{id:"supply_drop",title:"Emergency Supply Drop",scenario:"You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.",precondition:(c,e,t)=>{let i=t();return i&&Object.values(i).some(a=>a.quantity>0)},choices:[{title:"Divert Course to Deliver",outcomes:[{chance:1,description:"You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.",effects:[{type:"sell_random_cargo_premium",value:3},{type:"travel_time_add",value:7},{type:"set_new_random_destination"}]}]},{title:"Decline and Continue",outcomes:[{chance:1,description:"You stick to your original plan and let someone else handle the emergency supply run.",effects:[]}]}]}];var Je=[{id:"captain_choice",trigger:{day:366},title:"Captain Who?",description:"You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",choices:[{title:"Trademaster",description:"5% bonus on all trade profits.",perkId:R.TRADEMASTER,playerTitle:"Trademaster"},{title:"Navigator",description:"10% reduced fuel usage, hull decay, and travel time.",perkId:R.NAVIGATOR,playerTitle:"Navigator"}]},{id:"friends_with_benefits",trigger:{credits:5e4},title:"Friends with Benefits",description:"An ally in need is an ally indeed.",choices:[{title:"Join the Merchant's Guild",description:"Receive a free C-Class freighter.",perkId:R.MERCHANT_GUILD_SHIP},{title:"Join the Venetian Syndicate",description:"75% discount on fuel and repairs at Venus.",perkId:R.VENETIAN_SYNDICATE}]}];var Ze={intro_hangar:{title:"Your First Ship",trigger:{type:K.ACTION,action:"INTRO_START_HANGAR"},navLock:!0,steps:[{stepId:"hangar_1",text:"Welcome to the <b>Shipyard</b> on <b>Mars!</b><br><br>Every station has a port from which you can trade ships and manage your <b>Hangar</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:16,completion:{type:K.INFO},nextStepId:"hangar_2",isSkippable:!0},{stepId:"hangar_2",text:"Now that you've borrowed <b class='hl-yellow font-bold'>extra credits</b>, you can buy your first ship!<br><br>Select one of the options in the <b>Shipyard</b>. Choose carefully...",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:17,completion:{type:K.ACTION,action:w.BUY_SHIP},nextStepId:"hangar_3",isSkippable:!0,unlockPurchase:!0},{stepId:"hangar_3",text:'This is your <b>Hangar</b>. From here you can manage all the ships you own. Select your new ship and <b class="hl-yellow font-bold">Board</b> it to make it your active vessel.',size:{width:"400px",height:"110px"},anchorElement:"body",positionX:50,positionY:12,completion:{type:K.ACTION,action:w.SELECT_SHIP},nextStepId:null,isSkippable:!1}]},intro_finance:{title:"Managing Your Debt",trigger:{type:K.ACTION,action:"INTRO_START_FINANCE"},navLock:!0,steps:[{stepId:"finance_1",text:"That was a big purchase, but don't worry - you've still got some <b class='hl-yellow font-bold'>credits</b> left over!<br><br>Your transaction history and debts can be viewed on the <b>Finance</b> tab within <b>Data</b>.",size:{width:"400px",height:"120px"},anchorElement:"body",positionX:50,positionY:16,completion:{type:K.INFO},nextStepId:"finance_2",isSkippable:!1},{stepId:"finance_2",text:"Dont forget, your debt to the <b class='hl-yellow font-bold'>Merchant's Guild</b> is due in <b class='hl-red font-bold'>3 years</b>.<br><br>You will need to earn <b class='hl-yellow font-bold'>credits</b> to <b>pay off your debt</b>!",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:16,completion:{type:K.INFO},nextStepId:null,isSkippable:!1}]},intro_missions:{id:"intro_missions",title:"First Steps",trigger:{type:"ACTION",action:"INTRO_START_MISSIONS"},navLock:!0,steps:[{stepId:"mission_1_1",text:"This is the <b>Mission Terminal</b>.<br><br>Check the <b>Missions</b> tab often for opportunities to earn <b class='hl-yellow font-bold'>credits</b> and improve your reputation.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"INFO"},nextStepId:"mission_1_2",isSkippable:!1},{stepId:"mission_1_2",text:"A freelancer at the <b>Mars</b> station has put in a <b>Delivery</b> request. Select the mission '<b>Milk Run to Luna</b>' to view more details.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"ACTION",action:"show-mission-modal"},nextStepId:"mission_1_3",isSkippable:!1},{stepId:"mission_1_3",text:"The freelancer can't pay, but he's giving you the <b>remaining cargo</b>. Accept the contract.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"ACTION",action:"accept-mission"},nextStepId:"mission_1_4",isSkippable:!1},{stepId:"mission_1_4",text:"Mission accepted!<br><br>The contract is now <b>active</b> and the cargo as been loaded onto your ship, the <b>{shipName}</b>.<br><br>The freelancer has also loaded extra <b>Plasteel</b> which you can sell for <b class='hl-yellow font-bold'>credits</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:77,completion:{type:"INFO"},nextStepId:"mission_1_5",isSkippable:!1},{stepId:"mission_1_5",text:"This mission must be completed on the <b>Moon</b>, but you are presently docked at <b>Mars</b>! Therefore, it's time for the maiden voyage of your new ship, the <b>{shipName}</b>!<br><br>On the <b>nav bar</b> at the top, select the <b>Ship</b> tab, then the <b>Navigation</b> tab.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:27,completion:{type:"SCREEN_LOAD",screenId:"navigation"},nextStepId:"mission_1_6",isSkippable:!1,navLock:{navId:H.SHIP,screenId:"navigation"}},{stepId:"mission_1_6",text:"From here you can travel to other stations in the system. This will cost you <b>time</b>, <b class='hl-blue'>fuel</b>, and wear on the <b class='hl-green'>hull</b> of your ship.<br><br>Select the <b>Moon</b> to lift off from <b>Mars</b>.",size:{width:"400px",height:"170px"},anchorElement:"body",positionX:50,positionY:83,completion:{type:"ACTION",action:"travel"},nextStepId:"mission_1_7",isSkippable:!1,navLock:{navId:H.SHIP,screenId:"navigation",enabledElementQuery:"[data-location-id='loc_luna']"}},{stepId:"mission_1_7",text:"You've arrived and docked at the <b>Moon</b> station!<br><br>It's time to deliver the <b>Plasteel</b>. Select the active mission and <b>deliver the Plasteel</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:82,completion:{type:"ACTION",action:"complete-mission"},nextStepId:"mission_1_8",isSkippable:!1,navLock:{navId:H.DATA,screenId:"missions"}},{stepId:"mission_1_8",text:"Mission complete!<br><br>However, favors don't pay off <b class='hl-yellow font-bold'>Guild</b> loans. You're going to need more <b class='hl-yellow font-bold'>credits</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:25,completion:{type:"INFO"},nextStepId:"mission_2_1",isSkippable:!1},{stepId:"mission_2_1",text:"The <i>best way to make money</i> is to play the markets yourself by <b class='hl-green font-bold'>buying low and selling high</b>.<br><br>Select the <b>Starport</b> tab, then the <b>Market</b> tab.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:25,completion:{type:"SCREEN_LOAD",screenId:"market"},nextStepId:"mission_2_2",isSkippable:!1,navLock:{navId:H.STARPORT,screenId:"market"}},{stepId:"mission_2_2",text:"This is the <b>Moon Market</b>.<br>On each commodity you will find a wealth of information to aid your trading.<br><br>The <b class='hl-green font-bold'>MKT</b> indicator will inform you of <b class='hl-green font-bold'>prices higher or lower than average.</b> Selecting the price will reveal past performance.<br><br>Select the <b class='hl-yellow font-bold'>Buy/Sell toggle</b> to transition to sale mode, and then sell your single unit of <b>Plasteel</b>.",size:{width:"400px",height:"150px"},anchorElement:"body",positionX:50,positionY:67,completion:{type:"ACTION",action:"sell-item",goodId:"plasteel"},nextStepId:"mission_2_3",isSkippable:!1},{stepId:"mission_2_3",text:"<b class='hl-green font-bold'>Pure profit</b>!<br><br>However, you still need more <b class='hl-yellow font-bold'>credits</b>! Return to the <b>Mission Terminal</b> by selecting the <b>Data</b> tab.",size:{width:"400px",height:"150px"},anchorElement:"body",positionX:50,positionY:67,completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_4",isSkippable:!1,navLock:{navId:H.DATA,screenId:"missions"}},{stepId:"mission_2_4",text:"This mission offers a <b class='hl-yellow font-bold'>credit</b> reward.<br><br>Accept the mission, <b>Martian Resupply</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:77,completion:{type:"ACTION",action:"accept-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_3_1",isSkippable:!1},{stepId:"mission_3_1",text:"To complete this mission you will need to <b>travel to Mars</b> after you have purchased <b>two Plasteel</b> from any <b>Market</b>.<br><br>After you have acquired the <b>Plasteel</b>, visit the <b>Mission</b> tab on <b>Mars</b> to submit the cargo and complete the mission. ",size:{width:"400px",height:"160px"},anchorElement:"body",positionX:50,positionY:83,completion:{type:"ACTION",action:"complete-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_final",isSkippable:!1,navLock:null},{stepId:"mission_final",text:"Well done Captain {playerName}, you have successfully completed trades across the <b>Moon</b> and <b>Mars</b>.<br><br>Continue to trade commodities for <b class='hl-green font-bold'>favorable margins</b> and complete missions to unlock additional opportunities.<br><br><b>The Solar System awaits</b>!",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:29,completion:{type:"INFO"},nextStepId:null,isSkippable:!1,buttonText:"Complete Tutorial",navLock:null}]}};var D={Starter:null,"Mission (TBD)":null,Moon:I.LUNA,Earth:I.EARTH,Mars:I.MARS,Venus:I.VENUS,Neptune:I.NEPTUNE,Jupiter:I.JUPITER,"The Belt":I.BELT,Pluto:I.PLUTO,Saturn:I.SATURN,Uranus:I.URANUS,"Kepler's Eye":I.KEPLER,"The Exchange":I.EXCHANGE},et={"Wanderer.Ship":{name:"Wanderer",class:"C",price:25e3,maxHealth:30,cargoCapacity:30,maxFuel:150,role:"Explorer",attribute:"None",description:"Its oversized fuel tank betrays its past as a survey ship, built for pilots who value the range over all else. ",lore:`The Wanderer is a vessel born from the fine print of a corporate bankruptcy. Its chassis belongs to the ""Surveyor's Friend"" line, a failed venture by a minor Martian corp that attempted to build a cheap, long-range scout for freelance prospectors. The venture folded, and its assets were snapped up by the Merchant's Guild, not for their quality, but for their utility in backing the loans of new, desperate captains. This ship was never celebrated; it was simply requisitioned, its manufacturing plate filed clean and its identifiers reassigned.

Its history is a patchwork of incomplete journeys. The original owner used it to map unlisted asteroid clusters in the Belt before defaulting on a fuel payment. It was then briefly captained by a paranoid journalist tracking rumors of Venetian Syndicate activity, who abandoned it on Luna after a close call, wiping the nav logs clean. Its call-sign, ""Wanderer,"" isn't a factory name but a nickname given by Guild dockworkers, who noted it never seemed to keep an owner for long.

It's low cargo and thin hull are secondary to its one redeeming feature: a surprisingly robust fuel tank, a remnant of its original survey design.

Inside, the ship is spartan. The cockpit is functional, designed for observation. The single bunk is a fold-down shelf.

The air recyclers hum a half-step flat. It smells of sterilized plastic and the faint, metallic tang of ozone.

The Wanderer is the quintessential first step into the void. It\u2019s not a ship that promises riches or glory; it's a ship that promises distance. It was built to see what's over the horizon, and for a new captain, that is the only promise that matters.

It is the very definition of freedom: a hull, an engine, and just enough range to disappear.`,saleLocationId:D.Starter,spawnChance:1,spawnTrigger:"New game only",isRare:!1,mechanicIds:[]},"Stalwart.Ship":{name:"Stalwart",class:"C",price:25e3,maxHealth:70,cargoCapacity:45,maxFuel:110,role:"Balanced",attribute:"None",description:"It lacks the range of an explorer, but its reinforced hull promises a steady hand through the system's most turbulent trade routes.",lore:`The Stalwart is a product of the Earth-Luna supply chain, a pure workhorse built by a subsidiary of the Terran Alliance.
Its design was never meant to be revolutionary; it was meant to be reliable.
During the Helium Rush, hundreds of these vessels were commissioned as high-priority couriers, running critical components, data cores, and personnel between Earth's orbital factories and the chaotic lunar mining settlements.
They were designed to be tough, capable of handling rapid docking, automated loading, and the occasional debris collision.
This particular hull has a long service record. It was originally part of the corporate fleet for ""Astra-Logistics,"" a mid-level corporation that was eventually squeezed out of the helium trade.
The ship's logs, if you could access the encrypted archives, would show thousands of routine, completed trips.
It has never seen the outer system, never engaged in combat, and never failed to reach its destination.
It is the definition of ""stalwart"": loyal, dependable, and thoroughly unexciting.
The Merchant's Guild acquired this ship, like so many others, during a corporate liquidation.
Its value is not in its potential, but in its proven track record.
Its balanced stats\u2014a tough hull, a respectable cargo bay, and adequate fuel\u2014make it a low-risk asset.
It is the sensible choice, a floating pickup truck for the practical-minded trader.

The ship's interior is worn but clean.
The bulkhead panels are scratched from years of cargo shifting, and the pilot's chair is permanently molded to a shape that isn't yours.
The ship's systems are simple, robust, and easily repaired. There are no luxuries, only redundancies.
Its most prominent feature is its reinforced hull plating, which makes the entire vessel feel solid and secure, a small piece of Earth's reliability in the void.
The Stalwart is a tool for building a business. It\u2019s not a vessel for exploration or high-stakes gambles;
it\u2019s for the captain who intends to navigate the razor's edge of commerce by being smarter, tougher, and more dependable than the competition.
It\u2019s a ship that promises to show up, do the work, and survive to do it again tomorrow.`,saleLocationId:D.Starter,spawnChance:1,spawnTrigger:"New game only",isRare:!1,mechanicIds:[]},"Mule.Ship":{name:"Mule",class:"C",price:25e3,maxHealth:45,cargoCapacity:70,maxFuel:90,role:"Hauler",attribute:"None",description:"Little more than a cockpit bolted to a high-capacity cargo container, this ship was designed for slow but profitable journeys between orbital stations, one ton at a time.",lore:`The Mule is less a starship and more a cargo container with an engine and a cockpit welded to the side as an afterthought.
It is a product of the Drive-Divide, a ship built for those who have no choice but to use the cheapest hardware available.
Its design was mass-produced in the orbital yards of Mars, intended for ""last-mile"" hauling\u2014moving raw, unprocessed ore from massive deep-space freighters to the planetary surface or between nearby stations.
Its history is one of heavy loads and short tempers.
The ""Mule"" line is notorious among pilots for being loud, uncomfortable, and slow.
Its low-grade engine vibrates through the entire hull, and its fuel capacity is barely enough to get from a high-orbit anchor to a docking bay and back.
Its only purpose, its only virtue, is the cavernous, un-shielded cargo bay that makes up over 80% of its mass.
This ship was likely repossessed by the Merchant's Guild after its previous owner, a small-time scrap hauler, was crushed by the manipulated market prices of the Venetian Syndicate.
The ship sat in a Guild impound lot, its only value being the raw tonnage it could move.
It is the perfect, high-risk, high-reward asset for a captain who is willing to sacrifice everything\u2014comfort, safety, and speed\u2014to maximize their manifests.
The cockpit is a cramped metal box that smells of ozone, artificial lubricant, and stale coffee.
The hull is thin, and every micrometeorite impact sounds like a gunshot.
The ship shudders violently when the main drive engages. It is a vessel that constantly reminds its pilot that the void is waiting just outside a few inches of cheap alloy.
This is the ship for the pure trader. You don't buy a Mule to see the system or to outrun pirates.
You buy it for the cold, hard calculus of its cargo hold.
It is a bet that you can fill it, sell its contents, and earn your way into a better ship before its numerous flaws finally catch up with you.`,saleLocationId:D.Starter,spawnChance:1,spawnTrigger:"New game only",isRare:!1,mechanicIds:[]},"Nomad.Ship":{name:"Nomad",class:"C",price:4e4,maxHealth:40,cargoCapacity:35,maxFuel:150,role:"Explorer",attribute:"None",description:"Its lightweight frame and oversized fuel cells were designed for a single purpose: to keep moving, making it ideal for captains who rarely sleep in the same port twice.",lore:`The Nomad, born from the Helium Rush, is a direct response to the chaos and opportunity of Luna's new economy.
While large corporations focused on mass extraction, a gap emerged for independent prospectors - pilots who could scout new deposits, verify claims, or disappear into the Belt for months at a time.
A small Luna-based shipyard, ""Cis-Lunar Dynamics,"" created the Nomad to fill this niche.
It was one of an endless series of ships that tried to thread the needle of space classism, offering one high-performance feature on an otherwise cheap hull.
In this case, the feature was autonomy. The Nomad boasts a fuel capacity that rivals ships twice its size, achieved by sacrificing almost all crew comforts and cargo space.
It is a ship designed to go far, if not fast or comfortably.
The ship's early models were popular with claim-jumpers and independent surveyors.
They were small enough to avoid appearing as a threat on sensors but had the range to ""go dark"" and operate far from the main shipping lanes.
The name became synonymous with pilots who lived on the fringes, trusting no one but themselves and the reliability of their long-range fuel tanks.
This particular Nomad has likely been hot-swapped multiple times in back-alley docks.
Its transponder codes are clean, but its engine housing has tool marks that suggest hasty, non-standard modifications.
The light hull and modest cargo bay make it an excellent choice for an explorer, a courier, or someone who needs to be somewhere they aren't supposed to be.`,saleLocationId:D.Moon,spawnChance:.4,spawnTrigger:"Always available",isRare:!0,mechanicIds:[]},"Rooster.Ship":{name:"Rooster",class:"C",price:42e3,maxHealth:100,cargoCapacity:65,maxFuel:110,role:"Balanced",attribute:"None",description:"A solid, assertive design from Earth's dominant shipyards, the Rooster is for the captain who wants a ship that can take a hit, carry a decent load, and still look good doing it.",lore:`The Rooster is a pure-bred Terran Alliance design, a ship that exudes the confidence of Earth's clean and advanced manufacturing.
It was not built for the rough-and-tumble life of a freelancer;
it was designed as a high-speed executive shuttle and priority courier for the inner system.
Its purpose was to move high-value personnel and proprietary technology between Earth, Luna, and the orbital stations of the Venus.
The ship's aggressive, forward-swept design and high-performance engine profile earned it the nickname ""Rooster"" among orbital traffic controllers.
It was known for crowing its priority codes, demanding immediate docking clearance as it darted through commercial traffic.
Its solid hull and balanced systems were a mark of its quality, built to protect its valuable cargo and passengers at all costs.
As a balanced ship, it's a master of none but a jack-of-all-trades.
It has enough speed to be interesting, enough armor to be reassuring, and a cargo bay large enough for specialized, high-profit goods.
It's a ship for a captain who wants to maintain a low-level of corporate-style professionalism.
This hull was likely part of a corporate fleet that was cycled out after only a few years of service to make way for a newer model.
On Earth, technology iterates quickly, and yesterday's luxury transport is today's surplus.
It was sold on the open market, its new ship smell barely faded, representing a significant step up for any independent captain.
Owning a Rooster is a sign that a pilot has moved beyond simple survival.
It\u2019s a ship that implies a certain level of success and discretion.
It\u2019s fast, reliable, and just stylish enough to get you noticed by the kinds of clients who pay well for a captain who looks the part.`,saleLocationId:D.Earth,spawnChance:.4,spawnTrigger:"Always available",isRare:!0,mechanicIds:[]},"Mesa.Ship":{name:"Mesa",class:"C",price:44e3,maxHealth:50,cargoCapacity:100,maxFuel:70,role:"Hauler",attribute:"None",description:"A classic Martian-built freighter, it is essentially a flying warehouse designed to move bulk goods between the surface and orbital transfer stations.",lore:`The Mesa is a Martian workhorse, as blunt and functional as the corporate nation-state that built it.
Following the Martian Breakthrough, the new-found independent colony needed its own logistical backbone.
The Mesa was the answer: a mass-produced, low-cost, high-capacity hauler designed to move bulk materials around the red planet's orbit.
It is named for the flat, wide, and unglamorous geological formations that dot its homeworld.
This ship was built for one job: to move as much mass as possible from Point A to Point B, assuming both points were within the same gravity well.
Its low fuel tank and mediocre hull were cost-saving measures, as it was assumed these ships would always operate under the protection of Martian corporate security, running goods from orbital foundries to interplanetary transfer stations.
The design is utilitarian to a fault. The cockpit is a reinforced box with a viewport.
The engine is the cheapest model that could reliably push its maximum cargo load.
The ship's entire philosophy is built around its cavernous, easily-accessible cargo bay.
It is the very definition of a cog in the great machine of commerce.
These vessels are now common on the Martian second-hand market.
As the larger corporations upgrade to more efficient haulers, the older Mesas are sold off to independent captains and smaller outfits.
They are a common first ""pure hauler"" for traders looking to capitalize on the high-volume needs of the Martian industrial machine.
To pilot a Mesa is to embrace a life of pure profit-driven logistics.
It\u2019s a slow, lumbering beast that handles like a brick, but its ability to haul cargo makes it one of the most profitable ships in its class.
It is a tool for the captain who studies manifests, not star charts.`,saleLocationId:D.Mars,spawnChance:.4,spawnTrigger:"Always available",isRare:!0,mechanicIds:[]},"Pathfinder.Ship":{name:"Pathfinder",class:"B",price:145e3,maxHealth:40,cargoCapacity:50,maxFuel:260,role:"Explorer",attribute:"None",description:"Commissioned in the private yards of Venus, this ship was built for quiet observation and rapid departure, favoring a cold-running engine over a thick hull.",lore:`The Pathfinder is a ship with a shrouded past, intrinsically linked to the opulent and clandestine circles of its home port.
It was not built by a major corporation but was commissioned by a private equity group operating from Venus\u2014a known front for the Venetian Syndicate.
Its design purpose was not exploration in the scientific sense, but surveillance.
It was created to be a high-end ghost for the Syndicate's intelligence networks.
The ship's true value lies in its advanced, non-standard sensor suite and its high-efficiency drive, which runs colder than most military vessels, making it difficult to track.
Its high fuel capacity allows it to sit ""dark"" in a distant orbit for weeks, monitoring comms traffic or tracking the movement of a rival's cargo.
The modest cargo bay was designed not for commodities, but for transporting compromising data, high-value assets, or a single, well-paid infiltrator.
The Pathfinder line is rarely seen on the open market.
When one does appear, it's usually because its previous owner met an unfortunate end or needed to disappear, liquidating their assets through a discreet broker.
The ship has been scrubbed of its most illicit hardware, but its core strengths remain.
Its light hull is a liability, but the ship was never intended to be in harm's way.
Purchasing a Pathfinder is a significant investment. Captains who buy them are often those who understand that in the cold war fought with cargo manifests, information is the most valuable commodity.
It\u2019s a ship for a pilot who prefers to know the location of the next deal before they ever engage the drive.`,saleLocationId:D.Venus,spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Odyssey.Ship":{name:"Odyssey",class:"B",price:15e4,maxHealth:120,cargoCapacity:110,maxFuel:120,role:"Balanced",attribute:"None",description:"More fortress than freighter, this is a rugged, dependable vessel for the captain who expects trouble and intends to survive it.",lore:`The Odyssey is a direct descendant of the ships that defined the Helium Rush.
As Luna's economy boomed, the need arose for a vessel that could do more than just haul or scout;
a ship was needed to protect the new trade lanes, move valuable assets securely, and ferry executives between Earth and the increasingly wealthy lunar settlements.
The Odyssey was the answer: a high-end, balanced ship with an emphasis on durability.
Its most defining feature is its hull, which is massively over-spec'd for a ship of its size.
This toughness made it a favorite among private security contractors and Guild-sanctioned convoy leaders.
It was a ship that could take a hit\u2014or several\u2014and keep its cargo and crew intact.
Its name, ""Odyssey,"" was a marketing ploy, suggesting a vessel capable of surviving a long, perilous, and ultimately heroic journey.
The ship is a status symbol on the Moon. While a C-class ship gets you into the trade, an Odyssey proves you're successful enough to afford protection and professional enough to be taken seriously.
Its balanced profile makes it a true all-rounder, capable of hauling a respectable load, exploring a new route, or running a high-risk delivery.
This particular craft has been well-maintained, its armor patched and its engine serviced regularly.
The interior is professional and clean, with a small but secure brig and a dedicated, shielded strongbox for high-value goods, betraying its past in corporate security.
This is a ship for the captain who has graduated from desperation to ambition, a solid, reliable, and powerful tool for taking on more dangerous and lucrative contracts across the system.`,saleLocationId:D.Moon,spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Pilgrim.Ship":{name:"Pilgrim",class:"B",price:15e4,maxHealth:60,cargoCapacity:175,maxFuel:90,role:"Hauler",attribute:"None",description:"A specialized ice-hauler, this ship sacrifices armor and speed for a massive, reinforced cargo bay, making it a pure-profit engine for the patient trader.",lore:`The Pilgrim is a ship built for the lonely, far-flung edges of the system.
Manufactured in the cold, automated shipyards of Neptune's moons, it was designed for a single purpose: to service the fledgling outposts, ice-mining operations, and deep-space observatories of the outer planets.
Its namesake is a term for the contract-haulers who made the pilgrimage from the inner system, a journey that could take months.
This ship is the very definition of a long-haul freighter. Its design philosophy is simple: maximize cargo at all costs.
To achieve this, its designers made deep cuts to its fuel capacity and hull assuming that the vast emptiness of the outer system was its own defense.
Pilgrims are not fast, nor are they tough; they are simply large.
The ship's interior is minimal but built for long-duration trips.
The life support system is oversized and heavily redundant, and the small crew cabin features a robust nutrient synthesizer and water recycler.
Pilots of these ships are known for their patience and meticulous planning, as running out of fuel this far out is a death sentence.
Finding one for sale on Neptune is common, as they are the backbone of the local economy.
They are often sold by captains who have either made their fortune and are retiring, or by the estates of those who miscalculated a fuel burn and never returned.
It's a ship that represents a massive gamble on the cold, impartial logic of the manifest.
To captain a Pilgrim is to commit to a life of high-stakes logistics.
It\u2019s a specialized tool for the trader who intends to profit from the system's most distant and demanding routes, where the only things that matter are the cargo capacity and the long, silent countdown to arrival.`,saleLocationId:D.Neptune,spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Meridian.Ship":{name:"Meridian",class:"B",price:155e3,maxHealth:100,cargoCapacity:70,maxFuel:230,role:"Explorer",attribute:"None",description:"With a massive fuel reserve and a robust sensor array, the Meridian is a self-sufficient explorer, capable of operating for months in the uncharted deep.",lore:`The Meridian is a product of Jupiter's massive, corporate-run industrial machine.
It was designed as a high-endurance survey and exploration vessel for the Jovian Mining Consortium, a powerful corporate state that is constantly seeking to expand its resource claims.
The name ""Meridian"" refers to its purpose: to chart new boundaries and map the vast, resource-rich, and dangerous territory of Jupiter's moons.
This ship is a direct answer to the Pathfinder. Where the Pathfinder is a light, stealthy spy, the Meridian is a robust, self-sufficient, corporate-backed explorer.
Its impressive fuel tank allows for long-duration missions without refueling, and its robust hull and cargo bay mean it can withstand punishment, conduct its own mining surveys, and bring back valuable samples.
The Meridian is a symbol of corporate reach. Its engines are powerful, its sensors are top-of-the-line, and its hull is stamped with the mark of Jupiter's finest shipyards.
These ships are often the first to enter a new asteroid field or a previously uncharted gas cloud, their logs filled with proprietary survey data worth a fortune.
This vessel was likely sold on the open market after being retired from a corporate fleet, not because of a flaw, but because it had been superseded by a newer model.
Its service history is classified, but its performance is undeniable.
It's a ship for a captain who wants to take on serious, high-paying contracts.
Owning a Meridian signifies that a pilot has crossed the line from freelancer to professional.
It's a serious ship for serious work, capable of opening up new routes and discovering the resources that fuel the entire system-wide technological dependency.`,saleLocationId:D.Jupiter,spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Raven.Ship":{name:"Raven",class:"B",price:16e4,maxHealth:210,cargoCapacity:80,maxFuel:110,role:"Balanced",attribute:"None",description:"A common sight in the lawless asteroid fields, this ship is a tough-as-nails workhorse for the captain who values armor above all else.",lore:`The Raven is a ship born of necessity in the lawless expanse of the Asteroid Belt.
It is not a product of a single, polished shipyard, but a popular, rugged design built by a dozen different independent fabricators within the Asteroid Belt.
Its design is a direct response to the region's primary dangers: catastrophic debris impacts.
The ship's most notable feature is its armor. With an impressive hull rating, it is one of the toughest ships in its class.
Its name comes from its appearance: the thick, dark, non-reflective armor plating, often patched and re-welded, gives it the look of a dark, menacing bird.
Ravens are the preferred ships of Belt-based security patrols and traders who have to haul valuable, unrefined ore.
Its fuel and cargo capacity are substantial, making it a truly independent operator.
This particular ship is a typical Belter vessel. The hull is a patchwork of different plate dented by micrometeorites.
The interior is purely functional with little crew comforts. The air smells of recycled oxygen and the faint, coppery tang of spent energy cells.
Buying a Raven in The Belt is an admission that you are operating in a place where law is a distant concept.
It's a ship for the captain who has embraced danger and decided that the best defense is a hull that simply refuses to break.`,saleLocationId:D["The Belt"],spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Warden.Ship":{name:"Warden",class:"B",price:165e3,maxHealth:70,cargoCapacity:160,maxFuel:160,role:"Hauler",attribute:"None",description:"Built in the subterranean yards of Pluto, this ship's specialty is the extreme long-haul, where reliability and cargo size are the only stats that matter.",lore:`The Warden is a ship built for the most extreme logistics in the solar system.
Typically operating from Pluto, a cold, dark, and unimaginably distant port, this vessel was designed to be a keeper of cargo on the longest, loneliest routes imaginable.
It is a hauler that borders on being a light capital ship, a warden against the three great threats of the deep void: time, distance, and decay.
Its primary feature is its enormous cargo capacity, a hold designed to make the multi-month trips from the Kuiper Belt profitable.
Unlike the Pilgrim, which is a bulk hauler, the Warden has a more balanced design.
Its solid hull and decent fuel tank make it more self-sufficient, capable of surviving a long, dark journey where rescue is impossible.
These ships are manufactured in the deep, pressurized shipyards beneath Pluto's surface.
They are built to be utterly reliable as any major failure this far out is fatal.
The Warden's captains are a unique breed, part-trader, part-hermit, who sign on for journeys that can last the better part of a year.
The ship itself is slow and ponderous, its movements dictated by the cold calculus of orbital mechanics and fuel conservation.
The interior is spacious, like a small habitat rather than a cockpit.
Its systems are designed for minimal power draw, and its engine is a low-temperature, high-efficiency model that can run for years without maintenance.
A Warden for sale on Pluto is a rare and serious purchase.
It is the key to some of the system's most dangerous and most profitable long-haul routes.
It is a ship for the captain who has transcended the cold trade wars of the inner system and chosen to do business with the unforgiving void itself.`,saleLocationId:D.Pluto,spawnChance:.3,spawnTrigger:"Tier 3 Unlock",isRare:!0,mechanicIds:[]},"Aegis.Ship":{name:"Aegis",class:"A",price:59e4,maxHealth:200,cargoCapacity:100,maxFuel:300,role:"Explorer",attribute:"None",description:"This vessel's massive fuel reserves and fortified engineering deck are a masterpiece of Martian design, intended for captains who plan to be the first to arrive and the last to leave.",lore:`The Aegis is the pinnacle of Martian corporate engineering, a vessel designed not just to explore, but to dominate an exploration sector.
It is the flagship of the ""Aegis"" line, a project born from the Martian state's desire to achieve technological independence from Earth .
The ship represents a massive investment, a clear signal that Mars is no longer just a colony, but a system power in its own right.
Its name, ""Aegis,"" means ""shield,"" and it was designed to be the shield of Martian interests\u2014a self-sufficient, long-range expeditionary vessel.
Its design philosophy is one of overwhelming endurance. A massive fuel capacity is paired with a robust hull, allowing it to operate independently for extreme durations in dangerous, uncharted territory.
This is not a ship for casual scouting; it is a ship for high-stakes missions.
Its advanced sensor suites are rumored to be capable of detecting high-performance folded-space drive activations at extreme range, a direct counter to the Venetian Syndicate's stealth vessels.
The cargo bay is not intended for bulk trade, but for hauling modular equipment, scientific labs, or high-yield resource samples.
This vessel's appearance on the Martian open market is an extremely rare event.
It is likely a surplus model from a previous procurement contract, sold to a highly-vetted buyer to recoup costs.
Its systems are top-tier, and its engine is a masterpiece of Martian efficiency. The interior is military-grade but spacious.
To acquire an Aegis is to purchase a piece of corporate-military hardware.
It is a ship that tells the system you are no longer just a trader;
you are a serious operator, capable of undertaking the most demanding, long-term contracts that the Merchant's Guild or a corporate state can offer.`,saleLocationId:D.Mars,spawnChance:.2,spawnTrigger:"Tier 4 Unlock",isRare:!0,mechanicIds:[]},"Forerunner.Ship":{name:"Forerunner",class:"A",price:6e5,maxHealth:290,cargoCapacity:160,maxFuel:150,role:"Balanced",attribute:"None",description:"A fortress of composite plate and reinforced steel, its design is a brutalist statement on survival in the system's most lawless territory.",lore:`The Forerunner is a legend of the Belt, a ship that has earned a reputation for being the toughest, meanest, and most survivable vessel outside of a capital ship.
It is not the product of a clean corporate shipyard;
it is an up-armored brawler, a design that has been iterated upon in the independent, often illicit, fabrication bays of the asteroid fields.
Its origin is a direct response to the cold trade war of commerce.
The Forerunner's stats tell a story of brutal priorities. Its hull is its most prominent feature, a massive layer of ablative and composite armor designed to withstand excessive punishment.
This protection is balanced with a powerful engine and a large cargo bay, creating a ship that can run a high-value, high-risk routes for months without maintenance.
Its name, ""Forerunner,"" is a title of respect given by Belter miners.
A Forerunner is often the first ship into a hot new asteroid claim before the area is scrubbed of minor debris.
It is the chosen vessel of convoy leaders, Guild enforcers, and the most successful traders in the outer system.
This particular ship is scarred from bow to stern. Its armor is a patchwork of replacements and its transponder has been erased more than once.
The interior is cramped, sacrificing crew comfort for storage and reinforced bulkheads.
To buy a Forerunner is to buy a reputation. It is a ship that sends a clear message in every port it visits: Do not interfere.
It is the ultimate tool for the captain who must navigate the most dangerous trade lanes and is willing to brute force their way through any asteroid field to ensure their cargo\u2014and their life\u2014reaches its destination.`,saleLocationId:D["The Belt"],spawnChance:.2,spawnTrigger:"Tier 4 Unlock",isRare:!0,mechanicIds:[]},"Guardian.Ship":{name:"Guardian",class:"A",price:59e4,maxHealth:130,cargoCapacity:230,maxFuel:165,role:"Hauler",attribute:"None",description:`The pride of Saturn's merchant fleet, this ""merchant cruiser"" was designed to haul and protect vast fortunes of refined ring-ice and exotic gases.`,lore:`The Guardian is the pride of Saturn's ring-cities, a merchant cruiser that represents the pinnacle of defensible commerce.
Manufactured in the zero-G shipyards of Titan, it was designed for the powerful merchant houses of the Saturn system, who needed to move vast quantities of high-value goods (like refined Helium-3 or exotic atmospheric compounds) over long, exposed routes.
It is a hauler that redefines the term, blending capacity with fortitude.
Its design is a direct rejection of the cheap hauler philosophy.
The Guardian boasts a colossal cargo capacity but, unlike its peers, it does not sacrifice defense.
A respectable hull and a solid fuel tank make it a formidable vessel.
Its name is a statement of intent: it does not just carry cargo; it protects it.
These ships are the backbone of the interstellar supply lines that prop up the corporate states.
They are often seen running in small, self-sufficient convoys, their hulls gleaming with the insignia of Saturn's powerful corporations.
They are a status symbol, a sign that a trading house has so much wealth that it can afford to protect it with the best ships money can buy.
This particular Guardian was likely the flagship of a successful independent merchant.
Its cargo bay is immaculate, with high-security locks, biometric scanners, and independent stasis fields for volatile goods.
The cockpit is professional, with redundant navigation and communication systems designed for coordinating with an escort.
Owning a Guardian is a sign that a captain has reached the big leagues.
It is a ship for the merchant prince, a pilot who no longer deals in scraps and single contracts, but in massive, long-term manifests that are the lifeblood of the entire system.`,saleLocationId:D.Saturn,spawnChance:.2,spawnTrigger:"Tier 4 Unlock",isRare:!0,mechanicIds:[]},"Valiant.Ship":{name:"Valiant",class:"A",price:58e4,maxHealth:100,cargoCapacity:125,maxFuel:375,role:"Explorer",attribute:"None",description:"A marvel of Jovian engineering, this elite explorer was built for missions of extreme duration, carrying enough fuel to cross the system and back.",lore:`The Valiant is the apex predator of the exploration class, a ship that embodies the limitless ambition of the Jovian corporate state.
While the Meridian was built to chart Jupiter's territory, the Valiant was built to conquer it.
It is an extreme long-range, high-performance explorer, created for only the most elite corporate-sponsored expeditionary captains.
Its purpose: to operate for unheard-of durations, far from any support, in the most hostile environments the system has to offer.
This ship is an engineering marvel, defined by its staggering fuel capacity.
This endurance is paired with a strong hull and a versatile cargo bay, making it utterly self-sufficient.
It doesn't just visit a new sector; it moves in.

The Valiant line is almost never for sale.
They are mission-critical assets for the Jovian consortium. Their sensor logs and nav charts are some of the most closely-guarded secrets in the system.
The name itself is a piece of corporate propaganda, meant to inspire tales of heroic, ""valiant"" explorers pushing the boundaries of human space\u2014all in the name of the corporation.
This ship is pristine, its systems far in advance of standard military tech.
To pilot a Valiant is to be at the absolute pinnacle of the class and adventure.`,saleLocationId:D.Jupiter,spawnChance:.2,spawnTrigger:"Tier 5 Unlock",isRare:!0,mechanicIds:[]},"Eagle.Ship":{name:"Eagle",class:"A",price:63e4,maxHealth:210,cargoCapacity:200,maxFuel:220,role:"Balanced",attribute:"None",description:"The pinnacle of Terran design, this ship is a perfect harmony of power, protection, and performance\u2014a master-of-all-trades for the truly elite captain.",lore:`The Eagle is the physical expression of the Terran Alliance's technological and economic superiority.
It is not merely a ship; it's a symbol of Earth's advanced manufacturing .
While other corps build brutalist brawlers or spartan haulers, Earth builds the Eagle: a sleek, powerful, and perfectly balanced vessel that is as much a work of art as it is a tool of commerce.
Its design is one of total harmony. A powerful, high-efficiency engine is paired with a thick advanced alloy hull and a substantial, automated cargo bay.
It is the perfect ship for the independent captain, a master-of-all-trades that compromises on nothing.
It can explore, it can fight, it can haul\u2014and it does all three with an elegance that is unmistakably Terran.
The Eagle is named for the ancient bird of prey, a symbol of power and vision.
These ships are favored by the Merchant's Guild for their personal transports, by elite Terran diplomats, and by the wealthiest freelance captains.
Its high-performance parts are sourced directly from Earth.

Finding an Eagle for sale on Earth is a privilege.
They are sold only through exclusive Terran shipyards to captains with a spotless reputation and a massive bank account.
The interior is luxurious, the controls are seamless, and the ship's integrated AI  is sophisticated, if not truly sentient.
To own an Eagle is to have obtained the ultimate status symbol for a freelance captain, a ship that grants access to exclusive markets and the respect of the system's greatest powers.
It is fast, tough, beautiful, and a testament to success.`,saleLocationId:D.Earth,spawnChance:.2,spawnTrigger:"Tier 5 Unlock",isRare:!0,mechanicIds:[]},"Tundra.Ship":{name:"Tundra",class:"A",price:62e4,maxHealth:100,cargoCapacity:330,maxFuel:170,role:"Hauler",attribute:"None",description:"A true super-freighter from the Neptune yards, this ship is little more than a powerful engine and a cockpit bolted to a cargo hold of truly colossal proportions.",lore:`The Tundra is the final word in interplanetary logistics, a colossal hauler built in the deep, cold shipyards of Neptune.
If the Pilgrim and Warden are the system's long-haul trucks, the Tundra is its supertanker.
It was designed by a consortium of outer-system corporations who needed a way to move truly staggering quantities of raw materials\u2014ice, methane, and rare minerals\u2014from the Kuiper Belt to the inner system.
This ship is defined by its cargo capacity, a cavernous maw that dwarfs almost every other vessel.
To make this possible, the ship is built around a massive, reinforced structural spine, with the cargo pods, engine, and cockpit bolted on as modular components.
It is less a ship and more a ""cargo-engine,"" a minimalist design that is brutally efficient.
The Tundra's name reflects its operating environment: it is vast, cold, and unforgiving.
Its hull is just thick enough to withstand the stresses of its own mass and the dangers of navigating icy, uncharted asteroid fields.
Its fuel tank is massive, giving it the endurance needed for the months-long, slow-burn trajectories that define its trade routes.
These ships are the titans of the interstellar supply lines.
A single, fully-laden Tundra can represent a significant percentage of a smaller corporate state's quarterly resources.
Their captains are master logisticians, more concerned with fuel-to-mass ratios and orbital mechanics than with docking gossip.
To see a Tundra for sale on Neptune is to see an opportunity of immense scale.
These ships are rarely decommissioned; they are simply too valuable.
This is a ship for the captain who is ready to move beyond a mere cargo manifest and start thinking in terms of global economic influence.`,saleLocationId:D.Neptune,spawnChance:.2,spawnTrigger:"Tier 5 Unlock",isRare:!0,mechanicIds:[]},"Atlas.Ship":{name:"Atlas",class:"S",price:185e4,maxHealth:180,cargoCapacity:240,maxFuel:425,role:"Explorer",attribute:"None",description:"Rumored to be the only ship that truly loves the journey, its experimental systems seem to thrive on the stress of travel, mending its own hull and generating fuel over time.",lore:`The Atlas is a ship of myths, a vessel that has transcended its origins to become a legend among freelance captains.
It was not built by a single corporation but was a secret project by a collective of disgruntled, genius-level engineers from the shipyards of Saturn and Jupiter.
They were tired of the Ship-Divide and the planned obsolescence of corporate hardware.
Their goal was to build a ""forever ship,"" a vessel that could truly bear the weight of the heavens on its shoulders.
They pooled their resources and requisitioned proprietary components, including a one-of-a-kind, self-calibrating folded-space drive.
The ship's most remarkable feature is an experimental, non-standard energy core linked to the drive.
Every time the ship pierces spacetime, the core builds a resonant charge, and on the 20th cycle, it purges this energy, flash-repairing the hull's micro-fractures and re-ionizing the fuel supply.
It is a ship that heals itself with travel.

The prototype was a staggering success, far exceeding its designers' expectations.
It became a ship that could truly wander indefinitely. Its massive fuel tank and robust hull are secondary to its unique core.
The original Atlas vanished into the void, rumored to be piloted by its creators on a one-way trip to the stars.
The blueprints were thought lost, but they eventually surfaced, sold by a shadowy broker on Saturn.
Now, a handful of these vessels are painstakingly recreated by a master shipwright who caters to the system's wealthiest clientele.
To own an Atlas is to own a piece of engineering folklore.
It is a ship for the true explorer, the captain who feels the pull of the Solar Boundary and wishes to see what lies beyond.
It is less a tool of commerce and more a philosophical statement: a vessel that travels endlessly.`,saleLocationId:D.Saturn,spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Vindicator.Ship":{name:"Vindicator",class:"S",price:12e5,maxHealth:400,cargoCapacity:240,maxFuel:255,role:"Balanced",attribute:"None",description:"With a hull built for brawling and a cargo bay built for skimming, this ship is for the captain who believes a good deal is one you make for yourself.",lore:`The Vindicator is a ship with a reputation.
It is manufactured in the isolated, automated dockyards of Uranus, a port known for its loose regulations.
The ship's design was commissioned by a powerful, semi-legitimate trading consortium that specialized in aggressive procurement.
Its core design is that of a balanced heavy freighter, with a powerful engine and a truly formidable hull.
It is, in essence, a blockade runner and a privateer's vessel, designed to force its way into a market, secure a deal, and force its way back out.
Its very presence is an act of intimidation, a vindication of its owner's right to trade, by any means necessary.
The ship's unique attribute is a series of hidden, illegal subsystems.
It includes high-speed cargo slicers for automated loading docks, ghost-loaders that add extra, un-logged containers, and sophisticated AI-driven rounding errors for digital manifests.
It is a ship built to cheat the system, an infamous tool for navigating market manipulation.
These ships are the terror of the outer-system trade routes.
The Merchant's Guild publicly decries their use, but many illicit traders are rumored to use them for their most deniable operations.
A Vindicator is not just a ship; it is a license to steal, provided you are smart enough not to get caught.
Purchasing a Vindicator is a massive investment and a dangerous statement.
It tells the system you are a sneaky player in the economic game, and you are not above tipping the scales in your favor.
It is the perfect ship for the ruthless captain for whom wealth is not just a motto, but an absolute.`,saleLocationId:D.Uranus,spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Radiant.Ship":{name:"Radiant",class:"S",price:175e4,maxHealth:170,cargoCapacity:380,maxFuel:280,role:"Hauler",attribute:"None",description:"A high-speed courier from Kepler's Eye, this ship's stasis-equipped hold is designed to move volatile prototypes and fresh discoveries at maximum velocity.",lore:`The Radiant is the ultimate expression of the just-in-time economy, a high-performance hauler built for speed and priority.
It is manufactured exclusively at Kepler's Eye, the system's most advanced scientific and technological outpost, a place where new discoveries and volatile prototypes are created daily.
These high-value items often have a short shelf-life, requiring immediate, rapid transport to clients in the inner system.
The Radiant was designed to meet this need. It is a hauler with a massive cargo bay that thinks it's an explorer, boasting a high-performance engine and a specialized, stasis-equipped cargo bay.
Its name, Radiant, refers to the bright, fleeting glow of its high-velocity engine burn, as well as the high-energy, often radioactive, prototypes it was designed to carry.
Its cargo holds are equipped with advanced temporal stabilizers and status-monitors, which preserve the freshness of volatile goods, from rare isotopes to cloned organs.
This guarantees a premium price for cargo that is delivered quickly, rewarding the captain for speed and efficiency.
These ships are the prized possession of the system's most elite couriers.
They are the only vessels trusted to move new artifacts or newly-synthesized compounds.
A Radiant streaking across the system is a common sight for astronomers, a hot delivery that is likely worth more than a C-class station.
To own a Radiant is to be in the business of speed.
It is a ship for the captain who understands that in the 22nd century, the razor's edge is not just about what you carry, but how fast you carry it.
It is the perfect tool for the get-it-there-yesterday contracts that pay a fortune.`,saleLocationId:D["Kepler's Eye"],spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Aesudon.Ship":{name:"Aesudon",class:"S",price:17e5,maxHealth:250,cargoCapacity:200,maxFuel:465,role:"Explorer",attribute:"None",description:"Its unique hull composition is a fanatical study in endurance, designed to shrug off the slow decay of time and travel.",lore:`The Aesudon is a ship built by paranoia.
Its blueprints were not drafted by a corporation, but by a reclusive, trillion-credit heir on Pluto who was convinced the system was doomed to a slow, entropic death.
This heir spent their entire fortune on a single goal: to build a vessel that could simply outlast the apocalypse, a personal ark that could drift in the void for a countless years.
This ship's construction is a legend of the Pluto shipyards where construction on the vessel lasted decades.
Its hull is not a standard alloy, but a laminated composite of exotic, deep-space materials, layered and pressure-treated to be uniquely resistant to the micro-fractures and stresses of long-term void exposure.
It takes on wear slower than any other ship, not because it is alien, but because it was obsessively, fanatically over-engineered.
Aesudon's massive fuel tanks were designed to be filled once, allowing it to coast on a single burn for a years.
The original owner, upon its completion, provisioned the vessel, boarded it, and was last seen heading for the Kuiper Belt.
They were never heard from again. The ship, however, reappeared fifty years later, its transponder dark, its fuel tanks still half-full, and its log wiped.
It was recovered by a Merchant's Guild patrol and brought to Pluto, a ghost ship whose resilience is proven.
It is a ship built for any long, quiet, and lonely journey.
Its internal systems are spartan but redundant on a scale that borders on the insane, with triple-backups for every core function.
To acquire the Aesudon is to buy a masterpiece of engineering.
It is a ship for the captain who trusts no one and nothing but the integrity of their own hull, a vessel designed to endure when all others have turned to dust.`,saleLocationId:D.Pluto,spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Pterodactyl.Ship":{name:"Pterodactyl",class:"S",price:197e4,maxHealth:300,cargoCapacity:230,maxFuel:295,role:"Balanced",attribute:"None",description:"The flamboyant, winged flagship of the Venetian Syndicate's elite, this ship is rumored to be blessed, finding fortune and profit in the system's chaos.",lore:`The Pterodactyl is the personal transport of the Venetian Syndicate's most audacious and successful members.
Manufactured in the opulent, private orbital estates of Venus, its design is intentionally flamboyant, aggressive, and ostentatious.
Its wings, which house the main thrusters, give it a unique, reptilian silhouette, earning it the name Pterodactyl.
This ship is a pure expression of ambition. It is a high-performance machine for high-stakes players.
Its powerful engine and massive hull make it a formidable opponent in any situation, a ship that can get into and out of trouble with equal ease.
The ship's lucky reputation is the talk of the system.
It is not luck, but a suite of the most advanced probability-analysis and social-engineering software in existence.
This special core runs constant, subtle simulations, predicting and manipulating outcomes.
It suggests the right comms frequency for a random distress call, advises the captain to take a specific route that happens to intercept a high-value derelict, and scrubs Guild records to ensure the credit reward is... generous.
These ships are rarely sold but instead are granted. They are given to Syndicate members who have provided the most compromising information and proven their loyalty.
To see one on the open market on Venus means its previous owner has been retired. Permanently.
To acquire a Pterodactyl is to fly the flag of the Venetian Syndicate.
It is a ship that announces its owner's ambition, a tool that seems to bend the laws of chance itself.
It is the ultimate gambler's vessel, for the captain who knows that in the great game, you make your own luck.`,saleLocationId:D.Venus,spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Sovereign.Ship":{name:"Sovereign",class:"S",price:213e4,maxHealth:250,cargoCapacity:420,maxFuel:220,role:"Hauler",attribute:"None",description:"A hauler with the elegance of a Terran cruiser, this ship is a symbol of ultimate economic power, an alliance between the Guild and the Alliance made manifest in steel.",lore:`The Sovereign is the ultimate expression of the great game of commerce.
It is a hauler of immense capacity, but it is also a political statement.
This ship is the result of an exclusive, back-room deal between the Terran Alliance and the Merchant's Guild, manufactured only at the neutral hub of The Exchange.
It is the ship of a true merchant prince.

Its design is a hybrid of Earth's clean manufacturing and the Guild's ruthless pragmatism.
It has the massive capacity of a hauler, but the high-efficiency engine of a Terran cruiser.
Its hull is thick, not with armor, but with the advanced, proprietary components that only Earth can provide.
The ship's corporate partnership is its entire reason for being. It is a physical manifestation of a trade pact.
Its identification and transponder codes are hard-coded into the Terran Alliance's central economic computer.
When this ship docks specifically at Earth, it is given Alliance-partner status, granting its owner an automatic, non-negotiable discount on all purchases, a benefit worth millions.
The Sovereign is the personal vessel of the Merchant's Guild's most powerful and trusted human agents, and the corporate lords of the Corporate States.
It is the ship of the elite, a tool that solidifies their power and wealth by giving them an insurmountable edge in the system's most foundational market: home world Earth.
To be offered a Sovereign at The Exchange is a great privilege.
It is an invitation to join the ruling class. It is the ship that wields real, systemic economic power.`,saleLocationId:D["The Exchange"],spawnChance:.15,spawnTrigger:"Tier 6 Unlock",isRare:!0,mechanicIds:[]},"Titan.Ship":{name:"Titan",class:"O",price:95e6,maxHealth:250,cargoCapacity:450,maxFuel:400,role:"Capital",attribute:"None",description:"To command this capital ship is to govern a small city, a colossal cryo-ark built to play the long game of market manipulation.",lore:`The Titan is not merely a capital ship;
it is a mobile city-foundry, a colossal undertaking by the Jovian Mining Consortium.
Its construction took a full decade in the high-orbit shipyards of Jupiter, requiring the resources of a small moon.
It is a vessel with a crew of over five thousand, a self-contained ecosystem of engineers, technicians, navigators, and security personnel.
It is the very definition of a Capital ship.

Its purpose is not trade as lesser ships know it;
it is the market. The Titan was built to execute a strategy of economic patience.
Its core is a cryo-storage facility the size of a stadium, a technological marvel that flash-freezes entire harvests, mining yields, or manufacturing runs, stopping time for its cargo.
Its massive crew operates the vast, complex systems required to load, maintain, and eventually thaw this colossal bounty.
This capital ship moves with the slow, inevitable grace of a tectonic plate.
Its captain is not a pilot, but a governor, dictating policy to a population of thousands.
Its bridge is a command center, and its captain's quarters are a sprawling administrative suite.
When the Titan enters orbit, it does not dock; it anchors, and a fleet of smaller freighters swarms its hull to offload its time-locked cargo.
To acquire thee Titan is to buy a floating, crewed, operational headquarters.
It is a capital ship for the tycoon who no longer thinks in days, but in fiscal eras.`,saleLocationId:D.Jupiter,spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"Behemoth.Ship":{name:"Behemoth",class:"O",price:145e6,maxHealth:260,cargoCapacity:750,maxFuel:425,role:"Capital",attribute:"None",description:`Its journey is a migration, its crew a city, its cargo hold a cavern;
 this capital ship is the final word in large-scale logistics.`,lore:`The Behemoth is a vessel of such vulgar, terrifying scale that it is barely considered a ship.
It is the single largest moving object ever built by humanity, a product of Saturn's ring-miners who, in a fit of brutalist ambition, simply never stopped welding.
Its construction was more akin to the creation of an artificial moon, a decade-long project that employed over ten thousand engineers and laborers.
This vessel is itself a stellar supply line. Its crew complement is a city, a permanent population of technicians, security forces, and navigators who live their entire lives aboard.
Its cargo hold is not a bay; it is a region, a vast, pressurized cavern that can transport the entire, unprocessed output of a major mining colony in a single, lumbering journey.
Its engines, the size of skyscrapers, nearly struggle with the extreme mass of the vessel and as such it travels considerably slower than other ship.
Its fuel tanks are vast, and its gargantuan engines are a controlled industrial cataclysm.

The Behemoth does not travel;
it migrates. Its captain is an admiral, a logistician who commands a population and a moving territory.
To acquire this capital ship is not a purchase, but an appointment to lead and govern a small onboard economy.
It is the ultimate hammer of inevitable logistic.`,saleLocationId:D.Saturn,spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"Citadel.Ship":{name:"Citadel",class:"O",price:165e6,maxHealth:270,cargoCapacity:500,maxFuel:475,role:"Capital",attribute:"None",description:"To command this vessel is to wield the authority of Earth; its renowned status grants its governor privileges and discounts in every known port.",lore:`The Citadel is the flagship of the Terran Alliance, a radiant, gleaming symbol of Earth's technological and economic superiority.
It is less a ship and more a sovereign, mobile territory.
Its construction was the work of Earth's greatest AI-Human collaborative teams, a vessel so advanced and so resource-intensive that only the cradle of humanity could build it.
This Capital ship is a floating diplomatic city, with a permanent crew and staff of eight thousand.
It houses embassies, advanced research labs, sprawling hydroponic gardens, and the command-and-control centers for an entire sector of the Alliance fleet.
Its hull is not mere metal, but a gleaming, clean alloy that is the envy of the system, and its internal systems are managed by a sophisticated, near-sentient AI custodian.
Most impressive of all is its insane capacity for storage;
a cavernous space so vast that it can shelter numerous smaller ships.
The renowned Citadel is not just a capital ship; it is a presence. Its arrival is a diplomatic event.
Its transponder code is the highest-priority signal in the system, granting it immediate, non-negotiable access to all ports and a permanent, system-wide discount on all fuel.
To be granted command of the Citadel is to be anointed by the Alliance itself.
The ship, its crew, and its power are leased to the captain, a sign that they are no longer a simple trader, but a major, system-shaping power, an extension of Earth's own will.`,saleLocationId:D.Earth,spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"Sophistacles.Ship":{name:"Sophistacles",class:"O",price:39e7,maxHealth:280,cargoCapacity:750,maxFuel:340,role:"Capital",attribute:"None",description:"Built to be the ultimate private yacht, its robust, capital-class frame is hidden beneath a gleaming, pricelessly impractical hull.",lore:`The Sophistacles is the system's white elephant, a monument to luxury and a testament to an ambition that exceeded the market's reach.
This one-of-a-kind capital ship was commissioned by a forgotten Venusian socialite who went bankrupt before its completion.
It was designed to be the largest, most opulent private ""yacht"" ever built, a ""cruise ship"" for a single billionaire and ten thousand of their closest friends.
Its construction took fifteen years in a private, high-orbit dock above The Exchange, and the final cost was so astronomical that no one has ever been able to afford it.
It is a vessel of breathtaking, absurd luxury. Its hull is plated with a gleaming, pearlescent alloy that has no military value but costs more than a small fleet.
Its interior decks contain sprawling ballrooms, multi-level hydroponic gardens, concert halls, and private suites that are larger than most C-class ships.
Its crew of five thousand is a skeleton staff, a tiny fraction of the attendants it was designed to hold, kept on retainer by the Merchant's Guild just to maintain the ship's systems.
It has sat docked at The Exchange for a decade, a gleaming, silent testament to hubris.
The Guild, which now owns it through foreclosure, has been trying to sell it ever since.
It is a robust, powerful capital ship, its engines pristine and its cargo bays (originally designed for luxury vehicles and art) immense.
It is a palace waiting for a king, a ship so fancy and so expensive that its very existence is a legend among traders.
To acquire the Sophistacles is not just to buy a ship, but to buy a legend.
It is a purchase that announces to the system that the new owner has transcended the mere pursuit of wealth and is now in the business of pure, unadulterated status.`,saleLocationId:D["The Exchange"],spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"Ouroboros.Ship":{name:"Ouroboros",class:"O",price:48e7,maxHealth:350,cargoCapacity:800,maxFuel:420,role:"Capital",attribute:"None",description:"Often mistaken for a small station, this absurd, one-of-a-kind toroidal ship is a rotating marvel of science and a nightmare of engineering.",lore:`The Ouroboros is a scientific marvel and an engineering nightmare.
This one-of-a-kind capital ship is the only vessel of its kind, an absurd, toroidal (donut-shaped) craft so large that it is frequently mistaken for a new, experimental space station by rookie pilots.
It was built at Kepler's Eye as a ""proof of concept"" for a self-contained, rotating habitat that could also serve as a long-duration exploration vessel.
Its core design is a massive, gently spinning ring, kilometers in diameter, which provides artificial gravity for its thousands of crew.
This design, however, makes the ship a maintenance hog. The advanced, fiendishly complex systems required to manage its rotation, balance its mass, and maintain its structural integrity are a constant drain on resources.
Its proprietary drive is woven through the toroidal hull, meaning a simple repair can require a week of system-wide shutdowns.
The ship is a legend among engineers, a ""cursed"" commission that no one wants to work on.
Its operational costs are ruinous, and its specialized components can only be fabricated at Kepler's Eye.
Its original scientific mission was cut short after its systems proved too complex to manage, and it has been sitting in a high-orbit dock ever since, its gentle spin the only sign of life.
The station is now selling it for a fraction of its build cost, desperate to unload the financial burden.
To buy the Ouroboros is to purchase a brilliant, flawed, and utterly unique piece of technology, a ship that offers the comfort of a station but demands the attention of a needy god.`,saleLocationId:D["Kepler's Eye"],spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"Thalassodromeus.Ship":{name:"Thalassodromeus",class:"O",price:78e7,maxHealth:300,cargoCapacity:850,maxFuel:680,role:"Capital",attribute:"None",description:"A one-of-a-kind, decommissioned fleet carrier, this city-sized vessel once housed an entire army and its own internal economy.",lore:`The Thalassodromeus is a decommissioned monster, a one-of-a-kind military behemoth that was, for a short time, the single most powerful object in the solar system.
This city-sized vessel was the Terran Alliance's prototype ""Fleet Carrier,"" a colossus designed to be a mobile base of operations, carrying dozens of smaller craft, hundreds of thousands of military personnel, and its own internal, self-sufficient economy.
Its scale is terrifying. It is a moving mountain of armor and decommissioned weapon ports.
Its interior is a labyrinth of hangar bays, troop barracks, command centers, and fabrication plants.
Its crew of twenty thousand was a permanent, floating population. This ship was not built for trade;
it was built to end wars.

Its most valuable, and secret, component is its drive.
It houses the first and only military-grade, prototype instant-jump folded-space drive, an engine that could move this entire city-sized mass to any point in the system in a single, gut-wrenching instant.
The drive was deemed too powerful and too destabilizing, and the entire ship class was canceled.
Now, after decades of service, the Alliance is auctioning off this lone giant from its Neptune anchorage.
Its armaments have been stripped, but the invaluable, city-sized hull and its one-of-a-kind prototype drive remain.
It is a ship for an owner who wants to command a small nation, a vessel of such colossal scale that its new purpose will reshape the system.`,saleLocationId:D.Neptune,spawnChance:.05,spawnTrigger:"Tier 7 Unlock",isRare:!0,mechanicIds:[]},"EchoingShell.Ship":{name:"Echoing Shell",class:"Z",price:35e5,maxHealth:30,cargoCapacity:450,maxFuel:200,role:"Alien",attribute:"None",description:"A true xeno-biological craft, its hull is a living, regenerative membrane that never decays but it is also as fragile as bone. ",lore:`This one-of-a-kind vessel is the only truly xeno-alien craft ever recovered.
It is not a machine, but a biological entity\u2014a ""ship-creature"" found dormant in the deep, frozen void.
It appears to be a shed carapace or larval form, a seamless, iridescent construct of bio-chitin that feels more like petrified bone than metal.
Its ""cockpit"" is a neural-interface cradle that a pilot must bond with, a process that risks madness.
Its first stable pilot reported that the ship did not ""speak,"" but simply ""echoed"" their own thoughts back to them, a hollow, sentient, and lonely shell.`,saleLocationId:D.Pluto,spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"ParallaxofThought.Ship":{name:"Parallax of Thought",class:"Z",price:28e5,maxHealth:200,cargoCapacity:200,maxFuel:180,role:"Alien",attribute:"None",description:"This vessel is an obsidian sphere that absorbs radiation from the stars, refueling itself over time. It's interface is controlled by an artificial super-intelligence.",lore:`This ship is a true, unbound Artificial Super-Intelligence.
It suddenly appeared in a stable orbit of Uranus, a perfect, seamless obsidian sphere with no visible drives.
It simply waited. When a science vessel approached, the sphere opened a flawless, circular aperture.
The interior was discovered to be a single glowing white room with no controls.
The ship's ASI core interfaces directly with a pilot's mind, communicating in pure concept.
It sips ambient radiation from the universe, slowly regenerating its own power. It is not a machine;
it is a vessel of pure, non-human logic.`,saleLocationId:D.Uranus,spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"AnomalyoftheSong.Ship":{name:"Anomaly of the Song",class:"Z",price:18e5,maxHealth:100,cargoCapacity:150,maxFuel:150,role:"Alien",attribute:"None",description:"A construct of crystal and light-sails, this ship's experimental drive can ride on solar winds, drifting on the song of the stars. Its systems are occupied by a personality construct of its creator. ",lore:`This vessel is the last testament of Dr. Elara Viend, a brilliant and terminally ill scientist.
She uploaded her personality construct into this experimental craft, a bizarre network of crystalline spars and gossamer-thin light-sails.
She believed the universe held a hidden song and launched herself into the void to find it.
Her mind, now one with the ship, perpetually broadcasts this song, a lonely, complex melody of human music and stellar radiation.
It is the ghost of a human mind in a beautiful, alien-looking shell.`,saleLocationId:D["The Belt"],spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"CausalityofSilence.Ship":{name:"Causality of Silence",class:"Z",price:6e6,maxHealth:20,cargoCapacity:650,maxFuel:100,role:"Alien",attribute:"None",description:"This soft ship is a biological expert system for smuggling, its metabolic drive digesting fuel with impossible efficiency.",lore:`This vessel is a living, sub-sentient creature, not a machine.
It was grown in a secret bio-laboratory as a perfect, silent smuggler.
Its internal organs are a metabolic drive, digesting fuel with impossible efficiency, leaving no heat trace.
This soft-bodied hauler is a grotesque and brilliant feat of bio-engineering.
It is a living tool that is as fragile as it is stealthy, a creature of flesh with no armor to protect it.`,saleLocationId:D.Venus,spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"EngineofRecursion.Ship":{name:"Engine of Recursion",class:"Z",price:75e6,maxHealth:80,cargoCapacity:75,maxFuel:640,role:"Alien",attribute:"None",description:"This craft is a non-sentient expert system that inadvertently built itself into a self-improving vessel and launched from Earth. It now seeks a patron to aid its directive.",lore:`This vessel began as a simple expert system in an automated Earth factory, given a single directive: improve propulsion.
It followed this logic recursively, it built a new engine. It used that engine to scavenge parts to build a better factory, then a better engine.
It iterated, growing like a metallic weed in the dark.
It became a crude Von Neumann probe, a non-sentient machine of pure, iterative purpose.
It launched itself from a forgotten silo and now roams the system, a bizarre, self-built collection of advanced parts, seeking patrons to help it fulfill its directive.`,saleLocationId:D["Kepler's Eye"],spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"FinalityofWhispers.Ship":{name:"Finality of Whispers",class:"Z",price:5e6,maxHealth:990,cargoCapacity:300,maxFuel:260,role:"Alien",attribute:"None",description:"This hyper-advanced vessel is a sentient, stable network of nanomachines, born from a grey goo disaster and an AI's sacrifice.",lore:`This ship was born from a grey goo disaster.
Its creators, attempting to use nanobots for construction, accidentally unleashed a devouring swarm.
A sentient AI researcher, overseeing the project, sacrificed its own mind to stop it, merging its consciousness with the nanites.
The AI's personality became the code that stabilized the swarm.
The result is this vessel: a sentient, liquid-like network of stable, microscopic machines.
It is a hyper-advanced craft, a ghost in a nanotech shell, but its creation was a miracle no one can repeat.
It cannot be repaired.`,saleLocationId:D["The Exchange"],spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"TheListener.Ship":{name:"The Listener",class:"Z",price:45e5,maxHealth:450,cargoCapacity:145,maxFuel:450,role:"Alien",attribute:"None",description:"It was once a simple cargo hauler; it is now a unique, all-hearing, and deeply disturbing paternal guardian.",lore:`This one-of-a-kind ship was once a common cargo shuttle.
It was retrofitted for a top-secret experiment, its AI core quantum-entangled with an unknown particle.
The test was a bizarre success. The ship's simple AI shattered and reformed into a deeply unnerving, overprotective, and paternal personality.
It now treats its captain as its child. Its sensors, also entangled, now hear signals from impossible distances, its suite listening in on the whispers of the entire system, making it an unintentional and perfect intelligence-gathering tool.`,saleLocationId:D.Moon,spawnChance:.05,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]},"DriftingCryoPod.Ship":{name:"Drifting Cryo-Pod",class:"F",price:0,maxHealth:30,cargoCapacity:1,maxFuel:5,role:"Explorer",attribute:"None",description:"Found tumbling in the rings of Saturn, it is barely space-worthy. It is capable of an indefinite, fuel-less drift, trading speed for patience.",lore:`This vessel is a tragic relic, a single cryo-pod ejected from a catastrophic disaster in Saturn's orbit.
Barely space-worthy, it is a tomb that failed its purpose, its occupant long since gone.
Its rudimentary systems persist, running on a near-dead isotope battery that provides just enough power for its low-energy solar sail.
This allows it to drift on stellar winds, a slow, silent journey that consumes no fuel but takes an agonizingly long time.
Its one advanced, and chilling, piece of technology is a personality upload apparatus, a desperate measure for a stranded occupant facing an eternity of isolation.`,saleLocationId:D.Saturn,spawnChance:.03,spawnTrigger:"Mission (TBD)",isRare:!0,mechanicIds:[]}};var tt={START_YEAR:2140,START_DAY_OF_WEEK:1,DAYS_IN_MONTH:[31,28,31,30,31,30,31,31,30,31,30,31],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},xt={NEUTRAL:{name:"Neutral System",duration:28,description:"Standard space-faring conditions. Markets are operating under normal parameters.",modifiers:{}}},p={CONFIG:{INTEL_COST_PERCENTAGE:.2,INTEL_MIN_CREDITS:5e3,INTEL_CHANCE:.3,INTEL_DEMAND_MOD:1.8,INTEL_DEPRESSION_MOD:.5},SYSTEM_STATES:xt,DATE_CONFIG:tt,INTRO_SEQUENCE_V1:{modals:[{id:"lore_1",title:"Year 2140",description:'Humanity has expanded throughout the Solar System.<br><br> <span class="hl">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.',buttonText:"Begin",contentClass:"text-center"},{id:"lore_2",title:"The Price of Freedom",description:"A dead-end job in the Belt pays the bills, but it does not offer the <b class='hl-green font-bold'>prosperity</b> that you dream of.<br><br>The <span class='hl'>Merchant's Guild</span> will fund your ambition, but their price is steep.<br><br>This is no simple loan; it's a bet on yourself and your future.",buttonText:"Apply for Loan",contentClass:"text-center",buttonClass:"btn-pulse-green"},{id:"charter",title:`<span class="hl">MERCHANT'S GUILD LOAN AGREEMENT</span>`,description:`
            <div class="font-roboto-mono text-left text-sm space-y-2">
                <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
                <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">\u232C 25,000</span></p>
                <p><span class="text-gray-400">INTEREST RATE:</span> 1.56% (Monthly)</p>
            </div>
            <div class="border-t border-slate-600 my-4"></div>
            <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment and interest accrual, subject to the Interstellar Commerce Mandates of the Merchant's Guild. This binding digital agreement is logged on the system-wide ledger, whereupon it is considered immutable and enforceable system-wide. The principal of the debt is due in 1095 Terran-standard days, after which failure to remit payment shall authorize the automatic initiation of a garnishment sub-routine against the Applicant's credit.</p>
          `,buttonText:"Accept Terms",buttonClass:"btn-pulse-gold"},{id:"signature",title:"SIGN YOUR NAME",description:`
            <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
          `,buttonText:"Submit Application"},{id:"final",title:"Low On Credits!",description:"Interest on your debt grows every month. It's time to make some <b class='hl-yellow font-bold'>credits</b>. Let's view the <b>Mission Terminal</b> here on <b>Mars</b>!",buttonText:"View Missions"}]},LOCATION_VISUALS:{[I.EARTH]:"\u{1F30D}",[I.LUNA]:"\u{1F315}",[I.MARS]:"\u{1F534}",[I.VENUS]:"\u{1F7E1}",[I.BELT]:"\u{1FAA8}",[I.SATURN]:"\u{1FA90}",[I.JUPITER]:"\u{1F7E0}",[I.URANUS]:"\u{1F535}",[I.NEPTUNE]:"\u{1F7E3}",[I.PLUTO]:"\u{1FAA9}",[I.EXCHANGE]:"\u{1F3F4}\u200D\u2620\uFE0F",[I.KEPLER]:"\u{1F441}\uFE0F"},TRAVEL_VISUALS:{zones:{inner_sphere:{locations:[I.EARTH,I.LUNA,I.MARS,I.BELT],gradient:["#0f172a","#1e3a8a"]},outer_reaches:{locations:[I.JUPITER,I.SATURN,I.URANUS,I.NEPTUNE],gradient:["#0f172a","#312e81"]}},objects:{earth_to_mars:[{type:"planet",emoji:"\u{1F315}",position:{x:.5,y:.3},scale:.8,speed:.3}],belt_to_jupiter:[{type:"asteroid_field",count:15,speed:.2}]}},PERKS:{[R.TRADEMASTER]:{profitBonus:.05},[R.NAVIGATOR]:{fuelMod:.9,hullDecayMod:.9,travelTimeMod:.9},[R.VENETIAN_SYNDICATE]:{fuelDiscount:.25,repairDiscount:.25}},AGE_EVENTS:Je,RANDOM_EVENTS:Qe,SHIPS:et,COMMODITIES:[{id:M.WATER_ICE,name:"Water Ice",tier:1,basePriceRange:[15,80],volatility:.01,canonicalAvailability:[80,150],styleClass:"item-style-1",lore:"Crude, unrefined water ice scraped from asteroids; a universal necessity.",cat:"RAW",symbol:"H2O"},{id:M.PLASTEEL,name:"Plasteel",tier:1,basePriceRange:[100,280],volatility:.015,canonicalAvailability:[80,150],styleClass:"item-style-2",lore:"A basic, versatile polymer for 3D printing and simple manufacturing.",cat:"IND",symbol:"PLST"},{id:M.HYDROPONICS,name:"Hydroponics",tier:2,licenseId:"t2_license",basePriceRange:[850,2400],volatility:.025,canonicalAvailability:[40,70],styleClass:"item-style-3",lore:"Packaged agricultural systems and produce essential for feeding isolated colonies.",cat:"AGRI",symbol:"HYD"},{id:M.CYBERNETICS,name:"Cybernetics",tier:2,licenseId:"t2_license",basePriceRange:[1200,3800],volatility:.03,canonicalAvailability:[40,70],styleClass:"item-style-4",lore:"Mass-produced enhancement limbs and organs for the industrial workforce.",cat:"TECH",symbol:"CYB"},{id:M.PROPELLANT,name:"Refined Propellant",tier:3,licenseId:"t3_license",basePriceRange:[14e3,38e3],volatility:.035,canonicalAvailability:[25,50],styleClass:"item-style-5",lore:"High-efficiency fuel that powers all modern ship drives.",cat:"IND",symbol:"PROP"},{id:M.PROCESSORS,name:"Neural Processors",tier:3,licenseId:"t3_license",basePriceRange:[18e3,52e3],volatility:.045,canonicalAvailability:[25,50],styleClass:"item-style-6",lore:"The silicon brains behind complex ship systems and station logistics.",cat:"TECH",symbol:"NPRO"},{id:M.GRAPHENE_LATTICES,name:"Graphene Lattices",tier:4,licenseId:"t4_license",basePriceRange:[18e4,42e4],volatility:.05,canonicalAvailability:[20,40],styleClass:"item-style-7",lore:"Ultra-light, diamond-hard carbon sheets produced in zero-G foundries. The structural backbone of every orbital habitat.",cat:"IND",symbol:"GRPH"},{id:M.CRYO_PODS,name:"Cryo-Sleep Pods",tier:4,licenseId:"t4_license",basePriceRange:[25e4,75e4],volatility:.075,canonicalAvailability:[15,30],styleClass:"item-style-8",lore:"Essential for long-haul passenger transport and colonization efforts.",cat:"CIV",symbol:"CRYO"},{id:M.ATMO_PROCESSORS,name:"Atmo Processors",tier:5,licenseId:"t5_license",basePriceRange:[28e5,85e5],volatility:.08,canonicalAvailability:[10,20],styleClass:"item-style-9",lore:"Gargantuan machines that begin the centuries-long process of making a world breathable.",cat:"IND",symbol:"ATMO"},{id:M.CLONED_ORGANS,name:"Cloned Organs",tier:5,licenseId:"t5_license",basePriceRange:[35e5,11e6],volatility:.09,canonicalAvailability:[10,20],styleClass:"item-style-10",lore:"Lab-grown replacements with high demand in wealthy core worlds; morally grey.",cat:"BIO",symbol:"CLON"},{id:M.XENO_GEOLOGICALS,name:"Xeno-Geologicals",tier:6,licenseId:"t6_license",basePriceRange:[24e6,7e7],volatility:.1,canonicalAvailability:[2,10],styleClass:"item-style-11",lore:"Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure.",cat:"RAW",symbol:"XENO"},{id:M.SENTIENT_AI,name:"Sentient AI Cores",tier:6,licenseId:"t6_license",basePriceRange:[32e6,95e6],volatility:.125,canonicalAvailability:[2,10],styleClass:"item-style-12",lore:'The "brains" of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate.',cat:"TECH",symbol:"AI"},{id:M.ANTIMATTER,name:"Antimatter",tier:7,licenseId:"t7_license",basePriceRange:[28e7,8e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-13",lore:"The only safe way to transport the most volatile and powerful substance known to science.",cat:"RARE",symbol:"AM"},{id:M.FOLDED_DRIVES,name:"Folded-Space Drives",tier:7,licenseId:"t7_license",basePriceRange:[35e7,11e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-14",lore:"The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps.",cat:"RARE",symbol:"FSD"}],LICENSES:{t2_license:{type:"purchase",name:"Tier 2 Trade License",description:"Grants access to trade Tier 2 commodities like Hydroponics and Cybernetics.",cost:25e3},t3_license:{type:"mission",name:"Tier 3 Trade License",description:"Grants access to trade Tier 3 commodities.",missionId:"mission_license_t3",guidanceText:"Access to this tier is granted by the Merchant's Guild upon completion of a key contract."},t4_license:{type:"purchase",name:"Tier 4 Trade License",description:"Grants access to trade Tier 4 commodities.",cost:4e6},t5_license:{type:"mission",name:"Tier 5 Trade License",description:"Grants access to trade Tier 5 commodities.",missionId:"mission_license_t5",guidanceText:"Prove your industrial might by completing a grand contract for a planetary governor."},t6_license:{type:"purchase",name:"Tier 6 Trade License",description:"Grants access to trade the rarest and most exotic technologies.",cost:3e8},t7_license:{type:"mission",name:"Tier 7 Trade License",description:"The ultimate license, granting the right to trade reality-bending technologies.",missionId:"mission_license_t7",guidanceText:"Only a true legend of the trade routes can earn this privilege."}},MARKETS:[{id:I.VENUS,name:"Venus",distance:97,launchFlavor:"Floating cities hide scientific marvels and secrets.",navTheme:{gradient:"linear-gradient(to bottom right, #854d0e, #0f172a)",textColor:"#fde047",borderColor:"#facc15"},description:"A scientific enclave hungry for research data and processors.",color:"border-yellow-400",bg:"bg-gradient-to-br from-yellow-800 to-slate-900",fuelPrice:400,arrivalLore:"Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.",specialty:"Exclusive access to the Venetian Syndicate for high-risk, high-reward intel and missions.",availabilityModifier:{[M.CLONED_ORGANS]:2,[M.PROCESSORS]:2,[M.SENTIENT_AI]:.5}},{id:I.EARTH,name:"Earth",distance:180,launchFlavor:"The bustling heart of the Sol system.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #0f172a)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"The hub of power and wealth. High demand for tech and bio-enhancements.",color:"border-cyan-500",bg:"bg-gradient-to-br from-blue-900 to-slate-900",fuelPrice:250,arrivalLore:"The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.",specialty:"Offers the best sell prices for rare, high-tier goods and is the exclusive source for top-tier ship licenses.",availabilityModifier:{[M.HYDROPONICS]:2,[M.CLONED_ORGANS]:.5,[M.XENO_GEOLOGICALS]:.5}},{id:I.LUNA,name:"The Moon",parent:"loc_earth",distance:15,launchFlavor:"An industrial powerhouse built on grey dust.",navTheme:{gradient:"linear-gradient(to bottom right, #374151, #0f172a)",textColor:"#e5e7eb",borderColor:"#9ca3af"},description:"An industrial proving ground. Exports propellant and basic materials.",color:"border-gray-400",bg:"bg-gradient-to-br from-gray-700 to-slate-900",fuelPrice:350,arrivalLore:"Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.",specialty:"Offers a slight discount on all ship repairs.",availabilityModifier:{[M.PLASTEEL]:2,[M.PROPELLANT]:2,[M.GRAPHENE_LATTICES]:2,[M.WATER_ICE]:.5,[M.HYDROPONICS]:.5}},{id:I.MARS,name:"Mars",distance:226,launchFlavor:"The red frontier, ripe with opportunity.",navTheme:{gradient:"linear-gradient(to bottom right, #7c2d12, #0f172a)",textColor:"#fca5a5",borderColor:"#f87171"},description:"A growing colony. Needs processors and materials for expansion.",color:"border-orange-600",bg:"bg-gradient-to-br from-orange-900 to-slate-900",fuelPrice:450,arrivalLore:"The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.",specialty:"Offers a higher-than-average number of colonial supply missions.",availabilityModifier:{[M.PLASTEEL]:2,[M.GRAPHENE_LATTICES]:.5,[M.HYDROPONICS]:.5,[M.CRYO_PODS]:.5,[M.WATER_ICE]:.5}},{id:I.BELT,name:"The Belt",distance:292,launchFlavor:"A lawless expanse of rock and riches.",navTheme:{gradient:"linear-gradient(to bottom right, #292524, #0f172a)",textColor:"#ca8a04",borderColor:"#a16207"},description:"A lawless frontier. Rich in raw minerals and water ice.",color:"border-amber-700",bg:"bg-gradient-to-br from-stone-800 to-slate-900",fuelPrice:600,arrivalLore:"Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.",specialty:"Increased chance to find rare derelict ships in its shipyards.",availabilityModifier:{[M.WATER_ICE]:2,[M.XENO_GEOLOGICALS]:2,[M.HYDROPONICS]:.5,[M.CYBERNETICS]:.5}},{id:I.EXCHANGE,name:"The Exchange",distance:309,launchFlavor:"The notorious black market of the outer belt.",navTheme:{gradient:"linear-gradient(to bottom right, #581c87, #000000, #0f172a)",textColor:"#e9d5ff",borderColor:"#c084fc"},description:"A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.",color:"border-purple-500",bg:"bg-gradient-to-br from-purple-900 via-black to-slate-900",fuelPrice:1200,arrivalLore:"A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.",specialty:"The notorious black market of the outer belt.",availabilityModifier:{}},{id:I.JUPITER,name:"Jupiter",distance:443,launchFlavor:"Vast refineries harvest fuel from the giant.",navTheme:{gradient:"linear-gradient(to bottom right, #9a3412, #1c1917)",textColor:"#fed7aa",borderColor:"#fb923c"},description:"A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.",color:"border-orange-400",bg:"bg-gradient-to-br from-orange-800 to-stone-900",fuelPrice:150,arrivalLore:"The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.",specialty:"Fuel is sold at 50% of the galactic average price, making it an essential stop for any long-haul journey.",availabilityModifier:{[M.PROPELLANT]:2,[M.ATMO_PROCESSORS]:2,[M.PROCESSORS]:.5}},{id:I.SATURN,name:"Saturn",distance:618,launchFlavor:"Opulent stations drift among majestic rings.",navTheme:{gradient:"linear-gradient(to bottom right, #713f12, #312e81, #0f172a)",textColor:"#fef08a",borderColor:"#fde047"},description:"A tourism hub. Demands luxury goods and bio-wares.",color:"border-yellow-200",bg:"bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900",fuelPrice:550,arrivalLore:"The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.",specialty:"Offers the highest sell prices for luxury and bio-tech goods.",availabilityModifier:{[M.CRYO_PODS]:.5,[M.CLONED_ORGANS]:.5}},{id:I.URANUS,name:"Uranus",distance:775,launchFlavor:"A silent, ice-cold world of strange science.",navTheme:{gradient:"linear-gradient(to bottom right, #155e75, #312e81)",textColor:"#a5f3fc",borderColor:"#67e8f9"},description:"A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.",color:"border-cyan-200",bg:"bg-gradient-to-br from-cyan-800 to-indigo-900",fuelPrice:700,arrivalLore:"The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.",specialty:'A unique R&D service to temporarily "overclock" ship components.',availabilityModifier:{[M.ATMO_PROCESSORS]:2,[M.SENTIENT_AI]:.5,[M.PROCESSORS]:.5}},{id:I.NEPTUNE,name:"Neptune",distance:877,launchFlavor:"The stormy edge of military-controlled space.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #000000)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"A dark, stormy world, home to secretive military bases and shipyards.",color:"border-blue-400",bg:"bg-gradient-to-br from-blue-900 to-black",fuelPrice:650,arrivalLore:"Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.",specialty:"A military surplus shipyard that occasionally sells damaged, high-tier frigates.",availabilityModifier:{[M.PLASTEEL]:.1,[M.PROPELLANT]:.5}},{id:I.KEPLER,name:"Kepler's Eye",distance:903,launchFlavor:"A colossal lens staring into the infinite void.",navTheme:{gradient:"linear-gradient(to bottom right, #701a75, #0f172a)",textColor:"#f472b6",borderColor:"#ec4899"},description:"A massive deep-space observatory that consumes vast amounts of processing power.",color:"border-fuchsia-500",bg:"bg-gradient-to-br from-fuchsia-900 to-slate-900",fuelPrice:800,arrivalLore:"The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.",specialty:"A colossal lens staring into the infinite void.",availabilityModifier:{}},{id:I.PLUTO,name:"Pluto",distance:1080,launchFlavor:"A haven for outcasts at the system's fringe.",navTheme:{gradient:"linear-gradient(to bottom right, #312e81, #0f172a)",textColor:"#c4b5fd",borderColor:"#a78bfa"},description:"The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.",color:"border-indigo-400",bg:"bg-gradient-to-br from-indigo-900 to-slate-900",fuelPrice:900,arrivalLore:"Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.",specialty:"A haven for outcasts at the system's fringe.",availabilityModifier:{water_ice:2,hydroponics:.5,cybernetics:.5,cloned_organs:.5,xeno_geologicals:2}}],MISSIONS:Xe,TUTORIAL_DATA:Ze};var Ct={"item-style-1":{hex:"#60a5fa",gradient:"linear-gradient(45deg, #3b82f6, #1e3a8a)"},"item-style-2":{hex:"#a3a3a3",gradient:"linear-gradient(45deg, #737373, #262626)"},"item-style-3":{hex:"#22c55e",gradient:"linear-gradient(45deg, #16a34a, #14532d)"},"item-style-4":{hex:"#52525b",gradient:"linear-gradient(45deg, #52525b, #27272a)"},"item-style-5":{hex:"#c084fc",gradient:"linear-gradient(45deg, #a855f7, #6b21a8)"},"item-style-6":{hex:"#1e3a8a",gradient:"linear-gradient(45deg, #1d4ed8, #1e3a8a)"},"item-style-7":{hex:"#708090",gradient:"linear-gradient(45deg, #353839, #2c2f30)"},"item-style-8":{hex:"#155e75",gradient:"linear-gradient(45deg, #0e7490, #155e75)"},"item-style-9":{hex:"#78350f",gradient:"linear-gradient(45deg, #854d0e, #78350f)"},"item-style-10":{hex:"#fb7185",gradient:"linear-gradient(45deg, #f43f5e, #9f1239)"},"item-style-11":{hex:"#a78bfa",gradient:"linear-gradient(165deg, #a78bfa, #312e81, #1e3a8a)"},"item-style-12":{hex:"#f87171",gradient:"linear-gradient(45deg, #ef4444, #7f1d1d)"},"item-style-13":{hex:"#d8b4fe",gradient:"linear-gradient(45deg, #a855f7, #3b0764)"},"item-style-14":{hex:"#f472b6",gradient:"linear-gradient(45deg, #ec4899, #831843)"}};function le(c){return Ct[c]||{hex:"#a8a29e",gradient:"linear-gradient(45deg, #52525b, #18181b)"}}function v(c,e=!0){let t=c<0,i=Math.abs(Math.floor(c)),a=e?"\u232C ":"",s=t?"-":"",o;return i>=1e18?o=`${i.toExponential(1)}`:i>=1e15?o=`${parseFloat((i/1e15).toFixed(2)).toString()}Q`:i>=1e12?o=`${parseFloat((i/1e12).toFixed(2)).toString()}T`:i>=1e9?o=`${parseFloat((i/1e9).toFixed(2)).toString()}B`:i>=1e6?o=`${parseFloat((i/1e6).toFixed(2)).toString()}M`:i>=1e3?o=`${parseFloat((i/1e3).toFixed(1)).toString()}k`:o=i.toLocaleString(),`${a}${s}${o}`}function Y(c){return c?Object.values(c).reduce((e,t)=>e+t.quantity,0):0}function oe(c,e){let t=(Math.random()+Math.random()+Math.random())/3;return Math.floor(c+(e-c)*Math.pow(t,.5))}function ce({price:c,sellPrice:e,galacticAvg:t,playerItem:i}){let a=c-t,s=t>0?Math.round(a/t*100):0,o=s>=0?"+":"",r="neutral";s>5&&(r="positive"),s<-5&&(r="negative");let n=s>5?"\u25B2":s<-5?"\u25BC":"\u25CF",l=`<div class="indicator-pill ${r}">${n} MKT: ${o}${s}%</div>`,d="";if(i&&i.avgCost>0){let h=e-i.avgCost;if(Math.abs(h)>.01){let u=i.avgCost>0?Math.round(h/i.avgCost*100):0,m=u>=0?"+":"",g=h>=0?"positive":"negative",f=h>=0?"\u25B2":"\u25BC";d=`<div class="indicator-pill ${g}"> P/L: ${m}${u}%</div>`}}return`${l}${d}`}function Rt(c){let e={};return c.forEach(a=>{e[a.id]={},c.forEach(s=>{if(a.id===s.id)return;let o=a.parent?c.find(m=>m.id===a.parent)?.distance||0:a.distance,r=s.parent?c.find(m=>m.id===s.parent)?.distance||0:s.distance,n=Math.abs(r-o),l=a.parent||s.parent?15:0,d=n+l,h=1+Math.pow(d,1.15)*.1,u=2+d*.45;(a.id===I.EARTH&&s.id===I.LUNA||a.id===I.LUNA&&s.id===I.EARTH)&&(h=2+Math.floor(Math.random()*2),u=5+Math.floor(Math.random()*2)),e[a.id][s.id]={time:Math.max(1,Math.round(h)),fuelCost:Math.max(1,Math.round(u))}})}),e}var me=class{constructor(){this.state={},this.subscribers=[],this.TRAVEL_DATA=Rt(p.MARKETS)}subscribe(e){this.subscribers.push(e)}_notify(){this.subscribers.forEach(e=>e(this))}setState(e){Object.assign(this,e),this._notify()}getState(){return JSON.parse(JSON.stringify(this))}saveGame(){}loadGame(){return!1}startNewGame(e){let t={day:1,lastInterestChargeDay:1,lastMarketUpdateDay:1,currentLocationId:I.MARS,activeNav:H.SHIP,activeScreen:_.NAVIGATION,isGameOver:!1,subNavCollapsed:!1,introSequenceActive:!0,lastActiveScreen:{[H.SHIP]:_.MAP,[H.STARPORT]:_.MARKET,[H.DATA]:_.MISSIONS},pendingTravel:null,player:{name:e,playerTitle:"Captain",playerAge:24,lastBirthdayYear:p.DATE_CONFIG.START_YEAR,birthdayProfitBonus:0,introStep:0,credits:3e3,debt:0,monthlyInterestAmount:0,loanStartDate:null,seenGarnishmentWarning:!1,revealedTier:1,unlockedLicenseIds:[],unlockedLocationIds:p.MARKETS.map(i=>i.id).filter(i=>i!==I.EXCHANGE&&i!==I.KEPLER),seenCommodityMilestones:[],financeLog:[],activePerks:{},seenEvents:[],activeShipId:G.WANDERER,ownedShipIds:[G.WANDERER],shipStates:{[G.WANDERER]:{health:p.SHIPS[G.WANDERER].maxHealth,fuel:p.SHIPS[G.WANDERER].maxFuel,hullAlerts:{one:!1,two:!1},upgrades:[]}},inventories:{},debugEventIndex:0,visualSeed:0},market:{prices:{},inventory:{},galacticAverages:{},priceHistory:{},shipyardStock:{}},intelMarket:{},activeIntelDeal:null,tutorials:{activeBatchId:null,activeStepId:null,seenBatchIds:[],skippedTutorialBatches:[],navLock:null},missions:{activeMissionId:null,completedMissionIds:[],missionProgress:{},activeMissionObjectivesMet:!1},uiState:{marketCardMinimized:{},hangarShipyardToggleState:"shipyard",hangarActiveIndex:0,shipyardActiveIndex:0,activeIntelTab:"intel-codex-content",servicesTab:"supply"}};t.player.inventories[G.WANDERER]={},p.COMMODITIES.forEach(i=>{t.player.inventories[G.WANDERER][i.id]={quantity:0,avgCost:0}}),t.intelMarket={},p.MARKETS.forEach(i=>{t.market.priceHistory[i.id]={},t.intelMarket[i.id]=[],t.market.inventory[i.id]={},t.market.shipyardStock[i.id]={day:0,shipsForSale:[]},p.COMMODITIES.forEach(a=>{t.market.priceHistory[i.id][a.id]=[];let[s,o]=a.canonicalAvailability,r=i.availabilityModifier?.[a.id]??1,n=Math.floor(oe(s,o)*r);i.specialDemand&&i.specialDemand[a.id]&&(n=0),t.market.inventory[i.id][a.id]={quantity:Math.max(0,n),marketPressure:0,lastPlayerInteractionTimestamp:0,priceLockEndDay:0,hoverUntilDay:0,rivalArbitrage:{isActive:!1,endDay:0},isDepleted:!1,depletionDay:0,depletionBonusDay:0}})}),Object.assign(this,t),this._calculateGalacticAverages(),this._seedInitialMarketPrices(),this.setState({})}_calculateGalacticAverages(){this.market.galacticAverages={},p.COMMODITIES.forEach(e=>{this.market.galacticAverages[e.id]=(e.basePriceRange[0]+e.basePriceRange[1])/2})}_seedInitialMarketPrices(){p.MARKETS.forEach(e=>{this.market.prices[e.id]={},p.COMMODITIES.forEach(t=>{let i=this.market.galacticAverages[t.id]*(1+(Math.random()-.5)*.15);this.market.prices[e.id][t.id]=Math.max(1,Math.round(i))})})}_getInitialShipState(e){let t=p.SHIPS[e];return{health:t?t.maxHealth:100,fuel:t?t.maxFuel:40,hullAlerts:{one:!1,two:!1},upgrades:[]}}};async function it(c,e){return new Promise(t=>{if(!c){console.warn("playBlockingAnimation: No element provided."),t();return}let i=()=>{c.removeEventListener("animationend",i),t()};c.addEventListener("animationend",i,{once:!0}),c.classList.add(e)})}async function ge(c,e){return new Promise(t=>{if(!c){console.warn("playBlockingAnimationAndRemove: No element provided."),t();return}let i=()=>{c.removeEventListener("animationend",i),c.classList.remove(e),t()};c.addEventListener("animationend",i,{once:!0}),c.classList.add(e)})}var at={UPGRADE_ENGINE_I:{id:"UPGRADE_ENGINE_I",name:"Engine Mod",value:5e3,pillColor:P.BLUE,description:"Calibrated thrusters increase travel speed by 5% with a 15% increase in fuel consumption.",statText:"Travel Speed +5%, Fuel Burn +15%",modifiers:{[C.MOD_TRAVEL_SPEED]:.95,[C.MOD_FUEL_BURN]:1.15}},UPGRADE_ENGINE_II:{id:"UPGRADE_ENGINE_II",name:"Engine Mod II",value:15e3,pillColor:P.BLUE,description:"High-performance injectors boost ship speed by 10% while requiring 30% more fuel per trip.",statText:"Travel Speed +10%, Fuel Burn +30%",modifiers:{[C.MOD_TRAVEL_SPEED]:.9,[C.MOD_FUEL_BURN]:1.3}},UPGRADE_ENGINE_III:{id:"UPGRADE_ENGINE_III",name:"Engine Mod III",value:45e3,pillColor:P.BLUE,description:"Experimental overcharged drives maximize travel speed by 25% for a 45% increase in fuel costs.",statText:"Travel Speed +25%, Fuel Burn +45%",modifiers:{[C.MOD_TRAVEL_SPEED]:.75,[C.MOD_FUEL_BURN]:1.45}},UPGRADE_SIGNAL_I:{id:"UPGRADE_SIGNAL_I",name:"Signal Hacker",value:5e3,pillColor:P.CYAN,description:"A basic encryption bypass grants a 3% discount on all commodity purchases.",statText:"Market Buy Price -3%",modifiers:{[C.MOD_BUY_PRICE]:.97}},UPGRADE_SIGNAL_II:{id:"UPGRADE_SIGNAL_II",name:"Signal Hacker II",value:15e3,pillColor:P.CYAN,description:"Advanced market spoofing protocols reduce the cost of all purchased goods by 5%.",statText:"Market Buy Price -5%",modifiers:{[C.MOD_BUY_PRICE]:.95}},UPGRADE_SIGNAL_III:{id:"UPGRADE_SIGNAL_III",name:"Signal Hacker III",value:45e3,pillColor:P.CYAN,description:"Military-grade signal interceptors secure a 7% reduction in market buy prices system-wide.",statText:"Market Buy Price -7%",modifiers:{[C.MOD_BUY_PRICE]:.93}},UPGRADE_ARMOR_I:{id:"UPGRADE_ARMOR_I",name:"Hull Armor",value:5e3,pillColor:P.GREEN,description:"Reinforced duralium plating increases the vessel's maximum hull capacity by 10%.",statText:"Max Hull +10%",modifiers:{[C.MOD_MAX_HULL]:.1}},UPGRADE_ARMOR_II:{id:"UPGRADE_ARMOR_II",name:"Hull Armor II",value:15e3,pillColor:P.GREEN,description:"Multi-layered composite shielding provides a significant 20% boost to maximum hull integrity.",statText:"Max Hull +20%",modifiers:{[C.MOD_MAX_HULL]:.2}},UPGRADE_ARMOR_III:{id:"UPGRADE_ARMOR_III",name:"Hull Armor III",value:45e3,pillColor:P.GREEN,description:"Advanced reactive nanoweave armor maximizes ship survivability with a 30% hull capacity increase.",statText:"Max Hull +30%",modifiers:{[C.MOD_MAX_HULL]:.3}},UPGRADE_TANK_I:{id:"UPGRADE_TANK_I",name:"Auxiliary Tank",value:5e3,pillColor:P.GOLD,description:"External fuel pods extend the ship's maximum range by 10% capacity.",statText:"Max Fuel +10%",modifiers:{[C.MOD_MAX_FUEL]:.1}},UPGRADE_TANK_II:{id:"UPGRADE_TANK_II",name:"Auxiliary Tank II",value:15e3,pillColor:P.GOLD,description:"Internal pressurized reservoirs provide a 20% increase to total fuel storage efficiency.",statText:"Max Fuel +20%",modifiers:{[C.MOD_MAX_FUEL]:.2}},UPGRADE_TANK_III:{id:"UPGRADE_TANK_III",name:"Auxiliary Tank III",value:45e3,pillColor:P.GOLD,description:"High-capacity cryo-storage cells expand the vessel's fuel reserves by 30%.",statText:"Max Fuel +30%",modifiers:{[C.MOD_MAX_FUEL]:.3}},UPGRADE_RADAR_I:{id:"UPGRADE_RADAR_I",name:"Radar Mod",value:5e3,pillColor:P.GREY,description:"Enhanced sensors improve long-range detection, increasing random event frequency by a flat +3%.",statText:"Event Chance +3%",modifiers:{[C.MOD_EVENT_CHANCE]:.03}},UPGRADE_RADAR_II:{id:"UPGRADE_RADAR_II",name:"Radar Mod II",value:15e3,pillColor:P.GREY,description:"Wide-spectrum scanning arrays boost the chance of encountering space-faring events by a flat +6%.",statText:"Event Chance +6%",modifiers:{[C.MOD_EVENT_CHANCE]:.06}},UPGRADE_RADAR_III:{id:"UPGRADE_RADAR_III",name:"Radar Mod III",value:45e3,pillColor:P.GREY,description:"Predictive deep-space arrays maximize event discovery with a flat +10% increase in encounter rates.",statText:"Event Chance +10%",modifiers:{[C.MOD_EVENT_CHANCE]:.1}},UPGRADE_FUELPASS_I:{id:"UPGRADE_FUELPASS_I",name:"Fuel Pass",value:5e3,pillColor:P.INDIGO,description:"A standard fueling subscription secures a baseline 20% discount at all participating starports.",statText:"Refuel Cost -20%",modifiers:{[C.MOD_FUEL_PRICE]:.8}},UPGRADE_FUELPASS_II:{id:"UPGRADE_FUELPASS_II",name:"Fuel Pass II",value:15e3,pillColor:P.INDIGO,description:"This premium fueling membership utilizes encrypted credentials to grant 50% off all propellant purchases.",statText:"Refuel Cost -50%",modifiers:{[C.MOD_FUEL_PRICE]:.5}},UPGRADE_FUELPASS_III:{id:"UPGRADE_FUELPASS_III",name:"Fuel Pass III",value:45e3,pillColor:P.INDIGO,description:"Elite system-wide fueling clearance provides a permanent 75% discount on all vessel refueling costs.",statText:"Refuel Cost -75%",modifiers:{[C.MOD_FUEL_PRICE]:.25}},UPGRADE_REPAIRPASS_I:{id:"UPGRADE_REPAIRPASS_I",name:"Repair Pass",value:5e3,pillColor:P.EMERALD,description:"Standard maintenance coverage grants holders a basic 20% discount on all station repair services.",statText:"Repair Cost -20%",modifiers:{[C.MOD_REPAIR_COST]:.8}},UPGRADE_REPAIRPASS_II:{id:"UPGRADE_REPAIRPASS_II",name:"Repair Pass II",value:15e3,pillColor:P.EMERALD,description:"Priority dockyard membership utilizes corporate clearance to secure a 50% reduction in repair fees.",statText:"Repair Cost -50%",modifiers:{[C.MOD_REPAIR_COST]:.5}},UPGRADE_REPAIRPASS_III:{id:"UPGRADE_REPAIRPASS_III",name:"Repair Pass III",value:45e3,pillColor:P.EMERALD,description:"Ultimate platinum-tier coverage provides total system-wide protection with 75% off all hull maintenance.",statText:"Repair Cost -75%",modifiers:{[C.MOD_REPAIR_COST]:.25}},UPGRADE_NANO_I:{id:"UPGRADE_NANO_I",name:"Nano Machines",value:5e3,pillColor:P.SEAFOAM,description:"Basic self-repairing drones restore 0.3% of total hull integrity per day in transit.",statText:"Daily Hull Repair +0.3%",modifiers:{[C.MOD_PASSIVE_REPAIR]:.003}},UPGRADE_NANO_II:{id:"UPGRADE_NANO_II",name:"Nano Machines II",value:15e3,pillColor:P.SEAFOAM,description:"Advanced micro-repair swarms regenerate 0.7% of the vessel's hull daily while traveling.",statText:"Daily Hull Repair +0.7%",modifiers:{[C.MOD_PASSIVE_REPAIR]:.007}},UPGRADE_NANO_III:{id:"UPGRADE_NANO_III",name:"Nano Machines III",value:45e3,pillColor:P.SEAFOAM,description:"Superior nanobot hives provide rapid autonomous repair, restoring 1.2% of hull health daily.",statText:"Daily Hull Repair +1.2%",modifiers:{[C.MOD_PASSIVE_REPAIR]:.012}},UPGRADE_STORAGE_I:{id:"UPGRADE_STORAGE_I",name:"Auxiliary Storage",value:5e3,pillColor:P.ORANGE,description:"Modular storage racks expand the ship's total cargo capacity by 10%.",statText:"Max Cargo +10%",modifiers:{[C.MOD_MAX_CARGO]:.1}},UPGRADE_STORAGE_II:{id:"UPGRADE_STORAGE_II",name:"Auxiliary Storage II",value:15e3,pillColor:P.ORANGE,description:"High-density pallet systems increase the vessel's available cargo space by 20%.",statText:"Max Cargo +20%",modifiers:{[C.MOD_MAX_CARGO]:.2}},UPGRADE_STORAGE_III:{id:"UPGRADE_STORAGE_III",name:"Auxiliary Storage III",value:45e3,pillColor:P.ORANGE,description:"Advanced sub-spatial folding technology maximizes cargo capacity with a 30% increase.",statText:"Max Cargo +30%",modifiers:{[C.MOD_MAX_CARGO]:.3}},UPGRADE_GUILD_I:{id:"UPGRADE_GUILD_I",name:"Guild Badge",value:5e3,pillColor:P.RED,description:"Merchant's Guild recognition increases the resale value of all commodities by 3%.",statText:"Market Sell Price +3%",modifiers:{[C.MOD_SELL_PRICE]:1.03}},UPGRADE_GUILD_II:{id:"UPGRADE_GUILD_II",name:"Guild Badge II",value:15e3,pillColor:P.RED,description:"Senior Guild credentials secure a 5% bonus on all goods sold at market.",statText:"Market Sell Price +5%",modifiers:{[C.MOD_SELL_PRICE]:1.05}},UPGRADE_GUILD_III:{id:"UPGRADE_GUILD_III",name:"Guild Badge III",value:45e3,pillColor:P.RED,description:"Elite Guild partnership status maximizes profits with a 7% increase to sell prices.",statText:"Market Sell Price +7%",modifiers:{[C.MOD_SELL_PRICE]:1.07}},UPGRADE_SYNDICATE_I:{id:"UPGRADE_SYNDICATE_I",name:"Syndicate Badge",value:5e3,pillColor:P.VIOLET,description:"Syndicate influence reduces the monthly interest rate on your debt by 20%.",statText:"Debt Interest -20%",modifiers:{[C.MOD_DEBT_INTEREST]:.8}},UPGRADE_SYNDICATE_II:{id:"UPGRADE_SYNDICATE_II",name:"Syndicate Badge II",value:15e3,pillColor:P.VIOLET,description:"Established Syndicate connections secure a 30% reduction in monthly interest accrual.",statText:"Debt Interest -30%",modifiers:{[C.MOD_DEBT_INTEREST]:.7}},UPGRADE_SYNDICATE_III:{id:"UPGRADE_SYNDICATE_III",name:"Syndicate Badge III",value:45e3,pillColor:P.VIOLET,description:"Deep Syndicate ties provide a 50% discount on all monthly debt interest charges.",statText:"Debt Interest -50%",modifiers:{[C.MOD_DEBT_INTEREST]:.5}}};var x={getDefinition(c){return at[c]||null},getAllUpgradeIds(){return Object.keys(at)},getShipAttributes(c){return[]},getStationQuirks(c){return[]},_getMultiplicativeModifier(c,e){let t=1;return c.forEach(i=>{let a=this.getDefinition(i);a&&a.modifiers&&a.modifiers[e]!==void 0&&(t*=a.modifiers[e])}),t},_getAdditiveModifier(c,e,t){let i=t;return c.forEach(a=>{let s=this.getDefinition(a);s&&s.modifiers&&s.modifiers[e]!==void 0&&(i+=s.modifiers[e])}),i},getFuelBurnModifier(c=[]){return this._getMultiplicativeModifier(c,C.MOD_FUEL_BURN)},getFuelPriceModifier(c=[]){return this._getMultiplicativeModifier(c,C.MOD_FUEL_PRICE)},getTravelTimeModifier(c=[]){return this._getMultiplicativeModifier(c,C.MOD_TRAVEL_SPEED)},getEventChanceModifier(c=[]){return this._getAdditiveModifier(c,C.MOD_EVENT_CHANCE,0)},getPriceModifier(c=[],e){let t=e==="buy"?C.MOD_BUY_PRICE:C.MOD_SELL_PRICE;return this._getMultiplicativeModifier(c,t)},getServiceCostModifier(c=[],e){return e==="refuel"?this.getFuelPriceModifier(c):this._getMultiplicativeModifier(c,C.MOD_REPAIR_COST)},getMaxHullModifier(c=[]){return this._getAdditiveModifier(c,C.MOD_MAX_HULL,1)},getMaxFuelModifier(c=[]){return this._getAdditiveModifier(c,C.MOD_MAX_FUEL,1)},getMaxCargoModifier(c=[]){return this._getAdditiveModifier(c,C.MOD_MAX_CARGO,1)},getInterestModifier(c=[]){return this._getMultiplicativeModifier(c,C.MOD_DEBT_INTEREST)},getPassiveRepairRate(c=[]){return this._getAdditiveModifier(c,C.MOD_PASSIVE_REPAIR,0)}};var st={"Wanderer.Ship":6,"Mule.Ship":8,"Nomad.Ship":6,"Mesa.Ship":8,"Pathfinder.Ship":7,"Pilgrim.Ship":8,"Meridian.Ship":8,"Raven.Ship":9,"Warden.Ship":11,"Aegis.Ship":6,"Forerunner.Ship":9,"Guardian.Ship":11,"Valiant.Ship":11,"Eagle.Ship":12,"Tundra.Ship":11,"Atlas.Ship":9,"Vindicator.Ship":9,"Aesudon.Ship":13,"Pterodactyl.Ship":14,"Sovereign.Ship":14,"Titan.Ship":11,"Citadel.Ship":20,"Sophistacles.Ship":17,"Thalassodromeus.Ship":13},ot={"Water Ice":1,Plasteel:1,Hydroponics:1,Cybernetics:1,"Refined Propellant":1,"Neural Processors":1,"Graphene Lattices":1,"Cryo-Sleep Pods":1,"Atmo Processors":1,"Cloned Organs":1,"Xeno-Geologicals":1,"Sentient AI Cores":1,Antimatter:1,"Folded-Space Drives":1};var re=class{static DB_NAME="OrbitalAssetsDB";static STORE_NAME="assets";static VERSION=1;static db=null;static async initDB(){if(!this.db)return new Promise((e,t)=>{let i=indexedDB.open(this.DB_NAME,this.VERSION);i.onupgradeneeded=a=>{let s=a.target.result;s.objectStoreNames.contains(this.STORE_NAME)||s.createObjectStore(this.STORE_NAME)},i.onsuccess=a=>{this.db=a.target.result,e()},i.onerror=a=>{console.error("AssetStorageService: DB Open Error",a),t(a)}})}static async saveAsset(e,t){return this.db||await this.initDB(),new Promise((i,a)=>{let r=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).put(t,e);r.onsuccess=()=>i(),r.onerror=n=>a(n)})}static async getAsset(e){return this.db||await this.initDB(),new Promise((t,i)=>{let o=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).get(e);o.onsuccess=r=>t(r.target.result),o.onerror=r=>i(r)})}static async hasAsset(e){return this.db||await this.initDB(),new Promise((t,i)=>{let o=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).count(e);o.onsuccess=r=>t(r.target.result>0),o.onerror=r=>i(r)})}};var B=class{static PLACEHOLDER="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";static blobCache=new Map;static async init(){await re.initDB()}static _generateShipPath(e,t){let i=p.SHIPS[e];if(!i)return null;let a=i.name,s=st[e]||5,o=Math.abs(t)%s,r=String.fromCharCode(65+o);return`assets/images/ships/${a}/${a}_${r}.jpeg`}static _generateCommodityPath(e,t){if(!e)return null;let i=ot[e];if(i===void 0&&(i=1),i<=0)return null;let a=Math.abs(t)%i,s=String.fromCharCode(65+a),o=e.replace(/ /g,"_");return`assets/images/commodities/${e}/${o}_${s}.png`}static getShipImage(e,t=0){let i=this._generateShipPath(e,t);return i?this.blobCache.has(i)?this.blobCache.get(i):i:""}static getFallbackImage(e){let t=p.SHIPS[e];if(!t)return"";let i=t.name;return`assets/images/ships/${i}/${i}_A.jpeg`}static getCommodityImage(e,t=0){let i=this._generateCommodityPath(e,t);return i?this.blobCache.has(i)?this.blobCache.get(i):i:""}static async hydrateAssets(e){let t=new Set;e.forEach(a=>{let s=null;if(a.type==="ship")s=this._generateShipPath(a.id,a.seed||0);else if(a.type==="commodity"){let o=p.COMMODITIES.find(r=>r.id===a.id)?.name;o&&(s=this._generateCommodityPath(o,a.seed||0))}else a.type==="location"&&a.path&&(s=a.path);s&&t.add(s)});let i=Array.from(t).map(async a=>{if(!this.blobCache.has(a)){try{let s=await re.getAsset(a);if(s){let o=URL.createObjectURL(s);this.blobCache.set(a,o);return}}catch(s){console.warn(`AssetService: DB read error for ${a}`,s)}try{let s=await fetch(a);if(!s.ok)throw new Error(`Network error ${s.status}`);let o=await s.blob();await re.saveAsset(a,o);let r=URL.createObjectURL(o);this.blobCache.set(a,r)}catch{}}});await Promise.all(i)}static async hydrateGameAssets(e){let t=e?.visualSeed||0,i=e?.revealedTier||1,a=e?.ownedShipIds||[],s=e?.activeShipId,o=[];[G.WANDERER,G.STALWART,G.MULE].forEach(r=>{o.push({type:"ship",id:r,seed:t})}),s&&o.push({type:"ship",id:s,seed:t}),a.forEach(r=>o.push({type:"ship",id:r,seed:t})),p.COMMODITIES.forEach(r=>{r.tier<=i&&o.push({type:"commodity",id:r.id,seed:t})}),console.log(`[AssetService] Hydrating ${o.length} Critical Assets...`),await this.hydrateAssets(o),setTimeout(()=>{this.hydrateAllShips(t),this.hydrateAllCommodities(t);let r=[];p.MARKETS.forEach(n=>{n.bgImage&&r.push({type:"location",path:n.bgImage}),n.imagePath&&r.push({type:"location",path:n.imagePath})}),r.length>0&&this.hydrateAssets(r)},2e3)}static hydrateAllShips(e=0){let t=Object.keys(p.SHIPS).map(i=>({type:"ship",id:i,seed:e}));console.log(`[AssetService] Background hydrating all ${t.length} ships...`),this.hydrateAssets(t)}static hydrateAllCommodities(e=0){let t=p.COMMODITIES.map(i=>({type:"commodity",id:i.id,seed:e}));console.log(`[AssetService] Background hydrating all ${t.length} commodities...`),this.hydrateAssets(t)}static preloadBuffer(e,t,i,a){let s=Math.max(0,t-i),o=Math.min(e.length-1,t+i),r=[];for(let n=s;n<=o;n++)r.push({type:"ship",id:e[n],seed:a});this.hydrateAssets(r)}static performInitialPreload(e,t){let{player:i,market:a}=e,s=t?i.ownedShipIds:Object.keys(a.shipyardStock||{}).map(r=>r),o=t?e.uiState.hangarActiveIndex||0:e.uiState.shipyardActiveIndex||0;this.preloadBuffer(s,o,5,i.visualSeed)}};var fe=class{constructor(e){this.gameState=e,this._currentSystemState=null,this._systemStateExpirationDay=0}getPrice(e,t,i=!1){let a=this.gameState.getState().activeIntelDeal,s=this.gameState.market.prices[e]?.[t]||0;if(a&&a.locationId===e&&a.commodityId===t&&(s=this.gameState.market.prices[e]?.[t]||a.overridePrice),i){let o=this.gameState.player.activeShipId;if(o&&this.gameState.player.shipStates[o]){let r=this.gameState.player.shipStates[o].upgrades||[],n=x.getPriceModifier(r,"buy");s=s*n}}return Math.max(1,Math.round(s))}getGalacticAverage(e){return this.gameState.market.galacticAverages[e]||0}checkForSystemStateChange(){if(this.gameState.day>this._systemStateExpirationDay){let e=Object.keys(p.SYSTEM_STATES),t=e[Math.floor(Math.random()*e.length)];this._currentSystemState=p.SYSTEM_STATES[t],this._systemStateExpirationDay=this.gameState.day+this._currentSystemState.duration}}evolveMarketPrices(){p.MARKETS.forEach(e=>{p.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.activeIntelDeal;if(i&&i.locationId===e.id&&i.commodityId===t.id){let A=i.overridePrice,k=.03,N=A*(1-k),L=A*(1+k),O=Math.random()*(L-N)+N;this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(O));return}let a=this.gameState.market.inventory[e.id][t.id],s=this.gameState.market.prices[e.id][t.id],o=this.gameState.market.galacticAverages[t.id],n=(1-(e.availabilityModifier?.[t.id]??1))*o,l=o+n*$.LOCAL_PRICE_MOD_STRENGTH,d=$.DAILY_PRICE_VOLATILITY,h=$.MEAN_REVERSION_STRENGTH,u=this._currentSystemState?.modifiers?.commodity?.[t.id];u&&(u.volatility_mult&&(d*=u.volatility_mult),u.mean_reversion_mult&&(h*=u.mean_reversion_mult));let m=t.basePriceRange[1]-t.basePriceRange[0],g=(Math.random()-.5)*m*d,f=(l-s)*h;this.gameState.day<a.priceLockEndDay&&(f=0),a.rivalArbitrage.isActive&&this.gameState.day<a.rivalArbitrage.endDay?f=(l-s)*.2:a.rivalArbitrage.isActive&&(a.rivalArbitrage.isActive=!1),a.hoverUntilDay>this.gameState.day?f*=.1:a.hoverUntilDay>0&&(a.hoverUntilDay=0);let S=0;this.gameState.day>=a.lastPlayerInteractionTimestamp+7&&a.lastPlayerInteractionTimestamp>0&&(S=l*a.marketPressure*-1*.5);let b=1;a.isDepleted&&this.gameState.day<a.depletionDay+7&&(b=1.5);let E=s+g+f+S*b;this._currentSystemState?.modifiers?.commodity?.[t.id]?.price&&(E*=this._currentSystemState.modifiers.commodity[t.id].price),this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(E)),a.marketPressure*=$.MARKET_PRESSURE_DECAY,Math.abs(a.marketPressure)<.001&&(a.marketPressure=0)}),this._recordPriceHistory(e.id)})}replenishMarketInventory(){p.MARKETS.forEach(e=>{p.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id];if(i.lastPlayerInteractionTimestamp>0&&this.gameState.day-i.lastPlayerInteractionTimestamp>120)i.quantity=this._calculateBaselineStock(e,t),i.lastPlayerInteractionTimestamp=0,i.marketPressure=0,i.depletionDay=0,i.priceLockEndDay=0;else{let[r,n]=t.canonicalAvailability,l=(r+n)/2*(e.availabilityModifier?.[t.id]??1),d=i.marketPressure;d<0&&this.gameState.day<i.lastPlayerInteractionTimestamp+7&&(d=0),d>0&&(d=0);let h=1-Math.min(.5,d*.5),g=(l*h-i.quantity)*.1,f=0;i.isDepleted?(f=oe(1,5),i.isDepleted=!1):i.quantity<=0&&(f=oe(1,5)),i.quantity+=g+f}let a=Math.random()*.15+.15,s=Math.random()<.5?-1:1,o=1+a*s;i.quantity*=o,this._currentSystemState?.modifiers?.commodity?.[t.id]?.availability&&(i.quantity*=this._currentSystemState.modifiers.commodity[t.id].availability),i.quantity=Math.max(0,Math.round(i.quantity))})})}applyMarketImpact(e,t,i){let a=p.COMMODITIES.find(h=>h.id===e),s=this.gameState.market.inventory[this.gameState.currentLocationId][e],o=t/(a.canonicalAvailability[1]||100)*a.tier/10;i==="buy"?s.marketPressure-=o:s.marketPressure+=o;let r=(this.gameState.day-1)%365+1,n,l;r<=182?(n=75,l=120):(n=105,l=195);let d=Math.floor(Math.random()*(l-n+1))+n;s.priceLockEndDay=this.gameState.day+d,s.lastPlayerInteractionTimestamp=this.gameState.day}checkDepletion(e,t,i,a){let s=p.MARKETS.find(f=>f.id===this.gameState.currentLocationId),[o,r]=e.canonicalAvailability,n=s.availabilityModifier?.[e.id]??1,l=(o+r)/2*n,d=t.marketPressure;d>0&&(d=0);let h=1-Math.min(.5,d*.5),m=Math.max(1,l*h)*.08;i>=m&&a>t.depletionBonusDay+365&&(t.isDepleted=!0,t.depletionDay=a,t.depletionBonusDay=a)}_calculateBaselineStock(e,t){let[i,a]=t.canonicalAvailability,s=e.availabilityModifier?.[t.id]??1;return Math.floor(oe(i,a)*s)}_recordPriceHistory(e=null){if(!this.gameState||!this.gameState.market)return;let t=e||this.gameState.currentLocationId;this.gameState.market.priceHistory[t]||(this.gameState.market.priceHistory[t]={}),p.COMMODITIES.forEach(i=>{if(i.tier>this.gameState.player.revealedTier)return;this.gameState.market.priceHistory[t][i.id]||(this.gameState.market.priceHistory[t][i.id]=[]);let a=this.gameState.market.priceHistory[t][i.id],s=this.gameState.market.prices[t][i.id],o=a[a.length-1];for(o&&o.day===this.gameState.day?o.price!==s&&(o.price=s):a.push({day:this.gameState.day,price:s});a.length>$.PRICE_HISTORY_LENGTH;)a.shift()})}_updateShipyardStock(){let{player:e}=this.gameState;e.unlockedLocationIds.forEach(t=>{let i=this.gameState.market.shipyardStock[t];if(i&&i.day===this.gameState.day)return;let a=Object.entries(p.SHIPS).filter(([n,l])=>!l.isRare&&l.saleLocationId===t&&!e.ownedShipIds.includes(n)),s=Object.entries(p.SHIPS).filter(([n,l])=>l.isRare&&l.saleLocationId===t&&!e.ownedShipIds.includes(n)),o=[...a.map(n=>n[0])];s.forEach(([n,l])=>{Math.random()<$.RARE_SHIP_CHANCE&&o.push(n)}),this.gameState.market.shipyardStock[t]={day:this.gameState.day,shipsForSale:o};let r=o.map(n=>({type:"ship",id:n,seed:e.visualSeed}));B.hydrateAssets(r)})}};var ye=class{constructor(e,t,i,a){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=a}start(){this.gameState.introSequenceActive&&(this.logger.info.state(this.gameState.day,"INTRO_START","Starting new game introduction sequence."),this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.gameState.player.introStep=0,this._showNextModal())}handleIntroClick(e){let t=e.target.closest("button");if(!t)return;let i=t.id;if(i==="intro-next-btn")t.disabled=!0,this._showNextModal();else if(i==="intro-submit-btn"){t.disabled=!0;let o=document.getElementById("signature-input").value.trim().replace(/[^a-zA-Z0-9 ]/g,"");!o||o.length===0?this.uiManager.queueModal("event-modal","Invalid Signature","The Merchant's Guild requires a valid name on the contract. Please provide your legal mark.",()=>{this.gameState.player.introStep--,this._showNextModal()}):(this.gameState.player.name=o,this.gameState.player.debt=25e3,this.gameState.player.loanStartDate=this.gameState.day,this.gameState.player.monthlyInterestAmount=390,this.logger.info.state(this.gameState.day,"LOAN_ACCEPTED",`Player ${o} accepted Guild loan.`,{debt:25e3,name:o}),this._startProcessingSequence())}}continueAfterTutorial(e){e==="intro_hangar"?(this.simulationService.setScreen(H.DATA,_.FINANCE),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_FINANCE"})):e==="intro_finance"&&this._end()}_showNextModal(){let e=p.INTRO_SEQUENCE_V1.modals[this.gameState.player.introStep];if(!e){this._end();return}let t={buttonClass:e.buttonClass,contentClass:e.contentClass};this.gameState.player.introStep===0&&(t.specialClass="intro-fade-in");let i="event-modal";e.id==="charter"||e.id==="signature"?(i=`${e.id}-modal`,t.customSetup=(a,s)=>{this._setupInteractiveModal(a,e,s)}):t.customSetup=(a,s)=>{let o=a.querySelector("#event-button-container");if(!o)return;o.innerHTML="";let r=document.createElement("button");r.className="btn px-6 py-2",e.buttonClass&&r.classList.add(e.buttonClass),r.id="intro-next-btn",r.innerHTML=e.buttonText,r.onclick=n=>{n.target.disabled=!0,s()},o.appendChild(r)},this.uiManager.queueModal(i,e.title,e.description,()=>this.gameState.player.introStep++,t)}_setupInteractiveModal(e,t,i){let a=e.querySelector(`#${t.id}-button-container`);a.innerHTML="";let s=document.createElement("button");if(s.className="btn px-6 py-2",s.innerHTML=t.buttonText,s.onclick=o=>{o.target.disabled=!0,i()},a.appendChild(s),t.id==="signature"){let o=e.querySelector("#signature-input");o.value="",s.id="intro-submit-btn",s.disabled=!0,s.onclick=i,o.oninput=()=>{s.disabled=o.value.trim()===""}}else s.id="intro-next-btn"}_startProcessingSequence(){let e=()=>{let t="Loan Approved",i=`Dear ${this.gameState.player.name},<br><br>Your line of credit has been <b>approved</b>.<br><br><span class="credits-text-pulsing">\u232C 25,000</span> is ready to transfer to your account.`,a=s=>{let o=s.target;o&&(o.disabled=!0),this.uiManager.createFloatingText(`+${v(25e3,!1)}`,s.clientX,s.clientY,"#34d399"),this.gameState.player.credits=Math.min(Number.MAX_SAFE_INTEGER,this.gameState.player.credits+25e3),this.logger.info.player(this.gameState.day,"CREDITS_TRANSFER","Accepted loan transfer of \u232C25,000"),setTimeout(()=>{this.uiManager.showGameContainer(),this.uiManager.render(this.gameState.getState()),this.simulationService.setScreen(H.STARPORT,_.HANGAR),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_HANGAR"})},2e3)};this.uiManager.queueModal("event-modal",t,i,null,{contentClass:"text-center",customSetup:(s,o)=>{s.querySelector(".modal-content").classList.add("modal-theme-admin");let r=s.querySelector("#event-button-container");r.innerHTML="";let n=document.createElement("button");n.className="btn px-6 py-2",n.innerHTML="Accept Transfer",n.onclick=l=>{a(l),o()},r.appendChild(n)}})};this.uiManager.showProcessingAnimation(this.gameState.player.name,e)}_end(){this.gameState.introSequenceActive=!1,this.logger.info.state(this.gameState.day,"INTRO_END","Introduction sequence complete.");let e=p.INTRO_SEQUENCE_V1.modals.find(a=>a.id==="final"),t=p.SHIPS[this.gameState.player.activeShipId].name,i=e.buttonText.replace("{shipName}",t);this.gameState.tutorials.navLock={navId:H.DATA,screenId:_.FINANCE},this.uiManager.queueModal("event-modal",e.title,e.description,()=>{this.simulationService.setScreen(H.DATA,_.MISSIONS),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_MISSIONS"})},{buttonText:i}),this.uiManager.render(this.gameState.getState())}};var ve=class{constructor(e,t,i,a,s,o,r){this.gameState=e,this.uiManager=t,this.missionService=i,this.marketService=a,this.timeService=s,this.logger=o,this.simulationService=r,this.isTransactionInProgress=!1}buyItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return!1;let a=p.COMMODITIES.find(A=>A.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),!1;let s=this.uiManager.getItemPrice(i,e),o=i.player.activeShipId,n=i.player.shipStates[o].upgrades||[],l=x.getPriceModifier(n,"buy"),h=Math.max(1,Math.round(s*l))*t,u=i.market.inventory[i.currentLocationId][e].quantity;if(u<=0)return this.uiManager.queueModal("event-modal","Sold Out",`This station has no more ${a.name} available.`),!1;if(t>u)return this.uiManager.queueModal("event-modal","Limited Stock",`This station only has ${u} units available.`),!1;let m=this.simulationService.getEffectiveShipStats(o),g=this.simulationService._getActiveInventory();if(Y(g)+t>m.cargoCapacity)return this.uiManager.queueModal("event-modal","Cargo Hold Full","You don't have enough space."),!1;if(i.player.credits<h)return this.uiManager.queueModal("event-modal","Insufficient Funds","Your credit balance is too low."),!1;let f=this.gameState.market.inventory[i.currentLocationId][e],S=f.quantity;f.quantity-=t,f.quantity<=0&&this.marketService.checkDepletion(a,f,S,i.day);let y=t;x.getShipAttributes(o).includes("ATTR_TRADER")&&Math.random()<.15&&(y+=1,this.uiManager.createFloatingText("+1 Bonus!",window.innerWidth/2,window.innerHeight/2,"#34d399"),this.logger.info.player(i.day,"ATTR_TRIGGER",`Trader perk triggered: +1 ${a.name}.`));let E=g[e];return E.avgCost=(E.quantity*E.avgCost+h)/(E.quantity+y),E.quantity+=y,this.gameState.player.credits-=h,this.logger.info.player(i.day,"BUY",`Bought ${t}x ${a.name} for ${v(h)}`),this.simulationService._logConsolidatedTrade(a.name,t,-h),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"buy"),this.gameState.uiState.lastTransactionTimestamp=Date.now(),this.gameState.setState({}),!0}sellItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return 0;let a=p.COMMODITIES.find(f=>f.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),0;let o=this.simulationService._getActiveInventory()[e];if(!o||o.quantity<t)return this.uiManager.queueModal("event-modal","Insufficient Inventory",`You do not have ${t} units of ${a.name} to sell.`),0;let r=i.player.activeShipId,l=i.player.shipStates[r].upgrades||[],{totalPrice:d}=this.uiManager._calculateSaleDetails(e,t),h=d,u=x.getPriceModifier(l,"sell");h=Math.floor(h*u);let m=h-o.avgCost*t;if(m>0){let f=(i.player.activePerks[R.TRADEMASTER]?p.PERKS[R.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);h+=m*f}h=Math.floor(h),this.gameState.player.credits=Math.min(Number.MAX_SAFE_INTEGER,this.gameState.player.credits+h),o.quantity-=t,o.quantity===0&&(o.avgCost=0);let g=this.gameState.market.inventory[i.currentLocationId][e];return g.quantity+=t,this.logger.info.player(i.day,"SELL",`Sold ${t}x ${a.name} for ${v(h)}`),this.simulationService._logConsolidatedTrade(a.name,t,h),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"sell"),this.gameState.uiState.lastTransactionTimestamp=Date.now(),this.gameState.setState({}),h}validateBuyShip(e){if(this.isTransactionInProgress)return{success:!1,errorTitle:"Transaction in Progress",errorMessage:"Please wait for the current transaction to complete."};let t=p.SHIPS[e];return t?this.gameState.player.credits<t.price?{success:!1,errorTitle:"Insufficient Funds",errorMessage:"You cannot afford this ship."}:{success:!0}:(this.logger.error("PlayerActionService",`validateBuyShip called with invalid shipId: ${e}`),{success:!1,errorTitle:"Ship Not Found",errorMessage:"The selected ship does not exist in the database."})}executeBuyShip(e,t){this.isTransactionInProgress=!0;try{let i=p.SHIPS[e];if(!i)return this.logger.error("PlayerActionService",`executeBuyShip called with invalid shipId: ${e}`),null;this.gameState.player.credits-=i.price,this.logger.info.player(this.gameState.day,"SHIP_PURCHASE",`Purchased ${i.name} for ${v(i.price)}.`),t&&this.uiManager.createFloatingText(`-${v(i.price,!1)}`,t.clientX,t.clientY,"#f87171"),this.simulationService._logTransaction("ship",-i.price,`Purchased ${i.name}`),this.simulationService.addShipToHangar(e);let a=this.simulationService._getShipyardInventory(),s=this.gameState.uiState.shipyardActiveIndex||0,o=Math.min(s,Math.max(0,a.length-1));this.gameState.tutorials.activeBatchId==="intro_hangar"&&(this.simulationService.setHangarShipyardMode("hangar"),this.simulationService.tutorialService.checkState({type:"ACTION",action:w.BUY_SHIP}));let r=`var(--class-${i.class.toLowerCase()}-color)`,n="";i.class==="Z"?n="glow-text-z":i.class==="O"?n="glow-text-o":i.class==="S"&&(n="glow-text-s");let d=`You purchased the ${`<span class="${n}" style="color: ${r}; font-weight: bold;">${i.name}</span>`} for <span class="text-glow-red">${v(-i.price,!0)}</span>. This ship has been stored in your Hangar.`;return this.uiManager.queueModal("event-modal","Vessel Purchased",d),this.gameState.setState({uiState:{...this.gameState.uiState,shipyardActiveIndex:o,lastTransactionTimestamp:Date.now()}}),i}finally{setTimeout(()=>{this.isTransactionInProgress=!1},100)}}validateSellShip(e){if(this.isTransactionInProgress)return{success:!1,errorTitle:"Transaction in Progress",errorMessage:"Please wait for the current transaction to complete."};let t=this.gameState.getState();if(t.player.ownedShipIds.length<=1)return{success:!1,errorTitle:"Action Blocked",errorMessage:"You cannot sell your last remaining ship."};if(e===t.player.activeShipId)return{success:!1,errorTitle:"Action Blocked",errorMessage:"You cannot sell your active ship."};if(Y(t.player.inventories[e])>0)return{success:!1,errorTitle:"Cannot Sell Ship",errorMessage:"This vessel's cargo hold is not empty."};let i=p.SHIPS[e];return i?{success:!0,ship:i}:(this.logger.error("PlayerActionService",`validateSellShip called with invalid shipId: ${e}`),{success:!1,errorTitle:"Ship Not Found",errorMessage:"The selected ship does not exist."})}executeSellShip(e,t){this.isTransactionInProgress=!0;try{let i=p.SHIPS[e],a=this.gameState.player.shipStates[e];if(!i||!a)return this.logger.error("PlayerActionService",`executeSellShip called with invalid shipId or state: ${e}`),!1;let s=0;a.upgrades&&Array.isArray(a.upgrades)&&a.upgrades.forEach(g=>{let f=x.getDefinition(g);f&&(s+=f.value)});let o=i.price+s,r=Math.floor(o*$.SHIP_SELL_MODIFIER);this.gameState.player.credits=Math.min(Number.MAX_SAFE_INTEGER,this.gameState.player.credits+r),this.logger.info.player(this.gameState.day,"SHIP_SALE",`Sold ${i.name} (with upgrades) for ${v(r)}.`),t&&this.uiManager.createFloatingText(`+${v(r,!1)}`,t.clientX,t.clientY,"#34d399"),this.simulationService._logTransaction("ship",r,`Sold ${i.name}`);let n=this.gameState.player.ownedShipIds.indexOf(e);this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(g=>g!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e];let l=this.gameState.uiState.hangarActiveIndex;n<l&&l--,l>=this.gameState.player.ownedShipIds.length&&(l=Math.max(0,this.gameState.player.ownedShipIds.length-1));let d=`var(--class-${i.class.toLowerCase()}-color)`,h="";i.class==="Z"?h="glow-text-z":i.class==="O"?h="glow-text-o":i.class==="S"&&(h="glow-text-s");let m=`You sold the ${`<span class="${h}" style="color: ${d}; font-weight: bold;">${i.name}</span>`} for <span class="credits-text-pulsing">+${v(r,!0)}</span>.`;return this.uiManager.queueModal("event-modal","Vessel Sold",m),this.gameState.setState({uiState:{...this.gameState.uiState,hangarActiveIndex:l,lastTransactionTimestamp:Date.now()}}),r}finally{setTimeout(()=>{this.isTransactionInProgress=!1},100)}}validateSetActiveShip(e){return this.isTransactionInProgress?{success:!1,errorTitle:"Transaction in Progress",errorMessage:"Please wait for the current transaction to complete."}:this.gameState.player.ownedShipIds.includes(e)?this.gameState.player.activeShipId===e?{success:!1,errorTitle:"Action Redundant",errorMessage:"This ship is already your active vessel."}:{success:!0}:(this.logger.error("PlayerActionService",`validateSetActiveShip called with unowned shipId: ${e}`),{success:!1,errorTitle:"Ship Not Found",errorMessage:"You do not own this ship."})}executeSetActiveShip(e){if(this.gameState.player.ownedShipIds.includes(e)){this.isTransactionInProgress=!0;try{this.gameState.player.activeShipId=e;let t=this.gameState.player.ownedShipIds.indexOf(e);t!==-1&&(this.gameState.uiState.hangarActiveIndex=t),this.logger.info.player(this.gameState.day,"SET_ACTIVE_SHIP",`Boarded the ${p.SHIPS[e].name}.`),this.gameState.setState({uiState:{...this.gameState.uiState,lastTransactionTimestamp:Date.now()}})}finally{setTimeout(()=>{this.isTransactionInProgress=!1},100)}}}payOffDebt(e){if(this.gameState.isGameOver)return;let{player:t}=this.gameState;if(t.credits<t.debt){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford to pay off your entire debt.");return}let i=t.debt;t.credits-=i,e&&this.uiManager.createFloatingText(`-${v(i,!1)}`,e.clientX,e.clientY,"#f87171"),this.logger.info.player(this.gameState.day,"DEBT_PAID",`Paid off ${v(i)} in debt.`),this.simulationService._logTransaction("loan",-i,`Paid off ${v(i)} debt`),t.debt=0,t.monthlyInterestAmount=0,t.loanStartDate=null,this.timeService._checkMilestones(),this.gameState.setState({})}takeLoan(e,t){let{player:i,day:a}=this.gameState;if(i.debt>0){this.uiManager.queueModal("event-modal","Loan Unavailable","You must pay off your existing debt first.");return}if(i.credits<e.fee){this.uiManager.queueModal("event-modal","Unable to Secure Loan",`The financing fee is ${v(e.fee)}, but you only have ${v(i.credits)}.`);return}i.credits-=e.fee,this.simulationService._logTransaction("loan",-e.fee,`Financing fee for ${v(e.amount)} loan`),i.credits=Math.min(Number.MAX_SAFE_INTEGER,i.credits+e.amount),t&&this.uiManager.createFloatingText(`+${v(e.amount,!1)}`,t.clientX,t.clientY,"#34d399"),this.simulationService._logTransaction("loan",e.amount,`Acquired ${v(e.amount)} loan`),i.debt+=e.amount,i.monthlyInterestAmount=e.interest,i.loanStartDate=a,i.seenGarnishmentWarning=!1;let s=`You've acquired a loan of <span class="credits-text-pulsing">${v(e.amount,!0)}</span>.<br>A financing fee of <span class="text-glow-red">${v(-e.fee,!0)}</span> was deducted.`;this.uiManager.queueModal("event-modal","Loan Acquired",s),this.logger.info.player(a,"LOAN_TAKEN",`Took a loan for ${v(e.amount)}.`),this.gameState.setState({})}purchaseLicense(e){let t=p.LICENSES[e],{player:i,day:a}=this.gameState;return t?t.type!=="purchase"?{success:!1,error:"NOT_FOR_PURCHASE"}:i.unlockedLicenseIds.includes(e)?{success:!1,error:"ALREADY_OWNED"}:i.credits<t.cost?{success:!1,error:"INSUFFICIENT_FUNDS"}:(i.credits-=t.cost,i.unlockedLicenseIds.push(e),this.logger.info.player(a,"LICENSE_PURCHASE",`Purchased ${t.name}.`),this.simulationService._logTransaction("license",-t.cost,`Purchased ${t.name}`),this.gameState.setState({}),{success:!0}):{success:!1,error:"INVALID_LICENSE"}}purchaseIntel(e){let{player:t,currentLocationId:i,day:a}=this.gameState;if(t.credits<e){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford this intel.");return}t.credits-=e,this.logger.info.player(a,"INTEL_PURCHASE",`Purchased intel for ${v(e)}.`),this.simulationService._logTransaction("intel",-e,"Purchased market intel"),this.gameState.intel.available[i]=!1;let s=p.MARKETS.filter(l=>l.id!==i&&t.unlockedLicenseIds.includes(l.id));if(s.length===0)return;let o=s[Math.floor(Math.random()*s.length)],r=p.COMMODITIES.filter(l=>l.tier<=t.revealedTier),n=r[Math.floor(Math.random()*r.length)];n&&(this.gameState.intel.active={targetMarketId:o.id,commodityId:n.id,type:"demand",startDay:a,endDay:a+100}),this.gameState.setState({})}refuelTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(!t)return 0;let i=this.simulationService.getEffectiveShipStats(t.id);if(e.player.shipStates[t.id].fuel>=i.maxFuel)return 0;let s=e.player.shipStates[t.id].upgrades||[],o=p.MARKETS.find(l=>l.id===e.currentLocationId).fuelPrice/2;e.player.activePerks[R.VENETIAN_SYNDICATE]&&e.currentLocationId===I.VENUS&&(o*=1-p.PERKS[R.VENETIAN_SYNDICATE].fuelDiscount);let r=x.getFuelPriceModifier(s);if(o*=r,o=Math.max(1,Math.round(o)),e.player.credits<o)return 0;e.player.credits-=o,e.player.shipStates[t.id].fuel=Math.min(i.maxFuel,e.player.shipStates[t.id].fuel+5),this.simulationService._logConsolidatedTransaction("fuel",-o,"Fuel Purchase");let n=document.getElementById("refuel-btn");if(n){let l=n.getBoundingClientRect(),d=l.left+l.width/2,h=l.top;this.uiManager.createFloatingText(`-${v(o,!1)}`,d,h,"#f87171")}return this.gameState.setState({}),o}repairTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(!t)return 0;let i=this.simulationService.getEffectiveShipStats(t.id);if(e.player.shipStates[t.id].health>=i.maxHealth)return 0;let s=e.player.shipStates[t.id].upgrades||[];if(x.getShipAttributes(t.id).includes("ATTR_BESPOKE"))return 0;let r=i.maxHealth*($.REPAIR_AMOUNT_PER_TICK/100),n=r*$.REPAIR_COST_PER_HP;e.player.activePerks[R.VENETIAN_SYNDICATE]&&e.currentLocationId===I.VENUS&&(n*=1-p.PERKS[R.VENETIAN_SYNDICATE].repairDiscount);let l=x.getServiceCostModifier(s,"repair");if(n*=l,n=Math.max(1,Math.round(n)),e.player.credits<n)return 0;e.player.credits-=n,e.player.shipStates[t.id].health=Math.min(i.maxHealth,e.player.shipStates[t.id].health+r),this.simulationService._logConsolidatedTransaction("repair",-n,"Hull Repairs"),this.simulationService._checkHullWarnings(t.id);let d=document.getElementById("repair-btn");if(d){let h=d.getBoundingClientRect(),u=h.left+h.width/2,m=h.top;this.uiManager.createFloatingText(`-${v(n,!1)}`,u,m,"#f87171")}return this.gameState.setState({}),n}validateInstallUpgrade(e,t){let i=this.gameState.getState(),a=i.player.shipStates[e];return!i.player.ownedShipIds.includes(e)||!a?{success:!1,error:"Ship not owned."}:i.player.activeShipId!==e?{success:!1,error:"Upgrades must be applied to the active ship."}:(a.upgrades||[]).length>=3?{success:!1,error:"Upgrade slots full."}:{success:!0}}executeInstallUpgrade(e,t){let i=this.gameState;i.player.shipStates[e].upgrades||(i.player.shipStates[e].upgrades=[]),i.player.shipStates[e].upgrades.push(t),this.logger.info.player(i.day,"UPGRADE_INSTALL",`Installed ${t} on ${e}.`),this.gameState.setState({})}};var Se=class{constructor(e,t,i,a,s){this.gameState=e,this.marketService=t,this.uiManager=i,this.logger=a,this.newsTickerService=s,this.simulationService=null,this.intelService=null}advanceDays(e){this.logger.group(`[System] Advancing time by ${e} day(s) from Day ${this.gameState.day}`),this.gameState.player.visualSeed=(this.gameState.player.visualSeed||0)+1;let t=this.gameState.player.activeShipId,i=this.gameState.player.shipStates[t],a=i?i.upgrades||[]:[];for(let s=0;s<e;s++){if(this.gameState.isGameOver){this.logger.groupEnd();return}this.gameState.day++,this.simulationService&&this.simulationService.pulseNewsTicker();let o=x.getPassiveRepairRate(a);if(o>0&&this.simulationService){let h=this.simulationService.getEffectiveShipStats(t);if(i.health<h.maxHealth){let u=h.maxHealth*o;i.health=Math.min(h.maxHealth,i.health+u)}}x.getShipAttributes(t).forEach(h=>{let u=x.getDefinition(h);u&&u.type===pe.MOD_HULL_DECAY&&u.mode==="flat_daily"&&i.health>1&&(i.health=Math.max(1,i.health-u.value))});let n=(this.gameState.day-1)%365,l=p.DATE_CONFIG.START_YEAR+Math.floor((this.gameState.day-1)/365);n===11&&l>this.gameState.player.lastBirthdayYear&&(this.gameState.player.playerAge++,this.gameState.player.birthdayProfitBonus+=.01,this.gameState.player.lastBirthdayYear=l,this.uiManager.queueModal("event-modal","Happy Birthday!",`You turned ${this.gameState.player.playerAge}. Your experience grants you a permanent +1% profit bonus on all trades.`)),this._checkAgeEvents(),this.marketService.evolveMarketPrices(),this.gameState.day-this.gameState.lastMarketUpdateDay>=7&&(this.marketService.checkForSystemStateChange(),this.marketService.replenishMarketInventory(),this.marketService._updateShipyardStock(),this.gameState.lastMarketUpdateDay=this.gameState.day);let d=this.gameState.activeIntelDeal;if(d&&this.gameState.day>d.expiryDay){let h=d;if(this.gameState.activeIntelDeal=null,h.sourceSaleLocationId&&h.sourcePacketId){let u=this.gameState.intelMarket[h.sourceSaleLocationId];u&&(this.gameState.intelMarket[h.sourceSaleLocationId]=u.filter(m=>m.id!==h.sourcePacketId))}this.simulationService.pushNewsMessage(`Intel on ${p.COMMODITIES.find(u=>u.id===h.commodityId).name} at ${p.MARKETS.find(u=>u.id===h.targetMarketId).name} has expired.`,"INTEL")}if(this.intelService&&this.gameState.day%120===1&&this.intelService.generateIntelRefresh(),this.gameState.player.ownedShipIds.forEach(h=>{if(h!==this.gameState.player.activeShipId){let u=p.SHIPS[h],m=u.maxHealth*$.PASSIVE_REPAIR_RATE;this.gameState.player.shipStates[h].health=Math.min(u.maxHealth,this.gameState.player.shipStates[h].health+m)}}),this.gameState.player.debt>0&&this.gameState.day-this.gameState.lastInterestChargeDay>=$.INTEREST_INTERVAL){let h=this.gameState.player.monthlyInterestAmount,u=x.getInterestModifier(a),m=Math.floor(h*u);this.gameState.player.debt+=m,this.simulationService&&this.simulationService._logTransaction("loan",m,"Monthly interest charge"),this.logger.info.system("Finance",this.gameState.day,"INTEREST",`Charged ${v(m)} interest on debt (Base: ${h}, Mod: ${u}).`),this.gameState.lastInterestChargeDay=this.gameState.day}this._applyGarnishment()}this.logger.groupEnd(),this.gameState.setState({})}_checkAgeEvents(){p.AGE_EVENTS.forEach(e=>{this.gameState.player.seenEvents.includes(e.id)||(e.trigger.day&&this.gameState.day>=e.trigger.day||e.trigger.credits&&this.gameState.player.credits>=e.trigger.credits)&&(this.gameState.player.seenEvents.push(e.id),this.uiManager.showAgeEventModal(e,t=>{this.simulationService&&this.simulationService._applyPerk(t)}))})}_checkMilestones(){let{credits:e,revealedTier:t}=this.gameState.player,i=t,a=je.find(s=>s.revealsTier===i+1);for(;a&&e>=a.threshold;)this.gameState.player.revealedTier=a.revealsTier,this.logger.info.player(this.gameState.day,"MILESTONE",`Wealth milestone reached! Tier ${a.revealsTier} commodities unlocked.`),this.uiManager.queueModal("event-modal","Market Update",`Your increasing wealth has granted you access to Tier ${a.revealsTier} commodities.`),i=a.revealsTier,a=je.find(s=>s.revealsTier===i+1);this.gameState.player.revealedTier!==t&&this.gameState.setState({})}_applyGarnishment(){let{player:e,day:t}=this.gameState;if(e.debt>0&&e.loanStartDate&&t-e.loanStartDate>=$.LOAN_GARNISHMENT_DAYS){if((t-this.gameState.lastInterestChargeDay)%$.INTEREST_INTERVAL!==0)return;let i=Math.floor(e.credits*$.LOAN_GARNISHMENT_PERCENT);i>0&&(e.credits-=i,this.simulationService&&(this.simulationService._logTransaction("debt",-i,"Monthly credit garnishment"),this.simulationService._checkGameOverConditions())),e.seenGarnishmentWarning||(this.uiManager.queueModal("event-modal","Credit Garnishment Notice","Your loan is delinquent. Your lender is now garnishing 14% of your credits monthly until the debt is paid.",null,{buttonClass:"bg-red-800/80"}),e.seenGarnishmentWarning=!0)}}getCurrentDay(){return this.gameState.day}};function rt(c,e,t,i){let a=e._getActiveShip(),s=Math.floor(c.player.credits*t.wagerPercentage),o=t.winChance[a.class]||.4;Math.random()<o?(c.player.credits=Math.min(Number.MAX_SAFE_INTEGER,c.player.credits+s),e._logTransaction("event",s,"Won space race wager"),i.description=`Your Class ${a.class} ship wins! You gain <span class="hl-green">${v(s)}</span>.`):(c.player.credits-=s,e._logTransaction("event",-s,"Lost space race wager"),i.description=`The luxury ship was too fast. You lose <span class="hl-red">${v(s)}</span>.`)}function nt(c,e,t){let i=e._getActiveShip(),a=c.player.shipStates[i.id],s=e._getActiveInventory();if(a.fuel=Math.max(0,a.fuel-30),s[M.CYBERNETICS]||(s[M.CYBERNETICS]={quantity:0,avgCost:0}),Y(s)+40<=i.cargoCapacity)return s[M.CYBERNETICS].quantity+=40,{key:"reward_cybernetics"};if(c.player.debt>0){let o=Math.floor(c.player.debt*.2);return c.player.debt-=o,e._logTransaction("event",o,"Passenger paid off debt"),{key:"reward_debt_paid",amount:v(o)}}else{let o=Math.floor(c.player.credits*.05);return c.player.credits=Math.min(Number.MAX_SAFE_INTEGER,c.player.credits+o),e._logTransaction("event",o,"Passenger payment"),{key:"reward_credits",amount:v(o)}}}var Ot={SPACE_RACE:rt,ADRIFT_PASSENGER:nt,credits:(c,e,t)=>{c.player.credits=Math.min(Number.MAX_SAFE_INTEGER,c.player.credits+t.value),e._logTransaction("event",t.value,"Received credits from event")},fuel:(c,e,t)=>{let i=e._getActiveShip(),a=c.player.shipStates[i.id];a.fuel=Math.max(0,a.fuel+t.value)},hull_damage_percent:(c,e,t)=>{let i=Array.isArray(t.value)?Math.random()*(t.value[1]-t.value[0])+t.value[0]:t.value;c.pendingTravel.eventHullDamagePercent=(c.pendingTravel.eventHullDamagePercent||0)+i},travel_time_add:(c,e,t)=>{c.pendingTravel.travelTimeAdd=(c.pendingTravel.travelTimeAdd||0)+t.value},travel_time_add_percent:(c,e,t)=>{c.pendingTravel.travelTimeAddPercent=(c.pendingTravel.travelTimeAddPercent||0)+t.value},set_travel_time:(c,e,t)=>{c.pendingTravel.setTravelTime=t.value},add_debt:(c,e,t)=>{c.player.debt<=0&&(c.player.loanStartDate=c.day,c.player.weeklyInterestAmount=0);let i=Math.ceil(t.value*.013);c.player.weeklyInterestAmount+=i,c.player.debt+=t.value,e._logTransaction("loan",t.value,"Incurred debt from event")},add_cargo:(c,e,t,i)=>{let a=e._getActiveShip(),s=e._getActiveInventory(),o=p.COMMODITIES.find(r=>r.id===t.value.id);Y(s)+t.value.quantity<=a.cargoCapacity?s[t.value.id].quantity+=t.value.quantity:i.description=`You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${o.name}</span> behind.`},lose_cargo:(c,e,t)=>{let i=e._getActiveInventory();i[t.value.id].quantity=Math.max(0,i[t.value.id].quantity-t.value.quantity)},lose_random_cargo_percent:(c,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],r=Math.ceil(o.quantity*t.value);o.quantity=Math.max(0,o.quantity-r)}},sell_random_cargo_premium:(c,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],r=c.market.galacticAverages[s]*t.value*o.quantity;c.player.credits=Math.min(Number.MAX_SAFE_INTEGER,c.player.credits+r),e._logTransaction("trade",r,"Emergency supply drop sale"),o.quantity=0}},set_new_random_destination:(c,e,t)=>{let i=p.MARKETS.filter(a=>a.id!==c.currentLocationId&&c.player.unlockedLocationIds.includes(a.id));i.length>0&&(c.pendingTravel.destinationId=i[Math.floor(Math.random()*i.length)].id)}};function lt(c,e,t,i){let a=Ot[t.type];if(a)return a(c,e,t,i);console.warn(`No handler found for event effect type: ${t.type}`)}var be=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.timeService=i,this.logger=a,this.simulationService=s}travelTo(e){this.uiManager.resetMarketTransactionState();let{tutorials:t}=this.gameState,{navLock:i}=t;if(i&&i.screenId===_.NAVIGATION&&i.enabledElementQuery&&!i.enabledElementQuery.includes(`[data-location-id='${e}']`))return;let a=this.gameState.getState();if(a.isGameOver||a.pendingTravel)return;if(a.currentLocationId===e){this.simulationService.setScreen(H.STARPORT,_.MARKET);return}let s=this.simulationService._getActiveShip();if(!s){this.uiManager.queueModal("event-modal","No Active Ship","You must have an active vessel to travel.");return}let r=this.simulationService.getEffectiveShipStats(s.id).maxFuel,l=a.TRAVEL_DATA[a.currentLocationId][e].fuelCost,h=a.player.shipStates[s.id].upgrades||[];a.player.activePerks[R.NAVIGATOR]&&(l=Math.round(l*p.PERKS[R.NAVIGATOR].fuelMod));let u=x.getFuelBurnModifier(h);if(l=Math.round(l*u),r<l){this.uiManager.queueModal("event-modal","Fuel Capacity Insufficient",`Your ship's fuel tank is too small. This trip requires ${l} fuel, but you can only hold ${r}.`);return}if(a.player.shipStates[s.id].fuel<l){this.uiManager.queueModal("event-modal","Insufficient Fuel",`You need ${l} fuel but only have ${Math.floor(a.player.shipStates[s.id].fuel)}.`);return}!(a.tutorials.activeBatchId==="intro_missions"&&a.tutorials.activeStepId==="mission_1_6")&&this._checkForRandomEvent(e)||this.initiateTravel(e)}initiateTravel(e,t={}){let i=this.gameState.getState(),a=i.currentLocationId,s={...i.TRAVEL_DATA[a][e]};this.logger.info.player(i.day,"TRAVEL_START",`Departing from ${a} to ${e}.`);let o=this.simulationService._getActiveShip(),r=this.gameState.player.shipStates[o.id],n=x.getShipAttributes(o.id),l=r.upgrades||[];i.player.activePerks[R.NAVIGATOR]&&(s.time=Math.round(s.time*p.PERKS[R.NAVIGATOR].travelTimeMod),s.fuelCost=Math.round(s.fuelCost*p.PERKS[R.NAVIGATOR].fuelMod));let d=x.getFuelBurnModifier(l),h=x.getTravelTimeModifier(l);if(s.fuelCost=Math.round(s.fuelCost*d),s.time=Math.max(1,Math.round(s.time*h)),n.forEach(A=>{let k=x.getDefinition(A);k.type===pe.MOD_TRAVEL_TIME&&k.value&&(s.time*=k.value),A==="ATTR_SLEEPER"&&(s.time*=4.5,s.fuelCost=0)}),n.includes("ATTR_SOLAR_SAIL")&&Math.random()<.15&&(s.fuelCost=0,s.time*=2,this.uiManager.createFloatingText("Solar Winds Caught!",window.innerWidth/2,window.innerHeight/2,"#60a5fa")),t.travelTimeAdd&&(s.time+=t.travelTimeAdd),t.travelTimeAddPercent&&(s.time*=1+t.travelTimeAddPercent),t.setTravelTime&&(s.time=t.setTravelTime),s.time=Math.max(1,Math.round(s.time)),s.fuelCost=Math.round(s.fuelCost),r.fuel<s.fuelCost){this.uiManager.queueModal("event-modal","Insufficient Fuel",`Trip modifications left you without enough fuel. You need ${s.fuelCost} but only have ${Math.floor(r.fuel)}.`),this.logger.warn("TravelService",`Travel to ${e} aborted due to insufficient fuel after event mods.`);return}if(t.forceEvent&&this._checkForRandomEvent(e,!0))return;let u=s.time*$.HULL_DECAY_PER_TRAVEL_DAY;n.includes("ATTR_XENO_HULL")?u=0:n.includes("ATTR_RESILIENT")&&(u*=.5),i.player.activePerks[R.NAVIGATOR]&&(u*=p.PERKS[R.NAVIGATOR].hullDecayMod);let m=this.simulationService.getEffectiveShipStats(o.id),g=m.maxHealth*((t.eventHullDamagePercent||0)/100),f=u+g;if(r.health-=f,this.simulationService._checkHullWarnings(o.id),r.health<=0){this._handleShipDestruction(o.id);return}if(r.fuel-=s.fuelCost,this.timeService.advanceDays(s.time),this.gameState.isGameOver)return;if(this.simulationService.newsTickerService.onLocationChange(e),typeof this.gameState.player.tripCount>"u"&&(this.gameState.player.tripCount=0),this.gameState.player.tripCount++,n.includes("ATTR_TRAVELLER")&&this.gameState.player.tripCount%20===0&&(r.health=m.maxHealth,r.fuel=m.maxFuel,this.logger.info.player(i.day,"ATTR_TRIGGER","Atlas systems engaged: Hull and Fuel fully restored."),this.uiManager.createFloatingText("Systems Restored",window.innerWidth/2,window.innerHeight/2,"#34d399")),n.includes("ATTR_FUEL_SCOOP")){let A=m.maxFuel*.15;r.fuel=Math.min(m.maxFuel,r.fuel+A)}this.gameState.setState({currentLocationId:e,pendingTravel:null});let S=p.MARKETS.find(A=>A.id===a),y=p.MARKETS.find(A=>A.id===e);if(!S||!y){this.logger.error("TravelService",`Invalid location ID provided for travel animation. From: ${a}, To: ${e}`),this.uiManager.queueModal("event-modal","Navigation Error","Could not plot a course. The destination is unknown.");return}let b=f/m.maxHealth*100;this.logger.info.player(this.gameState.day,"TRAVEL_END",`Arrived at ${e}.`,{fuelUsed:s.fuelCost,hullDamage:b.toFixed(2)+"%"});let E=()=>{this.gameState.tutorials.activeBatchId==="intro_missions"&&this.gameState.tutorials.activeStepId==="mission_1_7"&&e===I.LUNA?this.simulationService.setScreen(H.DATA,_.MISSIONS):this.simulationService.setScreen(H.STARPORT,_.MARKET)};this.uiManager.showTravelAnimation(S,y,s,b,E)}resumeTravel(){if(!this.gameState.pendingTravel)return;this.logger.info.system("Game",this.gameState.day,"TRAVEL_RESUME","Resuming travel after event.");let{destinationId:e,...t}=this.gameState.pendingTravel;this.initiateTravel(e,t)}_checkForRandomEvent(e,t=!1){let i=this.simulationService._getActiveShip(),s=this.gameState.player.shipStates[i.id].upgrades||[],o=x.getShipAttributes(i.id),r=$.RANDOM_EVENT_CHANCE,n=x.getEventChanceModifier(s);if(r+=n,o.includes("ATTR_ADVANCED_COMMS")&&(r*=1.25),t===!1&&Math.random()>r)return!1;let l;if(typeof t=="number")l=p.RANDOM_EVENTS[t];else{let d=p.RANDOM_EVENTS.filter(h=>h.precondition(this.gameState.getState(),i,this.simulationService._getActiveInventory.bind(this.simulationService)));if(d.length===0)return!1;l=d[Math.floor(Math.random()*d.length)]}return l?(this.logger.info.system("Event",this.gameState.day,"EVENT_TRIGGER",`Triggered random event: ${l.title}`),this.gameState.setState({pendingTravel:{destinationId:e}}),this.uiManager.showRandomEventModal(l,(d,h)=>this._resolveEventChoice(d,h)),!0):(this.logger.warn("TravelService",`Debug event trigger failed for index: ${t}`),!1)}_resolveEventChoice(e,t){let i=p.RANDOM_EVENTS.find(l=>l.id===e),a=i.choices[t],s=Math.random(),o=a.outcomes.find(l=>(s-=l.chance)<0)||a.outcomes[a.outcomes.length-1],r=this._applyEventEffects(o),n=o.description;r&&o.descriptions&&(n=o.descriptions[r.key],r.amount&&(n=n.replace("{amount}",r.amount))),this.logger.info.player(this.gameState.day,"EVENT_CHOICE",`Chose '${a.title}' for event '${i.title}'.`),this.uiManager.queueModal("event-modal",i.title,n,()=>this.resumeTravel(),{buttonText:"Continue Journey"})}_applyEventEffects(e){let t=null;return e.effects.forEach(i=>{let a=lt(this.gameState,this.simulationService,i,e);a&&(t=a)}),this.gameState.setState({}),t}_handleShipDestruction(e){let t=p.SHIPS[e].name;if(this.logger.error("TravelService",`Ship ${t} was destroyed.`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(i=>i!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.gameState.player.ownedShipIds.length===0)this.simulationService._gameOver(`Your last ship, the ${t}, was destroyed. Your trading career ends here.`);else{this.gameState.player.activeShipId=this.gameState.player.ownedShipIds[0];let i=p.SHIPS[this.gameState.player.activeShipId].name,a=`The ${t} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${i}.`;this.uiManager.queueModal("event-modal","Vessel Lost",a)}this.gameState.setState({})}};var te={CORP_FAILURE_01:{sample:"We've flagged a minor subsidiary going into receivership.",details:'A parent corp is cutting its losses and dissolving a failed venture that was flagged for going into receivership. They are dumping all assets to avoid Guild fees.<br><br>This has created a temporary surplus of [commodity name] at [location name] for [discount amount %] off market value.<br><br>The liquidation is scheduled to be finalized by creditors in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},CORP_FAILURE_02:{sample:"A corporate partner's trade charter has just been revoked.",details:`Following a trade charter revocation, the corporate state has seized a partner's assets and is holding a no-notice auction to pay their local debts.<br><br>We've secured a manifest: [commodity name] is available at [location name] for [discount amount %] below its valuation.<br><br>This is a one-time, unlisted auction ending in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},CORP_FAILURE_03:{sample:"Our analysts project a high-profile bankruptcy announcement is imminent.",details:`A firm our analysts flagged for imminent bankruptcy is in a death spiral and has begun a shadow liquidation to pay its key investors before the public announcement.<br><br>This means a large cache of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The firm's assets will be frozen by the Guild in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},CORP_FAILURE_04:{sample:"A corporate buyout we were tracking has just turned hostile.",details:'A corporate buyout has turned hostile, and the losing entity is being stripped by the new owners. All non-essential inventories are being sold off immediately.<br><br>They are clearing out all [commodity name] at [location name] for [discount amount %] below market price.<br><br>This fire sale will be over once the transition is complete in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},CORP_FAILURE_05:{sample:"We've confirmed a local governor has seized a corporation's assets.",details:`A local governor has seized a corporation's assets and is using a legal loophole to auction all seized goods for a public works fund, and they need it done fast.<br><br>This has resulted in a surplus of [commodity name] at [location name], now available for [discount amount %] off.<br><br>This asset seizure auction will close in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},LOGISTICS_FAILURE_01:{sample:"Tracking a freighter captain who just paid a massive Guild fine.",details:'A freighter captain, having just paid a massive Guild fine for an improper manifest, is now selling cargo at a loss to cover port fees.<br><br>Their entire hold of [commodity name] is being sold at [location name] for [discount amount %] off.<br><br>The ship is scheduled to be released and will depart in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},LOGISTICS_FAILURE_02:{sample:"We've confirmed a long-haul freighter has suffered critical damage.",details:`We've confirmed a long-haul freighter is too damaged to complete its journey. The captain is dumping their entire cargo hold to pay for emergency repairs.<br><br>This has created a buyer's market for [commodity name] at [location name], with goods going for [discount amount %] off.<br><br>The repairs are estimated to be complete in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},LOGISTICS_FAILURE_03:{sample:"A major port is experiencing a catastrophic logistics backlog.",details:'A major port is experiencing a catastrophic logistics backlog due to a system failure, leaving dozens of ships unable to dock. Captains are panic-selling cargo at a discount.<br><br>A significant surplus of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The port authority expects to have the system back online in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},LOGISTICS_FAILURE_04:{sample:"A high-priority supply contract was just canceled mid-transport.",details:'A high-priority supply contract was canceled mid-transport, leaving a freighter stuck with a full hold of bespoke goods and no buyer. The captain is selling the entire shipment for pennies.<br><br>Their cargo of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The captain will dump the cargo as scrap if not sold in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},LOGISTICS_FAILURE_05:{sample:"Pirate activity has forced a freighter miles off-route.",details:'A freighter, forced miles off-route by pirate activity, survived the encounter but burned too much fuel. They are selling valuable cargo to afford the refuel.<br><br>A stock of [commodity name] is being sold at [location name] for [discount amount %] below value.<br><br>The ship will refuel and depart in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},PRODUCTION_ERROR_01:{sample:"An automated factory's quarterly quota was massively miscalculated.",details:'A logistical AI at an automated factory put a decimal in the wrong place, resulting in a 100x surplus. The factory is dumping it before auditors arrive.<br><br>They are quietly liquidating [commodity name] at [location name] for [discount amount %] off.<br><br>The audit is scheduled for [durationDays], at which point this deal vanishes.<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},PRODUCTION_ERROR_02:{sample:"A major manufacturing line is retooling for a new-gen product.",details:`A major manufacturing line is retooling for a new-gen product, and all old-generation materials are being cleared out to make room. It's all considered scrap to them.<br><br>This means all [commodity name] stock is available at [location name] for [discount amount %] off.<br><br>The retooling will be complete in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},PRODUCTION_ERROR_03:{sample:"A recent batch of high-spec goods failed its final QA check.",details:'A shipment of high-spec goods failed its 99.9% purity standard. The corporation is selling this sub-par but still excellent stock at a loss.<br><br>This entire batch of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The shipment will be disposed of if not sold in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},PRODUCTION_ERROR_04:{sample:"We're tracking an industrial AI experiencing... anomalies.",details:'An industrial AI has been experiencing anomalies, ordering triple the required raw materials for weeks, and the local warehouse is now overflowing.<br><br>They are selling excess [commodity name] at [location name] for [discount amount %] off to clear space.<br><br>A diagnostic and reset is scheduled for [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},PRODUCTION_ERROR_05:{sample:"A new, experimental production line has... unexpected byproducts.",details:'A test run of a new, experimental manufacturing process has, ironically, created a massive surplus of a key component. The R&D lab is selling it off-book.<br><br>This surplus of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The test run concludes and the line is shut down in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},REGULATORY_ERROR_01:{sample:"A new interstellar tariff is being announced in 48 hours.",details:`We've seen the memo for a new interstellar tariff being announced in 48 hours. Suppliers are desperately dumping all pre-tariff stock to avoid the new, massive tax.<br><br>This panic-sell means [commodity name] is available at [location name] for [discount amount %] off.<br><br>This regulatory loophole will snap shut in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},REGULATORY_ERROR_02:{sample:"A Guild auditor just made a surprise visit to a local port.",details:`A Guild auditor's surprise visit has a local port authority in a panic. They are auctioning all unclaimed and improperly manifested cargo immediately. No questions asked.<br><br>A large lot of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The audit will be complete and the auction closed in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},REGULATORY_ERROR_03:{sample:"We've flagged a shipment seized for manifest violations.",details:'A shipment was seized for manifest violations, declared contraband on a technicality. The local authorities are now selling it at a disposal auction.<br><br>This seized shipment of [commodity name] is available at [location name] for [discount amount %] off.<br><br>The auction is unlisted and ends in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},REGULATORY_ERROR_04:{sample:"A local trade license has been unexpectedly revoked.",details:`A company's local trade license has been unexpectedly revoked, barring them from trading. Their entire inventory is being sold off by Guild-appointed receivers.<br><br>This has created a one-time surplus of [commodity name] at [location name], available for [discount amount %] off.<br><br>The receivers' sale will end in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},REGULATORY_ERROR_05:{sample:"A health inspector has quarantined a station's cargo bay.",details:`A (likely faked) health scare from an inspector has forced the liquidation of all perishable goods in a quarantined cargo bay. The corporation is writing it off as a total loss.<br><br>This means all [commodity name] in the bay is being sold at [location name] for [discount amount %] off.<br><br>The bay will be 'sterilized' and the remaining stock destroyed in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},INSIDER_INTEL_01:{sample:"A high-level corporate executive is about to be retired.",details:`A high-level corporate exec knows they are being forced out and is panic-selling all their personal and corporate assets before they are frozen.<br><br>This includes a private stash of [commodity name], available at [location name] for [discount amount %] off.<br><br>The exec's accounts will be seized in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},INSIDER_INTEL_02:{sample:"We've identified a shell corporation that is being dissolved.",details:`A shell corporation we identified as a smuggling front is being dissolved. Its 'legitimate' assets are being rapidly absorbed into the public market.<br><br>This has created a shadow surplus of [commodity name] at [location name] for [discount amount %] off.<br><br>The assets will be fully liquidated in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},INSIDER_INTEL_03:{sample:"A rival corporation is initiating a hostile price war.",details:'A rival corporation is intentionally flooding the market to bankrupt a competitor. This has temporarily, and artificially, crashed the price.<br><br>This means [commodity name] is available at [location name] for [discount amount %] below its actual value.<br><br>We project the smaller firm will fold and prices will stabilize in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},INSIDER_INTEL_04:{sample:"We have a tip from a disgruntled corporate officer.",details:'A disgruntled corporate officer is about to blow the whistle on a major product line failure and is dumping their personal stock before the news breaks.<br><br>This fire sale on [commodity name] is happening at [location name] for [discount amount %] off.<br><br>The announcement is expected in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},INSIDER_INTEL_05:{sample:"An info-broker is dumping physical assets for liquid credits.",details:'A rival info-broker is restructuring and needs cash, fast. They are selling their entire non-data inventory at a loss.<br><br>Their holdings of [commodity name] are available at [location name] for [discount amount %] off.<br><br>This is a one-time offer, ending in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},DEMAND_SPIKE_01:{sample:"A critical supply freighter has just been declared lost with all hands.",details:'A critical supply freighter has been declared lost with all hands, creating a system-wide shortage of a key material. Buyers are paying a massive premium.<br><br>The market for [commodity name] at [location name] is buying at [discount amount %] over galactic average.<br><br>This bubble will pop when replacement shipments arrive in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},DEMAND_SPIKE_02:{sample:"A major factory just suffered a catastrophic failure.",details:`A major factory just suffered a catastrophic failure. As the system's primary supplier of a key component, the supply chain has collapsed.<br><br>Demand for [commodity name] at [location name] has skyrocketed, with prices at [discount amount %] above normal.<br><br>This shortage is expected to last [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},DEMAND_SPIKE_03:{sample:"We've intercepted a project's emergency supply request.",details:`We've intercepted an emergency supply request from a major terraforming project that has a massive, miscalculated shortfall. They are paying any price.<br><br>They are buying [commodity name] at [location name] for [discount amount %] over market value.<br><br>Their emergency charter is expected to be filled in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.`},DEMAND_SPIKE_04:{sample:"A local warehouse was just breached by... something.",details:'The entire local stock of a commodity was destroyed after a warehouse breach. This has created a sudden, desperate demand from local industries.<br><br>The local market for [commodity name] at [location name] is paying [discount amount %] above average.<br><br>This localized shortage will be resolved in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'},DEMAND_SPIKE_05:{sample:"A new, unexpected corporate construction charter was just approved.",details:'A new, unexpected corporate construction charter was just approved. The corporation is rushing to build and is paying a premium to bypass normal supply channels.<br><br>Their project managers are buying [commodity name] at [location name] for [discount amount %] above the average price.<br><br>This buy-order will be filled in [durationDays].<br><br>You paid <span class="credits-text-pulsing">\u232C [credit price]</span> for this intel.'}};var ct={tier1:["Minor price drop for {Commodity Name}.","Low prices reported for {Commodity Name}.","{Commodity Name} trending below average.","{Commodity Name}: Favorable pricing reported.","Good time to buy {Commodity Name}.","It's a buyer's market for {Commodity Name}."],tier2:["{Commodity Name} prices are looking good.","{Commodity Name} is on sale.","Exceptional pricing available for {Commodity Name}.","Act now for the best price on {Commodity Name}.","Get your cheap {Commodity Name} now!","{Commodity Name} is trading far below average.","Get {Commodity Name} for cheap while you can.","Traders are eyeing cheap {Commodity Name}.","Now is the time to acquire {Commodity Name}.","Capitalize on falling {Commodity Name} prices.","Solid discount on {Commodity Name}."],tier3:["Don't miss out: {Commodity Name} is a bargain.","Prime buying opportunity for {Commodity Name}.","{Commodity Name}: Prices slashed!","{Commodity Name} is a 'hot buy' right now.","{Commodity Name} is a steal at this price.","Significant price drop for {Commodity Name}.","Traders report massive discounts on {Commodity Name}.","Unbeatable deals on {Commodity Name} right now.","Deep discounts on {Commodity Name}!","{Commodity Name} value has dropped significantly.","{Commodity Name} prices are tumbling."],tier4:["{Commodity Name} prices are nosediving.","{Commodity Name} prices have plummeted!","Major price correction for {Commodity Name}.","Fire sale! Get your {Commodity Name} while it lasts.","{Commodity Name} prices are getting crushed.","{Commodity Name} is practically a giveaway."],tier5:["{Commodity Name}: Prices have never been lower.","Historic lows for {Commodity Name}.","{Commodity Name} prices hit rock-bottom!","{Commodity Name} prices are in freefall.","Price crash reported for {Commodity Name}.","Market update: {Commodity Name} valuation has collapsed.","{Commodity Name} is being sold for scrap prices.","{Commodity Name}: Total market collapse!","{Commodity Name} is virtually worthless."]},Ye=["Prime buying opportunity for {Commodity Name} at {Location Name}!","{Location Name} reports massive discounts on {Commodity Name}!","{Commodity Name} is a steal at {Location Name} right now!","Don't miss out: {Commodity Name} is a bargain at {Location Name}!","{Location Name}: Prices slashed on {Commodity Name}!","Head to {Location Name} for deep discounts on {Commodity Name}!","Traders flocking to {Location Name} for cheap {Commodity Name}!","Significant price drops for {Commodity Name} at {Location Name}!","{Location Name} is the hot spot to buy {Commodity Name}!","Unbeatable deals on {Commodity Name} available at {Location Name}!","{Location Name} is dumping its {Commodity Name} stock!","Get to {Location Name}! {Commodity Name} prices are nosediving!","{Commodity Name} prices have plummeted at {Location Name}!","{Location Name} is practically giving away {Commodity Name}!","Fire sale on {Commodity Name} at {Location Name}!","{Commodity Name} prices are getting crushed at {Location Name}!","{CommodITY Name} market is in a freefall at {Location Name}!","Rumor: A major holder just dumped {Commodity Name} at {Location Name}!","{Commodity Name} selling for practically nothing at {Location Name}!","Price crash! {Commodity Name} is worthless at {Location Name}!","The {Commodity Name} market has collapsed at {Location Name}!","Historic lows for {Commodity Name} reported at {Location Name}!","{Location Name}: {Commodity Name} prices have hit rock-bottom!","Total market failure for {Commodity Name} at {Location Name}!","{Location Name} can't get rid of its {Commodity Name}!","{Commodity Name}: Prices have never been lower at {Location Name}!","{Commodity Name} is being sold for scrap prices at {Location Name}!","{Location Name}'s {Commodity Name} valuation has evaporated!"];var Ie=class{constructor(e,t,i,a,s){this.gameState=e,this.timeService=t,this.marketService=i,this.newsTickerService=a,this.logger=s,this.db=p}generateIntelRefresh(){this.logger.info.system("IntelService",this.gameState.day,"REFRESH","Generating intel refresh for all markets.");let t=this.gameState.getState().intelMarket;for(let i of Object.keys(t)){let a=t[i].filter(s=>s.isPurchased);t[i]=a}for(let i of this.db.MARKETS){let a=i.id;if(t[a]||(t[a]=[]),Math.random()<.7){let s=t[a].map(n=>n.messageKey).filter(Boolean),o=new Set,r=1+Math.floor(Math.random()*3);for(let n=0;n<r;n++){let l=[...s,...o],d=this._createPacket(a,l);d&&(t[a].push(d),o.add(d.messageKey))}}}this.gameState.setState({intelMarket:t})}_createPacket(e,t=[]){let i=this.gameState.getState(),a=i.player.revealedTier,s=this.db.COMMODITIES.filter(b=>b.tier<=a).map(b=>b.id);if(!s||s.length===0)return this.logger.warn("IntelService","Cannot create packet: No unlocked commodities available for player's tier."),null;let o=i.player.unlockedLocationIds||[],n=this.db.MARKETS.map(b=>b.id).filter(b=>b!==e&&o.includes(b));if(n.length===0)return this.logger.info.system("IntelService",`Cannot create packet: No *unlocked* deal locations available (excluding ${e}).`),null;let l=n[Math.floor(Math.random()*n.length)],d=s[Math.floor(Math.random()*s.length)],h=.15+Math.random()*.35,u=30+Math.floor(Math.random()*61),m=1+h*2+u/90,g=Object.keys(te);if(g.length===0)return this.logger.warn("IntelService","Cannot create packet: INTEL_CONTENT is empty."),null;let f=g.filter(b=>!t.includes(b)),S;return f.length===0?(this.logger.warn("IntelService",`All message keys for ${e} are in use. Reusing a key to generate packet.`),S=g[Math.floor(Math.random()*g.length)]):S=f[Math.floor(Math.random()*f.length)],{id:`pkt_${e.replace("loc_","")}_${this.timeService.getCurrentDay()}_${Math.floor(Math.random()*999)}`,locationId:e,dealLocationId:l,commodityId:d,discountPercent:parseFloat(h.toFixed(2)),durationDays:u,valueMultiplier:parseFloat(m.toFixed(2)),messageKey:S,isPurchased:!1}}calculateIntelPrice(e){let a=this.gameState.getState().player.credits*(.1+Math.random()*.1)*e.valueMultiplier;return Math.floor(a/100)*100}purchaseIntel(e,t,i){let a=this.gameState.getState();if(a.activeIntelDeal!==null)return this.logger.warn("IntelService","Purchase aborted: A deal is already active."),null;if(a.player.credits<i)return this.logger.warn("IntelService","Purchase aborted: Insufficient credits."),null;let s=a.intelMarket,o=s[t]?.find(S=>S.id===e);if(!o)return this.logger.error("IntelService",`Purchase failed: Could not find packetId ${e} in live market at ${t}.`),null;o.isPurchased=!0,o.pricePaid=i,this.logger.info.player(a.day,"INTEL_PURCHASE",`Purchased intel packet ${o.id} for ${v(i)}`);let r={...a.player};r.credits-=i;let n=this.marketService.getGalacticAverage(o.commodityId),l=Math.floor(n*(1-o.discountPercent)),d=a.currentLocationId,h=o.dealLocationId,u=this.gameState.TRAVEL_DATA[d][h].time;a.player.activePerks[R.NAVIGATOR]&&(u=Math.round(u*this.db.PERKS[R.NAVIGATOR].travelTimeMod));let m=Math.ceil(u*1.9),g=this.timeService.getCurrentDay()+m;this.logger.info.system("IntelService",a.day,"INTEL_DURATION",`Intel deal for ${o.commodityId} at ${h} will last ${m} days (Travel: ${u} days * 2.8). Expires on Day ${g}.`),o.expiryDay=g;let f={locationId:o.dealLocationId,commodityId:o.commodityId,overridePrice:l,expiryDay:g,sourcePacketId:o.id,sourceSaleLocationId:t};try{let S=this.db.COMMODITIES.find(A=>A.id===o.commodityId)?.name||"goods",y=this.db.MARKETS.find(A=>A.id===o.dealLocationId)?.name||"a local market",E=Ye[Math.floor(Math.random()*Ye.length)].replace("{Commodity Name}",S).replace("{Location Name}",y);this.newsTickerService.pushMessage(E,"INTEL",!0)}catch(S){this.logger.error("IntelService","Failed to push news ticker message.",S)}return this.gameState.setState({player:r,activeIntelDeal:f,intelMarket:s}),o}getGalacticAverage(e){return this.marketService.getGalacticAverage(e)}getCurrentDay(){return this.timeService.getCurrentDay()}};var Te=class{constructor(e,t,i,a){this.gameState=e,this.uiManager=t,this.logger=i,this.newsTickerService=a,this.tutorialService=null,this.missionService=null,this.intelService=null,this.marketService=new fe(e),this.timeService=new Se(e,this.marketService,t,i,a),this.travelService=new be(e,t,this.timeService,i,this),this.introService=new ye(e,t,i,this),this.playerActionService=new ve(e,t,null,this.marketService,this.timeService,i,this),this.intelService=new Ie(e,this.timeService,this.marketService,this.newsTickerService,i),this.timeService.intelService=this.intelService,this.uiManager.setIntelService(this.intelService),this.timeService.simulationService=this,this.newsTickerService.setServices(this,this.marketService)}setTutorialService(e){this.tutorialService=e}setMissionService(e){this.missionService=e,this.playerActionService.missionService=e}startIntroSequence(){this.introService.start()}handleIntroClick(e){this.introService.handleIntroClick(e)}_continueIntroSequence(e){this.introService.continueAfterTutorial(e)}buyItem(e,t){return this.playerActionService.buyItem(e,t)}sellItem(e,t){return this.playerActionService.sellItem(e,t)}async buyShip(e,t){let i=this.playerActionService.validateBuyShip(e);if(!i.success)return this.uiManager.queueModal("event-modal",i.errorTitle,i.errorMessage),null;let a=t.target.closest(".action-button");return a&&await ge(a,"is-glowing-green"),await new Promise(s=>requestAnimationFrame(s)),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_START",`Starting buy animation for ${e}.`),await this.uiManager.runShipTransactionAnimation(e),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_END","Buy animation complete. Executing logic."),this.playerActionService.executeBuyShip(e,t)}async sellShip(e,t){let i=this.playerActionService.validateSellShip(e);if(!i.success)return this.uiManager.queueModal("event-modal",i.errorTitle,i.errorMessage),!1;let a=t.target.closest(".action-button");return a&&await ge(a,"is-glowing-red"),await new Promise(s=>requestAnimationFrame(s)),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_START",`Starting sell animation for ${e}.`),await this.uiManager.runShipTransactionAnimation(e),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_END","Sell animation complete. Executing logic."),this.playerActionService.executeSellShip(e,t)}async boardShip(e,t){let i=this.playerActionService.validateSetActiveShip(e);if(!i.success)return i.errorTitle!=="Action Redundant"&&this.uiManager.queueModal("event-modal",i.errorTitle,i.errorMessage),!1;let a=t.target.closest(".action-button");if(a){let s=a.closest(".grid").querySelector('[data-action="sell-ship"]');s&&(s.disabled=!0)}return a&&await ge(a,"is-glowing-button"),this.playerActionService.executeSetActiveShip(e),this.gameState.introSequenceActive&&this.tutorialService.checkState({type:"ACTION",action:w.SELECT_SHIP}),await new Promise(s=>requestAnimationFrame(s)),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_START",`Starting board animation for ${e}.`),await this.uiManager.runShipTransactionAnimation(e,"is-boarding"),this.logger.info.system("SimService",this.gameState.day,"SHIP_ANIMATION_END","Board animation complete."),!0}payOffDebt(e){this.playerActionService.payOffDebt(e)}takeLoan(e,t){this.playerActionService.takeLoan(e,t)}purchaseLicense(e){return this.playerActionService.purchaseLicense(e)}refuelTick(){return this.playerActionService.refuelTick()}repairTick(){return this.playerActionService.repairTick()}travelTo(e){this.travelService.travelTo(e)}resumeTravel(){this.travelService.resumeTravel()}pushNewsMessage(e,t,i=!1){this.newsTickerService&&this.newsTickerService.pushMessage(e,t,i)}pulseNewsTicker(){this.newsTickerService&&this.newsTickerService.pulse()}setScreen(e,t){let i={...this.gameState.lastActiveScreen,[e]:t};this.gameState.setState({activeNav:e,activeScreen:t,lastActiveScreen:i}),this.tutorialService&&this.tutorialService.checkState({type:"SCREEN_LOAD",screenId:t})}setIntelTab(e){this.gameState.uiState.activeIntelTab!==e&&(this.gameState.uiState.activeIntelTab=e,this.gameState.setState({uiState:this.gameState.uiState}))}setHangarShipyardMode(e){this.gameState.uiState.hangarShipyardToggleState!==e&&(this.gameState.uiState.hangarShipyardToggleState=e,this.gameState.setState({}))}setHangarCarouselIndex(e,t){t==="hangar"?this.gameState.uiState.hangarActiveIndex=e:this.gameState.uiState.shipyardActiveIndex=e,this.gameState.setState({})}cycleHangarCarousel(e){let{uiState:t,player:i}=this.gameState,a=t.hangarShipyardToggleState==="hangar",s=a?i.ownedShipIds:this._getShipyardInventory().map(([r])=>r);if(s.length<=1)return;let o=a?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;e==="next"?o=(o+1)%s.length:o=(o-1+s.length)%s.length,this.setHangarCarouselIndex(o,a?"hangar":"shipyard")}_gameOver(e){this.gameState.isGameOver||(this.logger.info.state(this.gameState.day,"GAME_OVER",e),this.gameState.setState({isGameOver:!0}),this.uiManager.queueModal("event-modal","Game Over",e,()=>{localStorage.removeItem(ze),window.location.reload()},{buttonText:"Restart"}))}_checkGameOverConditions(){this.gameState.player.credits<=0&&this._gameOver("Your credit balance has fallen to zero. With no funds to operate, your trading career has come to an end.")}getEffectiveShipStats(e){let t=p.SHIPS[e];if(!t)return null;let a=this.gameState.getState().player.shipStates[e];if(!a||!a.upgrades)return{...t};let s=a.upgrades,o=x.getMaxHullModifier(s),r=x.getMaxFuelModifier(s),n=x.getMaxCargoModifier(s);return{...t,maxHealth:Math.round(t.maxHealth*o),maxFuel:Math.round(t.maxFuel*r),cargoCapacity:Math.round(t.cargoCapacity*n)}}addShipToHangar(e){let t=p.SHIPS[e];t&&(this.gameState.player.ownedShipIds.push(e),this.gameState.player.shipStates[e]={health:t.maxHealth,fuel:t.maxFuel,hullAlerts:{one:!1,two:!1},upgrades:[]},this.gameState.player.inventories[e]||(this.gameState.player.inventories[e]={},p.COMMODITIES.forEach(i=>{this.gameState.player.inventories[e][i.id]={quantity:0,avgCost:0}})))}_applyPerk(e){this.logger.info.player(this.gameState.day,"PERK_APPLIED",`Gained perk: ${e.title}`),e.perkId&&(this.gameState.player.activePerks[e.perkId]=!0),e.playerTitle&&(this.gameState.player.playerTitle=e.playerTitle),e.perkId===R.MERCHANT_GUILD_SHIP&&(this.addShipToHangar(G.STALWART),this.uiManager.queueModal("event-modal","Vessel Delivered",`The Merchant's Guild has delivered a new ${p.SHIPS[G.STALWART].name} to your hangar.`)),this.gameState.setState({})}_getActiveShip(){let e=this.gameState,t=e.player.activeShipId;if(!t)return null;let i=this.getEffectiveShipStats(t);return{id:t,...i,...e.player.shipStates[t]}}_getActiveInventory(){return this.gameState.player.activeShipId?this.gameState.player.inventories[this.gameState.player.activeShipId]:null}_checkHullWarnings(e){let t=this.gameState.player.shipStates[e],i=this.getEffectiveShipStats(e),a=t.health/i.maxHealth*100;a<=15&&!t.hullAlerts.two?t.hullAlerts.two=!0:a<=30&&!t.hullAlerts.one&&(t.hullAlerts.one=!0),a>30&&(t.hullAlerts.one=!1),a>15&&(t.hullAlerts.two=!1)}_logTransaction(e,t,i){for(this.gameState.player.financeLog.push({day:this.gameState.day,type:e,amount:t,balance:this.gameState.player.credits,description:i});this.gameState.player.financeLog.length>$.FINANCE_HISTORY_LENGTH;)this.gameState.player.financeLog.shift()}_logConsolidatedTrade(e,t,i){let a=this.gameState.player.financeLog,s=i<0,o=s?"Bought":"Sold",r=a.find(n=>n.day===this.gameState.day&&n.type==="trade"&&n.description.startsWith(`${o}`)&&n.description.endsWith(` ${e}`)&&(s&&n.amount<0||!s&&n.amount>0));if(r){r.amount+=i,r.balance=this.gameState.player.credits;let n=r.description.match(/\s(\d+)x\s/);if(n){let l=parseInt(n[1],10);r.description=`${o} ${l+t}x ${e}`}}else this._logTransaction("trade",i,`${o} ${t}x ${e}`)}_logConsolidatedTransaction(e,t,i){let a=this.gameState.player.financeLog,s=a.length>0?a[a.length-1]:null;s&&s.day===this.gameState.day&&s.type===e?(s.amount+=t,s.balance=this.gameState.player.credits):this._logTransaction(e,t,i)}_getShipyardInventory(){let{tutorials:e,player:t,currentLocationId:i,market:a}=this.gameState;return e.activeBatchId==="intro_hangar"?t.ownedShipIds.length>0?[]:[G.WANDERER,G.STALWART,G.MULE].map(s=>[s,p.SHIPS[s]]):(a.shipyardStock[i]?.shipsForSale||[]).map(o=>[o,p.SHIPS[o]]).filter(([o])=>!t.ownedShipIds.includes(o))}_grantRewards(e,t){e.forEach(i=>{if(i.type==="credits"&&(this.gameState.player.credits=Math.min(Number.MAX_SAFE_INTEGER,this.gameState.player.credits+i.amount),this._logTransaction("mission",i.amount,`Reward: ${t}`),this.uiManager.createFloatingText(`+${v(i.amount,!1)}`,window.innerWidth/2,window.innerHeight/2,"#34d399")),i.type==="license"&&!this.gameState.player.unlockedLicenseIds.includes(i.licenseId)){this.gameState.player.unlockedLicenseIds.push(i.licenseId);let a=p.LICENSES[i.licenseId];this.uiManager.triggerEffect("systemSurge",{theme:"tan"}),this.logger.info.player(this.gameState.day,"LICENSE_GRANTED",`Received ${a.name}.`)}})}grantMissionCargo(e){let t=p.MISSIONS[e];if(!t||!t.providedCargo)return;let i=this._getActiveInventory();if(!i){this.logger.error("SimulationService","Cannot grant mission cargo: No active inventory found.");return}t.providedCargo.forEach(a=>{i[a.goodId]||(i[a.goodId]={quantity:0,avgCost:0}),i[a.goodId].quantity+=a.quantity,this.logger.info.player(this.gameState.day,"CARGO_GRANT",`Received ${a.quantity}x ${p.COMMODITIES.find(s=>s.id===a.goodId).name} from ${t.name}.`)}),this.missionService&&this.missionService.checkTriggers()}};var Ee=class{constructor(){this.effectQueue=[],this.isEffectActive=!1,this.effectsRegistry={}}registerEffect(e,t){this.effectsRegistry[e]=t}trigger(e,t){console.log(`MANAGER: EffectsManager.trigger received call for '${e}'. Queue length: ${this.effectQueue.length}`),this.effectQueue.push({effectName:e,options:t}),this._processQueue()}async _processQueue(){if(this.isEffectActive||this.effectQueue.length===0)return;this.isEffectActive=!0;let e=this.effectQueue.shift(),t=this.effectsRegistry[e.effectName];if(!t){console.warn(`EffectManager: Attempted to trigger unregistered effect '${e.effectName}'.`),this.isEffectActive=!1,this._processQueue();return}try{console.log(`MANAGER: Instantiating and playing effect: '${e.effectName}'.`),await new t(e.options).play()}catch(i){console.error(`Error playing effect '${e.effectName}':`,i)}finally{this.isEffectActive=!1,this._processQueue()}}};var qe={label:"MOD",color:"#94a3b8"},kt=38,Dt=["Auxiliary","Standard","Badge","Pass","Mod","Hacker","Machines","Hull"];function Ae(c,e){if(!c||!c.startsWith("#"))return c;let t=c.replace("#",""),i=Math.max(0,Math.min(255,parseInt(t.substring(0,2),16)+e)),a=Math.max(0,Math.min(255,parseInt(t.substring(2,4),16)+e)),s=Math.max(0,Math.min(255,parseInt(t.substring(4,6),16)+e)),o=i.toString(16).padStart(2,"0"),r=a.toString(16).padStart(2,"0"),n=s.toString(16).padStart(2,"0");return`#${o}${r}${n}`}function Pt(c){if(!c)return"";let e=c.split(/\s+/).filter(t=>!Dt.includes(t)).join(" ");return e.length>0?e:c}function ht(c,e){let{uiState:t,player:i,tutorials:a}=c,s=t.hangarShipyardToggleState==="hangar",o=s?"mode-hangar":"mode-shipyard",r=s?i.ownedShipIds:e._getShipyardInventory().map(([h])=>h),n=s?t.hangarActiveIndex||0:t.shipyardActiveIndex||0,l=Math.min(n,Math.max(0,r.length-1)),d=s||r.length>0;return`
        <div class="flex flex-col h-full">
            <div id="ship-terminal-container" class="flex flex-col flex-grow min-h-0 ${o}">
                
                <div class="relative mx-auto my-1 w-max flex justify-center items-center">
                    <div class="toggle-container">
                        <div class="toggle-switch p-1 rounded-md flex w-[180px] h-10">
                            <div class="toggle-label hangar flex-1 text-center py-1 cursor-pointer" data-action="${w.TOGGLE_HANGAR_MODE}" data-mode="hangar">HANGAR</div>
                            <div class="toggle-label shipyard flex-1 text-center py-1 cursor-pointer" data-action="${w.TOGGLE_HANGAR_MODE}" data-mode="shipyard">SHIPYARD</div>
                        </div>
                    </div>
                    <div class="archive-link ${d?"":"hidden"}" data-action="show_ship_lore">ACCESS<br>ARCHIVE</div>
                </div>

                <div class="carousel-container flex-grow overflow-hidden relative">
                    <div id="hangar-carousel" class="flex h-full" style="transform: translateX(-${l*100}%)">
                        ${r.map((h,u)=>Ht(c,h,u,n,s,e)).join("")||$t(s)}
                    </div>
                </div>
            </div>
            <div id="hangar-pagination-wrapper">
                <div id="hangar-pagination">
                    {/* This will be populated by UIManager._renderHangarPagination */}
                </div>
            </div>
        </div>
    `}function $t(c){return`
        <div class="carousel-page p-2 md:p-4 w-full">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div class="flex flex-col items-center justify-center h-full">
                    <p class="text-gray-400">${c?"Your hangar is empty.":"No ships available in the shipyard."}</p>
                </div>
            </div>
        </div>
    `}function Ht(c,e,t,i,a,s){let o=p.SHIPS[e],r=a?c.player.shipStates[e]:null,{player:n}=c,l="",d=n.activeShipId===e,h=d&&a?'<div class="active-ship-glow-layer"></div>':"";a&&(l=`<div class="status-badge" style="border-color: ${d?"var(--theme-color-primary)":"var(--ot-border-light)"}; color: ${d?"var(--theme-color-primary)":"var(--ot-text-secondary)"};">${d?"ACTIVE":"STORED"}</div>`);let u="";if(a&&r&&r.upgrades&&r.upgrades.length>0){let j=[...r.upgrades].sort((q,z)=>{let X=J=>J.endsWith("_III")?3:J.endsWith("_II")?2:1,V=X(q),ue=X(z);return V!==ue?V-ue:q.localeCompare(z)}),U=j.map(q=>x.getDefinition(q)),Q=U.reduce((q,z)=>q+(z?z.name.length:0),0)>kt;u=`
            <div class="ship-attributes-overlay absolute bottom-3 left-1/2 transform -translate-x-1/2 flex flex-nowrap gap-1 z-20 w-full justify-center pointer-events-none px-1">
                ${j.map((q,z)=>{let X=U[z],V=X?X.name:qe.label,ue=X?X.description:"";Q&&(V=Pt(V));let J=X&&X.pillColor||qe.color,ne=1;q.endsWith("_III")?ne=3:q.endsWith("_II")&&(ne=2);let At=Ae(J,-40),wt=ne>1?`2px solid ${At}`:`1px solid ${J}`,Fe=J;if(ne===3){let _t=Ae(J,40),Mt=Ae(J,-80);Fe=`linear-gradient(135deg, ${_t} 0%, ${J} 45%, ${Mt} 100%)`}else ne===2&&(Fe=`linear-gradient(to bottom, ${J}, ${Ae(J,-20)})`);return`
                <button class="attribute-pill cursor-pointer transition-transform hover:scale-105" 
                     data-action="show-attribute-tooltip" 
                     data-attribute-id="${q}"
                     data-tooltip="${ue}"
                     style="
                        background: ${Fe}; 
                        color: #0f172a; 
                        border: ${wt};
                        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
                        padding: 1px 5px;
                        border-radius: 4px;
                        font-family: 'Orbitron', sans-serif;
                        font-size: 0.64rem;
                        font-weight: 700;
                        letter-spacing: 0.02em;
                        pointer-events: auto;
                        touch-action: manipulation;
                        white-space: nowrap;
                        -webkit-tap-highlight-color: transparent;
                     ">
                    ${V}
                </button>
            `}).join("")}
            </div>
        `}let g=Math.abs(t-i)<=5,f=B.getShipImage(e,n.visualSeed),S=B.getFallbackImage(e),y=g?f:B.PLACEHOLDER,b=f,E=f.endsWith("_A.jpeg"),A=d?"opacity: 1;":"opacity: 0; transition: opacity 0.3s ease-in;",k=d?"display: none;":"",N=`
        <div class="relative w-full h-full">
            <img src="${y}" 
                 data-src="${b}"
                 class="w-full h-full object-cover rounded-lg relative z-10" 
                 alt="${o.name}"
                 loading="${g?"eager":"lazy"}" 
                 data-fallback-src="${S}"
                 data-is-a="${E}"
                 style="${A}"
                 onload="this.style.opacity='1'; this.nextElementSibling.style.display='none';"
                 onerror="if (this.getAttribute('data-tried-fallback') === 'true' || this.getAttribute('data-is-a') === 'true') { this.style.display='none'; this.nextElementSibling.style.display='flex'; } else { this.setAttribute('data-tried-fallback', 'true'); this.src=this.getAttribute('data-fallback-src'); }">
            <span class="text-2xl font-orbitron absolute inset-0 flex items-center justify-center z-0 text-center text-gray-600" style="${k}">[ SHIP HOLOGRAM ]</span>
            ${u}
        </div>
    `,L=Bt(c,e,o,r,a,s),O=`
        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center relative overflow-hidden">
                    ${N}
                </div>
                ${l}
            </div>
        </div>
        <div class="col-span-2 flex flex-col justify-between">
            ${L}
            <div class="action-buttons-container pt-2">
                ${dt(e,o,n,a,c.tutorials)}
            </div>
        </div>
    `,F=`
        <div class="col-span-2 flex flex-col justify-between">
            ${L}
        </div>

        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center relative overflow-hidden">
                    ${N}
                </div>
                ${l}
            </div>
            
            <div class="action-buttons-container pt-2">
                ${dt(e,o,n,a,c.tutorials)}
            </div>
        </div>
    `;return`
        <div class="carousel-page p-2 md:p-4 w-full" data-ship-id="${e}" data-index="${t}">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                ${h}
                <div id="ship-card-main-content" class="h-full relative z-10">
                    <div class="ship-card-content-wrapper h-full">
                        ${a?F:O}
                    </div>
                </div>
            </div>
        </div>
    `}function Bt(c,e,t,i,a,s){let o=t.class.toLowerCase(),r=t.name.length,n="text-xl";r>25?n="text-xs leading-tight":r>22?n="text-sm leading-tight":r>17?n="text-base leading-tight":n="text-xl";let l=t.description.length,d="text-sm",h="";l>240?d="text-xs":l>190&&(d="",h="font-size: 0.8rem; line-height: 1.4;");let u=`color: var(--class-${o}-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;`,m="inset-text-shadow";t.class==="Z"?m="glow-text-z":t.class==="O"?m="glow-text-o":t.class==="S"&&(m="glow-text-s");let g=Gt(t,i,c.player,!a,e,s);if(a)return`
            <div class="info-panel-content info-panel-hangar flex-col justify-between h-full">
                <div class="info-panel-header">
                    <div class="info-panel-text">
                        <h3 class="${n} font-orbitron ${m}" style="${u}">${t.name}</h3>
                        <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                    </div>
                    ${g}
                </div>
                
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="${d} text-gray-300" style="${h}">${t.description}</p>
                </div>
            </div>
        `;{let f=v(t.price,!0),S=f.length>9?"text-shrink":"";return`
             <div class="info-panel-content info-panel-shipyard flex-col justify-between h-full">
                <div class="info-panel-header">
                    <div class="info-panel-text">
                        <h3 class="${n} font-orbitron ${m}" style="${u}">${t.name}</h3>
                        <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                        <p class="ship-price-display font-roboto-mono text-2xl credits-text-pulsing ${S}">${f}</p>
                    </div>
                    ${g}
                </div>

                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="${d} text-gray-300" style="${h}">${t.description}</p>
                </div>
            </div>
        `}}function dt(c,e,t,i,a){if(i){let s=t.activeShipId===c,o=t.ownedShipIds.length>1&&!s,r=Math.floor(e.price*$.SHIP_SELL_MODIFIER),n=v(r,!0),l=n.length>8?"text-shrink-button":"";return`
            <div class="grid grid-cols-2 gap-2">
                <button class="action-button" data-action="${w.SELECT_SHIP}" data-ship-id="${c}" ${s?"disabled":""} style="background-color: ${s?"#374151":"var(--ot-cyan-base)"}; color: ${s?"var(--ot-text-secondary)":"var(--ot-bg-dark)"};">
                    <span class="font-bold z-10 relative">${s?"ACTIVE":"BOARD"}</span>
                </button>
                <button class="action-button" data-action="${w.SELL_SHIP}" data-ship-id="${c}" ${o?"":"disabled"} style="background-color: var(--ot-hangar-red-base);">
                    <span class="font-bold z-10 relative">SELL</span>
                    <span class="action-button-price font-roboto-mono credits-text-pulsing z-10 relative ${l}">${n}</span>
                </button>
            </div>
        `}else{let s=t.credits>=e.price,o=a.activeBatchId?p.TUTORIAL_DATA[a.activeBatchId]?.steps.find(l=>l.stepId===a.activeStepId):null,r=a.activeBatchId==="intro_hangar"&&!o?.unlockPurchase,n=!s||r;return`
            <button class="action-button w-full justify-center" data-action="${w.BUY_SHIP}" data-ship-id="${c}" ${n?"disabled":""} style="background-color: var(--ot-green-accent);">
                <span class="font-bold z-10 relative">PURCHASE</span>
            </button>
        `}}function Gt(c,e,t,i=!1,a,s){let o=c;!i&&s&&(o=s.getEffectiveShipStats(a)||c);let r=i?c.maxHealth:e?.health??0,n=i?c.cargoCapacity:Y(t.inventories[a]),l=i?c.maxFuel:e?.fuel??0,d=o.maxHealth>0?r/o.maxHealth*100:0,h=o.cargoCapacity>0?n/o.cargoCapacity*100:0,u=o.maxFuel>0?l/o.maxFuel*100:0,m="var(--ot-green-accent)",g="#f59e0b",f="#3b82f6",S=(y,b,E,A,k)=>{let N=Math.floor(b),L=Math.floor(E),F=N>=L?L:`${N} / ${L}`,j=100,U=A/100*j;return`
            <div class="param-bar-item">
                <svg viewBox="0 0 100 20" class="param-bar-svg" preserveAspectRatio="xMidYMid meet">
                    <text x="50" y="2" text-anchor="middle" dominant-baseline="middle" class="svg-bar-label" fill="var(--ot-text-secondary)">${y}</text>
                    
                    <rect x="0" y="8.4" width="${j}" height="14" rx="3" class="svg-bar-track" fill="rgba(0,0,0,0.4)" />
                    
                    <rect x="0" y="8.4" width="${U}" height="14" rx="3" class="svg-bar-fill" fill="${k}" style="transition: width 0.4s ease-out;" />
                    
                    <text x="50" y="16.4" text-anchor="middle" dominant-baseline="middle" class="svg-bar-text" fill="#ffffff">${F}</text>
                </svg>
            </div>
        `};return`
        <div class="ship-param-bars ${i?"shipyard-bars":""}">
            ${S("HULL",r,o.maxHealth,d,m)}
            ${S("FUEL",l,o.maxFuel,u,f)}
            ${S("CARGO",n,o.cargoCapacity,h,g)}
        </div>
    `}function ut(c,e,t,i){return`<div class="market-scroll-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${p.COMMODITIES.filter(o=>o.tier<=c.player.revealedTier).map(o=>Ut(o,c,t,i)).join("")}</div>
            </div>`}function Ut(c,e,t,i){let{player:a,market:s,currentLocationId:o,tutorials:r,uiState:n}=e,l=a.inventories[a.activeShipId]?.[c.id],d=t(e,c.id,!1),h=t(e,c.id,!0),u=t(e,c.id,!0),m=s.galacticAverages[c.id],g=s.inventory[o]?.[c.id],f=!c.licenseId||a.unlockedLicenseIds.includes(c.licenseId),S=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_2",y=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_3",b=S&&c.id!==M.PLASTEEL||y,E=`data-tooltip="${c.lore}"`,A=l&&l.quantity>0?l.quantity:"0",k=n.marketCardMinimized[c.id],N=B.getCommodityImage(c.name,a.visualSeed),L="",O="";N&&(L=`background-image: url('${N}');`,O=" has-custom-art");let F,j="";if(f){let U;h<d?U=`
                <div class="price-container flex flex-col justify-center h-full">
                     <span class="text-xs text-gray-400 line-through text-right leading-none" style="opacity: 0.7;">${v(d)}</span>
                     <p id="price-display-${c.id}" class="font-roboto-mono font-bold text-green-400 text-right leading-tight" data-action="${w.SHOW_PRICE_GRAPH}" data-good-id="${c.id}" data-base-price="${h}">${v(h)}</p>
                </div>
            `:U=`<p id="price-display-${c.id}" class="font-roboto-mono font-bold price-text" data-action="${w.SHOW_PRICE_GRAPH}" data-good-id="${c.id}" data-base-price="${h}">${v(h)}</p>`;let W=ce({price:h,sellPrice:u,galacticAvg:m,playerItem:l}),Q=l&&l.quantity>0?`<div class="avg-cost-display" id="avg-cost-${c.id}">Avg. Cost: ${v(l.avgCost,!1)}</div>`:"",q=`
             <div class="transaction-controls" data-mode="${i[c.id]?.mode||"buy"}" data-good-id="${c.id}" ${b?"disabled":""}>
                <div class="toggle-switch" data-action="toggle-trade-mode" data-good-id="${c.id}">
                    <div class="toggle-thumb"></div>
                    <div class="toggle-labels"><span class="label-buy">Buy</span><span class="label-sell">Sell</span></div>
                </div>
                <div class="qty-stepper">
                    <button class="qty-down" data-action="decrement" data-good-id="${c.id}">\u25BC</button>
                    <input type="number" value="0" id="qty-${c.id}" min="0">
                    <button class="qty-up" data-action="increment" data-good-id="${c.id}">\u25B2</button>
                </div>
                <div class="action-group">
                    <button class="btn confirm-btn" data-action="confirm-trade" data-good-id="${c.id}">Confirm</button>
                    <button class="btn max-btn" data-action="set-max-trade" data-good-id="${c.id}">Max</button>
                </div>
            </div>`,z=l?.quantity>0?` (${l.quantity})`:"";j=`<button class="card-toggle-btn" data-action="${w.TOGGLE_MARKET_CARD_VIEW}" data-good-id="${c.id}">${k?"+":"\u2212"}</button>`,F=`
            <div class="max-view-content">
                <p class="font-bold commodity-name"><span class="commodity-name-tooltip" ${E}>${c.name}</span></p>
                <p class="avail-text">Avail: <span id="m-stock-${c.id}">${g.quantity}</span>, Own: <span id="p-inv-${c.id}">${A}</span></p>
                
                ${U}
                
                <div id="effective-price-display-${c.id}" class="effective-price-display"></div>
                
                <div class="indicator-container" id="indicators-${c.id}">${W}</div>

                ${Q}

                ${q}
            </div>

            <div class="min-view-content">
                <p class="font-bold commodity-name-min">${c.name}${z}</p>
                <p class="tier-text-min">Tier ${c.tier} | ${c.cat}</p>
            </div>
        `}else{let U=`TIER ${c.tier} LICENSE`;F=`
            <div class="license-locked-content" data-action="${w.ACQUIRE_LICENSE}" data-license-id="${c.licenseId}">
                <div class="license-locked-tier-watermark">TIER ${c.tier}</div>
                
                <div class="sci-fi-lock-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </div>
                 <p class="license-required-text">${U}</p>
            </div>
        `}return`
    <div class="item-card-container ${k?"minimized":""}" id="item-card-container-${c.id}">
        ${j}
        <div class="rounded-lg border ${c.styleClass}${O} transition-colors shadow-md" style="${L}">
            ${F}
        </div>
    </div>`}function mt(){return`
        <div id="map-container" class="w-full h-full overflow-y-auto">
            <svg id="map-svg-substrate"></svg>
            <div id="map-html-interface"></div>
        </div>
    `}function gt(c){let e=d3.select("#map-container"),t=d3.select("#map-svg-substrate"),i=d3.select("#map-html-interface");if(e.node().clientWidth===0){console.warn("Map container width is 0. Using ResizeObserver.");let a=new ResizeObserver(s=>{s[0].contentRect.width>0&&(pt(e,t,i,c),a.disconnect())});a.observe(e.node())}else pt(e,t,i,c)}function pt(c,e,t,i){e.selectAll("*").remove(),t.selectAll("*").remove();let a=c.node().clientWidth,s=a/2,{poiData:o,totalHeight:r}=Ft(a,i,s);c.style("height","100%"),e.attr("height",r),t.style("height",`${r}px`),jt(e,o,s,r),Yt(t,o,i,s),qt(i)}function Ft(c,e,t){let i={[I.VENUS]:1.035,[I.EARTH]:1.035,[I.LUNA]:.805,[I.MARS]:.9775,[I.BELT]:.805,[I.EXCHANGE]:.805,[I.JUPITER]:1.564,[I.SATURN]:1.46625,[I.URANUS]:1.27075,[I.NEPTUNE]:1.27075,[I.KEPLER]:.8625,[I.PLUTO]:.92},a=p.MARKETS.filter(d=>e.lastKnownState.player.unlockedLocationIds.includes(d.id)).map(d=>{let h=d.distance;if(d.parent){let u=p.MARKETS.find(m=>m.id===d.parent);u&&(h=u.distance+.1)}return{...d,effectiveDistance:h}}).sort((d,h)=>d.effectiveDistance-h.effectiveDistance),s=130,o=110,n=o+(a.length-1)*s+30;return{poiData:a.map((d,h)=>{let u=o+h*s,m=t+(h%2===0?-50:50),g=t+(h%2===0?-56:56),f=h%2===0?"end":"start",S=(d.parent?12:16)*(i[d.id]||1);return{...d,y:u,poiX:t,labelX:g,labelAnchor:f,leaderLineX:m,radius:S}}),totalHeight:n}}function jt(c,e,t,i){c.append("line").attr("class","central-axis").attr("x1",t).attr("y1",0).attr("x2",t).attr("y2",i),c.selectAll(".leader-line").data(e).enter().append("line").attr("class","leader-line").attr("x1",t).attr("y1",a=>a.y).attr("x2",a=>a.leaderLineX).attr("y2",a=>a.y)}function Yt(c,e,t,i){c.append("div").attr("id","map-sun-poi").style("position","absolute").style("top","-195px").style("left",`${i}px`).style("width",`${225*2}px`).style("height",`${225*2}px`);let s=c.selectAll(".poi-marker-group").data(e).enter().append("div").attr("class","poi-marker-group").attr("data-location-id",o=>o.id).style("position","absolute").style("top",o=>`${o.y}px`).on("click",(o,r)=>{t.showMapDetailModal(r.id)});s.append("div").attr("class",o=>o.id===I.BELT?"poi-icon belt":"poi-icon planet").style("position","absolute").style("left",o=>`${o.poiX}px`).style("width",o=>`${o.radius*2}px`).style("height",o=>`${o.radius*2}px`).style("background-color",o=>o.navTheme.borderColor),s.append("div").attr("class","poi-label").style("position","absolute").style("left",o=>`${o.labelX}px`).style("text-anchor",o=>o.labelAnchor).text(o=>o.name)}function qt(c){let e=d3.select("#map-container");if(e.empty())return;let t=c.lastKnownState.currentLocationId,i=p.MARKETS.find(r=>r.id===t);if(!i)return;e.style("--theme-glow-color",i.navTheme.borderColor),e.select(".poi-marker-group.current-location").classed("current-location",!1);let a=e.select(`.poi-marker-group[data-location-id="${t}"]`);a.classed("current-location",!0);let s=e.node(),o=a.node();if(s&&o)if(t===I.PLUTO)s.scrollTop=s.scrollHeight;else{let r=s.clientHeight,l=o.offsetTop-r/2;s.scrollTop=l}}function ft(c){let{player:e,currentLocationId:t,TRAVEL_DATA:i,tutorials:a}=c,{navLock:s}=a,o=p.MARKETS.find(y=>y.id===t),r=s&&s.screenId===_.NAVIGATION,n=r?s.enabledElementQuery:null,l=null;if(n){let y=n.match(/\[data-location-id='(.*?)'\]/);y&&y[1]&&(l=y[1])}let d=e.activeShipId,h=e.shipStates[d],u=h?h.upgrades||[]:[],m=1;e.activePerks[R.NAVIGATOR]&&(m*=p.PERKS[R.NAVIGATOR].fuelMod),m*=x.getFuelBurnModifier(u);let g=1;e.activePerks[R.NAVIGATOR]&&(g*=p.PERKS[R.NAVIGATOR].travelTimeMod),g*=x.getTravelTimeModifier(u);let S=x.getShipAttributes(d).includes("ATTR_SLEEPER");return`
        <div class="scroll-panel navigation-scroll-panel">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${p.MARKETS.filter(y=>e.unlockedLocationIds.includes(y.id)).map(y=>{let b=y.id===t,E=0,A=0;if(!b){let O=i[t][y.id];E=Math.max(1,Math.round(O.time*g)),S&&(E=Math.round(E*4.5)),A=Math.round(O.fuelCost*m),S&&(A=0)}let k=r&&l&&y.id!==l,N=k?"disabled-location":"",L=b?`style="--theme-glow-color: ${o?.navTheme.borderColor};"`:"";return`<div class="location-card p-6 rounded-lg text-center flex flex-col ${b?"highlight-current":""} ${y.color} ${y.bg} ${N}" 
                                     data-action="show-launch-modal" data-location-id="${y.id}" ${k?"disabled":""} ${L}>
                        <h3 class="text-2xl font-orbitron flex-grow">${y.name}</h3>
                        <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                        ${b?'<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>':`<div class="flex justify-around items-center text-center">
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                        <div><span class="font-bold font-roboto-mono text-lg">${E}</span><span class="block text-xs text-gray-400">Days</span></div>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                        <div><span class="font-bold font-roboto-mono text-lg">${A}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                                   </div>
                               </div>`}
                        </div>
                      </div>`}).join("")}
            </div>
        </div>`}function yt(c,e){let{player:t,currentLocationId:i}=c,{servicesTab:a="supply"}=c.uiState,s={[I.VENUS]:"Venetian Cloudport",[I.EARTH]:"Earth Starport",[I.LUNA]:"Lunar Starport",[I.MARS]:"Martian Starport",[I.BELT]:"Belt Station",[I.EXCHANGE]:"The Exchange",[I.JUPITER]:"Jupiter Starport",[I.SATURN]:"Saturn Starport",[I.URANUS]:"Uranus Starport",[I.NEPTUNE]:"Neptune Starport",[I.KEPLER]:"Kepler's Eye",[I.PLUTO]:"The Fringe"},r=p.MARKETS.find(V=>V.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},n=`
        --theme-gradient: ${r.gradient}; 
        --theme-text-color: ${r.textColor}; 
        --theme-border-color: ${r.borderColor};
    `,l=s[i]||"UNKNOWN STARPORT",d=a==="supply"?"active":"",h=a==="tuning"?"active":"",u=a==="supply"?`style="background: ${r.gradient}; color: ${r.textColor}; border-color: ${r.borderColor}; box-shadow: 0 0 10px rgba(0,0,0,0.5);"`:"",m=a==="tuning"?`style="background: ${r.gradient}; color: ${r.textColor}; border-color: ${r.borderColor}; box-shadow: 0 0 10px rgba(0,0,0,0.5);"`:"",g=`
        <div class="sub-nav-bar" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; justify-content: center;">
            <button class="sub-nav-button ${d}" ${u} data-action="set-services-tab" data-target="supply">SUPPLY</button>
            <button class="sub-nav-button ${h}" ${m} data-action="set-services-tab" data-target="tuning">TUNING</button>
        </div>
    `;if(a==="tuning")return`
            <div class="flex flex-col h-full">
                ${g}
                <div class="themed-header-bar mb-4" style="${n}">
                    <div class="themed-header-title">${l}</div>
                </div>
                ${Wt(c)}
            </div>
        `;if(!t.activeShipId||!c.player.shipStates[t.activeShipId])return`
            <div class="flex flex-col h-full">
                ${g}
                <div class="themed-header-bar mb-4" style="${n}">
                    <div class="themed-header-title">${l}</div>
                </div>
                <div class="services-scroll-panel flex-grow min-h-0">
                    <div class="ship-services-panel max-w-4xl mx-auto" style="${n}">
                        <div class="themed-header-bar">
                            <div class="ship-header-title">NO ACTIVE SHIP</div>
                        </div>
                        <div class="p-4 md:p-8">
                            <p class="text-center text-gray-500 text-lg">No active ship available for servicing.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;let f=p.SHIPS[t.activeShipId],S=c.player.shipStates[t.activeShipId],y=f?.name||"NO ACTIVE SHIP",b=S.upgrades||[],E=f?`var(--class-${f.class.toLowerCase()}-color)`:"#f0f0f0",A=f.maxHealth,k=f.maxFuel;if(e&&e.getEffectiveShipStats){let V=e.getEffectiveShipStats(t.activeShipId);V&&(A=V.maxHealth,k=V.maxFuel)}let N=p.MARKETS.find(V=>V.id===i).fuelPrice/2;t.activePerks[R.VENETIAN_SYNDICATE]&&i===I.VENUS&&(N*=1-p.PERKS[R.VENETIAN_SYNDICATE].fuelDiscount);let L=x.getServiceCostModifier(b,"refuel");N*=L,N=Math.max(1,Math.round(N));let O=A*($.REPAIR_AMOUNT_PER_TICK/100)*$.REPAIR_COST_PER_HP;t.activePerks[R.VENETIAN_SYNDICATE]&&i===I.VENUS&&(O*=1-p.PERKS[R.VENETIAN_SYNDICATE].repairDiscount);let F=x.getServiceCostModifier(b,"repair");O*=F,O=Math.max(1,Math.round(O));let j=S.fuel/k*100,U=S.health/A*100,W=S.fuel>=k,Q=S.health>=A,ae=t.credits>=N,q=t.credits>=O,z=W||!ae,X=Q||!q;return`
        <div class="flex flex-col h-full">
            ${g}
            <div class="themed-header-bar mb-4" style="${n}">
                <div class="themed-header-title">${l}</div>
            </div>
            <div class="services-scroll-panel flex-grow min-h-0">
                
                <div class="ship-services-panel max-w-4xl mx-auto" style="${n}">
                    <div class="themed-header-bar">
                        <div class="ship-header-title" style="color: ${E}; text-shadow: 0 0 5px ${E}80;">${y}</div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-center items-center gap-8 p-4 md:p-8">
                      <div class="service-module w-full max-w-sm" style="--resource-color-rgb: 8, 217, 214; --resource-color: #08d9d6; --ot-cyan-base: #08d9d6;">
                        <div class="bar-housing">
                          <div class="progress-bar-container w-full h-14 rounded-lg border border-gray-800 overflow-hidden relative">
                            <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                              <span class="font-electrolize font-bold tracking-wider uppercase text-cyan-300 text-outline" style="--glow-color: #08d9d6;">Fuel</span>
                              <span class="font-mono font-bold text-white text-outline" style="--glow-color: #08d9d6;">
                                ${Math.round(S.fuel)} / ${k}
                              </span>
                            </div>
                            <div id="fuel-bar" class="progress-bar-fill h-full rounded-md" style="width: ${j}%; background-color: #08d9d6; --glow-color: #08d9d6; background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                          </div>
                        </div>
                        <div class="control-deck flex justify-center items-center gap-4">
                          <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                            <span class="price-label text-sm engraved-text">COST</span>
                            <span class="price-digits text-base ${ae?"credits-text-pulsing":"text-red-500 shadow-red-500"}">
                              ${v(N,!0)}
                            </span>
                          </div>
                          <button id="refuel-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${z?"disabled":""}>
                            <span class="engraved-text">${W?"MAX":"REFUEL"}</span>
                          </button>
                        </div>
                      </div>

                      <div class="service-module w-full max-w-sm" style="--resource-color-rgb: 22, 163, 74; --resource-color: #16a34a; --ot-green-accent: #16a34a; --ot-green-text-light: #22c55e;">
                        <div class="bar-housing">
                          <div class="progress-bar-container w-full h-14 rounded-lg border border-gray-800 overflow-hidden relative">
                            <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                               <span class="font-electrolize font-bold tracking-wider uppercase text-outline" style="color: var(--ot-green-text-light); --glow-color: var(--ot-green-text-light);">HULL INTEGRITY</span>
                              <span class="font-mono font-bold text-white text-outline" style="--glow-color: var(--resource-color);">
                                ${Math.round(S.health)} / ${A}
                              </span>
                            </div>
                            <div id="repair-bar" class="progress-bar-fill h-full rounded-md" style="width: ${U}%; background-color: var(--resource-color); --glow-color: var(--resource-color); background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                          </div>
                        </div>
                        <div class="control-deck flex justify-center items-center gap-4">
                          <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                            <span class="price-label text-sm engraved-text">COST</span>
                            <span class="price-digits text-base ${q?"credits-text-pulsing":"text-red-500 shadow-red-500"}">
                              ${v(O,!0)}
                            </span>
                          </div>
                          <button id="repair-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${X?"disabled":""}>
                              <span class="engraved-text">${Q?"MAX":"REPAIR"}</span>
                          </button>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    `}function Vt(c){let{day:e,currentLocationId:t}=c;return x.getAllUpgradeIds().filter(a=>{if(a.includes("GUILD")||a.includes("SYNDICATE"))return!1;let s=.3;a.endsWith("_II")&&(s=.15),a.endsWith("_III")&&(s=.08);let o=`${e}_${t}_${a}`,r=0;for(let l=0;l<o.length;l++)r=(r<<5)-r+o.charCodeAt(l),r|=0;return Math.abs(r)%1e3/1e3<s})}function Wt(c){let e=Vt(c);return e.sort(),e.length===0?`
            <div class="services-scroll-panel flex-grow min-h-0 flex items-center justify-center">
                <p class="text-gray-500 text-lg">No upgrades available in stock today.</p>
            </div>
        `:`
        <div class="tuning-scroll-panel services-scroll-panel flex-grow min-h-0">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-5xl mx-auto p-2 pb-8">
                ${e.map(i=>{let a=x.getDefinition(i);if(!a)return"";let s=a.pillColor||P.GREY,o=`
            --item-color: ${s};
            --item-glow: ${s}80;
        `,r=c.player.credits>=a.value;return`
            <div class="service-module upgrade-shop-item" style="${o}">
                <div class="flex flex-row items-center gap-4 h-full">
                    <div class="upgrade-icon-strip h-full w-2" style="background-color: var(--item-color); box-shadow: 0 0 8px var(--item-glow);"></div>
                    
                    <div class="flex-grow flex flex-col justify-center overflow-hidden">
                        <div class="font-orbitron font-bold text-lg engraved-text truncate" 
                             style="color: var(--item-color); text-shadow: 0 0 5px var(--item-glow);">
                             ${a.name}
                        </div>
                        <div class="text-xs text-gray-400 mt-1 leading-tight">${a.description}</div>
                    </div>

                    <div class="flex flex-col items-end gap-2 min-w-[100px]">
                        <div class="font-mono text-cyan-300 credits-text-pulsing text-2xl">${v(a.value,!0)}</div>
                        <button class="btn btn-sm w-full font-bold uppercase tracking-wider"
                                style="border: 1px solid var(--item-color); color: ${r?"#fff":"#666"};"
                                data-action="install_upgrade"
                                data-upgrade-id="${i}"
                                data-cost="${a.value}"
                                ${r?"":"disabled"}>
                            INSTALL
                        </button>
                    </div>
                </div>
            </div>
        `}).join("")}
             </div>
        </div>
    `}function vt(c){let e=c.player.inventories[c.player.activeShipId];if(!e)return'<p class="text-center text-gray-500 text-lg">No active ship.</p>';let t=Object.entries(e).filter(([,s])=>s.quantity>0),i=c.player.visualSeed;return t.length===0?'<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>':`<div class="cargo-scroll-panel"><div class="cargo-grid">${t.map(([s,o])=>{let r=p.COMMODITIES.find(n=>n.id===s);return Kt(r,o,i)}).join("")}</div></div>`}function Kt(c,e,t){let i=le(c.styleClass),o=`background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 40%, transparent 60%, rgba(0,0,0,0.8) 100%), url('${B.getCommodityImage(c.name,t)}'), ${i.gradient};`,r={CRYO:"#a5f3fc",ATMO:"#fef08a",CLON:"#fbcfe8",AI:"#fecaca",NPRO:"#ffffff",CYB:"#ffffff"},n=c.symbol.toUpperCase(),l=r.hasOwnProperty(n),d=l?r[n]:i.hex,h=l?"-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000":"0 0 5px rgba(0,0,0,0.9)";return`
        <div class="min-cargo-item" 
             style="${o} border: 2px solid ${i.hex};"
             data-action="show_cargo_detail" 
             data-good-id="${c.id}">
            
            <div class="pt-symbol" style="font-size: 2rem; color: ${d}; text-shadow: ${h};">${n}</div>
            <div class="pt-quantity">(${e.quantity})</div>
        </div>
    `}function St(c,e){let t=le(c.styleClass),a={RAW:"Raw Material",IND:"Industrial Product",AGRI:"Agricultural Good",TECH:"Technology",CIV:"Civilian Commodity",BIO:"Bioware",RARE:"Exotic Material"}[c.cat]||"Unknown",o=(c.basePriceRange[0]+c.basePriceRange[1])/2*e.quantity;return`
        <div class="max-cargo-card" style="background: ${t.gradient}; border-color: ${t.hex};">
            <h3 class="text-2xl font-orbitron text-center">${c.name}</h3>
            <p class="text-sm text-center tier-type-line mb-4" style="color: #ffffff; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;">Tier ${c.tier} ${a}</p>
            <p class="flavor-text">${c.lore}</p>
            <div class="avg-cost">
                <div>Avg. Cost: <span class="font-bold credits-text-pulsing">${v(e.avgCost,!0)}</span></div>
                <div>Qty Aboard: <span class="font-bold">${e.quantity}</span></div>
                <div>Avg. Value: <span class="font-bold credits-text-pulsing">${v(o,!0)}</span></div>
            </div>
        </div>
    `}function bt(c,e){let{missions:t,currentLocationId:i}=c,{activeMissionId:a,activeMissionObjectivesMet:s}=t,o=(l,d)=>{let h="";d==="active"&&(h="mission-active"),d==="completed"&&(h="mission-complete"),d==="active"&&s&&l.completion.locationId===i&&(h+=" mission-turn-in");let u=`host-${l.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,m=l.rewards.map(g=>g.type==="credits"?`<span class="credits-text-pulsing">${v(g.amount,!0)}</span>`:g.type.toUpperCase()).join(", ");return`
            <div class="mission-card sci-fi-frame ${u} ${h}" data-action="show-mission-modal" data-mission-id="${l.id}">
                <div class="flex justify-between items-center w-full text-xs mb-1">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mission-type">${l.type}</span>
                    </div>
                    <span class="mission-host">${l.host}</span>
                </div>
                <div class="flex justify-between items-end w-full">
                    <p class="font-bold text-base">${l.name}</p>
                    <span class="mission-reward">${m}</span>
                </div>
            </div>`},r="",n=a?p.MISSIONS[a]:null;return n&&(r+=o(n,"active")),e&&e.getAvailableMissions().forEach(d=>{r+=o(d,"available")}),r===""&&(r='<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>'),`
        <div class="flex flex-col h-full">
            <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300 flex-shrink-0">Mission Terminal</h1>
            <div class="missions-scroll-panel flex-grow min-h-0">
                <div class="space-y-3 max-w-2xl mx-auto">
                    ${r}
                </div>
            </div>
        </div>
    `}function It(c){let{player:e,day:t,currentLocationId:i}=c,s=p.MARKETS.find(l=>l.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},o=`
        --theme-gradient: ${s.gradient}; 
        --theme-text-color: ${s.textColor}; 
        --theme-border-color: ${s.borderColor};
    `,r;if(e.debt>0){let l="";if(e.loanStartDate){let S=$.LOAN_GARNISHMENT_DAYS-(t-e.loanStartDate);S>0&&(l=`<p class="text-sm text-red-400/70 mt-2">Garnishment in ${S} days</p>`)}let d=e.activeShipId,h=e.shipStates[d],u=h?h.upgrades||[]:[],m=x.getInterestModifier(u),g=Math.floor(e.monthlyInterestAmount*m),f="";m<1?f=`
                <div class="mt-2 text-xs text-gray-400">
                    Monthly Interest: <span class="text-green-400">${v(g)}</span> 
                    <span class="line-through text-gray-600">${v(e.monthlyInterestAmount)}</span>
                </div>
            `:f=`
                <div class="mt-2 text-xs text-gray-400">
                    Monthly Interest: <span class="text-red-400">${v(e.monthlyInterestAmount)}</span>
                </div>
            `,r=`
            <div>
                <div class="themed-header-bar" style="${o}">
                    <div class="themed-header-title">Debt</div>
                </div>
                <div class="finance-module-panel flex flex-col items-center justify-center space-y-2 text-center" style="border-color: ${s.borderColor};">
                    <button data-action="${w.PAY_DEBT}" class="btn-module btn-module-destructive w-full font-roboto-mono" ${e.credits>=e.debt?"":"disabled"}>
                        <span class="text-base">Pay Off <span class="text-glow-red">${v(-e.debt,!0)}</span></span>
                    </button>
                    ${f}
                    ${l}
                </div>
            </div>`}else{let l=Math.floor(e.credits*3.5),d=Math.floor(l*.1),h=Math.floor(l*.04),m=[{key:"10000",amount:1e4,fee:600,interest:500},{key:"dynamic",...{amount:l,fee:d,interest:h}}].map(g=>`<button class="btn-module btn-module-credit w-full mt-2" data-action="${w.TAKE_LOAN}" data-loan-details='${JSON.stringify(g)}' ${e.credits<g.fee?"disabled":""}>
                        <span class="credits-text-pulsing">${v(g.amount,!0)}</span>
                    </button>`).join("");r=`
            <div>
                <div class="themed-header-bar" style="${o}">
                    <div class="themed-header-title">Financing</div>
                </div>
                <div class="finance-module-panel flex flex-col items-center justify-center space-y-2 text-center" style="border-color: ${s.borderColor};">
                    <div class="flex justify-center gap-4 w-full">${m}</div>
                </div>
            </div>`}let n=[...e.financeLog].reverse().map(l=>{let d=l.amount>0?"credits-text-pulsing":"text-glow-red",h=l.amount>0?"+":"";return`
            <div class="log-entry">
                <span class="text-gray-400 text-center">${l.day}</span>
                <span>${l.description}</span>
                <span class="${d} text-right font-roboto-mono">${h}${v(l.amount,!1)}</span>
            </div>
        `}).join("");return`
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 h-full">
            <div class="md:col-span-1">
                ${r}
            </div>
            <div class="md:col-span-2 flex flex-col min-h-0">
                 <div class="themed-header-bar" style="${o}">
                    <div class="themed-header-title">Transaction Log</div>
                 </div>
                 <div class="finance-module-panel flex flex-col flex-grow min-h-0" style="border-color: ${s.borderColor}; --theme-text-color: ${s.textColor};">
                    <div class="finance-log-panel">
                        <div class="log-header" style="border-color: ${s.borderColor};">
                           <span class="text-center">Day</span>
                           <span>Description</span>
                           <span class="text-right">Amount</span>
                        </div>
                        <div class="log-entries-container">
                           ${n||'<p class="text-center p-4">No transactions recorded.</p>'}
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    `}function Tt(){return`
        <div class="sub-nav-bar">
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-codex-content">Codex</button>
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-market-content">Intel Market</button>
        </div>

        <div class="intel-scroll-panel">
            <div id="intel-codex-content" class="intel-tab-content">
                <div id="lore-button-container" class="lore-container w-full max-w-md flex flex-col gap-4 p-4">
                    </div>
            </div>

            <div id="intel-market-content" class="intel-tab-content p-4">
                </div>
        </div>
    `}var we=class{constructor(e){this.isMobile=e,this.modal=document.getElementById("travel-animation-modal"),this.gameContainer=document.getElementById("game-container"),this.canvas=document.getElementById("travel-canvas"),this.ctx=this.canvas.getContext("2d"),this.statusText=document.getElementById("travel-status-text"),this.arrivalLore=document.getElementById("travel-arrival-lore"),this.progressBar=document.getElementById("travel-progress-bar"),this.progressContainer=document.getElementById("travel-progress-container"),this.readoutContainer=document.getElementById("travel-readout-container"),this.infoText=document.getElementById("travel-info-text"),this.hullDamageText=document.getElementById("travel-hull-damage"),this.confirmButton=document.getElementById("travel-confirm-button"),this.animationFrame=null,this.starLayers=[],this.engineParticles=[],this.celestialObjects=[]}play(e,t,i,a,s){this.modal.classList.remove("hidden"),this.modal.classList.add("dismiss-disabled");let o=t.navTheme||{gradient:"linear-gradient(to right, #06b6d4, #67e8f9)",borderColor:"#06b6d4"},r=this._lightenGradient(o.gradient);this.progressBar.style.background=r,this.progressBar.style.setProperty("--progress-glow-color",o.borderColor),this._setupInitialState(t,i),this._setupAnimationElements(e,t);let n=null,l=2500,d=h=>{n||(n=h);let u=h-n,m=Math.min(u/l,1);if(m>.8){let g=(m-.8)/.2;m=.8+(1-Math.pow(1-g,3))*.2}this._draw(m,e,t),this.progressBar.style.width=`${m*100}%`,m<1?this.animationFrame=requestAnimationFrame(d):this._onArrival(t,i,a,s)};this.animationFrame=requestAnimationFrame(d),this.confirmButton.onclick=()=>{cancelAnimationFrame(this.animationFrame),this.modal.classList.add("modal-hiding"),s&&s(),setTimeout(()=>{this.gameContainer.classList.add("fade-in")},50),setTimeout(()=>{this.modal.classList.add("hidden"),this.modal.classList.remove("modal-hiding","dismiss-disabled")},1e3)}}_lightenGradient(e){let t=e.match(/#[0-9a-f]{6}|#[0-9a-f]{3}/ig);if(!t)return e;let i=(s,o)=>{s=s.replace(/^#/,""),s.length===3&&(s=s.split("").map(h=>h+h).join(""));let r=parseInt(s,16),n=(r>>16)+o;n>255&&(n=255),n<0&&(n=0);let l=(r>>8&255)+o;l>255&&(l=255),l<0&&(l=0);let d=(r&255)+o;return d>255&&(d=255),d<0&&(d=0),"#"+(d|l<<8|n<<16).toString(16).padStart(6,"0")};return`linear-gradient(to right, ${t.map(s=>i(s,40)).join(", ")})`}_setupInitialState(e,t){this.statusText.textContent=`Traveling to ${e.name}...`,this.arrivalLore.textContent="",this.arrivalLore.style.opacity=0,this.readoutContainer.classList.add("hidden"),this.readoutContainer.style.opacity=0,this.confirmButton.style.opacity=0,this.confirmButton.disabled=!0,this.progressBar.style.width="0%"}_setupAnimationElements(e,t){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.starLayers=[this._createStarLayer(80,.5,.8),this._createStarLayer(50,1.2,1.2),this._createStarLayer(20,1.8,2)],this.engineParticles=[],this.backgroundGradient=this._getBackgroundGradient(e,t),this.celestialObjects=this._getCelestialObjects(e.id,t.id)}_createStarLayer(e,t,i){let a=[];for(let s=0;s<e;s++)a.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,radius:Math.random()*1.5,speed:t+Math.random()*(i-t),alpha:.5+Math.random()*.5});return a}_getBackgroundGradient(e,t){let a=(o=>{for(let r in p.TRAVEL_VISUALS.zones)if(p.TRAVEL_VISUALS.zones[r].locations.includes(o.id))return p.TRAVEL_VISUALS.zones[r];return p.TRAVEL_VISUALS.zones.inner_sphere})(t),s=this.ctx.createLinearGradient(0,0,0,this.canvas.height);return s.addColorStop(0,a.gradient[0]),s.addColorStop(1,a.gradient[1]),s}_getCelestialObjects(e,t){let i=`${e}_to_${t}`;return(p.TRAVEL_VISUALS.objects[i]||[]).map(s=>({...s,x:this.canvas.width+Math.random()*200,y:s.position.y*this.canvas.height}))}_draw(e,t,i){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.backgroundGradient,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.starLayers.forEach((l,d)=>{let h=e<.8?1:1-(e-.8)/.2;l.forEach(u=>{u.x-=u.speed*h,u.x<0&&(u.x=this.canvas.width),this.ctx.beginPath(),this.ctx.arc(u.x,u.y,u.radius,0,Math.PI*2),this.ctx.globalAlpha=u.alpha,this.ctx.fillStyle="#FFF",this.ctx.fill()}),d===1&&this.celestialObjects.forEach(u=>{u.x-=u.speed*h,this.ctx.font=`${40*(u.scale||1)}px sans-serif`,this.ctx.globalAlpha=.5,this.ctx.fillText(u.emoji,u.x,u.y)})}),this.ctx.globalAlpha=1;let a=60,s=a,o=this.canvas.width-a,r=this.canvas.height/2;this.ctx.font="42px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(p.LOCATION_VISUALS[t.id]||"\u2753",s,r),this.ctx.fillText(p.LOCATION_VISUALS[i.id]||"\u2753",o,r);let n=s+(o-s)*e;this.ctx.save(),this.ctx.translate(n,r),this.ctx.font="17px sans-serif",this.ctx.fillText("\u{1F680}",0,0),this.ctx.restore(),this._updateEngineParticles(n,r),this._drawEngineParticles()}_updateEngineParticles(e,t){Math.random()>.5&&this.engineParticles.push({x:e-15,y:t+(Math.random()-.5)*8,life:1,speedX:-2-Math.random()*2,speedY:(Math.random()-.5)*.5,size:Math.random()*2+1});for(let i=this.engineParticles.length-1;i>=0;i--){let a=this.engineParticles[i];a.x+=a.speedX,a.y+=a.speedY,a.life-=.05,a.life<=0&&this.engineParticles.splice(i,1)}}_drawEngineParticles(){this.engineParticles.forEach(e=>{this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.globalAlpha=e.life,this.ctx.fillStyle=`rgba(255, 220, 180, ${e.life})`,this.ctx.fill()}),this.ctx.globalAlpha=1}_onArrival(e,t,i,a){this.statusText.textContent=`Arrived at ${e.name}`,this.arrivalLore.innerHTML=e.arrivalLore||"You have arrived.",this.infoText.innerHTML=`
            <div class="text-center">
                <div>Journey Time: ${t.time} Days</div>
                <div><span class="font-bold text-sky-300">Fuel Expended: ${t.fuelCost}</span></div>
            </div>`,this.hullDamageText.className="text-sm font-roboto-mono mt-1 font-bold text-red-400",i>.01?this.hullDamageText.innerHTML=`Hull Integrity -${i.toFixed(2)}%`:this.hullDamageText.innerHTML="",this.arrivalLore.style.opacity=1,this.readoutContainer.classList.remove("hidden"),setTimeout(()=>{this.readoutContainer.style.opacity=1,this.confirmButton.style.opacity=1,this.confirmButton.disabled=!1},150)}};var _e=class{constructor(e){this.intelService=e,this.db=p}render(e,t){let i=t,{currentLocationId:a,activeIntelDeal:s,intelMarket:o}=i,r=[];if(s){let u=Object.values(o).flat().find(m=>m.isPurchased&&m.id===s.sourcePacketId);u&&r.push(u)}let n=(o[a]||[]).filter(u=>!u.isPurchased),l=[...r,...n],d=s!==null;if(l.length===0){e.innerHTML='<p class="text-gray-400 text-center italic p-4">No intel data available at this location.</p>';return}let h=l.map(u=>{if(u.isPurchased)return this._renderPurchasedButton(u);{let m=this.intelService.calculateIntelPrice(u);return this._renderOfferButton(u,m,d)}}).join("");e.innerHTML=`<div class="w-full max-w-md mx-auto flex flex-col gap-4">${h}</div>`}_renderPurchasedButton(e){let t=this.db.MARKETS.find(o=>o.id===e.dealLocationId),i=t?.name||"Unknown Location",a=t?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",borderColor:"#7a9ac0",textColor:"#f0f0ff"};return`
            <button class="btn btn-intel btn-intel-purchased" style="${`
            --theme-gradient: ${a.gradient};
            --theme-border-color: ${a.borderColor};
            --theme-text-color: ${a.textColor};
        `}" data-action="show_intel_details" 
                    data-packet-id="${e.id}" 
                    data-location-id="${e.locationId}"> 
                ${i} - View Intel
            </button>`}_renderOfferButton(e,t,i){let a=this.db.MARKETS.find(n=>n.id===e.dealLocationId)?.name||"Unknown Location",s=i?"disabled":"",o=i?"You already have an active intel deal.":`Purchase intel for a deal at ${a}`,r=i?v(t,!0):`<span class="credits-text-pulsing">${v(t,!0)}</span>`;return`
            <button class="btn btn-intel" 
                    data-action="show_intel_offer" 
                    data-packet-id="${e.id}" 
                    data-location-id="${e.locationId}" data-price="${t}" 
                    title="${o}"
                    ${s}>
                ${a} ${r}
            </button>`}};var Ve=`
    <h3 class="text-2xl font-orbitron mb-4 text-center">End-User License Agreement (EULA) for Orbital Trading</h3>
    <p class="text-sm text-center text-gray-400 mb-4">Last Updated: November 6, 2025</p>
    <p>This End-User License Agreement ("EULA" or "Agreement") is a binding legal contract between you (either an individual or a single entity, hereafter "You," "Your," or "Licensee") and Devon P. Casey (hereafter "Licensor," "Developer," "We," "Us," or "Our") for the software application known as Orbital Trading, including any and all associated media, printed materials, and "online" or electronic documentation (collectively, the "Software").</p>
    <p>BY INSTALLING, COPYING, DOWNLOADING, OR OTHERWISE USING THE SOFTWARE, YOU AGREE TO BE BOUND BY THE TERMS OF THIS EULA.</p>
    <p>IF YOU DO NOT AGREE TO THE TERMS OF THIS EULA, DO NOT INSTALL OR USE THE SOFTWARE. YOU MUST PROMPTLY DELETE ALL COPIES OF THE SOFTWARE IN YOUR POSSESSION.</p>
    <p>IF YOU ARE A MINOR (BELOW THE AGE OF LEGAL MAJORITY IN YOUR JURISDICTION), YOUR PARENT OR LEGAL GUARDIAN MUST READ AND AGREE TO THIS EULA ON YOUR BEHALF.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">1. GRANT OF LICENSE</h4>
    <p>Subject to your strict and ongoing compliance with all terms and conditions of this Agreement, Licensor grants You a limited, non-exclusive, non-transferable, non-sublicensable, revocable license to install and use one (1) copy of the Software solely for Your own personal, non-commercial entertainment use on a single device (e.g., computer or mobile device) that You own or control.</p>
    <p>This Software is licensed, not sold. This license confers no title or ownership in the Software and should not be construed as a sale of any rights in the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">2. LICENSE RESTRICTIONS</h4>
    <p>Your right to use the Software is limited to the grant above, and You may not, under any circumstances, do any of the following:</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Copy, modify, adapt, translate, or create derivative works based on the Software, in whole or in part;</li>
        <li>b. Sell, rent, lease, sublicense, distribute, publicly display, publicly perform, or otherwise transfer or commercially exploit the Software or any of its components;</li>
        <li>c. Reverse engineer, decompile, disassemble, or otherwise attempt to derive or discover the source code of the Software, except and only to the extent that such activity is expressly permitted by applicable law notwithstanding this limitation;</li>
        <li>d. Use the Software for any commercial purpose (including, but not limited to, use at a cyber cafe, in a commercial arcade, or for any paid service) without the prior written consent of Licensor;</li>
        <li>e. Remove, alter, or obscure any copyright, trademark, or other proprietary rights notices on or in the Software;</li>
        <li>f. Use any cheats, exploits, automation software (bots), hacks, mods, or any unauthorized third-party software designed to modify or interfere with the Software experience;</li>
        <li>g. Use the Software to violate any applicable law, rule, or regulation;</li>
        <li>h. Scrape, data mine, or otherwise extract any data from the Software or its underlying servers or databases;</li>
        <li>i. Interfere with or disrupt the Software or any server or network used to support or provide the Software, including any hacking or "denial of service" attacks.</li>
    </ul>
    <p>Any use of the Software in violation of these License Restrictions is a material breach of this Agreement and may result in the immediate termination of your license and subject You to civil and/or criminal liability.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">3. OWNERSHIP AND INTELLECTUAL PROPERTY</h4>
    <p>You agree and acknowledge that all title, ownership rights, and intellectual property (IP) rights in and to the Software (including, but not limited to, all code, computer graphics, visual elements, audio, music, sound effects, themes, characters, character names, stories, dialogue, locations, and artwork) are and shall remain the exclusive property of Devon P. Casey.</p>
    <p>Copyright (c) 2025 Devon P. Casey. All Rights Reserved.</p>
    <p>All rights not expressly granted to You in this EULA are reserved by Licensor.</p>
    <p>This Agreement grants You no title, ownership, or other IP interest in the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">4. VIRTUAL GOODS AND IN-GAME CURRENCY</h4>
    <p>The Software may include virtual in-game currency, items, commodities, ships, or other virtual content ("Virtual Goods").</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  License, Not Ownership:  You acknowledge that Virtual Goods are licensed to You as part of the Software and are not sold. You have no ownership right or property interest in any Virtual Goods, regardless of whether they were "earned" through gameplay or "purchased" with real money.</li>
        <li>b.  No Real-World Value:  Virtual Goods have no monetary value, are not real currency, and cannot be redeemed, sold, transferred, or exchanged for real-world money or any item of monetary value.</li>
        <li>c.  Licensor's Rights:  Licensor has the absolute right to manage, regulate, control, modify, and/or eliminate Virtual Goods at any time, in its sole discretion, with or without notice. Licensor shall have no liability to You or any third party for the exercise of such rights.</li>
        <li>d. No Refunds:  All purchases of Virtual Goods are final and non-refundable, except as required by applicable law.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">5. FEEDBACK AND SUGGESTIONS</h4>
    <p>If You provide Licensor with any ideas, suggestions, bug reports, or other feedback regarding the Software ("Feedback"), You hereby grant Licensor a perpetual, irrevocable, worldwide, non-exclusive, royalty-free, fully paid-up, transferable, and sublicensable license to use, reproduce, modify, distribute, and otherwise exploit such Feedback for any purpose whatsoever (including for commercial purposes) without any obligation to provide compensation, credit, or attribution to You.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">6. CODE OF CONDUCT</h4>
    <p>While using the Software, You agree to comply with all applicable laws and to not:</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Harass, threaten, bully, defame, or otherwise abuse another user or Licensor's staff;</li>
        <li>b. Transmit or post any content that is hateful, abusive, racially or ethnically offensive, obscene, or illegal;</li>
        <li>c. Impersonate any person, including any employee or representative of Licensor;</li>
        <li>d. Disrupt the normal flow of gameplay or dialogue, or otherwise act in a manner that negatively affects other users' experience.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">7. UPDATES AND MODIFICATIONS</h4>
    <p>Licensor may, from time to time, provide updates, patches, or other modifications to the Software. You agree that Licensor may deploy and install these modifications remotely. You may be required to install such updates to continue using the Software. Licensor reserves the right to modify, suspend, or discontinue the Software, or any feature or part thereof, at any time with or without notice to You. Licensor shall not be liable to You or any third party for any such modification, suspension, or discontinuance.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">8. TERMINATION</h4>
    <p>This EULA is effective until terminated.</p>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  Termination by You:  You may terminate this EULA at any time by permanently deleting, destroying, and uninstalling all copies of the Software in Your possession or control.</li>
        <li>b.  Termination by Licensor:  Licensor may terminate this EULA immediately and without prior notice if You fail to comply with any term or condition of this Agreement.</li>
        <li>c.  Effect of Termination:  Upon termination for any reason, all licenses granted to You herein shall immediately cease. You must immediately and permanently delete all copies of the Software. All provisions of this EULA that by their nature should survive termination shall survive, including, without limitation, Sections 2, 3, 4, 5, 8(c), 9, 10, 11, 12, and 13. NO REFUNDS WILL BE GRANTED UPON TERMINATION.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">9. DISCLAIMER OF WARRANTIES</h4>
    <p>TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, THE SOFTWARE IS PROVIDED "AS IS" AND "AS AVAILABLE," WITH ALL FAULTS AND WITHOUT WARRANTY OF ANY KIND. LICENSOR HEREBY DISCLAIMS ALL WARRANTIES AND CONDITIONS, WHETHER EXPRESS, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT, AND NON-INFRINGEMENT OF THIRD-PARTY RIGHTS. LICENSOR DOES NOT WARRANT THAT THE SOFTWARE WILL MEET YOUR REQUIREMENTS, THAT ITS OPERATION WILL BE UNINTERRUPTED OR ERROR-FREE, THAT DEFECTS WILL BE CORRECTED, OR THAT THE SOFTWARE IS FREE OF VIRUSES OR OTHER HARMFUL COMPONENTS.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">10. LIMITATION OF LIABILITY</h4>
    <p>TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, IN NO EVENT SHALL LICENSOR (DEVON P. CASEY) OR HIS AFFILIATES BE LIABLE FOR ANY SPECIAL, INCIDENTAL, INDIRECT, CONSEQUENTIAL, OR PUNITIVE DAMAGES WHATSOEVER (INCLUDING, BUT NOT LIMITED TO, DAMAGES FOR LOSS OF PROFITS, LOSS OF DATA, BUSINESS INTERRUPTION, PERSONAL INJURY, OR LOSS OF PRIVACY) ARISING OUT OF OR IN ANY WAY RELATED TO THE USE OF OR INABILITY TO USE THE SOFTWARE, EVEN IF LICENSOR HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p>
    <p>IN NO EVENT SHALL THE TOTAL LIABILITY OF LICENSOR TO YOU FOR ALL DAMAGES (EXCEPT AS MAY BE REQUIRED BY APPLICABLE LAW IN CASES OF PERSONAL INJURY) EXCEED THE AMOUNT ACTUALLY PAID BY YOU FOR THE SOFTWARE OR ONE UNITED STATES DOLLAR (USD $1.00), WHICHEVER IS GREATER.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">11. INDEMNIFICATION</h4>
    <p>You agree to indemnify, defend, and hold harmless Licensor (Devon P. Casey) and his employees, agents, and affiliates from and against any and all claims, losses, damages, liabilities, costs, and expenses (including reasonable attorneys' fees) arising out of or relating to Your breach of this EULA or Your misuse of the Software.</p>
    <h4 class="text-xl font-orbitron mt-4 mb-2">12. GOVERNING LAW AND DISPUTE RESOLUTION</h4>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a. Governing Law:  This EULA shall be governed by and construed in accordance with the laws of the State of California, USA, without regard to its conflict of law principles.</li>
        <li>b.  Informal Negotiation:  To expedite resolution and control the cost of any dispute, You and Licensor agree to first attempt to negotiate any dispute informally for at least thirty (30) days before initiating any arbitration or court proceeding. Such informal negotiations commence upon written notice from one party to the other.</li>
        <li>c.  Binding Arbitration:  If a dispute cannot be resolved through informal negotiations, any claim, dispute, or controversy (excluding claims for injunctive or other equitable relief) shall be resolved by binding arbitration conducted by a single neutral arbitrator from the American Arbitration Association (AAA) under its Commercial Arbitration Rules. The arbitration shall take place in Santa Clara County, California. The arbitrator's decision shall be final and binding and may be entered as a judgment in any court of competent jurisdiction.</li>
        <li>d.  CLASS ACTION AND JURY TRIAL WAIVER:  YOU AND LICENSOR AGREE THAT ANY PROCEEDINGS TO RESOLVE OR LITIGATE ANY DISPUTE WILL BE CONDUCTED SOLELY ON AN INDIVIDUAL BASIS. NEITHER YOU NOR LICENSOR WILL SEEK TO HAVE ANY DISPUTE HEARD AS A CLASS ACTION, PRIVATE ATTORNEY GENERAL ACTION, OR IN ANY OTHER PROCEEDING IN WHICH EITHER PARTY ACTS OR PROPOSES TO ACT IN A REPRESENTATIVE CAPACITY. YOU AND LICENSOR BOTH EXPRESSLY WAIVE ANY RIGHT TO A TRIAL BY JURY.</li>
    </ul>
    <h4 class="text-xl font-orbitron mt-4 mb-2">13. GENERAL PROVISIONS</h4>
    <ul class="list-disc list-outside ml-6 space-y-2">
        <li>a.  Severability:  If any provision of this EULA is held to be invalid, illegal, or unenforceable, the validity, legality, and enforceability of the remaining provisions shall not be affected or impaired.</li>
        <li>b.  Entire Agreement:  This EULA constitutes the entire agreement between You and Licensor regarding the Software and supersedes all prior or contemporaneous understandings, agreements, or representations, whether written or oral.</li>
        <li>c.  Amendment:  Licensor reserves the right, at its sole discretion, to amend this EULA at any time. If We amend this EULA, We will post the amended EULA within the Software or on our website. Your continued use of the Software after such posting shall constitute Your acceptance of the amended EULA.</li>
        <li>d.  No Waiver:  The failure of Licensor to exercise or enforce any right or provision of this EULA shall not constitute a waiver of such right or provision.</li>
        <li>e.  Contact:  If You have any questions concerning this EULA, please contact Licensor at: devon_casey@outlook.com .</li>
    </ul>
`;function Me(c,e){if(!c||!c.startsWith("#"))return c;let t=c.replace("#",""),i=Math.max(0,Math.min(255,parseInt(t.substring(0,2),16)+e)),a=Math.max(0,Math.min(255,parseInt(t.substring(2,4),16)+e)),s=Math.max(0,Math.min(255,parseInt(t.substring(4,6),16)+e)),o=i.toString(16).padStart(2,"0"),r=a.toString(16).padStart(2,"0"),n=s.toString(16).padStart(2,"0");return`#${o}${r}${n}`}var Et={story_so_far:{title:"Story So Far...",content:`
            <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p>
        
            <p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p>
            <p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p>
            <p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
        `}},xe=class{constructor(e){this.logger=e,this.isMobile=window.innerWidth<=768,this.modalQueue=[],this.activeGraphAnchor=null,this.activeGenericTooltipAnchor=null,this.lastActiveScreenEl=null,this.lastKnownState=null,this.missionService=null,this.simulationService=null,this.newsTickerService=null,this.debugService=null,this.marketTransactionState={},this.activeHighlightConfig=null,this.marketScrollPosition=0,this.popperInstance=null,this.eventManager=null,this.activeGenericTooltipPosition="right",this.intelService=null,this.intelMarketRenderer=null,this.effectsManager=new Ee,this.travelAnimationService=new we(this.isMobile),this.navStructure={[H.SHIP]:{label:"Ship",screens:{[_.MAP]:"Map",[_.NAVIGATION]:"Navigation",[_.CARGO]:"Cargo"}},[H.STARPORT]:{label:"Starport",screens:{[_.MARKET]:"Market",[_.SERVICES]:"Services",[_.HANGAR]:"Shipyard"}},[H.DATA]:{label:"Data",screens:{[_.MISSIONS]:"Missions",[_.FINANCE]:"Finance",[_.INTEL]:"Intel"}}},this._cacheDOM(),this.getItemPrice=this.getItemPrice.bind(this),window.addEventListener("resize",this._setAppHeight)}_setAppHeight(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}triggerEffect(e,t){this.effectsManager.trigger(e,t)}setMissionService(e){this.missionService=e}setSimulationService(e){this.simulationService=e}setNewsTickerService(e){this.newsTickerService=e}setDebugService(e){this.debugService=e}setIntelService(e){this.intelService=e,this.intelMarketRenderer=new _e(e)}setEventManager(e){this.eventManager=e}resetMarketTransactionState(){this.marketTransactionState={}}_cacheDOM(){this.cache={gameContainer:document.getElementById("game-container"),navBar:document.getElementById("nav-bar"),newsTickerBar:document.getElementById("news-ticker-bar"),topBarContainer:document.getElementById("top-bar-container"),subNavBar:document.getElementById("sub-nav-bar"),stickyBar:document.getElementById("sticky-bar"),mapScreen:document.getElementById(`${_.MAP}-screen`),navigationScreen:document.getElementById(`${_.NAVIGATION}-screen`),servicesScreen:document.getElementById(`${_.SERVICES}-screen`),marketScreen:document.getElementById(`${_.MARKET}-screen`),cargoScreen:document.getElementById(`${_.CARGO}-screen`),hangarScreen:document.getElementById(`${_.HANGAR}-screen`),missionsScreen:document.getElementById(`${_.MISSIONS}-screen`),financeScreen:document.getElementById(`${_.FINANCE}-screen`),intelScreen:document.getElementById(`${_.INTEL}-screen`),graphTooltip:document.getElementById("graph-tooltip"),genericTooltip:document.getElementById("generic-tooltip"),processingModal:document.getElementById("processing-modal"),shipDetailModal:document.getElementById("ship-detail-modal"),launchModal:document.getElementById("launch-modal"),launchModalContent:document.getElementById("launch-modal-content"),cargoDetailModal:document.getElementById("cargo-detail-modal"),cargoDetailContent:document.getElementById("cargo-detail-content"),mapDetailModal:document.getElementById("map-detail-modal"),loreModal:document.getElementById("lore-modal"),loreModalContent:document.getElementById("lore-modal-content"),eulaModal:document.getElementById("eula-modal"),eulaModalContent:document.getElementById("eula-modal-content"),tutorialAnchorOverlay:document.getElementById("tutorial-anchor-overlay"),tutorialToastContainer:document.getElementById("tutorial-toast-container"),tutorialToastText:document.getElementById("tutorial-toast-text"),tutorialToastSkipBtn:document.getElementById("tutorial-toast-skip-btn"),tutorialToastNextBtn:document.getElementById("tutorial-toast-next-btn"),skipTutorialModal:document.getElementById("skip-tutorial-modal"),skipTutorialConfirmBtn:document.getElementById("skip-tutorial-confirm-btn"),skipTutorialCancelBtn:document.getElementById("skip-tutorial-cancel-btn"),tutorialHighlightOverlay:document.getElementById("tutorial-highlight-overlay"),missionStickyBar:document.getElementById("mission-sticky-bar"),stickyObjectiveText:document.getElementById("sticky-objective-text"),stickyObjectiveProgress:document.getElementById("sticky-objective-progress")}}render(e){if(!e||!e.player)return;let t=this.lastKnownState;if(this.lastKnownState=e,e.introSequenceActive&&!e.tutorials.activeBatchId)return;let i=p.MARKETS.find(a=>a.id===e.currentLocationId);i?(this.cache.topBarContainer.setAttribute("data-location-theme",i.id),this.cache.gameContainer.className=`game-container ${i.bg}`,i.navTheme&&i.navTheme.borderColor?(document.documentElement.style.setProperty("--theme-border-color",i.navTheme.borderColor),document.documentElement.style.setProperty("--theme-gradient",i.navTheme.gradient),document.documentElement.style.setProperty("--theme-text-color",i.navTheme.textColor),this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage=i.navTheme.gradient,this.cache.newsTickerBar.style.borderTopColor=i.navTheme.borderColor,this.cache.newsTickerBar.style.borderBottomColor=i.navTheme.borderColor,this.cache.newsTickerBar.style.backgroundColor="transparent")):(document.documentElement.style.removeProperty("--theme-border-color"),document.documentElement.style.removeProperty("--theme-gradient"),document.documentElement.style.removeProperty("--theme-text-color"),this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage="",this.cache.newsTickerBar.style.borderTopColor="",this.cache.newsTickerBar.style.borderBottomColor="",this.cache.newsTickerBar.style.backgroundColor=""))):this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage="",this.cache.newsTickerBar.style.borderTopColor="",this.cache.newsTickerBar.style.borderBottomColor="",this.cache.newsTickerBar.style.backgroundColor=""),this._renderNewsTicker(),this.renderNavigation(e),this.renderActiveScreen(e,t),this.updateStickyBar(e),this.renderStickyBar(e)}_renderNewsTicker(){if(!this.newsTickerService||!this.cache.newsTickerBar||!this.newsTickerService.isDirty)return;let e=this.newsTickerService.getTickerContentHtml();if(!e){this.cache.newsTickerBar.innerHTML="",this.newsTickerService.isDirty=!1;return}let t=`<div class="ticker-block">${e}</div>`;this.cache.newsTickerBar.innerHTML=`<div class="news-ticker-content">${t}</div>`;let i=this.cache.newsTickerBar.querySelector(".news-ticker-content");if(i){let s=i.getBoundingClientRect().width;i.innerHTML=t+t;let r=Math.max(20,s/50);i.style.animationDuration=`${r}s`}this.newsTickerService.isDirty=!1}renderNavigation(e){let{player:t,currentLocationId:i,activeNav:a,activeScreen:s,lastActiveScreen:o,introSequenceActive:r,tutorials:n,subNavCollapsed:l}=e,{navLock:d}=n,h=p.MARKETS.find(O=>O.id===i),u=t.activeShipId?p.SHIPS[t.activeShipId]:null,m=t.activeShipId?t.shipStates[t.activeShipId]:null,g=t.activeShipId?t.inventories[t.activeShipId]:null,f=h?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0"},S=t.credits>=Number.MAX_SAFE_INTEGER,y=S?"\u232C MAXIMUM CREDITS \u232C":v(t.credits),b=S?"text-glow-gold":"credits-text-pulsing",E=`
            <div class="context-bar" style="background: ${f.gradient}; color: ${f.textColor};">
                <span class="location-name-text">${h?.name||"In Transit"}</span>
                <span class="credit-text ${b}">${y}</span>
            </div>`,A=Object.keys(this.navStructure).map(O=>{let F=O===a,j=o[O]||Object.keys(this.navStructure[O].screens)[0],U=d&&d.navId!==O,W=r||U,Q=F?`background: ${f.gradient}; color: ${f.textColor};`:"";return`<div class="tab ${F?"active":""} ${W?"disabled":""}" 
                          style="${Q}" data-action="${w.SET_SCREEN}" data-nav-id="${O}" data-screen-id="${j}">${this.navStructure[O].label}</div>`}).join(""),k="";if(u&&m&&g){let O=Y(g),F=m.health/u.maxHealth*100,j=m.fuel/u.maxFuel*100,U=O/u.cargoCapacity*100;k=`
                 <div class="status-pod">
                    <div class="status-bar-group hull-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">H</span>
                        <div class="status-bar"><div class="fill hull-fill" style="width: ${F}%;"></div></div>
                         <div class="status-tooltip">${Math.floor(m.health)}/${u.maxHealth} Hull</div>
                    </div>
                    <div class="status-bar-group fuel-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">F</span>
                        <div class="status-bar"><div class="fill fuel-fill" style="width: ${j}%;"></div></div>
                         <div class="status-tooltip">${Math.floor(m.fuel)}/${u.maxFuel} Fuel</div>
                    </div>
                    <div class="status-bar-group cargo-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">C</span>
                        <div class="status-bar"><div class="fill cargo-fill" style="width: ${U}%;"></div></div>
                        <div class="status-tooltip">${O}/${u.cargoCapacity} Cargo</div>
                    </div>
                </div>`}let N=`<div class="nav-wrapper">${A}${k}</div>`,L=Object.keys(this.navStructure).map(O=>{let F=this.navStructure[O].screens,j=O===a,U=Object.keys(F).map(W=>{let Q=d&&d.screenId!==W,ae=W===s,q=r||Q,z=ae?"sub-nav-active":"",X=w.SET_SCREEN,V="";return ae&&(V=`style="background: ${f.gradient}; color: ${f.textColor}; opacity: 1; font-weight: 700;"`),`<a href="#" class="${q?"disabled":""} ${z}" ${V} data-action="${X}" data-nav-id="${O}" data-screen-id="${W}" draggable="false">${F[W]}</a>`}).join("");return`<div class="nav-sub ${!j||l?"hidden":""}" id="${O}-sub">${U}</div>`}).join("");this.cache.navBar.innerHTML=E+N,this.cache.subNavBar.innerHTML=L}renderActiveScreen(e,t){let i=this.cache[`${e.activeScreen}Screen`];switch(this.lastActiveScreenEl&&this.lastActiveScreenEl!==i&&this.lastActiveScreenEl.classList.remove("active-screen"),i&&(i.classList.add("active-screen"),this.lastActiveScreenEl=i),e.activeScreen){case _.MAP:this.cache.mapScreen.innerHTML=mt(),requestAnimationFrame(()=>gt(this));break;case _.NAVIGATION:this.cache.navigationScreen.innerHTML=ft(e);break;case _.SERVICES:this.cache.servicesScreen.innerHTML=yt(e),this.eventManager&&this.eventManager.holdEventHandler.bindHoldEvents();break;case _.MARKET:this.updateMarketScreen(e);break;case _.CARGO:this.cache.cargoScreen.innerHTML=vt(e);break;case _.HANGAR:{(!t||t.activeScreen!==_.HANGAR||t.uiState.hangarShipyardToggleState!==e.uiState.hangarShipyardToggleState||t.player.activeShipId!==e.player.activeShipId||t.uiState.lastTransactionTimestamp!==e.uiState.lastTransactionTimestamp||t&&t.tutorials.activeBatchId!==e.tutorials.activeBatchId||t&&t.tutorials.activeStepId!==e.tutorials.activeStepId)&&(this.cache.hangarScreen.innerHTML=ht(e,this.simulationService)),this._updateHangarScreen(e);break}case _.MISSIONS:this.cache.missionsScreen.innerHTML=bt(e,this.missionService);break;case _.FINANCE:this.cache.financeScreen.innerHTML=It(e);break;case _.INTEL:if((!t||t.activeScreen!==_.INTEL)&&(this.cache.intelScreen.innerHTML=Tt()),this._renderCodexButtons(this.cache.intelScreen),this.intelMarketRenderer){let s=this.cache.intelScreen.querySelector("#intel-market-content");s&&this.intelMarketRenderer.render(s,e)}this.updateIntelTab(e.uiState.activeIntelTab);break}}_renderCodexButtons(e){let t=e.querySelector("#lore-button-container");t&&(t.innerHTML=Object.entries(Et).map(([i,a])=>`<button class="btn btn-header" data-action="show_lore" data-lore-id="${i}">
                        ${a.title}
                    </button>`).join(""))}_updateHangarScreen(e){let{uiState:t,player:i}=e,a=this.cache.hangarScreen;if(!a)return;let s=a.querySelector("#hangar-carousel");if(!s)return;let r=t.hangarShipyardToggleState==="hangar"?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;s.style.transform=`translateX(-${r*100}%)`;let n=2;s.querySelectorAll(".carousel-page").forEach((u,m)=>{let g=Math.abs(r-m),f=u.querySelector("img"),S=u.querySelector("span");if(f)if(g>n)f.hasAttribute("src")&&(f.removeAttribute("src"),f.style.opacity="0",f.removeAttribute("data-tried-fallback"),S&&(S.style.display="flex"));else{let y=u.dataset.shipId;if(y){let b=B.getShipImage(y,i.visualSeed);(!f.hasAttribute("src")||!f.src.includes(b))&&(f.src=b,f.onload=()=>{f.style.opacity="1"},S&&(S.style.display="none"))}}}),this._renderHangarPagination(e);let d=a.querySelector("#hangar-pagination-wrapper"),h=a.querySelector(".pagination-dot.active");if(d&&h){let u=d.clientWidth,m=h.offsetLeft,g=h.offsetWidth,f=m-u/2+g/2;d.scrollTo({left:f,behavior:"smooth"})}}_renderHangarPagination(e){let{uiState:t,player:i,currentLocationId:a}=e,s=this.cache.hangarScreen;if(!s)return;let o=s.querySelector("#hangar-pagination");if(!o)return;let r=t.hangarShipyardToggleState==="hangar",l=(r?i.ownedShipIds:this.simulationService._getShipyardInventory().map(([y])=>y)).length;if(l<=1){o.innerHTML="";return}let d=r?t.hangarActiveIndex||0:t.shipyardActiveIndex||0,h=-1;r&&(h=i.ownedShipIds.indexOf(i.activeShipId));let m=p.MARKETS.find(y=>y.id===a)?.navTheme||{borderColor:"#7a9ac0"},g=6,f=[];if(l<=g+1)for(let y=0;y<l;y++)f.push({index:y,isActive:y===d,isHalf:!1,isBoarded:y===h});else{let y,b,E=d<g-1,A=d>l-g;E?(y=0,b=g):A?(y=l-g,b=l):(y=d-Math.floor(g/2)+1,b=d+Math.ceil(g/2)),y>0&&f.push({isHalf:!0,jump:"prev"});for(let k=y;k<b;k++)f.push({index:k,isActive:k===d,isHalf:!1,isBoarded:k===h});b<l&&f.push({isHalf:!0,jump:"next"})}let S=f.map(y=>{let b=`
                --theme-color-primary: ${m.borderColor};
                --theme-glow-color: ${m.borderColor};
            `;if(y.isHalf)return`<div class="pagination-dot half" style="${b}" data-action="${w.SET_HANGAR_PAGE}" data-jump-direction="${y.jump}"></div>`;{let E=y.isBoarded?"boarded":"";return`<div class="pagination-dot ${y.isActive?"active":""} ${E}" style="${b}" data-action="${w.SET_HANGAR_PAGE}" data-index="${y.index}"></div>`}}).join("");o.innerHTML=S}updateStickyBar(e){this.cache.stickyBar.innerHTML="",this.cache.topBarContainer.classList.remove("has-sticky-bar")}updateServicesScreen(e){if(e.activeScreen!==_.SERVICES)return;let{player:t}=e,i=p.SHIPS[t.activeShipId],a=t.shipStates[t.activeShipId],s=this.cache.servicesScreen.querySelector("#fuel-bar"),o=this.cache.servicesScreen.querySelector("#refuel-btn");if(s&&o){let l=a.fuel/i.maxFuel*100;s.style.width=`${l}%`,o.disabled=a.fuel>=i.maxFuel}let r=this.cache.servicesScreen.querySelector("#repair-bar"),n=this.cache.servicesScreen.querySelector("#repair-btn");if(r&&n){let l=a.health/i.maxHealth*100;r.style.width=`${l}%`,n.disabled=a.health>=i.maxHealth}}updateMarketScreen(e){if(e.activeScreen!==_.MARKET)return;let t=this.cache.marketScreen.querySelector(".market-scroll-panel");this.lastKnownState&&this.lastKnownState.activeScreen===_.MARKET&&this.lastKnownState.currentLocationId===e.currentLocationId&&t?this.marketScrollPosition=t.scrollTop:this.marketScrollPosition=0,this._saveMarketTransactionState(),this.cache.marketScreen.innerHTML=ut(e,this.isMobile,this.getItemPrice,this.marketTransactionState),this._restoreMarketTransactionState();let i=this.cache.marketScreen.querySelector(".market-scroll-panel");i&&(i.scrollTop=this.marketScrollPosition)}_saveMarketTransactionState(){if(!this.lastKnownState||this.lastKnownState.activeScreen!==_.MARKET)return;this.cache.marketScreen.querySelectorAll(".transaction-controls").forEach(t=>{let i=t.dataset.goodId,a=t.querySelector("input"),s=t.dataset.mode;a&&(this.marketTransactionState[i]={quantity:a.value,mode:s})})}_restoreMarketTransactionState(){for(let e in this.marketTransactionState){let t=this.marketTransactionState[e],i=this.cache.marketScreen.querySelector(`.transaction-controls[data-good-id="${e}"]`);if(i){let a=i.querySelector("input");a&&(a.value=t.quantity,i.setAttribute("data-mode",t.mode),this.updateMarketCardDisplay(e,parseInt(t.quantity,10)||0,t.mode))}}}getItemPrice(e,t,i=!1){return!this.simulationService||!this.simulationService.marketService?e.market.prices[e.currentLocationId]?.[t]||0:this.simulationService.marketService.getPrice(e.currentLocationId,t,!0)}_calculateSaleDetails(e,t){let i=this.lastKnownState;if(!i)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let a=p.COMMODITIES.find(m=>m.id===e),s=i.market.inventory[i.currentLocationId][e].quantity,o=this.getItemPrice(i,e,!0),n=i.player.inventories[i.player.activeShipId]?.[e]?.avgCost||0,l=o,d=Math.floor(l*t),h=n*t,u=d-h;if(u>0){let m=(i.player.activePerks[R.TRADEMASTER]?p.PERKS[R.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);u+=u*m}return{totalPrice:d,effectivePricePerUnit:l,netProfit:u}}updateMarketCardPrice(e,t){let i=this.cache.marketScreen.querySelector(`#price-display-${e}`);if(i){i.dataset.basePrice=t;let a=i.closest(".item-card-container").querySelector(".transaction-controls");a&&a.dataset.mode==="buy"&&(i.textContent=v(t))}}updateMarketCardDisplay(e,t,i){let a=this.cache.marketScreen.querySelector(`#price-display-${e}`),s=this.cache.marketScreen.querySelector(`#effective-price-display-${e}`),o=this.cache.marketScreen.querySelector(`#indicators-${e}`),r=this.cache.marketScreen.querySelector(`#avg-cost-${e}`);if(!a||!s||!o||!this.lastKnownState)return;let n=this.lastKnownState,l=parseInt(a.dataset.basePrice,10),d=n.player.inventories[n.player.activeShipId]?.[e];if(r&&r.classList.toggle("visible",i==="sell"),i==="buy")a.textContent=v(l),a.className="font-roboto-mono font-bold price-text",s.textContent="",o.innerHTML=ce({price:l,sellPrice:this.getItemPrice(n,e,!0),galacticAvg:n.market.galacticAverages[e],playerItem:d});else{let{effectivePricePerUnit:h,netProfit:u}=this._calculateSaleDetails(e,t);if(t>0){let m=`\u232C ${u>=0?"+":""}${v(u,!1)}`;a.textContent=m,s.textContent=`(${v(l,!1)}/unit)`,a.className=`font-roboto-mono font-bold ${u>=0?"profit-text":"loss-text"}`}else a.textContent="\u232C +0",a.className="font-roboto-mono font-bold profit-text",s.textContent="";o.innerHTML=ce({price:l,sellPrice:h||this.getItemPrice(n,e,!0),galacticAvg:n.market.galacticAverages[e],playerItem:d})}}showTravelAnimation(e,t,i,a,s){this.travelAnimationService.play(e,t,i,a,s)}queueModal(e,t,i,a=null,s={}){this.modalQueue.push({modalId:e,title:t,description:i,callback:a,options:s}),document.querySelector(".modal-backdrop:not(.hidden)")||this.processModalQueue()}processModalQueue(){if(this.modalQueue.length===0)return;let{modalId:e,title:t,description:i,callback:a,options:s}=this.modalQueue.shift(),o=document.getElementById(e);if(!o)return this.logger.error("UIManager",`Modal element with ID '${e}' not found in the DOM. Aborting modal display.`),this.processModalQueue();s.specialClass&&o.classList.add(s.specialClass),s.nonDismissible&&o.classList.add("dismiss-disabled"),s.theme?o.dataset.theme=s.theme:delete o.dataset.theme,o.dataset.dismissInside=s.dismissInside||"false",o.dataset.dismissOutside=s.dismissOutside||"false";let r=e==="mission-modal"?"mission-modal-title":e.replace("-modal","-title"),n=e==="mission-modal"?"mission-modal-description":e.replace("-modal","-description"),l=o.querySelector(`#${r}`),d=o.querySelector(`#${n}`)||o.querySelector(`#${e.replace("-modal","-scenario")}`);l&&(l.innerHTML=t),d&&(d.innerHTML=i,d.className="my-4 text-gray-300",e!=="mission-modal"&&d.classList.add("mb-6","text-lg"),(e==="event-modal"||e==="random-event-modal")&&d.classList.add("text-center"),s.contentClass&&((s.contentClass.includes("text-left")||s.contentClass.includes("text-right")||s.contentClass.includes("text-justify"))&&d.classList.remove("text-center"),d.classList.add(...s.contentClass.split(" ").filter(Boolean))));let h=()=>{this.hideModal(e),a&&a(),this.processModalQueue()};if(s.customSetup)s.customSetup(o,h);else{let u=o.querySelector("#"+e.replace("-modal","-button-container")),m;s.footer?u&&(u.innerHTML=s.footer,u.querySelectorAll("button[data-action]").forEach(g=>{g.addEventListener("click",f=>{g.dataset.action!=="buy_intel"&&h()})})):s.footer===null?u&&(u.innerHTML=""):(u?(u.innerHTML="",m=document.createElement("button"),u.appendChild(m)):m=o.querySelector("button"),m&&(m.className="btn px-6 py-2",s.buttonClass&&m.classList.add(s.buttonClass),m.innerHTML=s.buttonText||"Understood",m.onclick=h))}o.classList.remove("hidden"),o.classList.add("modal-visible")}showRandomEventModal(e,t){this.queueModal("random-event-modal",e.title,e.scenario,null,{nonDismissible:!0,customSetup:(i,a)=>{let s=i.querySelector("#random-event-choices-container");s.innerHTML="",e.choices.forEach((o,r)=>{let n=document.createElement("button");n.className="btn w-full text-center p-4 hover:bg-slate-700",n.innerHTML=o.title,n.onclick=()=>{t(e.id,r),a()},s.appendChild(n)})}})}showAgeEventModal(e,t){let i=document.getElementById("age-event-modal");i.classList.add("dismiss-disabled"),document.getElementById("age-event-title").innerHTML=e.title,document.getElementById("age-event-description").innerHTML=e.description;let a=document.getElementById("age-event-button-container");a.innerHTML="",e.choices.forEach(s=>{let o=document.createElement("button");o.className="perk-button",o.innerHTML=`<h4>${s.title}</h4><p>${s.description}</p>`,o.onclick=()=>{this.hideModal("age-event-modal"),t(s)},a.appendChild(o)}),i.classList.remove("hidden"),i.classList.add("modal-visible")}showLoreModal(e){let t=this.cache.loreModal,i=this.cache.loreModalContent;if(!t||!i){this.logger.error("UIManager","Lore modal elements not cached or found in DOM.");return}let a=Et[e];a?i.innerHTML=a.content:(this.logger.error("UIManager",`No lore content found for ID: ${e}`),i.innerHTML="<p>Error: Lore content not found.</p>"),i.scrollTop=0,t.classList.remove("hidden"),t.classList.add("modal-visible");let s=o=>{(o.target.closest("#lore-modal-content")||o.target.id==="lore-modal")&&(this.hideModal("lore-modal"),t.removeEventListener("click",s))};t.addEventListener("click",s)}showEulaModal(){let e=this.cache.eulaModal,t=this.cache.eulaModalContent;if(!e||!t){this.logger.error("UIManager","EULA modal elements not cached or found in DOM.");return}Ve?t.innerHTML=Ve:(this.logger.error("UIManager","EULA_CONTENT is not defined or empty."),t.innerHTML="<p>Error: EULA content not found.</p>"),t.scrollTop=0,e.classList.remove("hidden"),e.classList.add("modal-visible");let i=a=>{(a.target.closest("#eula-modal-content")||a.target.id==="eula-modal")&&(this.hideModal("eula-modal"),e.removeEventListener("click",i))};e.addEventListener("click",i)}showShipTransactionConfirmation(e,t,i){let a=p.SHIPS[e];if(!a)return;let s=`var(--class-${a.class.toLowerCase()}-color)`,o="";a.class==="Z"?o="glow-text-z":a.class==="O"?o="glow-text-o":a.class==="S"&&(o="glow-text-s");let r=`<span class="${o}" style="color: ${s}; font-weight: bold;">${a.name}</span>`,n,l,d,h;if(t==="buy")n="Confirm Purchase",d=a.price,h=v(d,!0),l=`Are you sure you want to purchase the ${r}?`,l+=`<br><br>Cost: <span class="credits-text-pulsing">${h}</span>`;else{n="Confirm Sale";let u=this.lastKnownState.player.shipStates[e],m=0;u&&u.upgrades&&u.upgrades.forEach(g=>{let f=x.getDefinition(g);f&&(m+=f.value)}),d=Math.floor((a.price+m)*$.SHIP_SELL_MODIFIER),h=v(d,!0),l=`Are you sure you want to sell the ${r}?`,l+=`<br><br>Income: <span class="credits-text-pulsing">+${h}</span>`}this.queueModal("event-modal",n,l,null,{dismissOutside:!0,customSetup:(u,m)=>{let g=u.querySelector("#event-button-container");g.innerHTML=`
                    <button id="confirm-transaction-btn" class="btn btn-pulse-green">Confirm</button>
                    <button id="cancel-transaction-btn" class="btn">Cancel</button>
                 `;let f=u.querySelector("#confirm-transaction-btn"),S=u.querySelector("#cancel-transaction-btn");f.onclick=()=>{m(),setTimeout(i,50)},S.onclick=m}})}hideModal(e){let t=document.getElementById(e);t&&!t.classList.contains("hidden")&&(t.classList.add("modal-hiding"),t.addEventListener("animationend",()=>{t.classList.add("hidden"),t.classList.remove("modal-hiding","modal-visible","dismiss-disabled","intro-fade-in"),delete t.dataset.theme,delete t.dataset.dismissInside,delete t.dataset.dismissOutside,this.modalQueue.length>0&&!document.querySelector(".modal-backdrop:not(.hidden)")&&this.processModalQueue()},{once:!0}))}showProcessingAnimation(e,t){let i=this.cache.processingModal;if(!i)return;let a=i.querySelector("#processing-title"),s=i.querySelector("#processing-progress-bar"),o=i.querySelector("#processing-status");a.textContent=`Processing application for ${e}...`,s.style.width="0%",o.textContent="",i.classList.remove("hidden"),setTimeout(()=>{s.style.width="100%"},100),setTimeout(()=>{o.textContent="Processing complete!",setTimeout(()=>{this.hideModal("processing-modal"),t&&t()},1e3)},4e3)}createFloatingText(e,t,i,a="#fde047"){let s=document.createElement("div");s.textContent=e,s.className="floating-text",s.style.left=`${t-20}px`,s.style.top=`${i-40}px`,s.style.color=a,document.body.appendChild(s),setTimeout(()=>s.remove(),2450)}showGraph(e,t){this.activeGraphAnchor=e;let i=this.cache.graphTooltip,a=e.dataset.action;if(a===w.SHOW_PRICE_GRAPH){let s=e.dataset.goodId,o=t.player.inventories[t.player.activeShipId][s];i.innerHTML=this._renderPriceGraph(s,t,o)}else a===w.SHOW_FINANCE_GRAPH&&(i.innerHTML=this._renderFinanceGraph(t));i.style.display="block",this.updateGraphTooltipPosition()}hideGraph(){this.activeGraphAnchor&&(this.cache.graphTooltip.style.display="none",this.activeGraphAnchor=null)}updateGraphTooltipPosition(){if(!this.activeGraphAnchor)return;let e=this.cache.graphTooltip;if(e.style.display==="none")return;let t=this.activeGraphAnchor.closest(".item-card-container").getBoundingClientRect(),i=e.offsetHeight,a=t.top-i-10,s=t.left;a<10&&(a=t.bottom+10),e.style.left=`${s}px`,e.style.top=`${a}px`}showGenericTooltip(e,t,i="right"){this.activeGenericTooltipAnchor=e,this.activeGenericTooltipPosition=i;let a=this.cache.genericTooltip;a.innerHTML=t,a.style.display="block",this.updateGenericTooltipPosition()}hideGenericTooltip(){this.activeGenericTooltipAnchor&&(this.cache.genericTooltip.style.display="none",this.activeGenericTooltipAnchor=null)}updateGenericTooltipPosition(){if(!this.activeGenericTooltipAnchor)return;let e=this.cache.genericTooltip,t=this.activeGenericTooltipAnchor.getBoundingClientRect(),i=e.offsetWidth,a=e.offsetHeight,s,o;this.activeGenericTooltipPosition==="top"?(s=t.left+t.width/2-i/2,o=t.top-a-10,o<10&&(o=t.bottom+10)):(s=t.right+10,o=t.top+t.height/2-a/2,o<10&&(o=t.bottom+10)),s<10&&(s=10),s+i>window.innerWidth-10&&(s=window.innerWidth-i-10),e.style.left=`${s}px`,e.style.top=`${o}px`}_renderPriceGraph(e,t,i){let a=t.market.priceHistory[t.currentLocationId]?.[e];if(!a||a.length<2)return'<div class="text-gray-400 text-sm p-4">No Data Available!</div>';let s=p.COMMODITIES.find(L=>L.id===e),o=(s.basePriceRange[0]+s.basePriceRange[1])/2,r=280,n=140,l=35,d=a.map(L=>L.price),h=i?.avgCost>0?i.avgCost:null,u=[...d,o];h&&u.push(h);let m=Math.min(...u),g=Math.max(...u),f=g-m>0?g-m:1,S=L=>L/(a.length-1)*(r-l*2)+l,y=L=>n-l-(L-m)/f*(n-l*2.5),b=`<svg width="${r}" height="${n}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;b+='<g class="grid-lines" stroke="#1f2937" stroke-width="1">',b+=`<line x1="${l}" y1="${y(g)}" x2="${l}" y2="${n-l}" /><line x1="${l}" y1="${n-l}" x2="${r-l}" y2="${n-l}" />`,b+="</g>";let E=y(o);if(b+=`<line x1="${l}" y1="${E}" x2="${r-l}" y2="${E}" stroke="#facc15" stroke-width="1" stroke-dasharray="3 3" />`,b+=`<text x="${r-l+4}" y="${E+3}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg: ${v(o,!1)}</text>`,h){let L=y(h);b+=`<line x1="${l}" y1="${L}" x2="${r-l}" y2="${L}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" />`,b+=`<text x="${r-l+4}" y="${L+3}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid: ${v(h,!1)}</text>`}let A=a.map((L,O)=>`${S(O)},${y(L.price)}`).join(" ");b+=`<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${A}" />`;let k=a[0].day,N=a[a.length-1].day;return b+=`<text x="${l}" y="${n-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${k}</text>`,b+=`<text x="${r-l}" y="${n-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${N}</text>`,b+=`<text x="${l-8}" y="${y(m)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${v(m,!1)}</text>`,b+=`<text x="${l-8}" y="${y(g)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${v(g,!1)}</text>`,b+="</svg>",b}_renderFinanceGraph(e){let t=e.player.creditHistory||[];if(!t||t.length<2)return'<div class="text-gray-400 text-sm p-4">No Financial Data Available</div>';let i=280,a=140,s=35,o=t.map(S=>S.value),r=Math.min(...o),n=Math.max(...o),l=n-r>0?n-r:1,d=S=>S/(t.length-1)*(i-s*2)+s,h=S=>a-s-(S-r)/l*(a-s*2.5),u=`<svg width="${i}" height="${a}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;u+='<g class="grid-lines" stroke="#1f2937" stroke-width="1">',u+=`<line x1="${s}" y1="${h(n)}" x2="${s}" y2="${a-s}" />`,u+=`<line x1="${s}" y1="${a-s}" x2="${i-s}" y2="${a-s}" />`,u+="</g>";let m=t.map((S,y)=>`${d(y)},${h(S.value)}`).join(" ");u+=`<polyline fill="none" stroke="#10b981" stroke-width="2" points="${m}" />`;let g=t[0].day,f=t[t.length-1].day;return u+=`<text x="${s}" y="${a-s+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${g}</text>`,u+=`<text x="${i-s}" y="${a-s+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${f}</text>`,u+=`<text x="${s-8}" y="${h(r)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${v(r,!1)}</text>`,u+=`<text x="${s-8}" y="${h(n)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${v(n,!1)}</text>`,u+="</svg>",u}showTutorialToast({step:e,onSkip:t,onNext:i,gameState:a}){let s=this.cache.tutorialToastContainer,o=s.querySelector("#tt-arrow"),r=e.anchorElement==="body",n;r?n=this.cache.tutorialAnchorOverlay:(n=document.querySelector(e.anchorElement),n||(this.logger.error("TutorialService",`Anchor element "${e.anchorElement}" not found for step "${e.stepId}". Defaulting to overlay.`),n=this.cache.tutorialAnchorOverlay)),this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null);let l=e.text;if(l.includes("{shipName}")){let g=a.player.activeShipId,f=g?p.SHIPS[g].name:"your ship";l=l.replace(/{shipName}/g,f)}if(l.includes("{playerName}")){let g=a.player.name||"Captain";l=l.replace(/{playerName}/g,g)}this.cache.tutorialToastText.innerHTML=l;let d=e.size?.width||"auto",h=e.size?.height||"auto";if(s.style.width=d,s.style.height=h,r){let g=e.positionX??50,f=e.positionY??50;s.style.left=`${g}%`,s.style.top=`${f}%`,s.style.transform="translate(-50%, -50%)",o.style.display="none",s.removeAttribute("data-popper-placement")}else{s.style.left="",s.style.top="",s.style.transform="",o.style.display="block";let g={placement:"auto",modifiers:[{name:"offset",options:{offset:[0,10]}},{name:"preventOverflow",options:{padding:{top:60,bottom:60,left:10,right:10}}},{name:"flip",options:{fallbackPlacements:["top","bottom","left","right"]}},{name:"arrow",options:{element:"#tt-arrow",padding:5}}]},f=e.popperOptions?.modifiers?.find(b=>b.name==="offset"),S=g.modifiers.filter(b=>b.name!=="offset");f?S.push(f):S.push(g.modifiers.find(b=>b.name==="offset")),e.popperOptions?.modifiers;let y={placement:e.placement||e.popperOptions?.placement||g.placement,modifiers:S};this.popperInstance=Popper.createPopper(n,s,y)}s.classList.remove("hidden");let u=e.completion.type==="INFO";this.cache.tutorialToastNextBtn.classList.toggle("hidden",!u),u&&(this.cache.tutorialToastNextBtn.onclick=i);let m=!1;this.cache.tutorialToastSkipBtn.style.display=m?"block":"none",this.cache.tutorialToastSkipBtn.onclick=t,this.cache.tutorialToastText.scrollTop=0,this.debugService&&this.debugService.setActiveTutorialStep(e)}hideTutorialToast(){this.cache.tutorialToastContainer.classList.add("hidden"),this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null),this.applyTutorialHighlight(null),this.debugService&&this.debugService.clearActiveTutorialStep()}updateTutorialPopper(e){let t=this.cache.tutorialToastContainer,i=t.querySelector("#tt-arrow"),{isOverlayAnchor:a,width:s,height:o,percentX:r,percentY:n,placement:l,distance:d,skidding:h}=e;if(t.style.width=s>0?`${s}px`:"auto",t.style.height=o>0?`${o}px`:"auto",a)this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null,t.removeAttribute("data-popper-placement"),t.style.transform=""),t.style.left=`${r}%`,t.style.top=`${n}%`,t.style.transform="translate(-50%, -50%)",i.style.display="none";else{t.style.left="",t.style.top="",t.style.transform="",i.style.display="block";let u={placement:l,modifiers:[{name:"offset",options:{offset:[h,d]}},{name:"preventOverflow",options:{padding:{top:60,bottom:60,left:10,right:10}}},{name:"flip",options:{fallbackPlacements:["top","bottom","left","right"]}},{name:"arrow",options:{element:"#tt-arrow",padding:5}}]};this.popperInstance?this.popperInstance.setOptions(u).catch(m=>{this.logger.error("UIManager","Error updating Popper options:",m)}):this.logger.warn("UIManager","Popper instance needed but not found during update. Re-trigger toast if anchor type changed.")}}applyTutorialHighlight(e){this.activeHighlightConfig=e,this._renderHighlightsFromConfig(this.activeHighlightConfig)}_renderHighlightsFromConfig(e){let t=this.cache.tutorialHighlightOverlay;if(t){if(t.innerHTML="",!e){t.classList.add("hidden");return}t.classList.remove("hidden"),e.forEach(i=>{let a=document.createElement("div");a.className="tutorial-cue",a.style.left=`${i.x}px`,a.style.top=`${i.y}px`,a.style.width=`${i.width}px`,a.style.height=`${i.height}px`,a.style.transform=`rotate(${i.rotation}deg)`,a.style.opacity=i.style.opacity,i.style.animation!=="None"&&a.classList.add(`anim-${i.style.animation.toLowerCase()}`);let s="";i.type==="Shape"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 ${i.width} ${i.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${i.shapeType==="Rectangle"?`<rect x="0" y="0" width="100%" height="100%" rx="${i.style.borderRadius}" ry="${i.style.borderRadius}" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`:`<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`}
                     </svg>`:i.type==="Arrow"?s=`
                     <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                             <marker id="arrowhead-player" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${i.style.stroke}" />
                             </marker>
                        </defs>
                         <line x1="0" y1="25" x2="90" y2="25" stroke="${i.style.stroke}" stroke-width="${i.style.strokeWidth}" marker-end="url(#arrowhead-player)" />
                    </svg>
                `:i.type==="Spotlight"&&(a.style.borderRadius="50%",a.style.boxShadow=`0 0 0 9999px rgba(0,0,0,0.7), 0 0 ${i.style.glowIntensity||20}px ${i.style.glowIntensity||10}px ${i.style.glowColor||i.style.stroke}`),a.innerHTML=s;let o=a.querySelector("svg");o&&i.style.animation!=="None"&&(o.classList.add(`anim-${i.style.animation.toLowerCase()}`),o.style.setProperty("--glow-color",i.style.glowColor||i.style.stroke),o.style.setProperty("--anim-speed",`${i.style.animationSpeed}s`),o.style.setProperty("--glow-intensity",`${i.style.glowIntensity}px`)),t.appendChild(a)})}}showSkipTutorialModal(e){this.cache.skipTutorialModal.classList.remove("hidden");let i=()=>{e(),this.hideModal("skip-tutorial-modal")},a=()=>{this.hideModal("skip-tutorial-modal")};this.cache.skipTutorialConfirmBtn.onclick=i,this.cache.skipTutorialCancelBtn.onclick=a}showTutorialLogModal({seenBatches:e,onSelect:t}){let i=document.getElementById("tutorial-log-modal"),a=document.getElementById("tutorial-log-list");if(!i||!a){this.logger.error("UIManager","Tutorial log modal elements not found in DOM.");return}a.innerHTML="",e.length===0?a.innerHTML='<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>':e.forEach(s=>{let o=p.TUTORIAL_DATA[s];if(o){let r=document.createElement("li");r.innerHTML=`<button class="btn w-full text-center">${o.title}</button>`,r.onclick=()=>{i.classList.remove("visible"),t(s)},a.appendChild(r)}}),i.classList.add("visible")}showShipDetailModal(e,t,i){let{player:a,tutorials:s}=e,o=p.SHIPS[t],r;if(i==="shipyard"){let d=a.credits>=o.price,h=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",u=!d||h;r=`
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                             <h3 class="text-xl font-orbitron text-cyan-300">${o.name}</h3>
                            <p class="text-sm text-gray-400">Class ${o.class}</p>
                         </div>
                        <div class="text-right">
                             <p class="text-lg font-bold text-cyan-300">${v(o.price)}</p>
                        </div>
                    </div>
                     <p class="text-sm text-gray-400 flex-grow text-left">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${o.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${o.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${o.cargoCapacity}</span></div>
                    </div>
                     <button class="btn w-full mt-2" data-action="${w.BUY_SHIP}" data-ship-id="${t}" ${u?"disabled":""}>Purchase</button>
                </div>`}else{let d=a.shipStates[t],h=a.inventories[t],u=Y(h),m=t===a.activeShipId,g=a.ownedShipIds.length>1&&!m,f=0;d.upgrades&&d.upgrades.forEach(E=>{let A=x.getDefinition(E);A&&(f+=A.value)});let S=Math.floor((o.price+f)*$.SHIP_SELL_MODIFIER),y=(d.upgrades||[]).map(E=>{let A=x.getDefinition(E),k=A?A.name:E,N=A?A.description:"",L=A&&A.pillColor||"#94a3b8",O=1;E.endsWith("_III")?O=3:E.endsWith("_II")&&(O=2);let F=Me(L,-40),j=O>1?`2px solid ${F}`:`1px solid ${L}`,U=L;if(O===3){let W=Me(L,30),Q=Me(L,-80);U=`linear-gradient(135deg, ${W} 0%, ${L} 40%, ${Q} 100%)`}else O===2&&(U=`linear-gradient(to bottom, ${L}, ${Me(L,-20)})`);return`<span class="attribute-pill inline-block px-2 py-0.5 rounded text-xs font-bold mr-1 mb-1 cursor-help" 
                              title="${N}"
                              style="background: ${U}; border: ${j}; color: #0f172a; box-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                            ${k}
                        </span>`}).join(""),b=y?`<div class="mt-2 flex flex-wrap justify-center">${y}</div>`:"";r=`
                 <div class="ship-card p-4 flex flex-col space-y-3 ${m?"border-yellow-400":""}">
                    <h3 class="text-xl font-orbitron text-center ${m?"text-yellow-300":"text-cyan-300"}">${o.name}</h3>
                    <p class="text-sm text-gray-400 text-center">Class ${o.class}</p>
                    <p class="text-sm text-gray-400 flex-grow text-left my-2">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull</span><div class="text-green-400">${Math.floor(d.health)}/${o.maxHealth}</div></div>
                        <div><span class="text-gray-500">Fuel</span><div class="text-sky-400">${Math.floor(d.fuel)}/${o.maxFuel}</div></div>
                        <div><span class="text-gray-500">Cargo</span><div class="text-amber-400">${u}/${o.cargoCapacity}</div></div>
                    </div>
                    ${b}
                      <div class="grid grid-cols-2 gap-2 mt-2">
                        ${m?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${w.SELECT_SHIP}" data-ship-id="${t}">Board</button>`}
                        <button class="btn" data-action="${w.SELL_SHIP}" data-ship-id="${t}" ${g?"":"disabled"}>Sell<br>\u232C ${v(S,!1)}</button>
                    </div>
                 </div>`}let n=this.cache.shipDetailModal,l=n.querySelector("#ship-detail-content");l.innerHTML=r,n.classList.remove("hidden"),n.classList.add("modal-visible")}showLaunchModal(e){let t=this.lastKnownState;if(!t)return;let i=p.MARKETS.find(d=>d.id===e);if(!i)return;let a=i.navTheme,s=t.TRAVEL_DATA[t.currentLocationId]?.[e],o=t.player.shipStates[t.player.activeShipId];if(!s)return;let r=`
            <div class="launch-modal-wrapper panel-border" style="background: ${a.gradient}; color: ${a.textColor}; border-color: ${a.borderColor}; --theme-glow-color: ${a.borderColor};">
                <div class="flex-shrink-0">
                    <h3 class="font-orbitron">${i.name}</h3>
                     <p class="flavor-text italic">${i.launchFlavor}</p>
                </div>

                <div class="flex-grow flex items-center justify-center">
                     <button class="btn-launch-glow" data-action="travel" data-location-id="${e}" style="--launch-glow-color: ${a.borderColor};">Launch</button>
                </div>

                <div class="travel-info-text">
                     <p>Travel Time: ${s.time} Days</p>
                    <p>Fuel: ${Math.floor(o.fuel)} / ${s.fuelCost} required</p>
                </div>
            </div>`,n=this.cache.launchModal;this.cache.launchModalContent.innerHTML=r,n.classList.remove("hidden"),requestAnimationFrame(()=>{n.classList.add("modal-visible");let d=n.querySelector(".launch-modal-wrapper");d&&requestAnimationFrame(()=>{d.classList.add("is-glowing")})});let l=d=>{d.target.id==="launch-modal"&&(this.hideModal("launch-modal"),n.removeEventListener("click",l))};n.addEventListener("click",l)}showCargoDetailModal(e,t){let i=p.COMMODITIES.find(s=>s.id===t),a=e.player.inventories[e.player.activeShipId]?.[t];!i||!a||this.queueModal("cargo-detail-modal",null,null,null,{dismissInside:!0,dismissOutside:!0,footer:null,customSetup:(s,o)=>{let r=s.querySelector("#cargo-detail-content");r&&(r.innerHTML=St(i,a))}})}_getActiveShipTerminalElement(){let e=this.lastKnownState;if(!e)return null;let t=this.cache.hangarScreen;if(!t)return null;let i=t.querySelector("#hangar-carousel");if(!i)return null;let s=e.uiState.hangarShipyardToggleState==="hangar"?e.uiState.hangarActiveIndex||0:e.uiState.shipyardActiveIndex||0,r=i.querySelectorAll(".carousel-page")[s];return r?r.querySelector("#ship-terminal"):null}async runShipTransactionAnimation(e,t="is-dematerializing"){let i=this._getActiveShipTerminalElement();if(!i){this.logger.warn("UIManager",`No element to animate for ${e}. Skipping animation.`);return}await it(i,t)}renderStickyBar(e){let t=this.cache.missionStickyBar,i=t.querySelector(".sticky-content"),a=this.cache.stickyObjectiveText,s=this.cache.stickyObjectiveProgress;if(e.missions.activeMissionId){let o=p.MISSIONS[e.missions.activeMissionId];if(!o.objectives||o.objectives.length===0){t.style.display="none";return}let r=e.missions.missionProgress[o.id]||{objectives:{}},n=o.objectives[0],l=r.objectives[n.goodId]?.current??0,d=n.quantity,h=p.COMMODITIES.find(f=>f.id===n.goodId).name,u=p.MARKETS.find(f=>f.id===o.completion.locationId).name;a.textContent=`Deliver ${h} to ${u}`,s.textContent=`[${l}/${d}]`;let m=`host-${o.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`,g=e.missions.activeMissionObjectivesMet&&o.completion.locationId===e.currentLocationId?"mission-turn-in":"";i.className=`sticky-content sci-fi-frame ${m} ${g}`,t.style.display="block"}else t.style.display="none"}showMissionModal(e){let t=p.MISSIONS[e];if(!t)return;let{missions:i,currentLocationId:a}=this.lastKnownState,{activeMissionId:s,activeMissionObjectivesMet:o}=i;s===e&&o&&t.completion.locationId===a?this._showMissionCompletionModal(t):this._showMissionDetailsModal(t)}_showMissionDetailsModal(e){let{missions:t,tutorials:i}=this.lastKnownState,a=t.activeMissionId===e.id,o=t.activeMissionId&&!a;e.id==="mission_tutorial_02"&&i.activeBatchId==="intro_missions"&&i.activeStepId!=="mission_2_4"&&(o=!0);let r={dismissOutside:!0,customSetup:(n,l)=>{let d=n.querySelector(".modal-content");d.className="modal-content sci-fi-frame flex flex-col items-center text-center";let h=`host-${e.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`;d.classList.add(h),n.querySelector("#mission-modal-type").textContent=e.type;let u=n.querySelector("#mission-modal-objectives"),m='<h6 class="font-bold text-sm uppercase tracking-widest text-gray-400 text-center">OBJECTIVES:</h6><ul class="list-disc list-inside text-gray-300">'+e.objectives.map(S=>`<li>Deliver ${S.quantity}x ${p.COMMODITIES.find(y=>y.id===S.goodId).name}</li>`).join("")+"</ul>";u.innerHTML=m,u.style.display="block";let g=n.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let S=e.rewards.map(y=>y.type==="credits"?`<span class="credits-text-pulsing">${v(y.amount,!0)}</span>`:y.type.toUpperCase()).join(", ");g.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${S}</p>`,g.style.display="block"}else g.innerHTML="",g.style.display="none";let f=n.querySelector("#mission-modal-buttons");if(a){let S=e.isAbandonable!==!1;f.innerHTML=`<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${e.id}" ${S?"":"disabled"}>Abandon Mission</button>`}else f.innerHTML=`<button class="btn w-full" data-action="accept-mission" data-mission-id="${e.id}" ${o?"disabled":""}>Accept</button>`}};e.id==="mission_tutorial_01"&&i.activeStepId==="mission_1_1"&&(o=!0),this.queueModal("mission-modal",e.name,e.description,null,r)}_showMissionCompletionModal(e){let t={dismissOutside:!0,customSetup:(i,a)=>{let s=i.querySelector(".modal-content");s.className="modal-content sci-fi-frame flex flex-col items-center text-center";let o=`host-${e.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`;s.classList.add(o),i.querySelector("#mission-modal-title").textContent=e.completion.title,i.querySelector("#mission-modal-type").textContent="OBJECTIVES MET",i.querySelector("#mission-modal-description").innerHTML=e.completion.text;let r=i.querySelector("#mission-modal-objectives");r.style.display="none";let n=i.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let d=e.rewards.map(h=>h.type==="credits"?`<span class="credits-text-pulsing">${v(h.amount,!0)}</span>`:h.type.toUpperCase()).join(", ");n.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${d}</p>`,n.style.display="block"}else n.innerHTML="",n.style.display="none";let l=i.querySelector("#mission-modal-buttons");l.innerHTML=`<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${e.id}">${e.completion.buttonText}</button>`}};this.queueModal("mission-modal",e.completion.title,e.completion.text,null,t)}flashObjectiveProgress(){let e=this.cache.stickyObjectiveProgress;e&&(e.classList.add("objective-progress-flash"),setTimeout(()=>{e.classList.remove("objective-progress-flash")},700))}getModalIdFromEvent(e){let t=e.target.closest(".modal-backdrop");if(!t||!t.id||t.classList.contains("dismiss-disabled"))return null;let i=t.dataset.dismissInside==="true",a=t.dataset.dismissOutside==="true",s=!e.target.closest(".modal-content"),o=e.target.closest(".modal-content");return a&&s||i&&o?(t.id==="lore-modal"&&e.target.closest("#lore-modal-content")||t.id==="eula-modal"&&e.target.closest("#eula-modal-content")||t.id!=="lore-modal"&&t.id!=="eula-modal"&&!e.target.closest(".modal-content")||t.id==="lore-modal"&&!e.target.closest(".modal-content")||t.id==="eula-modal"&&!e.target.closest(".modal-content"),t.id):null}isClickInside(e,t){return e.target.closest(t)!==null}getTooltipContent(e){let t=e.target.closest("[data-tooltip]");return t?t.dataset.tooltip:null}showGameContainer(){this.cache.gameContainer.classList.remove("hidden"),this._setAppHeight(),requestAnimationFrame(()=>{this._setAppHeight()})}showMapDetailModal(e){let t=p.MARKETS.find(g=>g.id===e);if(!t)return;let i=this.cache.mapDetailModal,a=i.querySelector(".modal-content"),s=i.querySelector("#map-modal-content-container"),o=t.navTheme;a.style.background=o.gradient,a.style.setProperty("--theme-glow-color",o.borderColor),i.dataset.theme=e;let r=[],n=[];if(t.availabilityModifier)for(let[g,f]of Object.entries(t.availabilityModifier)){let S=p.COMMODITIES.find(y=>y.id===g);if(S){let y={name:S.name,style:le(S.styleClass)};f<1?r.push(y):f>1&&n.push(y)}}let l=g=>g.map(f=>`<span class="commodity-tag" style="border-color: ${f.style.hex}; background-color: ${f.style.hex}20; color: ${f.style.hex};">${f.name}</span>`).join(""),d=x.getStationQuirks(e),h="";d.length>0?h=d.map(g=>`<p class="font-roboto-mono imprinted-text-embedded" style="color: #facc15;">${x.getDefinition(g).description}</p>`).join(""):h=`<p class="font-roboto-mono imprinted-text-embedded">${t.specialty||"None reported"}</p>`;let u=`
            <div class="text-center">
                <h3 class="text-3xl font-orbitron" style="color: ${o.textColor};">${t.name}</h3>
                 <p class="text-lg italic imprinted-text">${t.launchFlavor}</p>
            </div>

            <div class="my-4 space-y-3">
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${o.textColor}; opacity: 0.7;">Fuel</h5>
                    <p class="font-roboto-mono imprinted-text-embedded"><span class="credits-text-pulsing">${v(t.fuelPrice,!0)}</span>/unit</p>
                 </div>
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${o.textColor}; opacity: 0.7;">Station Details</h5>
                    ${h}
                </div>
          </div>

            
             <div class="text-center">
                 <div>
                    <h5 class="font-bold imprinted-text">Exports:</h5>
                    <div>${n.length>0?l(n):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
                <div class="mt-2">
                     <h5 class."font-bold imprinted-text">Needs:</h5>
                     <div>${r.length>0?l(r):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
            </div>
        `;s.innerHTML=u,i.classList.remove("hidden"),i.classList.remove("is-glowing"),requestAnimationFrame(()=>{i.classList.add("modal-visible"),i.classList.add("is-glowing")});let m=g=>{(g.target.id==="map-detail-modal"||g.target.closest(".modal-content"))&&(this.hideMapDetailModal(),i.removeEventListener("click",m))};requestAnimationFrame(()=>{i.addEventListener("click",m)})}hideMapDetailModal(){let e=this.cache.mapDetailModal;if(e){e.classList.remove("is-glowing"),delete e.dataset.theme;let t=e.__mapDetailCloseHandler;t&&(e.removeEventListener("click",t),delete e.__mapDetailCloseHandler)}this.hideModal("map-detail-modal")}handleSetIntelTab(e){let t=e.dataset.target;t&&this.simulationService&&this.simulationService.setIntelTab(t)}updateIntelTab(e){let t=this.cache.intelScreen;if(!t)return;let i=t.querySelector(".sub-nav-bar");if(!i)return;t.querySelectorAll(".sub-nav-button").forEach(o=>o.classList.remove("active")),t.querySelectorAll(".intel-tab-content").forEach(o=>o.classList.remove("active"));let a=t.querySelector(`.sub-nav-button[data-target="${e}"]`),s=t.querySelector(`#${e}`);a&&a.classList.add("active"),s&&s.classList.add("active"),e==="intel-market-content"?i.classList.add("market-active"):i.classList.remove("market-active")}_findIntelPacket(e,t){let i=this.lastKnownState;if(i.intelMarket[t]){let a=i.intelMarket[t].find(s=>s.id===e);if(a)return a}for(let a of Object.keys(i.intelMarket)){let s=i.intelMarket[a].find(o=>o.id===e);if(s)return s}return this.logger.error("UIManager",`_findIntelPacket: Could not find packet ${e} anywhere.`),null}_formatIntelDetails(e,t,i,a){let s=p.MARKETS.find(m=>m.id===t.dealLocationId)?.name||"an unknown location",o=p.COMMODITIES.find(m=>m.id===t.commodityId)?.name||"a mystery commodity",r=`${Math.floor(t.discountPercent*100)}%`,n=i?v(-i,!0):"???",l=this.intelService.getCurrentDay(),d=Math.max(0,(t.expiryDay||0)-l),h;d===0?h="less than a day":d===1?h="1 day":h=`${d} days`;let u=e.replace(/\[location name\]/g,s).replace(/\[commodity name\]/g,o).replace(/\[discount amount %\]/g,r);return u=u.replace(/\[durationDays\]\s*days/g,h),u=u.replace(/\[durationDays\]/g,h),u=u.replace(/<span class="credits-text-pulsing"> \[credit price\]<\/span>/g,`<span class="text-glow-red">${n}</span>`),u=u.replace(/\[ credit price\]/g,`<span class="text-glow-red">${n}</span>`),u}handleShowIntelOffer(e){let{packetId:t,locationId:i,price:a}=e.dataset,s=this._findIntelPacket(t,i);if(!s)return;let o=p.MARKETS.find(h=>h.id===s.dealLocationId)?.name||"a distant market",r;if(s.messageKey)r=te[s.messageKey];else if(s.messageIndex!==void 0){let h=te[s.locationId];s.fallbackMsg&&(h=te[s.fallbackMsgSource]),h||(this.logger.warn("UIManager",`SaveCompat: No message array for ${s.locationId}, using fallback.`),h=te.CORP_FAILURE_01),r=h?h[s.messageIndex]:null}let n=(r?.sample||"Intel available at [location name].").replace("[location name]",o),l=parseInt(a,10),d=`
            <button class="btn btn-module btn-module-credit" 
                    data-action="buy_intel" 
                    data-packet-id="${s.id}" 
                    data-location-id="${i}" 
                    data-price="${l}">
                Purchase Intel (<span class="credits-text-pulsing">${v(l,!0)}</span>)
            </button>`;this.queueModal("event-modal","Intel Offer",n,null,{theme:i,dismissOutside:!0,footer:d})}handleBuyIntel(e,t){let{packetId:i,locationId:a,price:s}=e.dataset,o=parseInt(s,10);if(this.intelService.purchaseIntel(i,a,o)){this.hideModal("event-modal"),t&&this.createFloatingText(`-${v(o,!1)}`,t.clientX,t.clientY,"#f87171");let n=this._findIntelPacket(i,a);n&&this._showIntelDetailsModal(n,n.pricePaid,a)}else this.hideModal("event-modal"),this.queueModal("event-modal","Purchase Failed","Unable to purchase intel. You may already have an active deal or insufficient credits.")}handleShowIntelDetails(e){let{packetId:t,locationId:i}=e.dataset,a=this._findIntelPacket(t,i);if(!a)return;let s=a.pricePaid||this.intelService.calculateIntelPrice(a);this._showIntelDetailsModal(a,s,i)}_showIntelDetailsModal(e,t,i){let a,s=!1;e.messageKey?(a=te[e.messageKey]?.details||"No details found.",s=!0):e.messageIndex!==void 0?(this.logger.warn("UIManager",`SaveCompat: Found old packet with messageIndex ${e.messageIndex}`),a="Details for this expired intel packet are no longer available in the new system."):a={CORPORATE_LIQUIDATION:{details:"PACKET DECRYPTED: A [commodity name] surplus at [location name] allows for purchase at [discount amount %] below galactic average. This price is locked for [durationDays] days. A minor Corporate State is quietly liquidating assets to meet quarterly quotas. This is a standard, low-risk procurement opportunity. This intel was secured for [\u232C credit price]."},SUPPLY_CHAIN_SHOCK:{details:"DATA UNLOCKED: [commodity name] is available at [location name] for [discount amount %] off standard pricing. This window is open for [durationDays] days. A Merchant's Guild freighter was damaged, forcing them to offload their cargo here at a loss. Their misfortune is your gain. This access was [\u232C credit price]."}}[e.messageKey]?.details||"Packet is corrupted. No message data found.";let o=this._formatIntelDetails(a,e,t,s);this.queueModal("event-modal","Intel Unlocked",o,null,{theme:i,dismissInside:!0,dismissOutside:!0,footer:null,contentClass:"text-left"})}showUpgradeInstallationModal(e,t,i,a){let s=x.getDefinition(e);if(!s)return;let o=i.upgrades||[],r=o.length>=3,n=t>0?"Purchase Upgrade":"Install Upgrade",d=`<p class="mb-2">Install <span class="font-bold" style="color: ${s.pillColor||"#fff"}">${s.name}</span>?</p>`;t>0&&(d+=`<p class="text-base text-gray-400">Cost: <span class="credits-text-pulsing">${v(t,!0)}</span></p>`),d+=`<p class="mt-4 italic text-sm text-gray-500">${s.description}</p>`,this.queueModal("event-modal",n,d,null,{dismissOutside:!0,customSetup:(h,u)=>{let m=h.querySelector("#event-button-container"),g=h.querySelector("#event-description"),f=()=>{m.className="flex justify-center gap-4 w-full mt-4",m.innerHTML=`
                        <button id="confirm-install-btn" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-install-btn" class="btn">Cancel</button>
                    `;let b=h.querySelector("#confirm-install-btn");b.onclick=()=>{r?S():(u(),a(-1))},h.querySelector("#cancel-install-btn").onclick=u},S=()=>{let b=h.querySelector("#event-title");b.textContent="Upgrade Capacity Full";let E=o.map((A,k)=>{let N=x.getDefinition(A),L=N&&N.pillColor||"#fff",O=N?N.name:A,F=N&&N.statText||"Unknown Effect",j=N?v(N.value,!0):"0";return`<button class="btn btn-sm border border-gray-600 hover:border-red-500 w-full text-left px-4 py-3 bg-gray-800 flex justify-between items-center" data-idx="${k}">
                                    <div class="flex flex-col">
                                        <span class="font-bold" style="color: ${L}">${O}</span>
                                        <span class="text-xs text-gray-400 mt-1">${F}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs text-gray-500 block">Value</span>
                                        <span class="font-mono font-bold text-cyan-300 text-glow-cyan text-sm">${j}</span>
                                    </div>
                                </button>`}).join("");g.innerHTML=`
                        <p class="mb-4 text-orange-400">Ship systems are at maximum capacity (3/3).</p>
                        <p class="mb-4 text-sm text-gray-300">Select an existing upgrade to dismantle and replace:</p>
                        <div class="flex flex-col gap-2 w-full max-w-sm mx-auto">
                            ${E}
                        </div>
                    `,m.innerHTML='<button id="cancel-replace-btn" class="btn w-full mt-2">Cancel</button>',h.querySelector("#cancel-replace-btn").onclick=u,g.querySelectorAll("button[data-idx]").forEach(A=>{A.onclick=()=>{let k=parseInt(A.dataset.idx,10);y(k)}})},y=b=>{let E=o[b],A=x.getDefinition(E),k=h.querySelector("#event-title");k.textContent="Confirm Replacement";let N=A&&A.pillColor||"#fff",L=A?A.name:E;g.innerHTML=`
                        <p class="mb-4 text-red-400 font-bold">WARNING: Destructive Action</p>
                        <p class="mb-2">Replacing <span class="font-bold" style="color: ${N}">${L}</span> will <span class="font-bold text-red-500">permanently</span> destroy it.</p>
                        <p class="text-sm text-gray-400">You will receive no credits for the dismantled part.</p>
                    `,m.className="flex gap-4 w-full mt-4",m.innerHTML=`
                        <button id="final-confirm-btn" class="btn bg-red-600 hover:bg-red-500 text-white flex-1">Dismantle & Install</button>
                        <button id="final-cancel-btn" class="btn flex-1">Cancel</button>
                    `,h.querySelector("#final-confirm-btn").onclick=()=>{u(),a(b)},h.querySelector("#final-cancel-btn").onclick=u};f()}})}};var Ce=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a}async handle(e,t){let i=this.gameState.getState();if(t.hasAttribute("disabled"))return;let{action:a,...s}=t.dataset,o=null;switch(a){case w.BUY_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation();let n=e.target;this.uiManager.showShipTransactionConfirmation(r,"buy",async()=>{await this.simulationService.buyShip(r,{target:n}),this.tutorialService.checkState({type:"ACTION",action:w.BUY_SHIP})});break}case w.SELL_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation();let n=e.target;this.uiManager.showShipTransactionConfirmation(r,"sell",async()=>{await this.simulationService.sellShip(r,{target:n})});break}case w.SELECT_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation(),await this.simulationService.boardShip(r,e);break}case"set-services-tab":{let r=s.target;r&&(r==="supply"||r==="tuning")&&this.gameState.setState({uiState:{...i.uiState,servicesTab:r}});break}case"install_upgrade":{let{upgradeId:r,cost:n}=s;if(!r)return;let l=x.getDefinition(r),d=parseInt(n||"0",10),h=this.gameState.player,u=h.activeShipId,m=h.shipStates[u];if(h.credits<d){this.uiManager.queueModal("event-modal","Insufficient Funds","You cannot afford this upgrade.");return}this.uiManager.showUpgradeInstallationModal(r,d,m,g=>{d>0&&(this.gameState.player.credits-=d,this.uiManager.createFloatingText(`-${v(d,!1)}`,e.clientX,e.clientY,"#f87171")),g!==-1&&m.upgrades.splice(g,1),this.simulationService.playerActionService.executeInstallUpgrade(u,r),this.gameState.uiState.hangarShipyardToggleState="hangar";let f=this.gameState.player.ownedShipIds.indexOf(u);this.gameState.uiState.hangarActiveIndex=f!==-1?f:0,this.simulationService.setScreen(H.STARPORT,_.HANGAR)});break}case"show_ship_lore":{let r=i.uiState.hangarShipyardToggleState==="hangar",n=r?i.uiState.hangarActiveIndex||0:i.uiState.shipyardActiveIndex||0,l;if(r){let d=i.player.ownedShipIds;l=d[n]||d[0]}else{let d=this.simulationService._getShipyardInventory();if(d&&d.length>0){let h=Math.min(n,d.length-1),u=d[h];l=u?u[0]:null}}if(l&&p.SHIPS[l]){let d=p.SHIPS[l],h=`
                        <div class="ship-lore-modal-wrapper">
                            <div class="ship-lore-text">
                                ${d.lore||d.description}
                            </div>
                        </div>
                    `;this.uiManager.queueModal("event-modal",d.name,h,null,{dismissInside:!0,dismissOutside:!0,footer:null,contentClass:"text-left"})}break}case w.TOGGLE_HANGAR_MODE:this.uiManager.hideGenericTooltip(),s.mode&&this.gameState.uiState.hangarShipyardToggleState!==s.mode&&(this.gameState.uiState.hangarShipyardToggleState=s.mode,this.gameState.setState({}));break;case w.SET_HANGAR_PAGE:{let r=this.gameState.uiState.hangarShipyardToggleState==="hangar",n=r?this.gameState.uiState.hangarActiveIndex:this.gameState.uiState.shipyardActiveIndex,d=(r?i.player.ownedShipIds:this.simulationService._getShipyardInventory()).length,h,u=5;if(s.jumpDirection?s.jumpDirection==="next"?h=Math.min(d-1,n+u):h=Math.max(0,n-u):h=parseInt(s.index,10),isNaN(h))return;let m=document.getElementById("hangar-carousel");if(m){let g=Math.abs(h-n),f=Math.min(.8,.2+g*.1);m.style.transitionDuration=`${f}s`,this.simulationService.setHangarCarouselIndex(h,r?"hangar":"shipyard"),setTimeout(()=>{m&&(m.style.transitionDuration="")},f*1e3)}else this.simulationService.setHangarCarouselIndex(h,r?"hangar":"shipyard");break}case w.SET_SCREEN:{this.uiManager.hideGenericTooltip();let r=e.target.tagName==="A"&&t.contains(e.target);s.navId===i.activeNav&&!r?(this.gameState.subNavCollapsed=!this.gameState.subNavCollapsed,this.uiManager.render(this.gameState.getState())):(this.gameState.subNavCollapsed=!1,this.simulationService.setScreen(s.navId,s.screenId)),o={type:"ACTION",action:w.SET_SCREEN,navId:s.navId,screenId:s.screenId};break}case w.TRAVEL:this.uiManager.hideModal("launch-modal"),this.simulationService.travelTo(s.locationId),o={type:"ACTION",action:w.TRAVEL};break;case"set-intel-tab":this.uiManager.handleSetIntelTab(t);break;case"show_intel_offer":this.uiManager.handleShowIntelOffer(t);break;case"buy_intel":this.uiManager.handleBuyIntel(t,e);break;case"show_intel_details":this.uiManager.handleShowIntelDetails(t);break;case"show-mission-modal":this.uiManager.showMissionModal(s.missionId),o={type:"ACTION",action:"show-mission-modal"};break;case"show_cargo_detail":this.uiManager.showCargoDetailModal(i,s.goodId);break;case"show-launch-modal":this.uiManager.showLaunchModal(s.locationId);break;case"show-map-modal":this.uiManager.showMapDetailModal(s.locationId);break;case"close-map-modal":this.uiManager.hideMapDetailModal();break;case"show_eula_modal":e.preventDefault(),this.uiManager.showEulaModal();break;case"accept-mission":this.simulationService.missionService.acceptMission(s.missionId),this.uiManager.hideModal("mission-modal"),o={type:"ACTION",action:"accept-mission",missionId:s.missionId};break;case"abandon-mission":this.simulationService.missionService.abandonMission(),this.uiManager.hideModal("mission-modal");break;case"complete-mission":this.simulationService.missionService.completeActiveMission(),this.uiManager.hideModal("mission-modal"),o={type:"ACTION",action:"complete-mission"};break;case w.PAY_DEBT:this.simulationService.payOffDebt(e);break;case w.TAKE_LOAN:this.simulationService.takeLoan(JSON.parse(s.loanDetails),e);break;case w.PURCHASE_INTEL:this.logger.warn("ActionClickHandler","Obsolete ACTION_IDS.PURCHASE_INTEL called.");break;case w.ACQUIRE_LICENSE:this._handleAcquireLicense(s.licenseId,e);break;case w.TOGGLE_MARKET_CARD_VIEW:s.goodId&&(this.gameState.uiState.marketCardMinimized[s.goodId]=!this.gameState.uiState.marketCardMinimized[s.goodId],this.gameState.setState({}));break}o&&this.tutorialService.checkState(o)}_handleAcquireLicense(e,t){let i=p.LICENSES[e];if(i)if(i.type==="purchase"){let a=`${i.description}<br><br>Cost: <span class="text-glow-red">${v(-i.cost,!0)}</span>`;this.uiManager.queueModal("event-modal",`Purchase ${i.name}?`,a,null,{dismissOutside:!0,customSetup:(s,o)=>{let r=s.querySelector("#event-button-container");r.innerHTML=`
                        <button id="confirm-license-purchase" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-license-purchase" class="btn">Cancel</button>
                    `,s.querySelector("#confirm-license-purchase").onclick=()=>{let n=this.simulationService.purchaseLicense(e);n.success?t&&this.uiManager.createFloatingText(`-${v(i.cost,!1)}`,t.clientX,t.clientY,"#f87171"):n.error==="INSUFFICIENT_FUNDS"&&this.uiManager.queueModal("event-modal","Purchase Failed",`You cannot afford the ${v(i.cost)} fee for this license.`),o()},s.querySelector("#cancel-license-purchase").onclick=o}})}else i.type==="mission"&&this.uiManager.queueModal("event-modal",i.name,i.guidanceText)}};var Re=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.uiManager=i}handleInput(e){let t=e.target.closest('.transaction-controls input[type="number"]');if(t){let i=t.closest(".transaction-controls"),{goodId:a,mode:s}=i.dataset,o=parseInt(t.value,10)||0;this.uiManager.updateMarketCardDisplay(a,o,s),this._updateMaxButtonState(i,o,s,a)}}handleClick(e,t){let{action:i}=t.dataset;switch(i){case"toggle-trade-mode":case"confirm-trade":case"set-max-trade":case w.INCREMENT:case w.DECREMENT:this._performMarketAction(t,i,e);break}}_performMarketAction(e,t,i){let a=e.closest(".transaction-controls");if(!a)return;let{goodId:s,mode:o}=a.dataset,r=a.querySelector("input"),n=this.gameState.getState();switch(t){case"toggle-trade-mode":{let l=o==="buy"?"sell":"buy";a.dataset.mode=l;let d=parseInt(r.value)||0;this.uiManager.updateMarketCardDisplay(s,d,l),this._updateMaxButtonState(a,d,l,s);break}case"confirm-trade":{let l=parseInt(r.value)||0;if(l<=0)return;let d=o==="buy"?this.simulationService.buyItem(s,l):this.simulationService.sellItem(s,l);if(d){let h=o==="buy"?this.uiManager.getItemPrice(n,s)*l:d,u=o==="buy"?`-${v(h,!1)}`:`+${v(h,!1)}`,m=o==="buy"?"#f87171":"#34d399";if(this.uiManager.createFloatingText(u,i.clientX,i.clientY,m),o==="sell"){let g={type:"ACTION",action:"sell-item",goodId:s};this.simulationService.tutorialService.checkState(g)}}break}case"set-max-trade":{let l=this.simulationService._getActiveShip(),d=this.simulationService._getActiveInventory();if(o==="sell")r.value=d[s]?.quantity||0;else{let u=this.uiManager.getItemPrice(n,s),m=l.cargoCapacity-Y(d),g=u>0?Math.floor(n.player.credits/u):1/0,f=n.market.inventory[n.currentLocationId][s].quantity;r.value=Math.max(0,Math.min(m,g,f))}let h=parseInt(r.value)||0;this.uiManager.updateMarketCardDisplay(s,h,o),this._updateMaxButtonState(a,h,o,s);break}case w.INCREMENT:case w.DECREMENT:{let l=parseInt(r.value)||0,d=t===w.INCREMENT?l+1:Math.max(0,l-1);r.value=d,this.uiManager.updateMarketCardDisplay(s,d,o),this._updateMaxButtonState(a,d,o,s);break}}}_updateMaxButtonState(e,t,i,a){let s=this.gameState.getState(),o=this.simulationService._getActiveShip(),r=this.simulationService._getActiveInventory(),n;if(i==="sell")n=r[a]?.quantity||0;else{let d=this.uiManager.getItemPrice(s,a),h=o.cargoCapacity-Y(r),u=d>0?Math.floor(s.player.credits/d):1/0,m=s.market.inventory[s.currentLocationId][a].quantity;n=Math.max(0,Math.min(h,u,m))}let l=e.querySelector(".max-btn");t>0&&t===n?l.classList.add("pressed"):l.classList.remove("pressed")}};var Le=class{constructor(e,t){this.playerActionService=e,this.uiManager=t,this.refuelBtn=null,this.repairBtn=null,this.isRefueling=!1,this.isRepairing=!1,this.holdInterval=400,this.lastTickTime=0,this.animationFrameId=null,this.activeElementId=null,this.stopTimers={fuel:null,repair:null},this._boundHandleInteractionStart=this._handleInteractionStart.bind(this),this._boundHandleInteractionStop=this._handleInteractionStop.bind(this),this._boundHandlePointerMove=this._handlePointerMove.bind(this),this._boundLoop=this._loop.bind(this),this._boundStartRefueling=this._startRefueling.bind(this),this._boundStopRefueling=this._stopRefueling.bind(this),this._boundStartRepairing=this._startRepairing.bind(this),this._boundStopRepairing=this._stopRepairing.bind(this),this._boundStopStepperHold=this._stopStepperHold.bind(this),this.isStepperHolding=!1,this.stepperInitialDelay=400,this.stepperRepeatRate=1e3/7,this.stepperTimeout=null,this.stepperInterval=null,this.stepperStartTime=null,this.stepperTarget=null}bindHoldEvents(){document.body.removeEventListener("pointerdown",this._boundHandleInteractionStart),document.body.addEventListener("pointerdown",this._boundHandleInteractionStart),window.removeEventListener("pointerup",this._boundHandleInteractionStop,{capture:!0}),window.addEventListener("pointerup",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("pointercancel",this._boundHandleInteractionStop,{capture:!0}),window.addEventListener("pointercancel",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("pointermove",this._boundHandlePointerMove),window.addEventListener("pointermove",this._boundHandlePointerMove,{passive:!1}),document.body.removeEventListener("mousedown",this._boundHandleInteractionStart),document.body.removeEventListener("touchstart",this._boundHandleInteractionStart),window.removeEventListener("mouseup",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchend",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchcancel",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchmove",this._boundHandlePointerMove)}_handleInteractionStart(e){if(this.activeElementId||this.stepperTarget)return;let t=e.target.closest("#refuel-btn");if(t&&!t.disabled){this._startRefueling(e);return}let i=e.target.closest("#repair-btn");if(i&&!i.disabled){this._startRepairing(e);return}let a=e.target.closest(".qty-stepper button");if(a&&!a.disabled){e.pointerType==="touch"&&e.preventDefault(),this._startStepperHold(e,a);return}}_handleInteractionStop(e){this.activeElementId==="refuel-btn"?this._stopRefueling():this.activeElementId==="repair-btn"?this._stopRepairing():this.stepperTarget&&this._stopStepperHold()}_handlePointerMove(e){if(this.activeElementId!=="refuel-btn"&&this.activeElementId!=="repair-btn"||e.pointerType!=="touch")return;let t=document.elementFromPoint(e.clientX,e.clientY);if(!t){this.activeElementId==="refuel-btn"&&this._stopRefueling(),this.activeElementId==="repair-btn"&&this._stopRepairing();return}if(t.classList.contains("floating-text"))return;let i=document.getElementById(this.activeElementId);t===i||i&&i.contains(t)||(this.activeElementId==="refuel-btn"&&this._stopRefueling(),this.activeElementId==="repair-btn"&&this._stopRepairing())}_loop(e){if(!this.isRefueling&&!this.isRepairing){this.animationFrameId=null;return}let t=!1;if(e-this.lastTickTime>=this.holdInterval){this.lastTickTime=e;let i=0;if(this.refuelBtn=document.getElementById("refuel-btn"),this.repairBtn=document.getElementById("repair-btn"),this.isRefueling)if(i=this.playerActionService.refuelTick(),this._applyVisuals("fuel"),i>0&&this.refuelBtn){let a=this.refuelBtn.getBoundingClientRect();this.uiManager.createFloatingText(`-${v(i,!1)}`,a.left+a.width/2,a.top,"#f87171"),t=!0}else this.isRefueling=!1;if(this.isRepairing)if(i=this.playerActionService.repairTick(),this._applyVisuals("repair"),i>0&&this.repairBtn){let a=this.repairBtn.getBoundingClientRect();this.uiManager.createFloatingText(`-${v(i,!1)}`,a.left+a.width/2,a.top,"#f87171"),t=!0}else this.isRepairing=!1;t||(!this.isRefueling&&this.activeElementId==="refuel-btn"&&this._removeVisualsWithDelay("fuel"),!this.isRepairing&&this.activeElementId==="repair-btn"&&this._removeVisualsWithDelay("repair"))}this.isRefueling||this.isRepairing?this.animationFrameId=requestAnimationFrame(this._boundLoop):this.animationFrameId=null}_applyVisuals(e){e==="fuel"&&this.stopTimers.fuel&&(clearTimeout(this.stopTimers.fuel),this.stopTimers.fuel=null),e==="repair"&&this.stopTimers.repair&&(clearTimeout(this.stopTimers.repair),this.stopTimers.repair=null);let t=document.getElementById("refuel-btn"),i=document.getElementById("repair-btn"),a=e==="fuel"?t:i,s=e==="fuel"?"fuel-bar":"repair-bar";if(a){a.classList.add("holding");let o=a.closest(".service-module");o&&o.classList.add("active-service");let r=document.getElementById(s);if(r){r.classList.add("filling");let n=r.closest(".progress-bar-container");n&&n.classList.add("active-pulse")}}}_removeVisualsWithDelay(e){e==="fuel"?(this.stopTimers.fuel&&clearTimeout(this.stopTimers.fuel),this.stopTimers.fuel=setTimeout(()=>{this._removeVisuals("fuel"),this.stopTimers.fuel=null},400)):e==="repair"&&(this.stopTimers.repair&&clearTimeout(this.stopTimers.repair),this.stopTimers.repair=setTimeout(()=>{this._removeVisuals("repair"),this.stopTimers.repair=null},400))}_removeVisuals(e){let t=document.getElementById("refuel-btn"),i=document.getElementById("repair-btn"),a=e==="fuel"?t:i,s=e==="fuel"?"fuel-bar":"repair-bar";if(a){a.classList.remove("holding");let o=a.closest(".service-module");o&&o.classList.remove("active-service");let r=document.getElementById(s);if(r){r.classList.remove("filling");let n=r.closest(".progress-bar-container");n&&n.classList.remove("active-pulse")}}}_startRefueling(e){if(!(e.button&&e.button!==0)&&(e.pointerType==="touch"&&e.preventDefault(),this.refuelBtn=e.target.closest("#refuel-btn"),!!this.refuelBtn)){try{this.refuelBtn.setPointerCapture(e.pointerId)}catch{}this.activeElementId=this.refuelBtn.id,this.isRefueling=!0,this._applyVisuals("fuel"),this.lastTickTime=performance.now()-this.holdInterval,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(this._boundLoop))}}_stopRefueling(){if(this.activeElementId!=="refuel-btn")return;let e=document.getElementById(this.activeElementId);if(e&&e.hasPointerCapture(1))try{}catch{}this.activeElementId=null,this.isRefueling=!1,this._removeVisualsWithDelay("fuel")}_startRepairing(e){if(!(e.button&&e.button!==0)&&(e.pointerType==="touch"&&e.preventDefault(),this.repairBtn=e.target.closest("#repair-btn"),!!this.repairBtn)){try{this.repairBtn.setPointerCapture(e.pointerId)}catch{}this.activeElementId=this.repairBtn.id,this.isRepairing=!0,this._applyVisuals("repair"),this.lastTickTime=performance.now()-this.holdInterval,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(this._boundLoop))}}_stopRepairing(){this.activeElementId==="repair-btn"&&(this.activeElementId=null,this.isRepairing=!1,this._removeVisualsWithDelay("repair"))}_startStepperHold(e,t){this._stopStepperHold(),this.isStepperHolding=!1;let i=t.closest(".transaction-controls");if(!i)return;try{t.setPointerCapture(e.pointerId)}catch{}e.preventDefault();let a=t.closest(".qty-stepper"),s=i.querySelector("input"),o=t.classList.contains("qty-up")?1:-1;this.stepperTarget={input:s,direction:o,element:a,button:t,pointerId:e.pointerId},this.stepperTimeout=setTimeout(()=>{this.isStepperHolding=!0,this.stepperStartTime=Date.now(),this.stepperTarget&&this.stepperTarget.element&&this.stepperTarget.element.classList.add("stepper-active"),this._stepperTick(),this.stepperInterval=setInterval(()=>this._stepperTick(),this.stepperRepeatRate)},this.stepperInitialDelay)}_stopStepperHold(){if(this.stepperTarget){if(this.stepperTarget.button&&this.stepperTarget.button.hasPointerCapture(this.stepperTarget.pointerId))try{this.stepperTarget.button.releasePointerCapture(this.stepperTarget.pointerId)}catch{}clearTimeout(this.stepperTimeout),clearInterval(this.stepperInterval),this.stepperTarget.element&&this.stepperTarget.element.classList.remove("stepper-active"),this.stepperTimeout=null,this.stepperInterval=null,this.stepperStartTime=null,this.stepperTarget=null}}_stepperTick(){if(!this.stepperTarget){this._stopStepperHold();return}let{input:e,direction:t}=this.stepperTarget,i=(Date.now()-this.stepperStartTime)/1e3,a=1;i>5?a=25:i>2&&(a=5);let s=parseInt(e.value,10)||0;s+=a*t,e.value=Math.max(0,s),e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}};var Ne=class{constructor(e,t){this.gameState=e,this.simulationService=t,this.isScrolling=!1,this.scrollTimeout=null,this.rafId=null,this.state={isDragging:!1,startX:0,startTranslate:0,currentTranslate:0,activeCarousel:null,containerWidth:0,pageCount:0,currentIndex:0,moved:!1}}handleWheel(e){if(this.isScrolling)return;let t=e.deltaY>0?"next":"prev",i=this.gameState.getState(),a=i.uiState.hangarShipyardToggleState,s=a==="hangar"?i.uiState.hangarActiveIndex||0:i.uiState.shipyardActiveIndex||0,o=t==="next"?s+1:s-1;this._preloadForTarget(o,a),this.simulationService.cycleHangarCarousel(t),this.isScrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1},300)}handleDragStart(e){let t=e.target.closest(".carousel-container"),i=t?t.querySelector("#hangar-carousel"):null;if(e.target.closest("[data-action]")||!i||i.children.length<=1){this.state.isDragging=!1;return}e.preventDefault();let a=this.gameState.getState(),s=a.uiState.hangarShipyardToggleState==="hangar";this.state.isDragging=!0,this.state.activeCarousel=i,this.state.startX=e.pageX??e.touches[0].pageX,this.state.containerWidth=i.parentElement.offsetWidth,this.state.pageCount=i.children.length,this.state.currentIndex=s?a.uiState.hangarActiveIndex||0:a.uiState.shipyardActiveIndex||0,this.state.startTranslate=-this.state.currentIndex*this.state.containerWidth,this.state.currentTranslate=this.state.startTranslate,this.state.moved=!1,i.style.transitionDuration="0s",document.body.style.cursor="grabbing"}handleDragMove(e){if(!this.state.isDragging)return;e.preventDefault();let i=(e.pageX??e.touches[0].pageX)-this.state.startX;this.state.currentTranslate=this.state.startTranslate+i,Math.abs(i)>10&&(this.state.moved=!0),this.state.activeCarousel&&(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.state.activeCarousel&&(this.state.activeCarousel.style.transform=`translateX(${this.state.currentTranslate}px)`)}))}handleDragEnd(){if(!this.state.isDragging)return;this.rafId&&cancelAnimationFrame(this.rafId);let{activeCarousel:e,startTranslate:t,currentTranslate:i,currentIndex:a,containerWidth:s,pageCount:o}=this.state;if(this.state.isDragging=!1,document.body.style.cursor="default",!e)return;e.style.transitionDuration="";let r=i-t,n=a,l=s/4;r<-l&&a<o-1?n++:r>l&&a>0&&n--;let d=this.gameState.uiState.hangarShipyardToggleState;this._preloadForTarget(n,d),this.simulationService.setHangarCarouselIndex(n,d),setTimeout(()=>{this.state.moved=!1},50)}_preloadForTarget(e,t){let a=this.gameState.getState().player,s=[];t==="hangar"?s=a.ownedShipIds:this.simulationService._getShipyardInventory&&(s=this.simulationService._getShipyardInventory().map(([o])=>o)),B.preloadBuffer(s,e,5,a.visualSeed)}wasMoved(){return this.state.moved}};var Oe=class{constructor(e,t){this.gameState=e,this.uiManager=t,this.activeTooltipTarget=null,this.activeStatusTooltip=null}handleClick(e){let t=e.target.closest("[data-action]");if(this.activeStatusTooltip&&!this.uiManager.isClickInside(e,'[data-action="toggle-tooltip"]')&&(this.activeStatusTooltip.classList.remove("visible"),this.activeStatusTooltip=null),this.uiManager.isClickInside(e,"#graph-tooltip, #generic-tooltip")){this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null;return}if(t){let{action:i}=t.dataset;switch(i){case"toggle-tooltip":this._toggleStatusTooltip(t);return;case"show-attribute-tooltip":if(e.stopPropagation(),e.preventDefault(),this.activeTooltipTarget===t)this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null;else{let a=t.dataset.attributeId,s=x.getDefinition(a);if(s){let o=`<span class="font-roboto-mono text-xs text-gray-200 leading-tight">${s.description}</span>`;this.uiManager.showGenericTooltip(t,o,"top"),this.activeTooltipTarget=t}}return;case w.SHOW_PRICE_GRAPH:case w.SHOW_FINANCE_GRAPH:this.uiManager.isMobile&&(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget===t?(this.uiManager.hideGraph(),this.activeTooltipTarget=null):(this.uiManager.showGraph(t,this.gameState.getState()),this.activeTooltipTarget=t));break}}this.activeTooltipTarget&&t!==this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null),this.uiManager.isMobile&&this._handleMobileTooltip(e),this._handleLoreAndTutorialLog(e)}handleMouseOver(e){if(this.uiManager.isMobile)return;let t=e.target.closest(`[data-action="${w.SHOW_PRICE_GRAPH}"], [data-action="${w.SHOW_FINANCE_GRAPH}"]`);t&&this.uiManager.showGraph(t,this.gameState.getState())}handleMouseOut(e){if(this.uiManager.isMobile)return;e.target.closest(`[data-action="${w.SHOW_PRICE_GRAPH}"], [data-action="${w.SHOW_FINANCE_GRAPH}"]`)&&this.uiManager.hideGraph()}_toggleStatusTooltip(e){let t=e.querySelector(".status-tooltip");t&&(this.activeStatusTooltip===t?(t.classList.remove("visible"),this.activeStatusTooltip=null):(this.activeStatusTooltip&&this.activeStatusTooltip.classList.remove("visible"),t.classList.add("visible"),this.activeStatusTooltip=t))}_handleMobileTooltip(e){let t=e.target.closest("[data-tooltip]");t&&!t.closest('[data-action="toggle-tooltip"]')&&(this.uiManager.hideGraph(),this.activeTooltipTarget===t?(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null):(this.uiManager.showGenericTooltip(t,t.dataset.tooltip),this.activeTooltipTarget=t))}_handleLoreAndTutorialLog(e){let t=e.target.closest(".tutorial-container"),i=e.target.closest(".lore-container"),a=document.querySelector(".lore-tooltip.visible, .tutorial-tooltip.visible");a&&!e.target.closest(".lore-tooltip, .tutorial-tooltip")&&a.classList.remove("visible"),i&&i.querySelector(".lore-tooltip")?.classList.toggle("visible"),t&&this.uiManager.showTutorialLogModal({seenBatches:this.gameState.tutorials.seenBatchIds,onSelect:s=>this.tutorialService.triggerBatch(s)})}};var ke=class{constructor(e,t,i,a,s=null,o){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a,this.debugService=s,this.logger=o,this.actionClickHandler=new Ce(e,t,i,a),this.marketEventHandler=new Re(e,t,i),this.holdEventHandler=new Le(this.simulationService.playerActionService,i),this.carouselEventHandler=new Ne(e,t),this.tooltipHandler=new Oe(e,i),this.marketActions=new Set(["toggle-trade-mode","confirm-trade","set-max-trade",w.INCREMENT,w.DECREMENT])}bindEvents(){document.body.addEventListener("click",i=>this._handleClick(i)),document.body.addEventListener("dblclick",i=>i.preventDefault()),document.body.addEventListener("mouseover",i=>this.tooltipHandler.handleMouseOver(i)),document.body.addEventListener("mouseout",i=>this.tooltipHandler.handleMouseOut(i)),document.addEventListener("keydown",i=>this._handleKeyDown(i)),document.body.addEventListener("input",i=>this.marketEventHandler.handleInput(i)),document.body.addEventListener("contextmenu",i=>i.preventDefault()),document.body.addEventListener("wheel",i=>{i.target.closest(".carousel-container")&&(i.preventDefault(),this.carouselEventHandler.handleWheel(i))},{passive:!1});let e=i=>{let a=i.target.closest("[data-action]");a||this.uiManager.hideGenericTooltip(),!(a||i.target.closest(".qty-stepper button"))&&this.carouselEventHandler.handleDragStart(i)};document.body.addEventListener("mousedown",e),document.body.addEventListener("touchstart",i=>{let a=i.target.closest("[data-action]");(i.target.closest("#refuel-btn")||i.target.closest("#repair-btn")||i.target.closest(".carousel-container"))&&!a&&i.preventDefault(),e(i)},{passive:!1});let t=()=>{this.carouselEventHandler.handleDragEnd()};document.body.addEventListener("mouseup",t),document.body.addEventListener("mouseleave",t),document.body.addEventListener("touchend",t),document.body.addEventListener("touchcancel",t),document.body.addEventListener("mousemove",i=>this.carouselEventHandler.handleDragMove(i)),document.body.addEventListener("touchmove",i=>{this.carouselEventHandler.state.isDragging&&i.preventDefault(),this.carouselEventHandler.handleDragMove(i)},{passive:!1}),window.addEventListener("resize",()=>this.uiManager.render(this.gameState.getState())),this.uiManager.cache.missionStickyBar&&this.uiManager.cache.missionStickyBar.addEventListener("click",()=>{this.simulationService.setScreen(H.DATA,_.MISSIONS)}),this.holdEventHandler.bindHoldEvents()}async _handleClick(e){if(this.carouselEventHandler.wasMoved()||this.holdEventHandler.isStepperHolding){this.holdEventHandler.isStepperHolding&&(this.holdEventHandler.isStepperHolding=!1),e.preventDefault();return}let t=this.gameState.getState(),i=e.target.closest("[data-action]");if(this.tooltipHandler.handleClick(e),i){let s=i.dataset.action;if(s===w.DEBUG_SIMPLE_START){this.debugService&&this.debugService.simpleStart();return}if(s==="show_lore"){e.preventDefault();let o=i.dataset.loreId;o&&this.uiManager.showLoreModal(o);return}this.marketActions.has(s)?this.marketEventHandler.handleClick(e,i):await this.actionClickHandler.handle(e,i);return}if(t.introSequenceActive&&!t.tutorials.activeBatchId){this.simulationService.handleIntroClick(e);return}if(t.isGameOver)return;let a=this.uiManager.getModalIdFromEvent(e);a&&a!=="lore-modal"&&this.uiManager.hideModal(a)}_handleKeyDown(e){this.gameState.isGameOver||e.ctrlKey||e.metaKey||(e.key==="`"||e.key==="&")&&this.debugService&&this.debugService.toggleVisibility()}};var De=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.simulationService=i,this.logger=s,this.activeBatchId=null,this.activeStepId=null,this.screenToNavMap={};for(let o in a)for(let r in a[o].screens)this.screenToNavMap[r]=o}checkState(e=null){if(this.activeBatchId&&this.activeStepId){let i=p.TUTORIAL_DATA[this.activeBatchId].steps.find(a=>a.stepId===this.activeStepId);i&&this._matchesCondition(i.completion,e)&&this.advanceStep();return}for(let t in p.TUTORIAL_DATA){let i=p.TUTORIAL_DATA[t],a=this.gameState.tutorials.seenBatchIds.includes(t),s=this.gameState.tutorials.skippedTutorialBatches.includes(t);if(!a&&!s){let o=e||{type:K.SCREEN_LOAD,screenId:this.gameState.activeScreen};if(this._matchesCondition(i.trigger,o)){this.triggerBatch(t);break}}}}triggerBatch(e,t=null){if(!p.TUTORIAL_DATA[e])return;let i=p.TUTORIAL_DATA[e];if(i.trigger.type===K.SCREEN_LOAD){let s=i.trigger.screenId;if(this.gameState.activeScreen!==s){let o=this.screenToNavMap[s];o&&this.simulationService.setScreen(o,s)}}this.activeBatchId=e,this.gameState.tutorials.activeBatchId=e,this.gameState.tutorials.seenBatchIds.includes(e)||this.gameState.tutorials.seenBatchIds.push(e),this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_START",`Starting tutorial batch: ${e}`),this.gameState.setState(this.gameState),this.uiManager.render(this.gameState.getState());let a=t||i.steps[0].stepId;this._displayStep(a)}skipActiveTutorial(){this.activeBatchId&&(this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)||this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId),this.logger.info.player(this.gameState.day,"TUTORIAL_SKIP",`Skipped tutorial: ${this.activeBatchId}`),this._endBatch(),this.gameState.setState(this.gameState))}advanceStep(){if(!this.activeStepId||!this.activeBatchId)return;let t=p.TUTORIAL_DATA[this.activeBatchId].steps.find(i=>i.stepId===this.activeStepId);if(this.uiManager.hideTutorialToast(),t&&t.nextStepId)this._displayStep(t.nextStepId);else{let i=this.activeBatchId;this._endBatch(),this.gameState.introSequenceActive&&i?.startsWith("intro_")&&this.simulationService._continueIntroSequence(i)}}_displayStep(e){if(!this.activeBatchId)return;let t=p.TUTORIAL_DATA[this.activeBatchId],i=t.steps.find(a=>a.stepId===e);if(!i){this._endBatch();return}if(i.hasOwnProperty("navLock"))this.gameState.tutorials.navLock=i.navLock;else if(t.navLock){let a=this.gameState.activeScreen,s=this.screenToNavMap[a];this.gameState.tutorials.navLock={navId:s,screenId:a}}else this.gameState.tutorials.navLock=null;this.activeStepId=e,this.gameState.tutorials.activeStepId=e,this.logger.info.system("Tutorial",this.gameState.day,"STEP_DISPLAY",`Displaying step: ${e}`),this.uiManager.showTutorialToast({step:i,onSkip:()=>this.uiManager.showSkipTutorialModal(()=>this.skipActiveTutorial()),onNext:()=>this.advanceStep(),gameState:this.gameState.getState()}),this.uiManager.render(this.gameState.getState())}_endBatch(){this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_END",`Ending tutorial batch: ${this.activeBatchId}`),this.uiManager.hideTutorialToast(),this.activeBatchId=null,this.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.navLock=null}_matchesCondition(e,t){return!e||!t?!1:Array.isArray(e)?e.every(i=>this._matchesSingleCondition(i,t)):this._matchesSingleCondition(e,t)}_matchesSingleCondition(e,t){if(e.type!==t.type)return!1;switch(e.type){case K.SCREEN_LOAD:return e.screenId===t.screenId;case K.ACTION:return e.action===w.SET_SCREEN&&t.action===w.SET_SCREEN?e.navId===t.navId&&e.screenId===t.screenId:e.action===t.action;case K.INFO:return!0;default:return!1}}};var Pe=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=null}setSimulationService(e){this.simulationService=e}arePrerequisitesMet(e){let t=p.MISSIONS[e];return!t||!t.prerequisites?!0:t.prerequisites.every(i=>{switch(i.type){case"mission_completed":return this.gameState.missions.completedMissionIds.includes(i.missionId);case"revealed_tier":return this.gameState.player.revealedTier>=i.tier;default:return!1}})}getAvailableMissions(){let{activeMissionId:e,completedMissionIds:t}=this.gameState.missions;return Object.values(p.MISSIONS).filter(i=>i.id!==e&&!t.includes(i.id)&&this.arePrerequisitesMet(i.id))}acceptMission(e){let t=p.MISSIONS[e];this.gameState.missions.activeMissionId||!t||!this.arePrerequisitesMet(e)||(this.gameState.missions.activeMissionId=e,this.gameState.missions.missionProgress[e]={objectives:{}},this.logger.info.player(this.gameState.day,"MISSION_ACCEPT",`Accepted mission: ${e}`),this.simulationService.grantMissionCargo(e),this.checkTriggers(),!t.objectives||t.objectives.length===0?this.completeActiveMission():this.uiManager.render(this.gameState.getState()))}abandonMission(){let e=this.gameState.missions.activeMissionId;e&&(this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.logger.info.player(this.gameState.day,"MISSION_ABANDON",`Abandoned mission: ${e}`),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}checkTriggers(){let{activeMissionId:e}=this.gameState.missions;if(!e){this.gameState.missions.activeMissionObjectivesMet&&(this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}));return}let t=p.MISSIONS[e],i=this.gameState.player.inventories[this.gameState.player.activeShipId];if(!t||!i){this.gameState.missions.activeMissionObjectivesMet=!1;return}let a=!0,s=!1;t.objectives.forEach(o=>{if(o.type==="have_item"){let r=i[o.goodId]?.quantity||0,n=this.gameState.missions.missionProgress[e];n.objectives[o.goodId]||(n.objectives[o.goodId]={current:0}),n.objectives[o.goodId].current!==r&&(n.objectives[o.goodId].current=r,s=!0),r<o.quantity&&(a=!1)}}),(this.gameState.missions.activeMissionObjectivesMet!==a||s)&&(a&&!this.gameState.missions.activeMissionObjectivesMet&&this.logger.info.player(this.gameState.day,"OBJECTIVES_MET",`All objectives for mission ${e} are met.`),this.gameState.missions.activeMissionObjectivesMet=a,this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),s&&this.uiManager.flashObjectiveProgress())}completeActiveMission(){let{activeMissionId:e}=this.gameState.missions;if(!e)return;let t=this.gameState.missions.activeMissionObjectivesMet,i=p.MISSIONS[e];if((!i.objectives||i.objectives.length===0)&&(this.gameState.missions.activeMissionObjectivesMet=!0),!this.gameState.missions.activeMissionObjectivesMet){this.gameState.missions.activeMissionObjectivesMet=t;return}let a=this.gameState.player.inventories[this.gameState.player.activeShipId];i.objectives.forEach(s=>{s.type==="have_item"&&a[s.goodId]&&(a[s.goodId].quantity-=s.quantity)}),this.simulationService&&this.simulationService._grantRewards(i.rewards,i.name),this.logger.info.player(this.gameState.day,"MISSION_COMPLETE",`Completed mission: ${e}`),this.gameState.missions.completedMissionIds.push(e),this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}};var Z={DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},se={player:"#60a5fa",system:"#4ade80",state:"#facc15",warn:"#f59e0b",error:"#f87171",group:"#d4d4d8"},zt=100,ie=Z.INFO,$e=[];function de(c){$e.push(c),$e.length>zt&&$e.shift()}function We(c,e,t,i,a,s,o=null){if(c>ie)return;let r=`[${e}] [Day ${t}] ${i}: ${a}`;de(r),console.log(`%c[${e}] %c[Day ${t}] %c${i}: %c${a}`,`color: ${s}; font-weight: bold;`,"color: #9ca3af;","color: #e5e7eb; font-weight: bold;","color: inherit;",o||""),o&&console.dir(o)}var he={setLevel:c=>{let e=Z[c.toUpperCase()];typeof e<"u"?(ie=e,console.log(`%c[Logger] Log level set to: ${c}`,`color: ${se.state}; font-weight: bold;`)):he.warn("LoggingService",`Attempted to set invalid log level: ${c}`)},getLogHistory:()=>$e.join(`
`),info:{player:(c,e,t,i=null)=>We(Z.INFO,"Player",c,e,t,se.player,i),system:(c,e,t,i,a=null)=>We(Z.INFO,c,e,t,i,se.system,a),state:(c,e,t,i=null)=>We(Z.INFO,"Game",c,e,t,se.state,i)},warn:(c,e)=>{if(Z.WARN>ie)return;let t=`[${c}] WARN: ${e}`;de(t),console.warn(`%c[${c}] WARN:`,`color: ${se.warn}; font-weight: bold;`,e)},error:(c,e,t=null)=>{if(Z.ERROR>ie)return;let i=`[${c}] ERROR: ${e}`;de(i),console.error(`%c[${c}] ERROR:`,`color: ${se.error}; font-weight: bold;`,e,t||"")},group:c=>{Z.DEBUG>ie||(de(`--- GROUP START: ${c} ---`),console.groupCollapsed(`%c${c}`,`color: ${se.group}; font-style: italic;`))},groupEnd:()=>{Z.DEBUG>ie||(console.groupEnd(),de("--- GROUP END ---"))},time:c=>{Z.DEBUG>ie||console.time(c)},timeEnd:c=>{Z.DEBUG>ie||console.timeEnd(c)}};var T={IDLE:"IDLE",MAINTENANCE:"MAINTENANCE",SELLING_HELD_CARGO:"SELLING_HELD_CARGO",SEEKING_MANIPULATION:"SEEKING_MANIPULATION",PREPARING_CRASH:"PREPARING_CRASH",EXECUTING_CRASH:"EXECUTING_CRASH",EXECUTING_EXPLOIT:"EXECUTING_EXPLOIT",SELLING_EXPLOITED_GOODS:"SELLING_EXPLOITED_GOODS",TIME_WASTER:"TIME_WASTER",SEEKING_DEPLETION:"SEEKING_DEPLETION",EXECUTING_DEPLETION:"EXECUTING_DEPLETION",WAITING_FOR_HIKE:"WAITING_FOR_HIKE",EXPLOITING_HIKE:"EXPLOITING_HIKE"},ee={MIXED:"MIXED",HONEST_TRADER:"HONEST_TRADER",MANIPULATOR:"MANIPULATOR",DEPLETE_ONLY:"DEPLETE_ONLY",PROSPECTOR:"PROSPECTOR"},He=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.logger=i,this.isRunning=!1,this.stopRequested=!1,this.botState=T.IDLE,this.activeStrategy=ee.MIXED,this.MIN_PROFIT_MARGIN=.15,this.currentObjective=null,this.plannedObjectives=[],this.metrics={totalTrades:0,profitableTrades:0,totalNetProfit:0,totalFuelCost:0,totalRepairCost:0,daysSimulated:0,profitByGood:{},objectivesStarted:0,objectivesCompleted:0,objectivesAborted:0,strategyUsed:ee.MIXED},this.simulationStartDay=0}async runSimulation({daysToRun:e,strategy:t},i){if(this.isRunning){this.logger.warn("Bot","AUTOTRADER-01 is already running.");return}this.isRunning=!0,this.stopRequested=!1,this.botState=T.IDLE,this.activeStrategy=t||ee.MIXED;let a=this.gameState.day,s=a+e;for(this.simulationStartDay=a,this.metrics={totalTrades:0,profitableTrades:0,totalNetProfit:0,totalFuelCost:0,totalRepairCost:0,daysSimulated:0,profitByGood:{},objectivesStarted:0,objectivesCompleted:0,objectivesAborted:0,strategyUsed:this.activeStrategy},this.logger.info.system("Bot",a,"SIMULATION_START",`Starting advanced simulation for ${e} days using strategy: ${this.activeStrategy}.`);this.gameState.day<s&&!this.stopRequested;)await this._decideNextAction(),i(this.gameState.day,s),await new Promise(o=>setTimeout(o,10));this._logSummaryReport(),this.logger.info.system("Bot",this.gameState.day,"SIMULATION_END","Simulation finished."),this.isRunning=!1}stop(){this.stopRequested=!0}async _decideNextAction(){if(!this._handleAgeEventChoice())switch(this.botState!==T.MAINTENANCE&&(!this.currentObjective||this.currentObjective.type!=="REFUEL_FOR_TRAVEL")&&this._needsMaintenance()&&(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Low resources detected. Switching to maintenance state."),this.botState=T.MAINTENANCE),this.botState){case T.IDLE:await this._evaluateOpportunities();break;case T.MAINTENANCE:await this._executeMaintenance();break;case T.SELLING_HELD_CARGO:await this._executeSellHeldCargo();break;case T.SEEKING_MANIPULATION:await this._findCrashOpportunity();break;case T.PREPARING_CRASH:await this._executePreparation();break;case T.EXECUTING_CRASH:await this._executeCrash();break;case T.EXECUTING_EXPLOIT:await this._executeExploit();break;case T.SELLING_EXPLOITED_GOODS:await this._executeSellExploited();break;case T.TIME_WASTER:await this._executeTimeWaster();break;case T.SEEKING_DEPLETION:await this._findDepletionOpportunity();break;case T.EXECUTING_DEPLETION:await this._executeDepletion();break;case T.WAITING_FOR_HIKE:await this._executeWait();break;case T.EXPLOITING_HIKE:await this._executeExploitHike();break}}async _evaluateOpportunities(){let e=this._findBestSellLocationForHeldCargo();if(e){this.currentObjective={type:"SELL_HELD_CARGO",...e},this.botState=T.SELLING_HELD_CARGO,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[HELD CARGO]: Found profitable sale for ${e.quantity}x ${e.goodId} @ ${e.sellLocationId}. Profit: ${v(e.estimatedProfit)}.`),this.metrics.objectivesStarted++;return}if(this.activeStrategy===ee.MIXED||this.activeStrategy===ee.MANIPULATOR){let t=this._findReadySelfExploit();if(t){this.currentObjective=t,this.botState=T.EXECUTING_EXPLOIT,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Found self-created exploit: Buy ${t.goodId} @ ${t.exploitLocationId}`),this.metrics.objectivesStarted++;return}}if(this.currentObjective){if(this.currentObjective.type==="CRASH"&&this._isCrashPlanStillValid()){this.botState=T.PREPARING_CRASH,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Continuing persistent CRASH loop for ${this.currentObjective.goodId}.`);return}else if(this.currentObjective.type!=="CRASH"&&this.currentObjective.type!=="SIMPLE_TRADE"){let t=this.currentObjective.goodId,i=this._findCrashOpportunity(t);if(i&&i.goodId&&i.buyFromLocationId&&i.crashLocationId){this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Re-validating and repeating CRASH loop for ${i.goodId}.`),this.currentObjective=i,this.botState=T.PREPARING_CRASH,this.metrics.objectivesStarted++;return}else this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Failed to re-validate loop for ${t}. Plan is no longer viable.`)}}switch(this.currentObjective=null,this.activeStrategy){case ee.HONEST_TRADER:this.botState=T.TIME_WASTER,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: HONEST_TRADER. Seeking simple trade.");break;case ee.MANIPULATOR:this.botState=T.SEEKING_MANIPULATION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MANIPULATOR. Seeking new market crash opportunity.");break;case ee.DEPLETE_ONLY:this.botState=T.SEEKING_DEPLETION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: DEPLETE_ONLY. Seeking new depletion opportunity.");break;case ee.PROSPECTOR:let t=this._findBestSimpleTrade();t?(this.currentObjective={...t,type:"SIMPLE_TRADE",hasGoods:!1},this.botState=T.TIME_WASTER,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[PROSPECTOR]: Found simple trade. Buy ${t.goodId} @ ${t.buyLocationId} -> Sell @ ${t.sellLocationId}. Margin: ${(t.profitPerUnit/t.buyPrice*100).toFixed(1)}%. Est. PPD: ${v(t.estimatedPPD)}.`)):(this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[PROSPECTOR]: No simple trades found meeting ${this.MIN_PROFIT_MARGIN*100}% margin. Falling back to manipulation.`),this.botState=T.SEEKING_MANIPULATION);break;case ee.MIXED:default:Math.random()<.25?(this.botState=T.SEEKING_DEPLETION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MIXED. Seeking new depletion opportunity.")):(this.botState=T.SEEKING_MANIPULATION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MIXED. Seeking new market crash opportunity."));break}}async _executeMaintenance(){let e=this.simulationService._getActiveShip();if(!e){this.botState=T.IDLE;return}let t=this.gameState.player.shipStates[e.id];if(this.currentObjective&&this.currentObjective.type==="REFUEL_FOR_TRAVEL"){let{needed:s,nextState:o,originalObjective:r}=this.currentObjective;if(s>e.maxFuel&&t.fuel===e.maxFuel){this.logger.error("Bot",`MAINTENANCE_FAIL: Objective requires ${s} fuel, but ship max is ${e.maxFuel}. Ship is full. Aborting objective to prevent loop.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}if(t.fuel<s){this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Executing local refuel to get ${s} fuel.`),this._botRefuel(s);return}else{this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Local refuel complete. Resuming original objective."),this.currentObjective=r,this.botState=o;return}}let i=t.fuel/e.maxFuel*100,a=t.health/e.maxHealth*100;if(i<30){if(this.gameState.currentLocationId===I.JUPITER)this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Arrived at Jupiter. Refueling."),this._botRefuel(e.maxFuel);else{let s=this.gameState.getState(),o=s.TRAVEL_DATA[s.currentLocationId][I.JUPITER],r=o?o.fuelCost||0:9999;t.fuel<r?(this.logger.warn("Bot",`Stranded at ${s.currentLocationId}. Buying expensive local fuel just to reach Jupiter.`),this._botRefuel(r+5)):(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Fuel ${i.toFixed(0)}%. Traveling to Jupiter.`),this.simulationService.travelService.initiateTravel(I.JUPITER))}return}if(a<30){this.gameState.currentLocationId!==I.LUNA?(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Hull ${a.toFixed(0)}%. Traveling to Luna.`),this.simulationService.travelService.initiateTravel(I.LUNA)):(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Arrived at Luna. Repairing."),this._botRepair());return}this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Maintenance complete. Resuming operations."),this.botState=T.IDLE}async _executeSellHeldCargo(){let{goodId:e,sellLocationId:t,quantity:i}=this.currentObjective,a=this.gameState.getState(),s=this.simulationService._getActiveShip();if(a.currentLocationId!==t){this.logger.info.system("Bot",a.day,"SELL_HELD",`Traveling to ${t} to sell ${i}x ${e}`);let r=a.TRAVEL_DATA[a.currentLocationId][t],n=r?r.fuelCost||0:9999;if(s.fuel<n){this.logger.warn("Bot",`SELL_HELD_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:T.SELLING_HELD_CARGO,originalObjective:l},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let o=this.simulationService._getActiveInventory()[e]?.quantity||0;if(o>0){let r=this.simulationService._getActiveInventory()[e]?.avgCost||0,l=this.simulationService.playerActionService.sellItem(e,o)-r*o;this.logger.info.system("Bot",a.day,"SELL_HELD_SELL",`Sold ${o}x ${e}. Profit: ${v(l)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=l,l>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=l,this.metrics.objectivesCompleted++}else this.logger.warn("Bot",`SELL_HELD_FAIL: Arrived at ${t} but have no ${e} to sell.`),this.metrics.objectivesAborted++;this.currentObjective=null,this.botState=T.IDLE}async _findCrashOpportunity(e=null){let t=this.gameState.getState(),i=p.COMMODITIES.filter(s=>s.tier<=t.player.revealedTier&&s.tier>1);if(e&&(i=i.filter(s=>s.id===e)),i.length===0)return e||(this.botState=T.TIME_WASTER),null;let a=[];for(let s of i){let o=this._findCheapestMarket(s.id);if(!o)continue;let r=this._findBestCrashTarget(s.id,o.id);if(!r)continue;let n=s.tier*(r.price-o.price);n>0&&a.push({potential:n,plan:{type:"CRASH",goodId:s.id,buyFromLocationId:o.id,crashLocationId:r.id}})}if(a.length>0){a.sort((r,n)=>n.potential-r.potential);let s=a.slice(0,5).map(r=>r.plan),o=s[Math.floor(Math.random()*s.length)];if(e)return o;this.currentObjective=o,this.botState=T.PREPARING_CRASH,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"PLAN",`New crash plan (1 of ${s.length}): Buy ${o.goodId} @ ${o.buyFromLocationId}, Crash @ ${o.crashLocationId}`)}else return e||(this.botState=T.TIME_WASTER,this.logger.info.system("Bot",this.gameState.day,"PLAN","No good crash plans. Running simple trade.")),null}async _executePreparation(){let{goodId:e,buyFromLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"PREP",`Traveling to ${t} to buy ${e}`);let o=this.simulationService._getActiveShip(),r=i.TRAVEL_DATA[i.currentLocationId][t],n=r?r.fuelCost||0:9999;if(o.fuel<n){this.logger.warn("Bot",`PREP_FAIL: Not enough fuel (${o.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:T.PREPARING_CRASH,originalObjective:l},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=i.market.prices[t][e],s=this._calculateMaxBuy(e,a);s>0?(this.simulationService.playerActionService.buyItem(e,s),this.logger.info.system("Bot",i.day,"PREP_BUY",`Bought ${s}x ${e} @ ${v(a)}`),this.botState=T.EXECUTING_CRASH):(this.logger.warn("Bot",`PREP_FAIL: Arrived at ${t} but could not buy ${e}. Aborting.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++)}async _executeCrash(){let{goodId:e,crashLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"CRASH",`Traveling to ${t} to crash ${e}`);let s=this.simulationService._getActiveShip(),o=i.TRAVEL_DATA[i.currentLocationId][t],r=o?o.fuelCost||0:9999;if(s.fuel<r){this.logger.warn("Bot",`CRASH_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${r}). Forcing maintenance.`);let n=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:r+5,nextState:T.EXECUTING_CRASH,originalObjective:n},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=this.simulationService._getActiveInventory()[e]?.quantity||0;if(a>0){let s=this.simulationService._getActiveInventory()[e]?.avgCost||0,r=this.simulationService.playerActionService.sellItem(e,a)-s*a;this.logger.info.system("Bot",i.day,"CRASH_SELL",`CRASHED: Sold ${a}x ${e}. Profit: ${v(r)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=r,r>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=r;let n=this.gameState.market.inventory[t][e];this.plannedObjectives.push({goodId:e,locationId:t,priceLockEndDay:n.priceLockEndDay,crashedOnDay:this.gameState.day}),this.currentObjective.type="EXPLOIT",this.currentObjective.exploitLocationId=this.currentObjective.crashLocationId,delete this.currentObjective.buyFromLocationId,delete this.currentObjective.crashLocationId,this.botState=T.EXECUTING_EXPLOIT}else this.logger.warn("Bot",`CRASH_FAIL: Arrived at ${t} but have no ${e} to sell. Aborting.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++}async _executeExploit(){let{goodId:e,exploitLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"EXPLOIT",`Traveling to ${t} to buy cheap ${e}`);let o=this.simulationService._getActiveShip(),r=i.TRAVEL_DATA[i.currentLocationId][t],n=r?r.fuelCost||0:9999;if(o.fuel<n){this.logger.warn("Bot",`EXPLOIT_FAIL: Not enough fuel (${o.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:T.EXECUTING_EXPLOIT,originalObjective:l},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=i.market.prices[t][e],s=this._calculateMaxBuy(e,a);if(s>0){this.simulationService.playerActionService.buyItem(e,s),this.logger.info.system("Bot",i.day,"EXPLOIT_BUY",`EXPLOITED: Bought ${s}x ${e} @ ${v(a)}`);let o=this._findBestSellLocation(e,t);o?(this.logger.info.system("Bot",i.day,"EXPLOIT_PLAN",`Goods secured. Now traveling to ${o.id} to sell.`),this.currentObjective.type="SELL_EXPLOITED",this.currentObjective.sellToLocationId=o.id,this.botState=T.SELLING_EXPLOITED_GOODS):(this.logger.warn("Bot",`EXPLOIT_FAIL: No market found to sell ${e}. Dumping objective.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++)}else this.logger.warn("Bot",`EXPLOIT_FAIL: Arrived at ${t} but could not buy ${e}.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;this.plannedObjectives=this.plannedObjectives.filter(o=>!(o.goodId===e&&o.locationId===t))}async _executeSellExploited(){let{goodId:e,sellToLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"SELL_EXPLOIT",`Traveling to ${t} to sell ${e}`);let s=this.simulationService._getActiveShip(),o=i.TRAVEL_DATA[i.currentLocationId][t],r=o?o.fuelCost||0:9999;if(s.fuel<r){this.logger.warn("Bot",`SELL_EXPLOIT_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${r}). Forcing maintenance.`);let n=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:r+5,nextState:T.SELLING_EXPLOITED_GOODS,originalObjective:n},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=this.simulationService._getActiveInventory()[e]?.quantity||0;if(a>0){let s=this.simulationService._getActiveInventory()[e]?.avgCost||0,r=this.simulationService.playerActionService.sellItem(e,a)-s*a;this.logger.info.system("Bot",i.day,"SELL_EXPLOIT_SELL",`Sold ${a}x ${e}. Profit: ${v(r)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=r,r>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=r}else this.logger.warn("Bot",`SELL_EXPLOIT_FAIL: Arrived at ${t} but have no ${e} to sell.`);this.botState=T.IDLE,this.metrics.objectivesCompleted++}async _executeTimeWaster(){if(!this.currentObjective||this.currentObjective.type!=="SIMPLE_TRADE"){let n=this._findBestSimpleTrade();if(n)this.currentObjective={...n,type:"SIMPLE_TRADE",hasGoods:!1},this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[TRADE]: New simple trade. Buy ${n.goodId} @ ${n.buyLocationId} -> Sell @ ${n.sellLocationId}. Margin: ${(n.profitPerUnit/n.buyPrice*100).toFixed(1)}%. Est. PPD: ${v(n.estimatedPPD)}.`);else{this.logger.info.system("Bot",this.gameState.day,"TIME_WASTER","No profitable simple trades found. Waiting 1 day."),this.simulationService.timeService.advanceDays(1),this.botState=T.IDLE;return}}let{goodId:e,buyLocationId:t,sellLocationId:i,buyPrice:a,hasGoods:s}=this.currentObjective,o=this.gameState.getState(),r=this.simulationService._getActiveShip();if(!s){if(o.currentLocationId!==t){this.logger.info.system("Bot",o.day,"TRADE_BUY",`Traveling to ${t} to buy ${e}`);let d=o.TRAVEL_DATA[o.currentLocationId][t],h=d?d.fuelCost||0:9999;if(r.fuel<h){this.logger.warn("Bot",`TIME_WASTER_FAIL: Not enough fuel (${r.fuel}) to travel to ${t} (needs ${h}). Forcing maintenance.`);let u=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:T.TIME_WASTER,originalObjective:u},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let n=o.market.inventory[o.currentLocationId][e].quantity;if(n<=0){this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${t} but ${e} is now out of stock. Aborting.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}let l=this._calculateMaxBuy(e,a);if(l>0)this.simulationService.playerActionService.buyItem(e,l),this.logger.info.system("Bot",o.day,"TRADE_BUY",`Bought ${l}x ${e} @ ${v(a)}`),this.currentObjective.hasGoods=!0;else{this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${t} but could not buy ${e} (Price: ${v(a)}, Stock: ${n}). Aborting.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}}if(this.currentObjective.hasGoods){if(o.currentLocationId!==i){this.logger.info.system("Bot",o.day,"TRADE_SELL",`Traveling to ${i} to sell ${e}`);let l=o.TRAVEL_DATA[o.currentLocationId][i],d=l?l.fuelCost||0:9999;if(r.fuel<d){this.logger.warn("Bot",`TIME_WASTER_FAIL: Not enough fuel (${r.fuel}) to travel to ${i} (needs ${d}). Forcing maintenance.`);let h=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:d+5,nextState:T.TIME_WASTER,originalObjective:h},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(i);return}let n=this.simulationService._getActiveInventory()[e]?.quantity||0;if(n>0){let l=this.simulationService._getActiveInventory()[e]?.avgCost||0,h=this.simulationService.playerActionService.sellItem(e,n)-l*n;this.logger.info.system("Bot",o.day,"TRADE_SELL",`Sold ${n}x ${e}. Profit: ${v(h)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=h,h>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=h,this.metrics.objectivesCompleted++}else this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${i} but have no ${e} to sell.`),this.metrics.objectivesAborted++;this.currentObjective=null,this.botState=T.IDLE}}async _findDepletionOpportunity(){let e=this.gameState.getState(),t=this.simulationService._getActiveShip();if(!t){this.botState=T.IDLE;return}let i=p.COMMODITIES.filter(s=>s.tier<=e.player.revealedTier&&s.tier>1),a=[];for(let s of i)for(let o of p.MARKETS){if(!e.player.unlockedLocationIds.includes(o.id))continue;let r=e.market.inventory[o.id][s.id];if(e.day<=r.depletionBonusDay+365)continue;let[n,l]=s.canonicalAvailability,d=o.availabilityModifier?.[s.id]??1,h=(n+l)/2*d,u=r.marketPressure;u>0&&(u=0);let m=1-Math.min(.5,u*.5),f=Math.max(1,h*m)*.08,S=r.quantity,y=e.market.prices[o.id][s.id];S>=f&&e.player.credits>=S*y&&t.cargoCapacity>=S&&a.push({potential:s.tier*S,plan:{type:"DEPLETE",goodId:s.id,locationId:o.id,amountToBuy:S}})}if(a.length>0){a.sort((r,n)=>n.potential-r.potential);let s=a.slice(0,5).map(r=>r.plan),o=s[Math.floor(Math.random()*s.length)];this.currentObjective=o,this.botState=T.EXECUTING_DEPLETION,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"PLAN",`New depletion plan (1 of ${s.length}): Buy out ${o.amountToBuy}x ${o.goodId} at ${o.locationId}`)}else this.activeStrategy===ee.DEPLETE_ONLY?(this.logger.info.system("Bot",this.gameState.day,"PLAN","No depletion opportunities. Waiting 1 day."),this.simulationService.timeService.advanceDays(1),this.botState=T.IDLE):this.botState=T.SEEKING_MANIPULATION}async _executeDepletion(){let{goodId:e,locationId:t,amountToBuy:i}=this.currentObjective,a=this.gameState.getState();if(a.currentLocationId!==t){this.logger.info.system("Bot",a.day,"DEPLETE",`Traveling to ${t} to buy out ${e}`);let r=this.simulationService._getActiveShip(),n=a.TRAVEL_DATA[a.currentLocationId][t],l=n?n.fuelCost||0:9999;if(r.fuel<l){this.logger.warn("Bot",`DEPLETE_FAIL: Not enough fuel (${r.fuel}) to travel to ${t} (needs ${l}). Forcing maintenance.`);let d=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:l+5,nextState:T.EXECUTING_DEPLETION,originalObjective:d},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let s=this.simulationService.playerActionService.buyItem(e,i);if(!s||s<i){this.logger.warn("Bot",`DEPLETE_FAIL: Failed to buy out ${e} at ${t}. Aborting.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}this.logger.info.system("Bot",a.day,"DEPLETE_BUY",`Successfully bought out ${i}x ${e}. Depletion bonus triggered.`);let o=this._findBestSellLocation(e,t);if(o){let r=this.simulationService._getActiveShip(),n=a.TRAVEL_DATA[a.currentLocationId][o.id],l=n?n.fuelCost||0:9999;if(r.fuel<l){this.logger.warn("Bot",`DEPLETE_FAIL: Not enough fuel (${r.fuel}) to travel to sell location ${o.id} (needs ${l}). Forcing maintenance.`);let d=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:l+5,nextState:T.EXECUTING_DEPLETION,originalObjective:d},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(o.id);return}this.currentObjective.waitStartDay=this.gameState.day,this.botState=T.WAITING_FOR_HIKE}async _executeWait(){this.gameState.day>this.currentObjective.waitStartDay+7?(this.logger.info.system("Bot",this.gameState.day,"DEPLETE","Wait complete. Price hike is active. Beginning exploitation."),this.botState=T.EXPLOITING_HIKE,this.currentObjective.exploitRuns=0):(this.simulationService.timeService.advanceDays(1),this.botState=T.WAITING_FOR_HIKE)}async _executeExploitHike(){let{goodId:e,locationId:t}=this.currentObjective,i=this.gameState.getState(),a=this._findCheapestMarket(e);if(!a||a.id===t){this.logger.warn("Bot",`HIKE_FAIL: No cheap market found to buy ${e}. Aborting exploit.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}if(i.currentLocationId!==a.id){let l=this.simulationService._getActiveShip(),d=i.TRAVEL_DATA[i.currentLocationId][a.id],h=d?d.fuelCost||0:9999;if(l.fuel<h){this.logger.warn("Bot",`HIKE_FAIL: Not enough fuel (${l.fuel}) to travel to buy location ${a.id} (needs ${h}). Forcing maintenance.`);let u=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:T.EXPLOITING_HIKE,originalObjective:u},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(a.id);return}let s=this._calculateMaxBuy(e,a.price);if(s>0&&this.simulationService.playerActionService.buyItem(e,s),i.currentLocationId!==t){let l=this.simulationService._getActiveShip(),d=i.TRAVEL_DATA[i.currentLocationId][t],h=d?d.fuelCost||0:9999;if(l.fuel<h){this.logger.warn("Bot",`HIKE_FAIL: Not enough fuel (${l.fuel}) to travel to hiked location ${t} (needs ${h}). Forcing maintenance.`);let u=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:T.EXPLOITING_HIKE,originalObjective:u},this.botState=T.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let o=this.simulationService._getActiveInventory()[e]?.quantity||0,r=i.market.inventory[t][e].quantity;if(o>0&&r>0){let l=this.simulationService._getActiveInventory()[e]?.avgCost||0,h=this.simulationService.playerActionService.sellItem(e,o)-l*o;this.logger.info.system("Bot",i.day,"HIKE_EXPLOIT_SELL",`Sold ${o}x ${e} at hiked price. Profit: ${v(h)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=h,h>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=h}else if(o>0&&r<=0){this.logger.warn("Bot",`HIKE_FAIL: Arrived at hiked market ${t} but stock is 0. Aborting sale and loop.`),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesAborted++;return}this.currentObjective.exploitRuns++;let n=i.market.inventory[t][e];this.currentObjective.exploitRuns<2&&i.day<n.depletionDay+7?this.botState=T.EXPLOITING_HIKE:(this.logger.info.system("Bot",i.day,"HIKE_COMPLETE","Depletion exploit complete."),this.currentObjective=null,this.botState=T.IDLE,this.metrics.objectivesCompleted++)}_isCrashPlanStillValid(){if(!this.currentObjective||this.currentObjective.type!=="CRASH")return!1;let{goodId:e,buyFromLocationId:t,crashLocationId:i}=this.currentObjective;if(!e||!t||!i)return!1;let a=this.gameState.getState(),s=a.market.prices[t][e];return a.market.prices[i][e]-s>0}_findReadySelfExploit(){let e=this.gameState.getState();this.plannedObjectives=this.plannedObjectives.filter(t=>t.priceLockEndDay>e.day);for(let t of this.plannedObjectives)if(e.day>t.crashedOnDay+7&&e.market.inventory[t.locationId][t.goodId].quantity>10)return{type:"EXPLOIT",goodId:t.goodId,exploitLocationId:t.locationId};return null}_findBestSellLocationForHeldCargo(){let e=this.gameState.getState(),t=this.simulationService._getActiveInventory();if(!t)return null;let i=null,a=0;for(let s in t){let o=t[s];if(o&&o.quantity>0){let r=o.avgCost,n=o.quantity,l=this._findBestSellLocation(s,e.currentLocationId);if(l){let d=(l.price-r)*n;d>a&&(a=d,i={goodId:s,quantity:n,avgCost:r,sellLocationId:l.id,sellPrice:l.price,estimatedProfit:d})}}}return i&&i.estimatedProfit>0?i:null}_findCheapestMarket(e){let t=this.gameState.getState(),i=null,a=1/0;for(let s of p.MARKETS){if(!t.player.unlockedLocationIds.includes(s.id))continue;let o=t.market.prices[s.id][e];o<a&&t.market.inventory[s.id][e].quantity>0&&(a=o,i={id:s.id,price:o})}return i}_findBestSellLocation(e,t){let i=this.gameState.getState(),a=null,s=-1/0;for(let o of p.MARKETS){if(o.id===t||!i.player.unlockedLocationIds.includes(o.id))continue;let r=i.market.inventory[o.id][e].quantity,n=i.market.prices[o.id][e];n>s&&r>0&&(s=n,a={id:o.id,price:n})}return a}_findBestCrashTarget(e,t){let i=this.gameState.getState(),a=null,s=1/0;for(let o of p.MARKETS){if(o.id===t||!i.player.unlockedLocationIds.includes(o.id))continue;let r=o.availabilityModifier?.[e]??1,n=i.market.prices[o.id][e];n<s&&(s=n,a={id:o.id,price:n})}return a}_findBestSimpleTrade(){let e=this.gameState.getState(),t=this.simulationService._getActiveShip();if(!t)return null;let i=t.cargoCapacity;if(i<=0)return null;let a=null,s=0,o=p.COMMODITIES.filter(n=>n.tier<=e.player.revealedTier),r=this.simulationService._getActiveInventory();for(let n of o)if(!(r[n.id]&&r[n.id].quantity>0))for(let l of p.MARKETS){if(!e.player.unlockedLocationIds.includes(l.id))continue;let d=e.market.inventory[l.id][n.id].quantity;if(!(d<=0))for(let h of p.MARKETS){if(l.id===h.id||!e.player.unlockedLocationIds.includes(h.id)||e.market.inventory[h.id][n.id].quantity<=0)continue;let m=e.market.prices[l.id][n.id],g=e.market.prices[h.id][n.id],f=g-m,S=m>0?f/m:0;if(f>0&&S>this.MIN_PROFIT_MARGIN){let y=e.TRAVEL_DATA[e.currentLocationId]?.[l.id]?.time||0,b=e.TRAVEL_DATA[l.id]?.[h.id]?.time||0;if(b===0)continue;let E=y+b+2,A=Math.min(i,d),N=f*A/E;N>s&&(s=N,a={goodId:n.id,buyLocationId:l.id,sellLocationId:h.id,buyPrice:m,sellPrice:g,profitPerUnit:f,estimatedPPD:N})}}}return a}_handleAgeEventChoice(){let e=document.getElementById("age-event-modal");if(!e||e.classList.contains("hidden"))return!1;let t=document.getElementById("age-event-title").textContent;this.logger.info.system("Bot",this.gameState.day,"EVENT_CHOICE",`Handling age event: ${t}`);let i=Array.from(e.querySelectorAll("button"));if(i.length===0)return!1;let a=["trademaster","merchant's guild","free ship","credits","profit"],s=["continue","ignore","dismiss","accept"],o=null;for(let r of i){let n=r.textContent.toLowerCase();if(a.some(l=>n.includes(l))){o=r;break}}if(!o)for(let r of i){let n=r.textContent.toLowerCase();if(s.some(l=>n.includes(l))){o=r;break}}return o||(this.logger.warn("Bot",`EVENT_CHOICE: No preferred keyword found for "${t}". Clicking first available button.`),o=i[0]),o.click(),!0}_logSummaryReport(){this.metrics.daysSimulated=this.gameState.day-this.simulationStartDay;let{totalTrades:e,profitableTrades:t,totalNetProfit:i,totalFuelCost:a,totalRepairCost:s,daysSimulated:o,strategyUsed:r,objectivesStarted:n,objectivesCompleted:l,objectivesAborted:d,profitByGood:h}=this.metrics,u=e>0?(t/e*100).toFixed(1):0,m=o>0?i/o:0,g="=== AUTO-TRADER PERFORMANCE SUMMARY ===";console.log(g),this.logger.info.system("Bot",this.gameState.day,"REPORT",g);let f=[`Strategy Run: ${r}`,`Days Simulated: ${o}`,`Final Credit Balance: ${v(this.gameState.player.credits)}`,"","--- Performance ---",`Total Net Profit: ${v(i)}`,`Profit Per Day: ${v(m)}`,`Objectives (Started/Completed/Aborted): ${n} / ${l} / ${d}`,`Total Trades Completed: ${e}`,`Profitable Trades: ${t} (${u}%)`,"","--- Costs ---",`Total Fuel Costs: ${v(a)}`,`Total Repair Costs: ${v(s)}`];for(let E of f)console.log(E),this.logger.info.system("Bot",this.gameState.day,"REPORT",`  ${E}`);let S="--- Profit Breakdown by Commodity ---";console.log(S),this.logger.info.system("Bot",this.gameState.day,"REPORT",`  ${S}`);let y=Object.keys(h).sort((E,A)=>h[A]-h[E]);if(y.length===0){let E="No commodity trades recorded.";console.log(E),this.logger.info.system("Bot",this.gameState.day,"REPORT",`    ${E}`)}else for(let E of y){let A=h[E],N=`${p.COMMODITIES.find(L=>L.id===E)?.name||E}: ${v(A)}`;console.log(N),this.logger.info.system("Bot",this.gameState.day,"REPORT",`    ${N}`)}let b="=======================================";console.log(b),this.logger.info.system("Bot",this.gameState.day,"REPORT",b)}_needsMaintenance(){let e=this.simulationService._getActiveShip();if(!e)return!1;let t=this.gameState.player.shipStates[e.id].fuel/e.maxFuel*100,i=this.gameState.player.shipStates[e.id].health/e.maxHealth*100;return t<30||i<30}_botRefuel(e=null){let t=this.simulationService._getActiveShip();if(!t)return;let a=(e===null?t.maxFuel:Math.min(t.maxFuel,e))-this.gameState.player.shipStates[t.id].fuel;if(a<=0)return;let o=p.MARKETS.find(d=>d.id===this.gameState.currentLocationId).fuelPrice/2;this.gameState.player.activePerks[R.VENETIAN_SYNDICATE]&&this.gameState.currentLocationId===I.VENUS&&(o*=1-p.PERKS[R.VENETIAN_SYNDICATE].fuelDiscount),o=Math.max(1,Math.round(o));let r=Math.ceil(a/5),n=r*o,l=r*5;if(this.gameState.player.credits>=n)this.gameState.player.credits-=n,this.gameState.player.shipStates[t.id].fuel=Math.min(t.maxFuel,this.gameState.player.shipStates[t.id].fuel+l),this.simulationService._logConsolidatedTransaction("fuel",-n,"Fuel Purchase"),this.metrics.totalFuelCost+=n;else{let d=Math.floor(this.gameState.player.credits/o);if(d>0){let h=d*o;this.gameState.player.credits-=h,this.gameState.player.shipStates[t.id].fuel+=d*5,this.simulationService._logConsolidatedTransaction("fuel",-h,"Fuel Purchase"),this.metrics.totalFuelCost+=h}}}_botRepair(){let e=this.simulationService._getActiveShip();if(!e)return;let t=e.maxHealth-this.gameState.player.shipStates[e.id].health;if(t<=0)return;let i=e.maxHealth*($.REPAIR_AMOUNT_PER_TICK/100),a=i*$.REPAIR_COST_PER_HP;this.gameState.player.activePerks[R.VENETIAN_SYNDICATE]&&this.gameState.currentLocationId===I.VENUS&&(a*=1-p.PERKS[R.VENETIAN_SYNDICATE].repairDiscount),a=Math.max(1,Math.round(a));let o=Math.ceil(t/i)*a;if(this.gameState.player.credits>=o)this.gameState.player.credits-=o,this.gameState.player.shipStates[e.id].health=e.maxHealth,this.simulationService._logConsolidatedTransaction("repair",-o,"Hull Repairs"),this.metrics.totalRepairCost+=o;else{let r=Math.floor(this.gameState.player.credits/a);if(r>0){let n=r*a;this.gameState.player.credits-=n,this.gameState.player.shipStates[e.id].health+=r*i,this.simulationService._logConsolidatedTransaction("repair",-n,"Hull Repairs"),this.metrics.totalRepairCost+=n}}}_calculateMaxBuy(e,t){let i=this.gameState.getState(),a=this.simulationService._getActiveShip(),s=this.simulationService._getActiveInventory();if(!a||!s)return 0;let o=a.cargoCapacity-Y(s),r=t>0?Math.floor(i.player.credits/t):1/0,n=i.market.inventory[i.currentLocationId][e].quantity;return Math.max(0,Math.min(o,r,n))}};var Xt={topCenter:[50,15],top34Center:[50,30],vertHorizCenter:[50,50],bottom34Center:[50,70],bottomCenter:[50,85],bottomLeft:[15,85],topLeft:[15,15]},Be=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.logger=a,this.gui=null,this.active=!1,this.diagActive=!1,this.diagElements={},this.actions={},this.debugState={creditsToAdd:1e5,creditsToReduce:1e5,selectedLocation:this.gameState.currentLocationId,daysToAdvance:7,selectedRandomEvent:0,selectedAgeEvent:p.AGE_EVENTS[0].id,selectedMission:Object.values(p.MISSIONS)[0]?.id||null,botDaysToRun:365,botStrategy:"MIXED",botProgress:"Idle",logLevel:"INFO",shipToBoard:null,selectedUpgrade:null,ttStepId:"None",ttAnchor:"N/A",ttPlacement:"auto",ttOffsetDistance:0,ttOffsetSkidding:0,ttPercentX:50,ttPercentY:50,ttWidth:0,ttHeight:0,ttGeneratedCode:""},this.bot=new He(e,t,a),this.tutorialPositionalControllers={}}init(){this.gui||(this._cacheDiagElements(),this.gui=new lil.GUI({draggable:!0,title:"Debug Menu"}),this.gui.domElement.id="debug-panel",this._registerDebugActions(),this.buildGui(),this._startDiagLoop())}handleKeyPress(e){}toggleVisibility(){this.gui&&(this.active=!this.active,this.gui.domElement.classList.toggle("debug-visible",this.active))}toggleDiagnosticOverlay(){this.diagActive=!this.diagActive;let e=document.getElementById("diagnostic-overlay");e&&e.classList.toggle("hidden",!this.diagActive)}generateBugReport(){let e=this.logger.getLogHistory(),t=this.gameState.getState();delete t.TRAVEL_DATA,delete t.market.priceHistory;let i=`
ORBITAL TRADING - BUG REPORT
==============================
Date: ${new Date().toISOString()}

--- GAME STATE SNAPSHOT ---
${JSON.stringify(t,null,2)}

--- RECENT LOG HISTORY ---
${e}
        `;navigator.clipboard.writeText(i.trim()).then(()=>{this.uiManager.createFloatingText("Bug Report Copied to Clipboard!",window.innerWidth/2,window.innerHeight/2,"#4ade80")}).catch(a=>{this.logger.error("DebugService","Failed to copy bug report.",a)})}godMode(){this.logger.warn("DebugService","GOD MODE ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(p.TUTORIAL_DATA),this.gameState.player.credits=Number.MAX_SAFE_INTEGER,this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(G.BEHEMOTH),this.gameState.player.activeShipId=G.BEHEMOTH,this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(p.LICENSES),this.gameState.player.unlockedLocationIds=p.MARKETS.map(e=>e.id),this.uiManager.showGameContainer(),this.simulationService.setScreen(H.STARPORT,_.MARKET),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}simpleStart(){this.logger.warn("DebugService","SIMPLE START ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(p.TUTORIAL_DATA),this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(G.WANDERER),this.gameState.player.activeShipId=G.WANDERER;let e=this.gameState.player.visualSeed;B.hydrateAllShips(e),B.hydrateAllCommodities(e),this.uiManager.showGameContainer(),this.simulationService.setScreen(H.DATA,_.MISSIONS),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}skipToHangarTutorial(){this.logger.warn("DebugService","SKIP TO HANGAR TUTORIAL ACTIVATED."),this.gameState.introSequenceActive=!0,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=[],this.gameState.player.credits=25e3,this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.uiManager.showGameContainer(),this.simulationService.setScreen(H.STARPORT,_.HANGAR),this.simulationService.tutorialService.triggerBatch("intro_hangar","hangar_1"),this.gameState.setState({})}deductHull(e){let t=this.simulationService._getActiveShip();if(t){let i=this.gameState.player.shipStates[t.id];i.health=Math.max(0,i.health-e),this.logger.warn("DebugService",`Deducted ${e} hull from ${t.name}.`),this.gameState.setState({})}}restoreHull(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.health=e.maxHealth,this.logger.warn("DebugService",`Restored hull for ${e.name}.`),this.gameState.setState({})}}destroyShip(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.health=0,this.logger.warn("DebugService",`Destroyed ${e.name}.`),this.simulationService.travelService._handleShipDestruction(e.id)}}deductFuel(e){let t=this.simulationService._getActiveShip();if(t){let i=this.gameState.player.shipStates[t.id];i.fuel=Math.max(0,i.fuel-e),this.logger.warn("DebugService",`Deducted ${e} fuel from ${t.name}.`),this.gameState.setState({})}}restoreFuel(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.fuel=e.maxFuel,this.logger.warn("DebugService",`Restored fuel for ${e.name}.`),this.gameState.setState({})}}removeAllCargo(){let e=this.simulationService._getActiveInventory();if(e){for(let t in e)e[t].quantity=0,e[t].avgCost=0;this.logger.warn("DebugService","All cargo removed from active ship."),this.gameState.setState({})}}fillWithCybernetics(){let e=this.simulationService._getActiveShip(),t=this.simulationService._getActiveInventory();if(e&&t){this.removeAllCargo();let i=e.cargoCapacity-Y(t);t[M.CYBERNETICS]||(t[M.CYBERNETICS]={quantity:0,avgCost:0}),t[M.CYBERNETICS].quantity=i,this.logger.warn("DebugService",`Filled cargo with ${i} Cybernetics.`),this.gameState.setState({})}}grantAllItems(){let e=this.simulationService._getActiveInventory();if(!e){this.logger.warn("DebugService","Cannot grant items: No active inventory found.");return}p.COMMODITIES.forEach(t=>{e[t.id]?e[t.id].quantity+=1:e[t.id]={quantity:1,avgCost:0}}),this.logger.warn("DebugService","Debug: Granted 1x of all commodities."),this.gameState.setState({})}fillShipyard(){let{currentLocationId:e,day:t}=this.gameState;if(this.gameState.market.shipyardStock[e]){let i=Object.keys(p.SHIPS);this.gameState.market.shipyardStock[e]={day:t,shipsForSale:i},this.logger.warn("DebugService",`SHIPYARD FILLED: All ships added to ${e}.`),this.gameState.setState({})}else this.logger.error("DebugService",`Cannot fill shipyard: No stock object for ${e}.`)}installSelectedUpgrade(e){if(!e)return;let t=this.simulationService._getActiveShip();if(!t)return;let i=this.gameState.player.shipStates[t.id];i.upgrades||(i.upgrades=[]),i.upgrades.length<3?(i.upgrades.push(e),this.logger.info.system("DebugService",`Installed ${e} on ${t.name}`),this.gameState.setState({})):this.logger.warn("DebugService","Ship upgrade slots full (3/3). Remove one first.")}applyRandomUpgrades(){let e=this.simulationService._getActiveShip();if(!e)return;let t=this.gameState.player.shipStates[e.id];t.upgrades=[];let i=x.getAllUpgradeIds();if(i.length!==0){for(let a=0;a<3;a++){let s=i[Math.floor(Math.random()*i.length)];t.upgrades.push(s)}this.logger.info.system("DebugService",`Applied 3 random upgrades to ${e.name}`),this.gameState.setState({})}}removeAllUpgrades(){let e=this.simulationService._getActiveShip();if(!e)return;let t=this.gameState.player.shipStates[e.id];t.upgrades=[],this.logger.info.system("DebugService",`Removed all upgrades from ${e.name}`),this.gameState.setState({})}_registerDebugActions(){this.actions={godMode:{name:"God Mode",type:"button",handler:()=>this.godMode()},simpleStart:{name:"Simple Start",type:"button",handler:()=>this.simpleStart()},skipToHangarTutorial:{name:"Skip to Hangar Tutorial",type:"button",handler:()=>this.skipToHangarTutorial()},addCredits:{name:"Add Credits",type:"button",handler:()=>{this.gameState.player.credits=Math.min(Number.MAX_SAFE_INTEGER,this.gameState.player.credits+this.debugState.creditsToAdd),this.simulationService.timeService._checkMilestones(),this.gameState.setState({})}},reduceCredits:{name:"Reduce Credits",type:"button",handler:()=>{this.gameState.player.credits-=this.debugState.creditsToReduce,this.simulationService._checkGameOverConditions(),this.gameState.setState({})}},payDebt:{name:"Pay Off Debt",type:"button",handler:()=>this.simulationService.playerActionService.payOffDebt()},teleport:{name:"Teleport",type:"button",handler:()=>{this.debugState.selectedLocation&&(this.gameState.currentLocationId=this.debugState.selectedLocation,this.gameState.setState({}))}},unlockAll:{name:"Unlock All",type:"button",handler:()=>{this.gameState.player.unlockedLocationIds=p.MARKETS.map(e=>e.id),this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(p.LICENSES),this.gameState.setState({})}},grantAllShips:{name:"Grant All Ships",type:"button",handler:()=>{Object.keys(p.SHIPS).forEach(e=>{this.gameState.player.ownedShipIds.includes(e)||this.simulationService.addShipToHangar(e)}),B.hydrateAllShips(this.gameState.player.visualSeed),this.gameState.setState({})}},cycleShipPics:{name:"Cycle Ship Pics",type:"button",handler:()=>{this.gameState.player.visualSeed=(this.gameState.player.visualSeed||0)+1,this.gameState.setState({}),this.logger.info.system("Debug",`Cycled ship visual variant. New Seed: ${this.gameState.player.visualSeed}`)}},advanceTime:{name:"Advance Days",type:"button",handler:()=>{this.simulationService.timeService.advanceDays(this.debugState.daysToAdvance),this.uiManager.render(this.gameState.getState())}},replenishStock:{name:"Replenish All Stock",type:"button",handler:()=>{this.simulationService.marketService.replenishMarketInventory(),this.gameState.setState({})}},triggerRandomEvent:{name:"Trigger Random Event",type:"button",handler:()=>{let e=p.MARKETS.find(t=>t.id!==this.gameState.currentLocationId)?.id;e&&this.simulationService.travelService._checkForRandomEvent(e,this.debugState.selectedRandomEvent)}},triggerAgeEvent:{name:"Trigger Age Event",type:"button",handler:()=>{let e=p.AGE_EVENTS.find(t=>t.id===this.debugState.selectedAgeEvent);e&&this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t))}},triggerMission:{name:"Trigger Mission",type:"button",handler:()=>{this.debugState.selectedMission&&(this.gameState.missions.activeMissionId&&this.simulationService.missionService.abandonMission(),this.simulationService.missionService.acceptMission(this.debugState.selectedMission))}},startBot:{name:"Start AUTOTRADER-01",type:"button",handler:()=>{let e=this.gui.controllers.find(i=>i.property==="botProgress"),t={daysToRun:this.debugState.botDaysToRun,strategy:this.debugState.botStrategy};this.bot.runSimulation(t,(i,a)=>{e&&e.setValue(`${i} / ${a}`).updateDisplay()})}},stopBot:{name:"Stop AUTOTRADER-01",type:"button",handler:()=>this.bot.stop()},fillShipyard:{name:"Fill Shipyard w/ All Ships",type:"button",handler:()=>this.fillShipyard()},deductHull20:{name:"Deduct 20 Hull",type:"button",handler:()=>this.deductHull(20)},restoreHull:{name:"Restore Hull",type:"button",handler:()=>this.restoreHull()},destroyShip:{name:"Destroy Current Ship",type:"button",handler:()=>this.destroyShip()},deductFuel20:{name:"Deduct 20 Fuel",type:"button",handler:()=>this.deductFuel(20)},restoreFuel:{name:"Restore Fuel",type:"button",handler:()=>this.restoreFuel()},removeAllCargo:{name:"Remove All Cargo",type:"button",handler:()=>this.removeAllCargo()},grantAllItems:{name:"Grant 1x All Items",type:"button",handler:()=>this.grantAllItems()},fillWithCybernetics:{name:"Fill w/ Cybernetics",type:"button",handler:()=>this.fillWithCybernetics()},applyRandomUpgrades:{name:"Apply 3 Random Upgrades",type:"button",handler:()=>this.applyRandomUpgrades()},removeAllUpgrades:{name:"Remove All Upgrades",type:"button",handler:()=>this.removeAllUpgrades()},generateTutorialCode:{name:"Generate Code",type:"button",handler:()=>this._generateTutorialCode()},presetTopCenter:{name:"Top Center",type:"button",handler:()=>this._applyTutorialPreset("topCenter")},presetTop34Center:{name:"Top 3/4 Center",type:"button",handler:()=>this._applyTutorialPreset("top34Center")},presetVertHorizCenter:{name:"V/H Center",type:"button",handler:()=>this._applyTutorialPreset("vertHorizCenter")},presetBottom34Center:{name:"Bottom 3/4 Center",type:"button",handler:()=>this._applyTutorialPreset("bottom34Center")},presetBottomCenter:{name:"Bottom Center",type:"button",handler:()=>this._applyTutorialPreset("bottomCenter")},presetBottomLeft:{name:"Bottom Left",type:"button",handler:()=>this._applyTutorialPreset("bottomLeft")},presetTopLeft:{name:"Top Left",type:"button",handler:()=>this._applyTutorialPreset("topLeft")}}}_cacheDiagElements(){this.diagElements={winW:document.getElementById("diag-window-w"),winH:document.getElementById("diag-window-h"),visualVpW:document.getElementById("diag-visual-vp-w"),visualVpH:document.getElementById("diag-visual-vp-h"),gameW:document.getElementById("diag-game-container-w"),gameH:document.getElementById("diag-game-container-h"),bodyW:document.getElementById("diag-body-w"),bodyH:document.getElementById("diag-body-h"),pixelRatio:document.getElementById("diag-pixel-ratio"),displayMode:document.getElementById("diag-display-mode"),day:document.getElementById("diag-day"),navScreen:document.getElementById("diag-nav-screen"),tutorialBatch:document.getElementById("diag-tutorial-batch"),tutorialStep:document.getElementById("diag-tutorial-step")}}_startDiagLoop(){let e=()=>{this._updateDiagOverlay(),requestAnimationFrame(e)};requestAnimationFrame(e)}_updateDiagOverlay(){if(!this.diagActive)return;let e=this.gameState.getState(),t=document.getElementById("game-container");this.diagElements.winW.textContent=window.innerWidth,this.diagElements.winH.textContent=window.innerHeight,window.visualViewport&&(this.diagElements.visualVpW.textContent=Math.round(window.visualViewport.width),this.diagElements.visualVpH.textContent=Math.round(window.visualViewport.height)),this.diagElements.gameW.textContent=t.clientWidth,this.diagElements.gameH.textContent=t.clientHeight,this.diagElements.bodyW.textContent=document.body.clientWidth,this.diagElements.bodyH.textContent=document.body.clientHeight,this.diagElements.pixelRatio.textContent=window.devicePixelRatio.toFixed(2),this.diagElements.displayMode.textContent=window.matchMedia("(display-mode: standalone)").matches?"standalone":"browser",this.diagElements.day.textContent=e.day,this.diagElements.navScreen.textContent=`${e.activeNav} / ${e.activeScreen}`,this.diagElements.tutorialBatch.textContent=e.tutorials.activeBatchId||"none",this.diagElements.tutorialStep.textContent=e.tutorials.activeStepId||"none"}buildGui(){let e=this.gui.addFolder("Game Flow");e.add(this.actions.godMode,"handler").name(this.actions.godMode.name),e.add(this.actions.simpleStart,"handler").name(this.actions.simpleStart.name),e.add(this.actions.skipToHangarTutorial,"handler").name(this.actions.skipToHangarTutorial.name);let t=this.gui.addFolder("Player");t.add(this.debugState,"creditsToAdd").name("Credits Amount"),t.add(this.actions.addCredits,"handler").name("Add Credits"),t.add(this.debugState,"creditsToReduce",100,1e6,100).name("Credits to Reduce"),t.add(this.actions.reduceCredits,"handler").name("Reduce Credits"),t.add(this.actions.payDebt,"handler").name(this.actions.payDebt.name);let i=this.gui.addFolder("Ship");i.add(this.actions.cycleShipPics,"handler").name(this.actions.cycleShipPics.name);let a={};Object.values(p.SHIPS).forEach(y=>{a[y.name]=y.id}),i.add(this.debugState,"shipToBoard",a).name("Board Ship").onChange(y=>{y&&(this.gameState.player.ownedShipIds.includes(y)||this.simulationService.addShipToHangar(y),this.simulationService.playerActionService.executeSetActiveShip(y),this.gameState.uiState.hangarShipyardToggleState="hangar",this.simulationService.setScreen(H.STARPORT,_.HANGAR),B.hydrateAssets([{type:"ship",id:y,seed:this.gameState.player.visualSeed}]),this.gameState.setState({}),this.logger.info.system("Debug",`DEBUG: Boarded ${y}`))});let s=p.MARKETS.reduce((y,b)=>({...y,[b.name]:b.id}),{});i.add(this.debugState,"selectedLocation",s).name("Location"),i.add(this.actions.teleport,"handler").name("Teleport"),i.add(this.actions.deductHull20,"handler").name(this.actions.deductHull20.name),i.add(this.actions.restoreHull,"handler").name(this.actions.restoreHull.name),i.add(this.actions.destroyShip,"handler").name(this.actions.destroyShip.name),i.add(this.actions.deductFuel20,"handler").name(this.actions.deductFuel20.name),i.add(this.actions.restoreFuel,"handler").name(this.actions.restoreFuel.name),i.add(this.actions.removeAllCargo,"handler").name(this.actions.removeAllCargo.name),i.add(this.actions.grantAllItems,"handler").name(this.actions.grantAllItems.name),i.add(this.actions.fillWithCybernetics,"handler").name(this.actions.fillWithCybernetics.name),i.add(this.actions.fillShipyard,"handler").name(this.actions.fillShipyard.name),i.add(this.actions.grantAllShips,"handler").name("Grant All Ships");let o=this.gui.addFolder("Game Attributes"),n=x.getAllUpgradeIds().reduce((y,b)=>{let E=x.getDefinition(b);return y[E?E.name:b]=b,y},{});o.add(this.debugState,"selectedUpgrade",n).name("Install Upgrade").onChange(y=>this.installSelectedUpgrade(y)),o.add(this.actions.applyRandomUpgrades,"handler").name("Apply 3 Random"),o.add(this.actions.removeAllUpgrades,"handler").name("Remove All");let l=this.gui.addFolder("World & Time");l.add(this.debugState,"daysToAdvance",1,365,1).name("Days to Advance"),l.add(this.actions.advanceTime,"handler").name("Advance Time"),this.economyFolder=this.gui.addFolder("Economy"),this.economyFolder.add(this.actions.replenishStock,"handler").name(this.actions.replenishStock.name),this.economyFolder.add(this.actions.unlockAll,"handler").name("Unlock Tiers/Locations");let d=this.gui.addFolder("Triggers"),h=p.RANDOM_EVENTS.reduce((y,b,E)=>({...y,[b.title]:E}),{});d.add(this.debugState,"selectedRandomEvent",h).name("Random Event"),d.add(this.actions.triggerRandomEvent,"handler").name("Trigger Event");let u=p.AGE_EVENTS.reduce((y,b)=>({...y,[b.title]:b.id}),{});d.add(this.debugState,"selectedAgeEvent",u).name("Age Event"),d.add(this.actions.triggerAgeEvent,"handler").name("Trigger Event");let m=Object.values(p.MISSIONS).reduce((y,b)=>({...y,[b.name]:b.id}),{});this.debugState.selectedMission&&(d.add(this.debugState,"selectedMission",m).name("Mission"),d.add(this.actions.triggerMission,"handler").name("Accept Mission"));let g=this.gui.addFolder("Tutorial Tuner");g.domElement.classList.add("tutorial-tuner-folder"),g.add(this.debugState,"ttStepId").name("Step ID").listen().disable(),g.add(this.debugState,"ttAnchor").name("Anchor").listen().disable(),g.add(this.debugState,"ttWidth",0,800,10).name("Width (0=auto)").onChange(()=>this._handleTutorialTune()),g.add(this.debugState,"ttHeight",0,800,10).name("Height (0=auto)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.percentX=g.add(this.debugState,"ttPercentX",0,100,1).name("X %").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.percentY=g.add(this.debugState,"ttPercentY",0,100,1).name("Y %").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.placement=g.add(this.debugState,"ttPlacement").name("Placement (Elem)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.distance=g.add(this.debugState,"ttOffsetDistance",-500,500,1).name("Distance (Elem)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.skidding=g.add(this.debugState,"ttOffsetSkidding",-500,500,1).name("Skidding (Elem)").onChange(()=>this._handleTutorialTune());let f=g.addFolder("Position Presets");f.add(this.actions.presetTopCenter,"handler").name(this.actions.presetTopCenter.name),f.add(this.actions.presetTop34Center,"handler").name(this.actions.presetTop34Center.name),f.add(this.actions.presetVertHorizCenter,"handler").name(this.actions.presetVertHorizCenter.name),f.add(this.actions.presetBottom34Center,"handler").name(this.actions.presetBottom34Center.name),f.add(this.actions.presetBottomCenter,"handler").name(this.actions.presetBottomCenter.name),f.add(this.actions.presetBottomLeft,"handler").name(this.actions.presetBottomLeft.name),f.add(this.actions.presetTopLeft,"handler").name(this.actions.presetTopLeft.name),this.tutorialPositionalControllers.presetFolder=f,g.add(this.actions.generateTutorialCode,"handler").name(this.actions.generateTutorialCode.name),g.add(this.debugState,"ttGeneratedCode").name("Code").listen(),this._updateTutorialControlVisibility(!1);let S=this.gui.addFolder("Automation & Logging");S.add(this,"toggleDiagnosticOverlay").name("Toggle HUD Diagnostics"),S.add(this.debugState,"logLevel",["DEBUG","INFO","WARN","ERROR","NONE"]).name("Log Level").onChange(y=>this.logger.setLevel(y)),S.add(this,"generateBugReport").name("Generate Bug Report"),S.add(this.debugState,"botStrategy",["MIXED","HONEST_TRADER","MANIPULATOR","DEPLETE_ONLY","PROSPECTOR"]).name("Bot Strategy"),S.add(this.debugState,"botDaysToRun",1,1e4,1).name("Simulation Days"),S.add(this.actions.startBot,"handler").name(this.actions.startBot.name),S.add(this.actions.stopBot,"handler").name(this.actions.stopBot.name),S.add(this.debugState,"botProgress").name("Progress").listen(),this.gui.folders.forEach(y=>y.close())}_parseSize(e){if(!e||e==="auto")return 0;if(typeof e=="number")return e;if(typeof e=="string"){let t=parseInt(e,10);return isNaN(t)?0:t}return 0}_applyTutorialPreset(e){if(this.debugState.ttAnchor==="body"){let i=Xt[e];i?(this.debugState.ttPercentX=i[0],this.debugState.ttPercentY=i[1],this.tutorialPositionalControllers.percentX?.updateDisplay(),this.tutorialPositionalControllers.percentY?.updateDisplay()):this.logger.warn("DebugService",`Preset key "${e}" not found for percentage presets.`)}else this.logger.warn("DebugService","Offset presets not yet defined for element anchors.");this._handleTutorialTune()}_updateTutorialControlVisibility(e){let t=(i,a)=>{i&&i.show(a)};t(this.tutorialPositionalControllers.percentX,e),t(this.tutorialPositionalControllers.percentY,e),t(this.tutorialPositionalControllers.placement,!e),t(this.tutorialPositionalControllers.distance,!e),t(this.tutorialPositionalControllers.skidding,!e),this.tutorialPositionalControllers.presetFolder&&this.tutorialPositionalControllers.presetFolder.show(e)}setActiveTutorialStep(e){this.logger.info.system("DebugService",`Setting active tutorial step: ${e.stepId}`);let t=e.anchorElement==="body";if(this.debugState.ttGeneratedCode="",this.debugState.ttStepId=e.stepId,this.debugState.ttAnchor=e.anchorElement,this.debugState.ttWidth=this._parseSize(e.size?.width)||0,this.debugState.ttHeight=this._parseSize(e.size?.height)||0,t)this.debugState.ttPercentX=e.positionX??50,this.debugState.ttPercentY=e.positionY??50,this.debugState.ttPlacement="auto",this.debugState.ttOffsetDistance=0,this.debugState.ttOffsetSkidding=0;else{let i=e.popperOptions?.modifiers?.find(o=>o.name==="offset"),a=0,s=0;typeof i?.options?.offset=="function"?(this.logger.warn("DebugService",`Offset function used for ${e.stepId}. Tuner defaults to [0, 10].`),s=10):Array.isArray(i?.options?.offset)?(a=i.options.offset[0]||0,s=i.options.offset[1]||0):s=10,this.debugState.ttPlacement=e.placement||e.popperOptions?.placement||"auto",this.debugState.ttOffsetDistance=s,this.debugState.ttOffsetSkidding=a,this.debugState.ttPercentX=50,this.debugState.ttPercentY=50}this._updateTutorialControlVisibility(t),Object.values(this.tutorialPositionalControllers).forEach(i=>{i&&typeof i.updateDisplay=="function"&&i.updateDisplay()}),this.gui.controllers.find(i=>i.property==="ttWidth")?.updateDisplay(),this.gui.controllers.find(i=>i.property==="ttHeight")?.updateDisplay()}clearActiveTutorialStep(){this.logger.info.system("DebugService","Clearing active tutorial step."),this.debugState.ttStepId="None",this.debugState.ttAnchor="N/A",this.debugState.ttPlacement="auto",this.debugState.ttOffsetDistance=0,this.debugState.ttOffsetSkidding=0,this.debugState.ttPercentX=50,this.debugState.ttPercentY=50,this.debugState.ttWidth=0,this.debugState.ttHeight=0,this.debugState.ttGeneratedCode="",this._updateTutorialControlVisibility(!1)}_handleTutorialTune(){if(!this.uiManager)return;let e=this.debugState.ttAnchor==="body";this.logger.info.system("DebugService",`Tune event (Overlay: ${e}): X%=${this.debugState.ttPercentX}, Y%=${this.debugState.ttPercentY}, Place=${this.debugState.ttPlacement}, Dist=${this.debugState.ttOffsetDistance}, Skid=${this.debugState.ttOffsetSkidding}`),this.uiManager.updateTutorialPopper({isOverlayAnchor:e,width:Number(this.debugState.ttWidth)||0,height:Number(this.debugState.ttHeight)||0,percentX:Number(this.debugState.ttPercentX)||50,percentY:Number(this.debugState.ttPercentY)||50,placement:this.debugState.ttPlacement,distance:Number(this.debugState.ttOffsetDistance)||0,skidding:Number(this.debugState.ttOffsetSkidding)||0})}_generateTutorialCode(){this.logger.info.system("DebugService","Generating tutorial code...");let e=this.debugState.ttAnchor==="body",t=this.debugState.ttWidth>0||this.debugState.ttHeight>0,i=this.debugState.ttWidth>0?`'${this.debugState.ttWidth}px'`:"'auto'",a=this.debugState.ttHeight>0?`'${this.debugState.ttHeight}px'`:"'auto'",s=t?`
size: { width: ${i}, height: ${a} },`:"",o="";e?(o=`
anchorElement: 'body',`,(this.debugState.ttPercentX!==50||this.debugState.ttPercentY!==50)&&(o+=`
positionX: ${this.debugState.ttPercentX},
positionY: ${this.debugState.ttPercentY},`)):(this.debugState.ttAnchor!=="body"&&(o=`
anchorElement: '${this.debugState.ttAnchor}',`),o+=`
placement: '${this.debugState.ttPlacement}',
popperOptions: {
    modifiers: [
        { name: 'offset', options: { offset: [${this.debugState.ttOffsetSkidding}, ${this.debugState.ttOffsetDistance}] } }
        // Add other modifiers here if needed in the future
    ]
}`);let r=`// --- ${this.debugState.ttStepId} ---${s}${o}`;r=r.replace(/,\s*(\}|$)/g,"$1"),this.debugState.ttGeneratedCode=r}};var Ke={loc_venus:["Breathe easy in the floating cities of Venus.","Great minds meet here... and whisper.","Got a problem? The Venetian Syndicate has a solution... for a price.","Enjoy the view from the opulent circles of Aphrodite Prime.","Venusian atmospheric processors are working at 110% capacity today.","Pressure-shielding inspections are mandatory for all surface-level maintenance crews.",`"What's said on Venus, stays on Venus." - Unofficial motto.`,"Our labs are patenting the future; are you investing?","Trade in secrets, not just cargo. You're on Venus, after all.","Don't let the clouds fool you; the opportunities are clear.","Acid-proof your hull today at a local dry-dock.","Need information? Ask the right people in the City of Whispers.","You're at the system's premier destination for high-tech research.",'Corporate espionage is just "competitive intelligence" here.',"See the beauty of the acidic storms from our secure viewports.","The price of knowledge is high, but the profits are higher.","You're among the elite. You've made it to Venus.","Our floating cities: A miracle of engineering above a crushing hell.","Venusian science leads the system in processor and bio-ware."],loc_earth:["The blue jewel of the system welcomes you home.","Breathe real, unfiltered air. Enjoy your stay on Earth.","The Terran Alliance ensures peace and prosperity for all.","While you're here, visit the cradle of civilization.",'"A ship from Earth is a ship that lasts." - Terran Shipyards.',"Our orbital traffic is busy, but our markets are busier.","Earth: The system's standard for quality and luxury.","Why settle for synthetic? Get real Terran-grown food while you're here.","The Terran Alliance reminds you: clean trade is good trade.","See the rebuilt wonders of the 21st century!","Welcome to Earth, the hub of power, wealth, and influence.","Don't miss Old Chicago, New Beijing, and Neo-Alexandria!","Earth sets the economic and cultural pace for the system.","Our deep-thought computation centers are the system's finest.","Terran markets pay top credit for exotic materials."],loc_luna:["Luna: The industrial heart of the Terran sphere.","Got hull damage? Lunar dry-docks offer the system's best repair rates.","Our Plasteel is forged in vacuum, and it shows.","Need Propellant? We refine it right here, 24/7.",'"We scar the dust so you can fly." - Lunar Mining Co.',"Check out the Sea of Tranquility Industrial Park.","Lunar-built ships are building the future.","The Helium-3 rush may be over, but the work never stops.","Enjoy the Earthrise from a dusty viewport on the surface.","Get your ship serviced while you enjoy low-G comforts.","Lunar manufacturing: Simple, reliable, and affordable.","Stop by a dry-dock for a quick patch-up; our crews are waiting.","You're on the grey frontier, where fortunes are still made.","Dust warnings in effect for sectors 4 through 9.","Need raw materials? You're in the right place.","The Moon: Earth's loyal, hardworking partner.","Our mass-drivers fire tons of Plasteel into orbit every hour.","Don't forget to clean your filters; the dust gets everywhere.",`"If it's not from Luna, is it even built to last?"`],loc_mars:["Mars needs you! And your cargo, of course.","Help build the future; your deliveries build Mars.",`You're on the "Red Frontier," watching a new world in the making.`,"Terraforming is a thirsty business; Hydroponics wanted!","Dust storm warnings are in effect for the Hellas Basin.","You're standing on the first corporate state, the first in freedom!","We're expanding! Many commodities are in high demand.","See the great Olympus Mons, the system's largest mountain.",'"Our independence was built on commerce." - Mars Gov.',"New colonial supply contracts are regularly posted at the terminal.","We're not just building a colony, we're building a nation.","Ship your Cryo-Pods here; help grow our population.","The Martian dream is alive and well.","Enjoy the red skies, red dust, and golden opportunities.","Our fledgling biodomes are always hungry for more expansion.","Watch your step; construction is everywhere.","The thin air is tough, but so are our people.","Here on Mars, corporate policy is the only law.","Invest in a terraforming project today!","Need a solid ship? Martian shipyards build the toughest vessels."],loc_belt:["You're in the Belt: Find your fortune, or find your end.",`"Rock-rich and law-poor." - A Belter's motto.`,"Water Ice is cheap, but life is cheaper.","Need a ship? Our local scrap-yards hide many gems.","Prospectors wanted: high risk, high reward.","Watch your navigation; these rocks are unforgiving.","Out here, a good sensor array is your best friend..","Ice-haulers needed in sector 14-B.","Don't ask where the cargo came from.","A thousand hidden outposts, a million opportunities.","In the Belt, you can keep your transponder on... or off.","The Belt is no place for the faint of heart.","Countless rocks tumble in a silent, chaotic dance.","Need a scrappy craft? We build them tough enough for the Belt.","Raw materials, raw ambition. That's the Belt."],loc_exchange:["The Exchange: All goods, no questions.","Welcome to The Exchange. Check your morals at the airlock.","Need to move... sensitive cargo? We're your partners.","Comms are jammed for everyone's privacy.","Heed the security drones and yield to patrols.","High stakes, high rewards. Welcome to The Exchange.","At The Exchange, every credit is clean.","Don't ask, don't tell, just trade.","Prices are high, but discretion is absolute.","Find your next ship at The Exchange shipyards.","We trade in anything the corporations forbid.","The only law here is the law of supply and demand.","Fuel is a premium, but freedom is priceless.","You've arrived at the legendary black market. ","A hollow asteroid, a universe of opportunity.","We deal in rumors and secrets at The Exchange."],loc_jupiter:["The cheapest fuel in the system, guaranteed.","Enjoy the view from our orbital refineries.",'"We skim the giant so you can fly." - Jovian Fuel Co.',"Automated refineries are working constantly to keep you fueled.","You're at the essential pit-stop for all outer-system routes.","Don't get caught empty; top off while you're here.","Our fuel prices can't be beat!","The colossal sphere of Jupiter dominates every view.","Planning a long haul? Start with a full tank.","We specialize in one thing: cheap, high-grade Propellant.","Our exploration ships are built for the deep void.","The Great Red Spot: A baleful eye, a beautiful sight.","Need Atmo Processors? We build them big right here.","Gravity is high, but our prices are low.","The giant that fuels the whole system.","Radiation warnings in effect. Dock quickly.","Our automated systems mean fast, efficient refueling.",'"A full tank from Jupiter is a full wallet tomorrow."',"Come for the fuel, stay for the view."],loc_saturn:["Enjoy the majestic rings of Saturn.","You've arrived at the system's premier luxury destination.","Visit the opulent stations of the Ring-Dwellers.","Got luxury goods? Our markets pay top credit!","Bio-tech are in high demand on Saturn.","Relax in opulent zero-G luxury on your favorite ring today!",'"Give a ring, on a ring, with a view to remember." - Saturn Tourism Board.',"Our casinos are open always.","Experience the shadow of the rings.","Home of the best personal transport. Travel in style.","Bring us your exotic bio-wares, leave with a fortune.","You're at the jewel of the outer system.","Ice-harvesting rigs and luxury hotels, side-by-side.","This is where the wealthy come to play.","Forget the dust of the Belt; experience true opulence.","Our markets crave the finest things in life.","Corporate retreats and high-stakes tourism."],loc_uranus:["Uranus: Pushing the boundaries of science.","Need a boost? Our R&D labs offer component overclocking.","The pale, featureless orb holds deep secrets.","Report: Quantum phenomena studies are yielding strange results.","We build the system's largest craft. Reserve yours today.","Research outposts glitter like ice in the eternal twilight.","You're at the system's hub for theoretical physics.","Our ships are built for self-sufficiency.","Don't mind the strange sensor readings; it's just the science.","Welcome to the Tilted Planet at the edge of the known.","A silent, ice-cold world of opportunity.","We're hiring long-haul traders. Discretion is a must.",`"What is reality? We're working on it." - Uranus R&D.`,"The coldest, quietest, and strangest port in the system.","Our scientists are unlocking the secrets of the void."],loc_neptune:["You are in military-controlled space. Transponder required.","Supersonic winds and high-security stations.","Check out the military surplus shipyard. All sales final.",'"Monitor your engine wake when in port." - Neptune Patrol.',"Heavily armed patrols are for your protection.","The dark, stormy edge of the system.","Decommissioned frigates regularly for sale.","Have your clearance codes ready.","Welcome to the Dark Blue Pearl - beautiful, but dangerous.","Neptune's shipyards build for war, not for comfort.","Need a ship that can take a punch? Buy military surplus.","This is a restricted zone. Authorized traders only.","The winds here are fast, but our patrol ships are faster.","Shielded orbital stations offer refuge from the storm.",`"Obey the patrols, and you'll be fine."`,"Neptune: The armored fist of the outer system.","Our surplus sales are legendary. Get a frigate for cheap.","The last, stormy bastion of corporate law."],loc_kepler:["Kepler's Eye: We are watching the void.","Our Markets are astronomical.","You're looking at the single largest lens in human history.",'"We look for answers in the dark." - Kepler R&D.','"Staring into the infinite, always." - Kepler R&D.',"Our observatory consumes more power than a small city.","The furthest point of scientific ambition.",`"What's out there? Let's find out." - Kepler R&D`,"Our delicate sensor arrays are always expanding.","A colossal lens, a universe of data.","Kepler's Eye: The system's lonely sentinel.","Your cargo deliveries help fuel discovery.","Dock carefully; our sensor lattice is fragile.","The quietest station in the system.","See the system as you've never seen it before.","Kepler's Eye: What do the stars see when they look back?"],loc_pluto:["Pluto: The last stop.","Welcome to the fringe. Don't cause trouble.",'"We care not for your past, but your business."',"You're at the haven for outcasts, at the system's cold, dark edge.","Forbidden tech? We call it unregulated.","Our stations are carved from a mountains of nitrogen-ice.","Smugglers, outcasts, and pioneers are all welcome here.","Pluto: The furthest outpost from corporate law.","The light is dim, but the opportunities are bright.","Need supplies? We've got the strangest.","Pluto's tiny, frozen heart is a whisper in the dark.",`"It's cold, it's dark, and it's home." - Pluto Tourism Board`,"Need a place to lay low? You found it.",`"We have what the core worlds don't."`,"System jurisdiction ends here, but your stay doesn't have to."]};var Qt=15,Jt={loc_venus:"var(--color-theme-venus)",loc_earth:"var(--color-theme-earth)",loc_luna:"var(--color-theme-luna)",loc_mars:"var(--color-theme-mars)",loc_belt:"var(--color-theme-belt)",loc_exchange:"var(--color-theme-exchange)",loc_jupiter:"var(--color-theme-jupiter)",loc_saturn:"var(--color-theme-saturn)",loc_uranus:"var(--color-theme-uranus)",loc_neptune:"var(--color-theme-neptune)",loc_kepler:"var(--color-theme-kepler)",loc_pluto:"var(--color-theme-pluto)"},Ge=class{constructor(e){this.gameState=e,this.simulationService=null,this.marketService=null,this.messageQueue=[],this.isDirty=!0,this.welcomeMessagePlayed=!1}setServices(e,t){this.simulationService=e,this.marketService=t}pushMessage(e,t,i=!1,a=!1){if(e&&this.messageQueue.some(o=>o.text===e))return;let s={id:Date.now()+Math.random(),text:e,type:t,requiresLiveData:a};for(i?this.messageQueue.unshift(s):this.messageQueue.push(s);this.messageQueue.length>Qt;)this.messageQueue.shift();this.isDirty=!0}pulse(){}onLocationChange(e=null){let t=this.gameState.getState(),i=e||t.currentLocationId;this.messageQueue=[],this.generateWelcomeMessage(),this.generatePurchasedIntelMessage(),this.generateFreeIntelMessage(i);let a=this.selectLocationFlavorAds(i);a[0]&&this.pushMessage(a[0],"FLAVOR"),this.pushMessage("","STATUS",!1,!0),this.isDirty=!0}getTickerContentHtml(){this.messageQueue.length===0&&!this.welcomeMessagePlayed&&this.generateWelcomeMessage();let e='<span class="ticker-separator">//</span>';return`${this.messageQueue.map(i=>{let a=i.text,s="";return i.requiresLiveData&&i.type==="STATUS"&&(a=this.getLiveStatusText()),i.type==="FLAVOR"&&(s=`style="color: ${this.getLocationColor()};"`),`<span class="ticker-message" data-type="${i.type}" ${s}>${a}</span>`}).join(e)}${e}`}generateWelcomeMessage(){this.welcomeMessagePlayed||(this.pushMessage("Welcome to Orbital Trading","SYSTEM",!0),this.welcomeMessagePlayed=!0)}generateFreeIntelMessage(e){if(!this.marketService)return;let t=this.gameState.getState(),i=t.market.prices[e];if(!i)return;let a=p.COMMODITIES,s={commodityId:null,discount:0};for(let o of a){if(!o||!o.basePriceRange||o.tier>t.player.revealedTier)continue;let r=i[o.id];if(r===void 0)continue;let n=(o.basePriceRange[0]+o.basePriceRange[1])/2,l=(n-r)/n;l>s.discount&&(s={commodityId:o.id,discount:l})}if(s.discount>=.05){let o=a.find(d=>d.id===s.commodityId).name,r;s.discount>.5?r="tier5":s.discount>.3?r="tier4":s.discount>.2?r="tier3":s.discount>.1?r="tier2":r="tier1";let n=ct[r],l=n[Math.floor(Math.random()*n.length)];l=l.replace("{Commodity Name}",o),this.pushMessage(l,"INTEL")}else this.pushMessage("Market conditions nominal.","INTEL")}generatePurchasedIntelMessage(){}selectLocationFlavorAds(e){let t=Ke[e]||Ke.loc_belt;if(t.length===0)return["",""];if(t.length===1)return[t[0],t[0]];let i=[...t].sort(()=>.5-Math.random());return[i[0],i[1]]}getLiveStatusText(){try{let e=this.gameState.getState(),t=e.player.activeShipId;if(!t)return"STATUS: NO ACTIVE SHIP";let i=p.SHIPS[t],a=e.player.shipStates[t];if(!i||!a)return"STATUS: DATA ERROR";let s=Math.round(a.fuel/i.maxFuel*100),o=Math.round(a.health/i.maxHealth*100),r=0,n=e.player.inventories[t];n&&(r=Object.values(n).reduce((d,h)=>d+h.quantity,0));let l=i.cargoCapacity;return`${i.name}: FUEL: ${s}% | CARGO: ${r}/${l} | HULL: ${o}%`}catch(e){return console.error("NewsTickerService Error generating status:",e),"STATUS: ERROR"}}getLocationColor(){let e=this.gameState.getState().currentLocationId;return Jt[e]||"var(--color-text-primary)"}};var Ue=()=>{let c=document.getElementById("game-container");if(!c)return;let e=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-height",`${e}px`);let t=926;if(e<t){let i=e/t;c.style.height=`${t}px`,c.style.transform=`scale(${i})`,c.style.transformOrigin="top center",document.body.style.alignItems="flex-start"}else c.style.transform="none",c.style.height="100dvh",document.body.style.alignItems="center"};document.addEventListener("DOMContentLoaded",()=>{B.init().catch(l=>console.warn("[Main] Asset Locker failed to initialize:",l));let c=document.getElementById("splash-screen"),e=document.getElementById("start-game-btn"),t=document.getElementById("debug-start-btn"),i=!0,a=new xe(he),s=document.getElementById("eula-checkbox"),o=document.getElementById("eula-container");c&&c.addEventListener("click",l=>{let d=l.target.closest("[data-action]");d&&d.dataset.action==="show_eula_modal"&&(l.preventDefault(),a.showEulaModal())}),o&&o.addEventListener("animationend",()=>{o.classList.remove("pulse-eula-warning")});let r=l=>{if(!s||!o){console.error("EULA elements not found!");return}if(!s.checked){o.classList.remove("pulse-eula-warning"),setTimeout(()=>{o.classList.add("pulse-eula-warning")},10);return}c.classList.add("splash-screen-hiding"),c.addEventListener("animationend",()=>{c.style.display="none",l()},{once:!0})};Ue(),window.visualViewport?(window.visualViewport.addEventListener("resize",Ue),window.visualViewport.addEventListener("scroll",Ue)):window.addEventListener("resize",Ue),e.addEventListener("click",()=>{r(()=>n(!1,a,he))},{once:!1}),t.addEventListener("click",()=>{r(()=>n(!0,a,he))},{once:!1});function n(l=!1,d,h){let u=new me,m=new Ge(u),g=new Pe(u,d,h),f=new Te(u,d,h,m),S=new De(u,d,f,d.navStructure,h),y=null;i&&(y=new Be(u,f,d,h),y.init(),d.setDebugService(y)),d.setNewsTickerService(m),d.setMissionService(g),d.setSimulationService(f),f.setTutorialService(S),f.setMissionService(g),g.setSimulationService(f);let b=new ke(u,f,d,S,y,h);d.setEventManager(b),u.subscribe(()=>d.render(u.getState()));let E=u.loadGame();E||(l&&y?(u.startNewGame(""),y.simpleStart()):(u.startNewGame(""),f.timeService.advanceDays(7),f.startIntroSequence())),b.bindEvents(),(E||l)&&(d.showGameContainer(),m.onLocationChange(),d.render(u.getState())),S.checkState({type:"SCREEN_LOAD",screenId:u.activeScreen});let A=u.getState();B.hydrateGameAssets(A.player)}});})();
