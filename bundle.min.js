(()=>{var A=Object.freeze({MAP:"map",NAVIGATION:"navigation",SERVICES:"services",MARKET:"market",CARGO:"cargo",HANGAR:"hangar",MISSIONS:"missions",FINANCE:"finance",INTEL:"intel"}),N=Object.freeze({SHIP:"ship",STARPORT:"starport",DATA:"data"}),L=Object.freeze({WANDERER:"starter",STALWART:"hauler_c1",MULE:"hauler_c2",PATHFINDER:"explorer_b1",NOMAD:"explorer_b2",VINDICATOR:"frigate_a1",AEGIS:"frigate_a2",ODYSSEY:"luxury_s1",MAJESTIC:"luxury_s2",TITAN_HAULER:"rare_s1",VOID_CHASER:"rare_s2",GUARDIAN:"rare_s3",STARGAZER:"rare_s4",BEHEMOTH:"rare_o1"}),E=Object.freeze({WATER_ICE:"water_ice",PLASTEEL:"plasteel",HYDROPONICS:"hydroponics",CYBERNETICS:"cybernetics",PROPELLANT:"propellant",PROCESSORS:"processors",GMO_SEEDS:"gmo_seeds",CRYO_PODS:"cryo_pods",ATMO_PROCESSORS:"atmos_processors",CLONED_ORGANS:"cloned_organs",XENO_GEOLOGICALS:"xeno_geologicals",SENTIENT_AI:"sentient_ai",ANTIMATTER:"antimatter",FOLDED_DRIVES:"folded_drives"}),v=Object.freeze({EARTH:"loc_earth",LUNA:"loc_luna",MARS:"loc_mars",VENUS:"loc_venus",BELT:"loc_belt",SATURN:"loc_saturn",JUPITER:"loc_jupiter",URANUS:"loc_uranus",NEPTUNE:"loc_neptune",PLUTO:"loc_pluto",EXCHANGE:"loc_exchange",KEPLER:"loc_kepler"}),M=Object.freeze({TRADEMASTER:"trademaster",NAVIGATOR:"navigator",VENETIAN_SYNDICATE:"venetian_syndicate",MERCHANT_GUILD_SHIP:"merchant_guild_ship"}),I=Object.freeze({DEBUG_SIMPLE_START:"debug-simple-start",SET_SCREEN:"set-screen",TRAVEL:"travel",BUY_SHIP:"buy-ship",SELL_SHIP:"sell-ship",SELECT_SHIP:"select-ship",PAY_DEBT:"pay-debt",TAKE_LOAN:"take-loan",PURCHASE_INTEL:"purchase-intel",ACQUIRE_LICENSE:"acquire-license",BUY_ITEM:"buy-item",SELL_ITEM:"sell-item",SET_MAX_BUY:"set-max-buy",SET_MAX_SELL:"set-max-sell",INCREMENT:"increment",DECREMENT:"decrement",SHOW_PRICE_GRAPH:"show-price-graph",SHOW_FINANCE_GRAPH:"show-finance-graph",TOGGLE_MARKET_CARD_VIEW:"toggle-market-card-view",TOGGLE_HANGAR_MODE:"toggle-hangar-mode",SET_HANGAR_PAGE:"set-hangar-page"}),D=Object.freeze({SCREEN_LOAD:"SCREEN_LOAD",ACTION:"ACTION",INFO:"INFO"}),C=Object.freeze({STARTING_CREDITS:5e3,STARTING_DEBT_INTEREST:125,REPAIR_COST_PER_HP:75,REPAIR_AMOUNT_PER_TICK:5,FUEL_SCALAR:3,INTEREST_INTERVAL:30,PASSIVE_REPAIR_RATE:.02,HULL_DECAY_PER_TRAVEL_DAY:1/7,SHIP_SELL_MODIFIER:.75,RARE_SHIP_CHANCE:.3,PRICE_HISTORY_LENGTH:65,FINANCE_HISTORY_LENGTH:25,DAILY_PRICE_VOLATILITY:.25,MEAN_REVERSION_STRENGTH:.04,MARKET_PRESSURE_DECAY:.7,LOCAL_PRICE_MOD_STRENGTH:.5,LOAN_GARNISHMENT_DAYS:1095,LOAN_GARNISHMENT_PERCENT:.14,RANDOM_EVENT_CHANCE:.07}),Te=[{threshold:5e4,revealsTier:2},{threshold:45e4,revealsTier:3},{threshold:4e6,revealsTier:4},{threshold:35e6,revealsTier:5},{threshold:3e8,revealsTier:6},{threshold:25e8,revealsTier:7}],xe="orbitalTraderSave_v2";var Ne={mission_tutorial_01:{id:"mission_tutorial_01",name:"Milk Run to Luna",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"Hey buddy, you're a new captain, right? My hauler's reactor is fried and I'm on the hook for a delivery to Luna.<br><br>Could you deliver this load of <b>Plasteel</b> to the <b>Moon</b> for me? I don't have any credits to spare, but I've padded the manifest.<br><br>Deliver what I owe, keep the rest. You won't have trouble selling it there, trust me.",objectives:[{type:"have_item",goodId:"plasteel",quantity:5}],completion:{locationId:"loc_luna",title:"Favor Complete",text:"The freelancer sends his thanks.",buttonText:"Deliver Plasteel"},rewards:[],providedCargo:[{goodId:"plasteel",quantity:6}]},mission_tutorial_02:{id:"mission_tutorial_02",name:"Martian Resupply",type:"DELIVERY",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"A construction crew on Mars has requested a small shipment of plasteel to complete a habitat.",prerequisites:[{type:"mission_completed",missionId:"mission_tutorial_01"}],objectives:[{type:"have_item",goodId:"plasteel",quantity:2}],completion:{locationId:"loc_mars",title:"Delivery Complete",text:"The construction foreman thanks you for the Plasteel.",buttonText:"Deliver Plasteel"},rewards:[{type:"credits",amount:7500}]},mission_license_t3:{id:"mission_license_t3",name:"Guild Certification",type:"LICENSE_GRANT",host:"GUILD",isRepeatable:!1,isAbandonable:!1,description:"The Merchant's Guild requires you to certify your trade proficiency. Accepting this contract formally recognizes your status and grants you access to Tier 3 commodities.",prerequisites:[{type:"revealed_tier",tier:3}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t3_license"}]},mission_license_t5:{id:"mission_license_t5",name:"Governor's Contract",type:"LICENSE_GRANT",host:"STATION",isRepeatable:!1,isAbandonable:!1,description:"The planetary governor requires a sign of your commitment to local industry. This contract solidifies your standing and unlocks access to Tier 5 commodities.",prerequisites:[{type:"revealed_tier",tier:5}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t5_license"}]},mission_license_t7:{id:"mission_license_t7",name:"Legendary Run",type:"LICENSE_GRANT",host:"UNKNOWN",isRepeatable:!1,isAbandonable:!1,description:"Your name is spoken in the farthest corners of the system. Only a legend of your stature may be granted the right to trade the most advanced technologies known.",prerequisites:[{type:"revealed_tier",tier:7}],objectives:[],completion:{},rewards:[{type:"license",licenseId:"t7_license"}]}};var Re=[{id:"distress_call",title:"Distress Call",scenario:"You pick up a distress signal from a small, damaged ship. They are out of fuel and requesting an emergency transfer to restart their reactor.",precondition:(d,e)=>e.fuel>=20,choices:[{title:"Offer Aid (20 Fuel)",outcomes:[{chance:.75,description:"The fuel transfer is successful. The grateful captain rewards you with 10,000 credits for your timely assistance.",effects:[{type:"fuel",value:-20},{type:"credits",value:1e4}]},{chance:.25,description:"As the fuel transfer begins, their reactor overloads! The resulting explosion damages your hull by 15%.",effects:[{type:"fuel",value:-20},{type:"hull_damage_percent",value:15}]}]},{title:"Ignore the Call",outcomes:[{chance:1,description:"You press on, and the desperate signal fades behind you.",effects:[]}]}]},{id:"floating_cargo",title:"Floating Cargo Pod",scenario:"Long-range sensors detect an unmarked, sealed cargo pod adrift in the shipping lane. It appears to be intact.",precondition:()=>!0,choices:[{title:"Bring it Aboard",outcomes:[{chance:.6,description:"The pod contains valuable goods. You gain 25 units of Neural Processors.",effects:[{type:"add_cargo",value:{id:E.PROCESSORS,quantity:25}}]},{chance:.4,description:"It was a trap! The pod is booby-trapped and detonates as your tractor beam locks on, causing 20% hull damage.",effects:[{type:"hull_damage_percent",value:20}]}]},{title:"Report it",outcomes:[{chance:1,description:"You notify the nearest station of the hazard and receive a small finder's fee of 1,000 credits.",effects:[{type:"credits",value:1e3}]}]}]},{id:"adrift_passenger",title:"Adrift Passenger",scenario:"You find a spacer in a functioning escape pod. Their beacon is down, and they ask for passage to the nearest civilized port.",precondition:(d,e)=>e.fuel>=30,choices:[{title:"Take Aboard for Payment",outcomes:[{chance:1,description:"The passenger is grateful for the rescue and pays you 10,000 credits upon arrival at your destination.",effects:[{type:"credits",value:1e4}]}]},{title:"Give a Fuel Cell (30 Fuel)",outcomes:[{chance:1,descriptions:{reward_cybernetics:'In gratitude, the passenger gives you a crate of <span class="hl-green">40 Cybernetics</span>.',reward_debt_paid:'Seeing your tight cargo, the passenger pays off 20% of your debt, reducing it by <span class="hl-green">{amount}</span>.',reward_credits:'With no room and no debt, the passenger transfers you <span class="hl-green">{amount}</span>.'},effects:[{type:"ADRIFT_PASSENGER"}]}]}]},{id:"meteoroid_swarm",title:"Micrometeoroid Swarm",scenario:"Alarms blare as you fly into an uncharted micrometeoroid swarm. Your navigation computer suggests two options to minimize damage.",precondition:(d,e)=>e.fuel>=15,choices:[{title:"Evade Aggressively (+15 Fuel)",outcomes:[{chance:1,description:"You burn extra fuel to successfully dodge the worst of the swarm, emerging unscathed.",effects:[{type:"fuel",value:-15}]}]},{title:"Brace for Impact",outcomes:[{chance:1,description:"You trust your hull to withstand the impacts, taking a beating but saving fuel.",effects:[{type:"hull_damage_percent",value:[10,25]}]}]}]},{id:"engine_malfunction",title:"Engine Malfunction",scenario:"A sickening shudder runs through the ship. A key plasma injector has failed, destabilizing your engine output.",precondition:(d,e,t)=>(t()[E.PLASTEEL]?.quantity||0)>=5,choices:[{title:"Quick, Risky Fix (5 Plasteel)",outcomes:[{chance:.5,description:"The patch holds! The engine stabilizes and you continue your journey without further incident.",effects:[{type:"lose_cargo",value:{id:E.PLASTEEL,quantity:5}}]},{chance:.5,description:"The patch fails catastrophically, causing a small explosion that deals 20% hull damage.",effects:[{type:"lose_cargo",value:{id:E.PLASTEEL,quantity:5}},{type:"hull_damage_percent",value:20}]}]},{title:"Limp to Destination",outcomes:[{chance:1,description:"You shut down the faulty injector. The ship is slower, but stable. Your remaining travel time increases by 25%.",effects:[{type:"travel_time_add_percent",value:.25}]}]}]},{id:"nav_glitch",title:"Navigation Sensor Glitch",scenario:"The nav-console flashes red. Your primary positioning sensors are offline, and you're flying blind in the deep dark.",precondition:()=>!0,choices:[{title:"Attempt Hard Reboot",outcomes:[{chance:.5,description:"Success! The sensors come back online. In your haste, you find a shortcut, shortening your trip. You will arrive the next day.",effects:[{type:"set_travel_time",value:1}]},{chance:.5,description:"The reboot corrupts your course data, sending you on a long, meandering path. This adds 15 days to your journey.",effects:[{type:"travel_time_add",value:15}]}]},{title:"Navigate Manually",outcomes:[{chance:1,description:"You rely on old-fashioned star charts. It's slow but safe, adding 7 days to your trip.",effects:[{type:"travel_time_add",value:7}]}]}]},{id:"life_support_fluctuation",title:"Life Support Fluctuation",scenario:"An alarm indicates unstable oxygen levels. It's not critical yet, but the crew is on edge and efficiency is dropping.",precondition:(d,e)=>e.health>e.maxHealth*.25,choices:[{title:"Salvage materials from the ship to repair the atmospheric regulators. (This will cost 25% hull damage)",outcomes:[{chance:1,description:"You cannibalize some non-essential hull plating to get the regulators working again. The system stabilizes, but the ship's integrity is compromised.",effects:[{type:"hull_damage_percent",value:25}]}]},{title:"Defer Maintenance Costs",outcomes:[{chance:1,description:"You log the issue for later. The cost of repairs and crew hazard pay, 5,000 credits, is added to your debt.",effects:[{type:"add_debt",value:5e3}]}]}]},{id:"cargo_rupture",title:"Cargo Hold Rupture",scenario:"A micrometeorite has punched a small hole in the cargo bay. One of your cargo stacks is exposed to hard vacuum.",precondition:(d,e,t)=>{let i=t();return i?Object.values(i).some(a=>a.quantity>0):!1},choices:[{title:"Jettison Damaged Cargo",outcomes:[{chance:1,description:"You vent the damaged section, losing 10% of a random cargo stack from your hold into the void.",effects:[{type:"lose_random_cargo_percent",value:.1}]}]},{title:"Attempt EVA Repair",outcomes:[{chance:.75,description:"The emergency patch holds! The cargo is safe, but the repair adds 2 days to your trip.",effects:[{type:"travel_time_add",value:2}]},{chance:.25,description:"The patch fails to hold. Explosive decompression destroys 50% of the cargo stack, and the repair still adds 2 days to your trip.",effects:[{type:"lose_random_cargo_percent",value:.5},{type:"travel_time_add",value:2}]}]}]},{id:"space_race",title:"Space Race Wager",scenario:'A smug-looking luxury ship pulls alongside and its captain, broadcasted on your main screen, challenges you to a "friendly" race to the destination.',precondition:d=>d.player.credits>100,choices:[{title:"Accept Wager (Bet: 80% of current credits)",outcomes:[{chance:1,description:"You accept the high-stakes challenge...",effects:[{type:"SPACE_RACE",wagerPercentage:.8,winChance:{S:.85,A:.7,B:.55,C:.4,O:.95}}]}]},{title:"Politely Decline",outcomes:[{chance:1,description:"You decline the race. The luxury ship performs a flashy maneuver and speeds off, leaving you to travel in peace.",effects:[]}]}]},{id:"supply_drop",title:"Emergency Supply Drop",scenario:"You intercept a system-wide emergency broadcast. A new outpost is offering a massive premium for an immediate delivery of a specific commodity that you happen to be carrying.",precondition:(d,e,t)=>{let i=t();return i&&Object.values(i).some(a=>a.quantity>0)},choices:[{title:"Divert Course to Deliver",outcomes:[{chance:1,description:"You sell your entire stack of the requested commodity for 3 times its galactic average value. Your course is diverted to a new, random destination, adding 7 days to your trip.",effects:[{type:"sell_random_cargo_premium",value:3},{type:"travel_time_add",value:7},{type:"set_new_random_destination"}]}]},{title:"Decline and Continue",outcomes:[{chance:1,description:"You stick to your original plan and let someone else handle the emergency supply run.",effects:[]}]}]}];var we=[{id:"captain_choice",trigger:{day:366},title:"Captain Who?",description:"You've successfully navigated many trades and run a tight ship. Your crew depends on you... but what kind of captain will you be?",choices:[{title:"Trademaster",description:"5% bonus on all trade profits.",perkId:M.TRADEMASTER,playerTitle:"Trademaster"},{title:"Navigator",description:"10% reduced fuel usage, hull decay, and travel time.",perkId:M.NAVIGATOR,playerTitle:"Navigator"}]},{id:"friends_with_benefits",trigger:{credits:5e4},title:"Friends with Benefits",description:"An ally in need is an ally indeed.",choices:[{title:"Join the Merchant's Guild",description:"Receive a free C-Class freighter.",perkId:M.MERCHANT_GUILD_SHIP},{title:"Join the Venetian Syndicate",description:"75% discount on fuel and repairs at Venus.",perkId:M.VENETIAN_SYNDICATE}]}];var Oe={intro_hangar:{title:"Your First Ship",trigger:{type:D.ACTION,action:"INTRO_START_HANGAR"},navLock:!0,steps:[{stepId:"hangar_1",text:"Welcome to the <b>Shipyard</b> on <b>Mars!</b><br><br>Every station has a port from which you can trade ships and manage your <b>Hangar</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:16,completion:{type:D.INFO},nextStepId:"hangar_2",isSkippable:!0},{stepId:"hangar_2",text:"Now that you've borrowed <b class='hl-yellow font-bold'>extra credits</b>, you can buy your first ship!<br><br>Select one of the options in the <b>Shipyard</b>. Choose carefully...",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:17,completion:{type:D.ACTION,action:I.BUY_SHIP},nextStepId:"hangar_3",isSkippable:!0,unlockPurchase:!0},{stepId:"hangar_3",text:'This is your <b>Hangar</b>. From here you can manage all the ships you own. Select your new ship and <b class="hl-yellow font-bold">Board</b> it to make it your active vessel.',size:{width:"400px",height:"110px"},anchorElement:"body",positionX:50,positionY:12,completion:{type:D.ACTION,action:I.SELECT_SHIP},nextStepId:null,isSkippable:!1}]},intro_finance:{title:"Managing Your Debt",trigger:{type:D.ACTION,action:"INTRO_START_FINANCE"},navLock:!0,steps:[{stepId:"finance_1",text:"That was a big purchase, but don't worry - you've still got some <b class='hl-yellow font-bold'>credits</b> left over!<br><br>Your transaction history and debts can be viewed on the <b>Finance</b> tab within <b>Data</b>.",size:{width:"400px",height:"120px"},anchorElement:"body",positionX:50,positionY:16,completion:{type:D.INFO},nextStepId:"finance_2",isSkippable:!1},{stepId:"finance_2",text:"Dont forget, your debt to the <b class='hl-yellow font-bold'>Merchant's Guild</b> is due in <b class='hl-red font-bold'>3 years</b>.<br><br>You will need to earn <b class='hl-yellow font-bold'>credits</b> to <b>pay off your debt</b>!",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:16,completion:{type:D.INFO},nextStepId:null,isSkippable:!1}]},intro_missions:{id:"intro_missions",title:"First Steps",trigger:{type:"ACTION",action:"INTRO_START_MISSIONS"},navLock:!0,steps:[{stepId:"mission_1_1",text:"This is the <b>Mission Terminal</b>.<br><br>Check the <b>Missions</b> tab often for opportunities to earn <b class='hl-yellow font-bold'>credits</b> and improve your reputation.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"INFO"},nextStepId:"mission_1_2",isSkippable:!1},{stepId:"mission_1_2",text:"A freelancer at the <b>Mars</b> station has put in a <b>Delivery</b> request. Select the mission '<b>Milk Run to Luna</b>' to view more details.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"ACTION",action:"show-mission-modal"},nextStepId:"mission_1_3",isSkippable:!1},{stepId:"mission_1_3",text:"The freelancer can't pay, but he's giving you the <b>remaining cargo</b>. Accept the contract.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:84,completion:{type:"ACTION",action:"accept-mission"},nextStepId:"mission_1_4",isSkippable:!1},{stepId:"mission_1_4",text:"Mission accepted!<br><br>The contract is now <b>active</b> and the cargo as been loaded onto your ship, the <b>{shipName}</b>.<br><br>The freelancer has also loaded extra <b>Plasteel</b> which you can sell for <b class='hl-yellow font-bold'>credits</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:77,completion:{type:"INFO"},nextStepId:"mission_1_5",isSkippable:!1},{stepId:"mission_1_5",text:"This mission must be completed on the <b>Moon</b>, but you are presently docked at <b>Mars</b>! Therefore, it's time for the maiden voyage of your new ship, the <b>{shipName}</b>!<br><br>On the <b>nav bar</b> at the top, select the <b>Ship</b> tab, then the <b>Navigation</b> tab.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:27,completion:{type:"SCREEN_LOAD",screenId:"navigation"},nextStepId:"mission_1_6",isSkippable:!1,navLock:{navId:N.SHIP,screenId:"navigation"}},{stepId:"mission_1_6",text:"From here you can travel to other stations in the system. This will cost you <b>time</b>, <b class='hl-blue'>fuel</b>, and wear on the <b class='hl-green'>hull</b> of your ship.<br><br>Select the <b>Moon</b> to lift off from <b>Mars</b>.",size:{width:"400px",height:"170px"},anchorElement:"body",positionX:50,positionY:83,completion:{type:"ACTION",action:"travel"},nextStepId:"mission_1_7",isSkippable:!1,navLock:{navId:N.SHIP,screenId:"navigation",enabledElementQuery:"[data-location-id='loc_luna']"}},{stepId:"mission_1_7",text:"You've arrived and docked at the <b>Moon</b> station!<br><br>It's time to deliver the <b>Plasteel</b>. Select the active mission and <b>deliver the Plasteel</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:82,completion:{type:"ACTION",action:"complete-mission"},nextStepId:"mission_1_8",isSkippable:!1,navLock:{navId:N.DATA,screenId:"missions"}},{stepId:"mission_1_8",text:"Mission complete!<br><br>However, favors don't pay off <b class='hl-yellow font-bold'>Guild</b> loans. You're going to need more <b class='hl-yellow font-bold'>credits</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:25,completion:{type:"INFO"},nextStepId:"mission_2_1",isSkippable:!1},{stepId:"mission_2_1",text:"The <i>best way to make money</i> is to play the markets yourself by <b class='hl-green font-bold'>buying low and selling high</b>.<br><br>Select the <b>Starport</b> tab, then the <b>Market</b> tab.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:25,completion:{type:"SCREEN_LOAD",screenId:"market"},nextStepId:"mission_2_2",isSkippable:!1,navLock:{navId:N.STARPORT,screenId:"market"}},{stepId:"mission_2_2",text:"This is the <b>Moon Market</b>.<br>On each commodity you will find a wealth of information to aid your trading.<br><br>The <b class='hl-green font-bold'>MKT</b> indicator will inform you of <b class='hl-green font-bold'>prices higher or lower than average.</b> Selecting the price will reveal past performance.<br><br>Select the <b class='hl-yellow font-bold'>Buy/Sell toggle</b> to transition to sale mode, and then sell your single unit of <b>Plasteel</b>.",size:{width:"400px",height:"150px"},anchorElement:"body",positionX:50,positionY:67,completion:{type:"ACTION",action:"sell-item",goodId:"plasteel"},nextStepId:"mission_2_3",isSkippable:!1},{stepId:"mission_2_3",text:"<b class='hl-green font-bold'>Pure profit</b>!<br><br>However, you still need more <b class='hl-yellow font-bold'>credits</b>! Return to the <b>Mission Terminal</b> by selecting the <b>Data</b> tab.",size:{width:"400px",height:"150px"},anchorElement:"body",positionX:50,positionY:67,completion:{type:"SCREEN_LOAD",screenId:"missions"},nextStepId:"mission_2_4",isSkippable:!1,navLock:{navId:N.DATA,screenId:"missions"}},{stepId:"mission_2_4",text:"This mission offers a <b class='hl-yellow font-bold'>credit</b> reward.<br><br>Accept the mission, <b>Martian Resupply</b>.",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:77,completion:{type:"ACTION",action:"accept-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_3_1",isSkippable:!1},{stepId:"mission_3_1",text:"To complete this mission you will need to <b>travel to Mars</b> after you have purchased <b>two Plasteel</b> from any <b>Market</b>.<br><br>After you have acquired the <b>Plasteel</b>, visit the <b>Mission</b> tab on <b>Mars</b> to submit the cargo and complete the mission. ",size:{width:"400px",height:"160px"},anchorElement:"body",positionX:50,positionY:83,completion:{type:"ACTION",action:"complete-mission",missionId:"mission_tutorial_02"},nextStepId:"mission_final",isSkippable:!1,navLock:null},{stepId:"mission_final",text:"Well done Captain {playerName}, you have successfully completed trades across the <b>Moon</b> and <b>Mars</b>.<br><br>Continue to trade commodities for <b class='hl-green font-bold'>favorable margins</b> and complete missions to unlock additional opportunities.<br><br><b>The Solar System awaits</b>!",size:{width:"400px",height:"auto"},anchorElement:"body",positionX:50,positionY:29,completion:{type:"INFO"},nextStepId:null,isSkippable:!1,buttonText:"Complete Tutorial",navLock:null}]}};var ke={START_YEAR:2140,START_DAY_OF_WEEK:1,DAYS_IN_MONTH:[31,28,31,30,31,30,31,31,30,31,30,31],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},et={NEUTRAL:{name:"Neutral System",duration:28,description:"Standard space-faring conditions. Markets are operating under normal parameters.",modifiers:{}}},u={CONFIG:{INTEL_COST_PERCENTAGE:.2,INTEL_MIN_CREDITS:5e3,INTEL_CHANCE:.3,INTEL_DEMAND_MOD:1.8,INTEL_DEPRESSION_MOD:.5},SYSTEM_STATES:et,DATE_CONFIG:ke,INTRO_SEQUENCE_V1:{modals:[{id:"lore_1",title:"Year 2140",description:'Humanity has expanded throughout the Solar System.<br><br> <span class="hl">Commerce</span> has thrived among the numerous colonies and stations longer than living memory.',buttonText:"Begin",contentClass:"text-center"},{id:"lore_2",title:"The Price of Freedom",description:"A dead-end job in the Belt pays the bills, but it does not offer the <b class='hl-green font-bold'>prosperity</b> that you dream of.<br><br>The <span class='hl'>Merchant's Guild</span> will fund your ambition, but their price is steep.<br><br>This is no simple loan; it's a bet on yourself and your future.",buttonText:"Apply for Loan",contentClass:"text-center",buttonClass:"btn-pulse-green"},{id:"charter",title:`<span class="hl">MERCHANT'S GUILD LOAN AGREEMENT</span>`,description:`
            <div class="font-roboto-mono text-left text-sm space-y-2">
                <p><span class="text-gray-400">CHARTER ID:</span> G7-K491-38B</p>
                <p><span class="text-gray-400">CREDIT AMOUNT:</span> <span class="credits-text-pulsing">\u232C 25,000</span></p>
                <p><span class="text-gray-400">INTEREST RATE:</span> 1.56% (Monthly)</p>
            </div>
            <div class="border-t border-slate-600 my-4"></div>
            <p class="text-sm text-gray-400 text-justify">Herein, the Applicant agrees to the terms of repayment and interest accrual, subject to the Interstellar Commerce Mandates of the Merchant's Guild. This binding digital agreement is logged on the system-wide ledger, whereupon it is considered immutable and enforceable system-wide. The principal of the debt is due in 1095 Terran-standard days, after which failure to remit payment shall authorize the automatic initiation of a garnishment sub-routine against the Applicant's credit.</p>
          `,buttonText:"Accept Terms",buttonClass:"btn-pulse-gold"},{id:"signature",title:"SIGN YOUR NAME",description:`
            <p class="text-sm text-gray-400 text-justify mb-4">I, the undersigned, do hereby accept the aforementioned terms and enter into this agreement with the Merchant's Guild. My signature, digitally rendered, shall serve as my legal mark.</p>
          `,buttonText:"Submit Application"},{id:"final",title:"Low On Credits!",description:"Interest on your debt grows every month. It's time to make some <b class='hl-yellow font-bold'>credits</b>. Let's view the <b>Mission Terminal</b> here on <b>Mars</b>!",buttonText:"View Missions"}]},LOCATION_VISUALS:{[v.EARTH]:"\u{1F30D}",[v.LUNA]:"\u{1F315}",[v.MARS]:"\u{1F534}",[v.VENUS]:"\u{1F7E1}",[v.BELT]:"\u{1FAA8}",[v.SATURN]:"\u{1FA90}",[v.JUPITER]:"\u{1F7E0}",[v.URANUS]:"\u{1F535}",[v.NEPTUNE]:"\u{1F7E3}",[v.PLUTO]:"\u{1FAA9}",[v.EXCHANGE]:"\u{1F3F4}\u200D\u2620\uFE0F",[v.KEPLER]:"\u{1F441}\uFE0F"},TRAVEL_VISUALS:{zones:{inner_sphere:{locations:[v.EARTH,v.LUNA,v.MARS,v.BELT],gradient:["#0f172a","#1e3a8a"]},outer_reaches:{locations:[v.JUPITER,v.SATURN,v.URANUS,v.NEPTUNE],gradient:["#0f172a","#312e81"]}},objects:{earth_to_mars:[{type:"planet",emoji:"\u{1F315}",position:{x:.5,y:.3},scale:.8,speed:.3}],belt_to_jupiter:[{type:"asteroid_field",count:15,speed:.2}]}},PERKS:{[M.TRADEMASTER]:{profitBonus:.05},[M.NAVIGATOR]:{fuelMod:.9,hullDecayMod:.9,travelTimeMod:.9},[M.VENETIAN_SYNDICATE]:{fuelDiscount:.25,repairDiscount:.25}},AGE_EVENTS:we,RANDOM_EVENTS:Re,SHIPS:{[L.WANDERER]:{name:"Wanderer",class:"C",price:25e3,maxHealth:100,cargoCapacity:20,maxFuel:100,saleLocationId:null,lore:"The All-Rounder. A reliable, if unspectacular, light freighter. Its balanced stats make it a good choice for new captains finding their niche."},[L.STALWART]:{name:"Stalwart",class:"C",price:25e3,maxHealth:150,cargoCapacity:45,maxFuel:80,saleLocationId:v.MARS,lore:"The Hauler. A workhorse of the inner worlds. Slow and cumbersome, but boasts an impressive cargo capacity for its price point."},[L.MULE]:{name:"Mule",class:"C",price:25e3,maxHealth:75,cargoCapacity:30,maxFuel:150,saleLocationId:v.BELT,lore:"The Explorer. What it lacks in cargo space, it makes up for with surprising efficiency and robust systems, allowing it to travel further and cheaper than other ships in its class."},[L.PATHFINDER]:{name:"Pathfinder",class:"B",price:18e4,maxHealth:120,cargoCapacity:40,maxFuel:150,saleLocationId:v.LUNA,lore:"Built for the long haul. Its extended fuel tanks and robust sensor suite make it ideal for reaching the outer edges of the system."},[L.NOMAD]:{name:"Nomad",class:"B",price:28e4,maxHealth:100,cargoCapacity:35,maxFuel:140,saleLocationId:v.URANUS,lore:"A vessel designed for self-sufficiency, featuring advanced life support and a small onboard workshop for emergency repairs."},[L.VINDICATOR]:{name:"Vindicator",class:"A",price:75e4,maxHealth:250,cargoCapacity:80,maxFuel:120,saleLocationId:v.NEPTUNE,lore:"A decommissioned military frigate. Fast, tough, and intimidating, with cargo space retrofitted where missile launchers used to be."},[L.AEGIS]:{name:"Aegis",class:"A",price:12e5,maxHealth:120,cargoCapacity:70,maxFuel:140,saleLocationId:v.EARTH,lore:"Built as a high-threat escort vessel, its hull is exceptionally dense. A flying fortress that can also haul a respectable amount of cargo."},[L.ODYSSEY]:{name:"Odyssey",class:"S",price:38e5,maxHealth:100,cargoCapacity:120,maxFuel:250,saleLocationId:v.SATURN,lore:"The pinnacle of personal transport. Gleaming chrome, whisper-quiet engines, and a cabin that smells of rich Corinthian leather."},[L.MAJESTIC]:{name:"Majestic",class:"S",price:72e5,maxHealth:200,cargoCapacity:160,maxFuel:250,saleLocationId:v.KEPLER,lore:"A flying palace favored by corporate magnates. Its speed, range, and capacity make it one of the most versatile ships money can buy."},[L.TITAN_HAULER]:{name:"Titan Hauler",class:"S",price:18e5,maxHealth:175,cargoCapacity:300,maxFuel:75,saleLocationId:v.URANUS,isRare:!0,lore:"A relic of a failed colonization effort, this ship is almost entirely a cargo container with an engine strapped to it."},[L.VOID_CHASER]:{name:"Void Chaser",class:"S",price:31e5,maxHealth:50,cargoCapacity:90,maxFuel:400,saleLocationId:v.BELT,isRare:!0,lore:"A heavily modified smuggling vessel. Its paper-thin hull is a small price to pay for its legendary engine and long-range fuel cells."},[L.GUARDIAN]:{name:"Guardian",class:"S",price:15e5,maxHealth:400,cargoCapacity:75,maxFuel:150,saleLocationId:v.EARTH,isRare:!0,lore:"An experimental military prototype with redundant hull plating, designed to withstand extreme punishment."},[L.STARGAZER]:{name:"Stargazer",class:"S",price:95e4,maxHealth:100,cargoCapacity:60,maxFuel:350,saleLocationId:v.JUPITER,isRare:!0,lore:"A deep-space exploration vessel with colossal fuel reserves, intended for journeys far beyond the known systems."},[L.BEHEMOTH]:{name:"Behemoth",class:"O",price:32e6,maxHealth:600,cargoCapacity:500,maxFuel:600,saleLocationId:v.EXCHANGE,isRare:!0,lore:"An orbital-class freighter that dwarfs even the largest stations. It is a legend among traders, rumored to be a mobile black market in its own right."}},COMMODITIES:[{id:E.WATER_ICE,name:"Water Ice",tier:1,basePriceRange:[15,80],volatility:.01,canonicalAvailability:[80,150],styleClass:"item-style-1",lore:"Crude, unrefined water ice scraped from asteroids; a universal necessity.",cat:"RAW",symbol:"H2O"},{id:E.PLASTEEL,name:"Plasteel",tier:1,basePriceRange:[100,280],volatility:.015,canonicalAvailability:[80,150],styleClass:"item-style-2",lore:"A basic, versatile polymer for 3D printing and simple manufacturing.",cat:"IND",symbol:"PLST"},{id:E.HYDROPONICS,name:"Hydroponics",tier:2,licenseId:"t2_license",basePriceRange:[850,2400],volatility:.025,canonicalAvailability:[40,70],styleClass:"item-style-3",lore:"Packaged agricultural systems and produce essential for feeding isolated colonies.",cat:"AGRI",symbol:"HYD"},{id:E.CYBERNETICS,name:"Cybernetics",tier:2,licenseId:"t2_license",basePriceRange:[1200,3800],volatility:.03,canonicalAvailability:[40,70],styleClass:"item-style-4",lore:"Mass-produced enhancement limbs and organs for the industrial workforce.",cat:"TECH",symbol:"CYB"},{id:E.PROPELLANT,name:"Refined Propellant",tier:3,licenseId:"t3_license",basePriceRange:[14e3,38e3],volatility:.035,canonicalAvailability:[25,50],styleClass:"item-style-5",lore:"High-efficiency fuel that powers all modern ship drives.",cat:"IND",symbol:"PROP"},{id:E.PROCESSORS,name:"Neural Processors",tier:3,licenseId:"t3_license",basePriceRange:[18e3,52e3],volatility:.045,canonicalAvailability:[25,50],styleClass:"item-style-6",lore:"The silicon brains behind complex ship systems and station logistics.",cat:"TECH",symbol:"NPRO"},{id:E.GMO_SEEDS,name:"GMO Seed Cultures",tier:4,licenseId:"t4_license",basePriceRange:[19e4,55e4],volatility:.06,canonicalAvailability:[15,30],styleClass:"item-style-7",lore:"Patented seeds holding the key to unlocking agricultural wealth on new worlds.",cat:"AGRI",symbol:"GMO"},{id:E.CRYO_PODS,name:"Cryo-Sleep Pods",tier:4,licenseId:"t4_license",basePriceRange:[25e4,75e4],volatility:.075,canonicalAvailability:[15,30],styleClass:"item-style-8",lore:"Essential for long-haul passenger transport and colonization efforts.",cat:"CIV",symbol:"CRYO"},{id:E.ATMO_PROCESSORS,name:"Atmo Processors",tier:5,licenseId:"t5_license",basePriceRange:[28e5,85e5],volatility:.08,canonicalAvailability:[10,20],styleClass:"item-style-9",lore:"Gargantuan machines that begin the centuries-long process of making a world breathable.",cat:"IND",symbol:"ATMO"},{id:E.CLONED_ORGANS,name:"Cloned Organs",tier:5,licenseId:"t5_license",basePriceRange:[35e5,11e6],volatility:.09,canonicalAvailability:[10,20],styleClass:"item-style-10",lore:"Lab-grown replacements with high demand in wealthy core worlds; morally grey.",cat:"BIO",symbol:"CLON"},{id:E.XENO_GEOLOGICALS,name:"Xeno-Geologicals",tier:6,licenseId:"t6_license",basePriceRange:[24e6,7e7],volatility:.1,canonicalAvailability:[2,10],styleClass:"item-style-11",lore:"Rare, non-terrestrial minerals with bizarre physical properties; a scientific treasure.",cat:"RAW",symbol:"XENO"},{id:E.SENTIENT_AI,name:"Sentient AI Cores",tier:6,licenseId:"t6_license",basePriceRange:[32e6,95e6],volatility:.125,canonicalAvailability:[2,10],styleClass:"item-style-12",lore:'The "brains" of capital ships whose emergent consciousness is a subject of intense, and often classified, philosophical debate.',cat:"TECH",symbol:"AI"},{id:E.ANTIMATTER,name:"Antimatter",tier:7,licenseId:"t7_license",basePriceRange:[28e7,8e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-13",lore:"The only safe way to transport the most volatile and powerful substance known to science.",cat:"RARE",symbol:"AM"},{id:E.FOLDED_DRIVES,name:"Folded-Space Drives",tier:7,licenseId:"t7_license",basePriceRange:[35e7,11e8],volatility:.15,canonicalAvailability:[2,10],styleClass:"item-style-14",lore:"The pinnacle of travel tech, allowing a vessel to pierce spacetime for near-instantaneous jumps.",cat:"RARE",symbol:"FSD"}],LICENSES:{t2_license:{type:"purchase",name:"Tier 2 Trade License",description:"Grants access to trade Tier 2 commodities like Hydroponics and Cybernetics.",cost:25e3},t3_license:{type:"mission",name:"Tier 3 Trade License",description:"Grants access to trade Tier 3 commodities.",missionId:"mission_license_t3",guidanceText:"Access to this tier is granted by the Merchant's Guild upon completion of a key contract."},t4_license:{type:"purchase",name:"Tier 4 Trade License",description:"Grants access to trade Tier 4 commodities.",cost:4e6},t5_license:{type:"mission",name:"Tier 5 Trade License",description:"Grants access to trade Tier 5 commodities.",missionId:"mission_license_t5",guidanceText:"Prove your industrial might by completing a grand contract for a planetary governor."},t6_license:{type:"purchase",name:"Tier 6 Trade License",description:"Grants access to trade the rarest and most exotic technologies.",cost:3e8},t7_license:{type:"mission",name:"Tier 7 Trade License",description:"The ultimate license, granting the right to trade reality-bending technologies.",missionId:"mission_license_t7",guidanceText:"Only a true legend of the trade routes can earn this privilege."}},MARKETS:[{id:v.VENUS,name:"Venus",distance:97,launchFlavor:"Floating cities hide scientific marvels and secrets.",navTheme:{gradient:"linear-gradient(to bottom right, #854d0e, #0f172a)",textColor:"#fde047",borderColor:"#facc15"},description:"A scientific enclave hungry for research data and processors.",color:"border-yellow-400",bg:"bg-gradient-to-br from-yellow-800 to-slate-900",fuelPrice:400,arrivalLore:"Floating cities drift through the thick, acidic clouds, their lights a lonely defiance to the crushing pressure below.",specialty:"Exclusive access to the Venetian Syndicate for high-risk, high-reward intel and missions.",availabilityModifier:{[E.CLONED_ORGANS]:2,[E.PROCESSORS]:2,[E.GMO_SEEDS]:.5,[E.SENTIENT_AI]:.5}},{id:v.EARTH,name:"Earth",distance:180,launchFlavor:"The bustling heart of the Sol system.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #0f172a)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"The hub of power and wealth. High demand for tech and bio-enhancements.",color:"border-cyan-500",bg:"bg-gradient-to-br from-blue-900 to-slate-900",fuelPrice:250,arrivalLore:"The cradle of humanity buzzes with endless traffic; a beacon of blue and green against the void.",specialty:"Offers the best sell prices for rare, high-tier goods and is the exclusive source for top-tier ship licenses.",availabilityModifier:{[E.HYDROPONICS]:2,[E.GMO_SEEDS]:2,[E.CLONED_ORGANS]:.5,[E.XENO_GEOLOGICALS]:.5}},{id:v.LUNA,name:"The Moon",parent:"loc_earth",distance:15,launchFlavor:"An industrial powerhouse built on grey dust.",navTheme:{gradient:"linear-gradient(to bottom right, #374151, #0f172a)",textColor:"#e5e7eb",borderColor:"#9ca3af"},description:"An industrial proving ground. Exports propellant and basic materials.",color:"border-gray-400",bg:"bg-gradient-to-br from-gray-700 to-slate-900",fuelPrice:350,arrivalLore:"Dusty plains are scarred by mining operations under the harsh, silent watch of distant Earth.",specialty:"Offers a slight discount on all ship repairs.",availabilityModifier:{[E.PLASTEEL]:2,[E.PROPELLANT]:2,[E.WATER_ICE]:.5,[E.HYDROPONICS]:.5}},{id:v.MARS,name:"Mars",distance:226,launchFlavor:"The red frontier, ripe with opportunity.",navTheme:{gradient:"linear-gradient(to bottom right, #7c2d12, #0f172a)",textColor:"#fca5a5",borderColor:"#f87171"},description:"A growing colony. Needs processors and materials for expansion.",color:"border-orange-600",bg:"bg-gradient-to-br from-orange-900 to-slate-900",fuelPrice:450,arrivalLore:"The thin, reddish atmosphere whips across terraforming arrays and fledgling biodomes.",specialty:"Offers a higher-than-average number of colonial supply missions.",availabilityModifier:{[E.PLASTEEL]:2,[E.HYDROPONICS]:.5,[E.CRYO_PODS]:.5,[E.WATER_ICE]:.5}},{id:v.BELT,name:"The Belt",distance:292,launchFlavor:"A lawless expanse of rock and riches.",navTheme:{gradient:"linear-gradient(to bottom right, #292524, #0f172a)",textColor:"#ca8a04",borderColor:"#a16207"},description:"A lawless frontier. Rich in raw minerals and water ice.",color:"border-amber-700",bg:"bg-gradient-to-br from-stone-800 to-slate-900",fuelPrice:600,arrivalLore:"Countless rocks tumble in a silent, chaotic dance, hiding both immense wealth and sudden peril.",specialty:"Increased chance to find rare derelict ships in its shipyards.",availabilityModifier:{[E.WATER_ICE]:2,[E.XENO_GEOLOGICALS]:2,[E.HYDROPONICS]:.5,[E.CYBERNETICS]:.5}},{id:v.EXCHANGE,name:"The Exchange",distance:309,launchFlavor:"The notorious black market of the outer belt.",navTheme:{gradient:"linear-gradient(to bottom right, #581c87, #000000, #0f172a)",textColor:"#e9d5ff",borderColor:"#c084fc"},description:"A legendary black market station hidden deep within the Kuiper Belt. High stakes, high rewards.",color:"border-purple-500",bg:"bg-gradient-to-br from-purple-900 via-black to-slate-900",fuelPrice:1200,arrivalLore:"A hollowed-out asteroid, bristling with rogue drones and comms jammers. This is the fabled Exchange, where fortunes are made or lost in an instant.",specialty:"The notorious black market of the outer belt.",availabilityModifier:{}},{id:v.JUPITER,name:"Jupiter",distance:443,launchFlavor:"Vast refineries harvest fuel from the giant.",navTheme:{gradient:"linear-gradient(to bottom right, #9a3412, #1c1917)",textColor:"#fed7aa",borderColor:"#fb923c"},description:"A gas giant teeming with orbital refineries. The primary source of propellant for the outer system.",color:"border-orange-400",bg:"bg-gradient-to-br from-orange-800 to-stone-900",fuelPrice:150,arrivalLore:"The colossal sphere of Jupiter dominates the viewport, its Great Red Spot a baleful eye. Automated refineries drift in its upper atmosphere.",specialty:"Fuel is sold at 50% of the galactic average price, making it an essential stop for any long-haul journey.",availabilityModifier:{[E.PROPELLANT]:2,[E.ATMO_PROCESSORS]:2,[E.PROCESSORS]:.5}},{id:v.SATURN,name:"Saturn",distance:618,launchFlavor:"Opulent stations drift among majestic rings.",navTheme:{gradient:"linear-gradient(to bottom right, #713f12, #312e81, #0f172a)",textColor:"#fef08a",borderColor:"#fde047"},description:"A tourism hub. Demands luxury goods and bio-wares.",color:"border-yellow-200",bg:"bg-gradient-to-br from-yellow-900 via-indigo-900 to-slate-900",fuelPrice:550,arrivalLore:"The majestic rings cast long shadows over opulent tourist stations and icy harvesting rigs.",specialty:"Offers the highest sell prices for luxury and bio-tech goods.",availabilityModifier:{[E.CRYO_PODS]:.5,[E.CLONED_ORGANS]:.5}},{id:v.URANUS,name:"Uranus",distance:775,launchFlavor:"A silent, ice-cold world of strange science.",navTheme:{gradient:"linear-gradient(to bottom right, #155e75, #312e81)",textColor:"#a5f3fc",borderColor:"#67e8f9"},description:"A cold, distant world where scientists study bizarre quantum phenomena and strange geologicals.",color:"border-cyan-200",bg:"bg-gradient-to-br from-cyan-800 to-indigo-900",fuelPrice:700,arrivalLore:"The pale, featureless orb of Uranus hangs tilted in the sky. Research outposts glitter like ice crystals in the eternal twilight.",specialty:'A unique R&D service to temporarily "overclock" ship components.',availabilityModifier:{[E.ATMO_PROCESSORS]:2,[E.SENTIENT_AI]:.5,[E.PROCESSORS]:.5}},{id:v.NEPTUNE,name:"Neptune",distance:877,launchFlavor:"The stormy edge of military-controlled space.",navTheme:{gradient:"linear-gradient(to bottom right, #1e3a8a, #000000)",textColor:"#93c5fd",borderColor:"#60a5fa"},description:"A dark, stormy world, home to secretive military bases and shipyards.",color:"border-blue-400",bg:"bg-gradient-to-br from-blue-900 to-black",fuelPrice:650,arrivalLore:"Supersonic winds howl across Neptune's deep blue clouds. Heavily armed patrol ships escort you to the shielded orbital station.",specialty:"A military surplus shipyard that occasionally sells damaged, high-tier frigates.",availabilityModifier:{[E.PLASTEEL]:.1,[E.PROPELLANT]:.5}},{id:v.KEPLER,name:"Kepler's Eye",distance:903,launchFlavor:"A colossal lens staring into the infinite void.",navTheme:{gradient:"linear-gradient(to bottom right, #701a75, #0f172a)",textColor:"#f472b6",borderColor:"#ec4899"},description:"A massive deep-space observatory that consumes vast amounts of processing power.",color:"border-fuchsia-500",bg:"bg-gradient-to-br from-fuchsia-900 to-slate-900",fuelPrice:800,arrivalLore:"The station is a single, enormous lens staring into the abyss, surrounded by a delicate lattice of sensors and habitation rings.",specialty:"A colossal lens staring into the infinite void.",availabilityModifier:{}},{id:v.PLUTO,name:"Pluto",distance:1080,launchFlavor:"A haven for outcasts at the system's fringe.",navTheme:{gradient:"linear-gradient(to bottom right, #312e81, #0f172a)",textColor:"#c4b5fd",borderColor:"#a78bfa"},description:"The furthest outpost, a haven for outcasts and smugglers dealing in forbidden tech.",color:"border-indigo-400",bg:"bg-gradient-to-br from-indigo-900 to-slate-900",fuelPrice:900,arrivalLore:"Pluto's tiny, frozen heart is a whisper in the dark. The only light comes from a ramshackle station carved into a nitrogen-ice mountain.",specialty:"A haven for outcasts at the system's fringe.",availabilityModifier:{water_ice:2,hydroponics:.5,cybernetics:.5,cloned_organs:.5,xeno_geologicals:2}}],MISSIONS:Ne,TUTORIAL_DATA:Oe};var tt={"item-style-1":{hex:"#60a5fa",gradient:"linear-gradient(45deg, #3b82f6, #1e3a8a)"},"item-style-2":{hex:"#a3a3a3",gradient:"linear-gradient(45deg, #737373, #262626)"},"item-style-3":{hex:"#22c55e",gradient:"linear-gradient(45deg, #16a34a, #14532d)"},"item-style-4":{hex:"#e5e5e5",gradient:"linear-gradient(45deg, #d4d4d4, #737373)"},"item-style-5":{hex:"#c084fc",gradient:"linear-gradient(45deg, #a855f7, #6b21a8)"},"item-style-6":{hex:"#93c5fd",gradient:"linear-gradient(45deg, #60a5fa, #2563eb)"},"item-style-7":{hex:"#84cc16",gradient:"linear-gradient(45deg, #a3e635, #4d7c0f)"},"item-style-8":{hex:"#67e8f9",gradient:"linear-gradient(45deg, #22d3ee, #0891b2)"},"item-style-9":{hex:"#fcd34d",gradient:"linear-gradient(45deg, #facc15, #b45309)"},"item-style-10":{hex:"#fb7185",gradient:"linear-gradient(45deg, #f43f5e, #9f1239)"},"item-style-11":{hex:"#a78bfa",gradient:"linear-gradient(165deg, #a78bfa, #312e81, #1e3a8a)"},"item-style-12":{hex:"#f87171",gradient:"linear-gradient(45deg, #ef4444, #7f1d1d)"},"item-style-13":{hex:"#d8b4fe",gradient:"linear-gradient(45deg, #a855f7, #3b0764)"},"item-style-14":{hex:"#f472b6",gradient:"linear-gradient(45deg, #ec4899, #831843)"}};function V(d){return tt[d]||{hex:"#a8a29e",gradient:"linear-gradient(45deg, #52525b, #18181b)"}}function y(d,e=!0){let t=d<0,i=Math.abs(Math.floor(d)),a=e?"\u232C ":"",s=t?"-":"",o;return i>=1e12?o=`${(i/1e12).toFixed(2)}T`:i>=1e9?o=`${(i/1e9).toFixed(2)}B`:i>=1e6?o=`${(i/1e6).toFixed(2)}M`:i>=1e3?o=`${(i/1e3).toFixed(1)}k`:o=i.toLocaleString(),`${a}${s}${o}`}function P(d){return d?Object.values(d).reduce((e,t)=>e+t.quantity,0):0}function q(d,e){let t=(Math.random()+Math.random()+Math.random())/3;return Math.floor(d+(e-d)*Math.pow(t,.5))}function W({price:d,sellPrice:e,galacticAvg:t,playerItem:i}){let a=d-t,s=t>0?Math.round(a/t*100):0,o=s>=0?"+":"",r="neutral";s>5&&(r="positive"),s<-5&&(r="negative");let n=s>5?"\u25B2":s<-5?"\u25BC":"\u25CF",l=`<div class="indicator-pill ${r}">${n} MKT: ${o}${s}%</div>`,c="";if(i&&i.avgCost>0){let h=e-i.avgCost;if(Math.abs(h)>.01){let m=i.avgCost>0?Math.round(h/i.avgCost*100):0,p=m>=0?"+":"",g=h>=0?"positive":"negative",S=h>=0?"\u25B2":"\u25BC";c=`<div class="indicator-pill ${g}"> P/L: ${p}${m}%</div>`}}return`${l}${c}`}function it(d){let e={};return d.forEach(a=>{e[a.id]={},d.forEach(s=>{if(a.id===s.id)return;let o=a.parent?d.find(p=>p.id===a.parent)?.distance||0:a.distance,r=s.parent?d.find(p=>p.id===s.parent)?.distance||0:s.distance,n=Math.abs(r-o),l=a.parent||s.parent?15:0,c=n+l,h=1+Math.pow(c,1.15)*.1,m=2+c*.45;(a.id===v.EARTH&&s.id===v.LUNA||a.id===v.LUNA&&s.id===v.EARTH)&&(h=2+Math.floor(Math.random()*2),m=5+Math.floor(Math.random()*2)),e[a.id][s.id]={time:Math.max(1,Math.round(h)),fuelCost:Math.max(1,Math.round(m))}})}),e}var Q=class{constructor(){this.state={},this.subscribers=[],this.TRAVEL_DATA=it(u.MARKETS)}subscribe(e){this.subscribers.push(e)}_notify(){this.subscribers.forEach(e=>e(this))}setState(e){Object.assign(this,e),this._notify()}getState(){return JSON.parse(JSON.stringify(this))}saveGame(){}loadGame(){return!1}startNewGame(e){let t={day:1,lastInterestChargeDay:1,lastMarketUpdateDay:1,currentLocationId:v.MARS,activeNav:N.SHIP,activeScreen:A.NAVIGATION,isGameOver:!1,subNavCollapsed:!1,introSequenceActive:!0,lastActiveScreen:{[N.SHIP]:A.MAP,[N.STARPORT]:A.MARKET,[N.DATA]:A.MISSIONS},pendingTravel:null,player:{name:e,playerTitle:"Captain",playerAge:24,lastBirthdayYear:u.DATE_CONFIG.START_YEAR,birthdayProfitBonus:0,introStep:0,credits:3e3,debt:0,monthlyInterestAmount:0,loanStartDate:null,seenGarnishmentWarning:!1,revealedTier:1,unlockedLicenseIds:[],unlockedLocationIds:u.MARKETS.map(i=>i.id).filter(i=>i!==v.EXCHANGE&&i!==v.KEPLER),seenCommodityMilestones:[],financeLog:[],activePerks:{},seenEvents:[],activeShipId:L.WANDERER,ownedShipIds:[L.WANDERER],shipStates:{[L.WANDERER]:{health:u.SHIPS[L.WANDERER].maxHealth,fuel:u.SHIPS[L.WANDERER].maxFuel,hullAlerts:{one:!1,two:!1}}},inventories:{},debugEventIndex:0},market:{prices:{},inventory:{},galacticAverages:{},priceHistory:{},shipyardStock:{}},intelMarket:{},activeIntelDeal:null,tutorials:{activeBatchId:null,activeStepId:null,seenBatchIds:[],skippedTutorialBatches:[],navLock:null},missions:{activeMissionId:null,completedMissionIds:[],missionProgress:{},activeMissionObjectivesMet:!1},uiState:{marketCardMinimized:{},hangarShipyardToggleState:"shipyard",hangarActiveIndex:0,shipyardActiveIndex:0,activeIntelTab:"codex"}};t.player.inventories[L.WANDERER]={},u.COMMODITIES.forEach(i=>{t.player.inventories[L.WANDERER][i.id]={quantity:0,avgCost:0}}),t.intelMarket={},u.MARKETS.forEach(i=>{t.market.priceHistory[i.id]={},t.intelMarket[i.id]=[],t.market.inventory[i.id]={},t.market.shipyardStock[i.id]={day:0,shipsForSale:[]},u.COMMODITIES.forEach(a=>{t.market.priceHistory[i.id][a.id]=[];let[s,o]=a.canonicalAvailability,r=i.availabilityModifier?.[a.id]??1,n=Math.floor(q(s,o)*r);i.specialDemand&&i.specialDemand[a.id]&&(n=0),t.market.inventory[i.id][a.id]={quantity:Math.max(0,n),marketPressure:0,lastPlayerInteractionTimestamp:0,priceLockEndDay:0,hoverUntilDay:0,rivalArbitrage:{isActive:!1,endDay:0},isDepleted:!1,depletionDay:0,depletionBonusDay:0}})}),Object.assign(this,t),this._calculateGalacticAverages(),this._seedInitialMarketPrices(),this.setState({})}_calculateGalacticAverages(){this.market.galacticAverages={},u.COMMODITIES.forEach(e=>{this.market.galacticAverages[e.id]=(e.basePriceRange[0]+e.basePriceRange[1])/2})}_seedInitialMarketPrices(){u.MARKETS.forEach(e=>{this.market.prices[e.id]={},u.COMMODITIES.forEach(t=>{let i=this.market.galacticAverages[t.id]*(1+(Math.random()-.5)*.15);this.market.prices[e.id][t.id]=Math.max(1,Math.round(i))})})}};var J=class{constructor(e){this.gameState=e,this._currentSystemState=null,this._systemStateExpirationDay=0}getPrice(e,t){let i=this.gameState.getState().activeIntelDeal;return i&&i.locationId===e&&i.commodityId===t?i.overridePrice:this.gameState.market.prices[e]?.[t]||0}getGalacticAverage(e){return this.gameState.market.galacticAverages[e]||0}checkForSystemStateChange(){if(this.gameState.day>this._systemStateExpirationDay){let e=Object.keys(u.SYSTEM_STATES),t=e[Math.floor(Math.random()*e.length)];this._currentSystemState=u.SYSTEM_STATES[t],this._systemStateExpirationDay=this.gameState.day+this._currentSystemState.duration}}evolveMarketPrices(){u.MARKETS.forEach(e=>{u.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id],a=this.gameState.market.prices[e.id][t.id],s=this.gameState.market.galacticAverages[t.id],r=(1-(e.availabilityModifier?.[t.id]??1))*s,n=s+r*C.LOCAL_PRICE_MOD_STRENGTH,l=C.DAILY_PRICE_VOLATILITY,c=C.MEAN_REVERSION_STRENGTH,h=this._currentSystemState?.modifiers?.commodity?.[t.id];h&&(h.volatility_mult&&(l*=h.volatility_mult),h.mean_reversion_mult&&(c*=h.mean_reversion_mult));let m=t.basePriceRange[1]-t.basePriceRange[0],p=(Math.random()-.5)*m*l,g=(n-a)*c;this.gameState.day<i.priceLockEndDay&&(g=0),i.rivalArbitrage.isActive&&this.gameState.day<i.rivalArbitrage.endDay?g=(n-a)*.2:i.rivalArbitrage.isActive&&(i.rivalArbitrage.isActive=!1),i.hoverUntilDay>this.gameState.day?g*=.1:i.hoverUntilDay>0&&(i.hoverUntilDay=0);let S=0;this.gameState.day>=i.lastPlayerInteractionTimestamp+7&&i.lastPlayerInteractionTimestamp>0&&(S=n*i.marketPressure*-1*.5);let T=1;i.isDepleted&&this.gameState.day<i.depletionDay+7&&(T=1.5);let _=a+p+g+S*T;this._currentSystemState?.modifiers?.commodity?.[t.id]?.price&&(_*=this._currentSystemState.modifiers.commodity[t.id].price),this.gameState.market.prices[e.id][t.id]=Math.max(1,Math.round(_)),i.marketPressure*=C.MARKET_PRESSURE_DECAY,Math.abs(i.marketPressure)<.001&&(i.marketPressure=0)}),this._recordPriceHistory(e.id)})}replenishMarketInventory(){u.MARKETS.forEach(e=>{u.COMMODITIES.forEach(t=>{if(t.tier>this.gameState.player.revealedTier)return;let i=this.gameState.market.inventory[e.id][t.id];if(i.lastPlayerInteractionTimestamp>0&&this.gameState.day-i.lastPlayerInteractionTimestamp>120)i.quantity=this._calculateBaselineStock(e,t),i.lastPlayerInteractionTimestamp=0,i.marketPressure=0,i.depletionDay=0,i.priceLockEndDay=0;else{let[r,n]=t.canonicalAvailability,l=(r+n)/2*(e.availabilityModifier?.[t.id]??1),c=i.marketPressure;c<0&&this.gameState.day<i.lastPlayerInteractionTimestamp+7&&(c=0),c>0&&(c=0);let h=1-Math.min(.5,c*.5),g=(l*h-i.quantity)*.1,S=0;i.isDepleted?(S=q(1,5),i.isDepleted=!1):i.quantity<=0&&(S=q(1,5)),i.quantity+=g+S}let a=Math.random()*.15+.15,s=Math.random()<.5?-1:1,o=1+a*s;i.quantity*=o,this._currentSystemState?.modifiers?.commodity?.[t.id]?.availability&&(i.quantity*=this._currentSystemState.modifiers.commodity[t.id].availability),i.quantity=Math.max(0,Math.round(i.quantity))})})}applyMarketImpact(e,t,i){let a=u.COMMODITIES.find(h=>h.id===e),s=this.gameState.market.inventory[this.gameState.currentLocationId][e],o=t/(a.canonicalAvailability[1]||100)*a.tier/10;i==="buy"?s.marketPressure-=o:s.marketPressure+=o;let r=(this.gameState.day-1)%365+1,n,l;r<=182?(n=75,l=120):(n=105,l=195);let c=Math.floor(Math.random()*(l-n+1))+n;s.priceLockEndDay=this.gameState.day+c,s.lastPlayerInteractionTimestamp=this.gameState.day}_calculateBaselineStock(e,t){let[i,a]=t.canonicalAvailability,s=e.availabilityModifier?.[t.id]??1;return Math.floor(q(i,a)*s)}_recordPriceHistory(e=null){if(!this.gameState||!this.gameState.market)return;let t=e||this.gameState.currentLocationId;this.gameState.market.priceHistory[t]||(this.gameState.market.priceHistory[t]={}),u.COMMODITIES.forEach(i=>{if(i.tier>this.gameState.player.revealedTier)return;this.gameState.market.priceHistory[t][i.id]||(this.gameState.market.priceHistory[t][i.id]=[]);let a=this.gameState.market.priceHistory[t][i.id],s=this.gameState.market.prices[t][i.id],o=a[a.length-1];for(o&&o.day===this.gameState.day?o.price!==s&&(o.price=s):a.push({day:this.gameState.day,price:s});a.length>C.PRICE_HISTORY_LENGTH;)a.shift()})}_updateShipyardStock(){let{player:e}=this.gameState;e.unlockedLocationIds.forEach(t=>{let i=this.gameState.market.shipyardStock[t];if(i&&i.day===this.gameState.day)return;let a=Object.entries(u.SHIPS).filter(([r,n])=>!n.isRare&&n.saleLocationId===t&&!e.ownedShipIds.includes(r)),s=Object.entries(u.SHIPS).filter(([r,n])=>n.isRare&&n.saleLocationId===t&&!e.ownedShipIds.includes(r)),o=[...a.map(r=>r[0])];s.forEach(([r,n])=>{Math.random()<C.RARE_SHIP_CHANCE&&o.push(r)}),this.gameState.market.shipyardStock[t]={day:this.gameState.day,shipsForSale:o}})}};var Z=class{constructor(e,t,i,a){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=a}start(){this.gameState.introSequenceActive&&(this.logger.info.state(this.gameState.day,"INTRO_START","Starting new game introduction sequence."),this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.gameState.player.introStep=0,this._showNextModal())}handleIntroClick(e){let t=e.target.closest("button");if(!t)return;let i=t.id;if(i==="intro-next-btn")t.disabled=!0,this._showNextModal();else if(i==="intro-submit-btn"){t.disabled=!0;let o=document.getElementById("signature-input").value.trim().replace(/[^a-zA-Z0-9 ]/g,"");!o||o.length===0?this.uiManager.queueModal("event-modal","Invalid Signature","The Merchant's Guild requires a valid name on the contract. Please provide your legal mark.",()=>{this.gameState.player.introStep--,this._showNextModal()}):(this.gameState.player.name=o,this.gameState.player.debt=25e3,this.gameState.player.loanStartDate=this.gameState.day,this.gameState.player.monthlyInterestAmount=390,this.logger.info.state(this.gameState.day,"LOAN_ACCEPTED",`Player ${o} accepted Guild loan.`,{debt:25e3,name:o}),this._startProcessingSequence())}}continueAfterTutorial(e){e==="intro_hangar"?(this.simulationService.setScreen(N.DATA,A.FINANCE),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_FINANCE"})):e==="intro_finance"&&this._end()}_showNextModal(){let e=u.INTRO_SEQUENCE_V1.modals[this.gameState.player.introStep];if(!e){this._end();return}let t={buttonClass:e.buttonClass,contentClass:e.contentClass};this.gameState.player.introStep===0&&(t.specialClass="intro-fade-in");let i="event-modal";e.id==="charter"||e.id==="signature"?(i=`${e.id}-modal`,t.customSetup=(a,s)=>{this._setupInteractiveModal(a,e,s)}):t.customSetup=(a,s)=>{let o=a.querySelector("#event-button-container");if(!o)return;o.innerHTML="";let r=document.createElement("button");r.className="btn px-6 py-2",e.buttonClass&&r.classList.add(e.buttonClass),r.id="intro-next-btn",r.innerHTML=e.buttonText,r.onclick=n=>{n.target.disabled=!0,s()},o.appendChild(r)},this.uiManager.queueModal(i,e.title,e.description,()=>this.gameState.player.introStep++,t)}_setupInteractiveModal(e,t,i){let a=e.querySelector(`#${t.id}-button-container`);a.innerHTML="";let s=document.createElement("button");if(s.className="btn px-6 py-2",s.innerHTML=t.buttonText,s.onclick=o=>{o.target.disabled=!0,i()},a.appendChild(s),t.id==="signature"){let o=e.querySelector("#signature-input");o.value="",s.id="intro-submit-btn",s.disabled=!0,s.onclick=i,o.oninput=()=>{s.disabled=o.value.trim()===""}}else s.id="intro-next-btn"}_startProcessingSequence(){let e=()=>{let t="Loan Approved",i=`Dear ${this.gameState.player.name},<br><br>Your line of credit has been <b>approved</b>.<br><br><span class="credits-text-pulsing">\u232C 25,000</span> is ready to transfer to your account.`,a=s=>{let o=s.target;o&&(o.disabled=!0),this.uiManager.createFloatingText(`+${y(25e3,!1)}`,s.clientX,s.clientY,"#34d399"),this.gameState.player.credits+=25e3,this.logger.info.player(this.gameState.day,"CREDITS_TRANSFER","Accepted loan transfer of \u232C25,000"),setTimeout(()=>{this.uiManager.showGameContainer(),this.uiManager.render(this.gameState.getState()),this.simulationService.setScreen(N.STARPORT,A.HANGAR),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_HANGAR"})},2e3)};this.uiManager.queueModal("event-modal",t,i,null,{contentClass:"text-center",customSetup:(s,o)=>{s.querySelector(".modal-content").classList.add("modal-theme-admin");let r=s.querySelector("#event-button-container");r.innerHTML="";let n=document.createElement("button");n.className="btn px-6 py-2",n.innerHTML="Accept Transfer",n.onclick=l=>{a(l),o()},r.appendChild(n)}})};this.uiManager.showProcessingAnimation(this.gameState.player.name,e)}_end(){this.gameState.introSequenceActive=!1,this.logger.info.state(this.gameState.day,"INTRO_END","Introduction sequence complete.");let e=u.INTRO_SEQUENCE_V1.modals.find(a=>a.id==="final"),t=u.SHIPS[this.gameState.player.activeShipId].name,i=e.buttonText.replace("{shipName}",t);this.gameState.tutorials.navLock={navId:N.DATA,screenId:A.FINANCE},this.uiManager.queueModal("event-modal",e.title,e.description,()=>{this.simulationService.setScreen(N.DATA,A.MISSIONS),this.simulationService.tutorialService.checkState({type:"ACTION",action:"INTRO_START_MISSIONS"})},{buttonText:i}),this.uiManager.render(this.gameState.getState())}};var ee=class{constructor(e,t,i,a,s,o,r){this.gameState=e,this.uiManager=t,this.missionService=i,this.marketService=a,this.timeService=s,this.logger=o,this.simulationService=r,this.isTransactionInProgress=!1}buyItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return!1;let a=u.COMMODITIES.find(p=>p.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),!1;let o=this.uiManager.getItemPrice(i,e)*t,r=i.market.inventory[i.currentLocationId][e].quantity;if(r<=0)return this.uiManager.queueModal("event-modal","Sold Out",`This station has no more ${a.name} available.`),!1;if(t>r)return this.uiManager.queueModal("event-modal","Limited Stock",`This station only has ${r} units available.`),!1;let n=this.simulationService._getActiveShip(),l=this.simulationService._getActiveInventory();if(P(l)+t>n.cargoCapacity)return this.uiManager.queueModal("event-modal","Cargo Hold Full","You don't have enough space."),!1;if(i.player.credits<o)return this.uiManager.queueModal("event-modal","Insufficient Funds","Your credit balance is too low."),!1;let c=this.gameState.market.inventory[i.currentLocationId][e],h=c.quantity;if(c.quantity-=t,c.quantity<=0){let p=u.MARKETS.find(w=>w.id===i.currentLocationId),[g,S]=a.canonicalAvailability,f=p.availabilityModifier?.[e]??1,T=(g+S)/2*f,_=c.marketPressure;_>0&&(_=0);let x=1-Math.min(.5,_*.5),R=Math.max(1,T*x)*.08;h>=R&&i.day>c.depletionBonusDay+365&&(c.isDepleted=!0,c.depletionDay=i.day,c.depletionBonusDay=i.day)}let m=l[e];return m.avgCost=(m.quantity*m.avgCost+o)/(m.quantity+t),m.quantity+=t,this.gameState.player.credits-=o,this.logger.info.player(i.day,"BUY",`Bought ${t}x ${a.name} for ${y(o)}`),this.simulationService._logConsolidatedTrade(a.name,t,-o),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"buy"),this.gameState.setState({}),!0}sellItem(e,t){let i=this.gameState.getState();if(i.isGameOver||t<=0)return 0;let a=u.COMMODITIES.find(h=>h.id===e);if(a.licenseId&&!i.player.unlockedLicenseIds.includes(a.licenseId))return this.uiManager.queueModal("event-modal","License Required",`You do not have the required license to trade ${a.name}.`),0;let o=this.simulationService._getActiveInventory()[e];if(!o||o.quantity<t)return this.uiManager.queueModal("event-modal","Insufficient Inventory",`You do not have ${t} units of ${a.name} to sell.`),0;let{totalPrice:r}=this.uiManager._calculateSaleDetails(e,t),n=r,l=n-o.avgCost*t;if(l>0){let h=(i.player.activePerks[M.TRADEMASTER]?u.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);n+=l*h}n=Math.floor(n),this.gameState.player.credits+=n,o.quantity-=t,o.quantity===0&&(o.avgCost=0);let c=this.gameState.market.inventory[i.currentLocationId][e];return c.quantity+=t,this.logger.info.player(i.day,"SELL",`Sold ${t}x ${a.name} for ${y(n)}`),this.simulationService._logConsolidatedTrade(a.name,t,n),this.timeService._checkMilestones(),this.missionService.checkTriggers(),this.marketService.applyMarketImpact(e,t,"sell"),this.gameState.setState({}),n}buyShip(e,t){if(this.isTransactionInProgress)return null;this.isTransactionInProgress=!0;try{let i=u.SHIPS[e];if(!i)return this.logger.error("PlayerActionService",`buyShip called with invalid shipId: ${e}`),null;if(this.gameState.player.credits<i.price)return this.uiManager.queueModal("event-modal","Insufficient Funds","You cannot afford this ship."),null;this.gameState.player.credits-=i.price,this.logger.info.player(this.gameState.day,"SHIP_PURCHASE",`Purchased ${i.name} for ${y(i.price)}.`),t&&this.uiManager.createFloatingText(`-${y(i.price,!1)}`,t.clientX,t.clientY,"#f87171"),this.simulationService._logTransaction("ship",-i.price,`Purchased ${i.name}`),this.simulationService.addShipToHangar(e);let a=this.simulationService._getShipyardInventory(),s=this.gameState.uiState.shipyardActiveIndex||0,o=Math.min(s,Math.max(0,a.length-1));return this.gameState.tutorials.activeBatchId==="intro_hangar"&&(this.simulationService.setHangarShipyardMode("hangar"),this.simulationService.tutorialService.checkState({type:"ACTION",action:I.BUY_SHIP})),this.gameState.setState({uiState:{...this.gameState.uiState,shipyardActiveIndex:o,lastTransactionTimestamp:Date.now()}}),i}finally{setTimeout(()=>{this.isTransactionInProgress=!1},100)}}sellShip(e,t){if(this.isTransactionInProgress)return!1;this.isTransactionInProgress=!0;try{let i=this.gameState.getState();if(i.player.ownedShipIds.length<=1)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your last remaining ship."),!1;if(e===i.player.activeShipId)return this.uiManager.queueModal("event-modal","Action Blocked","You cannot sell your active ship."),!1;if(P(i.player.inventories[e])>0)return this.uiManager.queueModal("event-modal","Cannot Sell Ship","This vessel's cargo hold is not empty."),!1;let a=u.SHIPS[e];if(!a)return this.logger.error("PlayerActionService",`sellShip called with invalid shipId: ${e}`),!1;let s=Math.floor(a.price*C.SHIP_SELL_MODIFIER);this.gameState.player.credits+=s,this.logger.info.player(this.gameState.day,"SHIP_SALE",`Sold ${a.name} for ${y(s)}.`),t&&this.uiManager.createFloatingText(`+${y(s,!1)}`,t.clientX,t.clientY,"#34d399"),this.simulationService._logTransaction("ship",s,`Sold ${a.name}`);let o=this.gameState.player.ownedShipIds.indexOf(e);this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(n=>n!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e];let r=this.gameState.uiState.hangarActiveIndex;return o<r&&r--,r>=this.gameState.player.ownedShipIds.length&&(r=Math.max(0,this.gameState.player.ownedShipIds.length-1)),this.uiManager.queueModal("event-modal","Vessel Sold",`You sold the ${a.name} for ${y(s)}.`),this.gameState.setState({uiState:{...this.gameState.uiState,hangarActiveIndex:r,lastTransactionTimestamp:Date.now()}}),s}finally{setTimeout(()=>{this.isTransactionInProgress=!1},100)}}setActiveShip(e){if(!this.gameState.player.ownedShipIds.includes(e))return;this.gameState.player.activeShipId=e;let t=this.gameState.player.ownedShipIds.indexOf(e);t!==-1&&(this.gameState.uiState.hangarActiveIndex=t),this.logger.info.player(this.gameState.day,"SET_ACTIVE_SHIP",`Boarded the ${u.SHIPS[e].name}.`),this.gameState.introSequenceActive&&this.simulationService.tutorialService.checkState({type:"ACTION",action:I.SELECT_SHIP}),this.gameState.setState({})}payOffDebt(){if(this.gameState.isGameOver)return;let{player:e}=this.gameState;if(e.credits<e.debt){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford to pay off your entire debt.");return}let t=e.debt;e.credits-=t,this.logger.info.player(this.gameState.day,"DEBT_PAID",`Paid off ${y(t)} in debt.`),this.simulationService._logTransaction("loan",-t,`Paid off ${y(t)} debt`),e.debt=0,e.monthlyInterestAmount=0,e.loanStartDate=null,this.timeService._checkMilestones(),this.gameState.setState({})}takeLoan(e){let{player:t,day:i}=this.gameState;if(t.debt>0){this.uiManager.queueModal("event-modal","Loan Unavailable","You must pay off your existing debt first.");return}if(t.credits<e.fee){this.uiManager.queueModal("event-modal","Unable to Secure Loan",`The financing fee is ${y(e.fee)}, but you only have ${y(t.credits)}.`);return}t.credits-=e.fee,this.simulationService._logTransaction("loan",-e.fee,`Financing fee for ${y(e.amount)} loan`),t.credits+=e.amount,this.simulationService._logTransaction("loan",e.amount,`Acquired ${y(e.amount)} loan`),t.debt+=e.amount,t.monthlyInterestAmount=e.interest,t.loanStartDate=i,t.seenGarnishmentWarning=!1;let a=`You've acquired a loan of <span class="hl-blue">${y(e.amount)}</span>.<br>A financing fee of <span class="hl-red">${y(e.fee)}</span> was deducted.`;this.uiManager.queueModal("event-modal","Loan Acquired",a),this.logger.info.player(i,"LOAN_TAKEN",`Took a loan for ${y(e.amount)}.`),this.gameState.setState({})}purchaseLicense(e){let t=u.LICENSES[e],{player:i,day:a}=this.gameState;return t?t.type!=="purchase"?{success:!1,error:"NOT_FOR_PURCHASE"}:i.unlockedLicenseIds.includes(e)?{success:!1,error:"ALREADY_OWNED"}:i.credits<t.cost?{success:!1,error:"INSUFFICIENT_FUNDS"}:(i.credits-=t.cost,i.unlockedLicenseIds.push(e),this.logger.info.player(a,"LICENSE_PURCHASE",`Purchased ${t.name}.`),this.simulationService._logTransaction("license",-t.cost,`Purchased ${t.name}`),this.gameState.setState({}),{success:!0}):{success:!1,error:"INVALID_LICENSE"}}purchaseIntel(e){let{player:t,currentLocationId:i,day:a}=this.gameState;if(t.credits<e){this.uiManager.queueModal("event-modal","Insufficient Funds","You can't afford this intel.");return}t.credits-=e,this.logger.info.player(a,"INTEL_PURCHASE",`Purchased intel for ${y(e)}.`),this.simulationService._logTransaction("intel",-e,"Purchased market intel"),this.gameState.intel.available[i]=!1;let s=u.MARKETS.filter(l=>l.id!==i&&t.unlockedLocationIds.includes(l.id));if(s.length===0)return;let o=s[Math.floor(Math.random()*s.length)],r=u.COMMODITIES.filter(l=>l.tier<=t.revealedTier),n=r[Math.floor(Math.random()*r.length)];n&&(this.gameState.intel.active={targetMarketId:o.id,commodityId:n.id,type:"demand",startDay:a,endDay:a+100}),this.gameState.setState({})}refuelTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(!t||t.fuel>=t.maxFuel)return 0;let i=u.MARKETS.find(s=>s.id===e.currentLocationId).fuelPrice/2;if(e.player.activePerks[M.VENETIAN_SYNDICATE]&&e.currentLocationId===v.VENUS&&(i*=1-u.PERKS[M.VENETIAN_SYNDICATE].fuelDiscount),i=Math.max(1,Math.round(i)),e.player.credits<i)return 0;e.player.credits-=i,e.player.shipStates[t.id].fuel=Math.min(t.maxFuel,e.player.shipStates[t.id].fuel+5),this.simulationService._logConsolidatedTransaction("fuel",-i,"Fuel Purchase");let a=document.getElementById("refuel-btn");if(a){let s=a.getBoundingClientRect(),o=s.left+s.width/2,r=s.top;this.uiManager.createFloatingText(`-${y(i,!1)}`,o,r,"#f87171")}return this.gameState.setState({}),i}repairTick(){let e=this.gameState,t=this.simulationService._getActiveShip();if(!t||t.health>=t.maxHealth)return 0;let i=t.maxHealth*(C.REPAIR_AMOUNT_PER_TICK/100),a=i*C.REPAIR_COST_PER_HP;if(e.player.activePerks[M.VENETIAN_SYNDICATE]&&e.currentLocationId===v.VENUS&&(a*=1-u.PERKS[M.VENETIAN_SYNDICATE].repairDiscount),a=Math.max(1,Math.round(a)),e.player.credits<a)return 0;e.player.credits-=a,e.player.shipStates[t.id].health=Math.min(t.maxHealth,e.player.shipStates[t.id].health+i),this.simulationService._logConsolidatedTransaction("repair",-a,"Hull Repairs"),this.simulationService._checkHullWarnings(t.id);let s=document.getElementById("repair-btn");if(s){let o=s.getBoundingClientRect(),r=o.left+o.width/2,n=o.top;this.uiManager.createFloatingText(`-${y(a,!1)}`,r,n,"#f87171")}return this.gameState.setState({}),a}};var te=class{constructor(e,t,i,a){this.gameState=e,this.marketService=t,this.uiManager=i,this.logger=a,this.simulationService=null,this.intelService=null}advanceDays(e){this.logger.group(`[System] Advancing time by ${e} day(s) from Day ${this.gameState.day}`);for(let t=0;t<e;t++){if(this.gameState.isGameOver){this.logger.warn("TimeService","Advance days aborted: Game is over."),this.logger.groupEnd();return}this.gameState.day++,this.simulationService&&this.simulationService.pulseNewsTicker();let i=(this.gameState.day-1)%365,a=u.DATE_CONFIG.START_YEAR+Math.floor((this.gameState.day-1)/365);i===11&&a>this.gameState.player.lastBirthdayYear&&(this.gameState.player.playerAge++,this.gameState.player.birthdayProfitBonus+=.01,this.gameState.player.lastBirthdayYear=a,this.logger.info.state(this.gameState.day,"BIRTHDAY",`Player is now age ${this.gameState.player.playerAge}. Profit bonus increased.`)),this._checkAgeEvents(),this.marketService.evolveMarketPrices(),this.gameState.day-this.gameState.lastMarketUpdateDay>=7&&(this.marketService.checkForSystemStateChange(),this.marketService.replenishMarketInventory(),this.marketService._updateShipyardStock(),this.gameState.lastMarketUpdateDay=this.gameState.day);let s=this.gameState.getState(),o=s.day;if(s.activeIntelDeal&&o>s.activeIntelDeal.expiryDay&&(this.gameState.updateState({activeIntelDeal:null}),this.logger.info.system("IntelService",o,"EXPIRED","Active intel deal has expired.")),this.intelService&&o%120===1&&this.intelService.generateIntelRefresh(),this.gameState.player.ownedShipIds.forEach(r=>{if(r!==this.gameState.player.activeShipId){let n=u.SHIPS[r],l=n.maxHealth*C.PASSIVE_REPAIR_RATE;this.gameState.player.shipStates[r].health=Math.min(n.maxHealth,this.gameState.player.shipStates[r].health+l)}}),this.gameState.player.debt>0&&this.gameState.day-this.gameState.lastInterestChargeDay>=C.INTEREST_INTERVAL){let r=this.gameState.player.monthlyInterestAmount;this.gameState.player.debt+=r,this.simulationService._logTransaction("loan",r,"Monthly interest charge"),this.logger.info.system("Finance",this.gameState.day,"INTEREST",`Charged ${y(r)} interest on debt.`),this.gameState.lastInterestChargeDay=this.gameState.day}this._applyGarnishment()}this.logger.groupEnd(),this.gameState.setState({})}_checkAgeEvents(){u.AGE_EVENTS.forEach(e=>{this.gameState.player.seenEvents.includes(e.id)||(e.trigger.day&&this.gameState.day>=e.trigger.day||e.trigger.credits&&this.gameState.player.credits>=e.trigger.credits)&&(this.gameState.player.seenEvents.push(e.id),this.logger.info.state(this.gameState.day,"AGE_EVENT",`Triggered age event: ${e.title}`),this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t)))})}_checkMilestones(){let{credits:e,revealedTier:t}=this.gameState.player,i=t,a=Te.find(s=>s.revealsTier===i+1);for(;a&&e>=a.threshold;)this.gameState.player.revealedTier=a.revealsTier,this.logger.info.state(this.gameState.day,"MILESTONE",`Unlocked Tier ${a.revealsTier} commodities.`),i=a.revealsTier,a=Te.find(s=>s.revealsTier===i+1);this.gameState.player.revealedTier!==t&&this.gameState.setState({})}_applyGarnishment(){let{player:e,day:t}=this.gameState;if(e.debt>0&&e.loanStartDate&&t-e.loanStartDate>=C.LOAN_GARNISHMENT_DAYS){if((t-this.gameState.lastInterestChargeDay)%C.INTEREST_INTERVAL!==0)return;let i=Math.floor(e.credits*C.LOAN_GARNISHMENT_PERCENT);i>0&&(e.credits-=i,this.simulationService._logTransaction("debt",-i,"Monthly credit garnishment"),this.simulationService._checkGameOverConditions()),e.seenGarnishmentWarning||(this.uiManager.queueModal("event-modal","Credit Garnishment Notice","Your loan is delinquent. Your lender is now garnishing 14% of your credits monthly until the debt is paid.",null,{buttonClass:"bg-red-800/80"}),e.seenGarnishmentWarning=!0,this.logger.warn("Finance",`Loan delinquent. Garnishment of ${C.LOAN_GARNISHMENT_PERCENT*100}% initiated.`))}}getCurrentDay(){return this.gameState.day}};function Pe(d,e,t,i){let a=e._getActiveShip(),s=Math.floor(d.player.credits*t.wagerPercentage),o=t.winChance[a.class]||.4;Math.random()<o?(d.player.credits+=s,e._logTransaction("event",s,"Won space race wager"),i.description=`Your Class ${a.class} ship wins! You gain <span class="hl-green">${y(s)}</span>.`):(d.player.credits-=s,e._logTransaction("event",-s,"Lost space race wager"),i.description=`The luxury ship was too fast. You lose <span class="hl-red">${y(s)}</span>.`)}function De(d,e,t){let i=e._getActiveShip(),a=d.player.shipStates[i.id],s=e._getActiveInventory();if(a.fuel=Math.max(0,a.fuel-30),s[E.CYBERNETICS]||(s[E.CYBERNETICS]={quantity:0,avgCost:0}),P(s)+40<=i.cargoCapacity)return s[E.CYBERNETICS].quantity+=40,{key:"reward_cybernetics"};if(d.player.debt>0){let o=Math.floor(d.player.debt*.2);return d.player.debt-=o,e._logTransaction("event",o,"Passenger paid off debt"),{key:"reward_debt_paid",amount:y(o)}}else{let o=Math.floor(d.player.credits*.05);return d.player.credits+=o,e._logTransaction("event",o,"Passenger payment"),{key:"reward_credits",amount:y(o)}}}var at={SPACE_RACE:Pe,ADRIFT_PASSENGER:De,credits:(d,e,t)=>{d.player.credits+=t.value,e._logTransaction("event",t.value,"Received credits from event")},fuel:(d,e,t)=>{let i=e._getActiveShip(),a=d.player.shipStates[i.id];a.fuel=Math.max(0,a.fuel+t.value)},hull_damage_percent:(d,e,t)=>{let i=Array.isArray(t.value)?Math.random()*(t.value[1]-t.value[0])+t.value[0]:t.value;d.pendingTravel.eventHullDamagePercent=(d.pendingTravel.eventHullDamagePercent||0)+i},travel_time_add:(d,e,t)=>{d.pendingTravel.travelTimeAdd=(d.pendingTravel.travelTimeAdd||0)+t.value},travel_time_add_percent:(d,e,t)=>{d.pendingTravel.travelTimeAddPercent=(d.pendingTravel.travelTimeAddPercent||0)+t.value},set_travel_time:(d,e,t)=>{d.pendingTravel.setTravelTime=t.value},add_debt:(d,e,t)=>{d.player.debt<=0&&(d.player.loanStartDate=d.day,d.player.weeklyInterestAmount=0);let i=Math.ceil(t.value*.013);d.player.weeklyInterestAmount+=i,d.player.debt+=t.value,e._logTransaction("loan",t.value,"Incurred debt from event")},add_cargo:(d,e,t,i)=>{let a=e._getActiveShip(),s=e._getActiveInventory(),o=u.COMMODITIES.find(r=>r.id===t.value.id);P(s)+t.value.quantity<=a.cargoCapacity?s[t.value.id].quantity+=t.value.quantity:i.description=`You try to tractor the pod, but there's no room in your cargo hold! You're forced to leave the <span class="hl">${o.name}</span> behind.`},lose_cargo:(d,e,t)=>{let i=e._getActiveInventory();i[t.value.id].quantity=Math.max(0,i[t.value.id].quantity-t.value.quantity)},lose_random_cargo_percent:(d,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],r=Math.ceil(o.quantity*t.value);o.quantity=Math.max(0,o.quantity-r)}},sell_random_cargo_premium:(d,e,t)=>{let i=e._getActiveInventory(),a=Object.entries(i).filter(([,s])=>s.quantity>0);if(a.length>0){let[s,o]=a[Math.floor(Math.random()*a.length)],r=d.market.galacticAverages[s]*t.value*o.quantity;d.player.credits+=r,e._logTransaction("trade",r,"Emergency supply drop sale"),o.quantity=0}},set_new_random_destination:(d,e,t)=>{let i=u.MARKETS.filter(a=>a.id!==d.currentLocationId&&d.player.unlockedLocationIds.includes(a.id));i.length>0&&(d.pendingTravel.destinationId=i[Math.floor(Math.random()*i.length)].id)}};function $e(d,e,t,i){let a=at[t.type];if(a)return a(d,e,t,i);console.warn(`No handler found for event effect type: ${t.type}`)}var ie=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.timeService=i,this.logger=a,this.simulationService=s}travelTo(e){this.uiManager.resetMarketTransactionState();let{tutorials:t}=this.gameState,{navLock:i}=t;if(i&&i.screenId===A.NAVIGATION&&i.enabledElementQuery&&!i.enabledElementQuery.includes(`[data-location-id='${e}']`))return;let a=this.gameState.getState();if(a.isGameOver||a.pendingTravel)return;if(a.currentLocationId===e){this.simulationService.setScreen(N.STARPORT,A.MARKET);return}let s=this.simulationService._getActiveShip();if(!s){this.uiManager.queueModal("event-modal","No Active Ship","You must have an active vessel to travel.");return}let r=a.TRAVEL_DATA[a.currentLocationId][e].fuelCost;if(a.player.activePerks[M.NAVIGATOR]&&(r=Math.round(r*u.PERKS[M.NAVIGATOR].fuelMod)),s.maxFuel<r){this.uiManager.queueModal("event-modal","Fuel Capacity Insufficient",`Your ship's fuel tank is too small. This trip requires ${r} fuel, but you can only hold ${s.maxFuel}.`);return}if(s.fuel<r){this.uiManager.queueModal("event-modal","Insufficient Fuel",`You need ${r} fuel but only have ${Math.floor(s.fuel)}.`);return}!(a.tutorials.activeBatchId==="intro_missions"&&a.tutorials.activeStepId==="mission_1_6")&&this._checkForRandomEvent(e)||this.initiateTravel(e)}initiateTravel(e,t={}){let i=this.gameState.getState(),a=i.currentLocationId,s={...i.TRAVEL_DATA[a][e]};this.logger.info.player(i.day,"TRAVEL_START",`Departing from ${a} to ${e}.`),i.player.activePerks[M.NAVIGATOR]&&(s.time=Math.round(s.time*u.PERKS[M.NAVIGATOR].travelTimeMod),s.fuelCost=Math.round(s.fuelCost*u.PERKS[M.NAVIGATOR].fuelMod)),t.travelTimeAdd&&(s.time+=t.travelTimeAdd),t.travelTimeAddPercent&&(s.time*=1+t.travelTimeAddPercent),t.setTravelTime&&(s.time=t.setTravelTime),s.time=Math.max(1,Math.round(s.time));let o=this.simulationService._getActiveShip(),r=this.gameState.player.shipStates[o.id];if(o.fuel<s.fuelCost){this.uiManager.queueModal("event-modal","Insufficient Fuel",`Trip modifications left you without enough fuel. You need ${s.fuelCost} but only have ${Math.floor(o.fuel)}.`),this.logger.warn("TravelService",`Travel to ${e} aborted due to insufficient fuel after event mods.`);return}if(t.forceEvent&&this._checkForRandomEvent(e,!0))return;let n=s.time*C.HULL_DECAY_PER_TRAVEL_DAY;i.player.activePerks[M.NAVIGATOR]&&(n*=u.PERKS[M.NAVIGATOR].hullDecayMod);let l=o.maxHealth*((t.eventHullDamagePercent||0)/100),c=n+l;if(r.health-=c,this.simulationService._checkHullWarnings(o.id),r.health<=0){this._handleShipDestruction(o.id);return}if(r.fuel-=s.fuelCost,this.timeService.advanceDays(s.time),this.gameState.isGameOver)return;this.simulationService.newsTickerService.onLocationChange(),this.gameState.setState({currentLocationId:e,pendingTravel:null});let h=u.MARKETS.find(S=>S.id===a),m=u.MARKETS.find(S=>S.id===e);if(!h||!m){this.logger.error("TravelService",`Invalid location ID provided for travel animation. From: ${a}, To: ${e}`),this.uiManager.queueModal("event-modal","Navigation Error","Could not plot a course. The destination is unknown.");return}let p=c/o.maxHealth*100;this.logger.info.player(this.gameState.day,"TRAVEL_END",`Arrived at ${e}.`,{fuelUsed:s.fuelCost,hullDamage:p.toFixed(2)+"%"});let g=()=>{this.gameState.tutorials.activeBatchId==="intro_missions"&&this.gameState.tutorials.activeStepId==="mission_1_7"&&e===v.LUNA?this.simulationService.setScreen(N.DATA,A.MISSIONS):this.simulationService.setScreen(N.STARPORT,A.MARKET)};this.uiManager.showTravelAnimation(h,m,s,p,g)}resumeTravel(){if(!this.gameState.pendingTravel)return;this.logger.info.system("Game",this.gameState.day,"TRAVEL_RESUME","Resuming travel after event.");let{destinationId:e,...t}=this.gameState.pendingTravel;this.initiateTravel(e,t)}_checkForRandomEvent(e,t=!1){if(t===!1&&Math.random()>C.RANDOM_EVENT_CHANCE)return!1;let i=this.simulationService._getActiveShip(),a;if(typeof t=="number")a=u.RANDOM_EVENTS[t];else{let s=u.RANDOM_EVENTS.filter(o=>o.precondition(this.gameState.getState(),i,this.simulationService._getActiveInventory.bind(this.simulationService)));if(s.length===0)return!1;a=s[Math.floor(Math.random()*s.length)]}return a?(this.logger.info.system("Event",this.gameState.day,"EVENT_TRIGGER",`Triggered random event: ${a.title}`),this.gameState.setState({pendingTravel:{destinationId:e}}),this.uiManager.showRandomEventModal(a,(s,o)=>this._resolveEventChoice(s,o)),!0):(this.logger.warn("TravelService",`Debug event trigger failed for index: ${t}`),!1)}_resolveEventChoice(e,t){let i=u.RANDOM_EVENTS.find(l=>l.id===e),a=i.choices[t],s=Math.random(),o=a.outcomes.find(l=>(s-=l.chance)<0)||a.outcomes[a.outcomes.length-1],r=this._applyEventEffects(o),n=o.description;r&&o.descriptions&&(n=o.descriptions[r.key],r.amount&&(n=n.replace("{amount}",r.amount))),this.logger.info.player(this.gameState.day,"EVENT_CHOICE",`Chose '${a.title}' for event '${i.title}'.`),this.uiManager.queueModal("event-modal",i.title,n,()=>this.resumeTravel(),{buttonText:"Continue Journey"})}_applyEventEffects(e){let t=null;return e.effects.forEach(i=>{let a=$e(this.gameState,this.simulationService,i,e);a&&(t=a)}),this.gameState.setState({}),t}_handleShipDestruction(e){let t=u.SHIPS[e].name;if(this.logger.error("TravelService",`Ship ${t} was destroyed.`),this.gameState.player.ownedShipIds=this.gameState.player.ownedShipIds.filter(i=>i!==e),delete this.gameState.player.shipStates[e],delete this.gameState.player.inventories[e],this.gameState.player.ownedShipIds.length===0)this.simulationService._gameOver(`Your last ship, the ${t}, was destroyed. Your trading career ends here.`);else{this.gameState.player.activeShipId=this.gameState.player.ownedShipIds[0];let i=u.SHIPS[this.gameState.player.activeShipId].name,a=`The ${t} suffered a catastrophic hull breach and was destroyed. All cargo was lost.<br><br>You now command your backup vessel, the ${i}.`;this.uiManager.queueModal("event-modal","Vessel Lost",a)}this.gameState.setState({})}};var K={CORPORATE_LIQUIDATION:{sample:"We have confirmed actionable intelligence at [location name]. The data points to a significant, short-term market inefficiency.",details:"PACKET DECRYPTED: A [commodity name] surplus at [location name] allows for purchase at [discount amount %] below galactic average. This price is locked for [durationDays] days. A minor Corporate State is quietly liquidating assets to meet quarterly quotas. This is a standard, low-risk procurement opportunity. This intel was secured for [\u232C credit price]."},SUPPLY_CHAIN_DISRUPTION:{sample:"A reliable node reports a supply chain disruption affecting [location name]. This packet identifies a specific commodity now available at a statistical discount.",details:"DATA UNLOCKED: [commodity name] is available at [location name] for [discount amount %] off standard pricing. This window is open for [durationDays] days. A Merchant's Guild freighter was damaged, forcing them to offload their cargo here at a loss. Their misfortune is your gain. This access was [\u232C credit price]."}};var He={tier1:["Minor price drop for {Commodity Name}.","Low prices reported for {Commodity Name}.","{Commodity Name} trending below average.","{Commodity Name}: Favorable pricing reported.","Good time to buy {Commodity Name}.","It's a buyer's market for {Commodity Name}."],tier2:["{Commodity Name} prices are looking good.","{Commodity Name} is on sale.","Exceptional pricing available for {Commodity Name}.","Act now for the best price on {Commodity Name}.","Get your cheap {Commodity Name} now!","{Commodity Name} is trading far below average.","Get {Commodity Name} for cheap while you can.","Traders are eyeing cheap {Commodity Name}.","Now is the time to acquire {Commodity Name}.","Capitalize on falling {Commodity Name} prices.","Solid discount on {Commodity Name}."],tier3:["Don't miss out: {Commodity Name} is a bargain.","Prime buying opportunity for {Commodity Name}.","{Commodity Name}: Prices slashed!","{Commodity Name} is a 'hot buy' right now.","{Commodity Name} is a steal at this price.","Significant price drop for {Commodity Name}.","Traders report massive discounts on {Commodity Name}.","Unbeatable deals on {Commodity Name} right now.","Deep discounts on {Commodity Name}!","{Commodity Name} value has dropped significantly.","{Commodity Name} prices are tumbling."],tier4:["{Commodity Name} prices are nosediving.","{Commodity Name} prices have plummeted!","Major price correction for {Commodity Name}.","Fire sale! Get your {Commodity Name} while it lasts.","{Commodity Name} prices are getting crushed.","{Commodity Name} is practically a giveaway."],tier5:["{Commodity Name}: Prices have never been lower.","Historic lows for {Commodity Name}.","{Commodity Name} prices hit rock-bottom!","{Commodity Name} prices are in freefall.","Price crash reported for {Commodity Name}.","Market update: {Commodity Name} valuation has collapsed.","{Commodity Name} is being sold for scrap prices.","{Commodity Name}: Total market collapse!","{Commodity Name} is virtually worthless."]},Ie=["Prime buying opportunity for {Commodity Name} at {Location Name}!","{Location Name} reports massive discounts on {Commodity Name}!","{Commodity Name} is a steal at {Location Name} right now!","Don't miss out: {Commodity Name} is a bargain at {Location Name}!","{Location Name}: Prices slashed on {Commodity Name}!","Head to {Location Name} for deep discounts on {Commodity Name}!","Traders flocking to {Location Name} for cheap {Commodity Name}!","Significant price drops for {Commodity Name} at {Location Name}!","{Location Name} is the hot spot to buy {Commodity Name}!","Unbeatable deals on {Commodity Name} available at {Location Name}!","{Location Name} is dumping its {Commodity Name} stock!","Get to {Location Name}! {Commodity Name} prices are nosediving!","{Commodity Name} prices have plummeted at {Location Name}!","{Location Name} is practically giving away {Commodity Name}!","Fire sale on {Commodity Name} at {Location Name}!","{Commodity Name} prices are getting crushed at {Location Name}!","{CommodITY Name} market is in a freefall at {Location Name}!","Rumor: A major holder just dumped {Commodity Name} at {Location Name}!","{Commodity Name} selling for practically nothing at {Location Name}!","Price crash! {Commodity Name} is worthless at {Location Name}!","The {Commodity Name} market has collapsed at {Location Name}!","Historic lows for {Commodity Name} reported at {Location Name}!","{Location Name}: {Commodity Name} prices have hit rock-bottom!","Total market failure for {Commodity Name} at {Location Name}!","{Location Name} can't get rid of its {Commodity Name}!","{Commodity Name}: Prices have never been lower at {Location Name}!","{Commodity Name} is being sold for scrap prices at {Location Name}!","{Location Name}'s {Commodity Name} valuation has evaporated!"];var ae=class{constructor(e,t,i,a,s){this.gameState=e,this.timeService=t,this.marketService=i,this.newsTickerService=a,this.logger=s,this.db=u}generateIntelRefresh(){this.logger.info.system("IntelService",this.gameState.day,"REFRESH","Generating intel refresh for all markets.");let t={...this.gameState.getState().intelMarket};for(let i of Object.keys(t)){let a=t[i].filter(s=>s.isPurchased);t[i]=a}for(let i of this.db.MARKETS){let a=i.id;if(t[a]||(t[a]=[]),Math.random()<.7){let s=t[a].map(n=>n.messageKey),o=new Set,r=1+Math.floor(Math.random()*3);for(let n=0;n<r;n++){let l=[...s,...o],c=this._createPacket(a,l);c&&(t[a].push(c),o.add(c.messageKey))}}}this.gameState.setState({intelMarket:t})}_createPacket(e,t=[]){let a=this.gameState.getState().player.revealedTier,s=this.db.COMMODITIES.filter(T=>T.tier<=a).map(T=>T.id);if(!s||s.length===0)return this.logger.warn("IntelService","Cannot create packet: No unlocked commodities available for player's tier."),null;let r=this.db.MARKETS.map(T=>T.id).filter(T=>T!==e);if(r.length===0)return this.logger.warn("IntelService","Cannot create packet: No other locations available for a deal."),null;let n=r[Math.floor(Math.random()*r.length)],l=s[Math.floor(Math.random()*s.length)],c=.15+Math.random()*.35,h=30+Math.floor(Math.random()*61),m=1+c*2+h/90,p=Object.keys(K);if(p.length===0)return this.logger.warn("IntelService","Cannot create packet: INTEL_CONTENT is empty."),null;let g=p.filter(T=>!t.includes(T)),S;return g.length===0?(this.logger.warn("IntelService",`All message keys for ${e} are in use. Reusing a key to generate packet.`),S=p[Math.floor(Math.random()*p.length)]):S=g[Math.floor(Math.random()*g.length)],{id:`pkt_${e.replace("loc_","")}_${this.timeService.getCurrentDay()}_${Math.floor(Math.random()*999)}`,locationId:e,dealLocationId:n,commodityId:l,discountPercent:parseFloat(c.toFixed(2)),durationDays:h,valueMultiplier:parseFloat(m.toFixed(2)),messageKey:S,isPurchased:!1}}calculateIntelPrice(e){let a=this.gameState.getState().player.credits*(.1+Math.random()*.1)*e.valueMultiplier;return Math.floor(a/100)*100}purchaseIntel(e,t,i){let a=this.gameState.getState();if(a.activeIntelDeal!==null)return this.logger.warn("IntelService","Purchase aborted: A deal is already active."),null;let s=this.gameState.intelMarket,o=s[t]?.find(h=>h.id===e);if(!o)return this.logger.error("IntelService",`Purchase failed: Could not find packetId ${e} at ${t}.`),null;if(a.player.credits<i)return this.logger.warn("IntelService","Purchase aborted: Insufficient credits."),null;this.gameState.player.credits-=i,this.logger.info.player(a.day,"INTEL_PURCHASE",`Purchased intel packet ${o.id} for ${y(i)}`),o.isPurchased=!0;let r=this.marketService.getGalacticAverage(o.commodityId),n=Math.floor(r*(1-o.discountPercent)),l=this.timeService.getCurrentDay()+o.durationDays,c={locationId:o.dealLocationId,commodityId:o.commodityId,overridePrice:n,expiryDay:l,sourcePacketId:o.id};try{let h=this.db.COMMODITIES.find(S=>S.id===o.commodityId)?.name||"goods",m=this.db.MARKETS.find(S=>S.id===o.dealLocationId)?.name||"a local market",g=Ie[Math.floor(Math.random()*Ie.length)].replace("{Commodity Name}",h).replace("{Location Name}",m);this.newsTickerService.pushMessage(g,"INTEL",!0)}catch(h){this.logger.error("IntelService","Failed to push news ticker message.",h)}return this.gameState.setState({activeIntelDeal:c,intelMarket:s}),o}getGalacticAverage(e){return this.marketService.getGalacticAverage(e)}getCurrentDay(){return this.timeService.getCurrentDay()}};var se=class{constructor(e,t,i,a){this.gameState=e,this.uiManager=t,this.logger=i,this.newsTickerService=a,this.tutorialService=null,this.missionService=null,this.intelService=null,this.marketService=new J(e),this.timeService=new te(e,this.marketService,t,i,a),this.travelService=new ie(e,t,this.timeService,i,this),this.introService=new Z(e,t,i,this),this.playerActionService=new ee(e,t,null,this.marketService,this.timeService,i,this),this.intelService=new ae(e,this.timeService,this.marketService,this.newsTickerService,i),this.timeService.intelService=this.intelService,this.uiManager.setIntelService(this.intelService),this.timeService.simulationService=this,this.newsTickerService.setServices(this,this.marketService)}setTutorialService(e){this.tutorialService=e}setMissionService(e){this.missionService=e,this.playerActionService.missionService=e}startIntroSequence(){this.introService.start()}handleIntroClick(e){this.introService.handleIntroClick(e)}_continueIntroSequence(e){this.introService.continueAfterTutorial(e)}buyItem(e,t){return this.playerActionService.buyItem(e,t)}sellItem(e,t){return this.playerActionService.sellItem(e,t)}initiateShipTransactionAnimation(e,t,i){this.playerActionService.initiateShipTransactionAnimation(e,t,i)}buyShip(e,t){return this.playerActionService.buyShip(e,t)}sellShip(e,t){return this.playerActionService.sellShip(e,t)}setActiveShip(e){this.playerActionService.setActiveShip(e)}payOffDebt(){this.playerActionService.payOffDebt()}takeLoan(e){this.playerActionService.takeLoan(e)}purchaseLicense(e){return this.playerActionService.purchaseLicense(e)}refuelTick(){return this.playerActionService.refuelTick()}repairTick(){return this.playerActionService.repairTick()}travelTo(e){this.travelService.travelTo(e)}resumeTravel(){this.travelService.resumeTravel()}pushNewsMessage(e,t,i=!1){this.newsTickerService&&this.newsTickerService.pushMessage(e,t,i)}pulseNewsTicker(){this.newsTickerService&&this.newsTickerService.pulse()}setScreen(e,t){let i={...this.gameState.lastActiveScreen,[e]:t};this.gameState.setState({activeNav:e,activeScreen:t,lastActiveScreen:i}),this.tutorialService&&this.tutorialService.checkState({type:"SCREEN_LOAD",screenId:t})}setIntelTab(e){this.gameState.uiState.activeIntelTab!==e&&(this.gameState.uiState.activeIntelTab=e,this.gameState.setState({uiState:this.gameState.uiState}))}setHangarShipyardMode(e){this.gameState.uiState.hangarShipyardToggleState!==e&&(this.gameState.uiState.hangarShipyardToggleState=e,this.gameState.setState({}))}setHangarCarouselIndex(e,t){t==="hangar"?this.gameState.uiState.hangarActiveIndex=e:this.gameState.uiState.shipyardActiveIndex=e,this.gameState.setState({})}cycleHangarCarousel(e){let{uiState:t,player:i}=this.gameState,a=t.hangarShipyardToggleState==="hangar",s=a?i.ownedShipIds:this._getShipyardInventory().map(([r])=>r);if(s.length<=1)return;let o=a?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;e==="next"?o=(o+1)%s.length:o=(o-1+s.length)%s.length,this.setHangarCarouselIndex(o,a?"hangar":"shipyard")}_gameOver(e){this.gameState.isGameOver||(this.logger.info.state(this.gameState.day,"GAME_OVER",e),this.gameState.setState({isGameOver:!0}),this.uiManager.queueModal("event-modal","Game Over",e,()=>{localStorage.removeItem(xe),window.location.reload()},{buttonText:"Restart"}))}_checkGameOverConditions(){this.gameState.player.credits<=0&&this._gameOver("Your credit balance has fallen to zero. With no funds to operate, your trading career has come to an end.")}addShipToHangar(e){let t=u.SHIPS[e];t&&(this.gameState.player.ownedShipIds.push(e),this.gameState.player.shipStates[e]={health:t.maxHealth,fuel:t.maxFuel,hullAlerts:{one:!1,two:!1}},this.gameState.player.inventories[e]||(this.gameState.player.inventories[e]={},u.COMMODITIES.forEach(i=>{this.gameState.player.inventories[e][i.id]={quantity:0,avgCost:0}})))}_applyPerk(e){this.logger.info.player(this.gameState.day,"PERK_APPLIED",`Gained perk: ${e.title}`),e.perkId&&(this.gameState.player.activePerks[e.perkId]=!0),e.playerTitle&&(this.gameState.player.playerTitle=e.playerTitle),e.perkId===M.MERCHANT_GUILD_SHIP&&(this.addShipToHangar(L.STALWART),this.uiManager.queueModal("event-modal","Vessel Delivered",`The Merchant's Guild has delivered a new ${u.SHIPS[L.STALWART].name} to your hangar.`)),this.gameState.setState({})}_getActiveShip(){let e=this.gameState,t=e.player.activeShipId;return t?{id:t,...u.SHIPS[t],...e.player.shipStates[t]}:null}_getActiveInventory(){return this.gameState.player.activeShipId?this.gameState.player.inventories[this.gameState.player.activeShipId]:null}_checkHullWarnings(e){let t=this.gameState.player.shipStates[e],i=u.SHIPS[e],a=t.health/i.maxHealth*100;a<=15&&!t.hullAlerts.two?t.hullAlerts.two=!0:a<=30&&!t.hullAlerts.one&&(t.hullAlerts.one=!0),a>30&&(t.hullAlerts.one=!1),a>15&&(t.hullAlerts.two=!1)}_logTransaction(e,t,i){for(this.gameState.player.financeLog.push({day:this.gameState.day,type:e,amount:t,balance:this.gameState.player.credits,description:i});this.gameState.player.financeLog.length>C.FINANCE_HISTORY_LENGTH;)this.gameState.player.financeLog.shift()}_logConsolidatedTrade(e,t,i){let a=this.gameState.player.financeLog,s=i<0,o=s?"Bought":"Sold",r=a.find(n=>n.day===this.gameState.day&&n.type==="trade"&&n.description.startsWith(`${o}`)&&n.description.endsWith(` ${e}`)&&(s&&n.amount<0||!s&&n.amount>0));if(r){r.amount+=i,r.balance=this.gameState.player.credits;let n=r.description.match(/\s(\d+)x\s/);if(n){let l=parseInt(n[1],10);r.description=`${o} ${l+t}x ${e}`}}else this._logTransaction("trade",i,`${o} ${t}x ${e}`)}_logConsolidatedTransaction(e,t,i){let a=this.gameState.player.financeLog,s=a.length>0?a[a.length-1]:null;s&&s.day===this.gameState.day&&s.type===e?(s.amount+=t,s.balance=this.gameState.player.credits):this._logTransaction(e,t,i)}_getShipyardInventory(){let{tutorials:e,player:t,currentLocationId:i,market:a}=this.gameState;return e.activeBatchId==="intro_hangar"?t.ownedShipIds.length>0?[]:[L.WANDERER,L.STALWART,L.MULE].map(s=>[s,u.SHIPS[s]]):(a.shipyardStock[i]?.shipsForSale||[]).map(o=>[o,u.SHIPS[o]]).filter(([o])=>!t.ownedShipIds.includes(o))}_grantRewards(e,t){e.forEach(i=>{if(i.type==="credits"&&(this.gameState.player.credits+=i.amount,this._logTransaction("mission",i.amount,`Reward: ${t}`),this.uiManager.createFloatingText(`+${y(i.amount,!1)}`,window.innerWidth/2,window.innerHeight/2,"#34d399")),i.type==="license"&&!this.gameState.player.unlockedLicenseIds.includes(i.licenseId)){this.gameState.player.unlockedLicenseIds.push(i.licenseId);let a=u.LICENSES[i.licenseId];this.uiManager.triggerEffect("systemSurge",{theme:"tan"}),this.logger.info.player(this.gameState.day,"LICENSE_GRANTED",`Received ${a.name}.`)}})}grantMissionCargo(e){let t=u.MISSIONS[e];if(!t||!t.providedCargo)return;let i=this._getActiveInventory();if(!i){this.logger.error("SimulationService","Cannot grant mission cargo: No active inventory found.");return}t.providedCargo.forEach(a=>{i[a.goodId]||(i[a.goodId]={quantity:0,avgCost:0}),i[a.goodId].quantity+=a.quantity,this.logger.info.player(this.gameState.day,"CARGO_GRANT",`Received ${a.quantity}x ${u.COMMODITIES.find(s=>s.id===a.goodId).name} from ${t.name}.`)}),this.missionService&&this.missionService.checkTriggers()}};var oe=class{constructor(){this.effectQueue=[],this.isEffectActive=!1,this.effectsRegistry={}}registerEffect(e,t){this.effectsRegistry[e]=t}trigger(e,t){console.log(`MANAGER: EffectsManager.trigger received call for '${e}'. Queue length: ${this.effectQueue.length}`),this.effectQueue.push({effectName:e,options:t}),this._processQueue()}async _processQueue(){if(this.isEffectActive||this.effectQueue.length===0)return;this.isEffectActive=!0;let e=this.effectQueue.shift(),t=this.effectsRegistry[e.effectName];if(!t){console.warn(`EffectManager: Attempted to trigger unregistered effect '${e.effectName}'.`),this.isEffectActive=!1,this._processQueue();return}try{console.log(`MANAGER: Instantiating and playing effect: '${e.effectName}'.`),await new t(e.options).play()}catch(i){console.error(`Error playing effect '${e.effectName}':`,i)}finally{this.isEffectActive=!1,this._processQueue()}}};function Ge(d,e){let{uiState:t,player:i,tutorials:a}=d,s=t.hangarShipyardToggleState==="hangar",o=s?"mode-hangar":"mode-shipyard",r=s?i.ownedShipIds:e._getShipyardInventory().map(([c])=>c),n=s?t.hangarActiveIndex||0:t.shipyardActiveIndex||0,l=Math.min(n,Math.max(0,r.length-1));return`
        <div class="flex flex-col h-full">
            <div id="ship-terminal-container" class="flex flex-col flex-grow min-h-0 ${o}">
                <div class="toggle-container mx-auto my-1">
                    <div class="toggle-switch p-1 rounded-md flex w-[180px] h-10">
                        <div class="toggle-label hangar flex-1 text-center py-1 cursor-pointer" data-action="${I.TOGGLE_HANGAR_MODE}" data-mode="hangar">HANGAR</div>
                        <div class="toggle-label shipyard flex-1 text-center py-1 cursor-pointer" data-action="${I.TOGGLE_HANGAR_MODE}" data-mode="shipyard">SHIPYARD</div>
                    </div>
                </div>

                <div class="carousel-container flex-grow overflow-hidden relative">
                    <div id="hangar-carousel" class="flex h-full" style="transform: translateX(-${l*100}%)">
                        ${r.map(c=>ot(d,c,s)).join("")||st(s)}
                    </div>
                </div>
            </div>
            <div id="hangar-pagination-wrapper">
                <div id="hangar-pagination">
                    {/* This will be populated by UIManager._renderHangarPagination */}
                </div>
            </div>
        </div>
    `}function st(d){return`
        <div class="carousel-page p-2 md:p-4 w-full">
             <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div class="flex flex-col items-center justify-center h-full">
                    <p class="text-gray-400">${d?"Your hangar is empty.":"No ships available in the shipyard."}</p>
                </div>
            </div>
        </div>
    `}function ot(d,e,t){let i=u.SHIPS[e],a=t?d.player.shipStates[e]:null,{player:s}=d,o="";if(t){let l=s.activeShipId===e;o=`<div class="status-badge" style="border-color: ${l?"var(--theme-color-primary)":"var(--ot-border-light)"}; color: ${l?"var(--theme-color-primary)":"var(--ot-text-secondary)"};">${l?"ACTIVE":"STORED"}</div>`}let r=`
        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${o}
            </div>
        </div>
        <div class="col-span-2 flex flex-col justify-between">
            ${Be(d,e,i,a,s,t)}
            <div class="action-buttons-container pt-2">
                ${Fe(e,i,s,t,d.tutorials)}
            </div>
        </div>
    `,n=`
        <div class="col-span-2 flex flex-col justify-between">
            ${Be(d,e,i,a,s,t)}
        </div>

        <div class="col-span-3 flex flex-col justify-between">
            <div class="ship-display-area flex-grow flex items-center justify-center relative">
                <div class="ship-image-placeholder w-full rounded-lg flex items-center justify-center">
                    <span class="text-2xl font-orbitron">[ SHIP HOLOGRAM ]</span>
                </div>
                ${o}
            </div>
            <div class="action-buttons-container pt-2">
                ${Fe(e,i,s,t,d.tutorials)}
            </div>
        </div>
    `;return`
        <div class="carousel-page p-2 md:p-4 w-full">
            <div id="ship-terminal" class="relative h-full rounded-lg border-2" style="border-color: var(--frame-border-color);">
                <div id="ship-card-main-content" class="h-full">
                    <div class="ship-card-content-wrapper h-full">
                        ${t?n:r}
                    </div>
                </div>
            </div>
        </div>
    `}function Be(d,e,t,i,a,s){let o=t.class.toLowerCase();return s?`
            <div class="info-panel-content info-panel-hangar flex-col justify-between h-full">
                <div>
                    <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${o}-color);">${t.name}</h3>
                    <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                </div>
                <div class="hangar-specs my-4">
                    ${Ee("Hull",i?.health,t.maxHealth,"var(--ot-green-accent)")}
                    ${Ee("Fuel",i?.fuel,t.maxFuel,"var(--ot-cyan-base)")}
                    ${Ee("Cargo",P(a.inventories[e]),t.cargoCapacity,"var(--class-s-color)")}
                </div>
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${t.lore}</p>
                </div>
            </div>
        `:`
             <div class="info-panel-content info-panel-shipyard flex-col justify-between h-full">
                <div>
                    <h3 class="text-2xl font-orbitron inset-text-shadow" style="color: var(--class-${o}-color);">${t.name}</h3>
                    <p class="text-md text-gray-400 inset-text-shadow">Class ${t.class} ${t.role||"Freighter"}</p>
                    <p class="ship-price-display font-roboto-mono text-2xl">${y(t.price)}</p>
                </div>
                 <div class="grid grid-cols-3 gap-2 my-4">
                    ${Ae("Max Hull",t.maxHealth)}
                    ${Ae("Max Fuel",t.maxFuel)}
                    ${Ae("Cargo Hold",t.cargoCapacity)}
                </div>
                <div class="flavor-text-box mt-auto" style="border-color: var(--frame-border-color);">
                    <p class="text-sm text-gray-300">${t.lore}</p>
                </div>
            </div>
        `}function Fe(d,e,t,i,a){if(i){let s=t.activeShipId===d,o=t.ownedShipIds.length>1&&!s,r=Math.floor(e.price*C.SHIP_SELL_MODIFIER);return`
            <div class="grid grid-cols-2 gap-2">
                <button class="action-button" data-action="${I.SELECT_SHIP}" data-ship-id="${d}" ${s?"disabled":""} style="background-color: ${s?"#374151":"var(--ot-cyan-base)"}; color: ${s?"var(--ot-text-secondary)":"var(--ot-bg-dark)"};">
                    <span class="font-bold">${s?"ACTIVE":"BOARD"}</span>
                </button>
                <button class="action-button" data-action="${I.SELL_SHIP}" data-ship-id="${d}" ${o?"":"disabled"} style="background-color: var(--ot-hangar-red-base);">
                    <span class="font-bold">SELL</span>
                    <span class="action-button-price font-roboto-mono">${y(r,!0)}</span>
                </button>
            </div>
        `}else{let s=t.credits>=e.price,o=a.activeBatchId?u.TUTORIAL_DATA[a.activeBatchId]?.steps.find(l=>l.stepId===a.activeStepId):null,r=a.activeBatchId==="intro_hangar"&&!o?.unlockPurchase,n=!s||r;return`
            <button class="action-button w-full justify-center" data-action="${I.BUY_SHIP}" data-ship-id="${d}" ${n?"disabled":""} style="background-color: var(--ot-green-accent);">
                <span class="font-bold">PURCHASE</span>
            </button>
        `}}function Ee(d,e,t,i){let a=t>0?e/t*100:0;return`
        <div class="spec-readout hangar-specs">
            <span class="text-xs text-right pr-2 text-gray-400">${d}</span>
            <div class="spec-bar"><div class="spec-bar-fill" style="width: ${a}%; background-color: ${i}; --bar-color: ${i};"></div></div>
            <span class="text-xs text-left pl-2">${Math.floor(e??0)}/${t}</span>
        </div>
    `}function Ae(d,e){return`
        <div class="spec-card">
            <p class="text-xs text-gray-400">${d}</p>
            <p class="text-lg font-bold font-orbitron">${e}</p>
        </div>
    `}function je(d,e,t,i){return`<div class="market-scroll-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${u.COMMODITIES.filter(o=>o.tier<=d.player.revealedTier).map(o=>rt(o,d,t,i)).join("")}</div>
            </div>`}function rt(d,e,t,i){let{player:a,market:s,currentLocationId:o,tutorials:r,uiState:n}=e,l=a.inventories[a.activeShipId]?.[d.id],c=t(e,d.id),h=t(e,d.id,!0),m=s.galacticAverages[d.id],p=s.inventory[o]?.[d.id],g=!d.licenseId||a.unlockedLicenseIds.includes(d.licenseId),S=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_2",f=r.activeBatchId==="intro_missions"&&r.activeStepId==="mission_2_3",T=S&&d.id!==E.PLASTEEL||f,_=`data-tooltip="${d.lore}"`,x=l&&l.quantity>0?l.quantity:"0",O=n.marketCardMinimized[d.id],R,k="";if(g){let w=W({price:c,sellPrice:h,galacticAvg:m,playerItem:l}),B=l&&l.quantity>0?`<div class="avg-cost-display" id="avg-cost-${d.id}">Avg. Cost: ${y(l.avgCost,!1)}</div>`:"",Y=`
             <div class="transaction-controls" data-mode="${i[d.id]?.mode||"buy"}" data-good-id="${d.id}" ${T?"disabled":""}>
                <div class="toggle-switch" data-action="toggle-trade-mode" data-good-id="${d.id}">
                    <div class="toggle-thumb"></div>
                    <div class="toggle-labels"><span class="label-buy">Buy</span><span class="label-sell">Sell</span></div>
                </div>
                <div class="qty-stepper">
                    <button class="qty-down" data-action="decrement" data-good-id="${d.id}">\u25BC</button>
                    <input type="number" value="0" id="qty-${d.id}" min="0">
                    <button class="qty-up" data-action="increment" data-good-id="${d.id}">\u25B2</button>
                </div>
                <div class="action-group">
                    <button class="btn confirm-btn" data-action="confirm-trade" data-good-id="${d.id}">Confirm</button>
                    <button class="btn max-btn" data-action="set-max-trade" data-good-id="${d.id}">Max</button>
                </div>
            </div>`,z=l?.quantity>0?` (${l.quantity})`:"";k=`<button class="card-toggle-btn" data-action="${I.TOGGLE_MARKET_CARD_VIEW}" data-good-id="${d.id}">${O?"+":"\u2212"}</button>`,R=`
            <div class="max-view-content">
                <p class="font-bold commodity-name"><span class="commodity-name-tooltip" ${_}>${d.name}</span></p>
                <p class="avail-text">Avail: <span id="m-stock-${d.id}">${p.quantity}</span>, Own: <span id="p-inv-${d.id}">${x}</span></p>
                <p id="price-display-${d.id}" class="font-roboto-mono font-bold price-text" data-action="${I.SHOW_PRICE_GRAPH}" data-good-id="${d.id}" data-base-price="${c}">${y(c)}</p>
                
                <div id="effective-price-display-${d.id}" class="effective-price-display"></div>
                
                <div class="indicator-container" id="indicators-${d.id}">${w}</div>

                ${B}

                ${Y}
            </div>

            <div class="min-view-content">
                <p class="font-bold commodity-name-min">${d.name}${z}</p>
                <p class="tier-text-min">Tier ${d.tier} | ${d.cat}</p>
            </div>
        `}else{let w=`TIER ${d.tier} LICENSE`;R=`
            <div class="license-locked-content" data-action="${I.ACQUIRE_LICENSE}" data-license-id="${d.licenseId}">
                <div class="license-locked-tier-watermark">TIER ${d.tier}</div>
                
                <div class="sci-fi-lock-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </div>
                 <p class="license-required-text">${w}</p>
            </div>
        `}return`
    <div class="item-card-container ${O?"minimized":""}" id="item-card-container-${d.id}">
        ${k}
        <div class="rounded-lg border ${d.styleClass} transition-colors shadow-md">
            ${R}
        </div>
    </div>`}function Ue(){return'<div id="map-container" class="w-full h-full overflow-y-auto"></div>'}function _e(d){let e=d3.select("#map-container");if(!e.node()||!e.select("svg").empty()){console.warn("Map container not found or map already initialized.");return}let t=e.node().clientWidth;if(t<=0){console.warn("Map container width not available yet. Retrying initialization shortly."),setTimeout(()=>_e(d),100);return}let i=e.append("svg").attr("id","map-svg").attr("width","100%"),s=i.append("defs").append("radialGradient").attr("id","sun-gradient");s.append("stop").attr("offset","0%").attr("stop-color","#fef08a"),s.append("stop").attr("offset","100%").attr("stop-color","#fde047"),i.append("circle").attr("class","sun").attr("cx","50%").attr("cy",-195).attr("r",225).attr("fill","url(#sun-gradient)");let o={[v.VENUS]:1.035,[v.EARTH]:1.035,[v.LUNA]:.805,[v.MARS]:.9775,[v.BELT]:.805,[v.EXCHANGE]:.805,[v.JUPITER]:1.564,[v.SATURN]:1.46625,[v.URANUS]:1.27075,[v.NEPTUNE]:1.27075,[v.KEPLER]:.8625,[v.PLUTO]:.92},r=u.MARKETS.filter(f=>d.lastKnownState.player.unlockedLocationIds.includes(f.id)).map(f=>{let _=(f.parent?12:16)*(o[f.id]||1),x=f.distance;if(f.parent){let O=u.MARKETS.find(R=>R.id===f.parent);O&&(x=O.distance+.1)}return{...f,effectiveDistance:x,finalRadius:_}}).sort((f,T)=>f.effectiveDistance-T.effectiveDistance),n=130,l=110,h=l+(r.length-1)*n+30;i.attr("height",h);let m=new Map;r.forEach((f,T)=>{m.set(f.id,l+T*n)}),i.append("line").attr("class","central-axis").attr("x1","50%").attr("y1",0).attr("x2","50%").attr("y2",h);let p=t/2,g=i.selectAll(".poi-group").data(r).enter().append("g").attr("class","poi-group").attr("data-location-id",f=>f.id).on("click",(f,T)=>{let _=f.target;_.closest(".poi-group")&&(_.tagName==="circle"||_.tagName==="path"||_.tagName==="text")&&d.showMapDetailModal(T.id)});g.append("line").attr("class","leader-line").attr("x1","50%").attr("y1",f=>m.get(f.id)).attr("x2",(f,T)=>p+(T%2===0?-50:50)).attr("y2",f=>m.get(f.id)),g.filter(f=>f.id!==v.BELT).append("circle").attr("cx","50%").attr("cy",f=>m.get(f.id)).attr("r",f=>f.finalRadius).attr("fill",f=>f.navTheme.borderColor);let S=g.filter(f=>f.id===v.BELT);if(!S.empty()){let f=S.datum().finalRadius;S.append("path").attr("d",`M 0,${-f} L ${f},0 L 0,${f} L ${-f},0 Z`).attr("transform",T=>`translate(${p}, ${m.get(T.id)})`).attr("fill",T=>T.navTheme.borderColor)}g.append("text").attr("class","poi-label").attr("x",(f,T)=>p+(T%2===0?-56:56)).attr("y",f=>m.get(f.id)).attr("text-anchor",(f,T)=>T%2===0?"end":"start").attr("dominant-baseline","middle").text(f=>f.name)}function qe(d){let{player:e,currentLocationId:t,TRAVEL_DATA:i,tutorials:a}=d,{navLock:s}=a,o=u.MARKETS.find(c=>c.id===t),r=s&&s.screenId===A.NAVIGATION,n=r?s.enabledElementQuery:null,l=null;if(n){let c=n.match(/\[data-location-id='(.*?)'\]/);c&&c[1]&&(l=c[1])}return`
        <div class="scroll-panel navigation-scroll-panel">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            ${u.MARKETS.filter(c=>e.unlockedLocationIds.includes(c.id)).map(c=>{let h=c.id===t,m=h?null:i[t][c.id],p=r&&l&&c.id!==l,g=p?"disabled-location":"",S=h?`style="--theme-glow-color: ${o?.navTheme.borderColor};"`:"";return`<div class="location-card p-6 rounded-lg text-center flex flex-col ${h?"highlight-current":""} ${c.color} ${c.bg} ${g}" 
                                 data-action="show-launch-modal" data-location-id="${c.id}" ${p?"disabled":""} ${S}>
                        <h3 class="text-2xl font-orbitron flex-grow">${c.name}</h3>
                        <div class="location-card-footer mt-auto pt-3 border-t border-cyan-100/10">
                        ${h?'<p class="text-yellow-300 font-bold mt-2">(Currently Docked)</p>':`<div class="flex justify-around items-center text-center">
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V5z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${m.time}</span><span class="block text-xs text-gray-400">Days</span></div>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                       <div><span class="font-bold font-roboto-mono text-lg">${m.fuelCost}</span><span class="block text-xs text-gray-400">Fuel</span></div>
                                   </div>
                               </div>`}
                      </div>
                      </div>`}).join("")}
            </div>
        </div>`}function Ye(d){let{player:e,currentLocationId:t}=d;if(!e.activeShipId||!d.player.shipStates[e.activeShipId])return'<p class="text-center text-gray-500 text-lg mt-8">No active ship available for servicing.</p>';let i=u.SHIPS[e.activeShipId],a=d.player.shipStates[e.activeShipId],s=u.MARKETS.find(S=>S.id===t).fuelPrice/2;e.activePerks[M.VENETIAN_SYNDICATE]&&t===v.VENUS&&(s*=1-u.PERKS[M.VENETIAN_SYNDICATE].fuelDiscount),s=Math.round(s);let o=i.maxHealth*(C.REPAIR_AMOUNT_PER_TICK/100)*C.REPAIR_COST_PER_HP;e.activePerks[M.VENETIAN_SYNDICATE]&&t===v.VENUS&&(o*=1-u.PERKS[M.VENETIAN_SYNDICATE].repairDiscount),o=Math.round(o);let r=a.fuel/i.maxFuel*100,n=a.health/i.maxHealth*100,l=a.fuel>=i.maxFuel,c=a.health>=i.maxHealth,h=e.credits>=s,m=e.credits>=o,p=l||!h,g=c||!m;return`
        <div class="services-scroll-panel">
            <div class="flex flex-col md:flex-row justify-center items-center gap-8 max-w-4xl mx-auto mt-8">
              <div
                class="service-module w-full max-w-sm"
                style="--resource-color-rgb: 8, 217, 214; --resource-color: #08d9d6; --ot-cyan-base: #08d9d6;"
              >
                <div class="bar-housing">
                  <div class="progress-bar-container w-full h-20 rounded-lg border border-gray-800 overflow-hidden relative">
                    <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                      <span class="font-electrolize font-bold tracking-wider uppercase text-cyan-300 text-outline" style="--glow-color: #08d9d6;">Fuel</span>
                      <span class="font-mono font-bold text-white text-outline" style="--glow-color: #08d9d6;">
                        ${Math.round(a.fuel)} / ${i.maxFuel}
                      </span>
                    </div>
                    <div id="fuel-bar" class="progress-bar-fill h-full rounded-md" style="width: ${r}%; background-color: #08d9d6; --glow-color: #08d9d6; background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                  </div>
                  </div>
                <div class="control-deck flex justify-center items-center gap-4">
                  <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                    <span class="price-label text-sm engraved-text">COST</span>
                    <span class="price-digits text-base ${h?"credits-text-pulsing":"text-red-500 shadow-red-500"}">
                        ${y(s,!0)}
                    </span>
                  </div>
                  <button id="refuel-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${p?"disabled":""}>
                      <span class="engraved-text">${l?"MAX":"REFUEL"}</span>
                  </button>
                  </div>
              </div>

              <div
                class="service-module w-full max-w-sm"
                style="--resource-color-rgb: 22, 163, 74; --resource-color: #16a34a; --ot-green-accent: #16a34a; --ot-green-text-light: #22c55e;"
              >
                <div class="bar-housing">
                  <div class="progress-bar-container w-full h-20 rounded-lg border border-gray-800 overflow-hidden relative">
                    <div class="absolute inset-0 z-10 flex justify-between items-center p-1.5 px-4 text-sm pointer-events-none">
                      <span class="font-electrolize font-bold tracking-wider uppercase text-outline" style="color: var(--ot-green-text-light); --glow-color: var(--ot-green-text-light);">HULL INTEGRITY</span>
                      <span class="font-mono font-bold text-white text-outline" style="--glow-color: var(--resource-color);">
                        ${Math.round(a.health)} / ${i.maxHealth}
                      </span>
                    </div>
                    <div id="repair-bar" class="progress-bar-fill h-full rounded-md" style="width: ${n}%; background-color: var(--resource-color); --glow-color: var(--resource-color); background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 40px 40px;"></div>
                  </div>
                  </div>
                <div class="control-deck flex justify-center items-center gap-4">
                  <div class="price-display-module w-32 h-12 flex justify-between items-center px-4">
                    <span class="price-label text-sm engraved-text">COST</span>
                    <span class="price-digits text-base ${m?"credits-text-pulsing":"text-red-500 shadow-red-500"}">
                        ${y(o,!0)}
                    </span>
                  </div>
                  <button id="repair-btn" class="industrial-button w-32 h-12 flex justify-center items-center text-center p-2 text-base font-orbitron uppercase tracking-wider transition-all duration-100 ease-in-out focus:outline-none" ${g?"disabled":""}>
                      <span class="engraved-text">${c?"MAX":"REPAIR"}</span>
                  </button>
                  </div>
              </div>
            </div>
        </div>`}function Ve(d){let e=d.player.inventories[d.player.activeShipId];if(!e)return'<p class="text-center text-gray-500 text-lg">No active ship.</p>';let t=Object.entries(e).filter(([,a])=>a.quantity>0);return t.length===0?'<p class="text-center text-gray-500 text-lg">Your cargo hold is empty.</p>':`<div class="cargo-scroll-panel"><div class="cargo-grid">${t.map(([a,s])=>{let o=u.COMMODITIES.find(r=>r.id===a);return nt(o,s)}).join("")}</div></div>`}function nt(d,e){let t=V(d.styleClass);return`
        <div class="min-cargo-item" 
             style="background: ${t.gradient}; border: 2px solid ${t.hex};"
             data-action="show_cargo_detail" 
             data-good-id="${d.id}">
            
            <div class="pt-symbol" style="font-size: 2rem; color: ${t.hex}; text-shadow: 0 0 5px rgba(0,0,0,0.7);">${d.symbol.toUpperCase()}</div>
            <div class="pt-quantity text-gray-400" style="text-shadow: 1px 1px 3px #000;">(${e.quantity})</div>
        </div>
    `}function We(d,e){let t=V(d.styleClass),a={RAW:"Raw Material",IND:"Industrial Product",AGRI:"Agricultural Good",TECH:"Technology",CIV:"Civilian Commodity",BIO:"Bioware",RARE:"Exotic Material"}[d.cat]||"Unknown",o=(d.basePriceRange[0]+d.basePriceRange[1])/2*e.quantity;return`
        <div class="max-cargo-card" style="background: ${t.gradient}; border-color: ${t.hex};">
            <h3 class="text-2xl font-orbitron text-center">${d.name}</h3>
            <p class="text-sm text-center tier-type-line mb-4" style="color: ${t.hex};">Tier ${d.tier} ${a}</p>
            <p class="flavor-text">${d.lore}</p>
            <div class="avg-cost">
                <div>Avg. Cost: <span class="font-bold credits-text-pulsing">${y(e.avgCost,!0)}</span></div>
                <div>Qty Aboard: <span class="font-bold">${e.quantity}</span></div>
                <div>Avg. Value: <span class="font-bold credits-text-pulsing">${y(o,!0)}</span></div>
            </div>
        </div>
    `}function Ke(d,e){let{missions:t,currentLocationId:i}=d,{activeMissionId:a,activeMissionObjectivesMet:s}=t,o=(l,c)=>{let h="";c==="active"&&(h="mission-active"),c==="completed"&&(h="mission-complete"),c==="active"&&s&&l.completion.locationId===i&&(h+=" mission-turn-in");let m=`host-${l.host.toLowerCase().replace(/[^a-z0-9]/g,"")}`,p=l.rewards.map(g=>g.type==="credits"?`\u232C ${g.amount.toLocaleString()}`:g.type.toUpperCase()).join(", ");return`
            <div class="mission-card sci-fi-frame ${m} ${h}" data-action="show-mission-modal" data-mission-id="${l.id}">
                <div class="flex justify-between items-center w-full text-xs mb-1">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="mission-type">${l.type}</span>
                    </div>
                    <span class="mission-host">${l.host}</span>
                </div>
                <div class="flex justify-between items-end w-full">
                    <p class="font-bold text-base">${l.name}</p>
                    <span class="mission-reward">${p}</span>
                </div>
            </div>`},r="",n=a?u.MISSIONS[a]:null;return n&&(r+=o(n,"active")),e&&e.getAvailableMissions().forEach(c=>{r+=o(c,"available")}),r===""&&(r='<p class="text-center text-gray-500 text-lg">No missions available at this terminal.</p>'),`
        <div class="flex flex-col h-full">
            <h1 class="text-3xl font-orbitron text-center mb-6 text-cyan-300 flex-shrink-0">Mission Terminal</h1>
            <div class="missions-scroll-panel flex-grow min-h-0">
                <div class="space-y-3 max-w-2xl mx-auto">
                    ${r}
                </div>
            </div>
        </div>
    `}function Xe(d){let{player:e,day:t,currentLocationId:i}=d,s=u.MARKETS.find(n=>n.id===i)?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0",borderColor:"#7a9ac0"},o;if(e.debt>0){let n="";if(e.loanStartDate){let l=C.LOAN_GARNISHMENT_DAYS-(t-e.loanStartDate);l>0&&(n=`<p class="text-xs text-red-400/70 mt-2">Garnishment in ${l} days</p>`)}o=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Debt</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <button data-action="${I.PAY_DEBT}" class="btn w-full py-2 bg-red-800/80 hover:bg-red-700/80 border-red-500 font-roboto-mono" ${e.credits>=e.debt?"":"disabled"}>
                        Pay Off ${y(e.debt)}
                    </button>
                    ${n}
                </div>
            </div>`}else{let n=Math.floor(e.credits*3.5),l=Math.floor(n*.1),c=Math.floor(n*.04),m=[{key:"10000",amount:1e4,fee:600,interest:500},{key:"dynamic",...{amount:n,fee:l,interest:c}}].map(p=>`<button class="btn btn-loan w-full p-2 mt-2" data-action="${I.TAKE_LOAN}" data-loan-details='${JSON.stringify(p)}' ${e.credits<p.fee?"disabled":""}>
                        <span class="font-orbitron text-cyan-300">\u232C ${y(p.amount,!1)}</span>
                    </button>`).join("");o=`
            <div>
                <h3 class="text-2xl font-orbitron text-center mb-4">Financing</h3>
                <div class="p-4 rounded-lg flex flex-col items-center justify-center space-y-2 shadow-lg panel-border border text-center" style="border-color: ${s.borderColor}; color: ${s.textColor}; background: ${s.gradient};">
                    <div class="flex justify-center gap-4 w-full">${m}</div>
                </div>
            </div>`}let r=[...e.financeLog].reverse().map(n=>{let l=n.amount>0?"text-green-400":"text-red-400",c=n.amount>0?"+":"";return`
            <div class="log-entry">
                <span class="text-gray-400 text-center">${n.day}</span>
                <span>${n.description}</span>
                <span class="${l} text-right font-roboto-mono">${c}${y(n.amount,!1)}</span>
            </div>
        `}).join("");return`
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 h-full">
            <div class="md:col-span-1">
                ${o}
            </div>
            <div class="md:col-span-2 flex flex-col min-h-0">
                 <h3 class="text-2xl font-orbitron text-center mb-4 flex-shrink-0">Transaction Log</h3>
                 <div class="finance-log-panel p-4 rounded-lg shadow-lg panel-border border" style="border-color: ${s.borderColor}; background: ${s.gradient}; --theme-text-color: ${s.textColor};">
                    <div class="log-header" style="border-color: ${s.borderColor};">
                       <span class="text-center">Day</span>
                       <span>Description</span>
                       <span class="text-right">Amount</span>
                    </div>
                    <div class="log-entries-container">
                        ${r||'<p class="text-center p-4">No transactions recorded.</p>'}
                    </div>
                 </div>
            </div>
        </div>
    `}function ze(){return`
        <div class="sub-nav-bar">
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-codex-content">Codex</button>
            <button class="sub-nav-button" data-action="set-intel-tab" data-target="intel-market-content">Intel Market</button>
        </div>

        <div class="intel-scroll-panel">
            <div id="intel-codex-content" class="intel-tab-content">
                <div id="lore-button-container" class="lore-container w-full max-w-md flex flex-col gap-4 p-4">
                    <button class="btn btn-header" data-action="show_lore" data-lore-id="story_so_far">
                        Story So Far...
                    </button>
                    </div>
            </div>

            <div id="intel-market-content" class="intel-tab-content p-4">
                </div>
        </div>
    `}var re=class{constructor(e){this.isMobile=e,this.modal=document.getElementById("travel-animation-modal"),this.gameContainer=document.getElementById("game-container"),this.canvas=document.getElementById("travel-canvas"),this.ctx=this.canvas.getContext("2d"),this.statusText=document.getElementById("travel-status-text"),this.arrivalLore=document.getElementById("travel-arrival-lore"),this.progressBar=document.getElementById("travel-progress-bar"),this.progressContainer=document.getElementById("travel-progress-container"),this.readoutContainer=document.getElementById("travel-readout-container"),this.infoText=document.getElementById("travel-info-text"),this.hullDamageText=document.getElementById("travel-hull-damage"),this.confirmButton=document.getElementById("travel-confirm-button"),this.animationFrame=null,this.starLayers=[],this.engineParticles=[],this.celestialObjects=[]}play(e,t,i,a,s){this.modal.classList.remove("hidden"),this.modal.classList.add("dismiss-disabled");let o=t.navTheme||{gradient:"linear-gradient(to right, #06b6d4, #67e8f9)",borderColor:"#06b6d4"},r=this._lightenGradient(o.gradient);this.progressBar.style.background=r,this.progressBar.style.setProperty("--progress-glow-color",o.borderColor),this._setupInitialState(t,i),this._setupAnimationElements(e,t);let n=null,l=2500,c=h=>{n||(n=h);let m=h-n,p=Math.min(m/l,1);if(p>.8){let g=(p-.8)/.2;p=.8+(1-Math.pow(1-g,3))*.2}this._draw(p,e,t),this.progressBar.style.width=`${p*100}%`,p<1?this.animationFrame=requestAnimationFrame(c):this._onArrival(t,i,a,s)};this.animationFrame=requestAnimationFrame(c),this.confirmButton.onclick=()=>{cancelAnimationFrame(this.animationFrame),this.modal.classList.add("modal-hiding"),s&&s(),setTimeout(()=>{this.gameContainer.classList.add("fade-in")},50),setTimeout(()=>{this.modal.classList.add("hidden"),this.modal.classList.remove("modal-hiding","dismiss-disabled")},1e3)}}_lightenGradient(e){let t=e.match(/#[0-9a-f]{6}|#[0-9a-f]{3}/ig);if(!t)return e;let i=(s,o)=>{s=s.replace(/^#/,""),s.length===3&&(s=s.split("").map(h=>h+h).join(""));let r=parseInt(s,16),n=(r>>16)+o;n>255&&(n=255),n<0&&(n=0);let l=(r>>8&255)+o;l>255&&(l=255),l<0&&(l=0);let c=(r&255)+o;return c>255&&(c=255),c<0&&(c=0),"#"+(c|l<<8|n<<16).toString(16).padStart(6,"0")};return`linear-gradient(to right, ${t.map(s=>i(s,40)).join(", ")})`}_setupInitialState(e,t){this.statusText.textContent=`Traveling to ${e.name}...`,this.arrivalLore.textContent="",this.arrivalLore.style.opacity=0,this.readoutContainer.classList.add("hidden"),this.readoutContainer.style.opacity=0,this.confirmButton.style.opacity=0,this.confirmButton.disabled=!0,this.progressBar.style.width="0%"}_setupAnimationElements(e,t){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.starLayers=[this._createStarLayer(80,.5,.8),this._createStarLayer(50,1.2,1.2),this._createStarLayer(20,1.8,2)],this.engineParticles=[],this.backgroundGradient=this._getBackgroundGradient(e,t),this.celestialObjects=this._getCelestialObjects(e.id,t.id)}_createStarLayer(e,t,i){let a=[];for(let s=0;s<e;s++)a.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,radius:Math.random()*1.5,speed:t+Math.random()*(i-t),alpha:.5+Math.random()*.5});return a}_getBackgroundGradient(e,t){let a=(o=>{for(let r in u.TRAVEL_VISUALS.zones)if(u.TRAVEL_VISUALS.zones[r].locations.includes(o.id))return u.TRAVEL_VISUALS.zones[r];return u.TRAVEL_VISUALS.zones.inner_sphere})(t),s=this.ctx.createLinearGradient(0,0,0,this.canvas.height);return s.addColorStop(0,a.gradient[0]),s.addColorStop(1,a.gradient[1]),s}_getCelestialObjects(e,t){let i=`${e}_to_${t}`;return(u.TRAVEL_VISUALS.objects[i]||[]).map(s=>({...s,x:this.canvas.width+Math.random()*200,y:s.position.y*this.canvas.height}))}_draw(e,t,i){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.backgroundGradient,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.starLayers.forEach((l,c)=>{let h=e<.8?1:1-(e-.8)/.2;l.forEach(m=>{m.x-=m.speed*h,m.x<0&&(m.x=this.canvas.width),this.ctx.beginPath(),this.ctx.arc(m.x,m.y,m.radius,0,Math.PI*2),this.ctx.globalAlpha=m.alpha,this.ctx.fillStyle="#FFF",this.ctx.fill()}),c===1&&this.celestialObjects.forEach(m=>{m.x-=m.speed*h,this.ctx.font=`${40*(m.scale||1)}px sans-serif`,this.ctx.globalAlpha=.5,this.ctx.fillText(m.emoji,m.x,m.y)})}),this.ctx.globalAlpha=1;let a=60,s=a,o=this.canvas.width-a,r=this.canvas.height/2;this.ctx.font="42px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(u.LOCATION_VISUALS[t.id]||"\u2753",s,r),this.ctx.fillText(u.LOCATION_VISUALS[i.id]||"\u2753",o,r);let n=s+(o-s)*e;this.ctx.save(),this.ctx.translate(n,r),this.ctx.font="17px sans-serif",this.ctx.fillText("\u{1F680}",0,0),this.ctx.restore(),this._updateEngineParticles(n,r),this._drawEngineParticles()}_updateEngineParticles(e,t){Math.random()>.5&&this.engineParticles.push({x:e-15,y:t+(Math.random()-.5)*8,life:1,speedX:-2-Math.random()*2,speedY:(Math.random()-.5)*.5,size:Math.random()*2+1});for(let i=this.engineParticles.length-1;i>=0;i--){let a=this.engineParticles[i];a.x+=a.speedX,a.y+=a.speedY,a.life-=.05,a.life<=0&&this.engineParticles.splice(i,1)}}_drawEngineParticles(){this.engineParticles.forEach(e=>{this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.globalAlpha=e.life,this.ctx.fillStyle=`rgba(255, 220, 180, ${e.life})`,this.ctx.fill()}),this.ctx.globalAlpha=1}_onArrival(e,t,i,a){this.statusText.textContent=`Arrived at ${e.name}`,this.arrivalLore.innerHTML=e.arrivalLore||"You have arrived.",this.infoText.innerHTML=`
            <div class="text-center">
                <div>Journey Time: ${t.time} Days</div>
                <div><span class="font-bold text-sky-300">Fuel Expended: ${t.fuelCost}</span></div>
            </div>`,this.hullDamageText.className="text-sm font-roboto-mono mt-1 font-bold text-red-400",i>.01?this.hullDamageText.innerHTML=`Hull Integrity -${i.toFixed(2)}%`:this.hullDamageText.innerHTML="",this.arrivalLore.style.opacity=1,this.readoutContainer.classList.remove("hidden"),setTimeout(()=>{this.readoutContainer.style.opacity=1,this.confirmButton.style.opacity=1,this.confirmButton.disabled=!1},150)}};var ne=class{constructor(e){this.intelService=e,this.db=u}render(e,t){let i=t,{currentLocationId:a,activeIntelDeal:s,intelMarket:o}=i,r=o[a]||[],n=s!==null;if(r.length===0){e.innerHTML='<p class="text-gray-400 text-center italic p-4">No intel data available at this location.</p>';return}let l=r.map(c=>{if(c.isPurchased)return this._renderPurchasedButton(c);{let h=this.intelService.calculateIntelPrice(c);return this._renderOfferButton(c,h,n)}}).join("");e.innerHTML=`<div class="w-full max-w-md mx-auto flex flex-col gap-4">${l}</div>`}_renderPurchasedButton(e){let t=this.db.MARKETS.find(i=>i.id===e.locationId)?.name||"Unknown";return`
            <button class="btn btn-intel" 
                    data-action="show_intel_details" 
                    data-packet-id="${e.id}" 
                    data-location-id="${e.locationId}">
                ${t} - View Intel
            </button>`}_renderOfferButton(e,t,i){let a=this.db.MARKETS.find(r=>r.id===e.locationId)?.name||"Unknown",s=i?"disabled":"",o=i?"You already have an active intel deal.":`Purchase intel from ${a}`;return`
            <button class="btn btn-intel" 
                    data-action="show_intel_offer" 
                    data-packet-id="${e.id}" 
                    data-location-id="${e.locationId}" 
                    data-price="${t}" 
                    title="${o}"
                    ${s}>
                ${a} \u232C ${t.toLocaleString()}
            </button>`}};var lt={story_so_far:`
        <p>The year 2140 is the result of a single, massive corporate takeover. A century ago, the "Ad Astra Initiative" released advanced technology to all of humanity, a gift from the new Human-AI Alliance on Earth designed to kickstart our expansion into the stars. It was a promise of a new beginning, an open-source key to the solar system, ensuring the survival of all Earth life, both organic and synthetic.</p>
    
        <p>But a gift to everyone is a business opportunity for the few. The hyper-corporations, already positioned in space, immediately patented the most efficient manufacturing processes and proprietary components for this new technology. This maneuver ensured that while anyone could build a Folded-Space Drive, only the corporations could supply the high-performance parts needed to make it truly effective, creating a system-wide technological dependency that persists to this day. This technological monopoly created the "Drive-Divide," the central pillar of the new class system. Nearly all ships run on older, less efficient hardware. Very few ships employ these coveted Folded-Space Drives.</p>
        <p>The major hubs beyond Earth are sovereign, corporate-run territories where law is policy and your rights are listed in an employment contract. These scattered colonies are fierce rivals, engaged in constant economic warfare, all propped up by the interstellar supply lines maintained by the Merchant's Guild. For them, you are just another cog in the great machine of commerce.</p>
        <p>In a system owned by corporations, possessing your own ship is the only true form of freedom. Every credit earned, every successful trade, is a bet on your own skill and a step toward true sovereignty on the razor's edge of a cargo manifest.</p>
    `},le=class{constructor(e){this.logger=e,this.isMobile=window.innerWidth<=768,this.modalQueue=[],this.activeGraphAnchor=null,this.activeGenericTooltipAnchor=null,this.lastActiveScreenEl=null,this.lastKnownState=null,this.missionService=null,this.simulationService=null,this.newsTickerService=null,this.debugService=null,this.marketTransactionState={},this.activeHighlightConfig=null,this.marketScrollPosition=0,this.popperInstance=null,this.eventManager=null,this.intelService=null,this.intelMarketRenderer=null,this.effectsManager=new oe,this.travelAnimationService=new re(this.isMobile),this.navStructure={[N.SHIP]:{label:"Ship",screens:{[A.MAP]:"Map",[A.NAVIGATION]:"Navigation",[A.CARGO]:"Cargo"}},[N.STARPORT]:{label:"Starport",screens:{[A.MARKET]:"Market",[A.SERVICES]:"Services",[A.HANGAR]:"Shipyard"}},[N.DATA]:{label:"Data",screens:{[A.MISSIONS]:"Missions",[A.FINANCE]:"Finance",[A.INTEL]:"Intel"}}},this._cacheDOM(),this.getItemPrice=this.getItemPrice.bind(this),window.addEventListener("resize",this._setAppHeight)}_setAppHeight(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}triggerEffect(e,t){this.effectsManager.trigger(e,t)}setMissionService(e){this.missionService=e}setSimulationService(e){this.simulationService=e}setNewsTickerService(e){this.newsTickerService=e}setDebugService(e){this.debugService=e}setIntelService(e){this.intelService=e,this.intelMarketRenderer=new ne(e)}setEventManager(e){this.eventManager=e}resetMarketTransactionState(){this.marketTransactionState={}}_cacheDOM(){this.cache={gameContainer:document.getElementById("game-container"),navBar:document.getElementById("nav-bar"),newsTickerBar:document.getElementById("news-ticker-bar"),topBarContainer:document.getElementById("top-bar-container"),subNavBar:document.getElementById("sub-nav-bar"),stickyBar:document.getElementById("sticky-bar"),mapScreen:document.getElementById(`${A.MAP}-screen`),navigationScreen:document.getElementById(`${A.NAVIGATION}-screen`),servicesScreen:document.getElementById(`${A.SERVICES}-screen`),marketScreen:document.getElementById(`${A.MARKET}-screen`),cargoScreen:document.getElementById(`${A.CARGO}-screen`),hangarScreen:document.getElementById(`${A.HANGAR}-screen`),missionsScreen:document.getElementById(`${A.MISSIONS}-screen`),financeScreen:document.getElementById(`${A.FINANCE}-screen`),intelScreen:document.getElementById(`${A.INTEL}-screen`),graphTooltip:document.getElementById("graph-tooltip"),genericTooltip:document.getElementById("generic-tooltip"),processingModal:document.getElementById("processing-modal"),shipDetailModal:document.getElementById("ship-detail-modal"),launchModal:document.getElementById("launch-modal"),launchModalContent:document.getElementById("launch-modal-content"),cargoDetailModal:document.getElementById("cargo-detail-modal"),cargoDetailContent:document.getElementById("cargo-detail-content"),mapDetailModal:document.getElementById("map-detail-modal"),loreModal:document.getElementById("lore-modal"),loreModalContent:document.getElementById("lore-modal-content"),tutorialAnchorOverlay:document.getElementById("tutorial-anchor-overlay"),tutorialToastContainer:document.getElementById("tutorial-toast-container"),tutorialToastText:document.getElementById("tutorial-toast-text"),tutorialToastSkipBtn:document.getElementById("tutorial-toast-skip-btn"),tutorialToastNextBtn:document.getElementById("tutorial-toast-next-btn"),skipTutorialModal:document.getElementById("skip-tutorial-modal"),skipTutorialConfirmBtn:document.getElementById("skip-tutorial-confirm-btn"),skipTutorialCancelBtn:document.getElementById("skip-tutorial-cancel-btn"),tutorialHighlightOverlay:document.getElementById("tutorial-highlight-overlay"),missionStickyBar:document.getElementById("mission-sticky-bar"),stickyObjectiveText:document.getElementById("sticky-objective-text"),stickyObjectiveProgress:document.getElementById("sticky-objective-progress")}}render(e){if(!e||!e.player)return;let t=this.lastKnownState;if(this.lastKnownState=e,e.introSequenceActive&&!e.tutorials.activeBatchId)return;let i=u.MARKETS.find(a=>a.id===e.currentLocationId);i?(this.cache.topBarContainer.setAttribute("data-location-theme",i.id),this.cache.gameContainer.className=`game-container ${i.bg}`,i.navTheme&&i.navTheme.borderColor?(document.documentElement.style.setProperty("--theme-border-color",i.navTheme.borderColor),document.documentElement.style.setProperty("--theme-gradient",i.navTheme.gradient),document.documentElement.style.setProperty("--theme-text-color",i.navTheme.textColor),this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage=i.navTheme.gradient,this.cache.newsTickerBar.style.borderTopColor=i.navTheme.borderColor,this.cache.newsTickerBar.style.borderBottomColor=i.navTheme.borderColor,this.cache.newsTickerBar.style.backgroundColor="transparent")):(document.documentElement.style.removeProperty("--theme-border-color"),document.documentElement.style.removeProperty("--theme-gradient"),document.documentElement.style.removeProperty("--theme-text-color"),this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage="",this.cache.newsTickerBar.style.borderTopColor="",this.cache.newsTickerBar.style.borderBottomColor="",this.cache.newsTickerBar.style.backgroundColor=""))):this.cache.newsTickerBar&&(this.cache.newsTickerBar.style.backgroundImage="",this.cache.newsTickerBar.style.borderTopColor="",this.cache.newsTickerBar.style.borderBottomColor="",this.cache.newsTickerBar.style.backgroundColor=""),this._renderNewsTicker(),this.renderNavigation(e),this.renderActiveScreen(e,t),this.updateStickyBar(e),this.renderStickyBar(e)}_renderNewsTicker(){if(!this.newsTickerService||!this.cache.newsTickerBar||!this.newsTickerService.isDirty)return;let e=this.newsTickerService.getTickerContentHtml();if(!e){this.cache.newsTickerBar.innerHTML="",this.newsTickerService.isDirty=!1;return}this.cache.newsTickerBar.innerHTML=e;let t=this.cache.newsTickerBar.querySelector(".news-ticker-content");if(t){let i=t.innerHTML,a=t.scrollWidth;t.innerHTML=i+i;let r=Math.max(20,a/50);t.style.animationDuration=`${r}s`}this.newsTickerService.isDirty=!1}renderNavigation(e){let{player:t,currentLocationId:i,activeNav:a,activeScreen:s,lastActiveScreen:o,introSequenceActive:r,tutorials:n,subNavCollapsed:l}=e,{navLock:c}=n,h=u.MARKETS.find(R=>R.id===i),m=t.activeShipId?u.SHIPS[t.activeShipId]:null,p=t.activeShipId?t.shipStates[t.activeShipId]:null,g=t.activeShipId?t.inventories[t.activeShipId]:null,S=h?.navTheme||{gradient:"linear-gradient(135deg, #4a5568, #2d3748)",textColor:"#f0f0f0"},f=`
            <div class="context-bar" style="background: ${S.gradient}; color: ${S.textColor};">
                <span class="location-name-text">${h?.name||"In Transit"}</span>
                <span class="credit-text">${y(t.credits)}</span>
            </div>`,T=Object.keys(this.navStructure).map(R=>{let k=R===a,w=o[R]||Object.keys(this.navStructure[R].screens)[0],B=c&&c.navId!==R,j=r||B,Y=k?`background: ${S.gradient}; color: ${S.textColor};`:"";return`<div class="tab ${k?"active":""} ${j?"disabled":""}" 
 style="${Y}" data-action="${I.SET_SCREEN}" data-nav-id="${R}" data-screen-id="${w}">${this.navStructure[R].label}</div>`}).join(""),_="";if(m&&p&&g){let R=P(g),k=p.health/m.maxHealth*100,w=p.fuel/m.maxFuel*100,B=R/m.cargoCapacity*100;_=`
                <div class="status-pod">
                    <div class="status-bar-group hull-group" data-action="toggle-tooltip">
                         <span class="status-bar-label">H</span>
                        <div class="status-bar"><div class="fill hull-fill" style="width: ${k}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(p.health)}/${m.maxHealth} Hull</div>
                    </div>
                    <div class="status-bar-group fuel-group" data-action="toggle-tooltip">
                        <span class="status-bar-label">F</span>
                        <div class="status-bar"><div class="fill fuel-fill" style="width: ${w}%;"></div></div>
                        <div class="status-tooltip">${Math.floor(p.fuel)}/${m.maxFuel} Fuel</div>
                    </div>
                    <div class="status-bar-group cargo-group" data-action="toggle-tooltip">
                         <span class="status-bar-label">C</span>
                        <div class="status-bar"><div class="fill cargo-fill" style="width: ${B}%;"></div></div>
                        <div class="status-tooltip">${R}/${m.cargoCapacity} Cargo</div>
                    </div>
                </div>`}let x=`<div class="nav-wrapper">${T}${_}</div>`,O=Object.keys(this.navStructure).map(R=>{let k=this.navStructure[R].screens,w=R===a,B=Object.keys(k).map(j=>{let Y=c&&c.screenId!==j,z=j===s,Qe=r||Y,Je=z?"sub-nav-active":"",Ze=I.SET_SCREEN,Le="";return z&&(Le=`style="background: ${S.gradient}; color: ${S.textColor}; opacity: 1; font-weight: 700;"`),`<a href="#" class="${Qe?"disabled":""} ${Je}" ${Le} data-action="${Ze}" data-nav-id="${R}" data-screen-id="${j}" draggable="false">${k[j]}</a>`}).join("");return`<div class="nav-sub ${!w||l?"hidden":""}" id="${R}-sub">${B}</div>`}).join("");this.cache.navBar.innerHTML=f+x,this.cache.subNavBar.innerHTML=O}renderActiveScreen(e,t){let i=this.cache[`${e.activeScreen}Screen`];switch(this.lastActiveScreenEl&&this.lastActiveScreenEl!==i&&this.lastActiveScreenEl.classList.remove("active-screen"),i&&(i.classList.add("active-screen"),this.lastActiveScreenEl=i),e.activeScreen){case A.MAP:this.cache.mapScreen.innerHTML=Ue(),requestAnimationFrame(()=>_e(this));break;case A.NAVIGATION:this.cache.navigationScreen.innerHTML=qe(e);break;case A.SERVICES:this.cache.servicesScreen.innerHTML=Ye(e),this.eventManager&&this.eventManager.holdEventHandler.bindHoldEvents();break;case A.MARKET:this.updateMarketScreen(e);break;case A.CARGO:this.cache.cargoScreen.innerHTML=Ve(e);break;case A.HANGAR:{(!t||t.activeScreen!==A.HANGAR||t.uiState.hangarShipyardToggleState!==e.uiState.hangarShipyardToggleState||t.player.activeShipId!==e.player.activeShipId||t.uiState.lastTransactionTimestamp!==e.uiState.lastTransactionTimestamp||t&&t.tutorials.activeBatchId!==e.tutorials.activeBatchId||t&&t.tutorials.activeStepId!==e.tutorials.activeStepId)&&(this.cache.hangarScreen.innerHTML=Ge(e,this.simulationService)),this._updateHangarScreen(e);break}case A.MISSIONS:this.cache.missionsScreen.innerHTML=Ke(e,this.missionService);break;case A.FINANCE:this.cache.financeScreen.innerHTML=Xe(e);break;case A.INTEL:if((!t||t.activeScreen!==A.INTEL)&&(this.cache.intelScreen.innerHTML=ze()),this.intelMarketRenderer){let s=this.cache.intelScreen.querySelector("#intel-market-content");s&&this.intelMarketRenderer.render(s,e)}this.updateIntelTab(e.uiState.activeIntelTab);break}}_updateHangarScreen(e){let{uiState:t}=e,i=this.cache.hangarScreen;if(!i)return;let a=i.querySelector("#hangar-carousel");if(!a)return;let o=t.hangarShipyardToggleState==="hangar"?t.hangarActiveIndex||0:t.shipyardActiveIndex||0;a.style.transform=`translateX(-${o*100}%)`,this._renderHangarPagination(e);let r=i.querySelector("#hangar-pagination-wrapper"),n=i.querySelector(".pagination-dot.active");if(r&&n){let l=r.clientWidth,c=n.offsetLeft,h=n.offsetWidth,m=c-l/2+h/2;r.scrollTo({left:m,behavior:"smooth"})}}_renderHangarPagination(e){let{uiState:t,player:i,currentLocationId:a}=e,s=this.cache.hangarScreen;if(!s)return;let o=s.querySelector("#hangar-pagination");if(!o)return;let r=t.hangarShipyardToggleState==="hangar",l=(r?i.ownedShipIds:this.simulationService._getShipyardInventory().map(([f])=>f)).length;if(l<=1){o.innerHTML="";return}let c=r?t.hangarActiveIndex||0:t.shipyardActiveIndex||0,m=u.MARKETS.find(f=>f.id===a)?.navTheme||{borderColor:"#7a9ac0"},p=6,g=[];if(l<=p+1)for(let f=0;f<l;f++)g.push({index:f,isActive:f===c,isHalf:!1});else{let f,T,_=c<p-1,x=c>l-p;_?(f=0,T=p):x?(f=l-p,T=l):(f=c-Math.floor(p/2)+1,T=c+Math.ceil(p/2)),f>0&&g.push({isHalf:!0,jump:"prev"});for(let O=f;O<T;O++)g.push({index:O,isActive:O===c,isHalf:!1});T<l&&g.push({isHalf:!0,jump:"next"})}let S=g.map(f=>{let T=`
                --theme-color-primary: ${m.borderColor};
                --theme-glow-color: ${m.borderColor};
            `;return f.isHalf?`<div class="pagination-dot half" style="${T}" data-action="${I.SET_HANGAR_PAGE}" data-jump-direction="${f.jump}"></div>`:`<div class="pagination-dot ${f.isActive?"active":""}" style="${T}" data-action="${I.SET_HANGAR_PAGE}" data-index="${f.index}"></div>`}).join("");o.innerHTML=S}updateStickyBar(e){this.cache.stickyBar.innerHTML="",this.cache.topBarContainer.classList.remove("has-sticky-bar")}updateServicesScreen(e){if(e.activeScreen!==A.SERVICES)return;let{player:t}=e,i=u.SHIPS[t.activeShipId],a=t.shipStates[t.activeShipId],s=this.cache.servicesScreen.querySelector("#fuel-bar"),o=this.cache.servicesScreen.querySelector("#refuel-btn");if(s&&o){let l=a.fuel/i.maxFuel*100;s.style.width=`${l}%`,o.disabled=a.fuel>=i.maxFuel}let r=this.cache.servicesScreen.querySelector("#repair-bar"),n=this.cache.servicesScreen.querySelector("#repair-btn");if(r&&n){let l=a.health/i.maxHealth*100;r.style.width=`${l}%`,n.disabled=a.health>=i.maxHealth}}updateMarketScreen(e){if(e.activeScreen!==A.MARKET)return;let t=this.cache.marketScreen.querySelector(".market-scroll-panel");this.lastKnownState&&this.lastKnownState.activeScreen===A.MARKET&&this.lastKnownState.currentLocationId===e.currentLocationId&&t?this.marketScrollPosition=t.scrollTop:this.marketScrollPosition=0,this._saveMarketTransactionState(),this.cache.marketScreen.innerHTML=je(e,this.isMobile,this.getItemPrice,this.marketTransactionState),this._restoreMarketTransactionState();let i=this.cache.marketScreen.querySelector(".market-scroll-panel");i&&(i.scrollTop=this.marketScrollPosition)}_saveMarketTransactionState(){if(!this.lastKnownState||this.lastKnownState.activeScreen!==A.MARKET)return;this.cache.marketScreen.querySelectorAll(".transaction-controls").forEach(t=>{let i=t.dataset.goodId,a=t.querySelector("input"),s=t.dataset.mode;a&&(this.marketTransactionState[i]={quantity:a.value,mode:s})})}_restoreMarketTransactionState(){for(let e in this.marketTransactionState){let t=this.marketTransactionState[e],i=this.cache.marketScreen.querySelector(`.transaction-controls[data-good-id="${e}"]`);if(i){let a=i.querySelector("input");a&&(a.value=t.quantity,i.setAttribute("data-mode",t.mode),this.updateMarketCardDisplay(e,parseInt(t.quantity,10)||0,t.mode))}}}getItemPrice(e,t,i=!1){return!this.simulationService||!this.simulationService.marketService?e.market.prices[e.currentLocationId]?.[t]||0:this.simulationService.marketService.getPrice(e.currentLocationId,t)}_calculateSaleDetails(e,t){let i=this.lastKnownState;if(!i)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let a=u.COMMODITIES.find(f=>f.id===e),s=i.market.inventory[i.currentLocationId][e].quantity,o=this.getItemPrice(i,e,!0),n=i.player.inventories[i.player.activeShipId]?.[e]?.avgCost||0;if(s<=0)return{totalPrice:0,effectivePricePerUnit:0,netProfit:0};let l=s*.1;if(t<=l){let f=o*t,T=n*t,_=f-T;if(_>0){let x=(i.player.activePerks[M.TRADEMASTER]?u.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);_+=_*x}return{totalPrice:f,effectivePricePerUnit:o,netProfit:_}}let c=t/s,h=0;a.tier<=2?h=Math.min(.1,(c-.1)*.2):a.tier<=5?h=Math.min(.25,(c-.1)*.5):h=Math.min(.4,(c-.1)*.8);let m=o*(1-h),p=Math.floor(m*t),g=n*t,S=p-g;if(S>0){let f=(i.player.activePerks[M.TRADEMASTER]?u.PERKS[M.TRADEMASTER].profitBonus:0)+(i.player.birthdayProfitBonus||0);S+=S*f}return{totalPrice:p,effectivePricePerUnit:m,netProfit:S}}updateMarketCardPrice(e,t){let i=this.cache.marketScreen.querySelector(`#price-display-${e}`);if(i){i.dataset.basePrice=t;let a=i.closest(".item-card-container").querySelector(".transaction-controls");a&&a.dataset.mode==="buy"&&(i.textContent=y(t))}}updateMarketCardDisplay(e,t,i){let a=this.cache.marketScreen.querySelector(`#price-display-${e}`),s=this.cache.marketScreen.querySelector(`#effective-price-display-${e}`),o=this.cache.marketScreen.querySelector(`#indicators-${e}`),r=this.cache.marketScreen.querySelector(`#avg-cost-${e}`);if(!a||!s||!o||!this.lastKnownState)return;let n=this.lastKnownState,l=parseInt(a.dataset.basePrice,10),c=n.player.inventories[n.player.activeShipId]?.[e];if(r&&r.classList.toggle("visible",i==="sell"),i==="buy")a.textContent=y(l),a.className="font-roboto-mono font-bold price-text",s.textContent="",o.innerHTML=W({price:l,sellPrice:this.getItemPrice(n,e,!0),galacticAvg:n.market.galacticAverages[e],playerItem:c});else{let{effectivePricePerUnit:h,netProfit:m}=this._calculateSaleDetails(e,t);if(t>0){let p=`\u232C ${m>=0?"+":""}${y(m,!1)}`;a.textContent=p,s.textContent=`(${y(h,!1)}/unit)`,a.className=`font-roboto-mono font-bold ${m>=0?"profit-text":"loss-text"}`}else a.textContent="\u232C +0",a.className="font-roboto-mono font-bold profit-text",s.textContent="";o.innerHTML=W({price:l,sellPrice:h||this.getItemPrice(n,e,!0),galacticAvg:n.market.galacticAverages[e],playerItem:c})}}showTravelAnimation(e,t,i,a,s){this.travelAnimationService.play(e,t,i,a,s)}queueModal(e,t,i,a=null,s={}){this.modalQueue.push({modalId:e,title:t,description:i,callback:a,options:s}),document.querySelector(".modal-backdrop:not(.hidden)")||this.processModalQueue()}processModalQueue(){if(this.modalQueue.length===0)return;let{modalId:e,title:t,description:i,callback:a,options:s}=this.modalQueue.shift(),o=document.getElementById(e);if(!o)return this.logger.error("UIManager",`Modal element with ID '${e}' not found in the DOM. Aborting modal display.`),this.processModalQueue();s.specialClass&&o.classList.add(s.specialClass),s.nonDismissible&&o.classList.add("dismiss-disabled"),s.theme?o.dataset.theme=s.theme:delete o.dataset.theme,o.dataset.dismissInside=s.dismissInside||"false",o.dataset.dismissOutside=s.dismissOutside||"false";let r=e==="mission-modal"?"mission-modal-title":e.replace("-modal","-title"),n=e==="mission-modal"?"mission-modal-description":e.replace("-modal","-description"),l=o.querySelector(`#${r}`),c=o.querySelector(`#${n}`)||o.querySelector(`#${e.replace("-modal","-scenario")}`);l&&(l.innerHTML=t),c&&(c.innerHTML=i,c.className="my-4 text-gray-300",e!=="mission-modal"&&c.classList.add("mb-6","text-lg"),(e==="event-modal"||e==="random-event-modal")&&c.classList.add("text-center"),s.contentClass&&((s.contentClass.includes("text-left")||s.contentClass.includes("text-right")||s.contentClass.includes("text-justify"))&&c.classList.remove("text-center"),c.classList.add(...s.contentClass.split(" ").filter(Boolean))));let h=()=>{this.hideModal(e),a&&a(),this.processModalQueue()};if(s.customSetup)s.customSetup(o,h);else{let m=o.querySelector("#"+e.replace("-modal","-button-container")),p;s.footer?m&&(m.innerHTML=s.footer,m.querySelectorAll("button[data-action]").forEach(g=>{g.addEventListener("click",S=>{g.dataset.action!=="buy_intel"&&h()})})):s.footer===null?m&&(m.innerHTML=""):(m?(m.innerHTML="",p=document.createElement("button"),m.appendChild(p)):p=o.querySelector("button"),p&&(p.className="btn px-6 py-2",s.buttonClass&&p.classList.add(s.buttonClass),p.innerHTML=s.buttonText||"Understood",p.onclick=h))}o.classList.remove("hidden"),o.classList.add("modal-visible")}showRandomEventModal(e,t){this.queueModal("random-event-modal",e.title,e.scenario,null,{nonDismissible:!0,customSetup:(i,a)=>{let s=i.querySelector("#random-event-choices-container");s.innerHTML="",e.choices.forEach((o,r)=>{let n=document.createElement("button");n.className="btn w-full text-center p-4 hover:bg-slate-700",n.innerHTML=o.title,n.onclick=()=>{t(e.id,r),a()},s.appendChild(n)})}})}showAgeEventModal(e,t){let i=document.getElementById("age-event-modal");i.classList.add("dismiss-disabled"),document.getElementById("age-event-title").innerHTML=e.title,document.getElementById("age-event-description").innerHTML=e.description;let a=document.getElementById("age-event-button-container");a.innerHTML="",e.choices.forEach(s=>{let o=document.createElement("button");o.className="perk-button",o.innerHTML=`<h4>${s.title}</h4><p>${s.description}</p>`,o.onclick=()=>{this.hideModal("age-event-modal"),t(s)},a.appendChild(o)}),i.classList.remove("hidden"),i.classList.add("modal-visible")}showLoreModal(e){let t=this.cache.loreModal,i=this.cache.loreModalContent;if(!t||!i){this.logger.error("UIManager","Lore modal elements not cached or found in DOM.");return}let a=lt[e];a?i.innerHTML=a:(this.logger.error("UIManager",`No lore content found for ID: ${e}`),i.innerHTML="<p>Error: Lore content not found.</p>"),i.scrollTop=0,t.classList.remove("hidden"),t.classList.add("modal-visible");let s=o=>{(o.target.closest("#lore-modal-content")||o.target.id==="lore-modal")&&(this.hideModal("lore-modal"),t.removeEventListener("click",s))};t.addEventListener("click",s)}hideModal(e){let t=document.getElementById(e);t&&!t.classList.contains("hidden")&&(t.classList.add("modal-hiding"),t.addEventListener("animationend",()=>{t.classList.add("hidden"),t.classList.remove("modal-hiding","modal-visible","dismiss-disabled","intro-fade-in"),delete t.dataset.theme,delete t.dataset.dismissInside,delete t.dataset.dismissOutside,this.modalQueue.length>0&&!document.querySelector(".modal-backdrop:not(.hidden)")&&this.processModalQueue()},{once:!0}))}showProcessingAnimation(e,t){let i=this.cache.processingModal;if(!i)return;let a=i.querySelector("#processing-title"),s=i.querySelector("#processing-progress-bar"),o=i.querySelector("#processing-status");a.textContent=`Processing application for ${e}...`,s.style.width="0%",o.textContent="",i.classList.remove("hidden"),setTimeout(()=>{s.style.width="100%"},100),setTimeout(()=>{o.textContent="Processing complete!",setTimeout(()=>{this.hideModal("processing-modal"),t&&t()},1e3)},4e3)}createFloatingText(e,t,i,a="#fde047"){let s=document.createElement("div");s.textContent=e,s.className="floating-text",s.style.left=`${t-20}px`,s.style.top=`${i-40}px`,s.style.color=a,document.body.appendChild(s),setTimeout(()=>s.remove(),2450)}showGraph(e,t){this.activeGraphAnchor=e;let i=this.cache.graphTooltip,a=e.dataset.action;if(a===I.SHOW_PRICE_GRAPH){let s=e.dataset.goodId,o=t.player.inventories[t.player.activeShipId][s];i.innerHTML=this._renderPriceGraph(s,t,o)}else a===I.SHOW_FINANCE_GRAPH&&(i.innerHTML=this._renderFinanceGraph(t));i.style.display="block",this.updateGraphTooltipPosition()}hideGraph(){this.activeGraphAnchor&&(this.cache.graphTooltip.style.display="none",this.activeGraphAnchor=null)}updateGraphTooltipPosition(){if(!this.activeGraphAnchor)return;let e=this.cache.graphTooltip;if(e.style.display==="none")return;let t=this.activeGraphAnchor.closest(".item-card-container").getBoundingClientRect(),i=e.offsetHeight,a=t.top-i-10,s=t.left;a<10&&(a=t.bottom+10),e.style.left=`${s}px`,e.style.top=`${a}px`}showGenericTooltip(e,t){this.activeGenericTooltipAnchor=e;let i=this.cache.genericTooltip;i.innerHTML=t,i.style.display="block",this.updateGenericTooltipPosition()}hideGenericTooltip(){this.activeGenericTooltipAnchor&&(this.cache.genericTooltip.style.display="none",this.activeGenericTooltipAnchor=null)}updateGenericTooltipPosition(){if(!this.activeGenericTooltipAnchor)return;let e=this.cache.genericTooltip,t=this.activeGenericTooltipAnchor.getBoundingClientRect(),i=e.offsetWidth,a=e.offsetHeight,s=t.right+10,o=t.top+t.height/2-a/2;o<10&&(o=t.bottom+10),s<10&&(s=10),s+i>window.innerWidth&&(s=window.innerWidth-i-10),e.style.left=`${s}px`,e.style.top=`${o}px`}_renderPriceGraph(e,t,i){let a=t.market.priceHistory[t.currentLocationId]?.[e];if(!a||a.length<2)return'<div class="text-gray-400 text-sm p-4">No Data Available!</div>';let s=u.COMMODITIES.find(w=>w.id===e),o=(s.basePriceRange[0]+s.basePriceRange[1])/2,r=280,n=140,l=35,c=a.map(w=>w.price),h=i?.avgCost>0?i.avgCost:null,m=[...c,o];h&&m.push(h);let p=Math.min(...m),g=Math.max(...m),S=g-p>0?g-p:1,f=w=>w/(a.length-1)*(r-l*2)+l,T=w=>n-l-(w-p)/S*(n-l*2.5),_=`<svg width="${r}" height="${n}" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#0c101d" />`;_+='<g class="grid-lines" stroke="#1f2937" stroke-width="1">',_+=`<line x1="${l}" y1="${T(g)}" x2="${l}" y2="${n-l}" /><line x1="${l}" y1="${n-l}" x2="${r-l}" y2="${n-l}" />`,_+="</g>";let x=T(o);if(_+=`<line x1="${l}" y1="${x}" x2="${r-l}" y2="${x}" stroke="#facc15" stroke-width="1" stroke-dasharray="3 3" />`,_+=`<text x="${r-l+4}" y="${x+3}" fill="#facc15" font-size="10" font-family="Roboto Mono" text-anchor="start">Avg: ${y(o,!1)}</text>`,h){let w=T(h);_+=`<line x1="${l}" y1="${w}" x2="${r-l}" y2="${w}" stroke="#34d399" stroke-width="1" stroke-dasharray="3 3" />`,_+=`<text x="${r-l+4}" y="${w+3}" fill="#34d399" font-size="10" font-family="Roboto Mono" text-anchor="start">Paid: ${y(h,!1)}</text>`}let O=a.map((w,B)=>`${f(B)},${T(w.price)}`).join(" ");_+=`<polyline fill="none" stroke="#60a5fa" stroke-width="2" points="${O}" />`;let R=a[0].day,k=a[a.length-1].day;return _+=`<text x="${l}" y="${n-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="start">Day ${R}</text>`,_+=`<text x="${r-l}" y="${n-l+15}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">Day ${k}</text>`,_+=`<text x="${l-8}" y="${T(p)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${y(p,!1)}</text>`,_+=`<text x="${l-8}" y="${T(g)+3}" fill="#9ca3af" font-size="10" font-family="Roboto Mono" text-anchor="end">${y(g,!1)}</text>`,_+="</svg>",_}showTutorialToast({step:e,onSkip:t,onNext:i,gameState:a}){let s=this.cache.tutorialToastContainer,o=s.querySelector("#tt-arrow"),r=e.anchorElement==="body",n;r?n=this.cache.tutorialAnchorOverlay:(n=document.querySelector(e.anchorElement),n||(this.logger.error("TutorialService",`Anchor element "${e.anchorElement}" not found for step "${e.stepId}". Defaulting to overlay.`),n=this.cache.tutorialAnchorOverlay)),this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null);let l=e.text;if(l.includes("{shipName}")){let g=a.player.activeShipId,S=g?u.SHIPS[g].name:"your ship";l=l.replace(/{shipName}/g,S)}if(l.includes("{playerName}")){let g=a.player.name||"Captain";l=l.replace(/{playerName}/g,g)}this.cache.tutorialToastText.innerHTML=l;let c=e.size?.width||"auto",h=e.size?.height||"auto";if(s.style.width=c,s.style.height=h,r){let g=e.positionX??50,S=e.positionY??50;s.style.left=`${g}%`,s.style.top=`${S}%`,s.style.transform="translate(-50%, -50%)",o.style.display="none",s.removeAttribute("data-popper-placement")}else{s.style.left="",s.style.top="",s.style.transform="",o.style.display="block";let g={placement:"auto",modifiers:[{name:"offset",options:{offset:[0,10]}},{name:"preventOverflow",options:{padding:{top:60,bottom:60,left:10,right:10}}},{name:"flip",options:{fallbackPlacements:["top","bottom","left","right"]}},{name:"arrow",options:{element:"#tt-arrow",padding:5}}]},S=e.popperOptions?.modifiers?.find(_=>_.name==="offset"),f=g.modifiers.filter(_=>_.name!=="offset");S?f.push(S):f.push(g.modifiers.find(_=>_.name==="offset")),e.popperOptions?.modifiers;let T={placement:e.placement||e.popperOptions?.placement||g.placement,modifiers:f};this.popperInstance=Popper.createPopper(n,s,T)}s.classList.remove("hidden");let m=e.completion.type==="INFO";this.cache.tutorialToastNextBtn.classList.toggle("hidden",!m),m&&(this.cache.tutorialToastNextBtn.onclick=i);let p=!1;this.cache.tutorialToastSkipBtn.style.display=p?"block":"none",this.cache.tutorialToastSkipBtn.onclick=t,this.cache.tutorialToastText.scrollTop=0,this.debugService&&this.debugService.setActiveTutorialStep(e)}hideTutorialToast(){this.cache.tutorialToastContainer.classList.add("hidden"),this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null),this.applyTutorialHighlight(null),this.debugService&&this.debugService.clearActiveTutorialStep()}updateTutorialPopper(e){let t=this.cache.tutorialToastContainer,i=t.querySelector("#tt-arrow"),{isOverlayAnchor:a,width:s,height:o,percentX:r,percentY:n,placement:l,distance:c,skidding:h}=e;if(t.style.width=s>0?`${s}px`:"auto",t.style.height=o>0?`${o}px`:"auto",a)this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null,t.removeAttribute("data-popper-placement"),t.style.transform=""),t.style.left=`${r}%`,t.style.top=`${posY}%`,t.style.transform="translate(-50%, -50%)",i.style.display="none";else{t.style.left="",t.style.top="",t.style.transform="",i.style.display="block";let m={placement:l,modifiers:[{name:"offset",options:{offset:[h,c]}},{name:"preventOverflow",options:{padding:{top:60,bottom:60,left:10,right:10}}},{name:"flip",options:{fallbackPlacements:["top","bottom","left","right"]}},{name:"arrow",options:{element:"#tt-arrow",padding:5}}]};this.popperInstance?this.popperInstance.setOptions(m).catch(p=>{this.logger.error("UIManager","Error updating Popper options:",p)}):this.logger.warn("UIManager","Popper instance needed but not found during update. Re-trigger toast if anchor type changed.")}}applyTutorialHighlight(e){this.activeHighlightConfig=e,this._renderHighlightsFromConfig(this.activeHighlightConfig)}_renderHighlightsFromConfig(e){let t=this.cache.tutorialHighlightOverlay;if(t){if(t.innerHTML="",!e){t.classList.add("hidden");return}t.classList.remove("hidden"),e.forEach(i=>{let a=document.createElement("div");a.className="tutorial-cue",a.style.left=`${i.x}px`,a.style.top=`${i.y}px`,a.style.width=`${i.width}px`,a.style.height=`${i.height}px`,a.style.transform=`rotate(${i.rotation}deg)`,a.style.opacity=i.style.opacity,i.style.animation!=="None"&&a.classList.add(`anim-${i.style.animation.toLowerCase()}`);let s="";i.type==="Shape"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 ${i.width} ${i.height}" preserveAspectRatio="none" style="overflow: visible;">
                        ${i.shapeType==="Rectangle"?`<rect x="0" y="0" width="100%" height="100%" rx="${i.style.borderRadius}" ry="${i.style.borderRadius}" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`:`<ellipse cx="50%" cy="50%" rx="50%" ry="50%" style="fill:${i.style.fill}; stroke:${i.style.stroke}; stroke-width:${i.style.strokeWidth}px;" />`}
                    </svg>`:i.type==="Arrow"?s=`
                    <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none" style="overflow: visible;">
                        <defs>
                            <marker id="arrowhead-player" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="${i.style.stroke}" />
                            </marker>
                        </defs>
                        <line x1="0" y1="25" x2="90" y2="25" stroke="${i.style.stroke}" stroke-width="${i.style.strokeWidth}" marker-end="url(#arrowhead-player)" />
                    </svg>
                `:i.type==="Spotlight"&&(a.style.borderRadius="50%",a.style.boxShadow=`0 0 0 9999px rgba(0,0,0,0.7), 0 0 ${i.style.glowIntensity||20}px ${i.style.glowIntensity||10}px ${i.style.glowColor||i.style.stroke}`),a.innerHTML=s;let o=a.querySelector("svg");o&&i.style.animation!=="None"&&(o.classList.add(`anim-${i.style.animation.toLowerCase()}`),o.style.setProperty("--glow-color",i.style.glowColor||i.style.stroke),o.style.setProperty("--anim-speed",`${i.style.animationSpeed}s`),o.style.setProperty("--glow-intensity",`${i.style.glowIntensity}px`)),t.appendChild(a)})}}showSkipTutorialModal(e){this.cache.skipTutorialModal.classList.remove("hidden");let i=()=>{e(),this.hideModal("skip-tutorial-modal")},a=()=>{this.hideModal("skip-tutorial-modal")};this.cache.skipTutorialConfirmBtn.onclick=i,this.cache.skipTutorialCancelBtn.onclick=a}showTutorialLogModal({seenBatches:e,onSelect:t}){let i=document.getElementById("tutorial-log-modal"),a=document.getElementById("tutorial-log-list");if(!i||!a){this.logger.error("UIManager","Tutorial log modal elements not found in DOM.");return}a.innerHTML="",e.length===0?a.innerHTML='<li class="text-gray-400 p-2 text-center">No tutorials viewed yet.</li>':e.forEach(s=>{let o=u.TUTORIAL_DATA[s];if(o){let r=document.createElement("li");r.innerHTML=`<button class="btn w-full text-center">${o.title}</button>`,r.onclick=()=>{i.classList.remove("visible"),t(s)},a.appendChild(r)}}),i.classList.add("visible")}showShipDetailModal(e,t,i){let{player:a,tutorials:s}=e,o=u.SHIPS[t],r;if(i==="shipyard"){let c=a.credits>=o.price,h=s.activeBatchId==="intro_hangar"&&s.activeStepId==="hangar_1",m=!c||h;r=`
                <div class="ship-card p-4 flex flex-col space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-orbitron text-cyan-300">${o.name}</h3>
                            <p class="text-sm text-gray-400">Class ${o.class}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-cyan-300">${y(o.price)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 flex-grow text-left">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull:</span> <span class="text-green-400">${o.maxHealth}</span></div>
                        <div><span class="text-gray-500">Fuel:</span> <span class="text-sky-400">${o.maxFuel}</span></div>
                        <div><span class="text-gray-500">Cargo:</span> <span class="text-amber-400">${o.cargoCapacity}</span></div>
                    </div>
                    <button class="btn w-full mt-2" data-action="${I.BUY_SHIP}" data-ship-id="${t}" ${m?"disabled":""}>Purchase</button>
                </div>`}else{let c=a.shipStates[t],h=a.inventories[t],m=P(h),p=t===a.activeShipId,g=a.ownedShipIds.length>1&&!p,S=Math.floor(o.price*C.SHIP_SELL_MODIFIER);r=`
                <div class="ship-card p-4 flex flex-col space-y-3 ${p?"border-yellow-400":""}">
                    <h3 class="text-xl font-orbitron text-center ${p?"text-yellow-300":"text-cyan-300"}">${o.name}</h3>
                    <p class="text-sm text-gray-400 text-center">Class ${o.class}</p>
                    <p class="text-sm text-gray-400 flex-grow text-left my-2">${o.lore}</p>
                    <div class="grid grid-cols-3 gap-x-4 text-sm font-roboto-mono text-center pt-2">
                        <div><span class="text-gray-500">Hull</span><div class="text-green-400">${Math.floor(c.health)}/${o.maxHealth}</div></div>
                        <div><span class="text-gray-500">Fuel</span><div class="text-sky-400">${Math.floor(c.fuel)}/${o.maxFuel}</div></div>
                        <div><span class="text-gray-500">Cargo</span><div class="text-amber-400">${m}/${o.cargoCapacity}</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        ${p?'<button class="btn" disabled>ACTIVE</button>':`<button class="btn" data-action="${I.SELECT_SHIP}" data-ship-id="${t}">Board</button>`}
                        <button class="btn" data-action="${I.SELL_SHIP}" data-ship-id="${t}" ${g?"":"disabled"}>Sell<br>\u232C ${y(S,!1)}</button>
                    </div>
                </div>`}let n=this.cache.shipDetailModal,l=n.querySelector("#ship-detail-content");l.innerHTML=r,n.classList.remove("hidden"),n.classList.add("modal-visible")}showLaunchModal(e){let t=this.lastKnownState;if(!t)return;let i=u.MARKETS.find(c=>c.id===e);if(!i)return;let a=i.navTheme,s=t.TRAVEL_DATA[t.currentLocationId]?.[e],o=t.player.shipStates[t.player.activeShipId];if(!s)return;let r=`
            <div class="launch-modal-wrapper panel-border" style="background: ${a.gradient}; color: ${a.textColor}; border-color: ${a.borderColor}; --theme-glow-color: ${a.borderColor};">
                <div class="flex-shrink-0">
                    <h3 class="font-orbitron">${i.name}</h3>
                    <p class="flavor-text italic">${i.launchFlavor}</p>
                </div>

                <div class="flex-grow flex items-center justify-center">
                   <button class="btn-launch-glow" data-action="travel" data-location-id="${e}" style="--launch-glow-color: ${a.borderColor};">Launch</button>
                </div>

                <div class="travel-info-text">
                    <p>Travel Time: ${s.time} Days</p>
                    <p>Fuel: ${Math.floor(o.fuel)} / ${s.fuelCost} required</p>
                </div>
            </div>`,n=this.cache.launchModal;this.cache.launchModalContent.innerHTML=r,n.classList.remove("hidden"),requestAnimationFrame(()=>{n.classList.add("modal-visible");let c=n.querySelector(".launch-modal-wrapper");c&&requestAnimationFrame(()=>{c.classList.add("is-glowing")})});let l=c=>{c.target.id==="launch-modal"&&(this.hideModal("launch-modal"),n.removeEventListener("click",l))};n.addEventListener("click",l)}showCargoDetailModal(e,t){let i=u.COMMODITIES.find(r=>r.id===t),a=e.player.inventories[e.player.activeShipId]?.[t];if(!i||!a)return;let s=this.cache.cargoDetailModal,o=this.cache.cargoDetailContent;o.innerHTML=We(i,a),s.classList.remove("hidden"),s.classList.add("modal-visible")}renderStickyBar(e){let t=this.cache.missionStickyBar,i=t.querySelector(".sticky-content"),a=this.cache.stickyObjectiveText,s=this.cache.stickyObjectiveProgress;if(e.missions.activeMissionId){let o=u.MISSIONS[e.missions.activeMissionId];if(!o.objectives||o.objectives.length===0){t.style.display="none";return}let r=e.missions.missionProgress[o.id]||{objectives:{}},n=o.objectives[0],l=r.objectives[n.goodId]?.current??0,c=n.quantity,h=u.COMMODITIES.find(S=>S.id===n.goodId).name,m=u.MARKETS.find(S=>S.id===o.completion.locationId).name;a.textContent=`Deliver ${h} to ${m}`,s.textContent=`[${l}/${c}]`;let p=`host-${o.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`,g=e.missions.activeMissionObjectivesMet&&o.completion.locationId===e.currentLocationId?"mission-turn-in":"";i.className=`sticky-content sci-fi-frame ${p} ${g}`,t.style.display="block"}else t.style.display="none"}showMissionModal(e){let t=u.MISSIONS[e];if(!t)return;let{missions:i,currentLocationId:a}=this.lastKnownState,{activeMissionId:s,activeMissionObjectivesMet:o}=i;s===e&&o&&t.completion.locationId===a?this._showMissionCompletionModal(t):this._showMissionDetailsModal(t)}_showMissionDetailsModal(e){let{missions:t,tutorials:i}=this.lastKnownState,a=t.activeMissionId===e.id,o=t.activeMissionId&&!a;e.id==="mission_tutorial_02"&&i.activeBatchId==="intro_missions"&&i.activeStepId!=="mission_2_4"&&(o=!0);let r={customSetup:(n,l)=>{let c=n.querySelector(".modal-content");c.className="modal-content sci-fi-frame flex flex-col items-center text-center";let h=`host-${e.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`;c.classList.add(h),n.querySelector("#mission-modal-type").textContent=e.type;let m=n.querySelector("#mission-modal-objectives"),p='<h6 class="font-bold text-sm uppercase tracking-widest text-gray-400 text-center">OBJECTIVES:</h6><ul class="list-disc list-inside text-gray-300">'+e.objectives.map(f=>`<li>Deliver ${f.quantity}x ${u.COMMODITIES.find(T=>T.id===f.goodId).name}</li>`).join("")+"</ul>";m.innerHTML=p,m.style.display="block";let g=n.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let f=e.rewards.map(T=>T.type==="credits"?`\u232C ${T.amount.toLocaleString()}`:T.type.toUpperCase()).join(", ");g.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-yellow-300">${f}</p>`,g.style.display="block"}else g.innerHTML="",g.style.display="none";let S=n.querySelector("#mission-modal-buttons");if(a){let f=e.isAbandonable!==!1;S.innerHTML=`<button class="btn w-full bg-red-800/80 hover:bg-red-700/80 border-red-500" data-action="abandon-mission" data-mission-id="${e.id}" ${f?"":"disabled"}>Abandon Mission</button>`}else S.innerHTML=`<button class="btn w-full" data-action="accept-mission" data-mission-id="${e.id}" ${o?"disabled":""}>Accept</button>`}};e.id==="mission_tutorial_01"&&i.activeStepId==="mission_1_1"&&(o=!0),this.queueModal("mission-modal",e.name,e.description,null,r)}_showMissionCompletionModal(e){let t={customSetup:(i,a)=>{let s=i.querySelector(".modal-content");s.className="modal-content sci-fi-frame flex flex-col items-center text-center";let o=`host-${e.host.toLowerCase().replace(/[^a-z0-N]/g,"")}`;s.classList.add(o),i.querySelector("#mission-modal-title").textContent=e.completion.title,i.querySelector("#mission-modal-type").textContent="OBJECTIVES MET",i.querySelector("#mission-modal-description").innerHTML=e.completion.text;let r=i.querySelector("#mission-modal-objectives");r.style.display="none";let n=i.querySelector("#mission-modal-rewards");if(e.rewards&&e.rewards.length>0){let c=e.rewards.map(h=>h.type==="credits"?`\u232C ${h.amount.toLocaleString()}`:h.type.toUpperCase()).join(", ");n.innerHTML=`<p class="font-roboto-mono text-sm text-gray-400 mb-1">REWARDS:</p><p class="font-orbitron text-xl text-green-300">${c}</p>`,n.style.display="block"}else n.innerHTML="",n.style.display="none";let l=i.querySelector("#mission-modal-buttons");l.innerHTML=`<button class="btn w-full btn-pulse-green" data-action="complete-mission" data-mission-id="${e.id}">${e.completion.buttonText}</button>`}};this.queueModal("mission-modal",e.completion.title,e.completion.text,null,t)}flashObjectiveProgress(){let e=this.cache.stickyObjectiveProgress;e&&(e.classList.add("objective-progress-flash"),setTimeout(()=>{e.classList.remove("objective-progress-flash")},700))}getModalIdFromEvent(e){let t=e.target.closest(".modal-backdrop");if(!t||!t.id||t.classList.contains("dismiss-disabled"))return null;let i=t.dataset.dismissInside==="true",a=t.dataset.dismissOutside==="true",s=!e.target.closest(".modal-content"),o=e.target.closest(".modal-content");return a&&s||i&&o?(t.id==="lore-modal"&&e.target.closest("#lore-modal-content")||t.id!=="lore-modal"&&!e.target.closest(".modal-content")||t.id==="lore-modal"&&!e.target.closest(".modal-content"),t.id):null}isClickInside(e,t){return e.target.closest(t)!==null}getTooltipContent(e){let t=e.target.closest("[data-tooltip]");return t?t.dataset.tooltip:null}showGameContainer(){this.cache.gameContainer.classList.remove("hidden"),this._setAppHeight(),requestAnimationFrame(()=>{this._setAppHeight()})}showMapDetailModal(e){let t=u.MARKETS.find(m=>m.id===e);if(!t)return;let i=this.cache.mapDetailModal,a=i.querySelector(".modal-content"),s=i.querySelector("#map-modal-content-container"),o=t.navTheme;a.style.background=o.gradient,a.style.setProperty("--theme-glow-color",o.borderColor),i.dataset.theme=e;let r=[],n=[];if(t.availabilityModifier)for(let[m,p]of Object.entries(t.availabilityModifier)){let g=u.COMMODITIES.find(S=>S.id===m);if(g){let S={name:g.name,style:V(g.styleClass)};p<1?r.push(S):p>1&&n.push(S)}}let l=m=>m.map(p=>`<span class="commodity-tag" style="border-color: ${p.style.hex}; background-color: ${p.style.hex}20; color: ${p.style.hex};">${p.name}</span>`).join(""),c=`
            <div class="text-center">
                <h3 class="text-3xl font-orbitron" style="color: ${o.textColor};">${t.name}</h3>
                <p class="text-lg italic imprinted-text">${t.launchFlavor}</p>
            </div>

            <div class="my-4 space-y-3">
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${o.textColor}; opacity: 0.7;">Fuel</h5>
                    <p class="font-roboto-mono imprinted-text-embedded" style="color: ${o.textColor};">${y(t.fuelPrice,!0)}/unit</p>
                </div>
                <div class="map-intel-block">
                    <h5 class="font-bold imprinted-text" style="color: ${o.textColor}; opacity: 0.7;">Station Details</h5>
                    <p class="font-roboto-mono imprinted-text-embedded" style="color: ${o.textColor};">${t.specialty||"None reported"}</p>
                </div>
            </div>

            <div class="text-center">
                <div>
                    <h5 class="font-bold imprinted-text">Exports:</h5>
                    <div>${n.length>0?l(n):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
                <div class="mt-2">
                    <h5 class="font-bold imprinted-text">Needs:</h5>
                    <div>${r.length>0?l(r):'<span class="text-gray-400">CLASSIFIED</span>'}</div>
                </div>
            </div>
        `;s.innerHTML=c,i.classList.remove("hidden"),i.classList.remove("is-glowing"),requestAnimationFrame(()=>{i.classList.add("modal-visible"),i.classList.add("is-glowing")});let h=m=>{(m.target.id==="map-detail-modal"||m.target.closest(".modal-content"))&&(this.hideMapDetailModal(),i.removeEventListener("click",h))};requestAnimationFrame(()=>{i.addEventListener("click",h)})}hideMapDetailModal(){let e=this.cache.mapDetailModal;if(e){e.classList.remove("is-glowing"),delete e.dataset.theme;let t=e.__mapDetailCloseHandler;t&&(e.removeEventListener("click",t),delete e.__mapDetailCloseHandler)}this.hideModal("map-detail-modal")}handleSetIntelTab(e){let t=e.dataset.target;t&&this.simulationService&&this.simulationService.setIntelTab(t)}updateIntelTab(e){let t=this.cache.intelScreen;if(!t)return;let i=t.querySelector(".sub-nav-bar");if(!i)return;t.querySelectorAll(".sub-nav-button").forEach(o=>o.classList.remove("active")),t.querySelectorAll(".intel-tab-content").forEach(o=>o.classList.remove("active"));let a=t.querySelector(`.sub-nav-button[data-target="${e}"]`),s=t.querySelector(`#${e}`);a&&a.classList.add("active"),s&&s.classList.add("active"),e==="intel-market-content"?i.classList.add("market-active"):i.classList.remove("market-active")}_findIntelPacket(e,t){let i=this.lastKnownState;if(!i.intelMarket[t])return this.logger.error("UIManager",`_findIntelPacket: No intelMarket for location ${t}`),null;let a=i.intelMarket[t].find(s=>s.id===e);return a||(this.logger.error("UIManager",`_findIntelPacket: Could not find packet ${e} at ${t}`),null)}_formatIntelDetails(e,t,i){let a=u.MARKETS.find(n=>n.id===t.dealLocationId)?.name||"an unknown location",s=u.COMMODITIES.find(n=>n.id===t.commodityId)?.name||"a mystery commodity",o=`${Math.floor(t.discountPercent*100)}%`,r=`${i.toLocaleString()} \u232C`;return e.replace(/\[location name\]/g,a).replace(/\[commodity name\]/g,s).replace(/\[discount amount %\]/g,o).replace(/\[durationDays\]/g,t.durationDays).replace(/\[ credit price\]/g,r)}handleShowIntelOffer(e){let{packetId:t,locationId:i,price:a}=e.dataset,s=this._findIntelPacket(t,i);if(!s)return;let o=u.MARKETS.find(c=>c.id===s.dealLocationId)?.name||"a distant market",r=(K[s.messageKey]?.sample||"Intel available at [location name].").replace("[location name]",o),n=parseInt(a,10),l=`
            <button class="btn btn-intel-buy" 
                    data-action="buy_intel" 
                    data-packet-id="${s.id}" 
                    data-location-id="${i}" 
                    data-price="${n}">
                Purchase Intel (${n.toLocaleString()} \u232C)
            </button>`;this.queueModal("event-modal","Intel Offer",r,null,{theme:i,dismissOutside:!0,footer:l})}handleBuyIntel(e){let{packetId:t,locationId:i,price:a}=e.dataset,s=parseInt(a,10);if(this.intelService.purchaseIntel(t,i,s)){this.hideModal("event-modal");let r=this._findIntelPacket(t,i);r&&this._showIntelDetailsModal(r,s,i)}else this.hideModal("event-modal"),this.queueModal("event-modal","Purchase Failed","Unable to purchase intel. You may already have an active deal or insufficient credits.")}handleShowIntelDetails(e){let{packetId:t,locationId:i}=e.dataset,a=this._findIntelPacket(t,i);if(!a)return;let s=this.intelService.calculateIntelPrice(a);this._showIntelDetailsModal(a,s,i)}_showIntelDetailsModal(e,t,i){let a=K[e.messageKey]?.details||"No details found.",s=this._formatIntelDetails(a,e,t);this.queueModal("event-modal","Intel Unlocked",s,null,{theme:i,dismissInside:!0,dismissOutside:!0,footer:null,contentClass:"text-left"})}};var ce=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a}handle(e,t){let i=this.gameState.getState();if(t.hasAttribute("disabled"))return;let{action:a,...s}=t.dataset,o=null;switch(a){case I.BUY_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation(),this.simulationService.buyShip(r,e),o={type:"ACTION",action:I.BUY_SHIP};break}case I.SELL_SHIP:{let{shipId:r}=s;if(!r)return;e.stopPropagation(),this.simulationService.sellShip(r,e);break}case I.SELECT_SHIP:{let{shipId:r}=s;if(!r)return;this.simulationService.setActiveShip(r),o={type:"ACTION",action:I.SELECT_SHIP};break}case I.TOGGLE_HANGAR_MODE:s.mode&&this.gameState.uiState.hangarShipyardToggleState!==s.mode&&(this.gameState.uiState.hangarShipyardToggleState=s.mode,this.gameState.setState({}));break;case I.SET_HANGAR_PAGE:{let r=this.gameState.uiState.hangarShipyardToggleState==="hangar",n=r?this.gameState.uiState.hangarActiveIndex:this.gameState.uiState.shipyardActiveIndex,c=(r?i.player.ownedShipIds:this.simulationService._getShipyardInventory()).length,h,m=5;if(s.jumpDirection?s.jumpDirection==="next"?h=Math.min(c-1,n+m):h=Math.max(0,n-m):h=parseInt(s.index,10),isNaN(h))return;let p=document.getElementById("hangar-carousel");if(p){let g=Math.abs(h-n),S=Math.min(.8,.2+g*.1);p.style.transitionDuration=`${S}s`,this.simulationService.setHangarCarouselIndex(h,r?"hangar":"shipyard"),setTimeout(()=>{p&&(p.style.transitionDuration="")},S*1e3)}else this.simulationService.setHangarCarouselIndex(h,r?"hangar":"shipyard");break}case I.SET_SCREEN:{let r=e.target.tagName==="A"&&t.contains(e.target);s.navId===i.activeNav&&!r?(this.gameState.subNavCollapsed=!this.gameState.subNavCollapsed,this.uiManager.render(this.gameState.getState())):(this.gameState.subNavCollapsed=!1,this.simulationService.setScreen(s.navId,s.screenId)),o={type:"ACTION",action:I.SET_SCREEN,navId:s.navId,screenId:s.screenId};break}case I.TRAVEL:this.uiManager.hideModal("launch-modal"),this.simulationService.travelTo(s.locationId),o={type:"ACTION",action:I.TRAVEL};break;case"set-intel-tab":this.uiManager.handleSetIntelTab(t);break;case"show_intel_offer":this.uiManager.handleShowIntelOffer(t);break;case"buy_intel":this.uiManager.handleBuyIntel(t);break;case"show_intel_details":this.uiManager.handleShowIntelDetails(t);break;case"show-mission-modal":this.uiManager.showMissionModal(s.missionId),o={type:"ACTION",action:"show-mission-modal"};break;case"show_cargo_detail":this.uiManager.showCargoDetailModal(i,s.goodId);break;case"show-launch-modal":this.uiManager.showLaunchModal(s.locationId);break;case"show-map-modal":this.uiManager.showMapDetailModal(s.locationId);break;case"close-map-modal":this.uiManager.hideMapDetailModal();break;case"accept-mission":this.simulationService.missionService.acceptMission(s.missionId),this.uiManager.hideModal("mission-modal"),o={type:"ACTION",action:"accept-mission",missionId:s.missionId};break;case"abandon-mission":this.simulationService.missionService.abandonMission(),this.uiManager.hideModal("mission-modal");break;case"complete-mission":this.simulationService.missionService.completeActiveMission(),this.uiManager.hideModal("mission-modal"),o={type:"ACTION",action:"complete-mission"};break;case I.PAY_DEBT:this.simulationService.payOffDebt();break;case I.TAKE_LOAN:this.simulationService.takeLoan(JSON.parse(s.loanDetails));break;case I.PURCHASE_INTEL:this.logger.warn("ActionClickHandler","Obsolete ACTION_IDS.PURCHASE_INTEL called.");break;case I.ACQUIRE_LICENSE:this._handleAcquireLicense(s.licenseId,e);break;case I.TOGGLE_MARKET_CARD_VIEW:s.goodId&&(this.gameState.uiState.marketCardMinimized[s.goodId]=!this.gameState.uiState.marketCardMinimized[s.goodId],this.gameState.setState({}));break}o&&this.tutorialService.checkState(o)}_handleAcquireLicense(e,t){let i=u.LICENSES[e];if(i)if(i.type==="purchase"){let a=`${i.description}<br><br>Cost: <b class='hl-yellow'>${y(i.cost)}</b>`;this.uiManager.queueModal("event-modal",`Purchase ${i.name}?`,a,null,{customSetup:(s,o)=>{let r=s.querySelector("#event-button-container");r.innerHTML=`
                        <button id="confirm-license-purchase" class="btn btn-pulse-green">Confirm</button>
                        <button id="cancel-license-purchase" class="btn">Cancel</button>
                    `,s.querySelector("#confirm-license-purchase").onclick=()=>{let n=this.simulationService.purchaseLicense(e);n.success?t&&this.uiManager.createFloatingText(`-${y(i.cost,!1)}`,t.clientX,t.clientY,"#f87171"):n.error==="INSUFFICIENT_FUNDS"&&this.uiManager.queueModal("event-modal","Purchase Failed",`You cannot afford the ${y(i.cost)} fee for this license.`),o()},s.querySelector("#cancel-license-purchase").onclick=o}})}else i.type==="mission"&&this.uiManager.queueModal("event-modal",i.name,i.guidanceText)}};var de=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.uiManager=i}handleInput(e){let t=e.target.closest('.transaction-controls input[type="number"]');if(t){let i=t.closest(".transaction-controls"),{goodId:a,mode:s}=i.dataset,o=parseInt(t.value,10)||0;this.uiManager.updateMarketCardDisplay(a,o,s),this._updateMaxButtonState(i,o,s,a)}}handleClick(e,t){let{action:i}=t.dataset;switch(i){case"toggle-trade-mode":case"confirm-trade":case"set-max-trade":case I.INCREMENT:case I.DECREMENT:this._performMarketAction(t,i,e);break}}_performMarketAction(e,t,i){let a=e.closest(".transaction-controls");if(!a)return;let{goodId:s,mode:o}=a.dataset,r=a.querySelector("input"),n=this.gameState.getState();switch(t){case"toggle-trade-mode":{let l=o==="buy"?"sell":"buy";a.dataset.mode=l;let c=parseInt(r.value)||0;this.uiManager.updateMarketCardDisplay(s,c,l),this._updateMaxButtonState(a,c,l,s);break}case"confirm-trade":{let l=parseInt(r.value)||0;if(l<=0)return;let c=o==="buy"?this.simulationService.buyItem(s,l):this.simulationService.sellItem(s,l);if(c){let h=o==="buy"?this.uiManager.getItemPrice(n,s)*l:c,m=o==="buy"?`-${y(h,!1)}`:`+${y(h,!1)}`,p=o==="buy"?"#f87171":"#34d399";if(this.uiManager.createFloatingText(m,i.clientX,i.clientY,p),o==="sell"){let g={type:"ACTION",action:"sell-item",goodId:s};this.simulationService.tutorialService.checkState(g)}}break}case"set-max-trade":{let l=this.simulationService._getActiveShip(),c=this.simulationService._getActiveInventory();if(o==="sell")r.value=c[s]?.quantity||0;else{let m=this.uiManager.getItemPrice(n,s),p=l.cargoCapacity-P(c),g=m>0?Math.floor(n.player.credits/m):1/0,S=n.market.inventory[n.currentLocationId][s].quantity;r.value=Math.max(0,Math.min(p,g,S))}let h=parseInt(r.value)||0;this.uiManager.updateMarketCardDisplay(s,h,o),this._updateMaxButtonState(a,h,o,s);break}case I.INCREMENT:case I.DECREMENT:{let l=parseInt(r.value)||0,c=t===I.INCREMENT?l+1:Math.max(0,l-1);r.value=c,this.uiManager.updateMarketCardDisplay(s,c,o),this._updateMaxButtonState(a,c,o,s);break}}}_updateMaxButtonState(e,t,i,a){let s=this.gameState.getState(),o=this.simulationService._getActiveShip(),r=this.simulationService._getActiveInventory(),n;if(i==="sell")n=r[a]?.quantity||0;else{let c=this.uiManager.getItemPrice(s,a),h=o.cargoCapacity-P(r),m=c>0?Math.floor(s.player.credits/c):1/0,p=s.market.inventory[s.currentLocationId][a].quantity;n=Math.max(0,Math.min(h,m,p))}let l=e.querySelector(".max-btn");t>0&&t===n?l.classList.add("pressed"):l.classList.remove("pressed")}};var he=class{constructor(e,t){this.playerActionService=e,this.uiManager=t,this.refuelBtn=null,this.repairBtn=null,this.isRefueling=!1,this.isRepairing=!1,this.holdInterval=400,this.lastTickTime=0,this.animationFrameId=null,this.activeElementId=null,this.stopTimers={fuel:null,repair:null},this._boundHandleInteractionStart=this._handleInteractionStart.bind(this),this._boundHandleInteractionStop=this._handleInteractionStop.bind(this),this._boundHandlePointerMove=this._handlePointerMove.bind(this),this._boundLoop=this._loop.bind(this),this._boundStartRefueling=this._startRefueling.bind(this),this._boundStopRefueling=this._stopRefueling.bind(this),this._boundStartRepairing=this._startRepairing.bind(this),this._boundStopRepairing=this._stopRepairing.bind(this),this._boundStopStepperHold=this._stopStepperHold.bind(this),this.isStepperHolding=!1,this.stepperInitialDelay=1e3,this.stepperRepeatRate=1e3/7,this.stepperTimeout=null,this.stepperInterval=null,this.stepperStartTime=null,this.stepperTarget=null}bindHoldEvents(){document.body.removeEventListener("pointerdown",this._boundHandleInteractionStart),document.body.addEventListener("pointerdown",this._boundHandleInteractionStart),window.removeEventListener("pointerup",this._boundHandleInteractionStop,{capture:!0}),window.addEventListener("pointerup",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("pointercancel",this._boundHandleInteractionStop,{capture:!0}),window.addEventListener("pointercancel",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("pointermove",this._boundHandlePointerMove),window.addEventListener("pointermove",this._boundHandlePointerMove,{passive:!1}),document.body.removeEventListener("mousedown",this._boundHandleInteractionStart),document.body.removeEventListener("touchstart",this._boundHandleInteractionStart),window.removeEventListener("mouseup",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchend",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchcancel",this._boundHandleInteractionStop,{capture:!0}),window.removeEventListener("touchmove",this._boundHandlePointerMove)}_handleInteractionStart(e){if(this.activeElementId||this.stepperTarget)return;let t=e.target.closest("#refuel-btn");if(t&&!t.disabled){this._startRefueling(e);return}let i=e.target.closest("#repair-btn");if(i&&!i.disabled){this._startRepairing(e);return}let a=e.target.closest(".qty-stepper button");if(a&&!a.disabled){e.pointerType==="touch"&&e.preventDefault(),this._startStepperHold(e,a);return}}_handleInteractionStop(e){this.activeElementId==="refuel-btn"?this._stopRefueling():this.activeElementId==="repair-btn"?this._stopRepairing():this.stepperTarget&&this._stopStepperHold()}_handlePointerMove(e){if(this.activeElementId!=="refuel-btn"&&this.activeElementId!=="repair-btn"||e.pointerType!=="touch")return;let t=document.elementFromPoint(e.clientX,e.clientY);if(!t){this.activeElementId==="refuel-btn"&&this._stopRefueling(),this.activeElementId==="repair-btn"&&this._stopRepairing();return}if(t.classList.contains("floating-text"))return;let i=document.getElementById(this.activeElementId);t===i||i&&i.contains(t)||(this.activeElementId==="refuel-btn"&&this._stopRefueling(),this.activeElementId==="repair-btn"&&this._stopRepairing())}_loop(e){if(!this.isRefueling&&!this.isRepairing){this.animationFrameId=null;return}let t=!1;if(e-this.lastTickTime>=this.holdInterval){this.lastTickTime=e;let i=0;if(this.refuelBtn=document.getElementById("refuel-btn"),this.repairBtn=document.getElementById("repair-btn"),this.isRefueling)if(i=this.playerActionService.refuelTick(),this._applyVisuals("fuel"),i>0&&this.refuelBtn){let a=this.refuelBtn.getBoundingClientRect();this.uiManager.createFloatingText(`-${y(i,!1)}`,a.left+a.width/2,a.top,"#f87171"),t=!0}else this.isRefueling=!1;if(this.isRepairing)if(i=this.playerActionService.repairTick(),this._applyVisuals("repair"),i>0&&this.repairBtn){let a=this.repairBtn.getBoundingClientRect();this.uiManager.createFloatingText(`-${y(i,!1)}`,a.left+a.width/2,a.top,"#f87171"),t=!0}else this.isRepairing=!1;t||(!this.isRefueling&&this.activeElementId==="refuel-btn"&&this._removeVisualsWithDelay("fuel"),!this.isRepairing&&this.activeElementId==="repair-btn"&&this._removeVisualsWithDelay("repair"))}this.isRefueling||this.isRepairing?this.animationFrameId=requestAnimationFrame(this._boundLoop):this.animationFrameId=null}_applyVisuals(e){e==="fuel"&&this.stopTimers.fuel&&(clearTimeout(this.stopTimers.fuel),this.stopTimers.fuel=null),e==="repair"&&this.stopTimers.repair&&(clearTimeout(this.stopTimers.repair),this.stopTimers.repair=null);let t=document.getElementById("refuel-btn"),i=document.getElementById("repair-btn"),a=e==="fuel"?t:i,s=e==="fuel"?"fuel-bar":"repair-bar";if(a){a.classList.add("holding");let o=a.closest(".service-module");o&&o.classList.add("active-service");let r=document.getElementById(s);if(r){r.classList.add("filling");let n=r.closest(".progress-bar-container");n&&n.classList.add("active-pulse")}}}_removeVisualsWithDelay(e){e==="fuel"?(this.stopTimers.fuel&&clearTimeout(this.stopTimers.fuel),this.stopTimers.fuel=setTimeout(()=>{this._removeVisuals("fuel"),this.stopTimers.fuel=null},400)):e==="repair"&&(this.stopTimers.repair&&clearTimeout(this.stopTimers.repair),this.stopTimers.repair=setTimeout(()=>{this._removeVisuals("repair"),this.stopTimers.repair=null},400))}_removeVisuals(e){let t=document.getElementById("refuel-btn"),i=document.getElementById("repair-btn"),a=e==="fuel"?t:i,s=e==="fuel"?"fuel-bar":"repair-bar";if(a){a.classList.remove("holding");let o=a.closest(".service-module");o&&o.classList.remove("active-service");let r=document.getElementById(s);if(r){r.classList.remove("filling");let n=r.closest(".progress-bar-container");n&&n.classList.remove("active-pulse")}}}_startRefueling(e){if(!(e.button&&e.button!==0)&&(e.pointerType==="touch"&&e.preventDefault(),this.refuelBtn=e.target.closest("#refuel-btn"),!!this.refuelBtn)){try{this.refuelBtn.setPointerCapture(e.pointerId)}catch{}this.activeElementId=this.refuelBtn.id,this.isRefueling=!0,this._applyVisuals("fuel"),this.lastTickTime=performance.now()-this.holdInterval,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(this._boundLoop))}}_stopRefueling(){if(this.activeElementId!=="refuel-btn")return;let e=document.getElementById(this.activeElementId);if(e&&e.hasPointerCapture(1))try{}catch{}this.activeElementId=null,this.isRefueling=!1,this._removeVisualsWithDelay("fuel")}_startRepairing(e){if(!(e.button&&e.button!==0)&&(e.pointerType==="touch"&&e.preventDefault(),this.repairBtn=e.target.closest("#repair-btn"),!!this.repairBtn)){try{this.repairBtn.setPointerCapture(e.pointerId)}catch{}this.activeElementId=this.repairBtn.id,this.isRepairing=!0,this._applyVisuals("repair"),this.lastTickTime=performance.now()-this.holdInterval,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(this._boundLoop))}}_stopRepairing(){this.activeElementId==="repair-btn"&&(this.activeElementId=null,this.isRepairing=!1,this._removeVisualsWithDelay("repair"))}_startStepperHold(e,t){this._stopStepperHold(),this.isStepperHolding=!1;let i=t.closest(".transaction-controls");if(!i)return;try{t.setPointerCapture(e.pointerId)}catch{}let a=t.closest(".qty-stepper"),s=i.querySelector("input"),o=t.classList.contains("qty-up")?1:-1;this.stepperTarget={input:s,direction:o,element:a,button:t,pointerId:e.pointerId},this.stepperTimeout=setTimeout(()=>{this.isStepperHolding=!0,this.stepperStartTime=Date.now(),this.stepperTarget&&this.stepperTarget.element&&this.stepperTarget.element.classList.add("stepper-active"),this._stepperTick(),this.stepperInterval=setInterval(()=>this._stepperTick(),this.stepperRepeatRate)},this.stepperInitialDelay)}_stopStepperHold(){if(this.stepperTarget){if(this.stepperTarget.button&&this.stepperTarget.button.hasPointerCapture(this.stepperTarget.pointerId))try{this.stepperTarget.button.releasePointerCapture(this.stepperTarget.pointerId)}catch{}clearTimeout(this.stepperTimeout),clearInterval(this.stepperInterval),this.stepperTarget.element&&this.stepperTarget.element.classList.remove("stepper-active"),this.isStepperHolding=!1,this.stepperTimeout=null,this.stepperInterval=null,this.stepperStartTime=null,this.stepperTarget=null}}_stepperTick(){if(!this.stepperTarget){this._stopStepperHold();return}let{input:e,direction:t}=this.stepperTarget,i=(Date.now()-this.stepperStartTime)/1e3,a=1;i>5?a=25:i>2&&(a=5);let s=parseInt(e.value,10)||0;s+=a*t,e.value=Math.max(0,s),e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}};var ue=class{constructor(e,t){this.gameState=e,this.simulationService=t,this.isScrolling=!1,this.scrollTimeout=null,this.state={isDragging:!1,startX:0,startTranslate:0,currentTranslate:0,activeCarousel:null,containerWidth:0,pageCount:0,currentIndex:0,moved:!1}}handleWheel(e){if(this.isScrolling)return;let t=e.deltaY>0?"next":"prev";this.simulationService.cycleHangarCarousel(t),this.isScrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1},300)}handleDragStart(e){let t=e.target.closest(".carousel-container"),i=t?t.querySelector("#hangar-carousel"):null;if(e.target.closest(".action-button")||!i||i.children.length<=1){this.state.isDragging=!1;return}e.preventDefault();let a=this.gameState.getState(),s=a.uiState.hangarShipyardToggleState==="hangar";this.state.isDragging=!0,this.state.activeCarousel=i,this.state.startX=e.pageX??e.touches[0].pageX,this.state.containerWidth=i.parentElement.offsetWidth,this.state.pageCount=i.children.length,this.state.currentIndex=s?a.uiState.hangarActiveIndex||0:a.uiState.shipyardActiveIndex||0,this.state.startTranslate=-this.state.currentIndex*this.state.containerWidth,this.state.currentTranslate=this.state.startTranslate,this.state.moved=!1,i.style.transitionDuration="0s",document.body.style.cursor="grabbing"}handleDragMove(e){if(!this.state.isDragging)return;e.preventDefault();let i=(e.pageX??e.touches[0].pageX)-this.state.startX;this.state.currentTranslate=this.state.startTranslate+i,Math.abs(i)>10&&(this.state.moved=!0),this.state.activeCarousel&&(this.state.activeCarousel.style.transform=`translateX(${this.state.currentTranslate}px)`)}handleDragEnd(){if(!this.state.isDragging)return;let{activeCarousel:e,startTranslate:t,currentTranslate:i,currentIndex:a,containerWidth:s,pageCount:o}=this.state;if(this.state.isDragging=!1,document.body.style.cursor="default",!e)return;e.style.transitionDuration="";let r=i-t,n=a,l=s/4;r<-l&&a<o-1?n++:r>l&&a>0&&n--;let c=this.gameState.uiState.hangarShipyardToggleState;this.simulationService.setHangarCarouselIndex(n,c),setTimeout(()=>{this.state.moved=!1},50)}wasMoved(){return this.state.moved}};var me=class{constructor(e,t){this.gameState=e,this.uiManager=t,this.activeTooltipTarget=null,this.activeStatusTooltip=null}handleClick(e){let t=e.target.closest("[data-action]");if(this.activeStatusTooltip&&!this.uiManager.isClickInside(e,'[data-action="toggle-tooltip"]')&&(this.activeStatusTooltip.classList.remove("visible"),this.activeStatusTooltip=null),this.uiManager.isClickInside(e,"#graph-tooltip, #generic-tooltip")){this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null;return}if(this.activeTooltipTarget&&t!==this.activeTooltipTarget&&(this.uiManager.hideGraph(),this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null),t){let{action:i}=t.dataset;switch(i){case"toggle-tooltip":this._toggleStatusTooltip(t);return;case I.SHOW_PRICE_GRAPH:case I.SHOW_FINANCE_GRAPH:this.uiManager.isMobile&&(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget===t?(this.uiManager.hideGraph(),this.activeTooltipTarget=null):(this.uiManager.showGraph(t,this.gameState.getState()),this.activeTooltipTarget=t));break}}this.uiManager.isMobile&&this._handleMobileTooltip(e),this._handleLoreAndTutorialLog(e)}handleMouseOver(e){if(this.uiManager.isMobile)return;let t=e.target.closest(`[data-action="${I.SHOW_PRICE_GRAPH}"], [data-action="${I.SHOW_FINANCE_GRAPH}"]`);t&&this.uiManager.showGraph(t,this.gameState.getState())}handleMouseOut(e){if(this.uiManager.isMobile)return;e.target.closest(`[data-action="${I.SHOW_PRICE_GRAPH}"], [data-action="${I.SHOW_FINANCE_GRAPH}"]`)&&this.uiManager.hideGraph()}_toggleStatusTooltip(e){let t=e.querySelector(".status-tooltip");t&&(this.activeStatusTooltip===t?(t.classList.remove("visible"),this.activeStatusTooltip=null):(this.activeStatusTooltip&&this.activeStatusTooltip.classList.remove("visible"),t.classList.add("visible"),this.activeStatusTooltip=t))}_handleMobileTooltip(e){let t=e.target.closest("[data-tooltip]");t&&!t.closest('[data-action="toggle-tooltip"]')&&(this.uiManager.hideGraph(),this.activeTooltipTarget===t?(this.uiManager.hideGenericTooltip(),this.activeTooltipTarget=null):(this.uiManager.showGenericTooltip(t,t.dataset.tooltip),this.activeTooltipTarget=t))}_handleLoreAndTutorialLog(e){let t=e.target.closest(".tutorial-container"),i=e.target.closest(".lore-container"),a=document.querySelector(".lore-tooltip.visible, .tutorial-tooltip.visible");a&&!e.target.closest(".lore-tooltip, .tutorial-tooltip")&&a.classList.remove("visible"),i&&i.querySelector(".lore-tooltip")?.classList.toggle("visible"),t&&this.uiManager.showTutorialLogModal({seenBatches:this.gameState.tutorials.seenBatchIds,onSelect:s=>this.tutorialService.triggerBatch(s)})}};var pe=class{constructor(e,t,i,a,s=null,o){this.gameState=e,this.simulationService=t,this.uiManager=i,this.tutorialService=a,this.debugService=s,this.logger=o,this.actionClickHandler=new ce(e,t,i,a),this.marketEventHandler=new de(e,t,i),this.holdEventHandler=new he(this.simulationService.playerActionService,i),this.carouselEventHandler=new ue(e,t),this.tooltipHandler=new me(e,i),this.marketActions=new Set(["toggle-trade-mode","confirm-trade","set-max-trade",I.INCREMENT,I.DECREMENT])}bindEvents(){document.body.addEventListener("click",i=>this._handleClick(i)),document.body.addEventListener("dblclick",i=>i.preventDefault()),document.body.addEventListener("mouseover",i=>this.tooltipHandler.handleMouseOver(i)),document.body.addEventListener("mouseout",i=>this.tooltipHandler.handleMouseOut(i)),document.addEventListener("keydown",i=>this._handleKeyDown(i)),document.body.addEventListener("input",i=>this.marketEventHandler.handleInput(i)),document.body.addEventListener("contextmenu",i=>i.preventDefault()),document.body.addEventListener("wheel",i=>{i.target.closest(".carousel-container")&&(i.preventDefault(),this.carouselEventHandler.handleWheel(i))},{passive:!1});let e=i=>{i.target.closest(".qty-stepper button")||this.carouselEventHandler.handleDragStart(i)};document.body.addEventListener("mousedown",e),document.body.addEventListener("touchstart",i=>{(i.target.closest("#refuel-btn")||i.target.closest("#repair-btn")||i.target.closest(".carousel-container")&&!i.target.closest(".action-button"))&&i.preventDefault(),e(i)},{passive:!1});let t=()=>{this.carouselEventHandler.handleDragEnd()};document.body.addEventListener("mouseup",t),document.body.addEventListener("mouseleave",t),document.body.addEventListener("touchend",t),document.body.addEventListener("touchcancel",t),document.body.addEventListener("mousemove",i=>this.carouselEventHandler.handleDragMove(i)),document.body.addEventListener("touchmove",i=>{this.carouselEventHandler.state.isDragging&&i.preventDefault(),this.carouselEventHandler.handleDragMove(i)},{passive:!1}),window.addEventListener("resize",()=>this.uiManager.render(this.gameState.getState())),this.uiManager.cache.missionStickyBar&&this.uiManager.cache.missionStickyBar.addEventListener("click",()=>{this.simulationService.setScreen(N.DATA,A.MISSIONS)})}_handleClick(e){if(this.carouselEventHandler.wasMoved()||this.holdEventHandler.isStepperHolding){this.holdEventHandler.isStepperHolding&&(this.holdEventHandler.isStepperHolding=!1),e.preventDefault();return}let t=this.gameState.getState(),i=e.target.closest("[data-action]");if(this.tooltipHandler.handleClick(e),i){let s=i.dataset.action;if(s===I.DEBUG_SIMPLE_START){this.debugService&&this.debugService.simpleStart();return}if(s==="show_lore"){e.preventDefault();let o=i.dataset.loreId;o&&this.uiManager.showLoreModal(o);return}this.marketActions.has(s)?this.marketEventHandler.handleClick(e,i):this.actionClickHandler.handle(e,i);return}if(t.introSequenceActive&&!t.tutorials.activeBatchId){this.simulationService.handleIntroClick(e);return}if(t.isGameOver)return;let a=this.uiManager.getModalIdFromEvent(e);a&&a!=="lore-modal"&&this.uiManager.hideModal(a)}_handleKeyDown(e){this.gameState.isGameOver||e.ctrlKey||e.metaKey||(e.key==="`"||e.key==="&")&&this.debugService&&this.debugService.toggleVisibility()}};var ge=class{constructor(e,t,i,a,s){this.gameState=e,this.uiManager=t,this.simulationService=i,this.logger=s,this.activeBatchId=null,this.activeStepId=null,this.screenToNavMap={};for(let o in a)for(let r in a[o].screens)this.screenToNavMap[r]=o}checkState(e=null){if(this.activeBatchId&&this.activeStepId){let i=u.TUTORIAL_DATA[this.activeBatchId].steps.find(a=>a.stepId===this.activeStepId);i&&this._matchesCondition(i.completion,e)&&this.advanceStep();return}for(let t in u.TUTORIAL_DATA){let i=u.TUTORIAL_DATA[t],a=this.gameState.tutorials.seenBatchIds.includes(t),s=this.gameState.tutorials.skippedTutorialBatches.includes(t);if(!a&&!s){let o=e||{type:D.SCREEN_LOAD,screenId:this.gameState.activeScreen};if(this._matchesCondition(i.trigger,o)){this.triggerBatch(t);break}}}}triggerBatch(e,t=null){if(!u.TUTORIAL_DATA[e])return;let i=u.TUTORIAL_DATA[e];if(i.trigger.type===D.SCREEN_LOAD){let s=i.trigger.screenId;if(this.gameState.activeScreen!==s){let o=this.screenToNavMap[s];o&&this.simulationService.setScreen(o,s)}}this.activeBatchId=e,this.gameState.tutorials.activeBatchId=e,this.gameState.tutorials.seenBatchIds.includes(e)||this.gameState.tutorials.seenBatchIds.push(e),this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_START",`Starting tutorial batch: ${e}`),this.gameState.setState(this.gameState),this.uiManager.render(this.gameState.getState());let a=t||i.steps[0].stepId;this._displayStep(a)}skipActiveTutorial(){this.activeBatchId&&(this.gameState.tutorials.skippedTutorialBatches.includes(this.activeBatchId)||this.gameState.tutorials.skippedTutorialBatches.push(this.activeBatchId),this.logger.info.player(this.gameState.day,"TUTORIAL_SKIP",`Skipped tutorial: ${this.activeBatchId}`),this._endBatch(),this.gameState.setState(this.gameState))}advanceStep(){if(!this.activeStepId||!this.activeBatchId)return;let t=u.TUTORIAL_DATA[this.activeBatchId].steps.find(i=>i.stepId===this.activeStepId);if(this.uiManager.hideTutorialToast(),t&&t.nextStepId)this._displayStep(t.nextStepId);else{let i=this.activeBatchId;this._endBatch(),this.gameState.introSequenceActive&&i?.startsWith("intro_")&&this.simulationService._continueIntroSequence(i)}}_displayStep(e){if(!this.activeBatchId)return;let t=u.TUTORIAL_DATA[this.activeBatchId],i=t.steps.find(a=>a.stepId===e);if(!i){this._endBatch();return}if(i.hasOwnProperty("navLock"))this.gameState.tutorials.navLock=i.navLock;else if(t.navLock){let a=this.gameState.activeScreen,s=this.screenToNavMap[a];this.gameState.tutorials.navLock={navId:s,screenId:a}}else this.gameState.tutorials.navLock=null;this.activeStepId=e,this.gameState.tutorials.activeStepId=e,this.logger.info.system("Tutorial",this.gameState.day,"STEP_DISPLAY",`Displaying step: ${e}`),this.uiManager.showTutorialToast({step:i,onSkip:()=>this.uiManager.showSkipTutorialModal(()=>this.skipActiveTutorial()),onNext:()=>this.advanceStep(),gameState:this.gameState.getState()}),this.uiManager.render(this.gameState.getState())}_endBatch(){this.logger.info.system("Tutorial",this.gameState.day,"TUTORIAL_END",`Ending tutorial batch: ${this.activeBatchId}`),this.uiManager.hideTutorialToast(),this.activeBatchId=null,this.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.navLock=null}_matchesCondition(e,t){return!e||!t?!1:Array.isArray(e)?e.every(i=>this._matchesSingleCondition(i,t)):this._matchesSingleCondition(e,t)}_matchesSingleCondition(e,t){if(e.type!==t.type)return!1;switch(e.type){case D.SCREEN_LOAD:return e.screenId===t.screenId;case D.ACTION:return e.action===I.SET_SCREEN&&t.action===I.SET_SCREEN?e.navId===t.navId&&e.screenId===t.screenId:e.action===t.action;case D.INFO:return!0;default:return!1}}};var fe=class{constructor(e,t,i){this.gameState=e,this.uiManager=t,this.logger=i,this.simulationService=null}setSimulationService(e){this.simulationService=e}arePrerequisitesMet(e){let t=u.MISSIONS[e];return!t||!t.prerequisites?!0:t.prerequisites.every(i=>{switch(i.type){case"mission_completed":return this.gameState.missions.completedMissionIds.includes(i.missionId);case"revealed_tier":return this.gameState.player.revealedTier>=i.tier;default:return!1}})}getAvailableMissions(){let{activeMissionId:e,completedMissionIds:t}=this.gameState.missions;return Object.values(u.MISSIONS).filter(i=>i.id!==e&&!t.includes(i.id)&&this.arePrerequisitesMet(i.id))}acceptMission(e){let t=u.MISSIONS[e];this.gameState.missions.activeMissionId||!t||!this.arePrerequisitesMet(e)||(this.gameState.missions.activeMissionId=e,this.gameState.missions.missionProgress[e]={objectives:{}},this.logger.info.player(this.gameState.day,"MISSION_ACCEPT",`Accepted mission: ${e}`),this.simulationService.grantMissionCargo(e),this.checkTriggers(),!t.objectives||t.objectives.length===0?this.completeActiveMission():this.uiManager.render(this.gameState.getState()))}abandonMission(){let e=this.gameState.missions.activeMissionId;e&&(this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.logger.info.player(this.gameState.day,"MISSION_ABANDON",`Abandoned mission: ${e}`),this.gameState.setState({}),this.uiManager.render(this.gameState.getState()))}checkTriggers(){let{activeMissionId:e}=this.gameState.missions;if(!e){this.gameState.missions.activeMissionObjectivesMet&&(this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}));return}let t=u.MISSIONS[e],i=this.gameState.player.inventories[this.gameState.player.activeShipId];if(!t||!i){this.gameState.missions.activeMissionObjectivesMet=!1;return}let a=!0,s=!1;t.objectives.forEach(o=>{if(o.type==="have_item"){let r=i[o.goodId]?.quantity||0,n=this.gameState.missions.missionProgress[e];n.objectives[o.goodId]||(n.objectives[o.goodId]={current:0}),n.objectives[o.goodId].current!==r&&(n.objectives[o.goodId].current=r,s=!0),r<o.quantity&&(a=!1)}}),(this.gameState.missions.activeMissionObjectivesMet!==a||s)&&(a&&!this.gameState.missions.activeMissionObjectivesMet&&this.logger.info.player(this.gameState.day,"OBJECTIVES_MET",`All objectives for mission ${e} are met.`),this.gameState.missions.activeMissionObjectivesMet=a,this.gameState.setState({}),this.uiManager.render(this.gameState.getState()),s&&this.uiManager.flashObjectiveProgress())}completeActiveMission(){let{activeMissionId:e}=this.gameState.missions;if(!e)return;let t=this.gameState.missions.activeMissionObjectivesMet,i=u.MISSIONS[e];if((!i.objectives||i.objectives.length===0)&&(this.gameState.missions.activeMissionObjectivesMet=!0),!this.gameState.missions.activeMissionObjectivesMet){this.gameState.missions.activeMissionObjectivesMet=t;return}let a=this.gameState.player.inventories[this.gameState.player.activeShipId];i.objectives.forEach(s=>{s.type==="have_item"&&a[s.goodId]&&(a[s.goodId].quantity-=s.quantity)}),this.simulationService&&this.simulationService._grantRewards(i.rewards,i.name),this.logger.info.player(this.gameState.day,"MISSION_COMPLETE",`Completed mission: ${e}`),this.gameState.missions.completedMissionIds.push(e),this.gameState.missions.activeMissionId=null,this.gameState.missions.activeMissionObjectivesMet=!1,this.gameState.setState({}),this.uiManager.render(this.gameState.getState())}};var $={DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},U={player:"#60a5fa",system:"#4ade80",state:"#facc15",warn:"#f59e0b",error:"#f87171",group:"#d4d4d8"},ct=100,F=$.INFO,Se=[];function X(d){Se.push(d),Se.length>ct&&Se.shift()}function Me(d,e,t,i,a,s,o=null){if(d>F)return;let r=`[${e}] [Day ${t}] ${i}: ${a}`;X(r),console.log(`%c[${e}] %c[Day ${t}] %c${i}: %c${a}`,`color: ${s}; font-weight: bold;`,"color: #9ca3af;","color: #e5e7eb; font-weight: bold;","color: inherit;",o||""),o&&console.dir(o)}var G={setLevel:d=>{let e=$[d.toUpperCase()];typeof e<"u"?(F=e,console.log(`%c[Logger] Log level set to: ${d}`,`color: ${U.state}; font-weight: bold;`)):G.warn("LoggingService",`Attempted to set invalid log level: ${d}`)},getLogHistory:()=>Se.join(`
`),info:{player:(d,e,t,i=null)=>Me($.INFO,"Player",d,e,t,U.player,i),system:(d,e,t,i,a=null)=>Me($.INFO,d,e,t,i,U.system,a),state:(d,e,t,i=null)=>Me($.INFO,"Game",d,e,t,U.state,i)},warn:(d,e)=>{if($.WARN>F)return;let t=`[${d}] WARN: ${e}`;X(t),console.warn(`%c[${d}] WARN:`,`color: ${U.warn}; font-weight: bold;`,e)},error:(d,e,t=null)=>{if($.ERROR>F)return;let i=`[${d}] ERROR: ${e}`;X(i),console.error(`%c[${d}] ERROR:`,`color: ${U.error}; font-weight: bold;`,e,t||"")},group:d=>{$.DEBUG>F||(X(`--- GROUP START: ${d} ---`),console.groupCollapsed(`%c${d}`,`color: ${U.group}; font-style: italic;`))},groupEnd:()=>{$.DEBUG>F||(console.groupEnd(),X("--- GROUP END ---"))},time:d=>{$.DEBUG>F||console.time(d)},timeEnd:d=>{$.DEBUG>F||console.timeEnd(d)}};var b={IDLE:"IDLE",MAINTENANCE:"MAINTENANCE",SELLING_HELD_CARGO:"SELLING_HELD_CARGO",SEEKING_MANIPULATION:"SEEKING_MANIPULATION",PREPARING_CRASH:"PREPARING_CRASH",EXECUTING_CRASH:"EXECUTING_CRASH",EXECUTING_EXPLOIT:"EXECUTING_EXPLOIT",SELLING_EXPLOITED_GOODS:"SELLING_EXPLOITED_GOODS",TIME_WASTER:"TIME_WASTER",SEEKING_DEPLETION:"SEEKING_DEPLETION",EXECUTING_DEPLETION:"EXECUTING_DEPLETION",WAITING_FOR_HIKE:"WAITING_FOR_HIKE",EXPLOITING_HIKE:"EXPLOITING_HIKE"},H={MIXED:"MIXED",HONEST_TRADER:"HONEST_TRADER",MANIPULATOR:"MANIPULATOR",DEPLETE_ONLY:"DEPLETE_ONLY",PROSPECTOR:"PROSPECTOR"},ye=class{constructor(e,t,i){this.gameState=e,this.simulationService=t,this.logger=i,this.isRunning=!1,this.stopRequested=!1,this.botState=b.IDLE,this.activeStrategy=H.MIXED,this.MIN_PROFIT_MARGIN=.15,this.currentObjective=null,this.plannedObjectives=[],this.metrics={totalTrades:0,profitableTrades:0,totalNetProfit:0,totalFuelCost:0,totalRepairCost:0,daysSimulated:0,profitByGood:{},objectivesStarted:0,objectivesCompleted:0,objectivesAborted:0,strategyUsed:H.MIXED},this.simulationStartDay=0}async runSimulation({daysToRun:e,strategy:t},i){if(this.isRunning){this.logger.warn("Bot","AUTOTRADER-01 is already running.");return}this.isRunning=!0,this.stopRequested=!1,this.botState=b.IDLE,this.activeStrategy=t||H.MIXED;let a=this.gameState.day,s=a+e;for(this.simulationStartDay=a,this.metrics={totalTrades:0,profitableTrades:0,totalNetProfit:0,totalFuelCost:0,totalRepairCost:0,daysSimulated:0,profitByGood:{},objectivesStarted:0,objectivesCompleted:0,objectivesAborted:0,strategyUsed:this.activeStrategy},this.logger.info.system("Bot",a,"SIMULATION_START",`Starting advanced simulation for ${e} days using strategy: ${this.activeStrategy}.`);this.gameState.day<s&&!this.stopRequested;)await this._decideNextAction(),i(this.gameState.day,s),await new Promise(o=>setTimeout(o,10));this._logSummaryReport(),this.logger.info.system("Bot",this.gameState.day,"SIMULATION_END","Simulation finished."),this.isRunning=!1}stop(){this.stopRequested=!0}async _decideNextAction(){if(!this._handleAgeEventChoice())switch(this.botState!==b.MAINTENANCE&&(!this.currentObjective||this.currentObjective.type!=="REFUEL_FOR_TRAVEL")&&this._needsMaintenance()&&(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Low resources detected. Switching to maintenance state."),this.botState=b.MAINTENANCE),this.botState){case b.IDLE:await this._evaluateOpportunities();break;case b.MAINTENANCE:await this._executeMaintenance();break;case b.SELLING_HELD_CARGO:await this._executeSellHeldCargo();break;case b.SEEKING_MANIPULATION:await this._findCrashOpportunity();break;case b.PREPARING_CRASH:await this._executePreparation();break;case b.EXECUTING_CRASH:await this._executeCrash();break;case b.EXECUTING_EXPLOIT:await this._executeExploit();break;case b.SELLING_EXPLOITED_GOODS:await this._executeSellExploited();break;case b.TIME_WASTER:await this._executeTimeWaster();break;case b.SEEKING_DEPLETION:await this._findDepletionOpportunity();break;case b.EXECUTING_DEPLETION:await this._executeDepletion();break;case b.WAITING_FOR_HIKE:await this._executeWait();break;case b.EXPLOITING_HIKE:await this._executeExploitHike();break}}async _evaluateOpportunities(){let e=this._findBestSellLocationForHeldCargo();if(e){this.currentObjective={type:"SELL_HELD_CARGO",...e},this.botState=b.SELLING_HELD_CARGO,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[HELD CARGO]: Found profitable sale for ${e.quantity}x ${e.goodId} @ ${e.sellLocationId}. Profit: ${y(e.estimatedProfit)}.`),this.metrics.objectivesStarted++;return}if(this.activeStrategy===H.MIXED||this.activeStrategy===H.MANIPULATOR){let t=this._findReadySelfExploit();if(t){this.currentObjective=t,this.botState=b.EXECUTING_EXPLOIT,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Found self-created exploit: Buy ${t.goodId} @ ${t.exploitLocationId}`),this.metrics.objectivesStarted++;return}}if(this.currentObjective){if(this.currentObjective.type==="CRASH"&&this._isCrashPlanStillValid()){this.botState=b.PREPARING_CRASH,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Continuing persistent CRASH loop for ${this.currentObjective.goodId}.`);return}else if(this.currentObjective.type!=="CRASH"&&this.currentObjective.type!=="SIMPLE_TRADE"){let t=this.currentObjective.goodId,i=this._findCrashOpportunity(t);if(i&&i.goodId&&i.buyFromLocationId&&i.crashLocationId){this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Re-validating and repeating CRASH loop for ${i.goodId}.`),this.currentObjective=i,this.botState=b.PREPARING_CRASH,this.metrics.objectivesStarted++;return}else this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`Failed to re-validate loop for ${t}. Plan is no longer viable.`)}}switch(this.currentObjective=null,this.activeStrategy){case H.HONEST_TRADER:this.botState=b.TIME_WASTER,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: HONEST_TRADER. Seeking simple trade.");break;case H.MANIPULATOR:this.botState=b.SEEKING_MANIPULATION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MANIPULATOR. Seeking new market crash opportunity.");break;case H.DEPLETE_ONLY:this.botState=b.SEEKING_DEPLETION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: DEPLETE_ONLY. Seeking new depletion opportunity.");break;case H.PROSPECTOR:let t=this._findBestSimpleTrade();t?(this.currentObjective={...t,type:"SIMPLE_TRADE",hasGoods:!1},this.botState=b.TIME_WASTER,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[PROSPECTOR]: Found simple trade. Buy ${t.goodId} @ ${t.buyLocationId} -> Sell @ ${t.sellLocationId}. Margin: ${(t.profitPerUnit/t.buyPrice*100).toFixed(1)}%. Est. PPD: ${y(t.estimatedPPD)}.`)):(this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[PROSPECTOR]: No simple trades found meeting ${this.MIN_PROFIT_MARGIN*100}% margin. Falling back to manipulation.`),this.botState=b.SEEKING_MANIPULATION);break;case H.MIXED:default:Math.random()<.25?(this.botState=b.SEEKING_DEPLETION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MIXED. Seeking new depletion opportunity.")):(this.botState=b.SEEKING_MANIPULATION,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE","Strategy: MIXED. Seeking new market crash opportunity."));break}}async _executeMaintenance(){let e=this.simulationService._getActiveShip();if(!e){this.botState=b.IDLE;return}let t=this.gameState.player.shipStates[e.id];if(this.currentObjective&&this.currentObjective.type==="REFUEL_FOR_TRAVEL"){let{needed:s,nextState:o,originalObjective:r}=this.currentObjective;if(s>e.maxFuel&&t.fuel===e.maxFuel){this.logger.error("Bot",`MAINTENANCE_FAIL: Objective requires ${s} fuel, but ship max is ${e.maxFuel}. Ship is full. Aborting objective to prevent loop.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}if(t.fuel<s){this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Executing local refuel to get ${s} fuel.`),this._botRefuel(s);return}else{this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Local refuel complete. Resuming original objective."),this.currentObjective=r,this.botState=o;return}}let i=t.fuel/e.maxFuel*100,a=t.health/e.maxHealth*100;if(i<30){if(this.gameState.currentLocationId===v.JUPITER)this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Arrived at Jupiter. Refueling."),this._botRefuel(e.maxFuel);else{let s=this.gameState.getState(),o=s.TRAVEL_DATA[s.currentLocationId][v.JUPITER],r=o?o.fuelCost||0:9999;t.fuel<r?(this.logger.warn("Bot",`Stranded at ${s.currentLocationId}. Buying expensive local fuel just to reach Jupiter.`),this._botRefuel(r+5)):(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Fuel ${i.toFixed(0)}%. Traveling to Jupiter.`),this.simulationService.travelService.initiateTravel(v.JUPITER))}return}if(a<30){this.gameState.currentLocationId!==v.LUNA?(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE",`Hull ${a.toFixed(0)}%. Traveling to Luna.`),this.simulationService.travelService.initiateTravel(v.LUNA)):(this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Arrived at Luna. Repairing."),this._botRepair());return}this.logger.info.system("Bot",this.gameState.day,"MAINTENANCE","Maintenance complete. Resuming operations."),this.botState=b.IDLE}async _executeSellHeldCargo(){let{goodId:e,sellLocationId:t,quantity:i}=this.currentObjective,a=this.gameState.getState(),s=this.simulationService._getActiveShip();if(a.currentLocationId!==t){this.logger.info.system("Bot",a.day,"SELL_HELD",`Traveling to ${t} to sell ${i}x ${e}`);let r=a.TRAVEL_DATA[a.currentLocationId][t],n=r?r.fuelCost||0:9999;if(s.fuel<n){this.logger.warn("Bot",`SELL_HELD_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:b.SELLING_HELD_CARGO,originalObjective:l},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let o=this.simulationService._getActiveInventory()[e]?.quantity||0;if(o>0){let r=this.simulationService._getActiveInventory()[e]?.avgCost||0,l=this.simulationService.playerActionService.sellItem(e,o)-r*o;this.logger.info.system("Bot",a.day,"SELL_HELD_SELL",`Sold ${o}x ${e}. Profit: ${y(l)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=l,l>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=l,this.metrics.objectivesCompleted++}else this.logger.warn("Bot",`SELL_HELD_FAIL: Arrived at ${t} but have no ${e} to sell.`),this.metrics.objectivesAborted++;this.currentObjective=null,this.botState=b.IDLE}async _findCrashOpportunity(e=null){let t=this.gameState.getState(),i=u.COMMODITIES.filter(s=>s.tier<=t.player.revealedTier&&s.tier>1);if(e&&(i=i.filter(s=>s.id===e)),i.length===0)return e||(this.botState=b.TIME_WASTER),null;let a=[];for(let s of i){let o=this._findCheapestMarket(s.id);if(!o)continue;let r=this._findBestCrashTarget(s.id,o.id);if(!r)continue;let n=s.tier*(r.price-o.price);n>0&&a.push({potential:n,plan:{type:"CRASH",goodId:s.id,buyFromLocationId:o.id,crashLocationId:r.id}})}if(a.length>0){a.sort((r,n)=>n.potential-r.potential);let s=a.slice(0,5).map(r=>r.plan),o=s[Math.floor(Math.random()*s.length)];if(e)return o;this.currentObjective=o,this.botState=b.PREPARING_CRASH,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"PLAN",`New crash plan (1 of ${s.length}): Buy ${o.goodId} @ ${o.buyFromLocationId}, Crash @ ${o.crashLocationId}`)}else return e||(this.botState=b.TIME_WASTER,this.logger.info.system("Bot",this.gameState.day,"PLAN","No good crash plans. Running simple trade.")),null}async _executePreparation(){let{goodId:e,buyFromLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"PREP",`Traveling to ${t} to buy ${e}`);let o=this.simulationService._getActiveShip(),r=i.TRAVEL_DATA[i.currentLocationId][t],n=r?r.fuelCost||0:9999;if(o.fuel<n){this.logger.warn("Bot",`PREP_FAIL: Not enough fuel (${o.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:b.PREPARING_CRASH,originalObjective:l},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=i.market.prices[t][e],s=this._calculateMaxBuy(e,a);s>0?(this.simulationService.playerActionService.buyItem(e,s),this.logger.info.system("Bot",i.day,"PREP_BUY",`Bought ${s}x ${e} @ ${y(a)}`),this.botState=b.EXECUTING_CRASH):(this.logger.warn("Bot",`PREP_FAIL: Arrived at ${t} but could not buy ${e}. Aborting.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++)}async _executeCrash(){let{goodId:e,crashLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"CRASH",`Traveling to ${t} to crash ${e}`);let s=this.simulationService._getActiveShip(),o=i.TRAVEL_DATA[i.currentLocationId][t],r=o?o.fuelCost||0:9999;if(s.fuel<r){this.logger.warn("Bot",`CRASH_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${r}). Forcing maintenance.`);let n=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:r+5,nextState:b.EXECUTING_CRASH,originalObjective:n},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=this.simulationService._getActiveInventory()[e]?.quantity||0;if(a>0){let s=this.simulationService._getActiveInventory()[e]?.avgCost||0,r=this.simulationService.playerActionService.sellItem(e,a)-s*a;this.logger.info.system("Bot",i.day,"CRASH_SELL",`CRASHED: Sold ${a}x ${e}. Profit: ${y(r)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=r,r>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=r;let n=this.gameState.market.inventory[t][e];this.plannedObjectives.push({goodId:e,locationId:t,priceLockEndDay:n.priceLockEndDay,crashedOnDay:this.gameState.day}),this.currentObjective.type="EXPLOIT",this.currentObjective.exploitLocationId=this.currentObjective.crashLocationId,delete this.currentObjective.buyFromLocationId,delete this.currentObjective.crashLocationId,this.botState=b.EXECUTING_EXPLOIT}else this.logger.warn("Bot",`CRASH_FAIL: Arrived at ${t} but have no ${e} to sell. Aborting.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++}async _executeExploit(){let{goodId:e,exploitLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"EXPLOIT",`Traveling to ${t} to buy cheap ${e}`);let o=this.simulationService._getActiveShip(),r=i.TRAVEL_DATA[i.currentLocationId][t],n=r?r.fuelCost||0:9999;if(o.fuel<n){this.logger.warn("Bot",`EXPLOIT_FAIL: Not enough fuel (${o.fuel}) to travel to ${t} (needs ${n}). Forcing maintenance.`);let l=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:n+5,nextState:b.EXECUTING_EXPLOIT,originalObjective:l},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=i.market.prices[t][e],s=this._calculateMaxBuy(e,a);if(s>0){this.simulationService.playerActionService.buyItem(e,s),this.logger.info.system("Bot",i.day,"EXPLOIT_BUY",`EXPLOITED: Bought ${s}x ${e} @ ${y(a)}`);let o=this._findBestSellLocation(e,t);o?(this.logger.info.system("Bot",i.day,"EXPLOIT_PLAN",`Goods secured. Now traveling to ${o.id} to sell.`),this.currentObjective.type="SELL_EXPLOITED",this.currentObjective.sellToLocationId=o.id,this.botState=b.SELLING_EXPLOITED_GOODS):(this.logger.warn("Bot",`EXPLOIT_FAIL: No market found to sell ${e}. Dumping objective.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++)}else this.logger.warn("Bot",`EXPLOIT_FAIL: Arrived at ${t} but could not buy ${e}.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;this.plannedObjectives=this.plannedObjectives.filter(o=>!(o.goodId===e&&o.locationId===t))}async _executeSellExploited(){let{goodId:e,sellToLocationId:t}=this.currentObjective,i=this.gameState.getState();if(i.currentLocationId!==t){this.logger.info.system("Bot",i.day,"SELL_EXPLOIT",`Traveling to ${t} to sell ${e}`);let s=this.simulationService._getActiveShip(),o=i.TRAVEL_DATA[i.currentLocationId][t],r=o?o.fuelCost||0:9999;if(s.fuel<r){this.logger.warn("Bot",`SELL_EXPLOIT_FAIL: Not enough fuel (${s.fuel}) to travel to ${t} (needs ${r}). Forcing maintenance.`);let n=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:r+5,nextState:b.SELLING_EXPLOITED_GOODS,originalObjective:n},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let a=this.simulationService._getActiveInventory()[e]?.quantity||0;if(a>0){let s=this.simulationService._getActiveInventory()[e]?.avgCost||0,r=this.simulationService.playerActionService.sellItem(e,a)-s*a;this.logger.info.system("Bot",i.day,"SELL_EXPLOIT_SELL",`Sold ${a}x ${e}. Profit: ${y(r)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=r,r>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=r}else this.logger.warn("Bot",`SELL_EXPLOIT_FAIL: Arrived at ${t} but have no ${e} to sell.`);this.botState=b.IDLE,this.metrics.objectivesCompleted++}async _executeTimeWaster(){if(!this.currentObjective||this.currentObjective.type!=="SIMPLE_TRADE"){let n=this._findBestSimpleTrade();if(n)this.currentObjective={...n,type:"SIMPLE_TRADE",hasGoods:!1},this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"OBJECTIVE",`[TRADE]: New simple trade. Buy ${n.goodId} @ ${n.buyLocationId} -> Sell @ ${n.sellLocationId}. Margin: ${(n.profitPerUnit/n.buyPrice*100).toFixed(1)}%. Est. PPD: ${y(n.estimatedPPD)}.`);else{this.logger.info.system("Bot",this.gameState.day,"TIME_WASTER","No profitable simple trades found. Waiting 1 day."),this.simulationService.timeService.advanceDays(1),this.botState=b.IDLE;return}}let{goodId:e,buyLocationId:t,sellLocationId:i,buyPrice:a,hasGoods:s}=this.currentObjective,o=this.gameState.getState(),r=this.simulationService._getActiveShip();if(!s){if(o.currentLocationId!==t){this.logger.info.system("Bot",o.day,"TRADE_BUY",`Traveling to ${t} to buy ${e}`);let c=o.TRAVEL_DATA[o.currentLocationId][t],h=c?c.fuelCost||0:9999;if(r.fuel<h){this.logger.warn("Bot",`TIME_WASTER_FAIL: Not enough fuel (${r.fuel}) to travel to ${t} (needs ${h}). Forcing maintenance.`);let m=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:b.TIME_WASTER,originalObjective:m},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let n=o.market.inventory[o.currentLocationId][e].quantity;if(n<=0){this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${t} but ${e} is now out of stock. Aborting.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}let l=this._calculateMaxBuy(e,a);if(l>0)this.simulationService.playerActionService.buyItem(e,l),this.logger.info.system("Bot",o.day,"TRADE_BUY",`Bought ${l}x ${e} @ ${y(a)}`),this.currentObjective.hasGoods=!0;else{this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${t} but could not buy ${e} (Price: ${y(a)}, Stock: ${n}). Aborting.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}}if(this.currentObjective.hasGoods){if(o.currentLocationId!==i){this.logger.info.system("Bot",o.day,"TRADE_SELL",`Traveling to ${i} to sell ${e}`);let l=o.TRAVEL_DATA[o.currentLocationId][i],c=l?l.fuelCost||0:9999;if(r.fuel<c){this.logger.warn("Bot",`TIME_WASTER_FAIL: Not enough fuel (${r.fuel}) to travel to ${i} (needs ${c}). Forcing maintenance.`);let h=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:c+5,nextState:b.TIME_WASTER,originalObjective:h},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(i);return}let n=this.simulationService._getActiveInventory()[e]?.quantity||0;if(n>0){let l=this.simulationService._getActiveInventory()[e]?.avgCost||0,h=this.simulationService.playerActionService.sellItem(e,n)-l*n;this.logger.info.system("Bot",o.day,"TRADE_SELL",`Sold ${n}x ${e}. Profit: ${y(h)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=h,h>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=h,this.metrics.objectivesCompleted++}else this.logger.warn("Bot",`TIME_WASTER_FAIL: Arrived at ${i} but have no ${e} to sell.`),this.metrics.objectivesAborted++;this.currentObjective=null,this.botState=b.IDLE}}async _findDepletionOpportunity(){let e=this.gameState.getState(),t=this.simulationService._getActiveShip();if(!t){this.botState=b.IDLE;return}let i=u.COMMODITIES.filter(s=>s.tier<=e.player.revealedTier&&s.tier>1),a=[];for(let s of i)for(let o of u.MARKETS){if(!e.player.unlockedLocationIds.includes(o.id))continue;let r=e.market.inventory[o.id][s.id];if(e.day<=r.depletionBonusDay+365)continue;let[n,l]=s.canonicalAvailability,c=o.availabilityModifier?.[s.id]??1,h=(n+l)/2*c,m=r.marketPressure;m>0&&(m=0);let p=1-Math.min(.5,m*.5),S=Math.max(1,h*p)*.08,f=r.quantity,T=e.market.prices[o.id][s.id];f>=S&&e.player.credits>=f*T&&t.cargoCapacity>=f&&a.push({potential:s.tier*f,plan:{type:"DEPLETE",goodId:s.id,locationId:o.id,amountToBuy:f}})}if(a.length>0){a.sort((r,n)=>n.potential-r.potential);let s=a.slice(0,5).map(r=>r.plan),o=s[Math.floor(Math.random()*s.length)];this.currentObjective=o,this.botState=b.EXECUTING_DEPLETION,this.metrics.objectivesStarted++,this.logger.info.system("Bot",this.gameState.day,"PLAN",`New depletion plan (1 of ${s.length}): Buy out ${o.amountToBuy}x ${o.goodId} at ${o.locationId}`)}else this.activeStrategy===H.DEPLETE_ONLY?(this.logger.info.system("Bot",this.gameState.day,"PLAN","No depletion opportunities. Waiting 1 day."),this.simulationService.timeService.advanceDays(1),this.botState=b.IDLE):this.botState=b.SEEKING_MANIPULATION}async _executeDepletion(){let{goodId:e,locationId:t,amountToBuy:i}=this.currentObjective,a=this.gameState.getState();if(a.currentLocationId!==t){this.logger.info.system("Bot",a.day,"DEPLETE",`Traveling to ${t} to buy out ${e}`);let r=this.simulationService._getActiveShip(),n=a.TRAVEL_DATA[a.currentLocationId][t],l=n?n.fuelCost||0:9999;if(r.fuel<l){this.logger.warn("Bot",`DEPLETE_FAIL: Not enough fuel (${r.fuel}) to travel to ${t} (needs ${l}). Forcing maintenance.`);let c=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:l+5,nextState:b.EXECUTING_DEPLETION,originalObjective:c},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let s=this.simulationService.playerActionService.buyItem(e,i);if(!s||s<i){this.logger.warn("Bot",`DEPLETE_FAIL: Failed to buy out ${e} at ${t}. Aborting.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}this.logger.info.system("Bot",a.day,"DEPLETE_BUY",`Successfully bought out ${i}x ${e}. Depletion bonus triggered.`);let o=this._findBestSellLocation(e,t);if(o){let r=this.simulationService._getActiveShip(),n=a.TRAVEL_DATA[a.currentLocationId][o.id],l=n?n.fuelCost||0:9999;if(r.fuel<l){this.logger.warn("Bot",`DEPLETE_FAIL: Not enough fuel (${r.fuel}) to travel to sell location ${o.id} (needs ${l}). Forcing maintenance.`);let c=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:l+5,nextState:b.EXECUTING_DEPLETION,originalObjective:c},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(o.id);return}this.currentObjective.waitStartDay=this.gameState.day,this.botState=b.WAITING_FOR_HIKE}async _executeWait(){this.gameState.day>this.currentObjective.waitStartDay+7?(this.logger.info.system("Bot",this.gameState.day,"DEPLETE","Wait complete. Price hike is active. Beginning exploitation."),this.botState=b.EXPLOITING_HIKE,this.currentObjective.exploitRuns=0):(this.simulationService.timeService.advanceDays(1),this.botState=b.WAITING_FOR_HIKE)}async _executeExploitHike(){let{goodId:e,locationId:t}=this.currentObjective,i=this.gameState.getState(),a=this._findCheapestMarket(e);if(!a||a.id===t){this.logger.warn("Bot",`HIKE_FAIL: No cheap market found to buy ${e}. Aborting exploit.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}if(i.currentLocationId!==a.id){let l=this.simulationService._getActiveShip(),c=i.TRAVEL_DATA[i.currentLocationId][a.id],h=c?c.fuelCost||0:9999;if(l.fuel<h){this.logger.warn("Bot",`HIKE_FAIL: Not enough fuel (${l.fuel}) to travel to buy location ${a.id} (needs ${h}). Forcing maintenance.`);let m=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:b.EXPLOITING_HIKE,originalObjective:m},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(a.id);return}let s=this._calculateMaxBuy(e,a.price);if(s>0&&this.simulationService.playerActionService.buyItem(e,s),i.currentLocationId!==t){let l=this.simulationService._getActiveShip(),c=i.TRAVEL_DATA[i.currentLocationId][t],h=c?c.fuelCost||0:9999;if(l.fuel<h){this.logger.warn("Bot",`HIKE_FAIL: Not enough fuel (${l.fuel}) to travel to hiked location ${t} (needs ${h}). Forcing maintenance.`);let m=this.currentObjective;this.currentObjective={type:"REFUEL_FOR_TRAVEL",needed:h+5,nextState:b.EXPLOITING_HIKE,originalObjective:m},this.botState=b.MAINTENANCE;return}this.simulationService.travelService.initiateTravel(t);return}let o=this.simulationService._getActiveInventory()[e]?.quantity||0,r=i.market.inventory[t][e].quantity;if(o>0&&r>0){let l=this.simulationService._getActiveInventory()[e]?.avgCost||0,h=this.simulationService.playerActionService.sellItem(e,o)-l*o;this.logger.info.system("Bot",i.day,"HIKE_EXPLOIT_SELL",`Sold ${o}x ${e} at hiked price. Profit: ${y(h)}`),this.metrics.totalTrades++,this.metrics.totalNetProfit+=h,h>0&&this.metrics.profitableTrades++,this.metrics.profitByGood[e]||(this.metrics.profitByGood[e]=0),this.metrics.profitByGood[e]+=h}else if(o>0&&r<=0){this.logger.warn("Bot",`HIKE_FAIL: Arrived at hiked market ${t} but stock is 0. Aborting sale and loop.`),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesAborted++;return}this.currentObjective.exploitRuns++;let n=i.market.inventory[t][e];this.currentObjective.exploitRuns<2&&i.day<n.depletionDay+7?this.botState=b.EXPLOITING_HIKE:(this.logger.info.system("Bot",i.day,"HIKE_COMPLETE","Depletion exploit complete."),this.currentObjective=null,this.botState=b.IDLE,this.metrics.objectivesCompleted++)}_isCrashPlanStillValid(){if(!this.currentObjective||this.currentObjective.type!=="CRASH")return!1;let{goodId:e,buyFromLocationId:t,crashLocationId:i}=this.currentObjective;if(!e||!t||!i)return!1;let a=this.gameState.getState(),s=a.market.prices[t][e];return a.market.prices[i][e]-s>0}_findReadySelfExploit(){let e=this.gameState.getState();this.plannedObjectives=this.plannedObjectives.filter(t=>t.priceLockEndDay>e.day);for(let t of this.plannedObjectives)if(e.day>t.crashedOnDay+7&&e.market.inventory[t.locationId][t.goodId].quantity>10)return{type:"EXPLOIT",goodId:t.goodId,exploitLocationId:t.locationId};return null}_findBestSellLocationForHeldCargo(){let e=this.gameState.getState(),t=this.simulationService._getActiveInventory();if(!t)return null;let i=null,a=0;for(let s in t){let o=t[s];if(o&&o.quantity>0){let r=o.avgCost,n=o.quantity,l=this._findBestSellLocation(s,e.currentLocationId);if(l){let c=(l.price-r)*n;c>a&&(a=c,i={goodId:s,quantity:n,avgCost:r,sellLocationId:l.id,sellPrice:l.price,estimatedProfit:c})}}}return i&&i.estimatedProfit>0?i:null}_findCheapestMarket(e){let t=this.gameState.getState(),i=null,a=1/0;for(let s of u.MARKETS){if(!t.player.unlockedLocationIds.includes(s.id))continue;let o=t.market.prices[s.id][e];o<a&&t.market.inventory[s.id][e].quantity>0&&(a=o,i={id:s.id,price:o})}return i}_findBestSellLocation(e,t){let i=this.gameState.getState(),a=null,s=-1/0;for(let o of u.MARKETS){if(o.id===t||!i.player.unlockedLocationIds.includes(o.id))continue;let r=i.market.inventory[o.id][e].quantity,n=i.market.prices[o.id][e];n>s&&r>0&&(s=n,a={id:o.id,price:n})}return a}_findBestCrashTarget(e,t){let i=this.gameState.getState(),a=null,s=1/0;for(let o of u.MARKETS){if(o.id===t||!i.player.unlockedLocationIds.includes(o.id))continue;let r=o.availabilityModifier?.[e]??1,n=i.market.prices[o.id][e];n<s&&(s=n,a={id:o.id,price:n})}return a}_findBestSimpleTrade(){let e=this.gameState.getState(),t=this.simulationService._getActiveShip();if(!t)return null;let i=t.cargoCapacity;if(i<=0)return null;let a=null,s=0,o=u.COMMODITIES.filter(n=>n.tier<=e.player.revealedTier),r=this.simulationService._getActiveInventory();for(let n of o)if(!(r[n.id]&&r[n.id].quantity>0))for(let l of u.MARKETS){if(!e.player.unlockedLocationIds.includes(l.id))continue;let c=e.market.inventory[l.id][n.id].quantity;if(!(c<=0))for(let h of u.MARKETS){if(l.id===h.id||!e.player.unlockedLocationIds.includes(h.id)||e.market.inventory[h.id][n.id].quantity<=0)continue;let p=e.market.prices[l.id][n.id],g=e.market.prices[h.id][n.id],S=g-p,f=p>0?S/p:0;if(S>0&&f>this.MIN_PROFIT_MARGIN){let T=e.TRAVEL_DATA[e.currentLocationId]?.[l.id]?.time||0,_=e.TRAVEL_DATA[l.id]?.[h.id]?.time||0;if(_===0)continue;let x=T+_+2,O=Math.min(i,c),k=S*O/x;k>s&&(s=k,a={goodId:n.id,buyLocationId:l.id,sellLocationId:h.id,buyPrice:p,sellPrice:g,profitPerUnit:S,estimatedPPD:k})}}}return a}_handleAgeEventChoice(){let e=document.getElementById("age-event-modal");if(!e||e.classList.contains("hidden"))return!1;let t=document.getElementById("age-event-title").textContent;this.logger.info.system("Bot",this.gameState.day,"EVENT_CHOICE",`Handling age event: ${t}`);let i=Array.from(e.querySelectorAll("button"));if(i.length===0)return!1;let a=["trademaster","merchant's guild","free ship","credits","profit"],s=["continue","ignore","dismiss","accept"],o=null;for(let r of i){let n=r.textContent.toLowerCase();if(a.some(l=>n.includes(l))){o=r;break}}if(!o)for(let r of i){let n=r.textContent.toLowerCase();if(s.some(l=>n.includes(l))){o=r;break}}return o||(this.logger.warn("Bot",`EVENT_CHOICE: No preferred keyword found for "${t}". Clicking first available button.`),o=i[0]),o.click(),!0}_logSummaryReport(){this.metrics.daysSimulated=this.gameState.day-this.simulationStartDay;let{totalTrades:e,profitableTrades:t,totalNetProfit:i,totalFuelCost:a,totalRepairCost:s,daysSimulated:o,strategyUsed:r,objectivesStarted:n,objectivesCompleted:l,objectivesAborted:c,profitByGood:h}=this.metrics,m=e>0?(t/e*100).toFixed(1):0,p=o>0?i/o:0,g="=== AUTO-TRADER PERFORMANCE SUMMARY ===";console.log(g),this.logger.info.system("Bot",this.gameState.day,"REPORT",g);let S=[`Strategy Run: ${r}`,`Days Simulated: ${o}`,`Final Credit Balance: ${y(this.gameState.player.credits)}`,"","--- Performance ---",`Total Net Profit: ${y(i)}`,`Profit Per Day: ${y(p)}`,`Objectives (Started/Completed/Aborted): ${n} / ${l} / ${c}`,`Total Trades Completed: ${e}`,`Profitable Trades: ${t} (${m}%)`,"","--- Costs ---",`Total Fuel Costs: ${y(a)}`,`Total Repair Costs: ${y(s)}`];for(let x of S)console.log(x),this.logger.info.system("Bot",this.gameState.day,"REPORT",`  ${x}`);let f="--- Profit Breakdown by Commodity ---";console.log(f),this.logger.info.system("Bot",this.gameState.day,"REPORT",`  ${f}`);let T=Object.keys(h).sort((x,O)=>h[O]-h[x]);if(T.length===0){let x="No commodity trades recorded.";console.log(x),this.logger.info.system("Bot",this.gameState.day,"REPORT",`    ${x}`)}else for(let x of T){let O=h[x],k=`${u.COMMODITIES.find(w=>w.id===x)?.name||x}: ${y(O)}`;console.log(k),this.logger.info.system("Bot",this.gameState.day,"REPORT",`    ${k}`)}let _="=======================================";console.log(_),this.logger.info.system("Bot",this.gameState.day,"REPORT",_)}_needsMaintenance(){let e=this.simulationService._getActiveShip();if(!e)return!1;let t=this.gameState.player.shipStates[e.id].fuel/e.maxFuel*100,i=this.gameState.player.shipStates[e.id].health/e.maxHealth*100;return t<30||i<30}_botRefuel(e=null){let t=this.simulationService._getActiveShip();if(!t)return;let a=(e===null?t.maxFuel:Math.min(t.maxFuel,e))-this.gameState.player.shipStates[t.id].fuel;if(a<=0)return;let o=u.MARKETS.find(c=>c.id===this.gameState.currentLocationId).fuelPrice/2;this.gameState.player.activePerks[M.VENETIAN_SYNDICATE]&&this.gameState.currentLocationId===v.VENUS&&(o*=1-u.PERKS[M.VENETIAN_SYNDICATE].fuelDiscount),o=Math.max(1,Math.round(o));let r=Math.ceil(a/5),n=r*o,l=r*5;if(this.gameState.player.credits>=n)this.gameState.player.credits-=n,this.gameState.player.shipStates[t.id].fuel=Math.min(t.maxFuel,this.gameState.player.shipStates[t.id].fuel+l),this.simulationService._logConsolidatedTransaction("fuel",-n,"Fuel Purchase"),this.metrics.totalFuelCost+=n;else{let c=Math.floor(this.gameState.player.credits/o);if(c>0){let h=c*o;this.gameState.player.credits-=h,this.gameState.player.shipStates[t.id].fuel+=c*5,this.simulationService._logConsolidatedTransaction("fuel",-h,"Fuel Purchase"),this.metrics.totalFuelCost+=h}}}_botRepair(){let e=this.simulationService._getActiveShip();if(!e)return;let t=e.maxHealth-this.gameState.player.shipStates[e.id].health;if(t<=0)return;let i=e.maxHealth*(C.REPAIR_AMOUNT_PER_TICK/100),a=i*C.REPAIR_COST_PER_HP;this.gameState.player.activePerks[M.VENETIAN_SYNDICATE]&&this.gameState.currentLocationId===v.VENUS&&(a*=1-u.PERKS[M.VENETIAN_SYNDICATE].repairDiscount),a=Math.max(1,Math.round(a));let o=Math.ceil(t/i)*a;if(this.gameState.player.credits>=o)this.gameState.player.credits-=o,this.gameState.player.shipStates[e.id].health=e.maxHealth,this.simulationService._logConsolidatedTransaction("repair",-o,"Hull Repairs"),this.metrics.totalRepairCost+=o;else{let r=Math.floor(this.gameState.player.credits/a);if(r>0){let n=r*a;this.gameState.player.credits-=n,this.gameState.player.shipStates[e.id].health+=r*i,this.simulationService._logConsolidatedTransaction("repair",-n,"Hull Repairs"),this.metrics.totalRepairCost+=n}}}_calculateMaxBuy(e,t){let i=this.gameState.getState(),a=this.simulationService._getActiveShip(),s=this.simulationService._getActiveInventory();if(!a||!s)return 0;let o=a.cargoCapacity-P(s),r=t>0?Math.floor(i.player.credits/t):1/0,n=i.market.inventory[i.currentLocationId][e].quantity;return Math.max(0,Math.min(o,r,n))}};var dt={topCenter:[50,15],top34Center:[50,30],vertHorizCenter:[50,50],bottom34Center:[50,70],bottomCenter:[50,85],bottomLeft:[15,85],topLeft:[15,15]},ve=class{constructor(e,t,i,a){this.gameState=e,this.simulationService=t,this.uiManager=i,this.logger=a,this.gui=null,this.active=!1,this.diagActive=!1,this.diagElements={},this.actions={},this.debugState={creditsToAdd:1e5,creditsToReduce:1e5,selectedLocation:this.gameState.currentLocationId,daysToAdvance:7,selectedRandomEvent:0,selectedAgeEvent:u.AGE_EVENTS[0].id,selectedMission:Object.values(u.MISSIONS)[0]?.id||null,botDaysToRun:365,botStrategy:"MIXED",botProgress:"Idle",logLevel:"INFO",ttStepId:"None",ttAnchor:"N/A",ttPlacement:"auto",ttOffsetDistance:0,ttOffsetSkidding:0,ttPercentX:50,ttPercentY:50,ttWidth:0,ttHeight:0,ttGeneratedCode:""},this.bot=new ye(e,t,a),this.tutorialPositionalControllers={}}init(){this.gui||(this._cacheDiagElements(),this.gui=new lil.GUI({draggable:!0,title:"Debug Menu"}),this.gui.domElement.id="debug-panel",this._registerDebugActions(),this.buildGui(),this._startDiagLoop())}handleKeyPress(e){}toggleVisibility(){this.gui&&(this.active=!this.active,this.gui.domElement.classList.toggle("debug-visible",this.active))}toggleDiagnosticOverlay(){this.diagActive=!this.diagActive;let e=document.getElementById("diagnostic-overlay");e&&e.classList.toggle("hidden",!this.diagActive)}generateBugReport(){let e=this.logger.getLogHistory(),t=this.gameState.getState();delete t.TRAVEL_DATA,delete t.market.priceHistory;let i=`
ORBITAL TRADING - BUG REPORT
==============================
Date: ${new Date().toISOString()}

--- GAME STATE SNAPSHOT ---
${JSON.stringify(t,null,2)}

--- RECENT LOG HISTORY ---
${e}
        `;navigator.clipboard.writeText(i.trim()).then(()=>{this.uiManager.createFloatingText("Bug Report Copied to Clipboard!",window.innerWidth/2,window.innerHeight/2,"#4ade80")}).catch(a=>{this.logger.error("DebugService","Failed to copy bug report.",a)})}godMode(){this.logger.warn("DebugService","GOD MODE ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(u.TUTORIAL_DATA),this.gameState.player.credits=1e12,this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(L.BEHEMOTH),this.gameState.player.activeShipId=L.BEHEMOTH,this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(u.LICENSES),this.gameState.player.unlockedLocationIds=u.MARKETS.map(e=>e.id),this.uiManager.showGameContainer(),this.simulationService.setScreen(N.STARPORT,A.MARKET),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}simpleStart(){this.logger.warn("DebugService","SIMPLE START ACTIVATED."),this.gameState.introSequenceActive=!1,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=Object.keys(u.TUTORIAL_DATA),this.gameState.player.ownedShipIds=[],this.simulationService.addShipToHangar(L.WANDERER),this.gameState.player.activeShipId=L.WANDERER,this.uiManager.showGameContainer(),this.simulationService.setScreen(N.DATA,A.MISSIONS),this.simulationService.timeService.advanceDays(7),this.gameState.setState({})}skipToHangarTutorial(){this.logger.warn("DebugService","SKIP TO HANGAR TUTORIAL ACTIVATED."),this.gameState.introSequenceActive=!0,this.simulationService.tutorialService.activeBatchId=null,this.simulationService.tutorialService.activeStepId=null,this.gameState.tutorials.activeBatchId=null,this.gameState.tutorials.activeStepId=null,this.gameState.tutorials.skippedTutorialBatches=[],this.gameState.player.credits=25e3,this.gameState.player.ownedShipIds=[],this.gameState.player.activeShipId=null,this.gameState.player.shipStates={},this.gameState.player.inventories={},this.uiManager.showGameContainer(),this.simulationService.setScreen(N.STARPORT,A.HANGAR),this.simulationService.tutorialService.triggerBatch("intro_hangar","hangar_1"),this.gameState.setState({})}deductHull(e){let t=this.simulationService._getActiveShip();if(t){let i=this.gameState.player.shipStates[t.id];i.health=Math.max(0,i.health-e),this.logger.warn("DebugService",`Deducted ${e} hull from ${t.name}.`),this.gameState.setState({})}}restoreHull(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.health=e.maxHealth,this.logger.warn("DebugService",`Restored hull for ${e.name}.`),this.gameState.setState({})}}destroyShip(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.health=0,this.logger.warn("DebugService",`Destroyed ${e.name}.`),this.simulationService.travelService._handleShipDestruction(e.id)}}deductFuel(e){let t=this.simulationService._getActiveShip();if(t){let i=this.gameState.player.shipStates[t.id];i.fuel=Math.max(0,i.fuel-e),this.logger.warn("DebugService",`Deducted ${e} fuel from ${t.name}.`),this.gameState.setState({})}}restoreFuel(){let e=this.simulationService._getActiveShip();if(e){let t=this.gameState.player.shipStates[e.id];t.fuel=e.maxFuel,this.logger.warn("DebugService",`Restored fuel for ${e.name}.`),this.gameState.setState({})}}removeAllCargo(){let e=this.simulationService._getActiveInventory();if(e){for(let t in e)e[t].quantity=0,e[t].avgCost=0;this.logger.warn("DebugService","All cargo removed from active ship."),this.gameState.setState({})}}fillWithCybernetics(){let e=this.simulationService._getActiveShip(),t=this.simulationService._getActiveInventory();if(e&&t){this.removeAllCargo();let i=e.cargoCapacity-P(t);t[E.CYBERNETICS]||(t[E.CYBERNETICS]={quantity:0,avgCost:0}),t[E.CYBERNETICS].quantity=i,this.logger.warn("DebugService",`Filled cargo with ${i} Cybernetics.`),this.gameState.setState({})}}grantAllItems(){let e=this.simulationService._getActiveInventory();if(!e){this.logger.warn("DebugService","Cannot grant items: No active inventory found.");return}u.COMMODITIES.forEach(t=>{e[t.id]?e[t.id].quantity+=1:e[t.id]={quantity:1,avgCost:0}}),this.logger.warn("DebugService","Debug: Granted 1x of all commodities."),this.gameState.setState({})}fillShipyard(){let{currentLocationId:e,day:t}=this.gameState;if(this.gameState.market.shipyardStock[e]){let i=Object.keys(u.SHIPS);this.gameState.market.shipyardStock[e]={day:t,shipsForSale:i},this.logger.warn("DebugService",`SHIPYARD FILLED: All ships added to ${e}.`),this.gameState.setState({})}else this.logger.error("DebugService",`Cannot fill shipyard: No stock object for ${e}.`)}_registerDebugActions(){this.actions={godMode:{name:"God Mode",type:"button",handler:()=>this.godMode()},simpleStart:{name:"Simple Start",type:"button",handler:()=>this.simpleStart()},skipToHangarTutorial:{name:"Skip to Hangar Tutorial",type:"button",handler:()=>this.skipToHangarTutorial()},addCredits:{name:"Add Credits",type:"button",handler:()=>{this.gameState.player.credits+=this.debugState.creditsToAdd,this.simulationService.timeService._checkMilestones(),this.gameState.setState({})}},reduceCredits:{name:"Reduce Credits",type:"button",handler:()=>{this.gameState.player.credits-=this.debugState.creditsToReduce,this.simulationService._checkGameOverConditions(),this.gameState.setState({})}},payDebt:{name:"Pay Off Debt",type:"button",handler:()=>this.simulationService.playerActionService.payOffDebt()},teleport:{name:"Teleport",type:"button",handler:()=>{this.debugState.selectedLocation&&(this.gameState.currentLocationId=this.debugState.selectedLocation,this.gameState.setState({}))}},unlockAll:{name:"Unlock All",type:"button",handler:()=>{this.gameState.player.unlockedLocationIds=u.MARKETS.map(e=>e.id),this.gameState.player.revealedTier=7,this.gameState.player.unlockedLicenseIds=Object.keys(u.LICENSES),this.gameState.setState({})}},grantAllShips:{name:"Grant All Ships",type:"button",handler:()=>{Object.keys(u.SHIPS).forEach(e=>{this.gameState.player.ownedShipIds.includes(e)||this.simulationService.addShipToHangar(e)}),this.gameState.setState({})}},advanceTime:{name:"Advance Days",type:"button",handler:()=>this.simulationService.timeService.advanceDays(this.debugState.daysToAdvance)},replenishStock:{name:"Replenish All Stock",type:"button",handler:()=>{this.simulationService.marketService.replenishMarketInventory(),this.gameState.setState({})}},triggerRandomEvent:{name:"Trigger Random Event",type:"button",handler:()=>{let e=u.MARKETS.find(t=>t.id!==this.gameState.currentLocationId)?.id;e&&this.simulationService.travelService._checkForRandomEvent(e,this.debugState.selectedRandomEvent)}},triggerAgeEvent:{name:"Trigger Age Event",type:"button",handler:()=>{let e=u.AGE_EVENTS.find(t=>t.id===this.debugState.selectedAgeEvent);e&&this.uiManager.showAgeEventModal(e,t=>this.simulationService._applyPerk(t))}},triggerMission:{name:"Trigger Mission",type:"button",handler:()=>{this.debugState.selectedMission&&(this.gameState.missions.activeMissionId&&this.simulationService.missionService.abandonMission(),this.simulationService.missionService.acceptMission(this.debugState.selectedMission))}},startBot:{name:"Start AUTOTRADER-01",type:"button",handler:()=>{let e=this.gui.controllers.find(i=>i.property==="botProgress"),t={daysToRun:this.debugState.botDaysToRun,strategy:this.debugState.botStrategy};this.bot.runSimulation(t,(i,a)=>{e&&e.setValue(`${i} / ${a}`).updateDisplay()})}},stopBot:{name:"Stop AUTOTRADER-01",type:"button",handler:()=>this.bot.stop()},fillShipyard:{name:"Fill Shipyard w/ All Ships",type:"button",handler:()=>this.fillShipyard()},deductHull20:{name:"Deduct 20 Hull",type:"button",handler:()=>this.deductHull(20)},restoreHull:{name:"Restore Hull",type:"button",handler:()=>this.restoreHull()},destroyShip:{name:"Destroy Current Ship",type:"button",handler:()=>this.destroyShip()},deductFuel20:{name:"Deduct 20 Fuel",type:"button",handler:()=>this.deductFuel(20)},restoreFuel:{name:"Restore Fuel",type:"button",handler:()=>this.restoreFuel()},removeAllCargo:{name:"Remove All Cargo",type:"button",handler:()=>this.removeAllCargo()},grantAllItems:{name:"Grant 1x All Items",type:"button",handler:()=>this.grantAllItems()},fillWithCybernetics:{name:"Fill w/ Cybernetics",type:"button",handler:()=>this.fillWithCybernetics()},generateTutorialCode:{name:"Generate Code",type:"button",handler:()=>this._generateTutorialCode()},presetTopCenter:{name:"Top Center",type:"button",handler:()=>this._applyTutorialPreset("topCenter")},presetTop34Center:{name:"Top 3/4 Center",type:"button",handler:()=>this._applyTutorialPreset("top34Center")},presetVertHorizCenter:{name:"V/H Center",type:"button",handler:()=>this._applyTutorialPreset("vertHorizCenter")},presetBottom34Center:{name:"Bottom 3/4 Center",type:"button",handler:()=>this._applyTutorialPreset("bottom34Center")},presetBottomCenter:{name:"Bottom Center",type:"button",handler:()=>this._applyTutorialPreset("bottomCenter")},presetBottomLeft:{name:"Bottom Left",type:"button",handler:()=>this._applyTutorialPreset("bottomLeft")},presetTopLeft:{name:"Top Left",type:"button",handler:()=>this._applyTutorialPreset("topLeft")}}}_cacheDiagElements(){this.diagElements={winW:document.getElementById("diag-window-w"),winH:document.getElementById("diag-window-h"),visualVpW:document.getElementById("diag-visual-vp-w"),visualVpH:document.getElementById("diag-visual-vp-h"),gameW:document.getElementById("diag-game-container-w"),gameH:document.getElementById("diag-game-container-h"),bodyW:document.getElementById("diag-body-w"),bodyH:document.getElementById("diag-body-h"),pixelRatio:document.getElementById("diag-pixel-ratio"),displayMode:document.getElementById("diag-display-mode"),day:document.getElementById("diag-day"),navScreen:document.getElementById("diag-nav-screen"),tutorialBatch:document.getElementById("diag-tutorial-batch"),tutorialStep:document.getElementById("diag-tutorial-step")}}_startDiagLoop(){let e=()=>{this._updateDiagOverlay(),requestAnimationFrame(e)};requestAnimationFrame(e)}_updateDiagOverlay(){if(!this.diagActive)return;let e=this.gameState.getState(),t=document.getElementById("game-container");this.diagElements.winW.textContent=window.innerWidth,this.diagElements.winH.textContent=window.innerHeight,window.visualViewport&&(this.diagElements.visualVpW.textContent=Math.round(window.visualViewport.width),this.diagElements.visualVpH.textContent=Math.round(window.visualViewport.height)),this.diagElements.gameW.textContent=t.clientWidth,this.diagElements.gameH.textContent=t.clientHeight,this.diagElements.bodyW.textContent=document.body.clientWidth,this.diagElements.bodyH.textContent=document.body.clientHeight,this.diagElements.pixelRatio.textContent=window.devicePixelRatio.toFixed(2),this.diagElements.displayMode.textContent=window.matchMedia("(display-mode: standalone)").matches?"standalone":"browser",this.diagElements.day.textContent=e.day,this.diagElements.navScreen.textContent=`${e.activeNav} / ${e.activeScreen}`,this.diagElements.tutorialBatch.textContent=e.tutorials.activeBatchId||"none",this.diagElements.tutorialStep.textContent=e.tutorials.activeStepId||"none"}buildGui(){let e=this.gui.addFolder("Game Flow");e.add(this.actions.godMode,"handler").name(this.actions.godMode.name),e.add(this.actions.simpleStart,"handler").name(this.actions.simpleStart.name),e.add(this.actions.skipToHangarTutorial,"handler").name(this.actions.skipToHangarTutorial.name);let t=this.gui.addFolder("Player");t.add(this.debugState,"creditsToAdd").name("Credits Amount"),t.add(this.actions.addCredits,"handler").name("Add Credits"),t.add(this.debugState,"creditsToReduce",100,1e6,100).name("Credits to Reduce"),t.add(this.actions.reduceCredits,"handler").name("Reduce Credits"),t.add(this.actions.payDebt,"handler").name(this.actions.payDebt.name);let i=this.gui.addFolder("Ship"),a=u.MARKETS.reduce((g,S)=>({...g,[S.name]:S.id}),{});i.add(this.debugState,"selectedLocation",a).name("Location"),i.add(this.actions.teleport,"handler").name("Teleport"),i.add(this.actions.deductHull20,"handler").name(this.actions.deductHull20.name),i.add(this.actions.restoreHull,"handler").name(this.actions.restoreHull.name),i.add(this.actions.destroyShip,"handler").name(this.actions.destroyShip.name),i.add(this.actions.deductFuel20,"handler").name(this.actions.deductFuel20.name),i.add(this.actions.restoreFuel,"handler").name(this.actions.restoreFuel.name),i.add(this.actions.removeAllCargo,"handler").name(this.actions.removeAllCargo.name),i.add(this.actions.grantAllItems,"handler").name(this.actions.grantAllItems.name),i.add(this.actions.fillWithCybernetics,"handler").name(this.actions.fillWithCybernetics.name),i.add(this.actions.fillShipyard,"handler").name(this.actions.fillShipyard.name),i.add(this.actions.grantAllShips,"handler").name("Grant All Ships");let s=this.gui.addFolder("World & Time");s.add(this.debugState,"daysToAdvance",1,365,1).name("Days to Advance"),s.add(this.actions.advanceTime,"handler").name("Advance Time");let o=this.gui.addFolder("Economy");o.add(this.actions.replenishStock,"handler").name(this.actions.replenishStock.name),o.add(this.actions.unlockAll,"handler").name("Unlock Tiers/Locations");let r=this.gui.addFolder("Triggers"),n=u.RANDOM_EVENTS.reduce((g,S,f)=>({...g,[S.title]:f}),{});r.add(this.debugState,"selectedRandomEvent",n).name("Random Event"),r.add(this.actions.triggerRandomEvent,"handler").name("Trigger Event");let l=u.AGE_EVENTS.reduce((g,S)=>({...g,[S.title]:S.id}),{});r.add(this.debugState,"selectedAgeEvent",l).name("Age Event"),r.add(this.actions.triggerAgeEvent,"handler").name("Trigger Event");let c=Object.values(u.MISSIONS).reduce((g,S)=>({...g,[S.name]:S.id}),{});this.debugState.selectedMission&&(r.add(this.debugState,"selectedMission",c).name("Mission"),r.add(this.actions.triggerMission,"handler").name("Accept Mission"));let h=this.gui.addFolder("Tutorial Tuner");h.domElement.classList.add("tutorial-tuner-folder"),h.add(this.debugState,"ttStepId").name("Step ID").listen().disable(),h.add(this.debugState,"ttAnchor").name("Anchor").listen().disable(),h.add(this.debugState,"ttWidth",0,800,10).name("Width (0=auto)").onChange(()=>this._handleTutorialTune()),h.add(this.debugState,"ttHeight",0,800,10).name("Height (0=auto)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.percentX=h.add(this.debugState,"ttPercentX",0,100,1).name("X %").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.percentY=h.add(this.debugState,"ttPercentY",0,100,1).name("Y %").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.placement=h.add(this.debugState,"ttPlacement").name("Placement (Elem)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.distance=h.add(this.debugState,"ttOffsetDistance",-500,500,1).name("Distance (Elem)").onChange(()=>this._handleTutorialTune()),this.tutorialPositionalControllers.skidding=h.add(this.debugState,"ttOffsetSkidding",-500,500,1).name("Skidding (Elem)").onChange(()=>this._handleTutorialTune());let m=h.addFolder("Position Presets");m.add(this.actions.presetTopCenter,"handler").name(this.actions.presetTopCenter.name),m.add(this.actions.presetTop34Center,"handler").name(this.actions.presetTop34Center.name),m.add(this.actions.presetVertHorizCenter,"handler").name(this.actions.presetVertHorizCenter.name),m.add(this.actions.presetBottom34Center,"handler").name(this.actions.presetBottom34Center.name),m.add(this.actions.presetBottomCenter,"handler").name(this.actions.presetBottomCenter.name),m.add(this.actions.presetBottomLeft,"handler").name(this.actions.presetBottomLeft.name),m.add(this.actions.presetTopLeft,"handler").name(this.actions.presetTopLeft.name),this.tutorialPositionalControllers.presetFolder=m,h.add(this.actions.generateTutorialCode,"handler").name(this.actions.generateTutorialCode.name),h.add(this.debugState,"ttGeneratedCode").name("Code").listen(),this._updateTutorialControlVisibility(!1);let p=this.gui.addFolder("Automation & Logging");p.add(this,"toggleDiagnosticOverlay").name("Toggle HUD Diagnostics"),p.add(this.debugState,"logLevel",["DEBUG","INFO","WARN","ERROR","NONE"]).name("Log Level").onChange(g=>this.logger.setLevel(g)),p.add(this,"generateBugReport").name("Generate Bug Report"),p.add(this.debugState,"botStrategy",["MIXED","HONEST_TRADER","MANIPULATOR","DEPLETE_ONLY","PROSPECTOR"]).name("Bot Strategy"),p.add(this.debugState,"botDaysToRun",1,1e4,1).name("Simulation Days"),p.add(this.actions.startBot,"handler").name(this.actions.startBot.name),p.add(this.actions.stopBot,"handler").name(this.actions.stopBot.name),p.add(this.debugState,"botProgress").name("Progress").listen(),this.gui.folders.forEach(g=>g.close())}_parseSize(e){if(!e||e==="auto")return 0;if(typeof e=="number")return e;if(typeof e=="string"){let t=parseInt(e,10);return isNaN(t)?0:t}return 0}_applyTutorialPreset(e){if(this.debugState.ttAnchor==="body"){let i=dt[e];i?(this.debugState.ttPercentX=i[0],this.debugState.ttPercentY=i[1],this.tutorialPositionalControllers.percentX?.updateDisplay(),this.tutorialPositionalControllers.percentY?.updateDisplay()):this.logger.warn("DebugService",`Preset key "${e}" not found for percentage presets.`)}else this.logger.warn("DebugService","Offset presets not yet defined for element anchors.");this._handleTutorialTune()}_updateTutorialControlVisibility(e){let t=(i,a)=>{i&&i.show(a)};t(this.tutorialPositionalControllers.percentX,e),t(this.tutorialPositionalControllers.percentY,e),t(this.tutorialPositionalControllers.placement,!e),t(this.tutorialPositionalControllers.distance,!e),t(this.tutorialPositionalControllers.skidding,!e),this.tutorialPositionalControllers.presetFolder&&this.tutorialPositionalControllers.presetFolder.show(e)}setActiveTutorialStep(e){this.logger.info.system("DebugService",`Setting active tutorial step: ${e.stepId}`);let t=e.anchorElement==="body";if(this.debugState.ttGeneratedCode="",this.debugState.ttStepId=e.stepId,this.debugState.ttAnchor=e.anchorElement,this.debugState.ttWidth=this._parseSize(e.size?.width)||0,this.debugState.ttHeight=this._parseSize(e.size?.height)||0,t)this.debugState.ttPercentX=e.positionX??50,this.debugState.ttPercentY=e.positionY??50,this.debugState.ttPlacement="auto",this.debugState.ttOffsetDistance=0,this.debugState.ttOffsetSkidding=0;else{let i=e.popperOptions?.modifiers?.find(o=>o.name==="offset"),a=0,s=0;typeof i?.options?.offset=="function"?(this.logger.warn("DebugService",`Offset function used for ${e.stepId}. Tuner defaults to [0, 10].`),s=10):Array.isArray(i?.options?.offset)?(a=i.options.offset[0]||0,s=i.options.offset[1]||0):s=10,this.debugState.ttPlacement=e.placement||e.popperOptions?.placement||"auto",this.debugState.ttOffsetDistance=s,this.debugState.ttOffsetSkidding=a,this.debugState.ttPercentX=50,this.debugState.ttPercentY=50}this._updateTutorialControlVisibility(t),Object.values(this.tutorialPositionalControllers).forEach(i=>{i&&typeof i.updateDisplay=="function"&&i.updateDisplay()}),this.gui.controllers.find(i=>i.property==="ttWidth")?.updateDisplay(),this.gui.controllers.find(i=>i.property==="ttHeight")?.updateDisplay()}clearActiveTutorialStep(){this.logger.info.system("DebugService","Clearing active tutorial step."),this.debugState.ttStepId="None",this.debugState.ttAnchor="N/A",this.debugState.ttPlacement="auto",this.debugState.ttOffsetDistance=0,this.debugState.ttOffsetSkidding=0,this.debugState.ttPercentX=50,this.debugState.ttPercentY=50,this.debugState.ttWidth=0,this.debugState.ttHeight=0,this.debugState.ttGeneratedCode="",this._updateTutorialControlVisibility(!1)}_handleTutorialTune(){if(!this.uiManager)return;let e=this.debugState.ttAnchor==="body";this.logger.info.system("DebugService",`Tune event (Overlay: ${e}): X%=${this.debugState.ttPercentX}, Y%=${this.debugState.ttPercentY}, Place=${this.debugState.ttPlacement}, Dist=${this.debugState.ttOffsetDistance}, Skid=${this.debugState.ttOffsetSkidding}`),this.uiManager.updateTutorialPopper({isOverlayAnchor:e,width:Number(this.debugState.ttWidth)||0,height:Number(this.debugState.ttHeight)||0,percentX:Number(this.debugState.ttPercentX)||50,percentY:Number(this.debugState.ttPercentY)||50,placement:this.debugState.ttPlacement,distance:Number(this.debugState.ttOffsetDistance)||0,skidding:Number(this.debugState.ttOffsetSkidding)||0})}_generateTutorialCode(){this.logger.info.system("DebugService","Generating tutorial code...");let e=this.debugState.ttAnchor==="body",t=this.debugState.ttWidth>0||this.debugState.ttHeight>0,i=this.debugState.ttWidth>0?`'${this.debugState.ttWidth}px'`:"'auto'",a=this.debugState.ttHeight>0?`'${this.debugState.ttHeight}px'`:"'auto'",s=t?`
size: { width: ${i}, height: ${a} },`:"",o="";e?(o=`
anchorElement: 'body',`,(this.debugState.ttPercentX!==50||this.debugState.ttPercentY!==50)&&(o+=`
positionX: ${this.debugState.ttPercentX},
positionY: ${this.debugState.ttPercentY},`)):(this.debugState.ttAnchor!=="body"&&(o=`
anchorElement: '${this.debugState.ttAnchor}',`),o+=`
placement: '${this.debugState.ttPlacement}',
popperOptions: {
    modifiers: [
        { name: 'offset', options: { offset: [${this.debugState.ttOffsetSkidding}, ${this.debugState.ttOffsetDistance}] } }
        // Add other modifiers here if needed in the future
    ]
}`);let r=`// --- ${this.debugState.ttStepId} ---${s}${o}`;r=r.replace(/,\s*(\}|$)/g,"$1"),this.debugState.ttGeneratedCode=r}};var Ce={loc_venus:["Breathe easy in the floating cities of Venus.","Great minds meet here... and whisper.","Got a problem? The Venetian Syndicate has a solution... for a price.","Enjoy the view from the opulent circles of Aphrodite Prime.","Venusian atmospheric processors are working at 110% capacity today.","Pressure-shielding inspections are mandatory for all surface-level maintenance crews.",`"What's said on Venus, stays on Venus." - Unofficial motto.`,"Our labs are patenting the future; are you investing?","Trade in secrets, not just cargo. You're on Venus, after all.","Don't let the clouds fool you; the opportunities are clear.","Acid-proof your hull today at a local dry-dock.","Need information? Ask the right people in the City of Whispers.","You're at the system's premier destination for high-tech research.",'Corporate espionage is just "competitive intelligence" here.',"See the beauty of the acidic storms from our secure viewports.","The price of knowledge is high, but the profits are higher.","You're among the elite. You've made it to Venus.","Our floating cities: A miracle of engineering above a crushing hell.","Venusian science leads the system in processor and bio-ware."],loc_earth:["The blue jewel of the system welcomes you home.","Breathe real, unfiltered air. Enjoy your stay on Earth.","The Terran Alliance ensures peace and prosperity for all.","While you're here, visit the cradle of civilization.",'"A ship from Earth is a ship that lasts." - Terran Shipyards.',"Our orbital traffic is busy, but our markets are busier.","Earth: The system's standard for quality and luxury.","Why settle for synthetic? Get real Terran-grown food while you're here.","The Terran Alliance reminds you: clean trade is good trade.","See the rebuilt wonders of the 21st century!","Welcome to Earth, the hub of power, wealth, and influence.","Don't miss Old Chicago, New Beijing, and Neo-Alexandria!","Earth sets the economic and cultural pace for the system.","Our deep-thought computation centers are the system's finest.","Terran markets pay top credit for exotic materials."],loc_luna:["Luna: The industrial heart of the Terran sphere.","Got hull damage? Lunar dry-docks offer the system's best repair rates.","Our Plasteel is forged in vacuum, and it shows.","Need Propellant? We refine it right here, 24/7.",'"We scar the dust so you can fly." - Lunar Mining Co.',"Check out the Sea of Tranquility Industrial Park.","Lunar-built ships are building the future.","The Helium-3 rush may be over, but the work never stops.","Enjoy the Earthrise from a dusty viewport on the surface.","Get your ship serviced while you enjoy low-G comforts.","Lunar manufacturing: Simple, reliable, and affordable.","Stop by a dry-dock for a quick patch-up; our crews are waiting.","You're on the grey frontier, where fortunes are still made.","Dust warnings in effect for sectors 4 through 9.","Need raw materials? You're in the right place.","The Moon: Earth's loyal, hardworking partner.","Our mass-drivers fire tons of Plasteel into orbit every hour.","Don't forget to clean your filters; the dust gets everywhere.",`"If it's not from Luna, is it even built to last?"`],loc_mars:["Mars needs you! And your cargo, of course.","Help build the future; your deliveries build Mars.",`You're on the "Red Frontier," watching a new world in the making.`,"Terraforming is a thirsty business; Hydroponics wanted!","Dust storm warnings are in effect for the Hellas Basin.","You're standing on the first corporate state, the first in freedom!","We're expanding! Many commodities are in high demand.","See the great Olympus Mons, the system's largest mountain.",'"Our independence was built on commerce." - Mars Gov.',"New colonial supply contracts are regularly posted at the terminal.","We're not just building a colony, we're building a nation.","Ship your Cryo-Pods here; help grow our population.","The Martian dream is alive and well.","Enjoy the red skies, red dust, and golden opportunities.","Our fledgling biodomes are always hungry for more expansion.","Watch your step; construction is everywhere.","The thin air is tough, but so are our people.","Here on Mars, corporate policy is the only law.","Invest in a terraforming project today!","Need a solid ship? Martian shipyards build the toughest vessels."],loc_belt:["You're in the Belt: Find your fortune, or find your end.",`"Rock-rich and law-poor." - A Belter's motto.`,"Water Ice is cheap, but life is cheaper.","Need a ship? Our local scrap-yards hide many gems.","Prospectors wanted: high risk, high reward.","Watch your navigation; these rocks are unforgiving.","Out here, a good sensor array is your best friend..","Ice-haulers needed in sector 14-B.","Don't ask where the cargo came from.","A thousand hidden outposts, a million opportunities.","In the Belt, you can keep your transponder on... or off.","The Belt is no place for the faint of heart.","Countless rocks tumble in a silent, chaotic dance.","Need a scrappy craft? We build them tough enough for the Belt.","Raw materials, raw ambition. That's the Belt."],loc_exchange:["The Exchange: All goods, no questions.","Welcome to The Exchange. Check your morals at the airlock.","Need to move... sensitive cargo? We're your partners.","Comms are jammed for everyone's privacy.","Heed the security drones and yield to patrols.","High stakes, high rewards. Welcome to The Exchange.","At The Exchange, every credit is clean.","Don't ask, don't tell, just trade.","Prices are high, but discretion is absolute.","Find your next ship at The Exchange shipyards.","We trade in anything the corporations forbid.","The only law here is the law of supply and demand.","Fuel is a premium, but freedom is priceless.","You've arrived at the legendary black market. ","A hollow asteroid, a universe of opportunity.","We deal in rumors and secrets at The Exchange."],loc_jupiter:["The cheapest fuel in the system, guaranteed.","Enjoy the view from our orbital refineries.",'"We skim the giant so you can fly." - Jovian Fuel Co.',"Automated refineries are working constantly to keep you fueled.","You're at the essential pit-stop for all outer-system routes.","Don't get caught empty; top off while you're here.","Our fuel prices can't be beat!","The colossal sphere of Jupiter dominates every view.","Planning a long haul? Start with a full tank.","We specialize in one thing: cheap, high-grade Propellant.","Our exploration ships are built for the deep void.","The Great Red Spot: A baleful eye, a beautiful sight.","Need Atmo Processors? We build them big right here.","Gravity is high, but our prices are low.","The giant that fuels the whole system.","Radiation warnings in effect. Dock quickly.","Our automated systems mean fast, efficient refueling.",'"A full tank from Jupiter is a full wallet tomorrow."',"Come for the fuel, stay for the view."],loc_saturn:["Enjoy the majestic rings of Saturn.","You've arrived at the system's premier luxury destination.","Visit the opulent stations of the Ring-Dwellers.","Got luxury goods? Our markets pay top credit!","Bio-tech are in high demand on Saturn.","Relax in opulent zero-G luxury on your favorite ring today!",'"Give a ring, on a ring, with a view to remember." - Saturn Tourism Board.',"Our casinos are open always.","Experience the shadow of the rings.","Home of the best personal transport. Travel in style.","Bring us your exotic bio-wares, leave with a fortune.","You're at the jewel of the outer system.","Ice-harvesting rigs and luxury hotels, side-by-side.","This is where the wealthy come to play.","Forget the dust of the Belt; experience true opulence.","Our markets crave the finest things in life.","Corporate retreats and high-stakes tourism."],loc_uranus:["Uranus: Pushing the boundaries of science.","Need a boost? Our R&D labs offer component overclocking.","The pale, featureless orb holds deep secrets.","Report: Quantum phenomena studies are yielding strange results.","We build the system's largest craft. Reserve yours today.","Research outposts glitter like ice in the eternal twilight.","You're at the system's hub for theoretical physics.","Our ships are built for self-sufficiency.","Don't mind the strange sensor readings; it's just the science.","Welcome to the Tilted Planet at the edge of the known.","A silent, ice-cold world of opportunity.","We're hiring long-haul traders. Discretion is a must.",`"What is reality? We're working on it." - Uranus R&D.`,"The coldest, quietest, and strangest port in the system.","Our scientists are unlocking the secrets of the void."],loc_neptune:["You are in military-controlled space. Transponder required.","Supersonic winds and high-security stations.","Check out the military surplus shipyard. All sales final.",'"Monitor your engine wake when in port." - Neptune Patrol.',"Heavily armed patrols are for your protection.","The dark, stormy edge of the system.","Decommissioned frigates regularly for sale.","Have your clearance codes ready.","Welcome to the Dark Blue Pearl - beautiful, but dangerous.","Neptune's shipyards build for war, not for comfort.","Need a ship that can take a punch? Buy military surplus.","This is a restricted zone. Authorized traders only.","The winds here are fast, but our patrol ships are faster.","Shielded orbital stations offer refuge from the storm.",`"Obey the patrols, and you'll be fine."`,"Neptune: The armored fist of the outer system.","Our surplus sales are legendary. Get a frigate for cheap.","The last, stormy bastion of corporate law."],loc_kepler:["Kepler's Eye: We are watching the void.","Our Markets are astronomical.","You're looking at the single largest lens in human history.",'"We look for answers in the dark." - Kepler R&D.','"Staring into the infinite, always." - Kepler R&D.',"Our observatory consumes more power than a small city.","The furthest point of scientific ambition.",`"What's out there? Let's find out." - Kepler R&D`,"Our delicate sensor arrays are always expanding.","A colossal lens, a universe of data.","Kepler's Eye: The system's lonely sentinel.","Your cargo deliveries help fuel discovery.","Dock carefully; our sensor lattice is fragile.","The quietest station in the system.","See the system as you've never seen it before.","Kepler's Eye: What do the stars see when they look back?"],loc_pluto:["Pluto: The last stop.","Welcome to the fringe. Don't cause trouble.",'"We care not for your past, but your business."',"You're at the haven for outcasts, at the system's cold, dark edge.","Forbidden tech? We call it unregulated.","Our stations are carved from a mountains of nitrogen-ice.","Smugglers, outcasts, and pioneers are all welcome here.","Pluto: The furthest outpost from corporate law.","The light is dim, but the opportunities are bright.","Need supplies? We've got the strangest.","Pluto's tiny, frozen heart is a whisper in the dark.",`"It's cold, it's dark, and it's home." - Pluto Tourism Board`,"Need a place to lay low? You found it.",`"We have what the core worlds don't."`,"System jurisdiction ends here, but your stay doesn't have to."]};var ht=15,ut={loc_venus:"var(--color-theme-venus)",loc_earth:"var(--color-theme-earth)",loc_luna:"var(--color-theme-luna)",loc_mars:"var(--color-theme-mars)",loc_belt:"var(--color-theme-belt)",loc_exchange:"var(--color-theme-exchange)",loc_jupiter:"var(--color-theme-jupiter)",loc_saturn:"var(--color-theme-saturn)",loc_uranus:"var(--color-theme-uranus)",loc_neptune:"var(--color-theme-neptune)",loc_kepler:"var(--color-theme-kepler)",loc_pluto:"var(--color-theme-pluto)"},be=class{constructor(e){this.gameState=e,this.simulationService=null,this.marketService=null,this.messageQueue=[],this.isDirty=!0,this.welcomeMessagePlayed=!1}setServices(e,t){this.simulationService=e,this.marketService=t}pushMessage(e,t,i=!1,a=!1){if(e&&this.messageQueue.some(o=>o.text===e))return;let s={id:Date.now()+Math.random(),text:e,type:t,requiresLiveData:a};for(i?this.messageQueue.unshift(s):this.messageQueue.push(s);this.messageQueue.length>ht;)this.messageQueue.shift();this.isDirty=!0}pulse(){}onLocationChange(){let t=this.gameState.getState().currentLocationId;this.messageQueue=[],this.generateWelcomeMessage(),this.generateFreeIntelMessage(t);let i=this.selectLocationFlavorAds(t);i[0]&&this.pushMessage(i[0],"FLAVOR"),this.generatePurchasedIntelMessage(),i[1]&&this.pushMessage(i[1],"FLAVOR"),this.pushMessage("","STATUS",!1,!0),this.isDirty=!0}getTickerContentHtml(){return this.messageQueue.length===0&&!this.welcomeMessagePlayed&&this.generateWelcomeMessage(),`<div class="news-ticker-content">${this.messageQueue.map(i=>{let a=i.text,s="";return i.requiresLiveData&&i.type==="STATUS"&&(a=this.getLiveStatusText()),i.type==="FLAVOR"&&(s=`style="color: ${this.getLocationColor()};"`),`<span class="ticker-message" data-type="${i.type}" ${s}>${a}</span>`}).join(' <span class="ticker-separator"> // </span> ')}</div>`}generateWelcomeMessage(){this.welcomeMessagePlayed||(this.pushMessage("Welcome to Orbital Trading","SYSTEM",!0),this.welcomeMessagePlayed=!0)}generateFreeIntelMessage(e){if(!this.marketService)return;let i=this.gameState.getState().market.prices[e];if(!i)return;let a=u.COMMODITIES,s={commodityId:null,discount:0};for(let o in i){let r=a.find(h=>h.id===o);if(!r||!r.basePriceRange)continue;let n=(r.basePriceRange[0]+r.basePriceRange[1])/2,l=i[o],c=(n-l)/n;c>s.discount&&(s={commodityId:o,discount:c})}if(s.discount>=.05){let o=a.find(c=>c.id===s.commodityId).name,r;s.discount>.5?r="tier5":s.discount>.3?r="tier4":s.discount>.2?r="tier3":s.discount>.1?r="tier2":r="tier1";let n=He[r],l=n[Math.floor(Math.random()*n.length)];l=l.replace("{Commodity Name}",o),this.pushMessage(l,"INTEL")}else this.pushMessage("Market conditions nominal.","INTEL")}generatePurchasedIntelMessage(){}selectLocationFlavorAds(e){let t=Ce[e]||Ce.loc_belt;if(t.length===0)return["",""];if(t.length===1)return[t[0],t[0]];let i=[...t].sort(()=>.5-Math.random());return[i[0],i[1]]}getLiveStatusText(){try{let e=this.gameState.getState(),t=e.player.activeShipId;if(!t)return"STATUS: NO ACTIVE SHIP";let i=u.SHIPS[t],a=e.player.shipStates[t];if(!i||!a)return"STATUS: DATA ERROR";let s=Math.round(a.fuel/i.maxFuel*100),o=Math.round(a.health/i.maxHealth*100),r=0,n=e.player.inventories[t];n&&(r=Object.values(n).reduce((c,h)=>c+h.quantity,0));let l=i.cargoCapacity;return`${i.name}: FUEL: ${s}% | CARGO: ${r}/${l} | HULL: ${o}%`}catch(e){return console.error("NewsTickerService Error generating status:",e),"STATUS: ERROR"}}getLocationColor(){let e=this.gameState.getState().currentLocationId;return ut[e]||"var(--color-text-primary)"}};document.addEventListener("DOMContentLoaded",()=>{let d=document.getElementById("splash-screen"),e=document.getElementById("start-game-btn"),t=document.getElementById("debug-start-btn"),i=!0;e.addEventListener("click",()=>{d.classList.add("splash-screen-hiding"),d.addEventListener("animationend",()=>{d.style.display="none",a()},{once:!0})},{once:!0}),t.addEventListener("click",()=>{d.classList.add("splash-screen-hiding"),d.addEventListener("animationend",()=>{d.style.display="none",a(!0)},{once:!0})});function a(s=!1){let o=new Q,r=new le(G),n=new be(o),l=new fe(o,r,G),c=new se(o,r,G,n),h=new ge(o,r,c,r.navStructure,G),m=null;i&&(m=new ve(o,c,r,G),m.init(),r.setDebugService(m)),r.setNewsTickerService(n),r.setMissionService(l),r.setSimulationService(c),c.setTutorialService(h),c.setMissionService(l),l.setSimulationService(c);let p=new pe(o,c,r,h,m,G);r.setEventManager(p),o.subscribe(()=>r.render(o.getState()));let g=o.loadGame();g||(s&&m?(o.startNewGame(""),m.simpleStart()):(o.startNewGame(""),c.timeService.advanceDays(7),c.startIntroSequence())),p.bindEvents(),(g||s)&&(r.showGameContainer(),n.onLocationChange(),r.render(o.getState())),h.checkState({type:"SCREEN_LOAD",screenId:o.activeScreen})}});})();
